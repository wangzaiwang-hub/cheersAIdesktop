module.exports=[790895,a=>{"use strict";var b=a.i(608061),c=a.i(533306),d=a.i(57843),e=a.i(243103);a.i(26354);var f=a.i(858364),g=a.i(105249),h=a.i(938409),i=a.i(563667),j=a.i(547904);a.i(412708);var k=a.i(851571),l=a.i(438890),m=a.i(735310);a.i(713310);var n=a.i(455495),o=a.i(705134),p=a.i(622191),q=a.i(844137),r=a.i(954200),s=a.i(133824);a.i(520254);var t=a.i(413034),u=a.i(483075),v=a.i(348206),w=a.i(461758),x=a.i(178812),y=a.i(99296),z=a.i(356616),A=a.i(671149),B=a.i(927592),C=a.i(526897),D=a.i(860653),E=a.i(970502),F=a.i(252613);a.i(529638);var G=a.i(557275),H=a.i(583373),I=a.i(505618),J=a.i(581117),K=a.i(363444),L=a.i(124116),M=a.i(438616),N=a.i(388206),O=a.i(346315),P=a.i(374715),Q=a.i(715381),R=a.i(909795);a.i(73009);var S=a.i(68545),T=a.i(730357),U=a.i(527344);let V=(0,d.memo)(({disabled:a})=>{let{theme:c}=(0,T.default)(),d=(0,k.useStore)(a=>a.showChatVariablePanel),e=(0,k.useStore)(a=>a.setShowChatVariablePanel),f=(0,k.useStore)(a=>a.setShowEnvPanel),g=(0,k.useStore)(a=>a.setShowGlobalVariablePanel),h=(0,k.useStore)(a=>a.setShowDebugAndPreviewPanel);return(0,b.jsx)(R.default,{className:(0,U.cn)("rounded-lg border border-transparent p-2","dark"===c&&d&&"border-black/5 bg-white/10 backdrop-blur-sm"),disabled:a,onClick:()=>{e(!0),f(!1),g(!1),h(!1)},variant:"ghost",children:(0,b.jsx)(S.BubbleX,{className:"h-4 w-4 text-components-button-secondary-text"})})});var W=a.i(829781);let X=(0,d.memo)(()=>{let{nodesReadOnly:a}=(0,W.useNodesReadOnly)();return(0,Q.useIsChatMode)()?(0,b.jsx)(V,{disabled:a}):null});var Y=a.i(429150);a.i(752298);var Z=a.i(693025),$=a.i(65395),_=a.i(114715),aa=a.i(931164),ab=a.i(990693),ac=a.i(602024),ad=a.i(375616),ae=a.i(802066);let af=(0,d.memo)(()=>{let{t:a}=(0,Z.useTranslation)(),{theme:c}=(0,T.default)(),f=(0,W.useIsChatMode)(),g=(0,k.useWorkflowStore)(),h=(0,e.useStore)(a=>a.appDetail),i=h?.id,j=(0,e.useStore)(a=>a.setAppDetail),{nodesReadOnly:l,getNodesReadOnly:n}=(0,W.useNodesReadOnly)(),{plan:o,isFetchedPlan:p}=(0,ad.useProviderContext)(),r=(0,k.useStore)(a=>a.publishedAt),t=(0,k.useStore)(a=>a.draftUpdatedAt),u=(0,k.useStore)(a=>a.toolPublished),v=(0,k.useStore)(a=>a.lastPublishedHasUserInput),w=(0,ac.default)(),x=w.length>0,y=w.find(a=>a.data.type===m.BlockEnum.Start),z=w.find(a=>a.data.type===m.BlockEnum.End),A=y?.data?.variables,B=(0,E.useEdges)(),C=(0,s.useFeatures)(a=>a.features.file),D=(0,d.useMemo)(()=>{let a=A||[];return C?.image?.enabled?[...a,{type:m.InputVarType.files,variable:"__image",required:!1,label:"files"}]:a},[C?.image?.enabled,A]),F=(0,d.useMemo)(()=>z?.data?.outputs||[],[z]),{handleCheckBeforePublish:G}=(0,ab.useChecklistBeforePublish)(),{handleSyncWorkflowDraft:H}=(0,J.useNodesSyncDraft)(),{notify:I}=(0,_.useToastContext)(),K=(0,d.useMemo)(()=>w.filter(a=>a.data.type===m.BlockEnum.Start).map(a=>a.id),[w]),L=(0,d.useMemo)(()=>!!K.length&&B.some(a=>K.includes(a.source)),[B,K]),M=(0,d.useMemo)(()=>w.some(a=>(0,m.isTriggerNode)(a.data.type)),[w]),N=(0,d.useMemo)(()=>{let a=w.reduce((a,b)=>{let c=b.data.type;return c===m.BlockEnum.Start||(0,m.isTriggerNode)(c)?a+1:a},0);return p&&o.type===aa.Plan.sandbox&&a>2},[w,o.type,p]),O=(0,P.useResetWorkflowVersionHistory)(),Q=(0,q.useInvalidateAppTriggers)(),S=(0,d.useCallback)(()=>{let{showFeaturesPanel:a,isRestoring:b,setShowFeaturesPanel:c}=g.getState();(!n()||b)&&c(!a)},[g,n]),V=(0,d.useCallback)(async()=>{try{let a=await (0,ae.fetchAppDetail)({url:"/apps",id:i});j({...a})}catch(a){console.error(a)}},[i,j]),{mutateAsync:X}=(0,P.usePublishWorkflow)(),af=(0,ab.useChecklist)(w,B),ag=(0,P.useInvalidateAppWorkflow)(),ah=(0,d.useCallback)(async b=>{if(af.length>0)throw I({type:"error",message:a("panel.checklistTip",{ns:"workflow"})}),Error("Checklist has unresolved items");if(await G()){let c=await X({url:`/apps/${i}/workflows/publish`,title:b?.title||"",releaseNotes:b?.releaseNotes||""});c&&(I({type:"success",message:a("api.actionSuccess",{ns:"common"})}),ag(i),V(),Q(i),g.getState().setPublishedAt(c.created_at),g.getState().setLastPublishedHasUserInput(L),O())}else throw Error("Checklist failed")},[af,G,X,I,i,a,ag,V,g,O,Q]),ai=(0,d.useCallback)(a=>{a&&H(!0)},[H]),aj=(0,d.useCallback)(()=>{g.setState({toolPublished:!0})},[g]);return(0,b.jsxs)(b.Fragment,{children:[f&&(0,b.jsxs)(R.default,{className:(0,U.cn)("rounded-lg border border-transparent text-components-button-secondary-text","dark"===c&&"border-black/5 bg-white/10 backdrop-blur-sm"),onClick:S,children:[(0,b.jsx)(Y.RiApps2AddLine,{className:"mr-1 h-4 w-4 text-components-button-secondary-text"}),a("common.features",{ns:"workflow"})]}),(0,b.jsx)($.default,{publishedAt:r,draftUpdatedAt:t,disabled:l||!x,toolPublished:u,inputs:D,outputs:F,onRefreshData:aj,onPublish:ah,onToggle:ai,workflowToolAvailable:v,crossAxisOffset:4,missingStartNode:!y,hasTriggerNode:M,startNodeLimitExceeded:N,publishDisabled:!x||N})]})}),ag=(0,d.memo)(()=>{let{appDetail:a,setCurrentLogItem:c,setShowMessageLogModal:f}=(0,e.useStore)((0,N.useShallow)(a=>({appDetail:a.appDetail,setCurrentLogItem:a.setCurrentLogItem,setShowMessageLogModal:a.setShowMessageLogModal}))),g=(0,P.useResetWorkflowVersionHistory)(),h=(0,Q.useIsChatMode)(),i=(0,d.useCallback)(()=>{c(),f(!1)},[c,f]),j=(0,d.useMemo)(()=>({onClearLogAndMessageModal:i,historyUrl:h?`/apps/${a.id}/advanced-chat/workflow-runs`:`/apps/${a.id}/workflow-runs`}),[a,h,i]),k=(0,d.useMemo)(()=>({normal:{components:{middle:(0,b.jsx)(af,{}),chatVariableTrigger:(0,b.jsx)(X,{})},runAndHistoryProps:{showRunButton:!h,showPreviewButton:h,viewHistoryProps:j}},viewHistory:{viewHistoryProps:j},restoring:{onRestoreSettled:g}}),[g,h,j]);return(0,b.jsx)(O.default,{...k})});var ah=a.i(129095);let ai=(0,D.default)(async()=>{},{loadableGenerated:{modules:[958431]},ssr:!1}),aj=(0,D.default)(async()=>{},{loadableGenerated:{modules:[689516]},ssr:!1}),ak=(0,D.default)(async()=>{},{loadableGenerated:{modules:[783946]},ssr:!1}),al=(0,D.default)(async()=>{},{loadableGenerated:{modules:[172774]},ssr:!1}),am=(0,D.default)(async()=>{},{loadableGenerated:{modules:[279541]},ssr:!1}),an=(0,D.default)(async()=>{},{loadableGenerated:{modules:[567995]},ssr:!1}),ao=(0,D.default)(async()=>{},{loadableGenerated:{modules:[932933]},ssr:!1}),ap=()=>{let{currentLogItem:a,setCurrentLogItem:c,showMessageLogModal:d,setShowMessageLogModal:f,currentLogModalActiveTab:g}=(0,e.useStore)((0,N.useShallow)(a=>({currentLogItem:a.currentLogItem,setCurrentLogItem:a.setCurrentLogItem,showMessageLogModal:a.showMessageLogModal,setShowMessageLogModal:a.setShowMessageLogModal,currentLogModalActiveTab:a.currentLogModalActiveTab})));return(0,b.jsx)(b.Fragment,{children:d&&(0,b.jsx)(ai,{fixedWidth:!0,width:400,currentLogItem:a,onCancel:()=>{c(),f(!1)},defaultTab:g})})},aq=()=>{let a=(0,Q.useIsChatMode)(),c=(0,k.useStore)(a=>a.historyWorkflowData),d=(0,k.useStore)(a=>a.showDebugAndPreviewPanel),e=(0,k.useStore)(a=>a.showChatVariablePanel),f=(0,k.useStore)(a=>a.showGlobalVariablePanel);return(0,b.jsxs)(b.Fragment,{children:[c&&!a&&(0,b.jsx)(aj,{}),c&&a&&(0,b.jsx)(ak,{}),d&&a&&(0,b.jsx)(al,{}),d&&!a&&(0,b.jsx)(am,{}),e&&a&&(0,b.jsx)(an,{}),f&&(0,b.jsx)(ao,{})]})},ar=(0,d.memo)(()=>{let a=(0,e.useStore)(a=>a.appDetail),c=(0,d.useMemo)(()=>{let b=a?.id;return{getVersionListUrl:`/apps/${b}/workflows`,deleteVersionUrl:a=>`/apps/${b}/workflows/${a}`,updateVersionUrl:a=>`/apps/${b}/workflows/${a}`,latestVersionId:a?.workflow?.id}},[a?.id,a?.workflow?.id]),f=(0,d.useMemo)(()=>({components:{left:(0,b.jsx)(ap,{}),right:(0,b.jsx)(aq,{})},versionHistoryPanelProps:c}),[c]);return(0,b.jsx)(ah.default,{...f})}),as=(0,D.default)(async()=>{},{loadableGenerated:{modules:[833709]},ssr:!1}),at=(0,D.default)(async()=>{},{loadableGenerated:{modules:[868879]},ssr:!1}),au=(0,D.default)(async()=>{},{loadableGenerated:{modules:[356881]},ssr:!1}),av=(0,D.default)(async()=>{},{loadableGenerated:{modules:[150579]},ssr:!1}),aw=(0,d.memo)(()=>{let a,c,e,f,{eventEmitter:g}=(0,L.useEventEmitterContextContext)(),[h,i]=(0,d.useState)([]),j=(0,k.useStore)(a=>a.showFeaturesPanel),l=(0,k.useStore)(a=>a.showImportDSLModal),n=(0,k.useStore)(a=>a.setShowImportDSLModal),o=(0,k.useStore)(a=>a.showOnboarding),p=(0,k.useStore)(a=>a.setShowOnboarding),q=(0,k.useStore)(a=>a.setHasSelectedStartNode),r=(0,k.useStore)(a=>a.setShouldAutoOpenStartNodeSelector),s=(0,E.useStoreApi)(),u=(0,t.useAvailableNodesMetaData)(),{handleSyncWorkflowDraft:v}=(0,J.useNodesSyncDraft)(),{handleOnboardingClose:w}=(a=(0,E.useStoreApi)(),c=(0,k.useWorkflowStore)(),e=(0,d.useCallback)(()=>{let{getNodes:b}=a.getState(),{showOnboarding:d,hasShownOnboarding:e,notInitialWorkflow:f,setShowOnboarding:g,setHasShownOnboarding:h,setShouldAutoOpenStartNodeSelector:i}=c.getState();d||f||0!==b().length||e||(g?.(!0),h?.(!0),i?.(!0))},[a,c]),f=(0,d.useCallback)(()=>{let{setShowOnboarding:a,setHasShownOnboarding:b,setShouldAutoOpenStartNodeSelector:d,hasSelectedStartNode:e,setHasSelectedStartNode:f}=c.getState();a?.(!1),b?.(!0),e?f?.(!1):d?.(!1)},[c]),(0,d.useEffect)(()=>{let a=setTimeout(()=>{e()},500);return()=>clearTimeout(a)},[e]),{checkAndShowOnboarding:e,handleOnboardingClose:f}),{handlePaneContextmenuCancel:x}=(0,I.usePanelInteractions)(),{exportCheck:y,handleExportDSL:z}=(0,H.useDSL)();g?.useSubscription(a=>{a.type===F.DSL_EXPORT_CHECK&&i(a.payload.data)});let A=(0,G.useAutoGenerateWebhookUrl)(),B=(0,d.useCallback)(()=>{w()},[w]),C=(0,d.useCallback)((a,b)=>{let c=u.nodesMap?.[a];if(!c?.defaultValue)return;let d={...c.defaultValue},e=(()=>{let c,e;if(a!==m.BlockEnum.TriggerPlugin||!b)return{...d,...b};let f=(c=d.title,e=d.desc,{plugin_id:b.plugin_id,provider_id:b.provider_name,provider_type:b.provider_type,provider_name:b.provider_name,event_name:b.event_name,event_label:b.event_label,event_description:b.event_description,title:b.event_label||b.title||c,desc:b.event_description||e,output_schema:{...b.output_schema},parameters_schema:b.paramSchemas?[...b.paramSchemas]:[],config:{...b.params},subscription_id:b.subscription_id,plugin_unique_identifier:b.plugin_unique_identifier,is_team_authorization:b.is_team_authorization,meta:b.meta?{...b.meta}:void 0});return{...d,...f,config:{...d.config,...f.config}}})(),{newNode:f}=(0,K.generateNewNode)({data:{...e},position:F.START_INITIAL_POSITION}),{setNodes:g,setEdges:h}=s.getState();g([f]),h([]),p?.(!1),q?.(!0),r?.(!0),v(!0,!1,{onSuccess:()=>{A(f.id)},onError:()=>{console.error("Failed to save node to draft")}})},[u,p,q,s,v]);return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(M.default,{}),j&&(0,b.jsx)(as,{}),o&&(0,b.jsx)(av,{isShow:o,onClose:B,onSelectStartNode:C}),l&&(0,b.jsx)(at,{onCancel:()=>n(!1),onBackup:y,onImport:x}),h.length>0&&(0,b.jsx)(au,{envList:h,onConfirm:z,onClose:()=>i([])}),(0,b.jsx)(ag,{}),(0,b.jsx)(ar,{})]})}),ax=({nodes:a,edges:c,viewport:e})=>{let f=(0,s.useFeaturesStore)(),g=(0,k.useWorkflowStore)(),h=(0,d.useCallback)(a=>{let{features:b,conversation_variables:c,environment_variables:d}=a;if(b&&f){let{setFeatures:a}=f.getState();a(b)}if(c){let{setConversationVariables:a}=g.getState();a(c)}if(d){let{setEnvironmentVariables:a}=g.getState();a(d)}},[f,g]),{doSyncWorkflowDraft:j,syncWorkflowDraftWhenPageClose:l}=(0,y.useNodesSyncDraft)(),{handleRefreshWorkflowDraft:m}=(0,A.useWorkflowRefreshDraft)(),{handleBackupDraft:n,handleLoadBackupDraft:o,handleRestoreFromPublishedWorkflow:p,handleRun:q,handleStopRun:r}=(0,B.useWorkflowRun)(),{handleStartWorkflowRun:D,handleWorkflowStartRunInChatflow:E,handleWorkflowStartRunInWorkflow:F,handleWorkflowTriggerScheduleRunInWorkflow:G,handleWorkflowTriggerWebhookRunInWorkflow:H,handleWorkflowTriggerPluginRunInWorkflow:I,handleWorkflowRunAllTriggersInWorkflow:J}=(0,C.useWorkflowStartRun)(),K=(0,t.useAvailableNodesMetaData)(),{getWorkflowRunAndTraceUrl:L}=(0,w.useGetRunAndTraceUrl)(),{exportCheck:M,handleExportDSL:N}=(0,v.useDSL)(),O=(0,u.useConfigsMap)(),{fetchInspectVars:P}=(0,z.useSetWorkflowVarsWithValue)({...O}),{hasNodeInspectVars:Q,hasSetInspectVar:R,fetchInspectVarValue:S,editInspectVarValue:T,renameInspectVarName:U,appendNodeInspectVars:V,deleteInspectVar:W,deleteNodeInspectorVars:X,deleteAllInspectorVars:Y,isInspectVarEdited:Z,resetToLastRunVar:$,invalidateSysVarValues:_,resetConversationVar:aa,invalidateConversationVarValues:ab}=(0,x.useInspectVarsCrud)(),ac=(0,d.useMemo)(()=>({syncWorkflowDraftWhenPageClose:l,doSyncWorkflowDraft:j,handleRefreshWorkflowDraft:m,handleBackupDraft:n,handleLoadBackupDraft:o,handleRestoreFromPublishedWorkflow:p,handleRun:q,handleStopRun:r,handleStartWorkflowRun:D,handleWorkflowStartRunInChatflow:E,handleWorkflowStartRunInWorkflow:F,handleWorkflowTriggerScheduleRunInWorkflow:G,handleWorkflowTriggerWebhookRunInWorkflow:H,handleWorkflowTriggerPluginRunInWorkflow:I,handleWorkflowRunAllTriggersInWorkflow:J,availableNodesMetaData:K,getWorkflowRunAndTraceUrl:L,exportCheck:M,handleExportDSL:N,fetchInspectVars:P,hasNodeInspectVars:Q,hasSetInspectVar:R,fetchInspectVarValue:S,editInspectVarValue:T,renameInspectVarName:U,appendNodeInspectVars:V,deleteInspectVar:W,deleteNodeInspectorVars:X,deleteAllInspectorVars:Y,isInspectVarEdited:Z,resetToLastRunVar:$,invalidateSysVarValues:_,resetConversationVar:aa,invalidateConversationVarValues:ab,configsMap:O}),[l,j,m,n,o,p,q,r,D,E,F,G,H,I,J,K,L,M,N,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ab,O]);return(0,b.jsx)(i.WorkflowWithInnerContext,{nodes:a,edges:c,viewport:e,onWorkflowDataUpdate:h,hooksStore:ac,children:(0,b.jsx)(aw,{})})};var ay=a.i(632295);let az=a=>({appId:"",appName:"",notInitialWorkflow:!1,setNotInitialWorkflow:b=>a(()=>({notInitialWorkflow:b})),shouldAutoOpenStartNodeSelector:!1,setShouldAutoOpenStartNodeSelector:b=>a(()=>({shouldAutoOpenStartNodeSelector:b})),nodesDefaultConfigs:{},setNodesDefaultConfigs:b=>a(()=>({nodesDefaultConfigs:b})),showOnboarding:!1,setShowOnboarding:b=>a(()=>({showOnboarding:b})),hasSelectedStartNode:!1,setHasSelectedStartNode:b=>a(()=>({hasSelectedStartNode:b})),hasShownOnboarding:!1,setHasShownOnboarding:b=>a(()=>({hasShownOnboarding:b}))}),aA=()=>{let{data:a,isLoading:j,fileUploadConfigResponse:s}=(0,ay.useWorkflowInit)(),t=(0,k.useWorkflowStore)(),{isLoadingCurrentWorkspace:u,currentWorkspace:v}=(0,o.useAppContext)(),{setTriggerStatuses:x}=(0,l.useTriggerStatusStore)(),y=(0,e.useStore)(a=>a.appDetail),z=y?.id,A=y?.mode===r.AppModeEnum.WORKFLOW,{data:B}=(0,q.useAppTriggers)(A?z:void 0,{staleTime:3e5,refetchOnWindowFocus:!1});(0,d.useEffect)(()=>{B?.data&&x(B.data.reduce((a,b)=>(a[b.node_id]="enabled"===b.status?"enabled":"disabled",a),{}))},[B?.data,x]),(0,d.useEffect)(()=>()=>{t.setState({isWorkflowDataLoaded:!1});let{debouncedSyncWorkflowDraft:a}=t.getState();a&&"cancel"in a&&a.cancel()},[t]);let C=(0,d.useMemo)(()=>a?(0,n.initialNodes)(a.graph.nodes,a.graph.edges):[],[a]),D=(0,d.useMemo)(()=>a?(0,n.initialEdges)(a.graph.edges,a.graph.nodes):[],[a]),E=(0,c.useSearchParams)(),{getWorkflowRunAndTraceUrl:F}=(0,w.useGetRunAndTraceUrl)(),G=E.get("replayRunId");if((0,d.useEffect)(()=>{if(!G)return;let{runUrl:a}=F(G);a&&(0,p.fetchRunDetail)(a).then(a=>{let{setInputs:b,setShowInputsPanel:c,setShowDebugAndPreviewPanel:d}=t.getState(),e=a.inputs,f=null;if("string"==typeof e)try{let a=JSON.parse(e);a&&"object"==typeof a&&!Array.isArray(a)&&(f=a)}catch(a){console.error("Failed to parse workflow run inputs",a)}else e&&"object"==typeof e&&!Array.isArray(e)&&(f=e);if(!f)return;let g={};Object.entries(f).forEach(([a,b])=>{if(!a.startsWith("sys.")){if(null==b){g[a]="";return}if("string"==typeof b||"number"==typeof b||"boolean"==typeof b){g[a]=b;return}try{g[a]=JSON.stringify(b)}catch{g[a]=String(b)}}}),Object.keys(g).length&&(b(g),c(!0),d(!0))})},[G,t,F]),!a||j||u||!v.id)return(0,b.jsx)("div",{className:"relative flex h-full w-full items-center justify-center",children:(0,b.jsx)(g.default,{})});let H=a.features||{},I={file:{image:{enabled:!!H.file_upload?.image?.enabled,number_limits:H.file_upload?.image?.number_limits||3,transfer_methods:H.file_upload?.image?.transfer_methods||["local_file","remote_url"]},enabled:!!(H.file_upload?.enabled||H.file_upload?.image?.enabled),allowed_file_types:H.file_upload?.allowed_file_types||[m.SupportUploadFileTypes.image],allowed_file_extensions:H.file_upload?.allowed_file_extensions||h.FILE_EXTS[m.SupportUploadFileTypes.image].map(a=>`.${a}`),allowed_file_upload_methods:H.file_upload?.allowed_file_upload_methods||H.file_upload?.image?.transfer_methods||["local_file","remote_url"],number_limits:H.file_upload?.number_limits||H.file_upload?.image?.number_limits||3,fileUploadConfig:s},opening:{enabled:!!H.opening_statement,opening_statement:H.opening_statement,suggested_questions:H.suggested_questions},suggested:H.suggested_questions_after_answer||{enabled:!1},speech2text:H.speech_to_text||{enabled:!1},text2speech:H.text_to_speech||{enabled:!1},citation:H.retriever_resource||{enabled:!1},moderation:H.sensitive_word_avoidance||{enabled:!1}};return(0,b.jsx)(i.default,{edges:D,nodes:C,children:(0,b.jsx)(f.FeaturesProvider,{features:I,children:(0,b.jsx)(ax,{nodes:C,edges:D,viewport:a.graph.viewport})})})};a.s(["default",0,()=>(0,b.jsx)(j.WorkflowContextProvider,{injectWorkflowStoreSliceFn:az,children:(0,b.jsx)(aA,{})})],790895)}];

//# sourceMappingURL=app_components_workflow-app_index_tsx_b7485fb0._.js.map