module.exports=[653822,a=>{"use strict";a.s(["formatBooleanInputs",0,(a,b)=>{if(!a)return b;let c={...b};return a.forEach(a=>{"checkbox"===a.type&&(c[a.key]=!!c[a.key])}),c},"promptVariablesToUserInputsForm",0,a=>{let b=[];return a.filter(({key:a,name:b})=>a&&a.trim()&&b&&b.trim()).forEach(a=>{"string"===a.type||"paragraph"===a.type?b.push({["string"===a.type?"text-input":"paragraph"]:{label:a.name,variable:a.key,required:!1!==a.required,max_length:a.max_length,default:"",hide:a.hide}}):"number"===a.type||"checkbox"===a.type?b.push({[a.type]:{label:a.name,variable:a.key,required:!1!==a.required,default:"",hide:a.hide}}):"select"===a.type?b.push({select:{label:a.name,variable:a.key,required:!1!==a.required,options:a.options,default:a.default??"",hide:a.hide}}):b.push({external_data_tool:{label:a.name,variable:a.key,enabled:a.enabled,type:a.type,config:a.config,required:a.required,icon:a.icon,icon_background:a.icon_background,hide:a.hide}})}),b},"userInputsFormToPromptVariables",0,(a,b)=>{if(!a)return[];let c=[];return a.forEach(a=>{let[d,e]=a.paragraph?["paragraph",a.paragraph]:a["text-input"]?["string",a["text-input"]]:a.number?["number",a.number]:a.checkbox?["boolean",a.checkbox]:a.file?["file",a.file]:a["file-list"]?["file-list",a["file-list"]]:a.external_data_tool?[a.external_data_tool.type,a.external_data_tool]:a.json_object?["json_object",a.json_object]:["select",a.select||{}],f=b===e?.variable;"string"===d||"paragraph"===d?c.push({key:e.variable,name:e.label,required:e.required,type:d,max_length:e.max_length,options:[],is_context_var:f,hide:e.hide,default:e.default}):"number"===d?c.push({key:e.variable,name:e.label,required:e.required,type:d,options:[],hide:e.hide,default:e.default}):"boolean"===d?c.push({key:e.variable,name:e.label,required:e.required,type:"checkbox",options:[],hide:e.hide,default:e.default}):"select"===d?c.push({key:e.variable,name:e.label,required:e.required,type:"select",options:e.options,is_context_var:f,hide:e.hide,default:e.default}):"file"===d?c.push({key:e.variable,name:e.label,required:e.required,type:d,config:{allowed_file_types:e.allowed_file_types,allowed_file_extensions:e.allowed_file_extensions,allowed_file_upload_methods:e.allowed_file_upload_methods,number_limits:1},hide:e.hide,default:e.default}):"file-list"===d?c.push({key:e.variable,name:e.label,required:e.required,type:d,config:{allowed_file_types:e.allowed_file_types,allowed_file_extensions:e.allowed_file_extensions,allowed_file_upload_methods:e.allowed_file_upload_methods,number_limits:e.max_length},hide:e.hide,default:e.default}):c.push({key:e.variable,name:e.label,required:e.required,type:e.type,enabled:e.enabled,config:e.config,icon:e.icon,icon_background:e.icon_background,is_context_var:f,hide:e.hide})}),c}])},847118,a=>{"use strict";var b=a.i(20177),c=a.i(111089),d=a.i(494261),e=a.i(533306),f=a.i(57843);a.i(752298);var g=a.i(693025),h=a.i(44348),i=a.i(41548),j=a.i(818386),k=a.i(114715),l=a.i(735310),m=a.i(98654),n=a.i(41511),o=a.i(954200),p=a.i(546107);let q=a=>({type:a.type,transfer_method:a.transfer_method,url:a.remote_url,upload_file_id:a.related_id});a.s(["useChat",0,(a,r,s,t,u,v)=>{let{t:w}=(0,g.useTranslation)(),{formatTime:x}=(0,m.default)(),{notify:y}=(0,k.useToastContext)(),z=(0,f.useRef)(""),A=(0,f.useRef)(!1),[B,C]=(0,f.useState)(!1),D=(0,f.useRef)(!1),E=(0,f.useRef)(""),[F,G]=(0,f.useState)([]),H=(0,f.useRef)(null),I=(0,f.useRef)(null),J=(0,e.useParams)(),K=(0,e.usePathname)(),[L,M]=(0,f.useState)(s||[]),N=(0,f.useRef)(L),[O,P]=(0,f.useState)(),Q=(0,f.useMemo)(()=>(0,p.getThreadMessages)(L,O),[L,O]),R=(0,f.useCallback)(a=>{var b,c;return b=r?.inputs||{},c=r?.inputsForm||[],a?a.replace(/\{\{([^}]+)\}\}/g,(a,d)=>{let e=b[d];if(e)return e;let f=c.find(a=>a.variable===d);return f?`{{${f.label}}}`:a}):a},[r?.inputs,r?.inputsForm]),S=(0,f.useMemo)(()=>{let b=[...Q];if(a?.opening_statement){let c=Q.findIndex(a=>a.isOpeningStatement);c>-1?b[c]={...b[c],content:R(a.opening_statement),suggestedQuestions:a.suggested_questions?.map(a=>R(a))}:b.unshift({id:"opening-statement",content:R(a.opening_statement),isAnswer:!0,isOpeningStatement:!0,suggestedQuestions:a.suggested_questions?.map(a=>R(a))})}return b},[Q,a?.opening_statement,R,a?.suggested_questions]);(0,f.useEffect)(()=>((0,d.setAutoFreeze)(!1),()=>{(0,d.setAutoFreeze)(!0)}),[]);let T=(0,f.useCallback)((a,b)=>(0,d.produce)(N.current,c=>{let d=[...c];for(;d.length>0;){let c=d.shift();if(c.id===a){b(c);break}c.children&&d.push(...c.children)}}),[]),U=(0,f.useCallback)((a,b)=>{let c=T(a,a=>{"function"==typeof b?b(a):Object.keys(b).forEach(c=>{a[c]=b[c]})});M(c),N.current=c},[T]),V=(0,f.useCallback)(a=>{C(a),D.current=a},[]),W=(0,f.useCallback)(()=>{A.current=!0,V(!1),t&&E.current&&t(E.current),H.current&&H.current.abort(),I.current&&I.current.abort()},[t,V]),X=(0,f.useCallback)(a=>{z.current="",E.current="",W(),M([]),G([]),a?.()},[W]),Y=(0,f.useCallback)(({parentId:a,responseItem:b,placeholderQuestionId:c,questionItem:e})=>{let f,g={...e,children:[{...b,children:[]}]};M(f=a||L.some(a=>[c,e.id].includes(a.id))?T(a,a=>{let b=a.children.findIndex(a=>[c,e.id].includes(a.id));-1===b?a.children.push(g):a.children[b]=g}):(0,d.produce)(L,a=>{a.push(g)})),N.current=f},[L,T]),Z=(0,f.useCallback)(async(d,e,{onGetConversationMessages:f,onGetSuggestedQuestions:g,onConversationComplete:k,isPublicAPI:m})=>{var p,s;let t;if(G([]),D.current)return y({type:"info",message:w("errorMessage.waitForResponse",{ns:"appDebug"})}),!1;let u=Q.find(a=>a.id===e.parent_message_id),v=`question-${Date.now()}`,B={id:v,content:e.query,isAnswer:!1,message_files:e.files,parentMessageId:e.parent_message_id},C=`answer-placeholder-${Date.now()}`,F={id:C,content:"",isAnswer:!0,parentMessageId:B.id,siblingIndex:u?.children?.length??L.length};P(u?.id),Y({parentId:e.parent_message_id,responseItem:F,placeholderQuestionId:v,questionItem:B});let M={id:C,content:"",agent_thoughts:[],message_files:[],isAnswer:!0,parentMessageId:B.id,siblingIndex:u?.children?.length??L.length};V(!0),A.current=!1;let{query:N,files:O,inputs:R,...S}=e,T={response_mode:"streaming",conversation_id:z.current,files:(0,j.getProcessedFiles)(O||[]),query:N,inputs:(p=R||{},s=r?.inputsForm||[],t={...p},s.forEach(a=>{let b=p[a.variable];if(a.type===l.InputVarType.checkbox){t[a.variable]=!!b;return}if(null!=b){if(a.type===l.InputVarType.singleFile)"transfer_method"in b?t[a.variable]=q(b):t[a.variable]=(0,j.getProcessedFiles)([b])[0];else if(a.type===l.InputVarType.multiFiles)"transfer_method"in b[0]?t[a.variable]=b.map(q):t[a.variable]=(0,j.getProcessedFiles)(b);else if(a.type===l.InputVarType.jsonObject)try{let c="string"==typeof b?JSON.parse(b):b;c&&"object"==typeof c&&!Array.isArray(c)?t[a.variable]=c:t[a.variable]=b}catch{t[a.variable]=b}}}),t),...S};T?.files?.length&&(T.files=T.files.map(a=>a.transfer_method===o.TransferMethod.local_file?{...a,url:""}:a));let W=!1,X=!1,Z="",$=!1;J.token?(Z="/text-to-audio",$=!0):J.appId&&(Z=K.search("explore/installed")>-1?`/installed-apps/${J.appId}/text-to-audio`:`/apps/${J.appId}/text-to-audio`);let _=null,aa=()=>(_||(_=i.AudioPlayerManager.getInstance().getAudioPlayer(Z,$,(0,h.v4)(),"none","none",c.noop)),_);return(0,n.ssePost)(d,{body:T},{isPublicAPI:m,onData:(a,b,{conversationId:c,messageId:d,taskId:f})=>{if(W){let b=M.agent_thoughts?.[M.agent_thoughts?.length-1];b&&(b.thought=b.thought+a)}else M.content=M.content+a;d&&!X&&(B.id=`question-${d}`,M.id=d,M.parentMessageId=B.id,X=!0),b&&c&&(z.current=c),E.current=f,d&&(M.id=d),Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})},async onCompleted(b){if(V(!1),!b){if(k&&k(z.current),z.current&&!A.current&&f){let{data:a}=await f(z.current,a=>H.current=a),b=a.find(a=>a.id===M.id);if(!b)return;let c=b.agent_thoughts?.length>0&&b.agent_thoughts[b.agent_thoughts?.length-1].thought===b.answer;U(M.id,{content:c?"":b.answer,log:[...b.message,..."assistant"!==b.message[b.message.length-1].role?[{role:"assistant",text:b.answer,files:b.message_files?.filter(a=>"assistant"===a.belongs_to)||[]}]:[]],more:{time:x(b.created_at,"hh:mm A"),tokens:b.answer_tokens+b.message_tokens,latency:b.provider_response_latency.toFixed(2),tokens_per_second:b.provider_response_latency>0?(b.answer_tokens/b.provider_response_latency).toFixed(2):void 0},conversationId:z.current,input:{inputs:b.inputs,query:b.query}})}if(a?.suggested_questions_after_answer?.enabled&&!A.current&&g)try{let{data:a}=await g(M.id,a=>I.current=a);G(a)}catch(a){G([])}}},onFile(a){let b=a.type||"image",c="transferMethod"in a?a:null,d={id:c?.id||a.id,type:c?.type||("image"===b?"image/png":"video"===b?"video/mp4":"audio"===b?"audio/mpeg":"application/octet-stream"),transferMethod:c?.transferMethod||("image"===b?"remote_url":"local_file"),uploadedId:c?.uploadedId||a.id,supportFileType:c?.supportFileType||("image"===b?"image":"video"===b?"video":"audio"===b?"audio":"document"),progress:c?.progress??100,name:c?.name||`generated_${b}.${"image"===b?"png":"video"===b?"mp4":"audio"===b?"mp3":"bin"}`,url:c?.url||a.url,size:c?.size??0},f=M.agent_thoughts?.[M.agent_thoughts?.length-1];if(f)M.agent_thoughts[M.agent_thoughts.length-1].message_files=[...f.message_files??[],d];else{let a=M.message_files??[];M.message_files=[...a,d]}Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})},onThought(a){if(W=!0,a.message_id&&!X&&(M.id=a.message_id),a.conversation_id&&(M.conversationId=a.conversation_id),0===M.agent_thoughts.length)M.agent_thoughts.push(a);else{let b=M.agent_thoughts[M.agent_thoughts.length-1];b.id===a.id?(a.thought=b.thought,a.message_files=b.message_files,M.agent_thoughts[M.agent_thoughts.length-1]=a):M.agent_thoughts.push(a)}Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})},onMessageEnd:a=>{if(a.metadata?.annotation_reply){M.id=a.id,M.annotation={id:a.metadata.annotation_reply.id,authorName:a.metadata.annotation_reply.account.name},Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id});return}M.citation=a.metadata?.retriever_resources||[];let c=(0,j.getProcessedFilesFromResponse)(a.files||[]);M.allFiles=(0,b.uniqBy)([...M.allFiles||[],...c||[]],"id"),Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})},onMessageReplace:a=>{M.content=a.answer},onError(){V(!1),Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})},onWorkflowStarted:({workflow_run_id:a,task_id:b})=>{E.current=b,M.workflow_run_id=a,M.workflowProcess={status:l.WorkflowRunningStatus.Running,tracing:[]},Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})},onWorkflowFinished:({data:a})=>{M.workflowProcess.status=a.status,Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})},onIterationStart:({data:a})=>{M.workflowProcess.tracing.push({...a,status:l.WorkflowRunningStatus.Running}),Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})},onIterationFinish:({data:a})=>{let b=M.workflowProcess.tracing,c=b.findIndex(b=>b.node_id===a.node_id&&(b.execution_metadata?.parallel_id===a.execution_metadata?.parallel_id||b.parallel_id===a.execution_metadata?.parallel_id));b[c]={...b[c],...a,status:l.WorkflowRunningStatus.Succeeded},Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})},onNodeStarted:({data:a})=>{a.iteration_id||e.loop_id||(M.workflowProcess.tracing.push({...a,status:l.WorkflowRunningStatus.Running}),Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id}))},onNodeFinished:({data:a})=>{if(a.iteration_id||e.loop_id)return;let b=M.workflowProcess.tracing.findIndex(b=>b.execution_metadata?.parallel_id?b.node_id===a.node_id&&b.execution_metadata?.parallel_id===a.execution_metadata?.parallel_id:b.node_id===a.node_id);M.workflowProcess.tracing[b]=a,Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})},onTTSChunk:(a,b)=>{if(!b||""===b)return;let c=aa();c&&(c.playAudioWithAudio(b,!0),i.AudioPlayerManager.getInstance().resetMsgId(a))},onTTSEnd:(a,b)=>{let c=aa();c&&c.playAudioWithAudio(b,!1)},onLoopStart:({data:a})=>{M.workflowProcess.tracing.push({...a,status:l.WorkflowRunningStatus.Running}),Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})},onLoopFinish:({data:a})=>{let b=M.workflowProcess.tracing,c=b.findIndex(b=>b.node_id===a.node_id&&(b.execution_metadata?.parallel_id===a.execution_metadata?.parallel_id||b.parallel_id===a.execution_metadata?.parallel_id));b[c]={...b[c],...a,status:l.WorkflowRunningStatus.Succeeded},Y({placeholderQuestionId:v,questionItem:B,responseItem:M,parentId:e.parent_message_id})}}),!0},[w,L.length,Q,a?.suggested_questions_after_answer,Y,U,y,V,x,J.token,J.appId,K,r]),$=(0,f.useCallback)((a,b,c)=>{let d=S[c-1].id,e=S[c].id;U(d,{content:a}),U(e,{content:b,annotation:{...S[c].annotation,logAnnotation:void 0}})},[S,U]),_=(0,f.useCallback)((a,b,c,d,e)=>{let f=S[e-1].id,g=S[e].id;U(f,{content:c}),U(g,{content:S[e].content,annotation:{id:a,authorName:b,logAnnotation:{content:d,account:{id:"",name:b,email:""}}}})},[S,U]),aa=(0,f.useCallback)(a=>{U(S[a].id,{content:S[a].content,annotation:{...S[a].annotation,id:""}})},[S,U]);return(0,f.useEffect)(()=>{u&&X(()=>v?.(!1))},[u,v,X]),{chatList:S,setTargetMessageId:P,conversationId:z.current,isResponding:B,setIsResponding:C,handleSend:Z,suggestedQuestions:F,handleRestart:X,handleStop:W,handleAnnotationEdited:$,handleAnnotationAdded:_,handleAnnotationRemoved:aa}}],847118)}];

//# sourceMappingURL=_2c33586f._.js.map