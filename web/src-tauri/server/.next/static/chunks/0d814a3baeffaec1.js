(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,112142,265630,e=>{"use strict";var a=e.i(563199),t=e.i(105845),s=e.i(268255);e.i(152567);var l=e.i(408767),r=e.i(339548),n=e.i(189299),i=e.i(324935);e.i(237855);var o=e.i(910605),d=e.i(291631),m=e.i(21151),c=e.i(299951),p=e.i(873517),u=e.i(137667),x=e.i(959752),g=e.i(481162),h=e.i(503160),v=e.i(955371),f=e.i(390622),b=e.i(124836),y=e.i(925521),j=e.i(923978),C=e.i(648404);let w=(0,r.createContext)({readonly:!1,appId:"",isAPIKeySet:!1,isTrailFinished:!1,mode:C.AppModeEnum.CHAT,modelModeType:C.ModelModeType.chat,promptMode:j.PromptMode.simple,setPromptMode:b.noop,isAdvancedMode:!1,isAgent:!1,isFunctionCall:!1,isOpenAI:!1,collectionList:[],canReturnToSimpleMode:!1,setCanReturnToSimpleMode:b.noop,chatPromptConfig:y.DEFAULT_CHAT_PROMPT_CONFIG,completionPromptConfig:y.DEFAULT_COMPLETION_PROMPT_CONFIG,currentAdvancedPrompt:[],showHistoryModal:b.noop,conversationHistoriesRole:{user_prefix:"user",assistant_prefix:"assistant"},setConversationHistoriesRole:b.noop,setCurrentAdvancedPrompt:b.noop,hasSetBlockStatus:{context:!1,history:!1,query:!1},conversationId:"",setConversationId:b.noop,introduction:"",setIntroduction:b.noop,suggestedQuestions:[],setSuggestedQuestions:b.noop,controlClearChatMessage:0,setControlClearChatMessage:b.noop,prevPromptConfig:{prompt_template:"",prompt_variables:[]},setPrevPromptConfig:b.noop,moreLikeThisConfig:{enabled:!1},setMoreLikeThisConfig:b.noop,suggestedQuestionsAfterAnswerConfig:{enabled:!1},setSuggestedQuestionsAfterAnswerConfig:b.noop,speechToTextConfig:{enabled:!1},setSpeechToTextConfig:b.noop,textToSpeechConfig:{enabled:!1,voice:"",language:""},setTextToSpeechConfig:b.noop,citationConfig:{enabled:!1},setCitationConfig:b.noop,moderationConfig:{enabled:!1},annotationConfig:{id:"",enabled:!1,score_threshold:y.ANNOTATION_DEFAULT.score_threshold,embedding_model:{embedding_model_name:"",embedding_provider_name:""}},setAnnotationConfig:b.noop,setModerationConfig:b.noop,externalDataToolsConfig:[],setExternalDataToolsConfig:b.noop,formattingChanged:!1,setFormattingChanged:b.noop,inputs:{},setInputs:b.noop,query:"",setQuery:b.noop,completionParams:{max_tokens:16,temperature:1,top_p:1,presence_penalty:1,frequency_penalty:1},setCompletionParams:b.noop,modelConfig:{provider:"OPENAI",model_id:"gpt-3.5-turbo",mode:C.ModelModeType.unset,configs:{prompt_template:"",prompt_variables:[]},chat_prompt_config:y.DEFAULT_CHAT_PROMPT_CONFIG,completion_prompt_config:y.DEFAULT_COMPLETION_PROMPT_CONFIG,more_like_this:null,opening_statement:"",suggested_questions:[],sensitive_word_avoidance:null,speech_to_text:null,text_to_speech:null,file_upload:null,suggested_questions_after_answer:null,retriever_resource:null,annotation_reply:null,external_data_tools:[],system_parameters:{audio_file_size_limit:0,file_size_limit:0,image_file_size_limit:0,video_file_size_limit:0,workflow_file_upload_limit:0},dataSets:[],agentConfig:y.DEFAULT_AGENT_SETTING},setModelConfig:b.noop,dataSets:[],showSelectDataSet:b.noop,setDataSets:b.noop,datasetConfigs:{retrieval_model:C.RETRIEVE_TYPE.multiWay,reranking_model:{reranking_provider_name:"",reranking_model_name:""},top_k:4,score_threshold_enabled:!1,score_threshold:.7,datasets:{datasets:[]}},datasetConfigsRef:{current:null},setDatasetConfigs:b.noop,hasSetContextVar:!1,isShowVisionConfig:!1,visionConfig:{enabled:!1,number_limits:2,detail:C.Resolution.low,transfer_methods:[C.TransferMethod.remote_url]},setVisionConfig:b.noop,isAllowVideoUpload:!1,isShowDocumentConfig:!1,isShowAudioConfig:!1,rerankSettingModalOpen:!1,setRerankSettingModalOpen:b.noop});e.s(["default",0,w,"useDebugConfigurationContext",0,()=>(0,r.useContext)(w)],265630);var _=e.i(168014),N=e.i(203956);let k=s.memo(e=>{let{value:t,onChange:l,maxLength:r}=e;return(0,s.useEffect)(()=>{t&&t>r&&l(r)},[t,r,l]),(0,a.jsx)("div",{children:(0,a.jsx)(d.default,{type:"number",max:r,min:1,value:t||"",onChange:e=>{let a=Number.parseInt(e.target.value,10);a>r?a=r:a<1&&(a=1),l(a)}})})});var T=e.i(151094);let M=s.memo(e=>{let{onConfirm:t,onCancel:s}=e,{t:r}=(0,l.useTranslation)();return(0,a.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,a.jsx)(T.default,{onClick:s,children:r("operation.cancel",{ns:"common"})}),(0,a.jsx)(T.default,{variant:"primary",onClick:t,children:r("operation.save",{ns:"common"})})]})}),E=JSON.stringify({type:"object",properties:{foo:{type:"string"},bar:{type:"object",properties:{sub:{type:"number"}},required:[],additionalProperties:!0}},required:[],additionalProperties:!0},null,2);var S=e.i(501371),F=e.i(516457),V=e.i(83278),I=e.i(391185),D=e.i(111378),R=e.i(963855),O=e.i(935139);let P=e=>{let{value:t,onSelect:l,items:r,popupInnerClassName:n,readonly:i}=e,[o,d]=(0,s.useState)(!1),m=t?r.find(e=>e.value===t):void 0;return(0,a.jsxs)(I.PortalToFollowElem,{open:o,onOpenChange:d,placement:"bottom-start",offset:4,children:[(0,a.jsx)(I.PortalToFollowElemTrigger,{onClick:()=>!i&&d(e=>!e),className:"w-full",children:(0,a.jsxs)("div",{className:(0,O.cn)(`group flex h-9 items-center justify-between rounded-lg border-0 bg-components-input-bg-normal px-2 text-sm hover:bg-state-base-hover-alt ${i?"cursor-not-allowed":"cursor-pointer"}`),title:m?.name,children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(D.default,{type:m?.value,className:"size-4 shrink-0 text-text-secondary"}),(0,a.jsx)("span",{className:`
              ml-1.5 text-components-input-text-filled ${!m?.name&&"text-components-input-text-placeholder"}
            `,children:m?.name})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,a.jsx)(V.default,{uppercase:!1,children:(0,R.inputVarTypeToVarType)(m?.value)}),(0,a.jsx)(F.ChevronDownIcon,{className:(0,O.cn)("h-4 w-4 shrink-0 text-text-quaternary group-hover:text-text-secondary",o&&"text-text-secondary")})]})]})}),(0,a.jsx)(I.PortalToFollowElemContent,{className:"z-[61]",children:(0,a.jsx)("div",{className:(0,O.cn)("w-[432px] rounded-md border-[0.5px] border-components-panel-border bg-components-panel-bg px-1 py-1 text-base shadow-lg focus:outline-none sm:text-sm",n),children:r.map(e=>(0,a.jsxs)("div",{className:"flex h-9 cursor-pointer items-center justify-between rounded-lg px-2 text-text-secondary hover:bg-state-base-hover",title:e.name,onClick:()=>{l(e),d(!1)},children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(D.default,{type:e.value,className:"size-4 shrink-0 text-text-secondary"}),(0,a.jsx)("span",{title:e.name,children:e.name})]}),(0,a.jsx)(V.default,{uppercase:!1,children:(0,R.inputVarTypeToVarType)(e.value)})]},e.value))})})]})},A="true",L="false",q=s.memo(e=>{let{isCreate:b,payload:y,isShow:j,onClose:T,onConfirm:F,supportFile:V}=e,{modelConfig:I}=(0,r.useContext)(w),{t:D}=(0,l.useTranslation)(),[R,O]=(0,s.useState)(()=>{var e;return(e=y||(0,_.getNewVarInWorkflow)("")).type===f.InputVarType.select&&""===e.default?{...e,default:void 0}:e}),{type:q,label:z,variable:$,options:W,max_length:U}=R,G=(0,s.useRef)(null),K=(0,n.useStore)(e=>e.appDetail),B=K?.mode!==C.AppModeEnum.ADVANCED_CHAT&&K?.mode!==C.AppModeEnum.WORKFLOW,H=(0,s.useMemo)(()=>{if(q!==f.InputVarType.jsonObject||!R.json_schema)return"";try{return R.json_schema}catch{return""}},[R.json_schema]);(0,s.useEffect)(()=>{j&&G.current?.focus()},[j]);let Q=q===f.InputVarType.textInput||q===f.InputVarType.paragraph,Y=(0,s.useCallback)((e,a)=>{let{isValid:t,errorMessageKey:s}=(0,_.checkKeys)([e],a);return!!t||(u.default.notify({type:"error",message:D(`varKeyError.${s}`,{ns:"appDebug",key:D("variableConfig.varName",{ns:"appDebug"})})}),!1)},[D]),J=(0,s.useCallback)(e=>a=>{O(t=>{let s={...t,[e]:a};return"options"===e&&t.default&&((Array.isArray(a)?a:[]).includes(t.default)||(s.default=void 0)),s})},[]),X=(0,s.useCallback)(e=>{if(null==e||""===e.trim())return J("json_schema")(void 0),null;try{let a=JSON.parse(e);J("json_schema")(JSON.stringify(a,null,2))}catch{return null}},[J]),Z=[{name:D("variableConfig.text-input",{ns:"appDebug"}),value:f.InputVarType.textInput},{name:D("variableConfig.paragraph",{ns:"appDebug"}),value:f.InputVarType.paragraph},{name:D("variableConfig.select",{ns:"appDebug"}),value:f.InputVarType.select},{name:D("variableConfig.number",{ns:"appDebug"}),value:f.InputVarType.number},{name:D("variableConfig.checkbox",{ns:"appDebug"}),value:f.InputVarType.checkbox},...V?[{name:D("variableConfig.single-file",{ns:"appDebug"}),value:f.InputVarType.singleFile},{name:D("variableConfig.multi-files",{ns:"appDebug"}),value:f.InputVarType.multiFiles}]:[],...B?[]:[{name:D("variableConfig.json",{ns:"appDebug"}),value:f.InputVarType.jsonObject}]],ee=(0,s.useCallback)(e=>{let a=e.value;O((0,t.produce)(R,e=>{e.type=a,a===f.InputVarType.select&&(e.default=void 0),[f.InputVarType.singleFile,f.InputVarType.multiFiles].includes(a)&&(Object.keys(x.DEFAULT_FILE_UPLOAD_SETTING).forEach(a=>{"max_length"!==a&&(e[a]=x.DEFAULT_FILE_UPLOAD_SETTING[a])}),a===f.InputVarType.multiFiles&&(e.max_length=x.DEFAULT_FILE_UPLOAD_SETTING.max_length))}))},[R]),ea=(0,s.useCallback)(e=>{let a=e.target.value;Y(a,!0)&&!R.label&&O(e=>({...e,label:a}))},[Y,R.label]),et=(0,s.useCallback)(e=>{(0,_.replaceSpaceWithUnderscoreInVarNameInput)(e.target);let a=e.target.value,{isValid:t,errorKey:s,errorMessageKey:l}=(0,_.checkKeys)([a],!0);t?J("variable")(e.target.value):u.default.notify({type:"error",message:D(`varKeyError.${l}`,{ns:"appDebug",key:s})})},[J,D]),es=(0,s.useMemo)(()=>{var e;return"boolean"==typeof(e=R.default)?e?A:L:"string"==typeof e&&e.toLowerCase()===A?A:L},[R.default]);return(0,a.jsxs)(m.default,{title:D(`variableConfig.${b?"addModalTitle":"editModalTitle"}`,{ns:"appDebug"}),isShow:j,onClose:T,children:[(0,a.jsx)("div",{className:"mb-8",ref:G,tabIndex:-1,children:(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(S.default,{title:D("variableConfig.fieldType",{ns:"appDebug"}),children:(0,a.jsx)(P,{value:q,items:Z,onSelect:ee})}),(0,a.jsx)(S.default,{title:D("variableConfig.varName",{ns:"appDebug"}),children:(0,a.jsx)(d.default,{value:$,onChange:et,onBlur:ea,placeholder:D("variableConfig.inputPlaceholder",{ns:"appDebug"})})}),(0,a.jsx)(S.default,{title:D("variableConfig.labelName",{ns:"appDebug"}),children:(0,a.jsx)(d.default,{value:z,onChange:e=>J("label")(e.target.value),placeholder:D("variableConfig.inputPlaceholder",{ns:"appDebug"})})}),Q&&(0,a.jsx)(S.default,{title:D("variableConfig.maxLength",{ns:"appDebug"}),children:(0,a.jsx)(k,{maxLength:q===f.InputVarType.textInput?256:1/0,modelId:I.model_id,value:U,onChange:J("max_length")})}),q===f.InputVarType.textInput&&(0,a.jsx)(S.default,{title:D("variableConfig.defaultValue",{ns:"appDebug"}),children:(0,a.jsx)(d.default,{value:R.default||"",onChange:e=>J("default")(e.target.value||void 0),placeholder:D("variableConfig.inputPlaceholder",{ns:"appDebug"})})}),q===f.InputVarType.paragraph&&(0,a.jsx)(S.default,{title:D("variableConfig.defaultValue",{ns:"appDebug"}),children:(0,a.jsx)(p.default,{value:String(R.default??""),onChange:e=>J("default")(e.target.value||void 0),placeholder:D("variableConfig.inputPlaceholder",{ns:"appDebug"})})}),q===f.InputVarType.number&&(0,a.jsx)(S.default,{title:D("variableConfig.defaultValue",{ns:"appDebug"}),children:(0,a.jsx)(d.default,{type:"number",value:R.default||"",onChange:e=>J("default")(e.target.value||void 0),placeholder:D("variableConfig.inputPlaceholder",{ns:"appDebug"})})}),q===f.InputVarType.checkbox&&(0,a.jsx)(S.default,{title:D("variableConfig.defaultValue",{ns:"appDebug"}),children:(0,a.jsx)(c.SimpleSelect,{className:"w-full",optionWrapClassName:"max-h-[140px] overflow-y-auto",items:[{value:A,name:D("variableConfig.startChecked",{ns:"appDebug"})},{value:L,name:D("variableConfig.noDefaultSelected",{ns:"appDebug"})}],defaultValue:es,onSelect:e=>J("default")(String(e.value)===A),placeholder:D("variableConfig.selectDefaultValue",{ns:"appDebug"}),allowSearch:!1})}),q===f.InputVarType.select&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(S.default,{title:D("variableConfig.options",{ns:"appDebug"}),children:(0,a.jsx)(N.default,{options:W||[],onChange:J("options")})}),W&&W.length>0&&(0,a.jsx)(S.default,{title:D("variableConfig.defaultValue",{ns:"appDebug"}),children:(0,a.jsx)(c.SimpleSelect,{className:"w-full",optionWrapClassName:"max-h-[140px] overflow-y-auto",items:[{value:"",name:D("variableConfig.noDefaultValue",{ns:"appDebug"})},...W.filter(e=>""!==e.trim()).map(e=>({value:e,name:e}))],defaultValue:R.default||"",onSelect:e=>J("default")(""===e.value?void 0:e.value),placeholder:D("variableConfig.selectDefaultValue",{ns:"appDebug"}),allowSearch:!1},`default-select-${W.join("-")}`)})]}),[f.InputVarType.singleFile,f.InputVarType.multiFiles].includes(q)&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(h.default,{payload:R,onChange:e=>O(e),isMultiple:q===f.InputVarType.multiFiles}),(0,a.jsx)(S.default,{title:D("variableConfig.defaultValue",{ns:"appDebug"}),children:(0,a.jsx)(o.FileUploaderInAttachmentWrapper,{value:q===f.InputVarType.singleFile?R.default?[R.default]:[]:R.default||[],onChange:e=>{q===f.InputVarType.singleFile?J("default")(e?.[0]||void 0):J("default")(e||void 0)},fileConfig:{allowed_file_types:R.allowed_file_types||[f.SupportUploadFileTypes.document],allowed_file_extensions:R.allowed_file_extensions||[],allowed_file_upload_methods:R.allowed_file_upload_methods||[C.TransferMethod.remote_url],number_limits:q===f.InputVarType.singleFile?1:R.max_length||5}})})]}),q===f.InputVarType.jsonObject&&(0,a.jsx)(S.default,{title:D("variableConfig.jsonSchema",{ns:"appDebug"}),isOptional:!0,children:(0,a.jsx)(g.default,{language:v.CodeLanguage.json,value:H,onChange:X,noWrapper:!0,className:"bg h-[80px] overflow-y-auto rounded-[10px] bg-components-input-bg-normal p-1",placeholder:(0,a.jsx)("div",{className:"whitespace-pre",children:E})})}),(0,a.jsxs)("div",{className:"!mt-5 flex h-6 items-center space-x-2",children:[(0,a.jsx)(i.default,{checked:R.required,disabled:R.hide,onCheck:()=>J("required")(!R.required)}),(0,a.jsx)("span",{className:"system-sm-semibold text-text-secondary",children:D("variableConfig.required",{ns:"appDebug"})})]}),(0,a.jsxs)("div",{className:"!mt-5 flex h-6 items-center space-x-2",children:[(0,a.jsx)(i.default,{checked:R.hide,disabled:R.required,onCheck:()=>J("hide")(!R.hide)}),(0,a.jsx)("span",{className:"system-sm-semibold text-text-secondary",children:D("variableConfig.hide",{ns:"appDebug"})})]})]})}),(0,a.jsx)(M,{onConfirm:()=>{let e=R.json_schema,a=null==e||"string"==typeof e&&""===e.trim(),t=a?void 0:e,s=R.type===f.InputVarType.jsonObject&&a?{...R,json_schema:void 0}:R,l=R.variable===y?.variable?void 0:{type:f.ChangeType.changeVarName,payload:{beforeKey:y?.variable||"",afterKey:R.variable}};if(Y(R.variable)){if(!R.label)return void u.default.notify({type:"error",message:D("variableConfig.errorMsg.labelNameRequired",{ns:"appDebug"})});if(Q||q===f.InputVarType.number)F(s,l);else if(q===f.InputVarType.select){if(W?.length===0)return void u.default.notify({type:"error",message:D("variableConfig.errorMsg.atLeastOneOption",{ns:"appDebug"})});let e={},a=!1;if(W?.forEach(t=>{if(e[t]){a=!0;return}e[t]=!0}),a)return void u.default.notify({type:"error",message:D("variableConfig.errorMsg.optionRepeat",{ns:"appDebug"})});F(s,l)}else if([f.InputVarType.singleFile,f.InputVarType.multiFiles].includes(q)){if(R.allowed_file_types?.length===0){let e=D("errorMsg.fieldRequired",{ns:"workflow",field:D("variableConfig.file.supportFileTypes",{ns:"appDebug"})});u.default.notify({type:"error",message:e});return}if(R.allowed_file_types?.includes(f.SupportUploadFileTypes.custom)&&!R.allowed_file_extensions?.length){let e=D("errorMsg.fieldRequired",{ns:"workflow",field:D("variableConfig.file.custom.name",{ns:"appDebug"})});u.default.notify({type:"error",message:e});return}F(s,l)}else if(q===f.InputVarType.jsonObject){if(!a&&"string"==typeof t)try{let e=JSON.parse(t);if(e?.type!=="object")return void u.default.notify({type:"error",message:D("variableConfig.errorMsg.jsonSchemaMustBeObject",{ns:"appDebug"})})}catch{u.default.notify({type:"error",message:D("variableConfig.errorMsg.jsonSchemaInvalid",{ns:"appDebug"})});return}F(s,l)}else F(s,l)}},onCancel:T})]})});e.s(["default",0,q],112142)},514112,e=>{"use strict";var a=e.i(563199),t=e.i(837699),s=e.i(417944),l=e.i(914697),r=e.i(268255);e.i(152567);var n=e.i(408767),i=e.i(151094),o=e.i(547105);e.i(36860);var d=e.i(705557),m=e.i(449980),c=e.i(21151),p=e.i(137667),u=e.i(739255),x=e.i(225162),g=e.i(337464),h=e.i(459760),v=e.i(632815),f=e.i(934465),b=e.i(526330),y=e.i(621544),j=e.i(981744),C=e.i(313746),w=e.i(904962),_=e.i(337352),N=e.i(513203);let k=e=>{let{Icon:t,text:s,onClick:l}=e;return(0,a.jsxs)("div",{className:"mr-1 mt-2 flex h-7 shrink-0 cursor-pointer items-center rounded-lg bg-components-button-secondary-bg px-2",onClick:l,children:[(0,a.jsx)(t,{className:"h-4 w-4 text-text-tertiary"}),(0,a.jsx)("div",{className:"ml-1 text-xs font-medium text-text-secondary",children:s})]})},T=r.memo(e=>{let{mode:T,isShow:M,onClose:E,flowId:S,nodeId:F,editorId:V,currentPrompt:I,isBasicMode:D,onFinished:R}=e,{t:O}=(0,n.useTranslation)(),P=localStorage.getItem("auto-gen-model")?JSON.parse(localStorage.getItem("auto-gen-model")):null,[A,L]=r.useState(P||{name:"",provider:"",mode:T,completion_params:{}}),{defaultModel:q}=(0,x.useModelListAndDefaultModelAndCurrentProviderAndModel)(u.ModelTypeEnum.textGeneration),z=[{icon:t.RiTerminalBoxLine,key:"pythonDebugger"},{icon:t.RiTranslate,key:"translation"},{icon:t.RiPresentationLine,key:"meetingTakeaways"},{icon:t.RiNewspaperLine,key:"writingsPolisher"},{icon:t.RiUser2Line,key:"professionalAnalyst"},{icon:t.RiFileExcel2Line,key:"excelFormulaExpert"},{icon:t.RiRoadMapLine,key:"travelPlanning"},{icon:t.RiDatabase2Line,key:"SQLSorcerer"},{icon:t.RiGitCommitLine,key:"GitGud"}],[$,W]=(0,l.useSessionStorageState)(`improve-instruction-${S}${D?"":`-${F}${V?`-${V}`:""}`}`),U=$||"",[G,K]=(0,r.useState)(""),[B,H]=(0,r.useState)(`${S}-0`),Q=(0,r.useCallback)(e=>()=>{W(O(`generate.template.${e}.instruction`,{ns:"appDebug"})),H(`${S}-${Date.now()}`)},[O]),{data:Y}=(0,v.useGenerateRuleTemplate)(_.GeneratorType.prompt,D);(0,r.useEffect)(()=>{!U&&Y&&W(Y.data),H(`${S}-${Date.now()}`)},[Y]);let[J,{setTrue:X,setFalse:Z}]=(0,s.useBoolean)(!1),ee=`${S}${D?"":`-${F}${V?`-${V}`:""}`}`,{addVersion:ea,current:et,currentVersionIndex:es,setCurrentVersionIndex:el,versions:er}=(0,N.default)({storageKey:ee});(0,r.useEffect)(()=>{if(q){let e=localStorage.getItem("auto-gen-model")?JSON.parse(localStorage.getItem("auto-gen-model")||""):null;e?L(e):L(e=>({...e,name:q.model,provider:q.provider.provider}))}},[q]);let en=(0,a.jsxs)("div",{className:"flex h-full w-0 grow flex-col items-center justify-center space-y-3",children:[(0,a.jsx)(m.default,{}),(0,a.jsx)("div",{className:"text-[13px] text-text-tertiary",children:O("generate.loading",{ns:"appDebug"})})]}),ei=(0,r.useCallback)(e=>{let a={...A,provider:e.provider,name:e.modelId,mode:e.mode};L(a),localStorage.setItem("auto-gen-model",JSON.stringify(a))},[A,L]),eo=(0,r.useCallback)(e=>{let a={...A,completion_params:e};L(a),localStorage.setItem("auto-gen-model",JSON.stringify(a))},[A,L]),ed=async()=>{if((""!==U.trim()||(p.default.notify({type:"error",message:O("errorMsg.fieldRequired",{ns:"common",field:O("generate.instruction",{ns:"appDebug"})})}),0))&&!J){X();try{let e,a=!1;if(D||!I){let{error:t,...s}=await (0,h.generateBasicAppFirstTimeRule)({instruction:U,model_config:A,no_variable:!1});e={...s,modified:s.prompt},t&&(a=!0,p.default.notify({type:"error",message:t}))}else{let{error:t,...s}=await (0,h.generateRule)({flow_id:S,node_id:F,current:I,instruction:U,ideal_output:G,model_config:A});e=s,t&&(a=!0,p.default.notify({type:"error",message:t}))}a||ea(e)}finally{Z()}}},[em,{setTrue:ec,setFalse:ep}]=(0,s.useBoolean)(!1);return(0,a.jsx)(c.default,{isShow:M,onClose:E,className:"min-w-[1140px] !p-0",children:(0,a.jsxs)("div",{className:"flex h-[680px] flex-wrap",children:[(0,a.jsxs)("div",{className:"h-full w-[570px] shrink-0 overflow-y-auto border-r border-divider-regular p-6",children:[(0,a.jsxs)("div",{className:"mb-5",children:[(0,a.jsx)("div",{className:`text-lg font-bold leading-[28px] ${w.default.textGradient}`,children:O("generate.title",{ns:"appDebug"})}),(0,a.jsx)("div",{className:"mt-1 text-[13px] font-normal text-text-tertiary",children:O("generate.description",{ns:"appDebug"})})]}),(0,a.jsx)("div",{children:(0,a.jsx)(g.default,{popupClassName:"!w-[520px]",portalToFollowElemContentClassName:"z-[1000]",isAdvancedMode:!0,provider:A.provider,completionParams:A.completion_params,modelId:A.name,setModel:ei,onCompletionParamsChange:eo,hideDebugWithMultipleModel:!0})}),D&&(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("div",{className:"mr-3 shrink-0 text-xs font-semibold uppercase leading-[18px] text-text-tertiary",children:O("generate.tryIt",{ns:"appDebug"})}),(0,a.jsx)("div",{className:"h-px grow",style:{background:"linear-gradient(to right, rgba(243, 244, 246, 1), rgba(243, 244, 246, 0))"}})]}),(0,a.jsx)("div",{className:"flex flex-wrap",children:z.map(e=>(0,a.jsx)(k,{Icon:e.icon,text:O(`generate.template.${e.key}.name`,{ns:"appDebug"}),onClick:Q(e.key)},e.key))})]}),(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"system-sm-semibold-uppercase mb-1.5 text-text-secondary",children:O("generate.instruction",{ns:"appDebug"})}),D?(0,a.jsx)(b.default,{editorKey:B,generatorType:_.GeneratorType.prompt,value:U,onChange:W,availableVars:[],availableNodes:[],isShowCurrentBlock:!!I,isShowLastRunBlock:!1}):(0,a.jsx)(y.default,{editorKey:B,generatorType:_.GeneratorType.prompt,value:U,onChange:W,nodeId:F||"",isShowCurrentBlock:!!I})]}),(0,a.jsx)(f.default,{value:G,onChange:K}),(0,a.jsxs)("div",{className:"mt-7 flex justify-end space-x-2",children:[(0,a.jsx)(i.default,{onClick:E,children:O("generate.dismiss",{ns:"appDebug"})}),(0,a.jsxs)(i.default,{className:"flex space-x-1",variant:"primary",onClick:ed,disabled:J,children:[(0,a.jsx)(d.Generator,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"text-xs font-semibold",children:O("generate.generate",{ns:"appDebug"})})]})]})]})]}),!J&&et&&(0,a.jsx)("div",{className:"h-full w-0 grow bg-background-default-subtle p-6 pb-0",children:(0,a.jsx)(C.default,{current:et,isBasicMode:D,nodeId:F,currentVersionIndex:es||0,setCurrentVersionIndex:el,versions:er||[],onApply:ec,generatorType:_.GeneratorType.prompt})}),J&&en,!J&&!et&&(0,a.jsx)(j.default,{}),em&&(0,a.jsx)(o.default,{title:O("generate.overwriteTitle",{ns:"appDebug"}),content:O("generate.overwriteMessage",{ns:"appDebug"}),isShow:!0,onConfirm:()=>{ep(),R(et)},onCancel:ep})]})})});e.s(["default",0,T])},888031,160659,e=>{"use strict";e.s(["default",()=>n],888031);var a=e.i(563199),t=e.i(268255);e.i(288243);var s=e.i(670977),l=e.i(935139);e.s(["default",()=>r],160659);let r=e=>{let{title:t,children:s,collapsed:l,onCollapse:r,operations:i}=e;return(0,a.jsx)("div",{className:"py-4",children:(0,a.jsx)(n,{trigger:(0,a.jsx)("div",{className:"system-sm-semibold-uppercase flex h-6 cursor-pointer items-center text-text-secondary",children:t}),operations:i,collapsed:l,onCollapse:r,children:(0,a.jsx)("div",{className:"px-4",children:s})})})},n=e=>{let{disabled:r,trigger:n,children:i,collapsed:o,onCollapse:d,operations:m,hideCollapseIcon:c}=e,[p,u]=(0,t.useState)(!0),x=void 0!==o?o:p,g=(0,t.useMemo)(()=>r?null:(0,a.jsx)(s.ArrowDownRoundFill,{className:(0,l.cn)("h-4 w-4 cursor-pointer text-text-quaternary group-hover/collapse:text-text-secondary",x&&"rotate-[270deg]")}),[x,r]);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"group/collapse flex items-center",children:[(0,a.jsxs)("div",{className:"ml-4 flex grow items-center",onClick:()=>{r||(u(!x),d?.(!x))},children:["function"==typeof n?n(g):n,!c&&(0,a.jsx)("div",{className:"h-4 w-4 shrink-0",children:g})]}),m]}),!x&&i]})}},684194,517827,598125,696481,8176,657419,e=>{"use strict";var a,t,s,l,r=((a={}).and="and",a.or="or",a),n=((t={}).contains="contains",t.notContains="not contains",t.startWith="start with",t.endWith="end with",t.is="is",t.isNot="is not",t.empty="empty",t.notEmpty="not empty",t.equal="=",t.notEqual="≠",t.largerThan=">",t.lessThan="<",t.largerThanOrEqual="≥",t.lessThanOrEqual="≤",t.isNull="is null",t.isNotNull="is not null",t.in="in",t.notIn="not in",t.allOf="all of",t.exists="exists",t.notExists="not exists",t.before="before",t.after="after",t),i=((s={}).disabled="disabled",s.automatic="automatic",s.manual="manual",s),o=((l={}).string="string",l.number="number",l.time="time",l.select="select",l);e.s(["ComparisonOperator",()=>n,"LogicalOperator",()=>r,"MetadataFilteringModeEnum",()=>i,"MetadataFilteringVariableType",()=>o],684194);var d=e.i(563199),m=e.i(837699),c=e.i(268255);e.i(152567);var p=e.i(408767),u=e.i(151094),x=e.i(291631),g=e.i(391185),h=e.i(935139);let v=(0,c.memo)(e=>{let{type:a,className:t}=e;return(0,d.jsxs)(d.Fragment,{children:[(a===o.string||a===o.select)&&(0,d.jsx)(m.RiTextSnippet,{className:(0,h.cn)("h-3.5 w-3.5",t)}),a===o.number&&(0,d.jsx)(m.RiHashtag,{className:(0,h.cn)("h-3.5 w-3.5",t)}),a===o.time&&(0,d.jsx)(m.RiTimeLine,{className:(0,h.cn)("h-3.5 w-3.5",t)})]})});e.s(["default",0,v],517827),e.s(["default",0,e=>{let{metadataList:a,handleAddCondition:t}=e,{t:s}=(0,p.useTranslation)(),[l,r]=(0,c.useState)(!1),[n,i]=(0,c.useState)(""),o=(0,c.useMemo)(()=>a?.filter(e=>e.name.includes(n)),[a,n]),h=(0,c.useCallback)(e=>{t?.(e),r(!1)},[t]);return(0,d.jsxs)(g.PortalToFollowElem,{open:l,onOpenChange:r,placement:"bottom-start",offset:{mainAxis:3,crossAxis:0},children:[(0,d.jsx)(g.PortalToFollowElemTrigger,{onClick:()=>r(!l),children:(0,d.jsxs)(u.default,{size:"small",variant:"secondary",children:[(0,d.jsx)(m.RiAddLine,{className:"h-3.5 w-3.5"}),s("nodes.knowledgeRetrieval.metadata.panel.add",{ns:"workflow"})]})}),(0,d.jsx)(g.PortalToFollowElemContent,{className:"z-10",children:(0,d.jsxs)("div",{className:"w-[320px] rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow-lg",children:[(0,d.jsx)("div",{className:"p-2 pb-1",children:(0,d.jsx)(x.default,{showLeftIcon:!0,placeholder:s("nodes.knowledgeRetrieval.metadata.panel.search",{ns:"workflow"}),value:n,onChange:e=>i(e.target.value)})}),(0,d.jsx)("div",{className:"p-1",children:o?.map(e=>(0,d.jsxs)("div",{className:"system-sm-medium flex h-6 cursor-pointer items-center rounded-md px-3 text-text-secondary hover:bg-state-base-hover",children:[(0,d.jsx)("div",{className:"mr-1 p-[1px]",children:(0,d.jsx)(v,{type:e.type})}),(0,d.jsx)("div",{className:"grow truncate",title:e.name,onClick:()=>h(e),children:e.name}),(0,d.jsx)("div",{className:"system-xs-regular shrink-0 text-text-tertiary",children:e.type})]},e.name))})]})})]})}],598125);var f=e.i(585458),b=e.i(836137),y=e.i(711536);e.s(["default",0,e=>{let{value:a,onChange:t}=e,{t:s}=(0,p.useTranslation)(),{userProfile:{timezone:l}}=(0,y.useAppContext)(),r=(0,c.useCallback)(e=>{e?t(e.unix()):t()},[t]),n=(0,c.useCallback)(e=>{let{handleClickTrigger:t}=e;return(0,d.jsxs)("div",{className:"group flex items-center",onClick:t,children:[(0,d.jsx)("div",{className:(0,h.cn)("system-sm-regular mr-0.5 flex h-6 grow cursor-pointer items-center px-1",a?"text-text-secondary":"text-text-tertiary"),children:a?(0,f.default)(1e3*a).tz(l).format("MMMM DD YYYY HH:mm A"):s("nodes.knowledgeRetrieval.metadata.panel.datePlaceholder",{ns:"workflow"})}),!!a&&(0,d.jsx)(m.RiCloseCircleFill,{className:(0,h.cn)("hidden h-4 w-4 shrink-0 cursor-pointer hover:text-components-input-text-filled group-hover:block",a&&"text-text-quaternary"),onClick:e=>{e.stopPropagation(),r()}}),(0,d.jsx)(m.RiCalendarLine,{className:(0,h.cn)("block h-4 w-4 shrink-0",a?"text-text-quaternary":"text-text-tertiary",a&&"group-hover:hidden")})]})},[a,r,l,s]);return(0,d.jsx)("div",{className:"h-8 px-2 py-1",children:(0,d.jsx)(b.default,{timezone:l,value:a?(0,f.default)(1e3*a):void 0,onChange:r,onClear:r,renderTrigger:n})})}],696481),e.i(39598);var j=e.i(678383);e.s(["default",0,e=>{let{variables:a=[],value:t,onChange:s,varType:l}=e,{t:r}=(0,p.useTranslation)(),[n,i]=(0,c.useState)(!1),o=a.find(e=>e.value===t),m=(0,c.useCallback)(e=>{s(e),i(!1)},[s]);return(0,d.jsxs)(g.PortalToFollowElem,{open:n,onOpenChange:i,placement:"bottom-start",offset:{mainAxis:4,crossAxis:0},children:[(0,d.jsx)(g.PortalToFollowElemTrigger,{asChild:!0,onClick:()=>{a.length&&i(!n)},children:(0,d.jsxs)("div",{className:"flex h-6 grow cursor-pointer items-center",children:[o&&(0,d.jsxs)("div",{className:"system-xs-medium inline-flex h-6 items-center rounded-md border-[0.5px] border-components-panel-border-subtle bg-components-badge-white-to-dark pl-[5px] pr-1.5 text-text-secondary shadow-xs",children:[(0,d.jsx)(j.Variable02,{className:"mr-1 h-3.5 w-3.5 text-text-accent"}),o.value]}),!o&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{className:"system-sm-regular flex grow items-center text-components-input-text-placeholder",children:[(0,d.jsx)(j.Variable02,{className:"mr-1 h-4 w-4"}),r("nodes.knowledgeRetrieval.metadata.panel.select",{ns:"workflow"})]}),(0,d.jsx)("div",{className:"system-2xs-medium flex h-5 shrink-0 items-center rounded-[5px] border border-divider-deep px-[5px] text-text-tertiary",children:l})]})]})}),(0,d.jsx)(g.PortalToFollowElemContent,{className:"z-[1000]",children:(0,d.jsx)("div",{className:"w-[200px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg-blur p-1 shadow-lg",children:a.map(e=>(0,d.jsxs)("div",{className:"system-xs-medium flex h-6 cursor-pointer items-center rounded-md px-2 text-text-secondary hover:bg-state-base-hover",onClick:()=>m(e.value),children:[(0,d.jsx)(j.Variable02,{className:"mr-1 h-4 w-4 text-text-accent"}),e.value]},e.value))})})]})}],8176);var C=e.i(403861);let w=["variable","constant"];e.s(["default",0,e=>{let{valueMethod:a="variable",onValueMethodChange:t}=e,[s,l]=(0,c.useState)(!1);return(0,d.jsxs)(g.PortalToFollowElem,{open:s,onOpenChange:l,placement:"bottom-start",offset:{mainAxis:4,crossAxis:0},children:[(0,d.jsx)(g.PortalToFollowElemTrigger,{asChild:!0,onClick:()=>l(e=>!e),children:(0,d.jsxs)(u.default,{className:"shrink-0",variant:"ghost",size:"small",children:[(0,C.capitalize)(a),(0,d.jsx)(m.RiArrowDownSLine,{className:"ml-[1px] h-3.5 w-3.5"})]})}),(0,d.jsx)(g.PortalToFollowElemContent,{className:"z-[1000]",children:(0,d.jsx)("div",{className:"w-[112px] rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur p-1 shadow-lg",children:w.map(e=>(0,d.jsx)("div",{className:(0,h.cn)("flex h-7 cursor-pointer items-center rounded-md px-3 hover:bg-state-base-hover","text-[13px] font-medium text-text-secondary",a===e&&"bg-state-base-hover"),onClick:()=>{a!==e&&(t(e),l(!1))},children:(0,C.capitalize)(e)},e))})})]})}],657419)},269398,e=>{"use strict";var a=e.i(563199),t=e.i(268255);e.i(152567);var s=e.i(408767),l=e.i(192447),r=e.i(963855);e.i(603198);var n=e.i(971481),n=n,i=e.i(390622);e.i(905691);var o=e.i(48498);e.s(["default",0,e=>{let{valueSelector:d,varType:m,isShort:c,availableNodes:p}=e,u=(0,l.useNodes)(),x=(0,r.isRagVariableVar)(d),g=(0,t.useMemo)(()=>{if((0,r.isSystemVar)(d)){let e=p?.find(e=>e.data.type===i.BlockEnum.Start);if(e)return e}return(0,r.getNodeInfoById)(p||u,x?d[1]:d[0])},[u,d,p,x]),h=(0,r.isENV)(d),v=(0,r.isConversationVar)(d),f=(0,r.isGlobalVar)(d),b=!!g||h||v||x||f,y=(0,r.isSystemVar)(d)?d.slice(0).join("."):d.slice(1).join("."),j=(0,o.isExceptionVariable)(y,g?.data.type),C=(0,l.useReactFlow)(),w=(0,l.useStoreApi)(),_=(0,t.useCallback)(()=>{let{clientWidth:e,clientHeight:a}=document.getElementById("workflow-container"),{setViewport:t}=C,{transform:s}=w.getState(),l=s[2],r=g.position;t({x:(e-400-g.width*l)/2-r.x*l,y:(a-g.height*l)/2-r.y*l,zoom:s[2]})},[g,C,w]),{t:N}=(0,s.useTranslation)();return(0,a.jsx)(n.default,{variables:d,nodeType:g?.data.type,nodeTitle:g?.data.title,variableType:c?void 0:m,onClick:e=>{(e.metaKey||e.ctrlKey)&&(e.stopPropagation(),_())},errorMsg:b?void 0:N("errorMsg.invalidVariable",{ns:"workflow"}),isExceptionVariable:j})}],269398)},428594,e=>{"use strict";var a=e.i(563199),t=e.i(124836),s=e.i(268255);e.i(152567);var l=e.i(408767),r=e.i(421001),n=e.i(337464),i=e.i(888031),o=e.i(684194),d=e.i(837699),m=e.i(151094),c=e.i(391185),p=e.i(598125),u=e.i(935139),x=e.i(517827),g=e.i(696481),h=e.i(291631),v=e.i(390622),f=e.i(8176),b=e.i(657419);e.i(39598);var y=e.i(678383),j=e.i(269398),C=e.i(139269);let w=e=>{let{valueSelector:t=[],varType:r=v.VarType.string,availableNodes:n=[],nodesOutputVars:i=[],onChange:o}=e,{t:d}=(0,l.useTranslation)(),[m,p]=(0,s.useState)(!1),u=(0,s.useCallback)((e,a)=>{o(e,a),p(!1)},[o]);return(0,a.jsxs)(c.PortalToFollowElem,{open:m,onOpenChange:p,placement:"bottom-start",offset:{mainAxis:4,crossAxis:0},children:[(0,a.jsx)(c.PortalToFollowElemTrigger,{asChild:!0,onClick:()=>p(!m),children:(0,a.jsxs)("div",{className:"flex h-6 grow cursor-pointer items-center",children:[!!t.length&&(0,a.jsx)(j.default,{valueSelector:t,varType:r,availableNodes:n,isShort:!0}),!t.length&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"system-sm-regular flex grow items-center text-components-input-text-placeholder",children:[(0,a.jsx)(y.Variable02,{className:"mr-1 h-4 w-4"}),d("nodes.knowledgeRetrieval.metadata.panel.select",{ns:"workflow"})]}),(0,a.jsx)("div",{className:"system-2xs-medium flex h-5 shrink-0 items-center rounded-[5px] border border-divider-deep px-[5px] text-text-tertiary",children:r})]})]})}),(0,a.jsx)(c.PortalToFollowElemContent,{className:"z-[1000]",children:(0,a.jsx)("div",{className:"w-[296px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow-lg",children:(0,a.jsx)(C.default,{vars:i,isSupportFileVar:!0,onChange:u})})})]})},_=e=>{let{value:t,onChange:r,valueMethod:n,onValueMethodChange:i,nodesOutputVars:o,availableNodes:d,isCommonVariable:m,commonVariables:c}=e,{t:p}=(0,l.useTranslation)(),u=(0,s.useCallback)(e=>{r(`{{#${e.join(".")}#}}`)},[r]),x=(0,s.useCallback)(e=>{r(`{{${e}}}`)},[r]);return(0,a.jsxs)("div",{className:"flex h-8 items-center pl-1 pr-2",children:[(0,a.jsx)(b.default,{valueMethod:n,onValueMethodChange:i}),(0,a.jsx)("div",{className:"ml-1 mr-1.5 h-4 w-[1px] bg-divider-regular"}),"variable"===n&&!m&&(0,a.jsx)(w,{valueSelector:t?t.split("."):[],onChange:u,nodesOutputVars:o,availableNodes:d,varType:v.VarType.number}),"variable"===n&&m&&(0,a.jsx)(f.default,{variables:c,value:t,onChange:x,varType:v.VarType.number}),"constant"===n&&(0,a.jsx)(h.default,{className:"border-none bg-transparent outline-none hover:bg-transparent focus:bg-transparent focus:shadow-none",value:t,onChange:e=>{r(e.target.value?Number(e.target.value):void 0)},placeholder:p("nodes.knowledgeRetrieval.metadata.panel.placeholder",{ns:"workflow"}),type:"number"})]})},N=[o.ComparisonOperator.equal,o.ComparisonOperator.notEqual,o.ComparisonOperator.largerThan,o.ComparisonOperator.largerThanOrEqual,o.ComparisonOperator.lessThan,o.ComparisonOperator.lessThanOrEqual],k=e=>!!e&&[o.ComparisonOperator.empty,o.ComparisonOperator.notEmpty,o.ComparisonOperator.isNull,o.ComparisonOperator.isNotNull,o.ComparisonOperator.exists,o.ComparisonOperator.notExists].includes(e),T=/\{\{(#[\w-]{1,50}(\.[a-z_]\w{0,29}){1,10}#)\}\}/gi,M=/\{\{([\w-]{1,50})\}\}/g,E="nodes.ifElse",S=e=>{let{className:t,disabled:r,variableType:n,value:i,onSelect:p}=e,{t:x}=(0,l.useTranslation)(),[g,h]=(0,s.useState)(!1),v=(0,s.useMemo)(()=>(e=>{switch(e){case o.MetadataFilteringVariableType.string:case o.MetadataFilteringVariableType.select:return[o.ComparisonOperator.is,o.ComparisonOperator.isNot,o.ComparisonOperator.contains,o.ComparisonOperator.notContains,o.ComparisonOperator.startWith,o.ComparisonOperator.endWith,o.ComparisonOperator.empty,o.ComparisonOperator.notEmpty,o.ComparisonOperator.in,o.ComparisonOperator.notIn];case o.MetadataFilteringVariableType.number:return[o.ComparisonOperator.equal,o.ComparisonOperator.notEqual,o.ComparisonOperator.largerThan,o.ComparisonOperator.lessThan,o.ComparisonOperator.largerThanOrEqual,o.ComparisonOperator.lessThanOrEqual,o.ComparisonOperator.empty,o.ComparisonOperator.notEmpty];default:return[o.ComparisonOperator.is,o.ComparisonOperator.before,o.ComparisonOperator.after,o.ComparisonOperator.empty,o.ComparisonOperator.notEmpty]}})(n).map(e=>({label:e&&!N.includes(e)?x(`${E}.comparisonOperator.${e}`,{ns:"workflow"}):e,value:e})),[x,n]),f=v.find(e=>Array.isArray(i)?e.value===i[0]:e.value===i);return(0,a.jsxs)(c.PortalToFollowElem,{open:g,onOpenChange:h,placement:"bottom-end",offset:{mainAxis:4,crossAxis:0},children:[(0,a.jsx)(c.PortalToFollowElemTrigger,{onClick:()=>h(e=>!e),children:(0,a.jsxs)(m.default,{className:(0,u.cn)("shrink-0",!f&&"opacity-50",t),size:"small",variant:"ghost",disabled:r,children:[f?f.label:x(`${E}.select`,{ns:"workflow"}),(0,a.jsx)(d.RiArrowDownSLine,{className:"ml-1 h-3.5 w-3.5"})]})}),(0,a.jsx)(c.PortalToFollowElemContent,{className:"z-10",children:(0,a.jsx)("div",{className:"rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur p-1 shadow-lg",children:v.map(e=>(0,a.jsx)("div",{className:"flex h-7 cursor-pointer items-center rounded-lg px-3 py-1.5 text-[13px] font-medium text-text-secondary hover:bg-state-base-hover",onClick:()=>{p(e.value),h(!1)},children:e.label},e.value))})})]})},F=e=>{let{value:t,onChange:r,valueMethod:n="constant",onValueMethodChange:i,nodesOutputVars:o,availableNodes:d,isCommonVariable:m,commonVariables:c}=e,{t:p}=(0,l.useTranslation)(),u=(0,s.useCallback)(e=>{r(`{{#${e.join(".")}#}}`)},[r]),x=(0,s.useCallback)(e=>{r(`{{${e}}}`)},[r]);return(0,a.jsxs)("div",{className:"flex h-8 items-center pl-1 pr-2",children:[(0,a.jsx)(b.default,{valueMethod:n,onValueMethodChange:i}),(0,a.jsx)("div",{className:"ml-1 mr-1.5 h-4 w-[1px] bg-divider-regular"}),"variable"===n&&!m&&(0,a.jsx)(w,{valueSelector:t?t.split("."):[],onChange:u,nodesOutputVars:o,availableNodes:d,varType:v.VarType.string}),"variable"===n&&m&&(0,a.jsx)(f.default,{variables:c,value:t,onChange:x,varType:v.VarType.string}),"constant"===n&&(0,a.jsx)(h.default,{className:"border-none bg-transparent outline-none hover:bg-transparent focus:bg-transparent focus:shadow-none",value:t,onChange:e=>r(e.target.value),placeholder:p("nodes.knowledgeRetrieval.metadata.panel.placeholder",{ns:"workflow"})})]})},V=e=>{let{className:t,disabled:l,condition:r,onRemoveCondition:n,onUpdateCondition:i,metadataList:m=[],availableStringVars:c=[],availableStringNodesWithParent:p=[],availableNumberVars:h=[],availableNumberNodesWithParent:v=[],isCommonVariable:f,availableCommonStringVars:b=[],availableCommonNumberVars:y=[]}=e,[j,C]=(0,s.useState)(!1),w=(0,s.useMemo)(()=>!l,[l]),N=(0,s.useCallback)(()=>{n?.(r.id)},[n,r.id]),E=(0,s.useMemo)(()=>{if(r.metadata_id){let e=m.find(e=>e.id===r.metadata_id);if(e)return e}return m.find(e=>e.name===r.name)},[m,r.metadata_id,r.name]),V=(0,s.useCallback)(e=>{i?.(r.id,{...r,value:k(r.comparison_operator)?void 0:r.value,comparison_operator:e})},[i,r]),I=(0,s.useMemo)(()=>{if((E?.type===o.MetadataFilteringVariableType.string||E?.type===o.MetadataFilteringVariableType.number||E?.type===o.MetadataFilteringVariableType.select)&&"string"==typeof r.value){let e=f?M:T,a=f?2:3,t=r.value.match(e);if(t?.length)return{value:t[0].slice(a,-a),valueMethod:"variable"}}return{value:r.value,valueMethod:"constant"}},[E,r.value,f]),[D,R]=(0,s.useState)(I.valueMethod),O=(0,s.useCallback)(e=>{R(e),i?.(r.id,{...r,value:void 0})},[r,i]),P=(0,s.useCallback)(e=>{i?.(r.id,{...r,value:e})},[r,i]);return(0,a.jsxs)("div",{className:(0,u.cn)("mb-1 flex last-of-type:mb-0",t),children:[(0,a.jsxs)("div",{className:(0,u.cn)("grow rounded-lg bg-components-input-bg-normal",j&&"bg-state-destructive-hover"),children:[(0,a.jsxs)("div",{className:"flex items-center p-1",children:[(0,a.jsx)("div",{className:"w-0 grow",children:(0,a.jsxs)("div",{className:"flex h-6 min-w-0 items-center rounded-md border-[0.5px] border-components-panel-border-subtle bg-components-badge-white-to-dark pl-1 pr-1.5 shadow-xs",children:[(0,a.jsx)("div",{className:"mr-0.5 p-[1px]",children:(0,a.jsx)(x.default,{type:E?.type,className:"h-3 w-3"})}),(0,a.jsx)("div",{className:"system-xs-medium mr-0.5 min-w-0 flex-1 truncate text-text-secondary",children:E?.name}),(0,a.jsx)("div",{className:"system-xs-regular text-text-tertiary",children:E?.type})]})}),(0,a.jsx)("div",{className:"mx-1 h-3 w-[1px] bg-divider-regular"}),(0,a.jsx)(S,{disabled:!w,variableType:E?.type||o.MetadataFilteringVariableType.string,value:r.comparison_operator,onSelect:V})]}),(0,a.jsxs)("div",{className:"border-t border-t-divider-subtle",children:[!k(r.comparison_operator)&&(E?.type===o.MetadataFilteringVariableType.string||E?.type===o.MetadataFilteringVariableType.select)&&(0,a.jsx)(F,{valueMethod:D,onValueMethodChange:O,nodesOutputVars:c,availableNodes:p,value:I.value,onChange:P,isCommonVariable:f,commonVariables:b}),!k(r.comparison_operator)&&E?.type===o.MetadataFilteringVariableType.number&&(0,a.jsx)(_,{valueMethod:D,onValueMethodChange:O,nodesOutputVars:h,availableNodes:v,value:I.value,onChange:P,isCommonVariable:f,commonVariables:y}),!k(r.comparison_operator)&&E?.type===o.MetadataFilteringVariableType.time&&(0,a.jsx)(g.default,{value:r.value,onChange:P})]})]}),(0,a.jsx)("div",{className:"ml-1 mt-1 flex h-6 w-6 shrink-0 cursor-pointer items-center justify-center rounded-lg text-text-tertiary hover:bg-state-destructive-hover hover:text-text-destructive",onMouseEnter:()=>C(!0),onMouseLeave:()=>C(!1),onClick:N,children:(0,a.jsx)(d.RiDeleteBinLine,{className:"h-4 w-4"})})]})},I=e=>{let{disabled:t,metadataList:s=[],metadataFilteringConditions:l={conditions:[],logical_operator:o.LogicalOperator.and},handleRemoveCondition:r,handleToggleConditionLogicalOperator:n,handleUpdateCondition:i,availableStringVars:m,availableStringNodesWithParent:c,availableNumberVars:p,availableNumberNodesWithParent:x,isCommonVariable:g,availableCommonNumberVars:h,availableCommonStringVars:v}=e,{conditions:f,logical_operator:b}=l;return(0,a.jsxs)("div",{className:(0,u.cn)("relative"),children:[f.length>1&&(0,a.jsxs)("div",{className:(0,u.cn)("absolute bottom-0 left-0 top-0 w-[44px]"),children:[(0,a.jsx)("div",{className:"absolute bottom-4 right-1 top-4 w-2.5 rounded-l-[8px] border border-r-0 border-divider-deep"}),(0,a.jsx)("div",{className:"absolute right-0 top-1/2 h-[29px] w-4 -translate-y-1/2 bg-components-panel-bg"}),(0,a.jsxs)("div",{className:"absolute right-1 top-1/2 flex h-[21px] -translate-y-1/2 cursor-pointer select-none items-center rounded-md border-[0.5px] border-components-button-secondary-border bg-components-button-secondary-bg px-1 text-[10px] font-semibold text-text-accent-secondary shadow-xs",onClick:()=>n(),children:[b.toUpperCase(),(0,a.jsx)(d.RiLoopLeftLine,{className:"ml-0.5 h-3 w-3"})]})]}),(0,a.jsx)("div",{className:(0,u.cn)(f.length>1&&"pl-[44px]"),children:f.map(e=>(0,a.jsx)(V,{disabled:t,condition:e,onUpdateCondition:i,onRemoveCondition:r,metadataList:s,availableStringVars:m,availableStringNodesWithParent:c,availableNumberVars:p,availableNumberNodesWithParent:x,isCommonVariable:g,availableCommonStringVars:v,availableCommonNumberVars:h},`${e.id}`))})]})},D=e=>{let{metadataFilteringConditions:t,metadataList:s,onCancel:r,handleAddCondition:n,...i}=e,{t:o}=(0,l.useTranslation)();return(0,a.jsxs)("div",{className:"w-[420px] rounded-2xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-2xl",children:[(0,a.jsxs)("div",{className:"relative px-3 pt-3.5",children:[(0,a.jsx)("div",{className:"system-xl-semibold text-text-primary",children:o("nodes.knowledgeRetrieval.metadata.panel.title",{ns:"workflow"})}),(0,a.jsx)("div",{className:"absolute bottom-0 right-2.5 flex h-8 w-8 cursor-pointer items-center justify-center",onClick:r,children:(0,a.jsx)(d.RiCloseLine,{className:"h-4 w-4 text-text-tertiary"})})]}),(0,a.jsx)("div",{className:"px-1 py-2",children:(0,a.jsxs)("div",{className:"px-3 py-1",children:[(0,a.jsx)("div",{className:"pb-2",children:(0,a.jsx)(I,{metadataList:s,metadataFilteringConditions:t,...i})}),(0,a.jsx)(p.default,{metadataList:s,handleAddCondition:n})]})})]})},R=e=>{let{metadataFilteringConditions:t,metadataList:r=[],handleRemoveCondition:n,selectedDatasetsLoaded:i,...o}=e,{t:p}=(0,l.useTranslation)(),[u,x]=(0,s.useState)(!1),g=t?.conditions||[];return(0,s.useEffect)(()=>{i&&g.forEach(e=>{let a=e.metadata_id&&r.find(a=>a.id===e.metadata_id),t=!e.metadata_id&&r.find(a=>a.name===e.name);a||t||n(e.id)})},[t,r,n,i]),(0,a.jsxs)(c.PortalToFollowElem,{placement:"left",offset:4,open:u,onOpenChange:x,children:[(0,a.jsx)(c.PortalToFollowElemTrigger,{onClick:()=>x(!u),children:(0,a.jsxs)(m.default,{variant:"secondary-accent",size:"small",children:[(0,a.jsx)(d.RiFilter3Line,{className:"mr-1 h-3.5 w-3.5"}),p("nodes.knowledgeRetrieval.metadata.panel.conditions",{ns:"workflow"}),(0,a.jsx)("div",{className:"system-2xs-medium-uppercase ml-1 flex items-center rounded-[5px] border border-divider-deep px-1 text-text-tertiary",children:t?.conditions.length||0})]})}),(0,a.jsx)(c.PortalToFollowElemContent,{className:"z-10",children:(0,a.jsx)(D,{metadataFilteringConditions:t,onCancel:()=>x(!1),metadataList:r,handleRemoveCondition:n,...o})})]})},O=e=>{let{value:t=o.MetadataFilteringModeEnum.disabled,onSelect:r}=e,{t:n}=(0,l.useTranslation)(),[i,p]=(0,s.useState)(!1),u=[{key:o.MetadataFilteringModeEnum.disabled,value:n("nodes.knowledgeRetrieval.metadata.options.disabled.title",{ns:"workflow"}),desc:n("nodes.knowledgeRetrieval.metadata.options.disabled.subTitle",{ns:"workflow"})},{key:o.MetadataFilteringModeEnum.automatic,value:n("nodes.knowledgeRetrieval.metadata.options.automatic.title",{ns:"workflow"}),desc:n("nodes.knowledgeRetrieval.metadata.options.automatic.subTitle",{ns:"workflow"})},{key:o.MetadataFilteringModeEnum.manual,value:n("nodes.knowledgeRetrieval.metadata.options.manual.title",{ns:"workflow"}),desc:n("nodes.knowledgeRetrieval.metadata.options.manual.subTitle",{ns:"workflow"})}],x=u.find(e=>e.key===t);return(0,a.jsxs)(c.PortalToFollowElem,{placement:"bottom-end",offset:{mainAxis:4,crossAxis:0},open:i,onOpenChange:p,children:[(0,a.jsx)(c.PortalToFollowElemTrigger,{onClick:e=>{e.stopPropagation(),p(!i)},asChild:!0,children:(0,a.jsxs)(m.default,{variant:"secondary",size:"small",children:[x.value,(0,a.jsx)(d.RiArrowDownSLine,{className:"h-3.5 w-3.5"})]})}),(0,a.jsx)(c.PortalToFollowElemContent,{className:"z-10",children:(0,a.jsx)("div",{className:"w-[280px] rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur p-1 shadow-lg",children:u.map(e=>(0,a.jsxs)("div",{className:"flex cursor-pointer rounded-lg p-2 pr-3 hover:bg-state-base-hover",onClick:()=>{r(e.key),p(!1)},children:[(0,a.jsx)("div",{className:"w-4 shrink-0",children:e.key===t&&(0,a.jsx)(d.RiCheckLine,{className:"h-4 w-4 text-text-accent"})}),(0,a.jsxs)("div",{className:"grow",children:[(0,a.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:e.value}),(0,a.jsx)("div",{className:"system-xs-regular text-text-tertiary",children:e.desc})]})]},e.key))})})]})};e.s(["default",0,e=>{let{metadataFilterMode:d=o.MetadataFilteringModeEnum.disabled,handleMetadataFilterModeChange:m,metadataModelConfig:c,handleMetadataModelChange:p,handleMetadataCompletionParamsChange:u,...x}=e,{t:g}=(0,l.useTranslation)(),[h,v]=(0,s.useState)(!0),f=(0,s.useCallback)(e=>{e===o.MetadataFilteringModeEnum.automatic&&v(!1),m(e)},[m]);return(0,a.jsx)(i.default,{disabled:d===o.MetadataFilteringModeEnum.disabled||d===o.MetadataFilteringModeEnum.manual,collapsed:h,onCollapse:v,hideCollapseIcon:!0,trigger:e=>(0,a.jsxs)("div",{className:"flex grow items-center justify-between pr-4",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("div",{className:"system-sm-semibold-uppercase mr-0.5 text-text-secondary",children:g("nodes.knowledgeRetrieval.metadata.title",{ns:"workflow"})}),(0,a.jsx)(r.default,{popupContent:(0,a.jsx)("div",{className:"w-[200px]",children:g("nodes.knowledgeRetrieval.metadata.tip",{ns:"workflow"})})}),e]}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(O,{value:d,onSelect:f}),d===o.MetadataFilteringModeEnum.manual&&(0,a.jsx)("div",{className:"ml-1",children:(0,a.jsx)(R,{...x})})]})]}),children:(0,a.jsx)(a.Fragment,{children:d===o.MetadataFilteringModeEnum.automatic&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"body-xs-regular px-4 text-text-tertiary",children:g("nodes.knowledgeRetrieval.metadata.options.automatic.desc",{ns:"workflow"})}),(0,a.jsx)("div",{className:"mt-1 px-4",children:(0,a.jsx)(n.default,{portalToFollowElemContentClassName:"z-[50]",popupClassName:"!w-[387px]",isInWorkflow:!0,isAdvancedMode:!0,provider:c?.provider||"",completionParams:c?.completion_params||{temperature:.7},modelId:c?.name||"",setModel:p||t.noop,onCompletionParamsChange:u||t.noop,hideDebugWithMultipleModel:!0,debugWithMultipleModel:!1})})]})})})}],428594)},221927,619434,e=>{"use strict";var a=e.i(621379);e.s(["hasEditPermissionForDataset",0,(e,t)=>{let{createdBy:s,partialMemberList:l,permission:r}=t;return r===a.DatasetPermission.onlyMe?e===s:r===a.DatasetPermission.allTeamMembers||r===a.DatasetPermission.partialMembers&&l.includes(e)}],221927);var t=e.i(563199),s=e.i(837699),l=e.i(346563),r=e.i(268255);e.i(152567);var n=e.i(408767),i=e.i(151094),o=e.i(291631),d=e.i(873517),m=e.i(137667),c=e.i(130990);e.i(698628);var p=e.i(127210),u=e.i(860507),x=e.i(584344),g=e.i(616629),h=e.i(59375),v=e.i(739255),f=e.i(225162),b=e.i(117960),y=e.i(711536),j=e.i(683257),C=e.i(296124),w=e.i(211857),_=e.i(652669),N=e.i(935139),k=e.i(757198);e.i(793622);var T=e.i(259509);e.i(39598);var M=e.i(549289),E=e.i(194655),S=e.i(404853),F=e.i(777582);let V=e=>{let{rowClass:a,labelClass:s,t:l,topK:r,scoreThreshold:n,scoreThresholdEnabled:i,onExternalSettingChange:o,currentDataset:d}=e;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:a,children:(0,t.jsx)(k.default,{})}),(0,t.jsxs)("div",{className:a,children:[(0,t.jsx)("div",{className:s,children:(0,t.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:l("form.retrievalSetting.title",{ns:"datasetSettings"})})}),(0,t.jsx)(F.default,{topK:r,scoreThreshold:n,scoreThresholdEnabled:i,onChange:o,isInRetrievalSetting:!0})]}),(0,t.jsx)("div",{className:a,children:(0,t.jsx)(k.default,{})}),(0,t.jsxs)("div",{className:a,children:[(0,t.jsx)("div",{className:s,children:(0,t.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:l("form.externalKnowledgeAPI",{ns:"datasetSettings"})})}),(0,t.jsx)("div",{className:"w-full max-w-[480px]",children:(0,t.jsxs)("div",{className:"flex h-full items-center gap-1 rounded-lg bg-components-input-bg-normal px-3 py-2",children:[(0,t.jsx)(M.ApiConnectionMod,{className:"h-4 w-4 text-text-secondary"}),(0,t.jsx)("div",{className:"system-sm-medium overflow-hidden text-ellipsis text-text-secondary",children:d?.external_knowledge_info.external_knowledge_api_name}),(0,t.jsx)("div",{className:"system-xs-regular text-text-tertiary",children:"·"}),(0,t.jsx)("div",{className:"system-xs-regular text-text-tertiary",children:d?.external_knowledge_info.external_knowledge_api_endpoint})]})})]}),(0,t.jsxs)("div",{className:a,children:[(0,t.jsx)("div",{className:s,children:(0,t.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:l("form.externalKnowledgeID",{ns:"datasetSettings"})})}),(0,t.jsx)("div",{className:"w-full max-w-[480px]",children:(0,t.jsx)("div",{className:"flex h-full items-center gap-1 rounded-lg bg-components-input-bg-normal px-3 py-2",children:(0,t.jsx)("div",{className:"system-xs-regular text-text-tertiary",children:d?.external_knowledge_info.external_knowledge_id})})})]}),(0,t.jsx)("div",{className:a,children:(0,t.jsx)(k.default,{})})]})},I=e=>{let{rowClass:a,labelClass:s,t:l,indexMethod:r,retrievalConfig:n,showMultiModalTip:i,onRetrievalConfigChange:o,docLink:d}=e;return(0,t.jsxs)("div",{className:a,children:[(0,t.jsx)("div",{className:(0,N.cn)(s,"w-auto min-w-[168px]"),children:(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:l("form.retrievalSetting.title",{ns:"datasetSettings"})}),(0,t.jsxs)("div",{className:"text-xs font-normal leading-[18px] text-text-tertiary",children:[(0,t.jsx)("a",{target:"_blank",rel:"noopener noreferrer",href:d("/use-dify/knowledge/create-knowledge/setting-indexing-methods"),className:"text-text-accent",children:l("form.retrievalSetting.learnMore",{ns:"datasetSettings"})}),l("form.retrievalSetting.description",{ns:"datasetSettings"})]})]})}),(0,t.jsx)("div",{children:r===p.IndexingType.QUALIFIED?(0,t.jsx)(S.default,{value:n,onChange:o,showMultiModalTip:i}):(0,t.jsx)(E.default,{value:n,onChange:o})})]})},D=e=>{if(e.isExternal){let{rowClass:a,labelClass:s,t:l,topK:r,scoreThreshold:n,scoreThresholdEnabled:i,onExternalSettingChange:o,currentDataset:d}=e;return(0,t.jsx)(V,{rowClass:a,labelClass:s,t:l,topK:r,scoreThreshold:n,scoreThresholdEnabled:i,onExternalSettingChange:o,currentDataset:d})}let{rowClass:a,labelClass:s,t:l,indexMethod:r,retrievalConfig:n,showMultiModalTip:i,onRetrievalConfigChange:o,docLink:d}=e;return(0,t.jsx)(I,{rowClass:a,labelClass:s,t:l,indexMethod:r,retrievalConfig:n,showMultiModalTip:i,onRetrievalConfigChange:o,docLink:d})},R=e=>{let{visible:a,message:l,onDismiss:r}=e;return a?(0,t.jsxs)("div",{className:"absolute bottom-[76px] left-[30px] right-[30px] z-10 flex h-10 items-center justify-between rounded-lg border border-[#FEF0C7] bg-[#FFFAEB] px-3 shadow-lg",children:[(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)(T.AlertTriangle,{className:"mr-1 h-3 w-3 text-[#F79009]"}),(0,t.jsx)("div",{className:"text-xs font-medium leading-[18px] text-gray-700",children:l})]}),(0,t.jsx)("button",{type:"button",className:"cursor-pointer p-1",onClick:e=>{r(),e.stopPropagation()},"aria-label":"close-retrieval-change-tip",children:(0,t.jsx)(s.RiCloseLine,{className:"h-4 w-4 text-gray-500"})})]}):null},O=`
  flex justify-between py-4 flex-wrap gap-y-2
`,P=`
  flex w-[168px] shrink-0
`;e.s(["default",0,e=>{let{currentDataset:k,onCancel:T,onSave:M}=e,{data:E}=(0,f.useModelList)(v.ModelTypeEnum.textEmbedding),{data:S}=(0,f.useModelList)(v.ModelTypeEnum.rerank),{t:F}=(0,n.useTranslation)(),V=(0,j.useDocLink)(),{notify:I}=(0,m.useToastContext)(),A=(0,r.useRef)(null),L="external"===k.provider,{setShowAccountSettingModal:q}=(0,C.useModalContext)(),[z,$]=(0,r.useState)(!1),{isCurrentWorkspaceDatasetOperator:W}=(0,y.useAppContext)(),[U,G]=(0,r.useState)({...k}),[K,B]=(0,r.useState)(U?.external_retrieval_model.top_k??2),[H,Q]=(0,r.useState)(U?.external_retrieval_model.score_threshold??.5),[Y,J]=(0,r.useState)(U?.external_retrieval_model.score_threshold_enabled??!1),[X,Z]=(0,r.useState)(k.partial_member_list||[]),[ee,ea]=(0,r.useState)([]),{data:et}=(0,_.useMembers)(),[es,el]=(0,r.useState)(k.indexing_technique),[er,en]=(0,r.useState)(U?.retrieval_model_dict),[ei,eo]=(0,r.useState)(k.keyword_number??10),ed=(e,a)=>{G({...U,[e]:a})},[em,ec]=(0,r.useState)(!1),ep=!(0,l.isEqual)(er,U?.retrieval_model_dict)||es!==U?.indexing_technique,eu=async()=>{if(!z){if(!U.name?.trim())return void I({type:"error",message:F("form.nameError",{ns:"datasetSettings"})});if(!(0,c.isReRankModelSelected)({rerankModelList:S,retrievalConfig:er,indexMethod:es}))return void I({type:"error",message:F("datasetConfig.rerankModelRequired",{ns:"appDebug"})});try{$(!0);let{id:e,name:t,description:s,permission:l}=U,r={datasetId:e,body:{name:t,description:s,permission:l,indexing_technique:es,keyword_number:ei,retrieval_model:{...er,score_threshold:er.score_threshold_enabled?er.score_threshold:0},embedding_model:U.embedding_model,embedding_model_provider:U.embedding_model_provider,...L&&{external_knowledge_id:k.external_knowledge_info.external_knowledge_id,external_knowledge_api_id:k.external_knowledge_info.external_knowledge_api_id,external_retrieval_model:{top_k:K,score_threshold:H,score_threshold_enabled:Y}}}};l===a.DatasetPermission.partialMembers&&(r.body.partial_member_list=X.map(e=>({user_id:e,role:ee.find(a=>a.id===e)?.role}))),await (0,w.updateDatasetSetting)(r),I({type:"success",message:F("actionMsg.modifiedSuccessfully",{ns:"common"})}),M({...U,indexing_technique:es,retrieval_model_dict:er})}catch{I({type:"error",message:F("actionMsg.modifiedUnsuccessfully",{ns:"common"})})}finally{$(!1)}}};(0,r.useEffect)(()=>{et?.accounts?ea(et.accounts):ea([])},[et]);let ex=(0,r.useMemo)(()=>(0,g.checkShowMultiModalTip)({embeddingModel:{provider:U.embedding_model_provider,model:U.embedding_model},rerankingEnable:er.reranking_enable,rerankModel:{rerankingProviderName:er.reranking_model.reranking_provider_name,rerankingModelName:er.reranking_model.reranking_model_name},indexMethod:es,embeddingModelList:E,rerankModelList:S}),[U.embedding_model,U.embedding_model_provider,er.reranking_enable,er.reranking_model,es,E,S]);return(0,t.jsxs)("div",{className:"flex w-full flex-col overflow-hidden rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-xl",style:{height:"calc(100vh - 72px)"},ref:A,children:[(0,t.jsxs)("div",{className:"flex h-14 shrink-0 items-center justify-between border-b border-divider-regular pl-6 pr-5",children:[(0,t.jsx)("div",{className:"flex flex-col text-base font-semibold text-text-primary",children:(0,t.jsx)("div",{className:"leading-6",children:F("title",{ns:"datasetSettings"})})}),(0,t.jsx)("div",{className:"flex items-center",children:(0,t.jsx)("div",{onClick:T,className:"flex h-6 w-6 cursor-pointer items-center justify-center",children:(0,t.jsx)(s.RiCloseLine,{className:"h-4 w-4 text-text-tertiary"})})})]}),(0,t.jsxs)("div",{className:"overflow-y-auto border-b border-divider-regular p-6 pb-[68px] pt-5",children:[(0,t.jsxs)("div",{className:(0,N.cn)(O,"items-center"),children:[(0,t.jsx)("div",{className:P,children:(0,t.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:F("form.name",{ns:"datasetSettings"})})}),(0,t.jsx)(o.default,{value:U.name,onChange:e=>ed("name",e.target.value),className:"block h-9",placeholder:F("form.namePlaceholder",{ns:"datasetSettings"})||""})]}),(0,t.jsxs)("div",{className:(0,N.cn)(O),children:[(0,t.jsx)("div",{className:P,children:(0,t.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:F("form.desc",{ns:"datasetSettings"})})}),(0,t.jsx)("div",{className:"w-full",children:(0,t.jsx)(d.default,{value:U.description||"",onChange:e=>ed("description",e.target.value),className:"resize-none",placeholder:F("form.descPlaceholder",{ns:"datasetSettings"})||""})})]}),(0,t.jsxs)("div",{className:O,children:[(0,t.jsx)("div",{className:P,children:(0,t.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:F("form.permissions",{ns:"datasetSettings"})})}),(0,t.jsx)("div",{className:"w-full",children:(0,t.jsx)(x.default,{disabled:!U?.embedding_available||W,permission:U.permission,value:X,onChange:e=>ed("permission",e),onMemberSelect:Z,memberList:ee})})]}),!!(k&&k.indexing_technique)&&(0,t.jsxs)("div",{className:(0,N.cn)(O),children:[(0,t.jsx)("div",{className:P,children:(0,t.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:F("form.indexMethod",{ns:"datasetSettings"})})}),(0,t.jsx)("div",{className:"grow",children:(0,t.jsx)(u.default,{disabled:!U?.embedding_available,value:es,onChange:el,currentValue:k.indexing_technique,keywordNumber:ei,onKeywordNumberChange:eo})})]}),es===p.IndexingType.QUALIFIED&&(0,t.jsxs)("div",{className:(0,N.cn)(O),children:[(0,t.jsx)("div",{className:P,children:(0,t.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:F("form.embeddingModel",{ns:"datasetSettings"})})}),(0,t.jsxs)("div",{className:"w-full",children:[(0,t.jsx)("div",{className:"h-8 w-full rounded-lg bg-components-input-bg-normal opacity-60",children:(0,t.jsx)(b.default,{readonly:!0,defaultModel:{provider:U.embedding_model_provider,model:U.embedding_model},modelList:E})}),(0,t.jsxs)("div",{className:"mt-2 w-full text-xs leading-6 text-text-tertiary",children:[F("form.embeddingModelTip",{ns:"datasetSettings"}),(0,t.jsx)("span",{className:"cursor-pointer text-text-accent",onClick:()=>q({payload:h.ACCOUNT_SETTING_TAB.PROVIDER}),children:F("form.embeddingModelTipLink",{ns:"datasetSettings"})})]})]})]}),L?(0,t.jsx)(D,{isExternal:!0,rowClass:O,labelClass:P,t:F,topK:K,scoreThreshold:H,scoreThresholdEnabled:Y,onExternalSettingChange:e=>{void 0!==e.top_k&&B(e.top_k),void 0!==e.score_threshold&&Q(e.score_threshold),void 0!==e.score_threshold_enabled&&J(e.score_threshold_enabled),G({...U,external_retrieval_model:{...U?.external_retrieval_model,...e}})},currentDataset:k}):(0,t.jsx)(D,{isExternal:!1,rowClass:O,labelClass:P,t:F,indexMethod:es,retrievalConfig:er,showMultiModalTip:ex,onRetrievalConfigChange:en,docLink:V})]}),(0,t.jsx)(R,{visible:ep&&!em,message:F("datasetConfig.retrieveChangeTip",{ns:"appDebug"}),onDismiss:()=>ec(!0)}),(0,t.jsxs)("div",{className:"sticky bottom-0 z-[5] flex w-full justify-end border-t border-divider-regular bg-background-section px-6 py-4",children:[(0,t.jsx)(i.default,{onClick:T,className:"mr-2",children:F("operation.cancel",{ns:"common"})}),(0,t.jsx)(i.default,{variant:"primary",disabled:z,onClick:eu,children:F("operation.save",{ns:"common"})})]})]})}],619434)},621708,e=>{"use strict";var a=e.i(563199),t=e.i(268255);e.i(152567);var s=e.i(408767),l=e.i(757198),r=e.i(363282),n=e.i(402588),i=e.i(260484),o=e.i(137667),d=e.i(421001),m=e.i(739255),c=e.i(225162),p=e.i(337464),u=e.i(117960),x=e.i(88961),g=e.i(621379),h=e.i(648404),v=e.i(935139),f=e.i(536500);let b=()=>{},y=()=>{},j=(0,t.memo)(e=>{let{datasetConfigs:j,onChange:C,isInWorkflow:w,singleRetrievalModelConfig:_={},onSingleRetrievalModelChange:N=b,onSingleRetrievalModelParamsChange:k=y,selectedDatasets:T=[]}=e,{t:M}=(0,s.useTranslation)(),E=(0,t.useMemo)(()=>(0,x.getSelectedDatasetsMode)(T),[T]),S=j.retrieval_model;(0,t.useEffect)(()=>{S===h.RETRIEVE_TYPE.oneWay&&C({...j,retrieval_model:h.RETRIEVE_TYPE.multiWay},w)},[S,j,w,C]);let{modelList:F,currentModel:V,currentProvider:I}=(0,c.useModelListAndDefaultModelAndCurrentProviderAndModel)(m.ModelTypeEnum.rerank),{currentModel:D}=(0,c.useCurrentProviderAndModel)(F,{provider:j.reranking_model?.reranking_provider_name||I?.provider||"",model:j.reranking_model?.reranking_model_name||V?.model||""}),R=(0,t.useMemo)(()=>({provider_name:j.reranking_model?.reranking_provider_name??"",model_name:j.reranking_model?.reranking_model_name??""}),[j.reranking_model]),O=(e,a)=>{"top_k"===e?C({...j,top_k:a}):"score_threshold"===e&&C({...j,score_threshold:a})},P=(e,a)=>{"top_k"!==e&&C({...j,score_threshold_enabled:a})},A=[{value:g.RerankingModeEnum.WeightedScore,label:M("weightedScore.title",{ns:"dataset"}),tips:M("weightedScore.description",{ns:"dataset"})},{value:g.RerankingModeEnum.RerankingModel,label:M("modelProvider.rerankModel.key",{ns:"common"}),tips:M("modelProvider.rerankModel.tip",{ns:"common"})}],L=E.allHighQuality&&!E.inconsistentEmbeddingModel,q=L&&j.reranking_mode===g.RerankingModeEnum.WeightedScore&&j.weights,z=j.reranking_mode||g.RerankingModeEnum.RerankingModel,$=(0,t.useMemo)(()=>E.allInternal&&E.allEconomic||E.allExternal,[E.allEconomic,E.allExternal,E.allInternal]),W=(0,t.useMemo)(()=>!$||j.reranking_enable,[j.reranking_enable,$]),U=(0,t.useCallback)(e=>{!D&&e&&o.default.notify({type:"error",message:M("errorMsg.rerankModelRequired",{ns:"workflow"})}),C({...j,reranking_enable:e})},[D,j,C]);return(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"system-xl-semibold text-text-primary",children:M("retrievalSettings",{ns:"dataset"})}),(0,a.jsx)("div",{className:"system-xs-regular text-text-tertiary",children:M("defaultRetrievalTip",{ns:"dataset"})}),S===h.RETRIEVE_TYPE.multiWay&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"my-2 flex h-6 items-center py-1",children:[(0,a.jsx)("div",{className:"system-xs-semibold-uppercase mr-2 shrink-0 text-text-secondary",children:M("rerankSettings",{ns:"dataset"})}),(0,a.jsx)(l.default,{bgStyle:"gradient",className:"mx-0 !h-px"})]}),E.inconsistentEmbeddingModel&&(0,a.jsx)("div",{className:"system-xs-medium mt-4 text-text-warning",children:M("inconsistentEmbeddingModelTip",{ns:"dataset"})}),E.mixtureInternalAndExternal&&(0,a.jsx)("div",{className:"system-xs-medium mt-4 text-text-warning",children:M("mixtureInternalAndExternalTip",{ns:"dataset"})}),E.allExternal&&(0,a.jsx)("div",{className:"system-xs-medium mt-4 text-text-warning",children:M("allExternalTip",{ns:"dataset"})}),E.mixtureHighQualityAndEconomic&&(0,a.jsx)("div",{className:"system-xs-medium mt-4 text-text-warning",children:M("mixtureHighQualityAndEconomicTip",{ns:"dataset"})}),L&&(0,a.jsx)("div",{className:"flex items-center justify-between",children:A.map(e=>(0,a.jsxs)("div",{className:(0,v.cn)("system-sm-medium flex h-8 w-[calc((100%-8px)/2)] cursor-pointer items-center justify-center rounded-lg border border-components-option-card-option-border bg-components-option-card-option-bg text-text-secondary",z===e.value&&"border-[1.5px] border-components-option-card-option-selected-border bg-components-option-card-option-selected-bg text-text-primary"),onClick:()=>{var a;(a=e.value)!==j.reranking_mode&&(a!==g.RerankingModeEnum.RerankingModel||D||o.default.notify({type:"error",message:M("errorMsg.rerankModelRequired",{ns:"workflow"})}),C({...j,reranking_mode:a}))},children:[(0,a.jsx)("div",{className:"truncate",children:e.label}),(0,a.jsx)(d.default,{popupContent:(0,a.jsx)("div",{className:"w-[200px]",children:e.tips}),popupClassName:"ml-0.5",triggerClassName:"ml-0.5 w-3.5 h-3.5"})]},e.value))}),!q&&(0,a.jsxs)("div",{className:"mt-2",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[$&&(0,a.jsx)(i.default,{size:"md",defaultValue:W,onChange:U}),(0,a.jsx)("div",{className:"system-sm-semibold ml-1 leading-[32px] text-text-secondary",children:M("modelProvider.rerankModel.key",{ns:"common"})}),(0,a.jsx)(d.default,{popupContent:(0,a.jsx)("div",{className:"w-[200px]",children:M("modelProvider.rerankModel.tip",{ns:"common"})}),popupClassName:"ml-1",triggerClassName:"ml-1 w-4 h-4"})]}),W&&(0,a.jsx)("div",{children:(0,a.jsx)(u.default,{defaultModel:R&&{provider:R?.provider_name,model:R?.model_name},onSelect:e=>{C({...j,reranking_model:{reranking_provider_name:e.provider,reranking_model_name:e.model}})},modelList:F})})]}),q&&(0,a.jsxs)("div",{className:"mt-2 space-y-4",children:[(0,a.jsx)(f.default,{value:{value:[j.weights.vector_setting.vector_weight,j.weights.keyword_setting.keyword_weight]},onChange:e=>{C({...j,weights:{...j.weights,vector_setting:{...j.weights.vector_setting,vector_weight:e.value[0]},keyword_setting:{keyword_weight:e.value[1]}}})}}),(0,a.jsx)(n.default,{value:j.top_k,onChange:O,enable:!0}),(0,a.jsx)(r.default,{value:j.score_threshold,onChange:O,enable:j.score_threshold_enabled,hasSwitch:!0,onSwitchChange:P})]}),!q&&(0,a.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,a.jsx)(n.default,{value:j.top_k,onChange:O,enable:!0}),W&&(0,a.jsx)(r.default,{value:j.score_threshold,onChange:O,enable:j.score_threshold_enabled,hasSwitch:!0,onSwitchChange:P})]})]}),w&&S===h.RETRIEVE_TYPE.oneWay&&(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-0.5",children:[(0,a.jsx)("div",{className:"text-[13px] font-medium leading-[32px] text-text-primary",children:M("modelProvider.systemReasoningModel.key",{ns:"common"})}),(0,a.jsx)(d.default,{popupContent:M("modelProvider.systemReasoningModel.tip",{ns:"common"})})]}),(0,a.jsx)(p.default,{isInWorkflow:w,popupClassName:"!w-[387px]",portalToFollowElemContentClassName:"!z-[1002]",isAdvancedMode:!0,provider:_?.provider,completionParams:_?.completion_params,modelId:_?.name,setModel:N,onCompletionParamsChange:k,hideDebugWithMultipleModel:!0,debugWithMultipleModel:!1})]})]})});e.s(["default",0,j],621708)}]);