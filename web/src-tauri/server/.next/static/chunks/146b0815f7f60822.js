(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,464143,e=>{"use strict";function t(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)e[o]=r[o]}return e}var r=function e(r,o){function n(e,n,s){if("u">typeof document){"number"==typeof(s=t({},o,s)).expires&&(s.expires=new Date(Date.now()+864e5*s.expires)),s.expires&&(s.expires=s.expires.toUTCString()),e=encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var i="";for(var a in s)s[a]&&(i+="; "+a,!0!==s[a]&&(i+="="+s[a].split(";")[0]));return document.cookie=e+"="+r.write(n,e)+i}}return Object.create({set:n,get:function(e){if("u">typeof document&&(!arguments.length||e)){for(var t=document.cookie?document.cookie.split("; "):[],o={},n=0;n<t.length;n++){var s=t[n].split("="),i=s.slice(1).join("=");try{var a=decodeURIComponent(s[0]);if(o[a]=r.read(i,a),e===a)break}catch(e){}}return e?o[e]:o}},remove:function(e,r){n(e,"",t({},r,{expires:-1}))},withAttributes:function(r){return e(this.converter,t({},this.attributes,r))},withConverter:function(r){return e(t({},this.converter,r),this.attributes)}},{attributes:{value:Object.freeze(o)},converter:{value:Object.freeze(r)}})}({read:function(e){return'"'===e[0]&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"});e.s(["default",()=>r])},842090,879445,e=>{"use strict";let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function r(e){return e.replace(/[&<>"']/g,e=>t[e])}async function o(e){try{return[null,await e]}catch(e){return[e||Error("unknown error")]}}async function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,[r,s]=await o(e);return r?t>0?await n(e,t-1):r instanceof Error?[r]:[Error("unknown error")]:[null,s]}e.s(["escape",()=>r],879445),e.s(["asyncRunSafe",()=>o,"canFindTool",0,(e,t)=>e===t||e===`langgenius/${t}/${t}`||e===`langgenius/${t}_tool/${t}`,"correctModelProvider",0,e=>e?e.includes("/")?e:["google"].includes(e)?"langgenius/gemini/google":`langgenius/${e}/${e}`:"","correctToolProvider",0,(e,t)=>e?t||e.includes("/")?e:["stepfun","jina","siliconflow","gitee_ai"].includes(e)?`langgenius/${e}_tool/${e}`:`langgenius/${e}/${e}`:"","fetchWithRetry",()=>n,"getPurifyHref",0,e=>e?r(e):"","getTextWidthWithCanvas",0,(e,t)=>{let r=document.createElement("canvas").getContext("2d");return r?(r.font=t??'12px Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"',Number(r.measureText(e).width.toFixed(2))):0},"sleep",0,e=>new Promise(t=>setTimeout(t,e))],842090)},367916,680173,351124,e=>{"use strict";e.s(["del",()=>ed,"delPublic",()=>ef,"get",()=>es,"getMarketplace",()=>ea,"getPublic",()=>ei,"handleStream",()=>ee,"patch",()=>ep,"patchPublic",()=>eg,"post",()=>el,"postMarketplace",()=>eu,"postPublic",()=>eh,"put",()=>ec,"request",()=>en,"ssePost",()=>eo,"upload",()=>er],367916);var t=e.i(464143),r=e.i(137667),o=e.i(925521),n=e.i(842090),s=e.i(168014);e.s(["ContentType",()=>k,"base",()=>W,"getBaseOptions",()=>z],351124);class i extends Error{response;request;options;constructor(e,t,r){const o=e.status||0===e.status?e.status:"",n=e.statusText??"",s=`${o} ${n}`.trim();super(`Request failed with ${s?`status code ${s}`:"an unknown error"}: ${t.method} ${t.url}`),this.name="HTTPError",this.response=e,this.request=t,this.options=r}}let a=(()=>{let e=!1,t=!1,r="function"==typeof globalThis.Request;if("function"==typeof globalThis.ReadableStream&&r)try{t=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type")}catch(e){if(e instanceof Error&&"unsupported BodyInit type"===e.message)return!1;throw e}return e&&!t})(),l="function"==typeof globalThis.AbortController,u="function"==typeof globalThis.AbortSignal&&"function"==typeof globalThis.AbortSignal.any,h="function"==typeof globalThis.ReadableStream,c="function"==typeof globalThis.FormData,d=["get","post","put","patch","head","delete"],f={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*",bytes:"*/*"},p=new TextEncoder().encode("------WebKitFormBoundaryaxpyiPgbbPti10Rw").length,g=Symbol("stop"),m={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,onUploadProgress:!0,fetch:!0},_={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,duplex:!0},y=(e,t,r)=>{let o,n=0;return e.pipeThrough(new TransformStream({transform(e,s){if(s.enqueue(e),o){n+=o.byteLength;let e=0===t?0:n/t;e>=1&&(e=1-Number.EPSILON),r?.({percent:e,totalBytes:Math.max(t,n),transferredBytes:n},o)}o=e},flush(){o&&(n+=o.byteLength,r?.({percent:1,totalBytes:Math.max(t,n),transferredBytes:n},o))}}))},b=e=>null!==e&&"object"==typeof e,T=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];for(let e of t)if((!b(e)||Array.isArray(e))&&void 0!==e)throw TypeError("The `options` argument must be an object");return P({},...t)},w=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=new globalThis.Headers(e),o=t instanceof globalThis.Headers;for(let[e,n]of new globalThis.Headers(t).entries())o&&"undefined"===n||void 0===n?r.delete(e):r.set(e,n);return r};function E(e,t,r){return Object.hasOwn(t,r)&&void 0===t[r]?[]:P(e[r]??[],t[r]??[])}let v=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return{beforeRequest:E(e,t,"beforeRequest"),beforeRetry:E(e,t,"beforeRetry"),afterResponse:E(e,t,"afterResponse"),beforeError:E(e,t,"beforeError")}},R=(e,t)=>{let r=new URLSearchParams;for(let o of[e,t])if(void 0!==o)if(o instanceof URLSearchParams)for(let[e,t]of o.entries())r.append(e,t);else if(Array.isArray(o))for(let e of o){if(!Array.isArray(e)||2!==e.length)throw TypeError("Array search parameters must be provided in [[key, value], ...] format");r.append(String(e[0]),String(e[1]))}else if(b(o))for(let[e,t]of Object.entries(o))void 0!==t&&r.append(e,String(t));else for(let[e,t]of new URLSearchParams(o).entries())r.append(e,t);return r},P=function(){let e;for(var t=arguments.length,r=Array(t),o=0;o<t;o++)r[o]=arguments[o];let n={},s={},i={},a=[];for(let t of r)if(Array.isArray(t))Array.isArray(n)||(n=[]),n=[...n,...t];else if(b(t)){for(let[r,o]of Object.entries(t)){if("signal"===r&&o instanceof globalThis.AbortSignal){a.push(o);continue}if("searchParams"===r){e=null==o?void 0:void 0===e?o:R(e,o);continue}b(o)&&r in n&&(o=P(n[r],o)),n={...n,[r]:o}}b(t.hooks)&&(i=v(i,t.hooks),n.hooks=i),b(t.headers)&&(s=w(s,t.headers),n.headers=s)}return void 0!==e&&(n.searchParams=e),a.length>0&&(1===a.length?n.signal=a[0]:u?n.signal=AbortSignal.any(a):n.signal=a.at(-1)),n},A={limit:2,methods:["get","put","head","delete","options","trace"],statusCodes:[408,413,429,500,502,503,504],afterStatusCodes:[413,429,503],maxRetryAfter:1/0,backoffLimit:1/0,delay:e=>.3*2**(e-1)*1e3},S=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("number"==typeof e)return{...A,limit:e};if(e.methods&&!Array.isArray(e.methods))throw Error("retry.methods must be an array");if(e.statusCodes&&!Array.isArray(e.statusCodes))throw Error("retry.statusCodes must be an array");return{...A,...e}};class C extends Error{request;constructor(e){super(`Request timed out: ${e.method} ${e.url}`),this.name="TimeoutError",this.request=e}}async function I(e,t,r,o){return new Promise((n,s)=>{let i=setTimeout(()=>{r&&r.abort(),s(new C(e))},o.timeout);o.fetch(e,t).then(n).catch(s).then(()=>{clearTimeout(i)})})}async function O(e,t){let{signal:r}=t;return new Promise((t,o)=>{function n(){clearTimeout(s),o(r.reason)}r&&(r.throwIfAborted(),r.addEventListener("abort",n,{once:!0}));let s=setTimeout(()=>{r?.removeEventListener("abort",n),t()},e)})}class j{static create(e,t){let r=new j(e,t),o=async()=>{if("number"==typeof r._options.timeout&&r._options.timeout>0x7fffffff)throw RangeError("The `timeout` option cannot be greater than 2147483647");await Promise.resolve();let e=await r._fetch();for(let t of r._options.hooks.afterResponse){let o=await t(r.request,r.#e(),r._decorateResponse(e.clone()),{retryCount:r._retryCount});o instanceof globalThis.Response&&(e=o)}if(r._decorateResponse(e),!e.ok&&r._options.throwHttpErrors){let t=new i(e,r.request,r.#e());for(let e of r._options.hooks.beforeError)t=await e(t,{retryCount:r._retryCount});throw t}if(r._options.onDownloadProgress){if("function"!=typeof r._options.onDownloadProgress)throw TypeError("The `onDownloadProgress` option must be a function");if(!h)throw Error("Streams are not supported in your environment. `ReadableStream` is missing.");return((e,t)=>{if(!e.body)return e;if(204===e.status)return new Response(null,{status:e.status,statusText:e.statusText,headers:e.headers});let r=Number(e.headers.get("content-length"))||0;return new Response(y(e.body,r,t),{status:e.status,statusText:e.statusText,headers:e.headers})})(e.clone(),r._options.onDownloadProgress)}return e},n=(r._options.retry.methods.includes(r.request.method.toLowerCase())?r._retry(o):o()).finally(async()=>{let e=r._originalRequest,t=[];e&&!e.bodyUsed&&t.push(e.body?.cancel()),r.request.bodyUsed||t.push(r.request.body?.cancel()),await Promise.all(t)});for(let[e,o]of Object.entries(f))("bytes"!==e||"function"==typeof globalThis.Response?.prototype?.bytes)&&(n[e]=async()=>{r.request.headers.set("accept",r.request.headers.get("accept")||o);let s=await n;if("json"===e){if(204===s.status)return"";let e=await s.text();return""===e?"":t.parseJson?t.parseJson(e):JSON.parse(e)}return s[e]()});return n}static #t(e){return!e||"object"!=typeof e||Array.isArray(e)||e instanceof URLSearchParams?e:Object.fromEntries(Object.entries(e).filter(e=>{let[,t]=e;return void 0!==t}))}request;abortController;_retryCount=0;_input;_options;_originalRequest;#r;constructor(e,t={}){if(this._input=e,this._options={...t,headers:w(this._input.headers,t.headers),hooks:v({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},t.hooks),method:(e=>d.includes(e)?e.toUpperCase():e)(t.method??this._input.method??"GET"),prefixUrl:String(t.prefixUrl||""),retry:S(t.retry),throwHttpErrors:!1!==t.throwHttpErrors,timeout:t.timeout??1e4,fetch:t.fetch??globalThis.fetch.bind(globalThis)},"string"!=typeof this._input&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&"string"==typeof this._input){if(this._input.startsWith("/"))throw Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(l&&u){const e=this._options.signal??this._input.signal;this.abortController=new globalThis.AbortController,this._options.signal=e?AbortSignal.any([e,this.abortController.signal]):this.abortController.signal}a&&(this._options.duplex="half"),void 0!==this._options.json&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json"));const r=t.headers&&new globalThis.Headers(t.headers).has("content-type");if(this._input instanceof globalThis.Request&&(c&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!r&&this._options.headers.delete("content-type"),this.request=new globalThis.Request(this._input,this._options),(e=>void 0!==e&&(Array.isArray(e)?e.length>0:e instanceof URLSearchParams?e.size>0:"object"==typeof e?Object.keys(e).length>0:"string"==typeof e?e.trim().length>0:!!e))(this._options.searchParams)){const e="string"==typeof this._options.searchParams?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(j.#t(this._options.searchParams)).toString(),t=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,"?"+e);this.request=new globalThis.Request(new globalThis.Request(t,{...this.request}),this._options)}if(this._options.onUploadProgress){if("function"!=typeof this._options.onUploadProgress)throw TypeError("The `onUploadProgress` option must be a function");if(!a)throw Error("Request streams are not supported in your environment. The `duplex` option for `Request` is not available.");this.request.body&&(this.request=((e,t,r)=>{if(!e.body)return e;let o=(e=>{if(!e)return 0;if(e instanceof FormData){let t=0;for(let[r,o]of e)t+=p,t+=new TextEncoder().encode(`Content-Disposition: form-data; name="${r}"`).length,t+="string"==typeof o?new TextEncoder().encode(o).length:o.size;return t}if(e instanceof Blob)return e.size;if(e instanceof ArrayBuffer)return e.byteLength;if("string"==typeof e)return new TextEncoder().encode(e).length;if(e instanceof URLSearchParams)return new TextEncoder().encode(e.toString()).length;if("byteLength"in e)return e.byteLength;if("object"==typeof e&&null!==e)try{let t=JSON.stringify(e);return new TextEncoder().encode(t).length}catch{}return 0})(r??e.body);return new Request(e,{duplex:"half",body:y(e.body,o,t)})})(this.request,this._options.onUploadProgress,this._options.body))}}_calculateRetryDelay(e){var t;if(this._retryCount++,this._retryCount>this._options.retry.limit||(t=e)instanceof C||t?.name===C.name)throw e;if(e instanceof i||e?.name===i.name){if(!this._options.retry.statusCodes.includes(e.response.status))throw e;let t=e.response.headers.get("Retry-After")??e.response.headers.get("RateLimit-Reset")??e.response.headers.get("X-RateLimit-Reset")??e.response.headers.get("X-Rate-Limit-Reset");if(t&&this._options.retry.afterStatusCodes.includes(e.response.status)){let e=1e3*Number(t);Number.isNaN(e)?e=Date.parse(t)-Date.now():e>=Date.parse("2024-01-01")&&(e-=Date.now());let r=this._options.retry.maxRetryAfter??e;return e<r?e:r}if(413===e.response.status)throw e}let r=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,r)}_decorateResponse(e){return this._options.parseJson&&(e.json=async()=>this._options.parseJson(await e.text())),e}async _retry(e){try{return await e()}catch(r){let t=Math.min(this._calculateRetryDelay(r),0x7fffffff);if(this._retryCount<1)throw r;for(let e of(await O(t,{signal:this._options.signal}),this._options.hooks.beforeRetry))if(await e({request:this.request,options:this.#e(),error:r,retryCount:this._retryCount})===g)return;return this._retry(e)}}async _fetch(){for(let e of this._options.hooks.beforeRequest){let t=await e(this.request,this.#e(),{retryCount:this._retryCount});if(t instanceof Request){this.request=t;break}if(t instanceof Response)return t}let e=((e,t)=>{let r={};for(let o in t)o in _||o in m||o in e||(r[o]=t[o]);return r})(this.request,this._options);return(this._originalRequest=this.request,this.request=this._originalRequest.clone(),!1===this._options.timeout)?this._options.fetch(this._originalRequest,e):I(this._originalRequest,e,this.abortController,this._options)}#e(){if(!this.#r){let{hooks:e,...t}=this._options;this.#r=Object.freeze(t)}return this.#r}}let q=e=>{let t=(t,r)=>j.create(t,T(e,r));for(let r of d)t[r]=(t,o)=>j.create(t,T(e,o,{method:r}));return t.create=e=>q(T(e)),t.extend=t=>("function"==typeof t&&(t=t(e??{})),q(T(e,t))),t.stop=g,t},x=q();function N(e){localStorage.setItem(o.ACCESS_TOKEN_LOCAL_STORAGE_NAME,e)}function U(){return localStorage.getItem(o.ACCESS_TOKEN_LOCAL_STORAGE_NAME)||""}function L(e){return localStorage.getItem((0,o.PASSPORT_LOCAL_STORAGE_NAME)(e))||""}async function $(e){localStorage.removeItem(o.ACCESS_TOKEN_LOCAL_STORAGE_NAME),localStorage.removeItem((0,o.PASSPORT_LOCAL_STORAGE_NAME)(e)),await eh("/logout")}e.s(["getWebAppAccessToken",()=>U,"getWebAppPassport",()=>L,"setWebAppAccessToken",()=>N,"webAppLogout",()=>$],680173);let k={json:"application/json",stream:"text/event-stream",audio:"audio/mpeg",form:"application/x-www-form-urlencoded; charset=UTF-8",download:"application/octet-stream",downloadZip:"application/zip",upload:"multipart/form-data"},D=async(e,t,r)=>{if(204===r.status)return new Response(JSON.stringify({result:"success"}),{status:200,headers:{"Content-Type":k.json}})},M=new Set(["webapp-signin","check-code","login"]),H=e=>{let t=U();t?e.headers.set("Authorization",`Bearer ${t}`):e.headers.delete("Authorization");let r=(()=>{let e=globalThis.location.pathname.split("/").filter(Boolean).at(-1)||"";if(e&&!M.has(e))return e;let t=new URLSearchParams(globalThis.location.search).get("redirect_url");if(!t)return"";try{let e=new URL(decodeURIComponent(t),globalThis.location.origin).pathname.split("/").filter(Boolean).at(-1)||"";return M.has(e)?"":e}catch{return""}})();r&&(e.headers.set(o.WEB_APP_SHARE_CODE_HEADER_NAME,r),e.headers.set(o.PASSPORT_HEADER_NAME,L(r)))},F={afterResponse:[D]},B=x.create({hooks:F,timeout:1e5}),z=()=>({method:"GET",mode:"cors",credentials:"include",headers:new Headers({"Content-Type":k.json}),redirect:"follow"});async function W(e){let n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{params:a,body:l,headers:u,...h}=Object.assign({},i.fetchCompat?{mode:"cors",credentials:"include",redirect:"follow"}:{mode:"cors",credentials:"include",headers:new Headers({"Content-Type":k.json}),method:"GET",redirect:"follow"},s),c=new Headers(u||{}),{isPublicAPI:d=!1,isMarketplaceAPI:f=!1,bodyStringify:p=!0,needAllResponseContent:g,deleteContentType:m,getAbortController:_,fetchCompat:y=!1,request:b}=i;if(n=f?o.MARKETPLACE_API_PREFIX:d?o.PUBLIC_API_PREFIX:o.API_PREFIX,_){let e=new AbortController;_(e),s.signal=e.signal}let T=n+(e.startsWith("/")?e:`/${e}`);f||c.set(o.CSRF_HEADER_NAME,t.default.get((0,o.CSRF_COOKIE_NAME)())||""),m&&c.delete("Content-Type"),f&&c.set("X-Dify-Version",o.IS_MARKETPLACE?"999.0.0":o.APP_VERSION);let w=B.extend({hooks:{...F,beforeError:[...F.beforeError||[],e=>(i.silent||r.default.notify({type:"error",message:e.message}),e)],beforeRequest:[...F.beforeRequest||[],d&&H].filter(e=>!!e),afterResponse:[...F.afterResponse||[],async(e,t,o)=>{let n=o.clone();if(!/^([23])\d{2}$/.test(String(n.status))){let e=n.json();switch(n.status){case 403:e.then(e=>{i.silent||r.default.notify({type:"error",message:e.message}),"already_setup"===e.code&&(globalThis.location.href=`${globalThis.location.origin}/signin`)});break;case 401:return Promise.reject(o);default:return e.then(e=>{i.silent||r.default.notify({type:"error",message:e.message})}),Promise.reject(o)}}}]}}),E=await w(b||T,{...h,headers:c,credentials:f?"omit":s.credentials||"include",retry:{methods:[]},...p&&!y?{json:l}:{body:l},searchParams:y?void 0:a,fetch(e,t){if(e instanceof Request&&t){let r=new Headers(t.headers||{});e.headers.forEach((e,t)=>{r.append(t,e)}),t.headers=r}return globalThis.fetch(e,t)}});if(g||y)return E;let v=E.headers.get("content-type");return v&&[k.download,k.audio,k.downloadZip].includes(v)?await E.blob():await E.json()}let J="is_other_tab_refreshing",K=!1;async function X(e){try{var t;let r=globalThis.localStorage.getItem(J);if(r&&"1"===r&&(t=e,new Date().getTime()-Number.parseInt(globalThis.localStorage.getItem("last_refresh_time")||"0")<=t)||K)await new Promise(e=>{!function t(){let r=globalThis.localStorage.getItem(J);r&&"1"===r||K?setTimeout(()=>{t()},1e3):e()}()});else{K=!0,globalThis.localStorage.setItem(J,"1"),globalThis.localStorage.setItem("last_refresh_time",new Date().getTime().toString()),globalThis.addEventListener("beforeunload",G);let[e,t]=await (0,n.fetchWithRetry)(globalThis.fetch(`${o.API_PREFIX}/refresh-token`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json;utf-8"}}));if(e)return Promise.reject(e);if(401===t.status)return Promise.reject(t)}}catch(e){return console.error(e),Promise.reject(e)}finally{G()}}function G(){K=!1,globalThis.localStorage.removeItem(J),globalThis.localStorage.removeItem("last_refresh_time"),globalThis.removeEventListener("beforeunload",G)}async function V(e){return Promise.race([new Promise((t,r)=>setTimeout(()=>{G(),r(Error("request timeout"))},e)),X(e)])}function Z(e){e&&new URL(e,globalThis.location.origin).pathname!==globalThis.location.pathname&&(globalThis.location.href=e)}let Q="/webapp-signin";function Y(e,t){let r=new URLSearchParams;globalThis.location.pathname!==Q&&(r.append("redirect_url",encodeURIComponent(`${globalThis.location.pathname}${globalThis.location.search}`)),e&&r.append("message",e),t&&r.append("code",String(t)),globalThis.location.href=`${globalThis.location.origin}${s.basePath}${Q}?${r.toString()}`)}let ee=(e,t,r,o,n,s,i,a,l,u,h,c,d,f,p,g,m,_,y,b,T,w,E,v,R,P,A,S)=>{let C;if(!e.ok)throw Error("Network response was not ok");let I=e.body?.getReader(),O=new TextDecoder("utf-8"),j="",q=!0;!function e(){let x=!1;I?.read().then(I=>{if(I.done)return void r?.();let N=(j+=O.decode(I.value,{stream:!0})).split("\n");try{N.forEach(e=>{if(e.startsWith("data: ")){try{C=JSON.parse(e.substring(6))}catch{t("",q,{conversationId:C?.conversation_id,messageId:C?.message_id});return}if(!C||"object"!=typeof C){t("",q,{conversationId:void 0,messageId:"",errorMessage:"Invalid response data",errorCode:"invalid_data"}),x=!0,r?.(!0,"Invalid response data");return}if(400===C.status||!C.event){t("",!1,{conversationId:void 0,messageId:"",errorMessage:C?.message,errorCode:C?.code}),x=!0,r?.(!0,C?.message);return}if("message"===C.event||"agent_message"===C.event){var I;t((I=C.answer)?I.replace(/\\u([0-9a-f]{4})/g,(e,t)=>String.fromCharCode(Number.parseInt(t,16))):"",q,{conversationId:C.conversation_id,taskId:C.task_id,messageId:C.id}),q=!1}else"agent_thought"===C.event?o?.(C):"message_file"===C.event?i?.(C):"message_end"===C.event?n?.(C):"message_replace"===C.event?s?.(C):"workflow_started"===C.event?a?.(C):"workflow_finished"===C.event?l?.(C):"node_started"===C.event?u?.(C):"node_finished"===C.event?h?.(C):"iteration_started"===C.event?c?.(C):"iteration_next"===C.event?d?.(C):"iteration_completed"===C.event?f?.(C):"loop_started"===C.event?p?.(C):"loop_next"===C.event?g?.(C):"loop_completed"===C.event?m?.(C):"node_retry"===C.event?_?.(C):"parallel_branch_started"===C.event?y?.(C):"parallel_branch_finished"===C.event?b?.(C):"text_chunk"===C.event?T?.(C):"text_replace"===C.event?v?.(C):"agent_log"===C.event?R?.(C):"tts_message"===C.event?w?.(C.message_id,C.audio,C.audio_type):"tts_message_end"===C.event?E?.(C.message_id,C.audio):"datasource_processing"===C.event?P?.(C):"datasource_completed"===C.event?A?.(C):"datasource_error"===C.event?S?.(C):console.warn(`Unknown event: ${C.event}`,C)}}),j=N[N.length-1]}catch(e){t("",!1,{conversationId:void 0,messageId:"",errorMessage:`${e}`}),x=!0,r?.(!0,e);return}x||e()})}()},et=W,er=async(e,r,n,s)=>{let i=r?o.PUBLIC_API_PREFIX:o.API_PREFIX,a=globalThis.location.pathname.split("/").slice(-1)[0],l={method:"POST",url:(n?`${i}${n}`:`${i}/files/upload`)+(s||""),headers:{[o.CSRF_HEADER_NAME]:t.default.get((0,o.CSRF_COOKIE_NAME)())||"",[o.PASSPORT_HEADER_NAME]:L(a),[o.WEB_APP_SHARE_CODE_HEADER_NAME]:a}},u={...l,...e,url:e.url||l.url,headers:{...l.headers,...e.headers}};return new Promise((e,t)=>{let r=u.xhr;for(let e in r.open(u.method,u.url),u.headers)r.setRequestHeader(e,u.headers[e]);r.withCredentials=!0,r.responseType="json",r.onreadystatechange=function(){4===r.readyState&&(201===r.status?e(r.response):t(r))},u.onprogress&&(r.upload.onprogress=u.onprogress),r.send(u.data)})},eo=async(e,n,s)=>{let{isPublicAPI:i=!1,onData:a,onCompleted:l,onThought:u,onFile:h,onMessageEnd:c,onMessageReplace:d,onWorkflowStarted:f,onWorkflowFinished:p,onNodeStarted:g,onNodeFinished:m,onIterationStart:_,onIterationNext:y,onIterationFinish:b,onNodeRetry:T,onParallelBranchStarted:w,onParallelBranchFinished:E,onTextChunk:v,onTTSChunk:R,onTTSEnd:P,onTextReplace:A,onAgentLog:S,onError:C,getAbortController:I,onLoopStart:O,onLoopNext:j,onLoopFinish:q,onDataSourceNodeProcessing:x,onDataSourceNodeCompleted:N,onDataSourceNodeError:U}=s,$=new AbortController,D=z(),M=globalThis.location.pathname.split("/").slice(-1)[0],H=Object.assign({},D,{method:"POST",signal:$.signal,headers:new Headers({[o.CSRF_HEADER_NAME]:t.default.get((0,o.CSRF_COOKIE_NAME)())||"",[o.WEB_APP_SHARE_CODE_HEADER_NAME]:M,[o.PASSPORT_HEADER_NAME]:L(M)})},n);H.headers.get("Content-Type")||H.headers.set("Content-Type",k.json),I?.($);let F=i?o.PUBLIC_API_PREFIX:o.API_PREFIX,B=e.startsWith("http://")||e.startsWith("https://")?e:`${F}${e.startsWith("/")?e:`/${e}`}`,{body:W}=H;W&&(H.body=JSON.stringify(W)),globalThis.fetch(B,H).then(t=>/^[23]\d{2}$/.test(String(t.status))?ee(t,(e,t,o)=>{if(o.errorMessage){C?.(o.errorMessage,o.errorCode),"AbortError: The user aborted a request."===o.errorMessage||o.errorMessage.includes("TypeError: Cannot assign to read only property")||r.default.notify({type:"error",message:o.errorMessage});return}a?.(e,t,o)},l,u,c,d,h,f,p,g,m,_,y,b,O,j,q,T,w,E,v,R,P,A,S,x,N,U):void(401===t.status?i?t.json().then(e=>{i&&("web_app_access_denied"===e.code&&Y(e.message,403),"web_sso_auth_required"===e.code&&Y(),"unauthorized"===e.code&&Y())}):V(1e5).then(()=>{eo(e,n,s)}).catch(e=>{console.error(e)}):(t.json().then(e=>{r.default.notify({type:"error",message:e.message||"Server Error"})}),C?.("Server Error")))).catch(e=>{"AbortError: The user aborted a request."===e.toString()||e.toString().includes("TypeError: Cannot assign to read only property")||r.default.notify({type:"error",message:e}),C?.(e)})},en=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;try{let a=i||{},[l,u]=await (0,n.asyncRunSafe)(et(e,t,a));if(null===l)return u;if(401!==l.status)return Promise.reject(l);{let[i,u]=await (0,n.asyncRunSafe)(l.json()),h=`${globalThis.location.origin}${s.basePath}/signin`;if(i)return globalThis.location.href=h,Promise.reject(l);if(/\/login/.test(e))return Promise.reject(u);let{code:c,message:d}=u;if("web_app_access_denied"===c)return Y(d,403),Promise.reject(l);if("web_sso_auth_required"===c)return Y(),Promise.reject(l);if("unauthorized_and_force_logout"===c)return globalThis.location.reload(),Promise.reject(l);let{isPublicAPI:f=!1,silent:p}=a;if(f&&"unauthorized"===c)return Y(),Promise.reject(l);if("init_validate_failed"===c&&o.IS_CE_EDITION&&!p)return r.default.notify({type:"error",message:d,duration:4e3}),Promise.reject(l);if("not_init_validated"===c&&o.IS_CE_EDITION)return Z(`${globalThis.location.origin}${s.basePath}/init`),Promise.reject(l);if("not_setup"===c&&o.IS_CE_EDITION)return Z(`${globalThis.location.origin}${s.basePath}/install`),Promise.reject(l);let[g]=await (0,n.asyncRunSafe)(V(1e5));if(null===g)return et(e,t,a);if(location.pathname!==`${s.basePath}/signin`||!o.IS_CE_EDITION)return Z(h),Promise.reject(l);if(!p)return r.default.notify({type:"error",message:d}),Promise.reject(l);return Z(h),Promise.reject(l)}}catch(e){return console.error(e),Promise.reject(e)}},es=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return en(e,Object.assign({},t,{method:"GET"}),r)},ei=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return es(e,t,{...r,isPublicAPI:!0})},ea=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return es(e,t,{...r,isMarketplaceAPI:!0})},el=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return en(e,Object.assign({},t,{method:"POST"}),r)},eu=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return el(e,t,{...r,isMarketplaceAPI:!0})},eh=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return el(e,t,{...r,isPublicAPI:!0})},ec=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return en(e,Object.assign({},t,{method:"PUT"}),r)},ed=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return en(e,Object.assign({},t,{method:"DELETE"}),r)},ef=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return ed(e,t,{...r,isPublicAPI:!0})},ep=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return en(e,Object.assign({},t,{method:"PATCH"}),r)},eg=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return ep(e,t,{...r,isPublicAPI:!0})}}]);