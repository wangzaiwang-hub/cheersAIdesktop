(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,881110,e=>{"use strict";var t=e.i(149086),a=e.i(354440),s=(0,t.createUseStorageState)(function(){return a.default?localStorage:void 0});e.s(["useLocalStorageState",0,s],881110)},910605,e=>{"use strict";var t=e.i(27808);e.s(["FileUploaderInAttachmentWrapper",()=>t.default])},371784,e=>{"use strict";var t=e.i(563199),a=e.i(268255);e.i(152567);var s=e.i(408767),r=e.i(324935);let n=a.memo(e=>{let{value:n,onChange:i,name:l,required:o,readonly:d}=e,{t:u}=(0,s.useTranslation)(),c=(0,a.useCallback)(()=>{i(!n)},[n,i]);return(0,t.jsxs)("div",{className:"flex h-6 items-center gap-2",children:[(0,t.jsx)(r.default,{className:"!h-4 !w-4",checked:!!n,onCheck:c,disabled:d}),(0,t.jsxs)("div",{className:"system-sm-medium flex items-center gap-1 text-text-secondary",children:[l,!o&&(0,t.jsx)("span",{className:"system-xs-regular text-text-tertiary",children:u("panel.optional",{ns:"workflow"})})]})]})});e.s(["default",0,n])},501912,449435,e=>{"use strict";var t=e.i(223751);e.s(["Link03",()=>t.default],501912);var a=e.i(563199),s=e.i(268255);e.i(152567);var r=e.i(408767),n=e.i(151094),i=e.i(648404);let l=/^(https?|ftp):\/\//;e.s(["default",0,e=>{let{onUpload:t,disabled:o}=e,{t:d}=(0,r.useTranslation)(),[u,c]=(0,s.useState)("");return(0,a.jsxs)("div",{className:"flex h-8 items-center rounded-lg border border-components-panel-border bg-components-panel-bg pl-1.5 pr-1 shadow-xs",children:[(0,a.jsx)("input",{type:"text",className:"mr-0.5 h-[18px] grow appearance-none bg-transparent px-1 text-[13px] text-text-primary outline-none",value:u,onChange:e=>c(e.target.value),placeholder:d("imageUploader.pasteImageLinkInputPlaceholder",{ns:"common"})||""}),(0,a.jsx)(n.default,{variant:"primary",size:"small",disabled:!u||o,onClick:()=>{o||t({type:i.TransferMethod.remote_url,_id:`${Date.now()}`,fileId:"",progress:l.test(u)?0:-1,url:u})},children:d("operation.ok",{ns:"common"})})]})}],449435)},538883,e=>{"use strict";var t=e.i(780887);e.s(["RefreshCcw01",()=>t.default])},189107,e=>{"use strict";var t=e.i(563199),a=e.i(268255);e.i(152567);var s=e.i(408767);e.i(47690);var r=e.i(501912);e.i(644896);var n=e.i(541983),i=e.i(391185),l=e.i(648404),o=e.i(330276),d=e.i(449435),u=e.i(837699);e.i(668763);var c=e.i(538883);e.i(793622);var p=e.i(259509),m=e.i(998020),h=e.i(421001),g=e.i(935139);let f=e=>{let{list:r,readonly:n,onRemove:i,onReUpload:o,onImageLinkLoadSuccess:d,onImageLinkLoadError:f}=e,{t:x}=(0,s.useTranslation)(),[b,y]=(0,a.useState)("");return(0,t.jsxs)("div",{className:"flex flex-wrap",children:[r.map(e=>(0,t.jsxs)("div",{className:"group relative mr-1 rounded-lg border-[0.5px] border-black/5",children:[e.type===l.TransferMethod.local_file&&100!==e.progress&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"absolute inset-0 z-[1] flex items-center justify-center bg-black/30",style:{left:e.progress>-1?`${e.progress}%`:0},children:-1===e.progress&&(0,t.jsx)(c.RefreshCcw01,{className:"h-5 w-5 text-white",onClick:()=>o?.(e._id)})}),e.progress>-1&&(0,t.jsxs)("span",{className:"absolute left-[50%] top-[50%] z-[1] translate-x-[-50%] translate-y-[-50%] text-sm text-white mix-blend-lighten",children:[e.progress,"%"]})]}),e.type===l.TransferMethod.remote_url&&100!==e.progress&&(0,t.jsxs)("div",{className:`
                  absolute inset-0 z-[1] flex items-center justify-center rounded-lg border
                  ${-1===e.progress?"border-[#DC6803] bg-[#FEF0C7]":"border-transparent bg-black/[0.16]"}
                `,children:[e.progress>-1&&(0,t.jsx)(u.RiLoader2Line,{className:"h-5 w-5 animate-spin text-white"}),-1===e.progress&&(0,t.jsx)(h.default,{popupContent:x("imageUploader.pasteImageLinkInvalid",{ns:"common"}),children:(0,t.jsx)(p.AlertTriangle,{className:"h-4 w-4 text-[#DC6803]"})})]}),(0,t.jsx)("img",{className:"h-16 w-16 cursor-pointer rounded-lg border-[0.5px] border-black/5 object-cover",alt:e.file?.name,onLoad:()=>{e.type===l.TransferMethod.remote_url&&d&&-1!==e.progress&&d(e._id)},onError:()=>{e.type===l.TransferMethod.remote_url&&f&&f(e._id)},src:e.type===l.TransferMethod.remote_url?e.url:e.base64Url,onClick:()=>100===e.progress&&y(e.type===l.TransferMethod.remote_url?e.url:e.base64Url)}),!n&&(0,t.jsx)("button",{type:"button",className:(0,g.cn)("absolute -right-[9px] -top-[9px] z-10 h-[18px] w-[18px] items-center justify-center","rounded-2xl shadow-lg hover:bg-state-base-hover",-1===e.progress?"flex":"hidden group-hover:flex"),onClick:()=>i?.(e._id),children:(0,t.jsx)(u.RiCloseLine,{className:"h-3 w-3 text-text-tertiary"})})]},e._id)),b&&(0,t.jsx)(m.default,{url:b,onCancel:()=>y(""),title:""})]})},x=e=>{let{children:s,onUpload:r,closePopover:n,limit:i,disabled:d}=e,[u,c]=(0,a.useState)(!1),{handleLocalFileUpload:p}=(0,o.useLocalFileUploader)({limit:i,onUpload:r,disabled:d});return(0,t.jsxs)("div",{className:"relative",onMouseEnter:()=>c(!0),onMouseLeave:()=>c(!1),children:[s(u),(0,t.jsx)("input",{className:"absolute inset-0 block w-full cursor-pointer text-[0] opacity-0 disabled:cursor-not-allowed",onClick:e=>e.target.value="",type:"file",accept:l.ALLOW_FILE_EXTENSIONS.map(e=>`.${e}`).join(","),onChange:e=>{let t=e.target.files?.[0];t&&(p(t),n?.())},disabled:d})]})},b=e=>{let{onUpload:n,disabled:l}=e,{t:o}=(0,s.useTranslation)(),[u,c]=(0,a.useState)(!1);return(0,t.jsxs)(i.PortalToFollowElem,{open:u,onOpenChange:c,placement:"top-start",children:[(0,t.jsx)(i.PortalToFollowElemTrigger,{onClick:()=>{l||c(e=>!e)},children:(0,t.jsxs)("div",{className:`
          relative flex h-8 items-center justify-center rounded-lg bg-components-button-tertiary-bg px-3 text-xs text-text-tertiary hover:bg-components-button-tertiary-bg-hover
          ${l?"cursor-not-allowed":"cursor-pointer"}
        `,children:[(0,t.jsx)(r.Link03,{className:"mr-2 h-4 w-4"}),o("imageUploader.pasteImageLink",{ns:"common"})]})}),(0,t.jsx)(i.PortalToFollowElemContent,{className:"z-10",children:(0,t.jsx)("div",{className:"w-[320px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg p-2 shadow-lg",children:(0,t.jsx)(d.default,{onUpload:e=>{c(!1),n(e)}})})})]})};e.s(["default",0,e=>{let{settings:r,onFilesChange:i,disabled:d}=e,{t:u}=(0,s.useTranslation)(),{files:c,onUpload:p,onRemove:m,onImageLinkLoadError:h,onImageLinkLoadSuccess:g,onReUpload:y}=(0,o.useImageFiles)();(0,a.useEffect)(()=>{i(c)},[c]);let _=(0,t.jsx)(x,{onUpload:p,disabled:c.length>=r.number_limits||d,limit:+r.image_file_size_limit,children:e=>(0,t.jsxs)("div",{className:`
            flex h-8 cursor-pointer items-center justify-center rounded-lg
            bg-components-button-tertiary-bg px-3 text-xs text-text-tertiary
            ${e&&"hover:bg-components-button-tertiary-bg-hover"}
          `,children:[(0,t.jsx)(n.ImagePlus,{className:"mr-2 h-4 w-4"}),u("imageUploader.uploadFromComputer",{ns:"common"})]})}),v=(0,t.jsx)(b,{onUpload:p,disabled:c.length>=r.number_limits||d});return(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"mb-1",children:(0,t.jsx)(f,{list:c,onRemove:m,onReUpload:y,onImageLinkLoadError:h,onImageLinkLoadSuccess:g})}),(0,t.jsx)("div",{className:`grid gap-1 ${2===r.transfer_methods.length?"grid-cols-2":"grid-cols-1"}`,children:r.transfer_methods.map(e=>e===l.TransferMethod.local_file?(0,t.jsx)(a.Fragment,{children:_},l.TransferMethod.local_file):e===l.TransferMethod.remote_url?(0,t.jsx)(a.Fragment,{children:v},l.TransferMethod.remote_url):null)})]})}],189107)},130822,e=>{"use strict";var t=e.i(223314),a=e.i(390622);let s=e=>({type:e.type,transfer_method:e.transfer_method,url:e.remote_url,upload_file_id:e.related_id});e.s(["getProcessedInputs",0,(e,r)=>{let n={...e};return r.forEach(r=>{let i=e[r.variable];if(r.type===a.InputVarType.checkbox){n[r.variable]=!!i;return}if(null!=i){if(r.type===a.InputVarType.singleFile)"transfer_method"in i?n[r.variable]=s(i):n[r.variable]=(0,t.getProcessedFiles)([i])[0];else if(r.type===a.InputVarType.multiFiles)"transfer_method"in i[0]?n[r.variable]=i.map(s):n[r.variable]=(0,t.getProcessedFiles)(i);else if(r.type===a.InputVarType.jsonObject)try{let e="string"==typeof i?JSON.parse(i):i;e&&"object"==typeof e&&!Array.isArray(e)?n[r.variable]=e:n[r.variable]=i}catch{n[r.variable]=i}}}),n},"processOpeningStatement",0,(e,t,a)=>e?e.replace(/\{\{([^}]+)\}\}/g,(e,s)=>{let r=t[s];if(r)return r;let n=a.find(e=>e.variable===s);return n?`{{${n.label}}}`:e}):e])},837063,e=>{e.v({icon:{type:"element",isRootNode:!0,name:"svg",attributes:{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},children:[{type:"element",name:"g",attributes:{opacity:"0.5"},children:[{type:"element",name:"rect",attributes:{width:"24",height:"24",rx:"6",fill:"#E5E7EB"},children:[]},{type:"element",name:"rect",attributes:{x:"0.25",y:"0.25",width:"23.5",height:"23.5",rx:"5.75",stroke:"black","stroke-opacity":"0.05","stroke-width":"0.5"},children:[]},{type:"element",name:"path",attributes:{d:"M11.8876 5.30588C11.9601 5.26959 12.019 5.21074 12.0553 5.13817L12.414 4.4208C12.5522 4.1444 12.9466 4.1444 13.0848 4.4208L13.4435 5.13817C13.4797 5.21074 13.5386 5.26959 13.6112 5.30588L14.3285 5.66457C14.6049 5.80276 14.6049 6.19719 14.3285 6.33539L13.6112 6.69407C13.5386 6.73036 13.4797 6.78921 13.4435 6.86178L13.0848 7.57916C12.9466 7.85555 12.5522 7.85555 12.414 7.57916L12.0553 6.86178C12.019 6.78921 11.9601 6.73036 11.8876 6.69407L11.1702 6.33539C10.8938 6.19719 10.8938 5.80276 11.1702 5.66457L11.8876 5.30588Z",fill:"#667085"},children:[]},{type:"element",name:"path",attributes:{d:"M7.88756 6.55588C7.96013 6.51959 8.01898 6.46074 8.05527 6.38817L8.28895 5.9208C8.42715 5.6444 8.82158 5.6444 8.95978 5.9208L9.19346 6.38817C9.22975 6.46074 9.2886 6.51959 9.36117 6.55588L9.82854 6.78956C10.1049 6.92776 10.1049 7.32219 9.82854 7.46039L9.36117 7.69407C9.2886 7.73036 9.22975 7.78921 9.19346 7.86178L8.95978 8.32915C8.82158 8.60555 8.42715 8.60555 8.28895 8.32915L8.05527 7.86178C8.01898 7.78921 7.96013 7.73036 7.88756 7.69407L7.42019 7.46039C7.14379 7.32219 7.14379 6.92776 7.42019 6.78957L7.88756 6.55588Z",fill:"#667085"},children:[]},{type:"element",name:"path",attributes:{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M17.9417 5.91012C18.1985 6.08504 18.2648 6.43496 18.0899 6.6917L16.0062 9.74998H17.4375C17.7482 9.74998 18 10.0018 18 10.3125V18.1875C18 18.9124 17.4124 19.5 16.6875 19.5H7.3125C6.58763 19.5 6 18.9123 6 18.1875V10.3125C6 10.0018 6.25184 9.74998 6.5625 9.74998H14.6449L17.1601 6.05826C17.3351 5.80152 17.685 5.7352 17.9417 5.91012ZM10.3125 12.75C10.0018 12.75 9.75 13.0018 9.75 13.3125C9.75 13.6231 10.0018 13.875 10.3125 13.875H13.6875C13.9982 13.875 14.25 13.6231 14.25 13.3125C14.25 13.0018 13.9982 12.75 13.6875 12.75H10.3125Z",fill:"#667085"},children:[]}]}]},name:"DefaultToolIcon"})},38215,e=>{e.v({icon:{type:"element",isRootNode:!0,name:"svg",attributes:{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg"},children:[{type:"element",name:"path",attributes:{d:"M5 6.5V5M8.93934 7.56066L10 6.5M10.0103 11.5H11.5103",stroke:"#667085","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},children:[]}]},name:"Icon3Dots"})},137153,e=>{e.v({icon:{type:"element",isRootNode:!0,name:"svg",attributes:{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},children:[{type:"element",name:"g",attributes:{id:"message-3-fill"},children:[{type:"element",name:"g",attributes:{id:"Vector",filter:"url(#filter0_d_1071_49501)"},children:[{type:"element",name:"path",attributes:{d:"M2 8.99374C2 5.68349 4.67654 3 8.00066 3H15.9993C19.3134 3 22 5.69478 22 8.99374V21H8.00066C4.68659 21 2 18.3052 2 15.0063V8.99374ZM14 11V13H16V11H14ZM8 11V13H10V11H8Z",fill:"url(#paint0_linear_1071_49501)"},children:[]}]}]},{type:"element",name:"defs",attributes:{},children:[{type:"element",name:"filter",attributes:{id:"filter0_d_1071_49501",x:"1.5",y:"2.75",width:"21",height:"19",filterUnits:"userSpaceOnUse","color-interpolation-filters":"sRGB"},children:[{type:"element",name:"feFlood",attributes:{"flood-opacity":"0",result:"BackgroundImageFix"},children:[]},{type:"element",name:"feColorMatrix",attributes:{in:"SourceAlpha",type:"matrix",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0",result:"hardAlpha"},children:[]},{type:"element",name:"feOffset",attributes:{dy:"0.25"},children:[]},{type:"element",name:"feGaussianBlur",attributes:{stdDeviation:"0.25"},children:[]},{type:"element",name:"feComposite",attributes:{in2:"hardAlpha",operator:"out"},children:[]},{type:"element",name:"feColorMatrix",attributes:{type:"matrix",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.2 0"},children:[]},{type:"element",name:"feBlend",attributes:{mode:"normal",in2:"BackgroundImageFix",result:"effect1_dropShadow_1071_49501"},children:[]},{type:"element",name:"feBlend",attributes:{mode:"normal",in:"SourceGraphic",in2:"effect1_dropShadow_1071_49501",result:"shape"},children:[]}]},{type:"element",name:"linearGradient",attributes:{id:"paint0_linear_1071_49501",x1:"12",y1:"3",x2:"12",y2:"21",gradientUnits:"userSpaceOnUse"},children:[{type:"element",name:"stop",attributes:{"stop-color":"#296DFF"},children:[]},{type:"element",name:"stop",attributes:{offset:"1","stop-color":"#0BA5EC"},children:[]}]}]}]},name:"Message3Fill"})},243661,e=>{e.v({icon:{type:"element",isRootNode:!0,name:"svg",attributes:{width:"624",height:"48",viewBox:"0 0 624 48",fill:"none",xmlns:"http://www.w3.org/2000/svg"},children:[{type:"element",name:"rect",attributes:{x:"8",y:"7",width:"16",height:"16",rx:"5",fill:"#F2F4F7"},children:[]},{type:"element",name:"rect",attributes:{x:"32",y:"10",width:"233",height:"10",rx:"3",fill:"#EAECF0"},children:[]},{type:"element",name:"rect",attributes:{x:"32",y:"31",width:"345",height:"6",rx:"3",fill:"#F2F4F7"},children:[]}]},name:"RowStruct"})},8482,322219,484474,706248,e=>{"use strict";var t=e.i(563199),a=e.i(807324),s=e.i(837063);let r=e=>{let{ref:r,...n}=e;return(0,t.jsx)(a.default,{...n,ref:r,data:s.default})};r.displayName="DefaultToolIcon",e.s(["default",0,r],322219),e.i(38215);var n=e.i(137153);let i=e=>{let{ref:s,...r}=e;return(0,t.jsx)(a.default,{...r,ref:s,data:n.default})};i.displayName="Message3Fill",e.s(["default",0,i],484474);var l=e.i(243661);let o=e=>{let{ref:s,...r}=e;return(0,t.jsx)(a.default,{...r,ref:s,data:l.default})};o.displayName="RowStruct",e.s(["default",0,o],706248),e.s([],8482)},326773,e=>{"use strict";var t=e.i(276925),a=e.i(124836),s=e.i(105845),r=e.i(326531),n=e.i(268255);e.i(152567);var i=e.i(408767),l=e.i(503144),o=e.i(153935),d=e.i(223314),u=e.i(137667),c=e.i(390622),p=e.i(157884),m=e.i(367916),h=e.i(648404),g=e.i(53349),f=e.i(130822);e.s(["useChat",0,(e,x,b,y,_,v)=>{let{t:w}=(0,i.useTranslation)(),{formatTime:j}=(0,p.default)(),{notify:k}=(0,u.useToastContext)(),C=(0,n.useRef)(""),S=(0,n.useRef)(!1),[N,I]=(0,n.useState)(!1),T=(0,n.useRef)(!1),F=(0,n.useRef)(""),[A,L]=(0,n.useState)([]),R=(0,n.useRef)(null),M=(0,n.useRef)(null),E=(0,r.useParams)(),q=(0,r.usePathname)(),[P,U]=(0,n.useState)(b||[]),D=(0,n.useRef)(P),[W,O]=(0,n.useState)(),B=(0,n.useMemo)(()=>(0,g.getThreadMessages)(P,W),[P,W]),$=(0,n.useCallback)(e=>(0,f.processOpeningStatement)(e,x?.inputs||{},x?.inputsForm||[]),[x?.inputs,x?.inputsForm]),V=(0,n.useMemo)(()=>{let t=[...B];if(e?.opening_statement){let a=B.findIndex(e=>e.isOpeningStatement);a>-1?t[a]={...t[a],content:$(e.opening_statement),suggestedQuestions:e.suggested_questions?.map(e=>$(e))}:t.unshift({id:"opening-statement",content:$(e.opening_statement),isAnswer:!0,isOpeningStatement:!0,suggestedQuestions:e.suggested_questions?.map(e=>$(e))})}return t},[B,e?.opening_statement,$,e?.suggested_questions]);(0,n.useEffect)(()=>((0,s.setAutoFreeze)(!1),()=>{(0,s.setAutoFreeze)(!0)}),[]);let H=(0,n.useCallback)((e,t)=>(0,s.produce)(D.current,a=>{let s=[...a];for(;s.length>0;){let a=s.shift();if(a.id===e){t(a);break}a.children&&s.push(...a.children)}}),[]),z=(0,n.useCallback)((e,t)=>{let a=H(e,e=>{"function"==typeof t?t(e):Object.keys(t).forEach(a=>{e[a]=t[a]})});U(a),D.current=a},[H]),G=(0,n.useCallback)(e=>{I(e),T.current=e},[]),Z=(0,n.useCallback)(()=>{S.current=!0,G(!1),y&&F.current&&y(F.current),R.current&&R.current.abort(),M.current&&M.current.abort()},[y,G]),K=(0,n.useCallback)(e=>{C.current="",F.current="",Z(),U([]),L([]),e?.()},[Z]),Q=(0,n.useCallback)(e=>{let t,{parentId:a,responseItem:r,placeholderQuestionId:n,questionItem:i}=e,l={...i,children:[{...r,children:[]}]};U(t=a||P.some(e=>[n,i.id].includes(e.id))?H(a,e=>{let t=e.children.findIndex(e=>[n,i.id].includes(e.id));-1===t?e.children.push(l):e.children[t]=l}):(0,s.produce)(P,e=>{e.push(l)})),D.current=t},[P,H]),J=(0,n.useCallback)(async(s,r,n)=>{let{onGetConversationMessages:i,onGetSuggestedQuestions:u,onConversationComplete:p,isPublicAPI:g}=n;if(L([]),T.current)return k({type:"info",message:w("errorMessage.waitForResponse",{ns:"appDebug"})}),!1;let b=B.find(e=>e.id===r.parent_message_id),y=`question-${Date.now()}`,_={id:y,content:r.query,isAnswer:!1,message_files:r.files,parentMessageId:r.parent_message_id},v=`answer-placeholder-${Date.now()}`,N={id:v,content:"",isAnswer:!0,parentMessageId:_.id,siblingIndex:b?.children?.length??P.length};O(b?.id),Q({parentId:r.parent_message_id,responseItem:N,placeholderQuestionId:y,questionItem:_});let I={id:v,content:"",agent_thoughts:[],message_files:[],isAnswer:!0,parentMessageId:_.id,siblingIndex:b?.children?.length??P.length};G(!0),S.current=!1;let{query:A,files:U,inputs:D,...W}=r,$={response_mode:"streaming",conversation_id:C.current,files:(0,d.getProcessedFiles)(U||[]),query:A,inputs:(0,f.getProcessedInputs)(D||{},x?.inputsForm||[]),...W};$?.files?.length&&($.files=$.files.map(e=>e.transfer_method===h.TransferMethod.local_file?{...e,url:""}:e));let V=!1,H=!1,Z="",K=!1;E.token?(Z="/text-to-audio",K=!0):E.appId&&(Z=q.search("explore/installed")>-1?`/installed-apps/${E.appId}/text-to-audio`:`/apps/${E.appId}/text-to-audio`);let J=null,X=()=>(J||(J=o.AudioPlayerManager.getInstance().getAudioPlayer(Z,K,(0,l.v4)(),"none","none",a.noop)),J);return(0,m.ssePost)(s,{body:$},{isPublicAPI:g,onData:(e,t,a)=>{let{conversationId:s,messageId:n,taskId:i}=a;if(V){let t=I.agent_thoughts?.[I.agent_thoughts?.length-1];t&&(t.thought=t.thought+e)}else I.content=I.content+e;n&&!H&&(_.id=`question-${n}`,I.id=n,I.parentMessageId=_.id,H=!0),t&&s&&(C.current=s),F.current=i,n&&(I.id=n),Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})},async onCompleted(t){if(G(!1),!t){if(p&&p(C.current),C.current&&!S.current&&i){let{data:e}=await i(C.current,e=>R.current=e),t=e.find(e=>e.id===I.id);if(!t)return;let a=t.agent_thoughts?.length>0&&t.agent_thoughts[t.agent_thoughts?.length-1].thought===t.answer;z(I.id,{content:a?"":t.answer,log:[...t.message,..."assistant"!==t.message[t.message.length-1].role?[{role:"assistant",text:t.answer,files:t.message_files?.filter(e=>"assistant"===e.belongs_to)||[]}]:[]],more:{time:j(t.created_at,"hh:mm A"),tokens:t.answer_tokens+t.message_tokens,latency:t.provider_response_latency.toFixed(2),tokens_per_second:t.provider_response_latency>0?(t.answer_tokens/t.provider_response_latency).toFixed(2):void 0},conversationId:C.current,input:{inputs:t.inputs,query:t.query}})}if(e?.suggested_questions_after_answer?.enabled&&!S.current&&u)try{let{data:e}=await u(I.id,e=>M.current=e);L(e)}catch(e){L([])}}},onFile(e){let t=e.type||"image",a="transferMethod"in e?e:null,s={id:a?.id||e.id,type:a?.type||("image"===t?"image/png":"video"===t?"video/mp4":"audio"===t?"audio/mpeg":"application/octet-stream"),transferMethod:a?.transferMethod||("image"===t?"remote_url":"local_file"),uploadedId:a?.uploadedId||e.id,supportFileType:a?.supportFileType||("image"===t?"image":"video"===t?"video":"audio"===t?"audio":"document"),progress:a?.progress??100,name:a?.name||`generated_${t}.${"image"===t?"png":"video"===t?"mp4":"audio"===t?"mp3":"bin"}`,url:a?.url||e.url,size:a?.size??0},n=I.agent_thoughts?.[I.agent_thoughts?.length-1];if(n)I.agent_thoughts[I.agent_thoughts.length-1].message_files=[...n.message_files??[],s];else{let e=I.message_files??[];I.message_files=[...e,s]}Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})},onThought(e){if(V=!0,e.message_id&&!H&&(I.id=e.message_id),e.conversation_id&&(I.conversationId=e.conversation_id),0===I.agent_thoughts.length)I.agent_thoughts.push(e);else{let t=I.agent_thoughts[I.agent_thoughts.length-1];t.id===e.id?(e.thought=t.thought,e.message_files=t.message_files,I.agent_thoughts[I.agent_thoughts.length-1]=e):I.agent_thoughts.push(e)}Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})},onMessageEnd:e=>{if(e.metadata?.annotation_reply){I.id=e.id,I.annotation={id:e.metadata.annotation_reply.id,authorName:e.metadata.annotation_reply.account.name},Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id});return}I.citation=e.metadata?.retriever_resources||[];let a=(0,d.getProcessedFilesFromResponse)(e.files||[]);I.allFiles=(0,t.uniqBy)([...I.allFiles||[],...a||[]],"id"),Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})},onMessageReplace:e=>{I.content=e.answer},onError(){G(!1),Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})},onWorkflowStarted:e=>{let{workflow_run_id:t,task_id:a}=e;F.current=a,I.workflow_run_id=t,I.workflowProcess={status:c.WorkflowRunningStatus.Running,tracing:[]},Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})},onWorkflowFinished:e=>{let{data:t}=e;I.workflowProcess.status=t.status,Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})},onIterationStart:e=>{let{data:t}=e;I.workflowProcess.tracing.push({...t,status:c.WorkflowRunningStatus.Running}),Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})},onIterationFinish:e=>{let{data:t}=e,a=I.workflowProcess.tracing,s=a.findIndex(e=>e.node_id===t.node_id&&(e.execution_metadata?.parallel_id===t.execution_metadata?.parallel_id||e.parallel_id===t.execution_metadata?.parallel_id));a[s]={...a[s],...t,status:c.WorkflowRunningStatus.Succeeded},Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})},onNodeStarted:e=>{let{data:t}=e;t.iteration_id||r.loop_id||(I.workflowProcess.tracing.push({...t,status:c.WorkflowRunningStatus.Running}),Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id}))},onNodeFinished:e=>{let{data:t}=e;if(t.iteration_id||r.loop_id)return;let a=I.workflowProcess.tracing.findIndex(e=>e.execution_metadata?.parallel_id?e.node_id===t.node_id&&e.execution_metadata?.parallel_id===t.execution_metadata?.parallel_id:e.node_id===t.node_id);I.workflowProcess.tracing[a]=t,Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})},onTTSChunk:(e,t)=>{if(!t||""===t)return;let a=X();a&&(a.playAudioWithAudio(t,!0),o.AudioPlayerManager.getInstance().resetMsgId(e))},onTTSEnd:(e,t)=>{let a=X();a&&a.playAudioWithAudio(t,!1)},onLoopStart:e=>{let{data:t}=e;I.workflowProcess.tracing.push({...t,status:c.WorkflowRunningStatus.Running}),Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})},onLoopFinish:e=>{let{data:t}=e,a=I.workflowProcess.tracing,s=a.findIndex(e=>e.node_id===t.node_id&&(e.execution_metadata?.parallel_id===t.execution_metadata?.parallel_id||e.parallel_id===t.execution_metadata?.parallel_id));a[s]={...a[s],...t,status:c.WorkflowRunningStatus.Succeeded},Q({placeholderQuestionId:y,questionItem:_,responseItem:I,parentId:r.parent_message_id})}}),!0},[w,P.length,B,e?.suggested_questions_after_answer,Q,z,k,G,j,E.token,E.appId,q,x]),X=(0,n.useCallback)((e,t,a)=>{let s=V[a-1].id,r=V[a].id;z(s,{content:e}),z(r,{content:t,annotation:{...V[a].annotation,logAnnotation:void 0}})},[V,z]),Y=(0,n.useCallback)((e,t,a,s,r)=>{let n=V[r-1].id,i=V[r].id;z(n,{content:a}),z(i,{content:V[r].content,annotation:{id:e,authorName:t,logAnnotation:{content:s,account:{id:"",name:t,email:""}}}})},[V,z]),ee=(0,n.useCallback)(e=>{z(V[e].id,{content:V[e].content,annotation:{...V[e].annotation,id:""}})},[V,z]);return(0,n.useEffect)(()=>{_&&K(()=>v?.(!1))},[_,v,K]),{chatList:V,setTargetMessageId:O,conversationId:C.current,isResponding:N,setIsResponding:I,handleSend:J,suggestedQuestions:A,handleRestart:K,handleStop:Z,handleAnnotationEdited:X,handleAnnotationAdded:Y,handleAnnotationRemoved:ee}}])},680884,e=>{"use strict";e.s(["formatBooleanInputs",0,(e,t)=>{if(!e)return t;let a={...t};return e.forEach(e=>{"checkbox"===e.type&&(a[e.key]=!!a[e.key])}),a},"promptVariablesToUserInputsForm",0,e=>{let t=[];return e.filter(e=>{let{key:t,name:a}=e;return t&&t.trim()&&a&&a.trim()}).forEach(e=>{"string"===e.type||"paragraph"===e.type?t.push({["string"===e.type?"text-input":"paragraph"]:{label:e.name,variable:e.key,required:!1!==e.required,max_length:e.max_length,default:"",hide:e.hide}}):"number"===e.type||"checkbox"===e.type?t.push({[e.type]:{label:e.name,variable:e.key,required:!1!==e.required,default:"",hide:e.hide}}):"select"===e.type?t.push({select:{label:e.name,variable:e.key,required:!1!==e.required,options:e.options,default:e.default??"",hide:e.hide}}):t.push({external_data_tool:{label:e.name,variable:e.key,enabled:e.enabled,type:e.type,config:e.config,required:e.required,icon:e.icon,icon_background:e.icon_background,hide:e.hide}})}),t},"userInputsFormToPromptVariables",0,(e,t)=>{if(!e)return[];let a=[];return e.forEach(e=>{let[s,r]=e.paragraph?["paragraph",e.paragraph]:e["text-input"]?["string",e["text-input"]]:e.number?["number",e.number]:e.checkbox?["boolean",e.checkbox]:e.file?["file",e.file]:e["file-list"]?["file-list",e["file-list"]]:e.external_data_tool?[e.external_data_tool.type,e.external_data_tool]:e.json_object?["json_object",e.json_object]:["select",e.select||{}],n=t===r?.variable;"string"===s||"paragraph"===s?a.push({key:r.variable,name:r.label,required:r.required,type:s,max_length:r.max_length,options:[],is_context_var:n,hide:r.hide,default:r.default}):"number"===s?a.push({key:r.variable,name:r.label,required:r.required,type:s,options:[],hide:r.hide,default:r.default}):"boolean"===s?a.push({key:r.variable,name:r.label,required:r.required,type:"checkbox",options:[],hide:r.hide,default:r.default}):"select"===s?a.push({key:r.variable,name:r.label,required:r.required,type:"select",options:r.options,is_context_var:n,hide:r.hide,default:r.default}):"file"===s?a.push({key:r.variable,name:r.label,required:r.required,type:s,config:{allowed_file_types:r.allowed_file_types,allowed_file_extensions:r.allowed_file_extensions,allowed_file_upload_methods:r.allowed_file_upload_methods,number_limits:1},hide:r.hide,default:r.default}):"file-list"===s?a.push({key:r.variable,name:r.label,required:r.required,type:s,config:{allowed_file_types:r.allowed_file_types,allowed_file_extensions:r.allowed_file_extensions,allowed_file_upload_methods:r.allowed_file_upload_methods,number_limits:r.max_length},hide:r.hide,default:r.default}):a.push({key:r.variable,name:r.label,required:r.required,type:r.type,enabled:r.enabled,config:r.config,icon:r.icon,icon_background:r.icon_background,is_context_var:n,hide:r.hide})}),a}])},419874,e=>{"use strict";var t=e.i(563199),a=e.i(837699),s=e.i(417944),r=e.i(26012),n=e.i(326531),i=e.i(268255);e.i(152567);var l=e.i(408767),o=e.i(189299),d=e.i(654313),u=e.i(744704),c=e.i(75518),p=e.i(449980),m=e.i(379415),h=e.i(543753),g=e.i(137667),f=e.i(459760),x=e.i(447301),b=e.i(935139);e.i(237855);var y=e.i(297162),_=e.i(481162),v=e.i(955371);let w=(0,i.memo)(e=>{let{data:a,content:s,currentTab:r}=e;return(0,t.jsxs)(t.Fragment,{children:["RESULT"===r&&(0,t.jsxs)("div",{className:"space-y-3 p-4",children:[a?.resultText&&(0,t.jsx)(m.Markdown,{content:a?.resultText||""}),!!a?.files?.length&&(0,t.jsx)("div",{className:"flex flex-col gap-2",children:a?.files.map(e=>(0,t.jsxs)("div",{className:"system-xs-regular flex flex-col gap-1",children:[(0,t.jsx)("div",{className:"py-1 text-text-tertiary ",children:e.varName}),(0,t.jsx)(y.FileList,{files:e.list,showDeleteAction:!1,showDownloadAction:!0,canPreview:!0})]},e.varName))})]}),"DETAIL"===r&&s&&(0,t.jsx)("div",{className:"p-4",children:(0,t.jsx)(_.default,{readOnly:!0,title:(0,t.jsx)("div",{children:"JSON OUTPUT"}),language:v.CodeLanguage.json,value:s,isJSONStringifyBeauty:!0})})]})}),j=e=>{let{isWorkflow:y,workflowProcessData:_,className:v,isError:k,onRetry:C,content:S,messageId:N,isLoading:I,isResponding:T,moreLikeThis:F,isInWebApp:A=!1,feedback:L,onFeedback:R,onSave:M,depth:E=1,isMobile:q,appSourceType:P,installedAppId:U,taskId:D,controlClearMoreLikeThis:W,supportFeedback:O,isShowTextToSpeech:B,hideProcessDetail:$,siteInfo:V,inSidePanel:H}=e,{t:z}=(0,l.useTranslation)(),G=(0,n.useParams)(),Z=1===E,K=P===x.AppSourceType.tryApp,[Q,J]=(0,i.useState)(""),[X,Y]=(0,i.useState)(null),[ee,et]=(0,i.useState)({rating:null}),{config:ea}=(0,c.useChatContext)(),es=(0,o.useStore)(e=>e.setCurrentLogItem),er=(0,o.useStore)(e=>e.setShowPromptLogModal),en=async e=>{await (0,x.updateFeedback)({url:`/messages/${X}/feedbacks`,body:{rating:e.rating}},P,U),et(e)},[ei,{setTrue:el,setFalse:eo}]=(0,s.useBoolean)(!1),ed=async()=>{if(ei||!N)return void g.default.notify({type:"warning",message:z("errorMessage.waitForResponse",{ns:"appDebug"})});el();let e=await (0,x.fetchMoreLikeThis)(N,P,U);J(e.answer),et({rating:null}),Y(e.id),eo()};(0,i.useEffect)(()=>{W&&(Y(null),J(""))},[W]),(0,i.useEffect)(()=>{I&&Y(null)},[I]);let eu=async()=>{let e=await (0,f.fetchTextGenerationMessage)({appId:G.appId,messageId:N});es(Array.isArray(e.message)?{...e,log:[...e.message,..."assistant"!==e.message[e.message.length-1].role?[{role:"assistant",text:e.answer,files:e.message_files?.filter(e=>"assistant"===e.belongs_to)||[]}]:[]]}:{...e,log:["string"==typeof e.message?{text:e.message}:e.message]}),er(!0)},[ec,ep]=(0,i.useState)("DETAIL"),em=!!_?.resultText||!!_?.files?.length,eh=async e=>{ep(e)};return(0,i.useEffect)(()=>{_?.resultText||_?.files?.length?eh("RESULT"):eh("DETAIL")},[_?.files?.length,_?.resultText]),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:(0,b.cn)("relative",!Z&&"mt-3",v),children:[I&&(0,t.jsx)("div",{className:(0,b.cn)("flex h-10 items-center",!H&&"rounded-2xl border-t border-divider-subtle bg-chat-bubble-bg"),children:(0,t.jsx)(p.default,{type:"area"})}),!I&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:(0,b.cn)("relative",!H&&"rounded-2xl border-t border-divider-subtle bg-chat-bubble-bg"),children:[_&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:(0,b.cn)("p-3",em&&"border-b border-divider-subtle"),children:[D&&(0,t.jsxs)("div",{className:(0,b.cn)("system-2xs-medium-uppercase mb-2 flex items-center text-text-accent-secondary",k&&"text-text-destructive"),children:[(0,t.jsx)(a.RiPlayList2Line,{className:"mr-1 h-3 w-3"}),(0,t.jsx)("span",{children:z("generation.execution",{ns:"share"})}),(0,t.jsx)("span",{className:"px-1",children:"·"}),(0,t.jsx)("span",{children:D})]}),V&&_&&(0,t.jsx)(u.default,{data:_,expand:_.expand,hideProcessDetail:$,hideInfo:$,readonly:!V.show_workflow_steps}),em&&(0,t.jsxs)("div",{className:"flex items-center space-x-6 px-1",children:[(0,t.jsx)("div",{className:(0,b.cn)("system-sm-semibold-uppercase cursor-pointer border-b-2 border-transparent py-3 text-text-tertiary","RESULT"===ec&&"border-util-colors-blue-brand-blue-brand-600 text-text-primary"),onClick:()=>eh("RESULT"),children:z("result",{ns:"runLog"})}),(0,t.jsx)("div",{className:(0,b.cn)("system-sm-semibold-uppercase cursor-pointer border-b-2 border-transparent py-3 text-text-tertiary","DETAIL"===ec&&"border-util-colors-blue-brand-blue-brand-600 text-text-primary"),onClick:()=>eh("DETAIL"),children:z("detail",{ns:"runLog"})})]})]}),!k&&(0,t.jsx)(w,{data:_,content:S,currentTab:ec})]}),!_&&D&&(0,t.jsxs)("div",{className:(0,b.cn)("system-2xs-medium-uppercase sticky left-0 top-0 flex w-full items-center rounded-t-2xl bg-components-actionbar-bg p-4 pb-3 text-text-accent-secondary",k&&"text-text-destructive"),children:[(0,t.jsx)(a.RiPlayList2Line,{className:"mr-1 h-3 w-3"}),(0,t.jsx)("span",{children:z("generation.execution",{ns:"share"})}),(0,t.jsx)("span",{className:"px-1",children:"·"}),(0,t.jsx)("span",{children:`${D}${E>1?`-${E-1}`:""}`})]}),k&&(0,t.jsx)("div",{className:"body-lg-regular p-4 pt-0 text-text-quaternary",children:z("generation.batchFailed.outputPlaceholder",{ns:"share"})}),!_&&!k&&"string"==typeof S&&(0,t.jsx)("div",{className:(0,b.cn)("p-4",D&&"pt-0"),children:(0,t.jsx)(m.Markdown,{content:S})})]}),(0,t.jsxs)("div",{className:(0,b.cn)("system-xs-regular relative mt-1 h-4 px-4 text-text-quaternary",q&&(X||ei)&&E<3&&"pl-10"),children:[!y&&(0,t.jsxs)("span",{children:[S?.length," ",z("unit.char",{ns:"common"})]}),(0,t.jsxs)("div",{className:"absolute bottom-1 right-2 flex items-center",children:[!A&&P!==x.AppSourceType.installedApp&&!T&&(0,t.jsx)("div",{className:"ml-1 flex items-center gap-0.5 rounded-[10px] border-[0.5px] border-components-actionbar-border bg-components-actionbar-bg p-0.5 shadow-md backdrop-blur-sm",children:(0,t.jsx)(d.default,{disabled:k||!N,onClick:eu,children:(0,t.jsx)(a.RiFileList3Line,{className:"h-4 w-4"})})}),(0,t.jsxs)("div",{className:"ml-1 flex items-center gap-0.5 rounded-[10px] border-[0.5px] border-components-actionbar-border bg-components-actionbar-bg p-0.5 shadow-md backdrop-blur-sm",children:[F&&!K&&(0,t.jsx)(d.default,{state:3===E?d.ActionButtonState.Disabled:d.ActionButtonState.Default,disabled:3===E,onClick:ed,children:(0,t.jsx)(a.RiSparklingLine,{className:"h-4 w-4"})}),B&&!K&&(0,t.jsx)(h.default,{id:N,voice:ea?.text_to_speech?.voice}),("RESULT"===ec&&_?.resultText||!y)&&(0,t.jsx)(d.default,{disabled:k||!N,onClick:()=>{let e=y?_?.resultText:S;"string"==typeof e?(0,r.default)(e):(0,r.default)(JSON.stringify(e)),g.default.notify({type:"success",message:z("actionMsg.copySuccessfully",{ns:"common"})})},children:(0,t.jsx)(a.RiClipboardLine,{className:"h-4 w-4"})}),A&&k&&(0,t.jsx)(d.default,{onClick:C,children:(0,t.jsx)(a.RiReplay15Line,{className:"h-4 w-4"})}),A&&!y&&!K&&(0,t.jsx)(d.default,{disabled:k||!N,onClick:()=>{M?.(N)},children:(0,t.jsx)(a.RiBookmark3Line,{className:"h-4 w-4"})})]}),(O||A)&&!y&&!K&&!k&&N&&(0,t.jsxs)("div",{className:"ml-1 flex items-center gap-0.5 rounded-[10px] border-[0.5px] border-components-actionbar-border bg-components-actionbar-bg p-0.5 shadow-md backdrop-blur-sm",children:[!L?.rating&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(d.default,{onClick:()=>R?.({rating:"like"}),children:(0,t.jsx)(a.RiThumbUpLine,{className:"h-4 w-4"})}),(0,t.jsx)(d.default,{onClick:()=>R?.({rating:"dislike"}),children:(0,t.jsx)(a.RiThumbDownLine,{className:"h-4 w-4"})})]}),L?.rating==="like"&&(0,t.jsx)(d.default,{state:d.ActionButtonState.Active,onClick:()=>R?.({rating:null}),children:(0,t.jsx)(a.RiThumbUpLine,{className:"h-4 w-4"})}),L?.rating==="dislike"&&(0,t.jsx)(d.default,{state:d.ActionButtonState.Destructive,onClick:()=>R?.({rating:null}),children:(0,t.jsx)(a.RiThumbDownLine,{className:"h-4 w-4"})})]})]})]}),!Z&&(0,t.jsxs)("div",{className:(0,b.cn)("absolute top-[-32px] flex h-[33px] w-4 justify-center",q?"left-[17px]":"left-[50%] translate-x-[-50%]"),children:[(0,t.jsx)("div",{className:"h-full w-0.5 bg-divider-regular"}),(0,t.jsx)("div",{className:(0,b.cn)("absolute left-0 flex h-4 w-4 items-center justify-center rounded-2xl border-[0.5px] border-divider-subtle bg-util-colors-blue-blue-500 shadow-xs",q?"top-[3.5px]":"top-2"),children:(0,t.jsx)(a.RiSparklingFill,{className:"h-3 w-3 text-text-primary-on-surface"})})]})]})]}),(X||ei)&&E<3&&(0,t.jsx)(j,{isInWebApp:!0,content:Q,messageId:X,depth:E+1,moreLikeThis:!0,onFeedback:en,isLoading:ei,feedback:ee,onSave:M,isShowTextToSpeech:B,isMobile:q,appSourceType:P,installedAppId:U,controlClearMoreLikeThis:W,isWorkflow:y,siteInfo:V,taskId:D})]})},k=i.memo(j);e.s(["default",0,k],419874)},290422,e=>{"use strict";e.s(["addFileInfos",0,(e,t)=>e&&t?e.map(e=>e.files&&e.files?.length>0?{...e,message_files:e.files.map(e=>t.find(t=>t.id===e))}:e):e,"sortAgentSorts",0,e=>{if(!e||e.some(e=>void 0===e.position))return e;let t=[...e];return t.sort((e,t)=>e.position-t.position),t}])},366892,e=>{"use strict";var t=e.i(563199),a=e.i(268255),s=e.i(935139);let r=a.memo(e=>{let{items:a,value:r,itemClassName:n,itemWrapClassName:i,activeItemClassName:l,onChange:o}=e,d=e=>{let{id:a,name:d,icon:u,extra:c,disabled:p}=e;return(0,t.jsxs)("div",{className:(0,s.cn)("system-md-semibold relative flex cursor-pointer items-center border-b-2 border-transparent pb-2 pt-2.5",a===r?(0,s.cn)("border-components-tab-active text-text-primary",l):"text-text-tertiary",p&&"cursor-not-allowed opacity-30",i),onClick:()=>!p&&o(a),children:[u||"",(0,t.jsx)("div",{className:(0,s.cn)("ml-2",n),children:d}),c||""]},a)};return(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("div",{className:"flex space-x-4",children:a.filter(e=>!e.isRight).map(d)}),(0,t.jsx)("div",{className:"flex space-x-4",children:a.filter(e=>e.isRight).map(d)})]})});e.s(["default",0,r])},112727,387450,608846,210807,727163,e=>{"use strict";var t=e.i(484474);e.s(["Message3Fill",()=>t.default],112727);var a=e.i(563199);e.i(326531);var s=e.i(268255),r=e.i(639751);e.i(53349);var n=e.i(449980),i=e.i(752901),l=e.i(562572),o=e.i(447301),d=e.i(722384);let u="webapp",c=[u,"conversations"];e.s(["useGetWebAppAccessModeByCode",0,e=>(0,l.useQuery)({queryKey:[u,"appAccessMode",e],queryFn:()=>(0,o.getAppAccessModeByAppCode)(e),enabled:!!e,staleTime:0,gcTime:0}),"useInvalidateShareConversations",0,()=>(0,d.useInvalid)(c),"useShareChatList",0,function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{enabled:a=!0,refetchOnReconnect:s,refetchOnWindowFocus:r}=t,n=a&&e.appSourceType!==o.AppSourceType.tryApp&&(e.appSourceType!==o.AppSourceType.installedApp||!!e.appId)&&!!e.conversationId;return(0,l.useQuery)({queryKey:[u,"chatList",e],queryFn:()=>(0,o.fetchChatList)(e.conversationId,e.appSourceType,e.appId),enabled:n,refetchOnReconnect:s,refetchOnWindowFocus:r,staleTime:0})},"useShareConversationName",0,function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{enabled:a=!0,refetchOnReconnect:s,refetchOnWindowFocus:r}=t,n=a&&(e.appSourceType!==o.AppSourceType.installedApp||!!e.appId)&&!!e.conversationId;return(0,l.useQuery)({queryKey:[u,"conversationName",e],queryFn:()=>(0,o.generationConversationName)(e.appSourceType,e.appId,e.conversationId),enabled:n,refetchOnReconnect:s,refetchOnWindowFocus:r})},"useShareConversations",0,function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{enabled:a=!0,refetchOnReconnect:s,refetchOnWindowFocus:r}=t,n=a&&e.appSourceType!==o.AppSourceType.tryApp&&(e.appSourceType!==o.AppSourceType.installedApp||!!e.appId);return(0,l.useQuery)({queryKey:[u,"conversations",e],queryFn:()=>(0,o.fetchConversations)(e.appSourceType,e.appId,e.lastId,e.pinned,e.limit),enabled:n,refetchOnReconnect:s,refetchOnWindowFocus:r})}],387450),e.i(494268);let p=(0,r.create)(e=>({shareCode:null,updateShareCode:t=>e(()=>({shareCode:t})),appInfo:null,updateAppInfo:t=>e(()=>({appInfo:t})),appParams:null,updateAppParams:t=>e(()=>({appParams:t})),webAppAccessMode:i.AccessMode.SPECIFIC_GROUPS_MEMBERS,updateWebAppAccessMode:t=>e(()=>({webAppAccessMode:t})),appMeta:null,updateWebAppMeta:t=>e(()=>({appMeta:t})),userCanAccessApp:!1,updateUserCanAccessApp:t=>e(()=>({userCanAccessApp:t})),embeddedUserId:null,updateEmbeddedUserId:t=>e(()=>({embeddedUserId:t})),embeddedConversationId:null,updateEmbeddedConversationId:t=>e(()=>({embeddedConversationId:t}))}));e.s(["useWebAppStore",0,p],608846);var m=e.i(837699),h=e.i(417944),g=e.i(915389),f=e.i(105845),x=e.i(419874),b=e.i(151094),y=e.i(223314);e.i(992280);var _=e.i(85789),v=e.i(137667);e.i(152567);var w=e.i(408767);let j=s.memo(()=>{let{t:e}=(0,w.useTranslation)();return(0,a.jsxs)("div",{className:"flex h-full w-full flex-col items-center justify-center",children:[(0,a.jsx)(m.RiSparklingFill,{className:"h-12 w-12 text-text-empty-state-icon"}),(0,a.jsx)("div",{className:"system-sm-regular mt-2 text-text-quaternary",children:e("generation.noData",{ns:"share"})})]})});var k=e.i(390622),C=e.i(925521),S=e.i(648404),N=e.i(842090),I=e.i(680884);let T=s.memo(e=>{let{isWorkflow:t,isCallBatchAPI:r,isPC:i,isMobile:l,appSourceType:d,appId:u,isError:c,isShowTextToSpeech:p,promptConfig:w,moreLikeThisEnabled:T,inputs:F,controlSend:A,controlRetry:L,controlStopResponding:R,onShowRes:M,handleSaveMessage:E,taskId:q,onCompleted:P,visionConfig:U,completionFiles:D,siteInfo:W,onRunStart:O,onRunControlChange:B,hideInlineStopButton:$=!1}=e,[V,{setTrue:H,setFalse:z}]=(0,h.useBoolean)(!1),[G,Z]=(0,s.useState)(""),K=(0,s.useRef)(""),Q=e=>{K.current=e,Z(e)},[J,X]=(0,s.useState)(),Y=(0,s.useRef)(void 0),ee=e=>{Y.current=e,X(e)},[et,ea]=(0,s.useState)(null),[es,er]=(0,s.useState)(!1),en=(0,s.useRef)(null),ei=(0,s.useCallback)(()=>{ea(null),er(!1),en.current=null,B?.(null)},[B]);(0,s.useEffect)(()=>{let e=()=>{en.current?.abort()};return R&&(e(),z(),ei()),e},[R,ei,z]);let{notify:el}=v.default,eo=!G,[ed,eu]=(0,s.useState)(null),[ec,ep]=(0,s.useState)({rating:null}),em=async e=>{await (0,o.updateFeedback)({url:`/messages/${ed}/feedbacks`,body:{rating:e.rating,content:e.content}},d,u),ep(e)},eh=(0,s.useCallback)(async()=>{if(et&&!es){er(!0);try{t?await (0,o.stopWorkflowMessage)(u,et,d,u||""):await (0,o.stopChatMessageResponding)(u,et,d,u||""),en.current?.abort()}catch(e){el({type:"error",message:e instanceof Error?e.message:String(e)})}finally{er(!1)}}},[u,et,d,u,es,t,el]);(0,s.useEffect)(()=>{B&&(V&&et?B({onStop:eh,isStopping:es}):B(null))},[et,eh,V,es,B]);let eg=async()=>{if(V)return el({type:"info",message:(0,g.t)("errorMessage.waitForResponse",{ns:"appDebug"})}),!1;if(!(()=>{if(r)return!0;let e=w?.prompt_variables;if(!e||e?.length===0)return!D.find(e=>e.transfer_method===S.TransferMethod.local_file&&!e.upload_file_id)||(el({type:"info",message:(0,g.t)("errorMessage.waitForFileUpload",{ns:"appDebug"})}),!1);let t="";return((e?.filter(e=>{let{key:t,name:a,required:s,type:r}=e;return"boolean"!==r&&"checkbox"!==r&&(!t||!t.trim()||!a||!a.trim()||s||null==s)})||[]).forEach(e=>{let{key:a,name:s}=e;!t&&(F[a]||(t=s))}),t)?(el({type:"error",message:(0,g.t)("errorMessage.valueOfVarRequired",{ns:"appDebug",key:t})}),!1):D.find(e=>e.transfer_method===S.TransferMethod.local_file&&!e.upload_file_id)?(el({type:"info",message:(0,g.t)("errorMessage.waitForFileUpload",{ns:"appDebug"})}),!1):!t})())return;let e={...(0,I.formatBooleanInputs)(w?.prompt_variables,F)};w?.prompt_variables.forEach(t=>{let a=e[t.key];"file"===t.type&&a&&"object"==typeof a&&!Array.isArray(a)?e[t.key]=(0,y.getProcessedFiles)([a])[0]:"file-list"===t.type&&Array.isArray(a)&&a.length>0&&(e[t.key]=(0,y.getProcessedFiles)(a))});let a={inputs:e};U.enabled&&D&&D?.length>0&&(a.files=D.map(e=>e.transfer_method===S.TransferMethod.local_file?{...e,url:""}:e)),eu(null),ep({rating:null}),Q(""),ei();let s=[],n="";i||(M(),O()),H();let l=!1,c=!1;(async()=>{await (0,N.sleep)(C.TEXT_GENERATION_TIMEOUT_MS),l||(z(),P(K.current,q,!1),ei(),c=!0)})(),t?(0,o.sendWorkflowMessage)(a,{onWorkflowStarted:e=>{let{workflow_run_id:t,task_id:a}=e;n=t,ea(a||null),er(!1),ee({status:k.WorkflowRunningStatus.Running,tracing:[],expand:!1,resultText:""})},onIterationStart:e=>{let{data:t}=e;ee((0,f.produce)(Y.current,e=>{e.expand=!0,e.tracing.push({...t,status:k.NodeRunningStatus.Running,expand:!0})}))},onIterationNext:()=>{ee((0,f.produce)(Y.current,e=>{e.expand=!0;let t=e.tracing.find(e=>e.node_id===a.node_id&&(e.execution_metadata?.parallel_id===a.execution_metadata?.parallel_id||e.parallel_id===a.execution_metadata?.parallel_id));t?.details.push([])}))},onIterationFinish:e=>{let{data:t}=e;ee((0,f.produce)(Y.current,e=>{e.expand=!0;let a=e.tracing.findIndex(e=>e.node_id===t.node_id&&(e.execution_metadata?.parallel_id===t.execution_metadata?.parallel_id||e.parallel_id===t.execution_metadata?.parallel_id));e.tracing[a]={...t,expand:!!t.error}}))},onLoopStart:e=>{let{data:t}=e;ee((0,f.produce)(Y.current,e=>{e.expand=!0,e.tracing.push({...t,status:k.NodeRunningStatus.Running,expand:!0})}))},onLoopNext:()=>{ee((0,f.produce)(Y.current,e=>{e.expand=!0;let t=e.tracing.find(e=>e.node_id===a.node_id&&(e.execution_metadata?.parallel_id===a.execution_metadata?.parallel_id||e.parallel_id===a.execution_metadata?.parallel_id));t?.details.push([])}))},onLoopFinish:e=>{let{data:t}=e;ee((0,f.produce)(Y.current,e=>{e.expand=!0;let a=e.tracing.findIndex(e=>e.node_id===t.node_id&&(e.execution_metadata?.parallel_id===t.execution_metadata?.parallel_id||e.parallel_id===t.execution_metadata?.parallel_id));e.tracing[a]={...t,expand:!!t.error}}))},onNodeStarted:e=>{let{data:t}=e;t.iteration_id||t.loop_id||ee((0,f.produce)(Y.current,e=>{e.expand=!0,e.tracing.push({...t,status:k.NodeRunningStatus.Running,expand:!0})}))},onNodeFinished:e=>{let{data:t}=e;t.iteration_id||t.loop_id||ee((0,f.produce)(Y.current,e=>{let a=e.tracing.findIndex(e=>e.node_id===t.node_id&&(e.execution_metadata?.parallel_id===t.execution_metadata?.parallel_id||e.parallel_id===t.execution_metadata?.parallel_id));a>-1&&e.tracing&&(e.tracing[a]={...e.tracing[a].extras?{extras:e.tracing[a].extras}:{},...t,expand:!!t.error})}))},onWorkflowFinished:e=>{let{data:t}=e;if(c)return void el({type:"warning",message:(0,g.t)("warningMessage.timeoutExceeded",{ns:"appDebug"})});let a=t.status,s=e=>{if(!e)return;let t=e=>{[k.NodeRunningStatus.Running,k.NodeRunningStatus.Waiting].includes(e.status)&&(e.status=k.NodeRunningStatus.Stopped),e.details?.forEach(e=>e.forEach(t)),e.retryDetail?.forEach(t),e.parallelDetail?.children?.forEach(t)};e.forEach(t)};if(a===k.WorkflowRunningStatus.Stopped){ee((0,f.produce)(Y.current,e=>{e.status=k.WorkflowRunningStatus.Stopped,s(e.tracing)})),z(),ei(),P(K.current,q,!1),l=!0;return}if(t.error){el({type:"error",message:t.error}),ee((0,f.produce)(Y.current,e=>{e.status=k.WorkflowRunningStatus.Failed,s(e.tracing)})),z(),ei(),P(K.current,q,!1),l=!0;return}ee((0,f.produce)(Y.current,e=>{e.status=k.WorkflowRunningStatus.Succeeded,e.files=(0,y.getFilesInLogs)(t.outputs||[])})),t.outputs?(Q(t.outputs),1===Object.keys(t.outputs).length&&"string"==typeof t.outputs[Object.keys(t.outputs)[0]]&&ee((0,f.produce)(Y.current,e=>{e.resultText=t.outputs[Object.keys(t.outputs)[0]]}))):Q(""),z(),ei(),eu(n),P(K.current,q,!0),l=!0},onTextChunk:e=>{let{data:{text:t}}=e;ee((0,f.produce)(Y.current,e=>{e.resultText+=t}))},onTextReplace:e=>{let{data:{text:t}}=e;ee((0,f.produce)(Y.current,e=>{e.resultText=t}))}},d,u).catch(e=>{z(),ei(),el({type:"error",message:e instanceof Error?e.message:String(e)})}):(0,o.sendCompletionMessage)(a,{onData:(e,t,a)=>{let{messageId:r,taskId:i}=a;n=r,i&&"string"==typeof i&&""!==i.trim()&&ea(e=>e??i),s.push(e),Q(s.join(""))},onCompleted:()=>{c?el({type:"warning",message:(0,g.t)("warningMessage.timeoutExceeded",{ns:"appDebug"})}):(z(),ei(),eu(n),P(K.current,q,!0),l=!0)},onMessageReplace:e=>{Q((s=[e.answer]).join(""))},onError(){c?el({type:"warning",message:(0,g.t)("warningMessage.timeoutExceeded",{ns:"appDebug"})}):(z(),ei(),P(K.current,q,!1),l=!0)},getAbortController:e=>{en.current=e}},d,u)},[ef,ex]=(0,s.useState)(0);(0,s.useEffect)(()=>{A&&(eg(),ex(Date.now()))},[A]),(0,s.useEffect)(()=>{L&&eg()},[L]);let eb=()=>(0,a.jsxs)(a.Fragment,{children:[!$&&V&&et&&(0,a.jsx)("div",{className:`mb-3 flex ${i?"justify-end":"justify-center"}`,children:(0,a.jsxs)(b.default,{variant:"secondary",disabled:es,onClick:eh,children:[es?(0,a.jsx)(m.RiLoader2Line,{className:"mr-[5px] h-3.5 w-3.5 animate-spin"}):(0,a.jsx)(_.StopCircle,{className:"mr-[5px] h-3.5 w-3.5"}),(0,a.jsx)("span",{className:"text-xs font-normal",children:(0,g.t)("operation.stopResponding",{ns:"appDebug"})})]})}),(0,a.jsx)(x.default,{isWorkflow:t,workflowProcessData:J,isError:c,onRetry:eg,content:G,messageId:ed,isInWebApp:!0,moreLikeThis:T,onFeedback:em,feedback:ec,onSave:E,isMobile:l,appSourceType:d,installedAppId:u,isLoading:!!r&&!G&&V,taskId:r?q<10?`0${q}`:`${q}`:void 0,controlClearMoreLikeThis:ef,isShowTextToSpeech:p,hideProcessDetail:!0,siteInfo:W})]});return(0,a.jsxs)(a.Fragment,{children:[!r&&!t&&(V&&!G?(0,a.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:(0,a.jsx)(n.default,{type:"area"})}):(0,a.jsx)(a.Fragment,{children:eo?(0,a.jsx)(j,{}):eb()})),!r&&t&&(V&&!J?(0,a.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:(0,a.jsx)(n.default,{type:"area"})}):J?eb():(0,a.jsx)(j,{})),r&&eb()]})});e.s(["default",0,T],210807),e.i(237855);var F=e.i(910605),A=e.i(189107),L=e.i(291631),R=e.i(299951),M=e.i(873517),E=e.i(371784),q=e.i(481162),P=e.i(955371),U=e.i(271743),D=e.i(935139);let W=s.memo(e=>{let{promptConfig:t,inputs:r,inputsRef:n,onInputsChange:i,onSend:l,visionConfig:o,onVisionFilesChange:d,runControl:u}=e,{t:c}=(0,w.useTranslation)(),p=(0,U.default)()===U.MediaType.pc,[h,g]=(0,s.useState)(!1),f=!!u,x=c("generation.stopRun",{ns:"share",defaultValue:"Stop Run"}),y=(0,s.useCallback)(e=>{f&&(e.preventDefault(),u?.onStop?.())},[f,u]),v=(0,s.useCallback)(e=>{i(e),n.current=e},[i,n]);return(0,s.useEffect)(()=>{if(h)return;let e={};t.prompt_variables.forEach(t=>{"select"===t.type?e[t.key]=t.default:"string"===t.type||"paragraph"===t.type?e[t.key]=t.default||"":"number"===t.type?e[t.key]=t.default??"":"checkbox"===t.type?e[t.key]=t.default||!1:"file"===t.type?e[t.key]=void 0:"file-list"===t.type?e[t.key]=[]:e[t.key]=void 0}),i(e),g(!0)},[t.prompt_variables,i]),(0,a.jsx)("div",{className:"",children:(0,a.jsx)("section",{children:(0,a.jsxs)("form",{onSubmit:e=>{e.preventDefault(),l()},children:[null!=r&&0!==Object.keys(r).length&&h?t.prompt_variables.filter(e=>!0!==e.hide).map(e=>(0,a.jsxs)("div",{className:"mt-4 w-full",children:["checkbox"!==e.type&&(0,a.jsxs)("div",{className:"system-md-semibold flex h-6 items-center gap-1 text-text-secondary",children:[(0,a.jsx)("div",{className:"truncate",children:e.name}),!e.required&&(0,a.jsx)("span",{className:"system-xs-regular text-text-tertiary",children:c("panel.optional",{ns:"workflow"})})]}),(0,a.jsxs)("div",{className:"mt-1",children:["select"===e.type&&(0,a.jsx)(R.default,{className:"w-full",defaultValue:r[e.key],onSelect:t=>{v({...n.current,[e.key]:t.value})},items:(e.options||[]).map(e=>({name:e,value:e})),allowSearch:!1}),"string"===e.type&&(0,a.jsx)(L.default,{type:"text",placeholder:e.name,value:r[e.key],onChange:t=>{v({...n.current,[e.key]:t.target.value})},maxLength:e.max_length}),"paragraph"===e.type&&(0,a.jsx)(M.default,{className:"h-[104px] sm:text-xs",placeholder:e.name,value:r[e.key],onChange:t=>{v({...n.current,[e.key]:t.target.value})}}),"number"===e.type&&(0,a.jsx)(L.default,{type:"number",placeholder:e.name,value:r[e.key],onChange:t=>{v({...n.current,[e.key]:t.target.value})}}),"checkbox"===e.type&&(0,a.jsx)(E.default,{name:e.name||e.key,value:!!r[e.key],required:e.required,onChange:t=>{v({...n.current,[e.key]:t})}}),"file"===e.type&&(0,a.jsx)(F.FileUploaderInAttachmentWrapper,{value:r[e.key]&&"object"==typeof r[e.key]?[r[e.key]]:[],onChange:t=>{v({...n.current,[e.key]:t[0]})},fileConfig:{...e.config,fileUploadConfig:o.fileUploadConfig}}),"file-list"===e.type&&(0,a.jsx)(F.FileUploaderInAttachmentWrapper,{value:Array.isArray(r[e.key])?r[e.key]:[],onChange:t=>{v({...n.current,[e.key]:t})},fileConfig:{...e.config,fileUploadConfig:o.fileUploadConfig}}),"json_object"===e.type&&(0,a.jsx)(q.default,{language:P.CodeLanguage.json,value:r[e.key],onChange:t=>{v({...n.current,[e.key]:t})},noWrapper:!0,className:"bg h-[80px] overflow-y-auto rounded-[10px] bg-components-input-bg-normal p-1",placeholder:(0,a.jsx)("div",{className:"whitespace-pre",children:"string"==typeof e.json_schema?e.json_schema:JSON.stringify(e.json_schema||"",null,2)})})]})]},e.key)):null,o?.enabled&&(0,a.jsxs)("div",{className:"mt-4 w-full",children:[(0,a.jsx)("div",{className:"system-md-semibold flex h-6 items-center text-text-secondary",children:c("imageUploader.imageUpload",{ns:"common"})}),(0,a.jsx)("div",{className:"mt-1",children:(0,a.jsx)(A.default,{settings:o,onFilesChange:e=>d(e.filter(e=>-1!==e.progress).map(e=>({type:"image",transfer_method:e.type,url:e.url,upload_file_id:e.fileId})))})})]}),(0,a.jsx)("div",{className:"mb-3 mt-6 w-full",children:(0,a.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,a.jsx)(b.default,{onClick:()=>{let e={};t.prompt_variables.forEach(t=>{"string"===t.type||"paragraph"===t.type||"number"===t.type?e[t.key]="":"checkbox"===t.type?e[t.key]=!1:e[t.key]=void 0}),i(e)},disabled:!1,children:(0,a.jsx)("span",{className:"text-[13px]",children:c("operation.clear",{ns:"common"})})}),(0,a.jsx)(b.default,{className:(0,D.cn)(!p&&"grow"),type:f?"button":"submit",variant:f?"secondary":"primary",disabled:f&&u?.isStopping,onClick:y,"data-testid":f?"stop-button":"run-button",children:f?(0,a.jsxs)(a.Fragment,{children:[u?.isStopping?(0,a.jsx)(m.RiLoader2Line,{className:"mr-1 h-4 w-4 shrink-0 animate-spin","aria-hidden":"true"}):(0,a.jsx)(_.StopCircle,{className:"mr-1 h-4 w-4 shrink-0","aria-hidden":"true"}),(0,a.jsx)("span",{className:"text-[13px]",children:x})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(m.RiPlayLargeLine,{className:"mr-1 h-4 w-4 shrink-0","aria-hidden":"true"}),(0,a.jsx)("span",{className:"text-[13px]",children:c("generation.run",{ns:"share"})})]})})]})})]})})})});e.s(["default",0,W],727163)}]);