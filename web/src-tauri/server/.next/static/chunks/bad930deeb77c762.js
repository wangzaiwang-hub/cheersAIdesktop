(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,221991,e=>{"use strict";function r(e){return Array.isArray(e)}e.s(["isArray",()=>r])},840247,e=>{"use strict";var r=e.i(652669);let a=e=>null!==e&&"object"==typeof e,t=function(e,r){let t=(e,r)=>{let i=a(e),l=a(r);if(!i)return!0;if(!l){for(let r in e)if("type"===r||a(e[r])&&!t(e[r],null))return!1;return!0}let o=e.type,s=r.type,n=a(o);if(!n&&o!==s)return!1;for(let a of new Set([...Object.keys(e),...Object.keys(r)]))if(("type"!==a||n)&&!t(e[a],r[a]))return!1;return!0};return t(e,r)};e.s(["default",0,()=>{let{data:e,isLoading:a}=(0,r.useSchemaTypeDefinitions)();return{isLoading:a,schemaTypeDefinitions:e}},"getMatchedSchemaType",0,(e,r)=>{if(!r||null==e)return"";let a=r.find(r=>t(e,r.schema));return a?a.name:""}],840247)},671258,754210,472663,e=>{"use strict";e.i(187243);var r,a=e.i(989425),t=e.i(390622);e.i(905691);var i=e.i(97672),l=e.i(840247);let o=[{name:"datasource_type",type:t.VarType.string,description:"local_file, online_document, website_crawl"}],s=[{name:"file",type:t.VarType.file,description:"file",subItems:[{name:"name",type:t.VarType.string,description:"file name"},{name:"size",type:t.VarType.number,description:"file size"},{name:"type",type:t.VarType.string,description:"file type"},{name:"extension",type:t.VarType.string,description:"file extension"},{name:"mime_type",type:t.VarType.string,description:"file mime type"},{name:"transfer_method",type:t.VarType.string,description:"file transfer method"},{name:"url",type:t.VarType.string,description:"file url"},{name:"related_id",type:t.VarType.string,description:"file related id"}]}];e.s(["COMMON_OUTPUT",0,o,"LOCAL_FILE_OUTPUT",0,s],754210),e.i(705848);var n=((r={}).localFile="local_file",r.websiteCrawl="website_crawl",r.onlineDocument="online_document",r.onlineDrive="online_drive",r);e.s(["DataSourceClassification",()=>n],472663);let p="errorMsg",c=(0,i.genNodeMetaData)({sort:-1,type:t.BlockEnum.DataSource,isStart:!0,isRequired:!0});e.s(["default",0,{metaData:c,defaultValue:{datasource_parameters:{},datasource_configurations:{}},checkValid(e,r,t){let{dataSourceInputsSchema:i,notAuthed:l}=t,o="";return l&&(o=r(`${p}.authRequired`,{ns:"workflow"})),o||i.filter(e=>e.required).forEach(t=>{let i=e.datasource_parameters[t.variable];if(!i){o=r(`${p}.fieldRequired`,{ns:"workflow",field:t.label});return}let{type:l,value:s}=i;l===a.VarType.variable?o||s&&0!==s.length||(o=r(`${p}.fieldRequired`,{ns:"workflow",field:t.label})):o||null!=s&&""!==s||(o=r(`${p}.fieldRequired`,{ns:"workflow",field:t.label}))}),{isValid:!o,errorMessage:o}},getOutputVars(e,r){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],{schemaTypeDefinitions:t}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{schemaTypeDefinitions:[]},{plugin_id:i,datasource_name:p,provider_type:c}=e,y=c===n.localFile,u=r.dataSourceList?.find(e=>e.plugin_id===i),d=u?.tools?.find(e=>e.name===p),b=d?.output_schema,m=[];return b?.properties&&Object.keys(b.properties).forEach(e=>{let r=b.properties[e],a=r.type,i="array"===a?`array[${r.items?.type.slice(0,1).toLocaleLowerCase()}${r.items?.type.slice(1)}]`:`${a.slice(0,1).toLocaleLowerCase()}${a.slice(1)}`,o=l.getMatchedSchemaType?.(r,t);"object"===i&&"file"===o&&(i="file"),m.push({variable:e,type:i,description:r.description,schemaType:o,children:"object"===r.type?{schema:{type:"object",properties:r.properties}}:void 0})}),[...o.map(e=>({variable:e.name,type:e.type})),...y?s.map(e=>({variable:e.name,type:e.type})):[],...a,...m]}}],671258)},144480,e=>{"use strict";var r=e.i(946700);e.i(187243);var a=e.i(989425),t=e.i(390622);e.i(905691);var i=e.i(97672),l=e.i(842090),o=e.i(959752),s=e.i(669744),n=e.i(840247);let p=e=>{if(!e)return;let{type:r,properties:a,items:t,oneOf:i,anyOf:l,allOf:o}=e;if(Array.isArray(r))return r.find(e=>e&&"null"!==e)||r[0];if("string"==typeof r)return r;for(let e of[i,l,o].filter(e=>Array.isArray(e)).flat()){let r=p(e);if(r)return r}return a?"object":t?"array":void 0},c=(e,r)=>{let a=(0,n.getMatchedSchemaType)(e,r);switch(p(e)){case"string":return{type:t.VarType.string,schemaType:a};case"number":return{type:t.VarType.number,schemaType:a};case"integer":return{type:t.VarType.integer,schemaType:a};case"boolean":return{type:t.VarType.boolean,schemaType:a};case"object":if("file"===a)return{type:t.VarType.file,schemaType:a};return{type:t.VarType.object,schemaType:a};case"array":{let i=(e=>{if(e&&e.items)return Array.isArray(e.items)?e.items[0]:e.items})(e);if(!i)return{type:t.VarType.array,schemaType:a};let{type:l,schemaType:o}=c(i,r),s=a||o;if("file"===o)return{type:t.VarType.arrayFile,schemaType:s};switch(l){case t.VarType.string:return{type:t.VarType.arrayString,schemaType:s};case t.VarType.number:case t.VarType.integer:return{type:t.VarType.arrayNumber,schemaType:s};case t.VarType.boolean:return{type:t.VarType.arrayBoolean,schemaType:s};case t.VarType.object:return{type:t.VarType.arrayObject,schemaType:s};case t.VarType.file:return{type:t.VarType.arrayFile,schemaType:s};default:return{type:t.VarType.array,schemaType:s}}}default:return{type:t.VarType.any,schemaType:a}}},y="errorMsg",u=(0,i.genNodeMetaData)({sort:-1,type:t.BlockEnum.Tool,helpLinkUri:"tools"});e.s(["default",0,{metaData:u,defaultValue:{tool_parameters:{},tool_configurations:{},tool_node_version:"2"},checkValid(e,r,t){let{toolInputsSchema:i,toolSettingSchema:l,language:o,notAuthed:s}=t,n="";return s&&(n=r(`${y}.authRequired`,{ns:"workflow"})),n||i.filter(e=>e.required).forEach(t=>{let i=e.tool_parameters[t.variable];if(!i){n=r(`${y}.fieldRequired`,{ns:"workflow",field:t.label});return}let{type:l,value:o}=i;l===a.VarType.variable?n||o&&0!==o.length||(n=r(`${y}.fieldRequired`,{ns:"workflow",field:t.label})):n||null!=o&&""!==o||(n=r(`${y}.fieldRequired`,{ns:"workflow",field:t.label}))}),n||l.filter(e=>e.required).forEach(a=>{let t=e.tool_configurations[a.variable];n||null!=t&&""!==t||(n=r(`${y}.fieldRequired`,{ns:"workflow",field:a.label[o]})),!n&&"object"==typeof t&&t.type&&(void 0===t.value||null===t.value||""===t.value||Array.isArray(t.value)&&0===t.value.length)&&(n=r(`${y}.fieldRequired`,{ns:"workflow",field:a.label[o]}))}),{isValid:!n,errorMessage:n}},getOutputVars(e,a,t){let{schemaTypeDefinitions:i}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{schemaTypeDefinitions:[]},{provider_id:n,provider_type:p}=e,y=[];switch(p){case r.CollectionType.builtIn:y=a.buildInTools??[];break;case r.CollectionType.custom:y=a.customTools??[];break;case r.CollectionType.workflow:y=a.workflowTools??[];break;case r.CollectionType.mcp:y=a.mcpTools??[];break;default:y=[]}let u=y.find(e=>(0,l.canFindTool)(e.id,n)),d=u?.tools.find(r=>r.name===e.tool_name),b=d?.output_schema,m=[];if(b&&b.properties){let e=[];Object.keys(b.properties).forEach(r=>{let a=b.properties[r],{type:t,schemaType:l}=c(a,i);e.push({variable:r,type:t,des:a.description,schemaType:l,children:"object"===a.type?{schema:{type:s.Type.object,properties:a.properties,additionalProperties:!1}}:void 0})}),m=[...o.TOOL_OUTPUT_STRUCT,...e]}else m=o.TOOL_OUTPUT_STRUCT;return m}}],144480)},963855,476255,245695,e=>{"use strict";var r=e.i(449448),a=e.i(221991),t=e.i(105845),i=e.i(959752),l=e.i(671258),o=e.i(144480),s=e.i(390622);e.i(905691);var n=e.i(97672),p=e.i(705848),c=e.i(669744);let y=e=>{if(!e)return;let{type:r,properties:a,items:t,oneOf:i,anyOf:l,allOf:o}=e;if(Array.isArray(r))return r.find(e=>e&&"null"!==e)||r[0];if("string"==typeof r)return r;for(let e of[i,l,o].filter(e=>Array.isArray(e)).flat()){let r=y(e);if(r)return r}return a?"object":t?"array":void 0},u=e=>{if(e&&e.items)return Array.isArray(e.items)?e.items[0]:e.items},d=(e,r)=>{if(!e)return;let a=e.schema_type||e.schemaType;if("string"==typeof a&&a.trim().length>0)return a},b=(e,r)=>{let a=d(e,r);switch(y(e)){case"string":return{type:s.VarType.string,schemaType:a};case"number":return{type:s.VarType.number,schemaType:a};case"integer":return{type:s.VarType.integer,schemaType:a};case"boolean":return{type:s.VarType.boolean,schemaType:a};case"object":return{type:s.VarType.object,schemaType:a};case"array":{let t=u(e);if(!t)return{type:s.VarType.array,schemaType:a};let{type:i,schemaType:l}=b(t,r),o=a||l;if("file"===l)return{type:s.VarType.arrayFile,schemaType:o};switch(i){case s.VarType.string:return{type:s.VarType.arrayString,schemaType:o};case s.VarType.number:case s.VarType.integer:return{type:s.VarType.arrayNumber,schemaType:o};case s.VarType.boolean:return{type:s.VarType.arrayBoolean,schemaType:o};case s.VarType.object:return{type:s.VarType.arrayObject,schemaType:o};case s.VarType.file:return{type:s.VarType.arrayFile,schemaType:o};default:return{type:s.VarType.array,schemaType:o}}}default:return{type:s.VarType.any,schemaType:a}}},m=(e,r)=>{let a=d(e,r),t=((e,r)=>{if("file"===r)return"array"===e?c.Type.array:c.Type.file;switch(e){case"number":case"integer":return c.Type.number;case"boolean":return c.Type.boolean;case"object":return c.Type.object;case"array":return c.Type.array;default:return c.Type.string}})(y(e),a),i={type:t};if(e?.description&&(i.description=e.description),a&&(i.schemaType=a),Array.isArray(e?.enum)&&(i.enum=e.enum),t===c.Type.object){i.properties=Object.entries(e?.properties||{}).reduce((e,a)=>{let[t,i]=a;return e[t]=m(i,r),e},{});let a=Array.isArray(e?.required)?e.required.filter(Boolean):void 0;i.required=a&&a.length>0?a:void 0,i.additionalProperties=!1}if(t===c.Type.array){let a=u(e);if(a){let{type:e,...t}=m(a,r);i.items={...t,type:e===c.Type.array?c.Type.object:e}}}return i},T={metaData:(0,n.genNodeMetaData)({sort:1,type:s.BlockEnum.TriggerPlugin,helpLinkUri:"trigger/plugin-trigger",isStart:!0}),defaultValue:{plugin_id:"",event_name:"",event_parameters:{},config:{}},checkValid(e,r){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},t="";e.subscription_id||(t=r("nodes.triggerPlugin.subscriptionRequired",{ns:"workflow"}));let{triggerInputsSchema:i=[],isReadyForCheckValid:l=!0}=a||{};return!t&&l&&i.filter(e=>e.required).forEach(a=>{if(t)return;let i=e.event_parameters?.[a.variable]??e.config?.[a.variable];if(!i){t=r("errorMsg.fieldRequired",{ns:"workflow",field:a.label});return}let{type:l,value:o}="object"==typeof i&&null!==i&&"type"in i?i:{type:p.VarKindType.constant,value:i};l===p.VarKindType.variable?(!o||Array.isArray(o)&&0===o.length)&&(t=r("errorMsg.fieldRequired",{ns:"workflow",field:a.label})):(null==o||""===o||Array.isArray(o)&&0===o.length)&&(t=r("errorMsg.fieldRequired",{ns:"workflow",field:a.label}))}),{isValid:!t,errorMessage:t}},getOutputVars(e,r,a){let{schemaTypeDefinitions:t}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{schemaTypeDefinitions:[]};var i=e.output_schema||{};if(!i||"object"!=typeof i)return[];let l=i.properties;return l?Object.entries(l).map(e=>{let[r,a]=e,{type:i,schemaType:l}=b(a,t),o=y(a),s={variable:r,type:i,des:a?.description,...l?{schemaType:l}:{}};if("object"===o){let e=a?.properties?Object.entries(a.properties).reduce((e,r)=>{let[a,i]=r;return e[a]=m(i,t),e},{}):{},r=Array.isArray(a?.required)?a.required.filter(Boolean):void 0;s.children={schema:{type:c.Type.object,properties:e,required:r&&r.length>0?r:void 0,additionalProperties:!1}}}return s}):[]}};e.s(["default",0,T],476255);var f=e.i(925521),v=e.i(648404);let _=[{value:v.TransferMethod.local_file,i18nKey:"localUpload"},{value:v.TransferMethod.remote_url,i18nKey:"url"}],V=["type","size","name","url","extension","mime_type","transfer_method","related_id"],h=V.filter(e=>"transfer_method"!==e);e.s(["FILE_TYPE_OPTIONS",0,[{value:"image",i18nKey:"image"},{value:"document",i18nKey:"doc"},{value:"audio",i18nKey:"audio"},{value:"video",i18nKey:"video"}],"OUTPUT_FILE_SUB_VARIABLES",0,h,"SUB_VARIABLES",0,V,"TRANSFER_METHOD",0,_],245695),e.i(187243);var g=e.i(989425);let k=e=>"sys"===e[0]||"sys"===e[1],E=e=>!(!k(e)||["query","files"].includes(e[1])),j=e=>"env"===e[0],B=e=>"conversation"===e[0],O=e=>!!e&&"rag"===e[0],A=e=>["sys","env","conversation","rag"].includes(e),S=e=>e&&(Array.isArray(e)&&e.length>0||!Array.isArray(e)&&Object.keys(e?.schema?.properties||{}).length>0),R=e=>({[s.InputVarType.number]:s.VarType.number,[s.InputVarType.checkbox]:s.VarType.boolean,[s.InputVarType.singleFile]:s.VarType.file,[s.InputVarType.multiFiles]:s.VarType.arrayFile,[s.InputVarType.jsonObject]:s.VarType.object})[e]||s.VarType.string,U=(e,r)=>r?({[c.Type.string]:s.VarType.arrayString,[c.Type.number]:s.VarType.arrayNumber,[c.Type.object]:s.VarType.arrayObject})[e]||s.VarType.string:({[c.Type.string]:s.VarType.string,[c.Type.number]:s.VarType.number,[c.Type.boolean]:s.VarType.boolean,[c.Type.object]:s.VarType.object,[c.Type.array]:s.VarType.array})[e]||s.VarType.string,w=(e,r)=>(0,t.produce)(e,a=>(Object.keys(e).forEach(a=>{let t=e[a],i=t.type===c.Type.object,l=t.type===c.Type.array,o=t.items?.type;i||r({variable:a,type:U(l?o:t.type,l)},[a])?t.type===c.Type.object&&t.properties&&(t.properties=w(t.properties,r)):delete e[a]}),a)),L=(e,r,a,i)=>{let l,{children:o}=e;if(o?.schema?.properties)l=(0,t.produce)(o,e=>{let a=e.schema.properties;return Object.keys(a).forEach(e=>{let t=a[e],i=t.type===c.Type.object,l=t.type===c.Type.array,o=t.items?.type;i||r({variable:e,type:U(l?o:t.type,l)},[e])?t.type===c.Type.object&&t.properties&&(t.properties=w(t.properties,r)):delete a[e]}),e});else l=Array.isArray(o)?o.map(e=>{let t,{children:i}=e,l=[...a,e.variable];if(!i)return{item:e,filteredObj:null,passesFilter:r(e,l)};let o=L(e,r,l,!1),n=S(o.children);return t=(e.type===s.VarType.object||e.type===s.VarType.file)&&i?n||r(e,l):n,{item:e,filteredObj:o,passesFilter:t}}).filter(e=>{let{passesFilter:r}=e;return r}).map(e=>{let{item:r,filteredObj:a}=e,{children:t}=r;return t&&a?{...r,children:a.children}:r}):[];return{variable:e.variable,type:i?s.VarType.file:s.VarType.object,children:l,schemaType:e.schemaType}},q=function(e,r,a,t,n){let p=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],{id:c,data:y}=e,u={nodeId:c,title:y.title,vars:[]};switch(y.type){case s.BlockEnum.Start:{let{variables:e}=y;u.vars=e.map(e=>{let r=R(e.type),a={variable:e.variable,type:r,isParagraph:e.type===s.InputVarType.paragraph,isSelect:e.type===s.InputVarType.select,options:e.options,required:e.required};try{r===s.VarType.object&&e.json_schema&&(a.children={schema:"string"==typeof e.json_schema?JSON.parse(e.json_schema):e.json_schema})}catch(e){console.error("Error formatting variable:",e)}return a}),r&&u.vars.push({variable:"sys.query",type:s.VarType.string}),u.vars.push({variable:"sys.files",type:s.VarType.arrayFile});break}case s.BlockEnum.TriggerWebhook:{let{variables:e=[]}=y;u.vars=e.map(e=>{let r=e.value_type||s.VarType.string;return{variable:e.variable,type:r,isParagraph:!1,isSelect:!1,options:e.options,required:e.required}});break}case s.BlockEnum.LLM:u.vars=[...i.LLM_OUTPUT_STRUCT],y.structured_output_enabled&&y.structured_output?.schema?.properties&&Object.keys(y.structured_output.schema.properties).length>0&&u.vars.push({variable:"structured_output",type:s.VarType.object,children:y.structured_output});break;case s.BlockEnum.KnowledgeRetrieval:u.vars=i.KNOWLEDGE_RETRIEVAL_OUTPUT_STRUCT;break;case s.BlockEnum.Code:{let{outputs:e}=y;u.vars=e?Object.keys(e).map(r=>({variable:r,type:e[r].type})):[];break}case s.BlockEnum.TemplateTransform:u.vars=i.TEMPLATE_TRANSFORM_OUTPUT_STRUCT;break;case s.BlockEnum.QuestionClassifier:u.vars=i.QUESTION_CLASSIFIER_OUTPUT_STRUCT;break;case s.BlockEnum.HttpRequest:u.vars=i.HTTP_REQUEST_OUTPUT_STRUCT;break;case s.BlockEnum.VariableAssigner:{let{output_type:e,advanced_settings:r}=y;r?.group_enabled?u.vars=r?.groups.map(e=>({variable:e.group_name,type:s.VarType.object,children:[{variable:"output",type:e.output_type}]})):u.vars=[{variable:"output",type:e}];break}case s.BlockEnum.VariableAggregator:{let{output_type:e,advanced_settings:r}=y;r?.group_enabled?u.vars=r?.groups.map(e=>({variable:e.group_name,type:s.VarType.object,children:[{variable:"output",type:e.output_type}]})):u.vars=[{variable:"output",type:e}];break}case s.BlockEnum.Tool:u.vars=o.default.getOutputVars?.(y,t,[],{schemaTypeDefinitions:p})||[];break;case s.BlockEnum.ParameterExtractor:u.vars=[...(y.parameters||[]).map(e=>({variable:e.name,type:e.type})),...i.PARAMETER_EXTRACTOR_COMMON_STRUCT];break;case s.BlockEnum.Iteration:u.vars=[{variable:"output",type:y.output_type||s.VarType.arrayString}];break;case s.BlockEnum.Loop:{let{loop_variables:e}=y;u.isLoop=!0,u.vars=e?.map(e=>({variable:e.label,type:e.var_type,isLoopVariable:!0,nodeId:u.nodeId}))||[];break}case s.BlockEnum.DocExtractor:u.vars=[{variable:"text",type:y.is_array_file?s.VarType.arrayString:s.VarType.string}];break;case s.BlockEnum.ListFilter:if(!y.var_type)break;u.vars=[{variable:"result",type:y.var_type},{variable:"first_record",type:y.item_var_type},{variable:"last_record",type:y.item_var_type}];break;case s.BlockEnum.Agent:{let e=[];Object.keys(y.output_schema?.properties||{}).forEach(r=>{let a=y.output_schema.properties[r];e.push({variable:r,type:"array"===a.type?`Array[${a.items?.type?a.items.type.slice(0,1).toLocaleUpperCase()+a.items.type.slice(1):"Unknown"}]`:`${a.type?a.type.slice(0,1).toLocaleUpperCase()+a.type.slice(1):"Unknown"}`})}),u.vars=[...e,...i.TOOL_OUTPUT_STRUCT,...i.AGENT_OUTPUT_STRUCT];break}case s.BlockEnum.DataSource:u.vars=l.default.getOutputVars?.(y,t,n,{schemaTypeDefinitions:p})||[];break;case s.BlockEnum.TriggerPlugin:u.vars=T.getOutputVars?.(y,t,[],{schemaTypeDefinitions:p})||[];break;case"env":u.vars=y.envList.map(e=>({variable:`env.${e.name}`,type:e.value_type,description:e.description}));break;case"conversation":u.vars=y.chatVarList.map(e=>({variable:`conversation.${e.name}`,type:e.value_type,description:e.description}));break;case"global":u.vars=y.globalVarList;break;case"rag":u.vars=y.ragVariables.map(e=>({variable:`rag.shared.${e.variable}`,type:R(e.type),des:e.label,isRagVariable:!0}))}let{error_strategy:d}=y;d&&(u.vars=[...u.vars,{variable:"error_message",type:s.VarType.string,isException:!0},{variable:"error_type",type:s.VarType.string,isException:!0}]);let b=[c];return u.vars=u.vars.filter(e=>{if(a(e,(()=>{let r=e.variable.split("."),[a]=r;return A(a)?r:[...b,...r]})()))return!0;let r=e.type===s.VarType.file,t=r?h.map(e=>{let r=i.FILE_STRUCT.find(r=>r.variable===e);return{variable:e,type:r?.type||s.VarType.string}}):e.children;if(!t)return!1;let l=L(r?{...e,children:t}:e,a,b,r);return S(l?.children)}).map(e=>{let r=e.type===s.VarType.file,{children:t}=r?{children:h.map(e=>{let r=i.FILE_STRUCT.find(r=>r.variable===e);return{variable:e,type:r?.type||s.VarType.string}})}:e;return t?L(r?{...e,children:t}:e,a,b,r):e}),u},I=function(e,r){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(e,r)=>!0,t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],n=arguments.length>6?arguments[6]:void 0,p=arguments.length>7?arguments[7]:void 0,c={id:"global",data:{title:"SYSTEM",type:"global",globalVarList:(0,i.getGlobalVars)(r)}},y={id:"rag",data:{title:"SHARED INPUTS",type:"rag",ragVariables:o.filter(e=>"shared"===e.belong_to_node_id)}};return[...[...e].sort((e,r)=>e.data.type===s.BlockEnum.Start?1:r.data.type===s.BlockEnum.Start?-1:"env"===e.data.type?1:"env"===r.data.type?-1:"conversation"===e.data.type?1:"conversation"===r.data.type?-1:"global"===e.data.type?1:"global"===r.data.type?-1:(r.position?.x||0)-(e.position?.x||0)).filter(e=>i.SUPPORT_OUTPUT_VARS_NODE.includes(e?.data?.type)),...t.length>0?[{id:"env",data:{title:"ENVIRONMENT",type:"env",envList:t}}]:[],...r&&l.length>0?[{id:"conversation",data:{title:"CONVERSATION",type:"conversation",chatVarList:l}}]:[],c,...y.data.ragVariables.length>0?[y]:[]].map(e=>{let t=[];return e.data.type===s.BlockEnum.DataSource&&(t=o.filter(r=>r.belong_to_node_id===e.id)),{...q(e,r,a,n,t.map(r=>({variable:`rag.${e.id}.${r.variable}`,type:R(r.type),description:r.label,isRagVariable:!0})),p),isStartNode:e.data.type===s.BlockEnum.Start}}).filter(e=>e.vars.length>0)},C=e=>{let{valueSelector:r,beforeNodesOutputVars:a}=e,t=r[0],i=k(r),l=B(r),o=i?a.find(e=>e.isStartNode):a.find(e=>e.nodeId===t);if(!o)return s.VarType.string;let n=s.VarType.string,p=o.vars;if(i||l)n=p.find(e=>e.variable===r.join("."))?.type;else for(let e=1;e<r.length;e++){let a=r[e],t=e===r.length-1;p=Array.isArray(p)?p.find(e=>e.variable===a):[],t?n=p?.type:(p?.type===s.VarType.object||p?.type===s.VarType.file)&&(p=p.children||[])}switch(n){case s.VarType.arrayString:return s.VarType.string;case s.VarType.arrayNumber:return s.VarType.number;case s.VarType.arrayBoolean:return s.VarType.boolean;case s.VarType.arrayObject:return s.VarType.object;case s.VarType.array:return s.VarType.arrayObject;case s.VarType.arrayFile:return s.VarType.file;default:return s.VarType.string}},P=e=>{let{valueSelector:r,beforeNodesOutputVars:a}=e,t=r[0],i=k(r),l=i?a.find(e=>e.isStartNode):a.find(e=>e.nodeId===t);if(!l)return s.VarType.string;let o=s.VarType.string,n=l.vars;switch(i?o=n.find(e=>e.variable===r.join("."))?.type:r.slice(1).forEach((e,a)=>{let t=a===r.length-2;n=n?.find(r=>r.variable===e),t?o=n?.type:(n?.type===s.VarType.object||n?.type===s.VarType.file)&&(n=n.children)}),o){case s.VarType.arrayString:return s.VarType.string;case s.VarType.arrayNumber:return s.VarType.number;case s.VarType.arrayObject:return s.VarType.object;case s.VarType.arrayBoolean:return s.VarType.boolean;case s.VarType.array:return s.VarType.any;case s.VarType.arrayFile:return s.VarType.file;default:return s.VarType.string}},N=e=>{let{parentNode:r,valueSelector:a,isIterationItem:t,isLoopItem:i,availableNodes:l,isChatMode:o,isConstant:n,environmentVariables:p=[],conversationVariables:c=[],ragVariables:y=[],allPluginInfoList:u,schemaTypeDefinitions:d,preferSchemaType:b}=e;if(n)return s.VarType.string;let m=I(l,o,void 0,p,c,y,u,d),T=r?.data.type===s.BlockEnum.Iteration;if(t)return C({valueSelector:a,beforeNodesOutputVars:m});if(T){if("item"===a[1])return C({valueSelector:r?.data?.iterator_selector||[],beforeNodesOutputVars:m});if("index"===a[1])return s.VarType.number}let f=r?.data.type===s.BlockEnum.Loop;if(i)return P({valueSelector:a,beforeNodesOutputVars:m});if(f){if("item"===a[1])return P({valueSelector:r?.data?.iterator_selector||[],beforeNodesOutputVars:m});if("index"===a[1])return s.VarType.number}let v=E(a),_=k(a)&&!v,V=j(a),h=B(a),g=O(a)&&"shared"===a[1],A=O(a)&&"shared"!==a[1],S=l.find(e=>e?.data.type===s.BlockEnum.Start),R=_?S?.id:v?"global":A?a[1]:a[0],w=m.find(e=>e.nodeId===R);if(!w)return s.VarType.string;let L=s.VarType.string,q=w.vars;if(_||V||h||g||v)return q.find(e=>e.variable===a.join("."))?.type;{let e=q.find(e=>A?e.variable===a.join("."):e.variable===a[1]);if(!e)return s.VarType.string;if(A)return e.type;if(e.children?.schema?.properties){if(2===a.length)return b&&e.schemaType?e.schemaType:s.VarType.object;let r=e.children.schema;return a.slice(2).forEach((e,t)=>{let i=t===a.length-3;r&&(r=r.properties[e],i&&(L=U(r?.type)))}),L}return a.slice(1).forEach((e,r)=>{let t=r===a.length-2;Array.isArray(q)&&(q=q?.find(r=>r.variable===e)),t?L=b&&q?.schemaType?q?.schemaType:q?.type:(q?.type===s.VarType.object||q?.type===s.VarType.file)&&(q=q.children)}),L}},x=e=>{if(!e)return[];let a=[];return e.forEach(e=>{f.VAR_REGEX.lastIndex=0,"string"==typeof e&&a.push(...e.match(f.VAR_REGEX)||[])}),(0,r.uniq)(a).map(e=>e.replaceAll("{{#","").replace("#}}","").split("."))},M=(e,r,a)=>e&&"string"==typeof e&&a&&0!==a.length?e.replaceAll(`{{#${r.join(".")}#}}`,`{{#${a.join(".")}#}}`):e,F=e=>{let{data:r}=e,{type:a}=r,t=[];switch(a){case s.BlockEnum.End:t=r.outputs?.map(e=>e.value_selector);break;case s.BlockEnum.Answer:t=x([r.answer]);break;case s.BlockEnum.LLM:{let e=r.model?.mode===v.AppModeEnum.CHAT,a=[];e?(a=r.prompt_template?.map(e=>e.text)||[],r.memory?.query_prompt_template&&a.push(r.memory.query_prompt_template)):a=[r.prompt_template.text],t=[...x(a),...r.context?.variable_selector?[r.context?.variable_selector]:[]];break}case s.BlockEnum.KnowledgeRetrieval:{let{query_variable_selector:e,query_attachment_selector:a=[]}=r;t=[e,a];break}case s.BlockEnum.IfElse:(t=[]).push(...(r.cases||[]).flatMap(e=>e.conditions||[]).flatMap(e=>{let r=[];return e.variable_selector&&r.push(e.variable_selector),e.sub_variable_condition&&e.sub_variable_condition.conditions&&r.push(...e.sub_variable_condition.conditions.map(e=>e.variable_selector||[]).filter(e=>e.length>0)),r}));break;case s.BlockEnum.Code:t=r.variables?.map(e=>e.value_selector);break;case s.BlockEnum.TemplateTransform:t=r.variables?.map(e=>e.value_selector);break;case s.BlockEnum.QuestionClassifier:{t=[r.query_variable_selector];let e=x([r.instruction||""]);t.push(...e);let a=r.classes.map(e=>e.name);t.push(...x(a));break}case s.BlockEnum.HttpRequest:t=x([r.url,r.headers,r.params,"string"==typeof r.body.data?r.body.data:r.body.data.map(e=>e.value).join("")]);break;case s.BlockEnum.Tool:t=[...x(Object.keys(r.tool_parameters)?.filter(e=>r.tool_parameters[e].type===g.VarType.mixed).map(e=>r.tool_parameters[e].value)),...Object.keys(r.tool_parameters).filter(e=>r.tool_parameters[e].type===g.VarType.variable).map(e=>r.tool_parameters[e].value)||[]];break;case s.BlockEnum.DataSource:t=[...x(Object.keys(r.datasource_parameters)?.filter(e=>r.datasource_parameters[e].type===g.VarType.mixed).map(e=>r.datasource_parameters[e].value)),...Object.keys(r.datasource_parameters).filter(e=>r.datasource_parameters[e].type===g.VarType.variable).map(e=>r.datasource_parameters[e].value)||[]];break;case s.BlockEnum.VariableAssigner:case s.BlockEnum.VariableAggregator:t=r?.variables;break;case s.BlockEnum.ParameterExtractor:{t=[r.query];let e=x([r.instruction||""]);t.push(...e);break}case s.BlockEnum.Iteration:t=[r.iterator_selector];break;case s.BlockEnum.Loop:t=r.break_conditions?.map(e=>e.variable_selector||[])||[];break;case s.BlockEnum.ListFilter:t=[r.variable];break;case s.BlockEnum.Agent:{let e=[];if(!r.agent_parameters)break;Object.keys(r.agent_parameters||{}).forEach(a=>{let{value:t}=r.agent_parameters[a];"string"==typeof t&&e.push(...x([t]))}),t=e}}return t||[]},$=(e,r,a)=>{if(!e.variable)return;a.push([...r,e.variable]);let t=!!e.children?.schema?.properties;e.children?.length>0&&e.children.forEach(t=>{$(t,[...r,e.variable],a)}),t&&Object.keys(e.children?.schema?.properties||{}).forEach(t=>{let i=e.children?.schema?.properties[t].type,l=i===c.Type.array,o=e.children?.schema?.properties[t].items?.type;$({variable:t,type:U(l?o:i,l)},[...r,e.variable],a)})},D=(e,r,a)=>{Array.isArray(e)&&e.forEach(e=>{$(e,r,a)}),$(e,r,a)};e.s(["findUsedVarNodes",0,(e,r)=>{let a=[];return r.forEach(r=>{F(r).find(r=>r.join(".")===e.join("."))&&a.push(r)}),a},"getNodeInfoById",0,(e,r)=>{if((0,a.isArray)(e))return e.find(e=>e.id===r)},"getNodeOutputVars",0,(e,r)=>{let{data:a,id:t}=e,{type:l}=a,o=[];switch(l){case s.BlockEnum.Start:{let{variables:e}=a;o=e.map(e=>[t,e.variable]),r&&(o.push([t,"sys","query"]),o.push([t,"sys","files"]));break}case s.BlockEnum.LLM:{let e=[...i.LLM_OUTPUT_STRUCT];a.structured_output_enabled&&a.structured_output?.schema?.properties&&Object.keys(a.structured_output.schema.properties).length>0&&e.push({variable:"structured_output",type:s.VarType.object,children:a.structured_output}),D(e,[t],o);break}case s.BlockEnum.KnowledgeRetrieval:D(i.KNOWLEDGE_RETRIEVAL_OUTPUT_STRUCT,[t],o);break;case s.BlockEnum.Code:{let{outputs:e}=a;Object.keys(e).forEach(e=>{o.push([t,e])});break}case s.BlockEnum.TemplateTransform:D(i.TEMPLATE_TRANSFORM_OUTPUT_STRUCT,[t],o);break;case s.BlockEnum.QuestionClassifier:D(i.QUESTION_CLASSIFIER_OUTPUT_STRUCT,[t],o);break;case s.BlockEnum.HttpRequest:D(i.HTTP_REQUEST_OUTPUT_STRUCT,[t],o);break;case s.BlockEnum.VariableAssigner:case s.BlockEnum.VariableAggregator:o.push([t,"output"]);break;case s.BlockEnum.Tool:D(i.TOOL_OUTPUT_STRUCT,[t],o);break;case s.BlockEnum.ParameterExtractor:{let{parameters:e}=a;e?.length>0&&e.forEach(e=>{o.push([t,e.name])});break}case s.BlockEnum.Iteration:case s.BlockEnum.Loop:o.push([t,"output"]);break;case s.BlockEnum.DocExtractor:o.push([t,"text"]);break;case s.BlockEnum.ListFilter:o.push([t,"result"]),o.push([t,"first_record"]),o.push([t,"last_record"])}return o},"getNodeUsedVarPassToServerKey",0,(e,r)=>{let{data:a}=e,{type:t}=a,i="";switch(t){case s.BlockEnum.LLM:i=[`#${r.join(".")}#`],a.context?.variable_selector.join(".")===r.join(".")&&i.push("#context#");break;case s.BlockEnum.KnowledgeRetrieval:i="query";break;case s.BlockEnum.IfElse:{let e=a=>{for(let t of a)for(let a of t.conditions||[]){if(a.variable_selector?.join(".")===r.join("."))return a;if(a.sub_variable_condition){let r=e([a.sub_variable_condition]);if(r)return r}}};e(a.cases||[])&&(i=`#${r.join(".")}#`);break}case s.BlockEnum.Code:{let e=a.variables?.find(e=>Array.isArray(e.value_selector)&&e.value_selector&&e.value_selector.join(".")===r.join("."));e&&(i=e.variable);break}case s.BlockEnum.TemplateTransform:{let e=a.variables?.find(e=>Array.isArray(e.value_selector)&&e.value_selector&&e.value_selector.join(".")===r.join("."));e&&(i=e.variable);break}case s.BlockEnum.QuestionClassifier:i="query";break;case s.BlockEnum.HttpRequest:case s.BlockEnum.Tool:case s.BlockEnum.VariableAssigner:case s.BlockEnum.VariableAggregator:i=`#${r.join(".")}#`;break;case s.BlockEnum.ParameterExtractor:i="query"}return i},"getNodeUsedVars",0,F,"getVarType",0,N,"inputVarTypeToVarType",0,R,"isConversationVar",0,B,"isENV",0,j,"isGlobalVar",0,E,"isRagVariableVar",0,O,"isSpecialVar",0,A,"isSystemVar",0,k,"removeFileVars",0,e=>e.map(e=>({...e,vars:e.vars.filter(e=>e.type!==s.VarType.file&&e.type!==s.VarType.arrayFile)})).filter(e=>e.vars.length>0),"toNodeAvailableVars",0,e=>{let{parentNode:r,t:a,beforeNodes:t,isChatMode:i,environmentVariables:l,conversationVariables:o,ragVariables:n,filterVar:p,allPluginInfoList:c,schemaTypeDefinitions:y}=e,u=I(t,i,p,l,o,n,c,y);if(r?.data.type===s.BlockEnum.Iteration){let e=N({parentNode:r,isIterationItem:!0,valueSelector:r?.data.iterator_selector||[],availableNodes:t,isChatMode:i,environmentVariables:l,conversationVariables:o,allPluginInfoList:c,schemaTypeDefinitions:y}),n=e===s.VarType.file?{children:h.map(e=>({variable:e,type:"size"===e?s.VarType.number:s.VarType.string}))}:{},p={nodeId:r?.id,title:a("nodes.iteration.currentIteration",{ns:"workflow"}),vars:[{variable:"item",type:e,...n},{variable:"index",type:s.VarType.number}]},d=u.findIndex(e=>e.nodeId===r?.id);d>-1&&u.splice(d,1),u.unshift(p)}return u},"toNodeOutputVars",0,I,"updateNodeVars",0,(e,r,a)=>(0,t.produce)(e,e=>{let{data:t}=e,{type:i}=t;switch(i){case s.BlockEnum.End:t.outputs&&(t.outputs=t.outputs.map(e=>(e.value_selector.join(".")===r.join(".")&&(e.value_selector=a),e)));break;case s.BlockEnum.Answer:t.variables&&(t.variables=t.variables.map(e=>(e.value_selector.join(".")===r.join(".")&&(e.value_selector=a),e)));break;case s.BlockEnum.LLM:t.model?.mode===v.AppModeEnum.CHAT?(t.prompt_template=t.prompt_template.map(e=>({...e,text:M(e.text,r,a)})),t.memory?.query_prompt_template&&(t.memory.query_prompt_template=M(t.memory.query_prompt_template,r,a))):t.prompt_template={...t.prompt_template,text:M(t.prompt_template.text,r,a)},t.context?.variable_selector?.join(".")===r.join(".")&&(t.context.variable_selector=a);break;case s.BlockEnum.KnowledgeRetrieval:t.query_variable_selector.join(".")===r.join(".")&&(t.query_variable_selector=a),t.query_attachment_selector?.join(".")===r.join(".")&&(t.query_attachment_selector=a);break;case s.BlockEnum.IfElse:t.cases&&(t.cases=t.cases.map(e=>(e.conditions&&(e.conditions=e.conditions.map(e=>(e.variable_selector?.join(".")===r.join(".")&&(e.variable_selector=a),e.sub_variable_condition&&e.sub_variable_condition.conditions&&(e.sub_variable_condition.conditions=e.sub_variable_condition.conditions.map(e=>(e.variable_selector?.join(".")===r.join(".")&&(e.variable_selector=a),e))),e))),e)));break;case s.BlockEnum.Code:t.variables&&(t.variables=t.variables.map(e=>(e.value_selector.join(".")===r.join(".")&&(e.value_selector=a),e)));break;case s.BlockEnum.TemplateTransform:t.variables&&(t.variables=t.variables.map(e=>(e.value_selector.join(".")===r.join(".")&&(e.value_selector=a),e)));break;case s.BlockEnum.QuestionClassifier:t.query_variable_selector.join(".")===r.join(".")&&(t.query_variable_selector=a),t.instruction=M(t.instruction,r,a);break;case s.BlockEnum.HttpRequest:t.url=M(t.url,r,a),t.headers=M(t.headers,r,a),t.params=M(t.params,r,a),"string"==typeof t.body.data?t.body.data=M(t.body.data,r,a):t.body.data=t.body.data.map(e=>({...e,value:M(e.value||"",r,a)}));break;case s.BlockEnum.Tool:Object.keys(t.tool_parameters)?.filter(e=>t.tool_parameters[e].type!==g.VarType.constant)&&Object.keys(t.tool_parameters).forEach(e=>{let i=t.tool_parameters[e],{type:l}=i;l===g.VarType.variable&&i.value.join(".")===r.join(".")&&(t.tool_parameters[e]={...i,value:a}),l===g.VarType.mixed&&(t.tool_parameters[e]={...i,value:M(t.tool_parameters[e].value,r,a)})});break;case s.BlockEnum.DataSource:Object.keys(t.datasource_parameters)?.filter(e=>t.datasource_parameters[e].type!==g.VarType.constant)&&Object.keys(t.datasource_parameters).forEach(e=>{let i=t.datasource_parameters[e],{type:l}=i;l===g.VarType.variable&&i.value.join(".")===r.join(".")&&(t.datasource_parameters[e]={...i,value:a}),l===g.VarType.mixed&&(t.datasource_parameters[e]={...i,value:M(t.datasource_parameters[e].value,r,a)})});break;case s.BlockEnum.VariableAssigner:t.variables&&(t.variables=t.variables.map(e=>(e.join(".")===r.join(".")&&(e=a),e)));break;case s.BlockEnum.VariableAggregator:t.variables&&(t.variables=t.variables.map(e=>(e.join(".")===r.join(".")&&(e=a),e)));break;case s.BlockEnum.ParameterExtractor:t.query.join(".")===r.join(".")&&(t.query=a),t.instruction=M(t.instruction,r,a);break;case s.BlockEnum.Iteration:t.iterator_selector.join(".")===r.join(".")&&(t.iterator_selector=a);break;case s.BlockEnum.Loop:t.break_conditions&&(t.break_conditions=t.break_conditions.map(e=>(e.variable_selector?.join(".")===r.join(".")&&(e.variable_selector=a),e)));break;case s.BlockEnum.ListFilter:t.variable.join(".")===r.join(".")&&(t.variable=a)}}),"varTypeToStructType",0,e=>({[s.VarType.string]:c.Type.string,[s.VarType.number]:c.Type.number,[s.VarType.boolean]:c.Type.boolean,[s.VarType.object]:c.Type.object,[s.VarType.array]:c.Type.array,[s.VarType.arrayString]:c.Type.array,[s.VarType.arrayNumber]:c.Type.array,[s.VarType.arrayObject]:c.Type.array,[s.VarType.arrayFile]:c.Type.array})[e]||c.Type.string],963855)}]);