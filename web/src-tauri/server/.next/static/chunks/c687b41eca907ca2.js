(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,853797,e=>{e.v({input:"style-module__lg-8DW__input"})},724605,465574,348042,e=>{"use strict";let t,a;var r,s,l,n,o,i,d,c,u,p,m,x=e.i(563199),h=e.i(295978),h=h,g=e.i(346563),f=e.i(105845),b=e.i(233697),y=e.i(268255),v=e.i(389358),w=e.i(876057),j=e.i(192447),k=e.i(925521),N=e.i(249420),C=e.i(154033),_=e.i(141696),T=e.i(935139),h=h,S=e.i(959752);e.i(845780);var E=e.i(368148),V=e.i(265522),I=e.i(604208),R=e.i(339512),M=e.i(837699),A=e.i(813672);e.i(152567);var O=e.i(408767),P=e.i(908432),L=e.i(189299);e.i(27905);var F=e.i(70735),F=F,B=e.i(421001),D=e.i(59375),$=e.i(225162);e.i(302047);var z=e.i(674245),H=e.i(735964),H=H,W=e.i(946468),W=W,q=e.i(10717),U=e.i(227746),U=U,K=e.i(981086),G=e.i(665127),J=e.i(120219),X=e.i(3340),Q=e.i(554499),Y=e.i(148280),Z=e.i(720315),ee=e.i(95131);e.i(491401);var et=e.i(585736),ea=e.i(959095);let er=y.memo(e=>{let{className:t}=e;return(0,x.jsx)("div",{className:(0,T.cn)(t,"h-[0.5px] bg-divider-subtle")})});var es=e.i(151094),el=e.i(396094),en=e.i(867019),eo=e.i(503607),ei=e.i(443014),ed=e.i(253807),ec=e.i(199288),eu=e.i(18800),ep=e.i(654537);let em=y.memo(e=>{let{nodeName:t,onHide:a,children:r}=e,{t:s}=(0,O.useTranslation)();return(0,x.jsx)("div",{className:"absolute inset-0 z-10 rounded-2xl bg-background-overlay-alt",children:(0,x.jsxs)("div",{className:"flex h-full flex-col rounded-2xl bg-components-panel-bg",children:[(0,x.jsxs)("div",{className:"flex h-8 shrink-0 items-center justify-between pl-4 pr-3 pt-3",children:[(0,x.jsxs)("div",{className:"truncate text-base font-semibold text-text-primary",children:[s("singleRun.testRun",{ns:"workflow"})," ",t]}),(0,x.jsx)("div",{className:"ml-2 shrink-0 cursor-pointer p-1",onClick:()=>{a()},children:(0,x.jsx)(M.RiCloseLine,{className:"h-4 w-4 text-text-tertiary "})})]}),r]})})});var ex=e.i(475390),eh=e.i(387852),eg=e.i(648404),ef=e.i(480600),eb=e.i(390622);let ey=e=>{let{nodeId:t,payload:a,onCancel:r}=e,{t:s}=(0,O.useTranslation)(),l=(0,ei.useDataSourceStore)(),{isPending:n,handleRunWithSyncDraft:o,datasourceType:i,datasourceNodeData:d,startRunBtnDisabled:c}=(e=>{let{nodeId:t,flowId:a,flowType:r,payload:s,setRunResult:l,isPaused:n,isRunAfterSingleRun:o,setIsRunAfterSingleRun:i,onSuccess:d,appendNodeInspectVars:c}=e,u=(0,j.useStoreApi)(),p=(0,ei.useDataSourceStore)(),m=(0,y.useRef)(n),{handleNodeDataUpdate:x}=(0,Q.useNodeDataUpdate)(),h=s.provider_type,{localFileList:g,onlineDocuments:f,websitePages:b,selectedFileIds:v}=(0,ei.useDataSourceStoreWithSelector)((0,P.useShallow)(e=>({localFileList:e.localFileList,onlineDocuments:e.onlineDocuments,websitePages:e.websitePages,selectedFileIds:e.selectedFileIds}))),w=(0,y.useMemo)(()=>!!s&&(h===ep.DatasourceType.localFile?!g.length||g.some(e=>!e.file.id):h===ep.DatasourceType.onlineDocument?!f.length:h===ep.DatasourceType.websiteCrawl?!b.length:h===ep.DatasourceType.onlineDrive&&!v.length),[s,h,g,f.length,v.length,b.length]);(0,y.useEffect)(()=>{m.current=n},[n]);let k=s._singleRunningStatus||eb.NodeRunningStatus.NotStart,N=(0,eh.useInvalidLastRun)(r,a,t),C=async e=>{if(m.current)return;if(!(!o||k===eb.NodeRunningStatus.Succeeded))return void l(e);let r=await (0,_.fetchNodeInspectVars)(ef.FlowType.ragPipeline,a,t),{getNodes:s}=u.getState();c(t,r,s()),e?.status===eb.NodeRunningStatus.Succeeded&&d()},{mutateAsync:T,isPending:S}=(0,ex.useDatasourceSingleRun)(),{handleSyncWorkflowDraft:E}=(0,I.useNodesSyncDraft)();return{isPending:S,handleRunWithSyncDraft:()=>{x({id:t,data:{...s,_singleRunningStatus:eb.NodeRunningStatus.Running}}),i(!0),E(!0,!0,{onSuccess(){(()=>{let e={},{currentCredentialId:r}=p.getState();if(h===ep.DatasourceType.localFile){let{localFileList:t}=p.getState(),{id:a,name:r,type:s,size:l,extension:n,mime_type:o}=t[0].file;e={related_id:a,name:r,type:s,size:l,extension:n,mime_type:o,url:"",transfer_method:eg.TransferMethod.local_file}}if(h===ep.DatasourceType.onlineDocument){let{onlineDocuments:t}=p.getState(),{workspace_id:a,...s}=t[0];e={workspace_id:a,page:s,credential_id:r}}if(h===ep.DatasourceType.websiteCrawl){let{websitePages:t}=p.getState();e={...t[0],credential_id:r}}if(h===ep.DatasourceType.onlineDrive){let{bucket:t,onlineDriveFileList:a,selectedFileIds:s}=p.getState(),l=a.find(e=>e.id===s[0]);e={bucket:t,id:l?.id,type:l?.type,credential_id:r}}let l=!1;T({pipeline_id:a,start_node_id:t,start_node_title:s.title,datasource_type:h,datasource_info:e},{onError:()=>{l=!0,N(),m.current||x({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Failed}})},onSettled:e=>{C(e),l||m.current||x({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Succeeded}})}})})()}})},datasourceType:h,datasourceNodeData:s,startRunBtnDisabled:w}})(e),{clearOnlineDocumentData:u}=(0,eu.useOnlineDocument)(),{clearWebsiteCrawlData:p}=(0,eu.useWebsiteCrawl)(),{clearOnlineDriveData:m}=(0,eu.useOnlineDrive)(),h=(0,y.useCallback)(()=>{i===ep.DatasourceType.onlineDocument?u():i===ep.DatasourceType.websiteCrawl?p():i===ep.DatasourceType.onlineDrive&&m()},[u,m,p,i]),g=(0,y.useCallback)(e=>{let{setCurrentCredentialId:t}=l.getState();h(),t(e)},[h,l]);return(0,x.jsx)(em,{nodeName:a.title,onHide:r,children:(0,x.jsxs)("div",{className:"flex flex-col gap-y-5 px-4 pt-4",children:[i===ep.DatasourceType.localFile&&(0,x.jsx)(el.default,{allowedExtensions:d.fileExtensions||[],supportBatchUpload:!1}),i===ep.DatasourceType.onlineDocument&&(0,x.jsx)(en.default,{nodeId:t,nodeData:d,isInPipeline:!0,onCredentialChange:g,supportBatchUpload:!1}),i===ep.DatasourceType.websiteCrawl&&(0,x.jsx)(ec.default,{nodeId:t,nodeData:d,isInPipeline:!0,onCredentialChange:g,supportBatchUpload:!1}),i===ep.DatasourceType.onlineDrive&&(0,x.jsx)(eo.default,{nodeId:t,nodeData:d,isInPipeline:!0,onCredentialChange:g,supportBatchUpload:!1}),(0,x.jsxs)("div",{className:"flex justify-end gap-x-2",children:[(0,x.jsx)(es.default,{onClick:r,children:s("operation.cancel",{ns:"common"})}),(0,x.jsx)(es.default,{onClick:o,variant:"primary",loading:n,disabled:n||c,children:s("singleRun.startRun",{ns:"workflow"})})]})]})})},ev=y.memo(e=>(0,x.jsx)(ed.default,{children:(0,x.jsx)(ey,{...e})}));var ew=e.i(472663),ej=e.i(267223),ek=e.i(443202);e.i(275225);var eN=e.i(705405);e.i(905691);var eC=e.i(911684),e_=e.i(52592),eT=e.i(296124),eS=e.i(819114),eE=e.i(842090),eV=e.i(194095),eI=e.i(223314),eR=e.i(137667),eM=e.i(766036),eA=e.i(285923);let eO=y.memo(e=>{let{className:t,label:a,inputs:r,values:s,onChange:l}=e,n=(0,y.useMemo)(()=>{let e=e=>{let t=r.find(t=>t.variable===e)?.value_selector;if(!t)return[e];let a=[];return r.forEach(e=>{e.value_selector?.join(".")===t.join(".")&&a.push(e.variable)}),a},t=new Map;for(let a of r)t.set(a.variable,e(a.variable));return t},[r]),o=(0,y.useRef)(s);(0,y.useEffect)(()=>{o.current=s},[s]);let i=(0,y.useCallback)(e=>{let t=n.get(e)??[e];return e=>{l((0,f.produce)(o.current,a=>{for(let r of t)a[r]=e}))}},[o,l,n]),d=[eb.InputVarType.contexts,eb.InputVarType.iterator].includes(r[0]?.type),c=r[0]?.type===eb.InputVarType.iterator&&r[0]?.isFileItem,u=r[0]?.type===eb.InputVarType.contexts,p=(0,y.useCallback)(()=>{l((0,f.produce)(s,e=>{let t=r[0].variable;e[t]||(e[t]=[]),e[t].push(u?S.RETRIEVAL_OUTPUT_STRUCT:"")}))},[s,l,r,u]);return(0,x.jsxs)("div",{className:(0,T.cn)(t,"space-y-2"),children:[a&&(0,x.jsxs)("div",{className:"mb-1 flex items-center justify-between",children:[(0,x.jsx)("div",{className:"system-xs-medium-uppercase flex h-6 items-center text-text-tertiary",children:a}),d&&!c&&(0,x.jsx)(eM.default,{onClick:p})]}),r.map((e,t)=>(0,x.jsx)(eA.default,{inStepRun:!0,payload:e,value:s[e.variable],onChange:i(e.variable)},t))]})}),eP=y.memo(e=>{let{nodeName:t,onHide:a,onRun:r,forms:s,filteredExistVarForms:l,existVarValuesInForms:n}=e,{t:o}=(0,O.useTranslation)(),i=(()=>{if(!s||0===s.length)return!0;let e=s.find(e=>!!e.values["#files#"]);if(!e)return!0;let t=e.values["#files#"];return!t?.some(e=>e.transfer_method===eg.TransferMethod.local_file&&!e.upload_file_id)})(),d=(0,y.useRef)(!1);return((0,y.useEffect)(()=>{d.current||(d.current=!0,0===l.length&&r({}))},[l,r]),0===l.length)?null:(0,x.jsx)(em,{nodeName:t,onHide:a,children:(0,x.jsxs)("div",{className:"h-0 grow overflow-y-auto pb-4",children:[(0,x.jsx)("div",{className:"mt-3 space-y-4 px-4",children:l.map((e,t)=>(0,x.jsxs)("div",{children:[(0,x.jsx)(eO,{className:(0,T.cn)(t<s.length-1&&"mb-4"),...e},t),t<s.length-1&&(0,x.jsx)(er,{})]},t))}),(0,x.jsx)("div",{className:"mt-4 flex justify-between space-x-2 px-4",children:(0,x.jsx)(es.default,{disabled:!i,variant:"primary",className:"w-0 grow space-x-2",onClick:()=>{let e="";if(s.forEach((t,a)=>{let r=n[a];t.inputs.forEach(a=>{let s=t.values[a.variable];(e||!a.required||a.type===eb.InputVarType.checkbox||a.variable in r||""!==s&&null!=s&&(a.type!==eb.InputVarType.files||0!==s.length)||(e=o("errorMsg.fieldRequired",{ns:"workflow",field:"object"==typeof a.label?a.label.variable:a.label})),!e&&(a.type===eb.InputVarType.singleFile||a.type===eb.InputVarType.multiFiles)&&s)&&(Array.isArray(s)?s.find(e=>e.transferMethod===eg.TransferMethod.local_file&&!e.uploadedId):s.transferMethod===eg.TransferMethod.local_file&&!s.uploadedId)&&(e=o("errorMessage.waitForFileUpload",{ns:"appDebug"}))})}),e)return void eR.default.notify({message:e,type:"error"});let t={},a="";(s.forEach(e=>{e.inputs.forEach(r=>{try{let a=function(e,t){if(t===eb.InputVarType.checkbox)return!!e;if(null==e)return e;if(t===eb.InputVarType.number)return Number.parseFloat(e);if(t===eb.InputVarType.json)return JSON.parse(e);if(t===eb.InputVarType.contexts)return e.map(e=>JSON.parse(e));if(t===eb.InputVarType.multiFiles)return(0,eI.getProcessedFiles)(e);if(t===eb.InputVarType.singleFile){if(Array.isArray(e))return(0,eI.getProcessedFiles)(e);if(!e)return;return(0,eI.getProcessedFiles)([e])[0]}return e}(e.values[r.variable],r.type);t[r.variable]=a}catch{a=r.variable}})}),a)?eR.default.notify({message:o("errorMsg.invalidJson",{ns:"workflow",field:a}),type:"error"}):r(t)},children:(0,x.jsx)("div",{children:o("singleRun.startRun",{ns:"workflow"})})})})]})})});var eL=e.i(888031),eF=e.i(291631),eB=e.i(481162),eD=e.i(955371);let e$=e=>{let{forms:t,onFormChange:a}=e,{t:r}=(0,O.useTranslation)(),s=(0,y.useCallback)(e=>{let{key:t,type:r}=e;return e=>{let s;(r===eb.VarType.string||r===eb.VarType.number)&&(s=e.target.value),(r===eb.VarType.array||r===eb.VarType.arrayNumber||r===eb.VarType.arrayString||r===eb.VarType.arrayObject||r===eb.VarType.arrayFile||r===eb.VarType.object)&&(s=e),a({key:t,type:r,value:s})}},[a]);return(0,x.jsxs)("div",{className:"px-4 pt-2",children:[(0,x.jsxs)("div",{className:"body-xs-regular mb-2 text-text-tertiary",children:[r("nodes.common.errorHandle.defaultValue.desc",{ns:"workflow"})," "]}),(0,x.jsx)("div",{className:"space-y-1",children:t.map((e,t)=>(0,x.jsxs)("div",{className:"py-1",children:[(0,x.jsxs)("div",{className:"mb-1 flex items-center",children:[(0,x.jsx)("div",{className:"system-sm-medium mr-1 text-text-primary",children:e.key}),(0,x.jsx)("div",{className:"system-xs-regular text-text-tertiary",children:e.type})]}),(e.type===eb.VarType.string||e.type===eb.VarType.number)&&(0,x.jsx)(eF.default,{type:e.type,value:e.value||(e.type===eb.VarType.string?"":0),onChange:s({key:e.key,type:e.type})}),(e.type===eb.VarType.array||e.type===eb.VarType.arrayNumber||e.type===eb.VarType.arrayString||e.type===eb.VarType.arrayObject||e.type===eb.VarType.object)&&(0,x.jsx)(eB.default,{language:eD.CodeLanguage.json,value:e.value,onChange:s({key:e.key,type:e.type})})]},t))})]})};var ez=e.i(391185),eH=e.i(381086);let eW=e=>{let{value:t,onSelected:a}=e,{t:r}=(0,O.useTranslation)(),[s,l]=(0,y.useState)(!1),n=[{value:eH.ErrorHandleTypeEnum.none,label:r("nodes.common.errorHandle.none.title",{ns:"workflow"}),description:r("nodes.common.errorHandle.none.desc",{ns:"workflow"})},{value:eH.ErrorHandleTypeEnum.defaultValue,label:r("nodes.common.errorHandle.defaultValue.title",{ns:"workflow"}),description:r("nodes.common.errorHandle.defaultValue.desc",{ns:"workflow"})},{value:eH.ErrorHandleTypeEnum.failBranch,label:r("nodes.common.errorHandle.failBranch.title",{ns:"workflow"}),description:r("nodes.common.errorHandle.failBranch.desc",{ns:"workflow"})}],o=n.find(e=>e.value===t);return(0,x.jsxs)(ez.PortalToFollowElem,{open:s,onOpenChange:l,placement:"bottom-end",offset:4,children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:e=>{e.stopPropagation(),e.nativeEvent.stopImmediatePropagation(),l(e=>!e)},children:(0,x.jsxs)(es.default,{size:"small",children:[o?.label,(0,x.jsx)(M.RiArrowDownSLine,{className:"h-3.5 w-3.5"})]})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[11]",children:(0,x.jsx)("div",{className:"w-[280px] rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur p-1 shadow-lg",children:n.map(e=>(0,x.jsxs)("div",{className:"flex cursor-pointer rounded-lg p-2 pr-3 hover:bg-state-base-hover",onClick:t=>{t.stopPropagation(),t.nativeEvent.stopImmediatePropagation(),a(e.value),l(!1)},children:[(0,x.jsx)("div",{className:"mr-1 w-4 shrink-0",children:t===e.value&&(0,x.jsx)(M.RiCheckLine,{className:"h-4 w-4 text-text-accent"})}),(0,x.jsxs)("div",{className:"grow",children:[(0,x.jsx)("div",{className:"system-sm-semibold mb-0.5 text-text-secondary",children:e.label}),(0,x.jsx)("div",{className:"system-xs-regular text-text-tertiary",children:e.description})]})]},e.value))})})]})};var eq=e.i(683257);let eU=()=>{let{t:e}=(0,O.useTranslation)(),t=(0,eq.useDocLink)();return(0,x.jsx)("div",{className:"px-4 pt-2",children:(0,x.jsxs)("div",{className:"rounded-[10px] bg-workflow-process-bg p-4",children:[(0,x.jsx)("div",{className:"mb-2 flex h-8 w-8 items-center justify-center rounded-[10px] border-[0.5px] border-components-card-border bg-components-card-bg shadow-lg",children:(0,x.jsx)(M.RiMindMap,{className:"h-5 w-5 text-text-tertiary"})}),(0,x.jsx)("div",{className:"system-sm-medium mb-1 text-text-secondary",children:e("nodes.common.errorHandle.failBranch.customize",{ns:"workflow"})}),(0,x.jsxs)("div",{className:"system-xs-regular text-text-tertiary",children:[e("nodes.common.errorHandle.failBranch.customizeTip",{ns:"workflow"})," ",(0,x.jsx)("a",{href:t("/use-dify/debug/error-type"),target:"_blank",className:"text-text-accent",children:e("common.learnMore",{ns:"workflow"})})]})]})})};var eK=e.i(735738);let eG=e=>e===eb.VarType.string?"":e===eb.VarType.number?0:e===eb.VarType.object?"{}":e===eb.VarType.arrayObject||e===eb.VarType.arrayString||e===eb.VarType.arrayNumber||e===eb.VarType.arrayFile?"[]":"",eJ=e=>{let{type:t}=e;if(t===eb.BlockEnum.LLM)return[{key:"text",type:eb.VarType.string,value:eG(eb.VarType.string)}];if(t===eb.BlockEnum.HttpRequest)return[{key:"body",type:eb.VarType.string,value:eG(eb.VarType.string)},{key:"status_code",type:eb.VarType.number,value:eG(eb.VarType.number)},{key:"headers",type:eb.VarType.object,value:eG(eb.VarType.object)}];if(t===eb.BlockEnum.Tool)return[{key:"text",type:eb.VarType.string,value:eG(eb.VarType.string)},{key:"json",type:eb.VarType.arrayObject,value:eG(eb.VarType.arrayObject)}];if(t===eb.BlockEnum.Code){let{outputs:t}=e;return Object.keys(t).map(e=>({key:e,type:t[e].type,value:eG(t[e].type)}))}return[]},eX=e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{error_strategy:s,default_value:l}=a,{collapsed:n,setCollapsed:o,handleErrorHandleTypeChange:i}=((e,t)=>{let a=(0,y.useMemo)(()=>t.error_strategy===eH.ErrorHandleTypeEnum.none,[t.error_strategy]),[r,s]=(0,y.useState)(a),{handleNodeDataUpdateWithSyncDraft:l}=(0,Q.useNodeDataUpdate)(),{handleEdgeDeleteByDeleteBranch:n}=(0,eK.useEdgesInteractions)(),o=(0,y.useCallback)((t,a)=>{a.error_strategy!==t&&(t===eH.ErrorHandleTypeEnum.none&&(l({id:e,data:{error_strategy:void 0,default_value:void 0}}),s(!0),n(e,eH.ErrorHandleTypeEnum.failBranch)),t===eH.ErrorHandleTypeEnum.failBranch&&(l({id:e,data:{error_strategy:t,default_value:void 0}}),s(!1)),t===eH.ErrorHandleTypeEnum.defaultValue&&(l({id:e,data:{error_strategy:t,default_value:eJ(a)}}),s(!1),n(e,eH.ErrorHandleTypeEnum.failBranch)))},[e,l,n]);return{collapsed:r,setCollapsed:s,handleErrorHandleTypeChange:o}})(t,a),{handleFormChange:d}=(e=>{let{handleNodeDataUpdateWithSyncDraft:t}=(0,Q.useNodeDataUpdate)();return{handleFormChange:(0,y.useCallback)((a,r)=>{let{key:s,value:l,type:n}=a,o=r.default_value||[],i=o.findIndex(e=>e.key===s);if(i>-1){let a=[...o];a[i].value=l,t({id:e,data:{default_value:a}});return}t({id:e,data:{default_value:[...o,{key:s,value:l,type:n}]}})},[t,e])}})(t),c=(0,y.useCallback)(e=>t=>{i(t,e)},[i]),u=(0,y.useCallback)(e=>t=>{d(t,e)},[d]);return(0,x.jsx)(x.Fragment,{children:(0,x.jsx)("div",{className:"py-4",children:(0,x.jsx)(eL.default,{disabled:!s,collapsed:n,onCollapse:o,hideCollapseIcon:!0,trigger:e=>(0,x.jsxs)("div",{className:"flex grow items-center justify-between pr-4",children:[(0,x.jsxs)("div",{className:"flex items-center",children:[(0,x.jsx)("div",{className:"system-sm-semibold-uppercase mr-0.5 text-text-secondary",children:r("nodes.common.errorHandle.title",{ns:"workflow"})}),(0,x.jsx)(B.default,{popupContent:r("nodes.common.errorHandle.tip",{ns:"workflow"})}),e]}),(0,x.jsx)(eW,{value:s||eH.ErrorHandleTypeEnum.none,onSelected:c(a)})]}),children:(0,x.jsxs)(x.Fragment,{children:[s===eH.ErrorHandleTypeEnum.failBranch&&!n&&(0,x.jsx)(eU,{}),s===eH.ErrorHandleTypeEnum.defaultValue&&!n&&!!l?.length&&(0,x.jsx)(e$,{forms:l,onFormChange:u(a)})]})})})})},eQ=e=>{let t=(0,Y.useNodesMetaData)();return(0,y.useMemo)(()=>t?.nodesMap?.[e]?.metaData.helpLinkUri||"",[t,e])},eY=(0,y.memo)(e=>{let{nodeType:t}=e,{t:a}=(0,O.useTranslation)(),r=eQ(t);return r?(0,x.jsx)(B.default,{popupContent:a("userProfile.helpCenter",{ns:"common"}),children:(0,x.jsx)("a",{href:r,target:"_blank",className:"mr-1 flex h-6 w-6 items-center justify-center rounded-md hover:bg-state-base-hover",children:(0,x.jsx)(M.RiBookOpenLine,{className:"h-4 w-4 text-gray-500"})})}):null});var eZ=e.i(792021);let e0=(0,y.memo)(e=>{let{nodeId:t,nodeData:a,sourceHandle:r,isParallel:s,isFailBranch:l}=e,{t:n}=(0,O.useTranslation)(),[o,i]=(0,y.useState)(!1),{handleNodeAdd:d}=(0,V.useNodesInteractions)(),{nodesReadOnly:c}=(0,Z.useNodesReadOnly)(),{availableNextBlocks:u}=(0,X.useAvailableBlocks)(a.type,a.isInIteration||a.isInLoop),p=(0,y.useCallback)((e,a)=>{d({nodeType:e,pluginDefaultValue:a},{prevNodeId:t,prevNodeSourceHandle:r})},[d]),m=(0,y.useCallback)(e=>{i(e)},[]),h=(0,y.useMemo)(()=>l?n("common.addFailureBranch",{ns:"workflow"}):s?n("common.addParallelNode",{ns:"workflow"}):n("panel.selectNextStep",{ns:"workflow"}),[l,s,n]),g=(0,y.useCallback)(e=>(0,x.jsxs)("div",{className:`
          bg-dropzone-bg hover:bg-dropzone-bg-hover relative flex h-9 cursor-pointer items-center rounded-lg border border-dashed
          border-divider-regular px-2 text-xs text-text-placeholder
          ${e&&"!bg-components-dropzone-bg-alt"}
          ${c&&"!cursor-not-allowed"}
        `,children:[(0,x.jsx)("div",{className:"mr-1.5 flex h-5 w-5 items-center justify-center rounded-[5px] bg-background-default-dimmed",children:(0,x.jsx)(M.RiAddLine,{className:"h-3 w-3"})}),(0,x.jsx)("div",{className:"flex items-center uppercase",children:h})]}),[c,h]);return(0,x.jsx)(eZ.default,{open:o,onOpenChange:m,disabled:c,onSelect:p,placement:"top",offset:0,trigger:g,popupClassName:"!w-[328px]",availableBlocksTypes:u})});function e1(e,t){let a=new Set(t);return e.filter(e=>a.has(e))}let e2=e=>{let{data:t,nodeId:a,sourceHandle:r}=e,{t:s}=(0,O.useTranslation)(),{handleNodeChange:l}=(0,V.useNodesInteractions)(),{availablePrevBlocks:n,availableNextBlocks:o}=(0,X.useAvailableBlocks)(t.type,t.isInIteration||t.isInLoop),i=(0,y.useCallback)((e,t)=>{l(a,e,r,t)},[a,r,l]),d=(0,y.useCallback)(()=>(0,x.jsx)("div",{className:"flex h-8 cursor-pointer items-center rounded-lg px-2 hover:bg-state-base-hover",children:s("panel.change",{ns:"workflow"})}),[s]);return(0,x.jsx)(eZ.default,{onSelect:i,placement:"top-end",offset:{mainAxis:6,crossAxis:8},trigger:d,popupClassName:"!w-[328px]",availableBlocksTypes:e1(n,o).filter(e=>e!==t.type)})},e5=e=>{let{open:t,onOpenChange:a,data:r,nodeId:s,sourceHandle:l}=e,{t:n}=(0,O.useTranslation)(),{handleNodeDelete:o,handleNodeDisconnect:i}=(0,V.useNodesInteractions)();return(0,x.jsxs)(ez.PortalToFollowElem,{placement:"bottom-end",offset:{mainAxis:4,crossAxis:-4},open:t,onOpenChange:a,children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>a(!t),children:(0,x.jsx)(es.default,{className:"h-6 w-6 p-0",children:(0,x.jsx)(M.RiMoreFill,{className:"h-4 w-4"})})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-10",children:(0,x.jsxs)("div",{className:"system-md-regular min-w-[120px] rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur text-text-secondary shadow-lg",children:[(0,x.jsxs)("div",{className:"p-1",children:[(0,x.jsx)(e2,{data:r,nodeId:s,sourceHandle:l}),(0,x.jsx)("div",{className:"flex h-8 cursor-pointer items-center rounded-lg px-2 hover:bg-state-base-hover",onClick:()=>i(s),children:n("common.disconnect",{ns:"workflow"})})]}),(0,x.jsx)("div",{className:"p-1",children:(0,x.jsx)("div",{className:"flex h-8 cursor-pointer items-center rounded-lg px-2 hover:bg-state-base-hover",onClick:()=>o(s),children:n("operation.delete",{ns:"common"})})})]})})]})},e3=(0,y.memo)(e=>{let{nodeId:t,sourceHandle:a,data:r}=e,{t:s}=(0,O.useTranslation)(),[l,n]=(0,y.useState)(!1),{nodesReadOnly:o}=(0,Z.useNodesReadOnly)(),{handleNodeSelect:i}=(0,V.useNodesInteractions)(),d=(0,ee.useToolIcon)(r),c=(0,y.useCallback)(e=>{n(e)},[]);return(0,x.jsxs)("div",{className:"group relative flex h-9 cursor-pointer items-center rounded-lg border-[0.5px] border-divider-regular bg-background-default px-2 text-xs text-text-secondary shadow-xs last-of-type:mb-0 hover:bg-background-default-hover",children:[(0,x.jsx)(J.default,{type:r.type,toolIcon:d,className:"mr-1.5 shrink-0"}),(0,x.jsx)("div",{className:"system-xs-medium grow truncate text-text-secondary",title:r.title,children:r.title}),!o&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(es.default,{className:"mr-1 hidden shrink-0 group-hover:flex",size:"small",onClick:()=>i(t),children:s("common.jumpToNode",{ns:"workflow"})}),(0,x.jsx)("div",{className:(0,T.cn)("hidden shrink-0 items-center group-hover:flex",l&&"flex"),children:(0,x.jsx)(e5,{data:r,nodeId:t,sourceHandle:a,open:l,onOpenChange:c})})]})]})}),e4=e=>{let{nodeId:t,nodeData:a,sourceHandle:r,nextNodes:s,branchName:l,isFailBranch:n}=e;return(0,x.jsxs)("div",{className:(0,T.cn)("space-y-0.5 rounded-[10px] bg-background-section-burn p-0.5",n&&"border-[0.5px] border-state-warning-hover-alt bg-state-warning-hover"),children:[l&&(0,x.jsx)("div",{className:(0,T.cn)("system-2xs-semibold-uppercase flex items-center truncate px-2 text-text-tertiary",n&&"text-text-warning"),title:l,children:l}),s.map(e=>(0,x.jsx)(e3,{nodeId:e.id,data:e.data,sourceHandle:"source"},e.id)),(0,x.jsx)(e0,{isParallel:!!s.length,isFailBranch:n,nodeId:t,nodeData:a,sourceHandle:r})]})},e6=(0,y.memo)(e=>{let{list:t}=e,a=t.map(e=>36*e+(e-1)*2+12+6),r=a.map((e,t)=>0===t?e:a.slice(0,t).reduce((e,t)=>e+t,0)+e),s=r.length,l=r[s-1]+(s-1)*8;return(0,x.jsx)("svg",{className:"w-6 shrink-0",style:{height:l},children:r.map((e,t)=>{let a=(t>0?r[t-1]:0)+8*t+16;return(0,x.jsxs)("g",{children:[0===t&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("path",{d:"M0,18 L24,18",strokeWidth:1,fill:"none",className:"stroke-divider-solid"}),(0,x.jsx)("rect",{x:0,y:16,width:1,height:4,className:"fill-divider-solid-alt"})]}),t>0&&(0,x.jsx)("path",{d:`M0,18 Q12,18 12,28 L12,${a-10+2} Q12,${a+2} 24,${a+2}`,strokeWidth:1,fill:"none",className:"stroke-divider-solid"}),(0,x.jsx)("rect",{x:23,y:a,width:1,height:4,className:"fill-divider-solid-alt"})]},t)})})}),e8=(0,y.memo)(e=>{let{selectedNode:t}=e,{t:a}=(0,O.useTranslation)(),r=t.data,s=(0,ee.useToolIcon)(r),l=(0,y.useMemo)(()=>r._targetBranches||[],[r]),n=(0,j.useStore)(e=>e.edges.map(e=>({id:e.id,source:e.source,sourceHandle:e.sourceHandle,target:e.target,targetHandle:e.targetHandle})),g.isEqual),o=(0,j.useStore)(e=>e.getNodes().map(e=>({id:e.id,data:e.data})),g.isEqual),i=(0,j.getOutgoers)(t,o,n),d=(0,j.getConnectedEdges)([t],n).filter(e=>e.source===t.id),c=(0,y.useMemo)(()=>{let e=e=>e.reduce((e,t)=>{let a=i.find(e=>e.id===t.target);return a&&e.push(a),e},[]),t=[];if(l?.length)t=l.map((t,s)=>{let l=e(d.filter(e=>e.sourceHandle===t.id));return{branch:{...t,name:r.type===eb.BlockEnum.QuestionClassifier?`${a("nodes.questionClassifiers.class",{ns:"workflow"})} ${s+1}`:t.name},nextNodes:l}});else if(t=[{branch:{id:"",name:""},nextNodes:e(d.filter(e=>"source"===e.sourceHandle))}],r.error_strategy===eH.ErrorHandleTypeEnum.failBranch&&(0,eC.hasErrorHandleNode)(r.type)){let r=e(d.filter(e=>e.sourceHandle===eH.ErrorHandleTypeEnum.failBranch));t.push({branch:{id:eH.ErrorHandleTypeEnum.failBranch,name:a("common.onFailure",{ns:"workflow"})},nextNodes:r})}return t},[l,d,r.error_strategy,r.type,i,a]);return(0,x.jsxs)("div",{className:"flex py-1",children:[(0,x.jsx)("div",{className:"relative flex h-9 w-9 shrink-0 items-center justify-center rounded-lg border-[0.5px] border-divider-regular bg-background-default shadow-xs",children:(0,x.jsx)(J.default,{type:t.data.type,toolIcon:s})}),(0,x.jsx)(e6,{list:c.length?c.map(e=>e.nextNodes.length+1):[1]}),(0,x.jsx)("div",{className:"grow space-y-2",children:c.map((e,a)=>(0,x.jsx)(e4,{nodeId:t.id,nodeData:t.data,sourceHandle:e.branch.id,nextNodes:e.nextNodes,branchName:e.branch.name,isFailBranch:e.branch.id===eH.ErrorHandleTypeEnum.failBranch},a))})]})});var e9=e.i(946700),e7=e.i(194902);let te=(0,y.memo)(e=>{let{nodeId:t,nodeData:a,sourceHandle:r}=e,{t:s}=(0,O.useTranslation)(),{handleNodeChange:l}=(0,V.useNodesInteractions)(),{availablePrevBlocks:n,availableNextBlocks:o}=(0,X.useAvailableBlocks)(a.type,a.isInIteration||a.isInLoop),i=(0,Z.useIsChatMode)(),d=(0,et.useHooksStore)(e=>e.configsMap?.flowType)!==ef.FlowType.ragPipeline&&!i,c=(0,y.useMemo)(()=>{if((0,eb.isTriggerNode)(a.type))return[t]},[a.type,t]),u=(0,y.useMemo)(()=>n.length&&o.length?e1(n,o):n.length?n:o,[n,o]),p=(0,y.useCallback)((e,a)=>{l(t,e,r,a)},[l,t,r]),m=(0,y.useCallback)(()=>(0,x.jsx)("div",{className:"flex h-8 w-[232px] cursor-pointer items-center rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",children:s("panel.changeBlock",{ns:"workflow"})}),[s]);return(0,x.jsx)(eZ.default,{placement:"bottom-end",offset:{mainAxis:-36,crossAxis:4},onSelect:p,trigger:m,popupClassName:"min-w-[240px]",availableBlocksTypes:u,showStartTab:d,ignoreNodeIds:c,forceEnableStartTab:a.type===eb.BlockEnum.Start})}),tt=(0,y.memo)(e=>{let{id:t,data:a,onClosePopup:r,showHelpLink:s}=e,{t:l}=(0,O.useTranslation)(),n=(0,j.useEdges)(),{handleNodeDelete:o,handleNodesDuplicate:i,handleNodeSelect:d,handleNodesCopy:c}=(0,V.useNodesInteractions)(),{handleNodeDataUpdate:u}=(0,Q.useNodeDataUpdate)(),{handleSyncWorkflowDraft:p}=(0,I.useNodesSyncDraft)(),{nodesReadOnly:m}=(0,Z.useNodesReadOnly)(),h=n.find(e=>e.target===t),g=(0,Y.useNodeMetaData)({id:t,data:a}),f=!g.isTypeFixed&&!m,b=!!(a.isInIteration||a.isInLoop),{data:v}=(0,C.useAllWorkflowTools)(),w=a.type===eb.BlockEnum.Tool&&a.provider_type===e9.CollectionType.workflow,k=(0,y.useMemo)(()=>{if(!w||!v||!a.provider_id)return;let e=v.find(e=>(0,eE.canFindTool)(e.id,a.provider_id));return e?.workflow_app_id},[w,v,a.provider_id]);return(0,x.jsxs)("div",{className:"w-[240px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-xl",children:[(f||(0,eC.canRunBySingle)(a.type,b))&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)("div",{className:"p-1",children:[(0,eC.canRunBySingle)(a.type,b)&&(0,x.jsx)("div",{className:`
                      flex h-8 cursor-pointer items-center rounded-lg px-3 text-sm text-text-secondary
                      hover:bg-state-base-hover
                    `,onClick:()=>{d(t),u({id:t,data:{_isSingleRun:!0}}),p(!0),r()},children:l("panel.runThisStep",{ns:"workflow"})}),f&&(0,x.jsx)(te,{nodeId:t,nodeData:a,sourceHandle:h?.sourceHandle||"source"})]}),(0,x.jsx)("div",{className:"h-px bg-divider-regular"})]}),!m&&(0,x.jsxs)(x.Fragment,{children:[!g.isSingleton&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)("div",{className:"p-1",children:[(0,x.jsxs)("div",{className:"flex h-8 cursor-pointer items-center justify-between rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>{r(),c(t)},children:[l("common.copy",{ns:"workflow"}),(0,x.jsx)(e7.default,{keys:["ctrl","c"]})]}),(0,x.jsxs)("div",{className:"flex h-8 cursor-pointer items-center justify-between rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>{r(),i(t)},children:[l("common.duplicate",{ns:"workflow"}),(0,x.jsx)(e7.default,{keys:["ctrl","d"]})]})]}),(0,x.jsx)("div",{className:"h-px bg-divider-regular"})]}),!g.isUndeletable&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"p-1",children:(0,x.jsxs)("div",{className:`
                      flex h-8 cursor-pointer items-center justify-between rounded-lg px-3 text-sm text-text-secondary
                      hover:bg-state-destructive-hover hover:text-text-destructive
                      `,onClick:()=>o(t),children:[l("operation.delete",{ns:"common"}),(0,x.jsx)(e7.default,{keys:["del"]})]})}),(0,x.jsx)("div",{className:"h-px bg-divider-regular"})]})]}),w&&k&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"p-1",children:(0,x.jsx)("a",{href:`/app/${k}/workflow`,target:"_blank",className:"flex h-8 cursor-pointer items-center rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",children:l("panel.openWorkflow",{ns:"workflow"})})}),(0,x.jsx)("div",{className:"h-px bg-divider-regular"})]}),s&&g.helpLinkUri&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"p-1",children:(0,x.jsx)("a",{href:g.helpLinkUri,target:"_blank",className:"flex h-8 cursor-pointer items-center rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",children:l("panel.helpLink",{ns:"workflow"})})}),(0,x.jsx)("div",{className:"h-px bg-divider-regular"})]}),(0,x.jsx)("div",{className:"p-1",children:(0,x.jsxs)("div",{className:"px-3 py-2 text-xs text-text-tertiary",children:[(0,x.jsx)("div",{className:"mb-1 flex h-[22px] items-center font-medium",children:l("panel.about",{ns:"workflow"}).toLocaleUpperCase()}),(0,x.jsx)("div",{className:"mb-1 leading-[18px] text-text-secondary",children:g.description}),(0,x.jsxs)("div",{className:"leading-[18px]",children:[l("panel.createdBy",{ns:"workflow"})," ",g.author]})]})})]})}),ta=(0,y.memo)(e=>{let{id:t,data:a,triggerClassName:r,offset:s={mainAxis:4,crossAxis:53},onOpenChange:l,showHelpLink:n=!0}=e,[o,i]=(0,y.useState)(!1),d=(0,y.useCallback)(e=>{i(e),l&&l(e)},[l]);return(0,x.jsxs)(ez.PortalToFollowElem,{placement:"bottom-end",offset:s,open:o,onOpenChange:d,children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>d(!o),children:(0,x.jsx)("div",{className:`
            flex h-6 w-6 cursor-pointer items-center justify-center rounded-md
            hover:bg-state-base-hover
            ${o&&"bg-state-base-hover"}
            ${r}
          `,children:(0,x.jsx)(M.RiMoreFill,{className:"h-4 w-4 text-text-tertiary"})})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[11]",children:(0,x.jsx)(tt,{id:t,data:a,onClosePopup:()=>i(!1),showHelpLink:n})})]})});var tr=e.i(170866),ts=e.i(260484),tl=e.i(853797);let tn=e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{handleRetryConfigChange:s}=(e=>{let{handleNodeDataUpdateWithSyncDraft:t}=(0,Q.useNodeDataUpdate)();return{handleRetryConfigChange:(0,y.useCallback)(a=>{t({id:e,data:{retry_config:a}})},[e,t])}})(t),{retry_config:l}=a,n=e=>{e>10?e=10:e<1&&(e=1),s({retry_enabled:!0,max_retries:e,retry_interval:l?.retry_interval||1e3})},o=e=>{e>5e3?e=5e3:e<100&&(e=100),s({retry_enabled:!0,max_retries:l?.max_retries||3,retry_interval:e})};return(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)("div",{className:"pt-2",children:[(0,x.jsxs)("div",{className:"flex h-10 items-center justify-between px-4 py-2",children:[(0,x.jsx)("div",{className:"flex items-center",children:(0,x.jsx)("div",{className:"system-sm-semibold-uppercase mr-0.5 text-text-secondary",children:r("nodes.common.retry.retryOnFailure",{ns:"workflow"})})}),(0,x.jsx)(ts.default,{defaultValue:l?.retry_enabled,onChange:e=>{s({retry_enabled:e,max_retries:l?.max_retries||3,retry_interval:l?.retry_interval||1e3})}})]}),l?.retry_enabled&&(0,x.jsxs)("div",{className:"px-4 pb-2",children:[(0,x.jsxs)("div",{className:"mb-1 flex w-full items-center",children:[(0,x.jsx)("div",{className:"system-xs-medium-uppercase mr-2 grow text-text-secondary",children:r("nodes.common.retry.maxRetries",{ns:"workflow"})}),(0,x.jsx)(tr.default,{className:"mr-3 w-[108px]",value:l?.max_retries||3,onChange:n,min:1,max:10}),(0,x.jsx)(eF.default,{type:"number",wrapperClassName:"w-[100px]",value:l?.max_retries||3,onChange:e=>n(Number.parseInt(e.currentTarget.value,10)||3),min:1,max:10,unit:r("nodes.common.retry.times",{ns:"workflow"})||"",className:tl.default.input})]}),(0,x.jsxs)("div",{className:"flex items-center",children:[(0,x.jsx)("div",{className:"system-xs-medium-uppercase mr-2 grow text-text-secondary",children:r("nodes.common.retry.retryInterval",{ns:"workflow"})}),(0,x.jsx)(tr.default,{className:"mr-3 w-[108px]",value:l?.retry_interval||1e3,onChange:o,min:100,max:5e3}),(0,x.jsx)(eF.default,{type:"number",wrapperClassName:"w-[100px]",value:l?.retry_interval||1e3,onChange:e=>o(Number.parseInt(e.currentTarget.value,10)||1e3),min:100,max:5e3,unit:r("nodes.common.retry.ms",{ns:"workflow"})||"",className:tl.default.input})]})]})]}),(0,x.jsx)(er,{className:"mx-4 mt-2"})]})};var to=e.i(765673);let ti=(0,y.memo)(e=>{let{value:t,onBlur:a}=e,{t:r}=(0,O.useTranslation)(),[s,l]=(0,y.useState)(t);return(0,x.jsx)("input",{value:s,onChange:e=>l(e.target.value),className:`
        system-xl-semibold mr-2 h-7 min-w-0 grow appearance-none rounded-md border border-transparent bg-transparent px-1 text-text-primary
        outline-none focus:shadow-xs
      `,placeholder:r("common.addTitle",{ns:"workflow"})||"",onBlur:()=>{if(!s){l(t),a(t);return}a(s)}})});ti.displayName="TitleInput";let td=(0,y.memo)(e=>{let{value:t,onChange:a}=e,{t:r}=(0,O.useTranslation)(),[s,l]=(0,y.useState)(!1),n=(0,y.useCallback)(()=>{l(!0)},[]),o=(0,y.useCallback)(()=>{l(!1)},[]);return(0,x.jsx)("div",{className:`
        leading-0 group flex max-h-[60px] overflow-y-auto rounded-lg bg-components-panel-bg
        px-2 py-[5px]
        ${s&&"!shadow-xs"}
      `,children:(0,x.jsx)(to.default,{value:t,onChange:e=>a(e.target.value),minRows:1,onFocus:n,onBlur:o,className:`
          w-full resize-none appearance-none bg-transparent text-xs
          leading-[18px] text-text-primary caret-[#295EFF]
          outline-none placeholder:text-text-quaternary
        `,placeholder:r("common.addDescription",{ns:"workflow"})||""})})});td.displayName="DescriptionInput";var tc=e.i(739780);e.i(711786);var tu=e.i(414696);let tp=y.memo(e=>{let{canSingleRun:t,onSingleRun:a}=e,{t:r}=(0,O.useTranslation)();return(0,x.jsxs)("div",{className:"flex h-0 grow flex-col items-center justify-center",children:[(0,x.jsx)(tu.ClockPlay,{className:"h-8 w-8 text-text-quaternary"}),(0,x.jsx)("div",{className:"system-xs-regular my-2 text-text-tertiary",children:r("debug.noData.description",{ns:"workflow"})}),t&&(0,x.jsxs)(es.default,{className:"flex",size:"small",onClick:a,children:[(0,x.jsx)(M.RiPlayLine,{className:"mr-1 h-3.5 w-3.5"}),(0,x.jsx)("div",{children:r("debug.noData.runThisNode",{ns:"workflow"})})]})]})}),tm=y.memo(e=>{let{appId:t,nodeId:a,canSingleRun:r,isRunAfterSingleRun:s,updateNodeRunningStatus:l,nodeInfo:n,runningStatus:o,onSingleRunClicked:i,singleRunResult:d,isPaused:c,...u}=e,p=(0,et.useHooksStore)(e=>e.configsMap),m=o===eb.NodeRunningStatus.Succeeded,h=o===eb.NodeRunningStatus.Failed,[g,f]=y.useState(null),[b,v]=(0,y.useState)(!1),[w,j]=(0,y.useState)(!1),k=[eb.NodeRunningStatus.Succeeded,eb.NodeRunningStatus.Failed].includes(g),N=!s||m||h||b&&k,{data:C,isFetching:_,error:T}=(0,eh.useLastRun)(p?.flowType||ef.FlowType.appFlow,p?.flowId||"",a,N),S=(0,y.useMemo)(()=>!c&&(s?[eb.NodeRunningStatus.Running,eb.NodeRunningStatus.NotStart].includes(o):_),[_,c,s,o]),E=T?.status===404,V=(N?C:d)||C||{},I=(0,y.useMemo)(()=>c||o===eb.NodeRunningStatus.Stopped?eb.NodeRunningStatus.Stopped:o===eb.NodeRunningStatus.Listening?eb.NodeRunningStatus.Listening:V.status||u.status,[c,o,V,u.status]),R=(0,y.useCallback)(()=>{v(!1),j(!1),f(null)},[]);(0,y.useEffect)(()=>{w&&g&&(!o||o===eb.NodeRunningStatus.NotStart)&&(l(g),R())},[m,h,o]),(0,y.useEffect)(()=>{[eb.NodeRunningStatus.Succeeded,eb.NodeRunningStatus.Failed].includes(o)&&f(o)},[o]),(0,y.useEffect)(()=>{R()},[a]);let A=(0,y.useCallback)(()=>{"hidden"===document.visibilityState?v(!0):j(!0)},[]);return((0,y.useEffect)(()=>(document.addEventListener("visibilitychange",A),()=>{document.removeEventListener("visibilitychange",A)}),[A]),_&&!s)?(0,x.jsx)("div",{className:"flex h-0 grow flex-col items-center justify-center",children:(0,x.jsx)(M.RiLoader2Line,{className:"size-4 animate-spin text-text-tertiary"})}):S?(0,x.jsx)(tc.default,{status:"running",showSteps:!1}):c||!E&&V?(0,x.jsx)("div",{children:(0,x.jsx)(tc.default,{...V,...u,status:I,total_tokens:V?.execution_metadata?.total_tokens||u?.total_tokens,created_by:V?.created_by_account?.created_by||u?.created_by,nodeInfo:V,showSteps:!1})}):(0,x.jsx)(tp,{canSingleRun:r,onSingleRun:i})});var tx=e.i(944419),th=e.i(762767),tg=e.i(124836);e.i(201987);var tf=e.i(207331),tb=e.i(471981),ty=e.i(963855),tv=e.i(879306),tw=e.i(187921),tj=e.i(14868),tk=e.i(57375),tN=e.i(893925),tC=e.i(762433),t_=e.i(13254),tT=e.i(248405),tS=e.i(128250),tE=e.i(697797),tV=e.i(547944),tI=e.i(260781),tR=e.i(144480),tM=e.i(879756),tA=e.i(443523),tO=e.i(367916),tP=e.i(840247);let{checkValid:tL}=tT.default,{checkValid:tF}=t_.default,{checkValid:tB}=tN.default,{checkValid:tD}=tw.default,{checkValid:t$}=tI.default,{checkValid:tz}=tV.default,{checkValid:tH}=tk.default,{checkValid:tW}=tR.default,{checkValid:tq}=tM.default,{checkValid:tU}=tv.default,{checkValid:tK}=tE.default,{checkValid:tG}=tC.default,{checkValid:tJ}=tj.default,{checkValid:tX}=tS.default,tQ={[eb.BlockEnum.LLM]:tL,[eb.BlockEnum.KnowledgeRetrieval]:tF,[eb.BlockEnum.IfElse]:tB,[eb.BlockEnum.Code]:tD,[eb.BlockEnum.TemplateTransform]:t$,[eb.BlockEnum.QuestionClassifier]:tz,[eb.BlockEnum.HttpRequest]:tH,[eb.BlockEnum.Tool]:tW,[eb.BlockEnum.VariableAssigner]:tU,[eb.BlockEnum.VariableAggregator]:tq,[eb.BlockEnum.ParameterExtractor]:tK,[eb.BlockEnum.Iteration]:tG,[eb.BlockEnum.DocExtractor]:tJ,[eb.BlockEnum.Loop]:tX};var tY=e.i(607224),tZ=e.i(418017),t0=e.i(739255),t1=e.i(885327),t2=e.i(157644),t5=e.i(243922),t3=e.i(619507);let t4=function(e){let{inputs:t,setInputs:a,varKey:r="variables"}=e;return{handleVarListChange:(0,y.useCallback)(e=>{a((0,f.produce)(t,t=>{t[r]=e}))},[t,a,r]),handleAddVariable:(0,y.useCallback)(()=>{a((0,f.produce)(t,e=>{e[r].push({variable:"",value_selector:[]})}))},[t,a,r])}};e.i(187243);var t6=e.i(989425);let t8=(e,t)=>{let a=(0,t5.useStrategyProviderDetail)(e||"",{retry:!1}),r=a.data?.declaration.strategies.find(e=>e.identity.name===t),s=(0,t2.useFetchPluginsInMarketPlaceByIds)([e],{retry:!1}),l=(0,y.useMemo)(()=>{if(a.isLoading||s.isLoading)return;let e=!!r,t=!a.isError;return{plugin:{source:s.data?.data.plugins.at(0)?"marketplace":"external",installed:t},isExistInPlugin:e}},[r,s,a.isError,a.isLoading]),n=(0,y.useCallback)(()=>{a.refetch(),s.refetch()},[s,a]);return{strategyProvider:a,strategy:r,strategyStatus:l,refetch:n}},t9=(e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),{inputs:r,setInputs:s}=(0,tZ.default)(e,t),{handleVarListChange:l,handleAddVariable:n}=t4({inputs:r,setInputs:s}),{strategyStatus:o,strategy:i,strategyProvider:d}=t8(r.agent_strategy_provider_name,r.agent_strategy_name),c=r.agent_strategy_provider_name?.split("/").splice(0,2).join("/"),u=(0,t2.useCheckInstalled)({pluginIds:[c],enabled:!!c}),p=(0,y.useMemo)(()=>{let e=(i?.parameters||[]).map(e=>e.name);return Object.fromEntries(Object.entries(r.agent_parameters||{}).filter(t=>{let[a]=t;return e.includes(a)}).map(e=>{let[t,a]=e;return[t,a.value]}))},[r.agent_parameters,i?.parameters]),m=(0,y.useCallback)(e=>i?.parameters.some(t=>t.name===e&&t.type===t0.FormTypeEnum.any)?t6.VarType.variable:t6.VarType.constant,[i?.parameters]),x=e=>{let t=(0,t1.generateAgentToolValue)(e.settings,(0,t1.toolParametersToFormSchemas)(e.schemas.filter(e=>"llm"!==e.form))),a=(0,t1.generateAgentToolValue)(e.parameters,(0,t1.toolParametersToFormSchemas)(e.schemas.filter(e=>"llm"===e.form)),!0);return(0,f.produce)(e,e=>{e.settings=t,e.parameters=a})};(0,y.useEffect)(()=>{i&&s(r.version||r.tool_node_version?r:(0,f.produce)(r,e=>{let t=i?.parameters||[];Object.keys(e.agent_parameters||{}).forEach(a=>{let r=t.find(e=>e.name===a);r?.type===t0.FormTypeEnum.toolSelector&&(e.agent_parameters[a].value=x(e.agent_parameters[a].value)),r?.type===t0.FormTypeEnum.multiToolSelector&&(e.agent_parameters[a].value=e.agent_parameters[a].value.map(e=>x(e)))}),e.tool_node_version="2"}))},[i]);let h=(0,y.useCallback)(e=>[eb.VarType.arrayObject,eb.VarType.array,eb.VarType.number,eb.VarType.string,eb.VarType.secret,eb.VarType.arrayString,eb.VarType.arrayNumber,eb.VarType.file,eb.VarType.arrayFile].includes(e.type),[]),{availableVars:g,availableNodesWithParent:b}=(0,t3.default)(e,{onlyLeafNodeVar:!1,filterVar:h}),v=(0,y.useMemo)(()=>{let e=[];return r.output_schema&&r.output_schema.properties?(Object.keys(r.output_schema.properties).forEach(t=>{let a=r.output_schema.properties[t];e.push({name:t,type:"array"===a.type?`Array[${a.items?.type?a.items.type.slice(0,1).toLocaleUpperCase()+a.items.type.slice(1):"Unknown"}]`:`${a.type?a.type.slice(0,1).toLocaleUpperCase()+a.type.slice(1):"Unknown"}`,description:a.description})}),e):[]},[r.output_schema]),w=(0,y.useCallback)(e=>{s((0,f.produce)(r,t=>{t.memory=e}))},[r,s]),j=(0,Z.useIsChatMode)();return{readOnly:a,inputs:r,setInputs:s,handleVarListChange:l,handleAddVariable:n,currentStrategy:i,formData:p,onFormChange:e=>{let t={};Object.entries(e).forEach(e=>{let[a,r]=e;t[a]={type:m(a),value:r}}),s({...r,agent_parameters:t})},currentStrategyStatus:o,strategyProvider:d.data,pluginDetail:u.data?.plugins.at(0),availableVars:g,availableNodesWithParent:b,outputSchema:v,handleMemoryChange:w,isChatMode:j}};var t7=e.i(721423),ae=e.i(18084);let at=(e,t)=>{let a=t.find(t=>"sys"===e[0]&&!!t.isStartNode||e[0]===t.nodeId),r=a?.vars.find(t=>"sys"===e[0]&&t.variable===`sys.${e[1]}`||t.variable===e[1]),s="";return r?.type==="array[file]"&&(s=eb.InputVarType.multiFiles),r?.type==="file"&&(s=eb.InputVarType.singleFile),r&&{...r,formType:s}},aa=e=>Array.isArray(e.value)?e.value[0]??"":"number"==typeof e.value?String(e.value):e.value??"",ar="nodes.knowledgeRetrieval",as=(e,t)=>{let{payload:a={enabled:!1},onChange:r}=t,{currentModel:s}=(0,$.useTextGenerationCurrentProviderAndModelAndModelList)({provider:e.provider,model:e.name}),l=(0,Z.useIsChatMode)(),n=(0,y.useCallback)(()=>!!s?.features?.includes(t0.ModelFeatureEnum.vision),[s]),o=n(),i=(0,y.useCallback)(e=>{r((0,f.produce)(a,t=>{t.enabled=e,e&&l?t.configs={detail:eg.Resolution.high,variable_selector:["sys","files"]}:e||delete t.configs}))},[l,r,a]),d=(0,y.useCallback)(e=>{r((0,f.produce)(a,t=>{t.configs=e}))},[r,a]),c=(0,y.useCallback)(()=>{n()?a.enabled&&r({enabled:!0,configs:{detail:eg.Resolution.high,variable_selector:[]}}):i(!1)},[n,i,r,a.enabled]);return{isVisionModel:o,handleVisionResolutionEnabledChange:i,handleVisionResolutionChange:d,handleModelChanged:c}},al="nodes.llm";var an=e.i(417944),ao=e.i(344600);let ai=(e,t)=>{let a=(0,eN.useWorkflowStore)(),{nodesReadOnly:r}=(0,Z.useNodesReadOnly)(),{t:s}=(0,O.useTranslation)(),l=(0,$.useLanguage)(),{inputs:n,setInputs:o}=(0,tZ.default)(e,t),{provider_id:i,provider_type:d,tool_name:c,tool_configurations:u,tool_parameters:p}=n,m=d===e9.CollectionType.builtIn,{data:x}=(0,C.useAllBuiltInTools)(),{data:h}=(0,C.useAllCustomTools)(),{data:g}=(0,C.useAllWorkflowTools)(),{data:b}=(0,C.useAllMCPTools)(),v=(0,y.useMemo)(()=>{switch(d){case e9.CollectionType.builtIn:return x||[];case e9.CollectionType.custom:return h||[];case e9.CollectionType.workflow:return g||[];case e9.CollectionType.mcp:return b||[];default:return[]}},[x,h,b,d,g]),w=(0,y.useMemo)(()=>v.find(e=>(0,eE.canFindTool)(e.id,i)),[v,i]),j=!!w?.allow_delete,k=!!w?.is_team_authorization,N=m&&j&&!k,[_,{setTrue:T,setFalse:S}]=(0,an.useBoolean)(!1),E=(0,C.useInvalidToolsByType)(d),V=(0,y.useCallback)(async e=>{await (0,ao.updateBuiltInToolCredential)(w?.name,e),eR.default.notify({type:"success",message:s("api.actionSuccess",{ns:"common"})}),E(),S()},[w?.name,S,s,E,d]),I=(0,y.useMemo)(()=>w?.tools.find(e=>e.name===c),[w,c]),R=(0,y.useMemo)(()=>I?(0,t1.toolParametersToFormSchemas)(I.parameters):[],[I]),M=(0,y.useMemo)(()=>R.filter(e=>"llm"===e.form),[R]),A=(0,y.useMemo)(()=>R.filter(e=>"llm"!==e.form),[R]),P=A.some(e=>"boolean"===e.type||"number-input"===e.type),L=(0,y.useCallback)(e=>{P?o((0,f.produce)(e,e=>{let t={...e.tool_configurations};Object.keys(e.tool_configurations).forEach(e=>{let a=R.find(t=>t.variable===e),r=t[e];a?.type==="boolean"&&("string"==typeof r&&(t[e]="true"===r||"1"===r),"number"==typeof r&&(t[e]=1===r)),a?.type==="number-input"&&"string"==typeof r&&""!==r&&(t[e]=Number.parseFloat(r))}),e.tool_configurations=t})):o(e)},[o,R,P]),[F,B]=(0,y.useState)(!1),D=(0,y.useMemo)(()=>F?u:(0,t1.getConfiguredValue)(u,A),[F,A,u]),z=(0,y.useCallback)(e=>{B(!0),L({...n,tool_configurations:e})},[n,L]);(0,y.useEffect)(()=>{if(!I)return;let e=(0,f.produce)(n,e=>{e.tool_configurations&&0!==Object.keys(e.tool_configurations).length||(e.tool_configurations=(0,t1.getConfiguredValue)(u,A)),e.tool_parameters&&0!==Object.keys(e.tool_parameters).length||(e.tool_parameters=(0,t1.getConfiguredValue)(p,M))}),{setControlPromptEditorRerenderKey:t}=a.getState();L(e),setTimeout(()=>t(Date.now()))},[I]);let H=(0,y.useCallback)(e=>{L({...n,tool_parameters:e})},[n,L]),W=I&&!!m&&!w,q=(0,y.useMemo)(()=>{let e=[],t=I?.output_schema;return t&&t.properties&&Object.keys(t.properties).forEach(a=>{let r=t.properties[a];"object"===r.type?e.push({name:a,value:r}):e.push({name:a,type:"array"===r.type?`Array[${r.items?.type?r.items.type.slice(0,1).toLocaleUpperCase()+r.items.type.slice(1):"Unknown"}]`:`${r.type?r.type.slice(0,1).toLocaleUpperCase()+r.type.slice(1):"Unknown"}`,description:r.description})}),e},[I]),U=(0,y.useMemo)(()=>{let e=I?.output_schema;if(!e||!e.properties)return!1;let t=e.properties;return Object.keys(t).some(e=>"object"===t[e].type)},[I]);return{readOnly:r,inputs:n,currTool:I,toolSettingSchema:A,toolSettingValue:D,setToolSettingValue:z,toolInputVarSchema:M,setInputVar:H,currCollection:w,isShowAuthBtn:N,showSetAuth:_,showSetAuthModal:T,hideSetAuthModal:S,handleSaveAuth:V,isLoading:W,outputSchema:q,hasObjectOutput:U,getMoreDataForCheckValid:()=>{let e;return{toolInputsSchema:(e=[],M.forEach(t=>{e.push({label:t.label[l]||t.label.en_US,variable:t.variable,type:t.type,required:t.required})}),e),notAuthed:N,toolSettingSchema:A,language:l}}}};var ad=e.i(227785),ac=e.i(366892),au=((r={}).settings="settings",r.lastRun="lastRun",r.relations="relations",r);let ap=y.memo(e=>{let{value:t,onChange:a}=e,{t:r}=(0,O.useTranslation)();return(0,x.jsx)(ac.default,{items:[{id:"settings",name:r("debug.settingsTab",{ns:"workflow"}).toLocaleUpperCase()},{id:"lastRun",name:r("debug.lastRunTab",{ns:"workflow"}).toLocaleUpperCase()}],itemClassName:"ml-0",value:t,onChange:a})}),am={[eb.BlockEnum.LLM]:e=>{let t,a,r,{id:s,payload:l,runInputData:n,runInputDataRef:o,getInputVars:i,setRunInputData:d,toVarInputs:c}=e,{t:u}=(0,O.useTranslation)(),{inputs:p}=(0,tZ.default)(s,l),m=(0,Z.useIsChatMode)(),x=n["#context#"],h=(0,y.useCallback)(e=>{d?.({...o.current,"#context#":e})},[o,d]),g=n["#files#"],f=(0,y.useCallback)(e=>{d?.({...o.current,"#files#":e})},[o,d]),b=p.model,v=p.model?.mode===eg.AppModeEnum.CHAT,{isVisionModel:w}=as(b,{payload:p.vision,onChange:tg.noop}),j=v?p.prompt_template.some(e=>e.edition_type===eb.EditionType.jinja2):p.prompt_template.edition_type===eb.EditionType.jinja2,k=(0,y.useCallback)(e=>[eb.VarType.arrayObject,eb.VarType.array,eb.VarType.number,eb.VarType.string,eb.VarType.secret,eb.VarType.arrayString,eb.VarType.arrayNumber,eb.VarType.file,eb.VarType.arrayFile].includes(e.type),[]),{availableVars:N}=(0,t3.default)(s,{onlyLeafNodeVar:!1,filterVar:k}),C=(a=i((t=v?p.prompt_template.filter(e=>e.edition_type!==eb.EditionType.jinja2).map(e=>e.text):[p.prompt_template.text],m&&v&&p.memory&&(t.push("{{#sys.query#}}"),t.push(p.memory.query_prompt_template)),t))||[],j?[...a,...c?c(p.prompt_config?.jinja2_variables||[]):[]]:a),_=(r={},Object.keys(n).filter(e=>!["#context#","#files#"].includes(e)).forEach(e=>{r[e]=n[e]}),r),T=(0,y.useCallback)(e=>{let t={...e,"#context#":o.current["#context#"],"#files#":o.current["#files#"]};d?.(t)},[o,d]);return{forms:(()=>{let e=[];if(C.length>0&&e.push({label:u(`${al}.singleRun.variable`,{ns:"workflow"}),inputs:C,values:_,onChange:T}),p.context?.variable_selector&&p.context?.variable_selector.length>0&&e.push({label:u(`${al}.context`,{ns:"workflow"}),inputs:[{label:"",variable:"#context#",type:eb.InputVarType.contexts,required:!1}],values:{"#context#":x},onChange:e=>h(e["#context#"])}),w&&l.vision?.enabled&&l.vision?.configs?.variable_selector){let t=at(l.vision.configs.variable_selector,N);e.push({label:u(`${al}.vision`,{ns:"workflow"}),inputs:[{label:t?.variable,variable:"#files#",type:t?.formType,required:!1}],values:{"#files#":g},onChange:e=>f(e["#files#"])})}return e})(),getDependentVars:()=>{let e=[...C.map(e=>e.variable&&"string"==typeof e.variable?e.variable.slice(1,-1).split("."):[]).filter(e=>e.length>0),l.context.variable_selector];if(w&&l.vision?.enabled&&l.vision?.configs?.variable_selector){let t=l.vision.configs.variable_selector;e.push(t)}return e},getDependentVar:e=>"#context#"===e?l.context.variable_selector:"#files#"===e&&l.vision.configs?.variable_selector}},[eb.BlockEnum.KnowledgeRetrieval]:e=>{let{id:t,payload:a,runInputData:r,runInputDataRef:s,setRunInputData:l}=e,{t:n}=(0,O.useTranslation)(),o=(0,ae.useDatasetsDetailStore)(e=>e.datasetsDetail),i=r.query,d=r.queryAttachment,c=(0,y.useCallback)(e=>{l({...s.current,query:e})},[s,l]),u=(0,y.useCallback)(e=>{l({...s.current,queryAttachment:e})},[s,l]),p=(0,y.useCallback)(e=>[eb.VarType.file,eb.VarType.arrayFile].includes(e.type),[]),{availableVars:m}=(0,t3.default)(t,{onlyLeafNodeVar:!1,filterVar:p});return{forms:(0,y.useMemo)(()=>{let e=a.dataset_ids.reduce((e,t)=>(o[t]&&e.push(o[t]),e),[]).some(e=>e.is_multimodal),t=[{inputs:[{label:n(`${ar}.queryText`,{ns:"workflow"}),variable:"query",type:eb.InputVarType.paragraph,required:!1}],values:{query:i},onChange:e=>c(e.query)}];if(e){let e=at(a.query_attachment_selector||[],m);t.push({inputs:[{label:n(`${ar}.queryAttachment`,{ns:"workflow"}),variable:"queryAttachment",type:e?.formType,required:!1}],values:{queryAttachment:d},onChange:e=>u(e.queryAttachment)})}return t},[i,c,n,o,a.dataset_ids,a.query_attachment_selector,m,d,u]),getDependentVars:()=>[a.query_variable_selector,a.query_attachment_selector||[]],getDependentVar:e=>"query"===e?a.query_variable_selector:"queryAttachment"===e?a.query_attachment_selector||[]:void 0}},[eb.BlockEnum.Code]:e=>{let t,{id:a,payload:r,runInputData:s,toVarInputs:l,setRunInputData:n}=e,{inputs:o}=(0,tZ.default)(a,r),i=l(o.variables),d=(0,y.useCallback)(e=>{n(e)},[n]),c=(t={},Object.keys(s).forEach(e=>{t[e]=s[e]}),t);return{forms:(0,y.useMemo)(()=>[{inputs:i,values:c,onChange:d}],[c,d,i]),getDependentVars:()=>r.variables.map(e=>e.value_selector),getDependentVar:e=>{let t=r.variables.find(t=>t.variable===e);if(t)return t.value_selector}}},[eb.BlockEnum.TemplateTransform]:e=>{let t,{id:a,payload:r,runInputData:s,toVarInputs:l,setRunInputData:n}=e,{inputs:o}=(0,tZ.default)(a,r),i=l(o.variables),d=(0,y.useCallback)(e=>{n(e)},[n]),c=(t={},Object.keys(s).forEach(e=>{t[e]=s[e]}),t);return{forms:(0,y.useMemo)(()=>[{inputs:i,values:c,onChange:d}],[c,d,i]),getDependentVars:()=>r.variables.map(e=>e.value_selector),getDependentVar:e=>{let t=r.variables.find(t=>t.variable===e);if(t)return t.value_selector}}},[eb.BlockEnum.QuestionClassifier]:e=>{let t,{id:a,payload:r,runInputData:s,runInputDataRef:l,getInputVars:n,setRunInputData:o}=e,{t:i}=(0,O.useTranslation)(),{inputs:d}=(0,tZ.default)(a,r),{isVisionModel:c}=as(d.model,{payload:d.vision,onChange:tg.noop}),u=s["#files#"],p=(0,y.useCallback)(e=>{o?.({...l.current,"#files#":e})},[l,o]),m=n([d.instruction]),x=(t={},Object.keys(s).filter(e=>!["#files#"].includes(e)).forEach(e=>{t[e]=s[e]}),t),h=(0,y.useCallback)(e=>{let t={...e,"#files#":l.current["#files#"]};o?.(t)},[l,o]),g=(0,y.useCallback)(e=>[eb.VarType.file,eb.VarType.arrayFile].includes(e.type),[]),{availableVars:f}=(0,t3.default)(a,{onlyLeafNodeVar:!1,filterVar:g});return{forms:(()=>{let e=[];if(e.push({label:i("nodes.llm.singleRun.variable",{ns:"workflow"}),inputs:[{label:i("nodes.questionClassifiers.inputVars",{ns:"workflow"}),variable:"query",type:eb.InputVarType.paragraph,required:!0},...m],values:x,onChange:h}),c&&r.vision?.enabled&&r.vision?.configs?.variable_selector){let t=at(r.vision.configs.variable_selector,f);e.push({label:i("nodes.llm.vision",{ns:"workflow"}),inputs:[{label:t?.variable,variable:"#files#",type:t?.formType,required:!1}],values:{"#files#":u},onChange:e=>p(e["#files#"])})}return e})(),getDependentVars:()=>{let e=m.map(e=>e.variable&&"string"==typeof e.variable?e.variable.slice(1,-1).split("."):[]).filter(e=>e.length>0),t=[r.query_variable_selector,...e];if(c&&r.vision?.enabled&&r.vision?.configs?.variable_selector){let e=r.vision.configs.variable_selector;t.push(e)}return t},getDependentVar:e=>"query"===e?r.query_variable_selector:"#files#"===e&&r.vision.configs?.variable_selector}},[eb.BlockEnum.HttpRequest]:e=>{let t,{id:a,payload:r,runInputData:s,getInputVars:l,setRunInputData:n}=e,{inputs:o}=(0,tZ.default)(a,r),i=(0,y.useMemo)(()=>Array.isArray(o.body.data)?o.body.data.filter(e=>e.file?.length).map(e=>e.file?`{{#${e.file.join(".")}#}}`:"").join(" "):"",[o.body.data]),d=l([o.url,o.headers,o.params,"string"==typeof o.body.data?o.body.data:o.body.data?.map(e=>e.value).join(""),i]),c=(0,y.useCallback)(e=>{n(e)},[n]),u=(t={},Object.keys(s).forEach(e=>{t[e]=s[e]}),t);return{forms:(0,y.useMemo)(()=>[{inputs:d,values:u,onChange:c}],[u,c,d]),getDependentVars:()=>d.map(e=>e.variable&&"string"==typeof e.variable?e.variable.slice(1,-1).split("."):[]).filter(e=>e.length>0)}},[eb.BlockEnum.Tool]:e=>{let{id:t,payload:a,getInputVars:r,setRunInputData:s,runResult:l}=e,{t:n}=(0,O.useTranslation)(),{inputs:o}=(0,tZ.default)(t,a),i=r([...Object.keys(o.tool_parameters).filter(e=>o.tool_parameters[e].type!==t6.VarType.constant).map(e=>o.tool_parameters[e]),...Object.keys(o.tool_configurations).filter(e=>"object"==typeof o.tool_configurations[e]&&o.tool_configurations[e].type&&o.tool_configurations[e].type!==t6.VarType.constant).map(e=>o.tool_configurations[e])].map(e=>e.type===t6.VarType.variable?e.value.join?`{{#${e.value.join(".")}#}}`:`{{#${e.value}#}}`:e.value)),[d,c]=(0,y.useState)({}),u=(0,y.useCallback)(e=>{c(e),s(e)},[s]),p=(0,y.useCallback)(()=>(0,f.produce)(d,e=>{Object.keys(o.tool_parameters).forEach(t=>{let{type:a,value:r}=o.tool_parameters[t];if(a===t6.VarType.constant&&null==r){if(!e.tool_parameters||!e.tool_parameters[t])return;e[t]=r}})}),[o.tool_parameters,d]),m=(0,y.useMemo)(()=>[{inputs:i,values:p(),onChange:u}],[p,u,i]);return{forms:m,nodeInfo:(0,y.useMemo)(()=>l?(0,tY.default)([l],n)[0]:null,[l,n]),toolIcon:(0,ee.useToolIcon)(a),getDependentVars:()=>i.map(e=>e.variable&&"string"==typeof e.variable?e.variable.slice(1,-1).split("."):[]).filter(e=>e.length>0)}},[eb.BlockEnum.ParameterExtractor]:e=>{let t,{id:a,payload:r,runInputData:s,runInputDataRef:l,getInputVars:n,setRunInputData:o}=e,{t:i}=(0,O.useTranslation)(),{inputs:d}=(0,tZ.default)(a,r),{isVisionModel:c}=as(d.model,{payload:d.vision,onChange:tg.noop}),u=s["#files#"],p=(0,y.useCallback)(e=>{o?.({...l.current,"#files#":e})},[l,o]),m=n([d.instruction]),x=(t={},Object.keys(s).filter(e=>!["#context#","#files#"].includes(e)).forEach(e=>{t[e]=s[e]}),t),h=(0,y.useCallback)(e=>{let t={...e,"#context#":l.current["#context#"],"#files#":l.current["#files#"]};o?.(t)},[l,o]),g=(0,y.useCallback)(e=>[eb.VarType.file,eb.VarType.arrayFile].includes(e.type),[]),{availableVars:f}=(0,t3.default)(a,{onlyLeafNodeVar:!1,filterVar:g});return{forms:(()=>{let e=[];if(e.push({label:i("nodes.llm.singleRun.variable",{ns:"workflow"}),inputs:[{label:i("nodes.parameterExtractor.inputVar",{ns:"workflow"}),variable:"query",type:eb.InputVarType.paragraph,required:!0},...m],values:x,onChange:h}),c&&r.vision?.enabled&&r.vision?.configs?.variable_selector){let t=at(r.vision.configs.variable_selector,f);e.push({label:i("nodes.llm.vision",{ns:"workflow"}),inputs:[{label:t?.variable,variable:"#files#",type:t?.formType,required:!1}],values:{"#files#":u},onChange:e=>p(e["#files#"])})}return e})(),getDependentVars:()=>{let e=m.map(e=>e.variable&&"string"==typeof e.variable?e.variable.slice(1,-1).split("."):[]).filter(e=>e.length>0),t=[r.query,...e];if(c&&r.vision?.enabled&&r.vision?.configs?.variable_selector){let e=r.vision.configs.variable_selector;t.push(e)}return t},getDependentVar:e=>"query"===e?r.query:"#files#"===e&&r.vision.configs?.variable_selector}},[eb.BlockEnum.Iteration]:e=>{let t,a,r,s,{id:l,payload:n,runInputData:o,toVarInputs:i,setRunInputData:d,iterationRunResult:c}=e,{t:u}=(0,O.useTranslation)(),{isNodeInIteration:p}=(0,Z.useIsNodeInIteration)(l),{getIterationNodeChildren:m,getBeforeNodesInSameBranch:x}=(0,Z.useWorkflow)(),h=m(l),g=[...x(l),...h],f=`${l}.input_selector`,b=o[f],v=(0,y.useCallback)(e=>{d({...o,[f]:e})},[f,o,d]),{usedOutVars:w,allVarObject:j}=(t=[],a={},r={},h.forEach(e=>{(0,ty.getNodeUsedVars)(e).filter(e=>e&&e.length>0).forEach(s=>{if(s[0]===l||p(s[0]))return;let n=s.join(".");a[n]||(a[n]=!0,t.push(s));let o=(0,ty.getNodeUsedVarPassToServerKey)(e,s);"string"==typeof o&&(o=[o]),o.forEach((t,a)=>{r[[n,e.id,a].join(k.VALUE_SELECTOR_DELIMITER)]={inSingleRunPassedKey:t}})})}),{usedOutVars:i(t.map(e=>{let t=(0,ty.getNodeInfoById)(g,e[0]);return{label:{nodeType:t?.data.type,nodeName:t?.data.title||g[0]?.data.title,variable:(0,ty.isSystemVar)(e)?e.join("."):e[e.length-1]},variable:`${e.join(".")}`,value_selector:e}})),allVarObject:r}),N=(0,y.useCallback)(e=>{d(e)},[d]),C=(s={},Object.keys(o).forEach(e=>{s[e]=o[e]}),s),_=(0,y.useMemo)(()=>[{inputs:[...w],values:C,onChange:N},{label:u("nodes.iteration.input",{ns:"workflow"}),inputs:[{label:"",variable:f,type:eb.InputVarType.iterator,required:!1,getVarValueFromDependent:!0,isFileItem:n.iterator_input_type===eb.VarType.arrayFile}],values:{[f]:b},onChange:e=>v(e[f])}],[C,b,f,n.iterator_input_type,N,v,u,w]);return{forms:_,nodeInfo:(0,tY.default)(c,u)[0],allVarObject:j,getDependentVars:()=>[n.iterator_selector],getDependentVar:e=>{if(e===f)return n.iterator_selector}}},[eb.BlockEnum.Agent]:e=>{let{id:t,payload:a,runInputData:r,getInputVars:s,setRunInputData:l,runResult:n}=e,{t:o}=(0,O.useTranslation)(),{inputs:i}=(0,tZ.default)(t,a),d=(0,y.useMemo)(()=>Object.fromEntries(Object.entries(i.agent_parameters||{}).map(e=>{let[t,a]=e;return[t,a.value]})),[i.agent_parameters]),{strategy:c}=t8(i.agent_strategy_provider_name,i.agent_strategy_name),u=c?.parameters.filter(e=>"string"===e.type).map(e=>d[e.name])||[],p=s?.(u),m=(0,y.useMemo)(()=>{let e=[];return p.length>0&&e.push({label:o("nodes.llm.singleRun.variable",{ns:"workflow"}),inputs:p,values:r,onChange:l}),e},[r,l,o,p]);return{forms:m,nodeInfo:(0,y.useMemo)(()=>{if(n)return(0,tY.default)([n],o)[0]},[n,o]),getDependentVars:()=>p.map(e=>e.variable&&"string"==typeof e.variable?e.variable.slice(1,-1).split("."):[]).filter(e=>e.length>0)}},[eb.BlockEnum.DocExtractor]:e=>{let{payload:t,runInputData:a,setRunInputData:r}=e,{t:s}=(0,O.useTranslation)(),l=a.files,n=(0,y.useCallback)(e=>{r({...a,files:e})},[a,r]);return{forms:(0,y.useMemo)(()=>[{inputs:[{label:s("nodes.docExtractor.inputVar",{ns:"workflow"}),variable:"files",type:eb.InputVarType.multiFiles,required:!0}],values:{files:l},onChange:e=>n(e.files)}],[l,n,s]),getDependentVars:()=>[t.variable_selector],getDependentVar:e=>{if("files"===e)return t.variable_selector}}},[eb.BlockEnum.Loop]:e=>{let t,a,r,s,l,n,o,i,{id:d,payload:c,runInputData:u,runResult:p,loopRunResult:m,setRunInputData:x,toVarInputs:h,varSelectorsToVarInputs:g}=e,{t:f}=(0,O.useTranslation)(),{isNodeInLoop:b}=(0,Z.useIsNodeInLoop)(d),{getLoopNodeChildren:v,getBeforeNodesInSameBranch:w}=(0,Z.useWorkflow)(),j=v(d),N=[...w(d),...j],{usedOutVars:C,allVarObject:_}=(t=[],a={},r={},j.forEach(e=>{(0,ty.getNodeUsedVars)(e).filter(e=>e&&e.length>0).forEach(s=>{if(s[0]===d||b(s[0]))return;let l=s.join(".");a[l]||(a[l]=!0,t.push(s));let n=(0,ty.getNodeUsedVarPassToServerKey)(e,s);"string"==typeof n&&(n=[n]),n.forEach((t,a)=>{r[[l,e.id,a].join(k.VALUE_SELECTOR_DELIMITER)]={inSingleRunPassedKey:t}})})}),{usedOutVars:h(t.map(e=>{let t=(0,ty.getNodeInfoById)(N,e[0]);return{label:{nodeType:t?.data.type,nodeName:t?.data.title||N[0]?.data.title,variable:(0,ty.isSystemVar)(e)?e.join("."):e[e.length-1]},variable:`${e.join(".")}`,value_selector:e}})),allVarObject:r}),T=(0,y.useMemo)(()=>{let e=(0,tY.default)(m,f)[0];return p&&e?{...e,execution_metadata:{...p.execution_metadata,...e.execution_metadata}}:e},[p,m,f]),S=(0,y.useCallback)(e=>{x(e)},[x]),E=(s={},Object.keys(u).forEach(e=>{s[e]=u[e]}),s),V=e=>{var t;let a,r=[];return e.variable_selector&&r.push(e.variable_selector),e.sub_variable_condition&&e.sub_variable_condition.conditions?.length&&r.push(...(t=e.sub_variable_condition,a=[],t.conditions&&t.conditions.length&&t.conditions.forEach(e=>{let t=V(e);a.push(...t)}),a)),r},I=(l=[],c.break_conditions?.forEach(e=>{let t=V(e);l.push(...t)}),c.loop_variables?.forEach(e=>{e.value_type===eb.ValueType.variable&&l.push(e.value)}),n=[...g(l)],o={},i=[],n.forEach(e=>{e&&(o[e.variable]||(o[e.variable]=!0,i.push(e)))}),[{inputs:[...C,...i],values:E,onChange:S}]),R=e=>{var t;let a,r=[];return e.variable_selector&&r.push(e.variable_selector),e.sub_variable_condition&&e.sub_variable_condition.conditions?.length&&r.push(...(t=e.sub_variable_condition,a=[],t.conditions&&t.conditions.length&&t.conditions.forEach(e=>{let t=R(e);a.push(...t)}),a)),r};return{forms:I,nodeInfo:T,allVarObject:_,getDependentVars:()=>{let e=C.map(e=>e.variable.split("."));return c.break_conditions?.forEach(t=>{let a=R(t);e.push(...a)}),c.loop_variables?.forEach(t=>{t.value_type===eb.ValueType.variable&&e.push(t.value)}),e.filter(e=>e[0]!==d)}}},[eb.BlockEnum.Start]:e=>{let t,a,{id:r,payload:s,runInputData:l,setRunInputData:n}=e,{t:o}=(0,O.useTranslation)(),i=(0,Z.useIsChatMode)();return{forms:(t=[],a=s.variables.map(e=>({...e,getVarValueFromDependent:!0})),i&&a.push({label:"sys.query",variable:"#sys.query#",type:eb.InputVarType.textInput,required:!0}),a.push({label:"sys.files",variable:"#sys.files#",type:eb.InputVarType.multiFiles,required:!1}),t.push({label:o("nodes.llm.singleRun.variable",{ns:"workflow"}),inputs:a,values:l,onChange:n}),t),getDependentVars:()=>{let e=[...s.variables.map(e=>[r,e.variable]),["sys","files"]];return i&&e.push(["sys","query"]),e},getDependentVar:e=>[r,e]}},[eb.BlockEnum.IfElse]:e=>{let t,a,r,s,l,n,{payload:o,runInputData:i,setRunInputData:d,getInputVars:c,varSelectorsToVarInputs:u}=e,p=(0,y.useCallback)(e=>{d(e)},[d]),m=(t={},Object.keys(i).forEach(e=>{t[e]=i[e]}),t),x=e=>{let t=[];return e.conditions&&e.conditions.length&&e.conditions.forEach(e=>{let a=h(e);t.push(...a)}),t},h=e=>{let t=[];return e.variable_selector&&t.push(e.variable_selector),e.sub_variable_condition&&e.sub_variable_condition.conditions?.length&&t.push(...x(e.sub_variable_condition)),t},g=e=>{let t=[];return e.conditions&&e.conditions.length&&e.conditions.forEach(e=>{let a=f(e);t.push(...a)}),t},f=e=>{let t=[];if(e.value&&"string"==typeof e.value){let a=c([e.value]);t.push(...a)}return e.sub_variable_condition&&e.sub_variable_condition.conditions?.length&&t.push(...g(e.sub_variable_condition)),t},b=(a=[],r=[],o.cases&&o.cases.length&&o.cases.forEach(e=>{let t=x(e);a.push(...t),r.push(...g(e))}),s=[...u(a),...r],l={},n=[],s.forEach(e=>{e&&(l[e.variable]||(l[e.variable]=!0,n.push(e)))}),[{inputs:n,values:m,onChange:p}]),v=e=>{let t=[];return e.conditions&&e.conditions.length&&e.conditions.forEach(e=>{let a=w(e);t.push(...a)}),t},w=e=>{let t=[];return e.variable_selector&&t.push(e.variable_selector),e.sub_variable_condition&&e.sub_variable_condition.conditions?.length&&t.push(...v(e.sub_variable_condition)),t};return{forms:b,getDependentVars:()=>{let e=[];return o.cases&&o.cases.length&&o.cases.forEach(t=>{let a=v(t);e.push(...a)}),e}}},[eb.BlockEnum.VariableAggregator]:e=>{let t,a,r,s,l,n,{payload:o,runInputData:i,setRunInputData:d,varSelectorsToVarInputs:c}=e,u=(0,y.useCallback)(e=>{d(e)},[d]),p=(t={},Object.keys(i).forEach(e=>{t[e]=i[e]}),t);return{forms:(a=[],(r=!!o.advanced_settings?.group_enabled)||!o.variables||!o.variables.length||o.variables.forEach(e=>{a.push(e)}),r&&o.advanced_settings&&o.advanced_settings.groups&&o.advanced_settings.groups.length&&o.advanced_settings.groups.forEach(e=>{e.variables?.forEach(e=>{a.push(e)})}),s=c(a),l={},n=[],s.forEach(e=>{e&&(l[e.variable]||(l[e.variable]=!0,n.push({...e,required:!1})))}),[{inputs:n,values:p,onChange:u}]),getDependentVars:()=>{if(o.advanced_settings?.group_enabled){let e=[];return o.advanced_settings.groups.forEach(t=>{t.variables&&e.push([...t.variables])}),e}return[o.variables]}}},[eb.BlockEnum.Assigner]:e=>{let{id:t,payload:a,runInputData:r,setRunInputData:s,varSelectorsToVarInputs:l}=e,{inputs:n}=(0,tZ.default)(t,a),o=(n.items??[]).filter(e=>e.operation!==t7.WriteMode.clear&&e.operation!==t7.WriteMode.set&&e.operation!==t7.WriteMode.removeFirst&&e.operation!==t7.WriteMode.removeLast&&!t7.writeModeTypesNum.includes(e.operation)).map(e=>e.value);return{forms:(0,y.useMemo)(()=>[{inputs:l(o),values:r,onChange:s}],[r,s,l,o]),getDependentVars:()=>o}},[eb.BlockEnum.KnowledgeBase]:e=>{let{payload:t,runInputData:a,setRunInputData:r}=e,{t:s}=(0,O.useTranslation)(),l=a.query,n=(0,y.useCallback)(e=>{r({...a,query:e})},[a,r]);return{forms:(0,y.useMemo)(()=>[{inputs:[{label:s("nodes.common.inputVars",{ns:"workflow"}),variable:"query",type:eb.InputVarType.paragraph,required:!0}],values:{query:l},onChange:e=>n(e.query)}],[l,n,s]),getDependentVars:()=>[t.index_chunk_variable_selector],getDependentVar:e=>{if("query"===e)return t.index_chunk_variable_selector}}},[eb.BlockEnum.VariableAssigner]:void 0,[eb.BlockEnum.End]:void 0,[eb.BlockEnum.Answer]:void 0,[eb.BlockEnum.ListFilter]:void 0,[eb.BlockEnum.IterationStart]:void 0,[eb.BlockEnum.LoopStart]:void 0,[eb.BlockEnum.LoopEnd]:void 0,[eb.BlockEnum.DataSource]:void 0,[eb.BlockEnum.DataSourceEmpty]:void 0,[eb.BlockEnum.TriggerWebhook]:void 0,[eb.BlockEnum.TriggerSchedule]:void 0,[eb.BlockEnum.TriggerPlugin]:void 0},ax={[eb.BlockEnum.Tool]:e=>{let{id:t,payload:a}=e,{getMoreDataForCheckValid:r}=ai(t,a);return{getData:r}},[eb.BlockEnum.LLM]:void 0,[eb.BlockEnum.KnowledgeRetrieval]:void 0,[eb.BlockEnum.Code]:void 0,[eb.BlockEnum.TemplateTransform]:void 0,[eb.BlockEnum.QuestionClassifier]:void 0,[eb.BlockEnum.HttpRequest]:void 0,[eb.BlockEnum.ParameterExtractor]:void 0,[eb.BlockEnum.Iteration]:void 0,[eb.BlockEnum.Agent]:void 0,[eb.BlockEnum.DocExtractor]:void 0,[eb.BlockEnum.Loop]:void 0,[eb.BlockEnum.Start]:void 0,[eb.BlockEnum.IfElse]:void 0,[eb.BlockEnum.VariableAggregator]:void 0,[eb.BlockEnum.End]:void 0,[eb.BlockEnum.Answer]:void 0,[eb.BlockEnum.VariableAssigner]:void 0,[eb.BlockEnum.ListFilter]:void 0,[eb.BlockEnum.IterationStart]:void 0,[eb.BlockEnum.Assigner]:void 0,[eb.BlockEnum.LoopStart]:void 0,[eb.BlockEnum.LoopEnd]:void 0,[eb.BlockEnum.DataSource]:void 0,[eb.BlockEnum.DataSourceEmpty]:void 0,[eb.BlockEnum.KnowledgeBase]:void 0,[eb.BlockEnum.TriggerWebhook]:void 0,[eb.BlockEnum.TriggerSchedule]:void 0,[eb.BlockEnum.TriggerPlugin]:e=>{let{payload:t}=e,{data:a}=(0,eS.useAllTriggerPlugins)(),r=(0,eq.useGetLanguage)();return{getData:(0,y.useCallback)(()=>(0,ad.getTriggerCheckParams)(t,a,r),[t,a,r])}}};var ah=e.i(380493),ag=e.i(369795),af=e.i(430807);let ab=e=>{let{subscriptionIdSelected:t,onSubscriptionChange:a,children:r}=e,{subscriptions:s}=(0,af.useSubscriptionList)(),l=s?.length||0;return(0,x.jsxs)("div",{className:(0,T.cn)("px-4",l>0&&"flex items-center justify-between pr-3"),children:[!l&&(0,x.jsx)(ah.CreateSubscriptionButton,{buttonType:ah.CreateButtonType.FULL_BUTTON}),r,l>0&&(0,x.jsx)(ag.SubscriptionSelectorEntry,{selectedId:t,onSelect:a})]})},ay=(0,y.memo)(e=>{let{id:t,data:a,children:r}=e,{t:s}=(0,O.useTranslation)(),l=(0,$.useLanguage)(),{showMessageLogModal:n}=(0,L.useStore)((0,P.useShallow)(e=>({showMessageLogModal:e.showMessageLogModal}))),o=a._singleRunningStatus===eb.NodeRunningStatus.Running,i=(0,eN.useStore)(e=>e.showSingleRunPanel),d=(0,eN.useStore)(e=>e.workflowCanvasWidth),c=(0,eN.useStore)(e=>e.nodePanelWidth),u=(0,eN.useStore)(e=>e.otherPanelWidth),p=(0,eN.useStore)(e=>e.setNodePanelWidth),m=(0,eN.useStore)(e=>e.pendingSingleRun),h=(0,eN.useStore)(e=>e.setPendingSingleRun),g=(0,y.useMemo)(()=>d?Math.max(d-(u||0)-400,400):720,[d,u]),b=(0,y.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"user",a=Math.max(400,Math.min(e,g));"user"===t&&localStorage.setItem("workflow-node-panel-width",`${a}`),p(a)},[g,p]),v=(0,y.useCallback)(e=>{b(e,"user")},[b]),{triggerRef:w,containerRef:S}=(0,eV.useResizePanel)({direction:"horizontal",triggerDirection:"left",minWidth:400,maxWidth:g,onResize:(0,A.debounce)(v)}),E=(0,A.debounce)(e=>{b(e,"system")});(0,y.useEffect)(()=>{!d||c+u+400>d&&E(Math.max(d-u-400,400))},[c,u,d,E]);let{handleNodeSelect:es}=(0,V.useNodesInteractions)(),{nodesReadOnly:el}=(0,Z.useNodesReadOnly)(),{availableNextBlocks:en}=(0,X.useAvailableBlocks)(a.type,a.isInIteration||a.isInLoop),eo=(0,ee.useToolIcon)(a),{saveStateToHistory:ei}=(0,R.useWorkflowHistory)(),{handleNodeDataUpdate:ed,handleNodeDataUpdateWithSyncDraft:ec}=(0,Q.useNodeDataUpdate)(),eu=(0,y.useCallback)(e=>{ec({id:t,data:{title:e}}),ei(R.WorkflowHistoryEvent.NodeTitleChange,{nodeId:t})},[ec,t,ei]),ep=(0,y.useCallback)(e=>{ec({id:t,data:{desc:e}}),ei(R.WorkflowHistoryEvent.NodeDescriptionChange,{nodeId:t})},[ec,t,ei]),ex=!!(a.isInIteration||a.isInLoop),eg=(0,eC.canRunBySingle)(a.type,ex),ey=(0,L.useStore)(e=>e.appDetail),eI=(0,y.useRef)(!1),[eM,eA]=(0,y.useState)(!1);(0,y.useEffect)(()=>{a._singleRunningStatus===eb.NodeRunningStatus.Running?(eI.current=!0,eA(!1)):a._isSingleRun&&void 0===a._singleRunningStatus&&eI&&(eA(!0),eI.current=!1)},[a]);let eO=(0,y.useCallback)(e=>{ed({id:t,data:{...a,_singleRunningStatus:e}})},[ed,t,a]);(0,y.useEffect)(()=>{eI.current=!1},[t]);let{nodesMap:eL}=(0,Y.useNodesMetaData)(),eF=(0,et.useHooksStore)(e=>e.configsMap),{isShowSingleRun:eB,hideSingleRun:eD,runningStatus:e$,runInputData:ez,runInputDataRef:eH,runResult:eW,setRunResult:eq,getInputVars:eU,toVarInputs:eK,tabType:eG,isRunAfterSingleRun:eJ,setIsRunAfterSingleRun:eQ,setTabType:eZ,handleAfterCustomSingleRun:e0,singleRunParams:e1,nodeInfo:e2,setRunInputData:e5,handleStop:e3,handleSingleRun:e4,handleRunWithParams:e6,getExistVarValuesInForms:e9,getFilteredExistVarForms:e7}=(e=>{let{...t}=e,{conversationVars:a,systemVars:r,hasSetInspectVar:s}=(0,ea.default)(),l=t.data.type,n=l===eb.BlockEnum.Start,o=l===eb.BlockEnum.Iteration,i=l===eb.BlockEnum.Loop,d=l===eb.BlockEnum.VariableAggregator,c=(0,eC.isSupportCustomRunForm)(l),{handleSyncWorkflowDraft:u}=(0,I.useNodesSyncDraft)(),{getData:p}=((e,t)=>ax[l]?.({id:e,payload:t})||{getData:()=>({})})(t.id,t.data),[m,x]=(0,y.useState)(!1),{id:h,flowId:g,flowType:b,data:v}=t,w=(e=>{let{id:t,flowId:a,flowType:r,data:s,defaultRunInputData:l,moreDataForCheckValid:n,iteratorInputKey:o,loopInputKey:i,isRunAfterSingleRun:d,isPaused:c}=e,{t:u}=(0,O.useTranslation)(),{getBeforeNodesInSameBranch:p,getBeforeNodesInSameBranchIncludeParent:m}=(0,Z.useWorkflow)(),x=(0,eN.useStore)(e=>e.conversationVariables),h=(0,Z.useIsChatMode)(),g=s.type===eb.BlockEnum.Iteration,b=s.type===eb.BlockEnum.Loop,v=s.type===eb.BlockEnum.Start,w=p(t),k=m(t),T=(0,eN.useWorkflowStore)(),{schemaTypeDefinitions:S}=(0,tP.default)(),{data:E}=(0,C.useAllBuiltInTools)(),{data:V}=(0,C.useAllCustomTools)(),{data:I}=(0,C.useAllWorkflowTools)(),{data:R}=(0,C.useAllMCPTools)(),M=tQ[s.type],[A,P]=(0,y.useState)(l||{}),L=(0,y.useRef)(A),F=(0,y.useCallback)(e=>{L.current=e,P(e)},[]),B=o?A[o]?.length:0,D=i?A[i]?.length:0,$=(0,j.useStoreApi)(),{setShowSingleRunPanel:z,setIsListening:H,setListeningTriggerType:W,setListeningTriggerNodeId:q,setListeningTriggerNodeIds:U,setListeningTriggerIsAll:K,setShowVariableInspectPanel:G}=T.getState(),J=(0,y.useCallback)((e,t)=>{let{nodesWithInspectVars:a,setNodesWithInspectVars:r}=T.getState(),s=!1,l=(0,f.produce)(a,a=>{let r=a.findIndex(t=>t.nodeId===e);if(-1!==r){let e=a[r];e.isSingRunRunning!==t&&(e.isSingRunRunning=t,t&&(e.isValueFetched=!1),s=!0)}else if(t){let{getNodes:t}=$.getState(),r=t().find(t=>t.id===e);r&&(a.unshift({nodeId:e,nodeType:r.data.type,title:r.data.title,vars:[],nodePayload:r.data,isSingRunRunning:!0,isValueFetched:!1}),s=!0)}});s&&r(l)},[T,$]),X=(0,eh.useInvalidLastRun)(r,a,t),[Y,ee]=(0,y.useState)(null),{appendNodeInspectVars:et,invalidateSysVarValues:er,invalidateConversationVarValues:es}=(0,ea.default)(),el=s._singleRunningStatus||eb.NodeRunningStatus.NotStart,en=(0,y.useRef)(!1),eo=(0,y.useRef)(null),ei=(0,y.useRef)(void 0),ed=(0,y.useRef)(0),ec=(0,y.useRef)(null),eu=(0,y.useRef)(!1),ep=(0,y.useRef)(null),em=(0,y.useRef)(void 0),ex=(0,y.useRef)(0),eg=(0,y.useRef)(null),ef=(0,y.useRef)(c);(0,y.useEffect)(()=>{ef.current=c},[c]);let{eventEmitter:ey}=(0,N.useEventEmitterContextContext)(),ev=s.type===eb.BlockEnum.TriggerSchedule,ew=s.type===eb.BlockEnum.TriggerWebhook,ej=s.type===eb.BlockEnum.TriggerPlugin,ek=ew||ej||ev,eC=(0,y.useCallback)(async e=>{if(ef.current)return;if(!(!d||el===eb.NodeRunningStatus.Succeeded))return void ee(e);let s=await (0,_.fetchNodeInspectVars)(r,a,t),{getNodes:l}=$.getState();et(t,s,l()),J(t,!1),e?.status===eb.NodeRunningStatus.Succeeded&&(X(),(v||ek)&&er(),es())},[d,el,a,t,$,et,J,X,v,ek,er,es]),{handleNodeDataUpdate:e_}=(0,Q.useNodeDataUpdate)(),eT=(0,y.useCallback)(()=>{en.current=!1,ed.current+=1,eo.current&&eo.current.abort(),eo.current=null,void 0!==ei.current&&(window.clearTimeout(ei.current),ei.current=void 0),ec.current&&(ec.current(),ec.current=null)},[]),eS=(0,y.useCallback)(()=>{eu.current=!1,ex.current+=1,ep.current&&ep.current.abort(),ep.current=null,void 0!==em.current&&(window.clearTimeout(em.current),em.current=void 0),eg.current&&(eg.current(),eg.current=null)},[]),eE=(0,y.useCallback)(()=>{ek&&(H(!0),G(!0),W(s.type),q(t),U([t]),K(!1))},[ek,H,G,W,s.type,q,t,U,K]),eV=(0,y.useCallback)(()=>{ek&&(H(!1),W(null),q(null),U([]),K(!1))},[ek,H,W,q,U,K]),eI=(0,y.useCallback)(async()=>{let e=`/apps/${a}/workflows/draft/nodes/${t}/trigger/run`;try{let a=await (0,tO.post)(e,{body:JSON.stringify({})});if(!a){let e="Schedule trigger run failed";throw eR.default.notify({type:"error",message:e}),Error(e)}if(a?.status==="error"){let e=a?.message||"Schedule trigger run failed";throw eR.default.notify({type:"error",message:e}),Error(e)}return e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Succeeded}}),a}catch(e){throw console.error("handleRun: schedule trigger single run error",e),e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Failed}}),eR.default.notify({type:"error",message:"Schedule trigger run failed"}),e}},[a,t,e_,s]),eM=(0,y.useCallback)(async()=>{let e=`/apps/${a}/workflows/draft/nodes/${t}/trigger/run`;en.current=!0;let r=++ed.current;for(;en.current&&r===ed.current;){let a=new AbortController;eo.current=a;try{let l=await (0,tO.post)(e,{body:JSON.stringify({}),signal:a.signal});if(!en.current||r!==ed.current)return null;if(!l){let e=l?.message||"Webhook debug failed";throw eR.default.notify({type:"error",message:e}),eT(),Error(e)}if(l?.status==="waiting"){let e=Number(l.retry_in)||2e3;if(eo.current=null,!en.current||r!==ed.current)return null;await new Promise(t=>{let r=window.setTimeout(t,e);ei.current=r,ec.current=t,a.signal.addEventListener("abort",()=>{window.clearTimeout(r),t()},{once:!0})}),ei.current=void 0,ec.current=null;continue}if(l?.status==="error"){let e=l.message||"Webhook debug failed";throw eR.default.notify({type:"error",message:e}),eT(),Error(e)}return e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Listening}}),eT(),l}catch(e){if(a.signal.aborted&&(!en.current||r!==ed.current)||a.signal.aborted)return null;if(eR.default.notify({type:"error",message:"Webhook debug request failed"}),eT(),e instanceof Error)throw e;throw Error(String(e))}finally{eo.current=null}}return null},[a,t,s,e_,eT]),eA=(0,y.useCallback)(async()=>{let e=`/apps/${a}/workflows/draft/nodes/${t}/trigger/run`;eu.current=!0;let r=++ex.current;for(;eu.current&&r===ex.current;){let a,l=new AbortController;ep.current=l;let n=await (0,tO.post)(e,{body:JSON.stringify({}),signal:l.signal}).catch(async e=>{let{error:t,status:r}=await e.clone().json()||{};return a={message:t,status:r},null}).finally(()=>{ep.current=null});if(!eu.current||r!==ex.current)break;if(a){if(l.signal.aborted)return null;throw eR.default.notify({type:"error",message:a.message}),eS(),a}if(!n){let e="Plugin debug failed";throw eR.default.notify({type:"error",message:e}),eS(),Error(e)}if(n?.status==="waiting"){let e=Number(n.retry_in)||2e3;if(!eu.current||r!==ex.current)return null;await new Promise(t=>{let a=window.setTimeout(t,e);em.current=a,eg.current=t,l.signal.addEventListener("abort",()=>{window.clearTimeout(a),t()},{once:!0})}),em.current=void 0,eg.current=null;continue}if(n?.status==="error"){let e=n.message||"Plugin debug failed";throw eR.default.notify({type:"error",message:e}),eS(),Error(e)}return e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Listening}}),eS(),n}return null},[a,t,s,e_,eS]),eO=()=>{if(!M)return{isValid:!0,errorMessage:""};let e=M(s,u,n);return e.isValid||(e_({id:t,data:{...s,_isSingleRun:!1}}),eR.default.notify({type:"error",message:e.errorMessage||""})),e},[eP,eL]=(0,y.useState)(!1),eF=s._isSingleRun&&eP,[eB,eD]=(0,y.useState)([]),[e$,ez]=(0,y.useState)([]);(0,y.useEffect)(()=>{if(!M)return void eL(!0);if(s._isSingleRun){let{isValid:e}=eO();eL(e)}},[s._isSingleRun]),(0,y.useEffect)(()=>{z(!!eF)},[eF,z]);let eH=el===eb.NodeRunningStatus.Succeeded||el===eb.NodeRunningStatus.Failed,eW=async e=>{let l;ew&&eT(),ej&&eS(),J(t,!0),ek?eE():eV(),e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:ek?eb.NodeRunningStatus.Listening:eb.NodeRunningStatus.Running}});let n=!1;try{if(g||b){if(g){eD([]);let l=[],n=null;(0,tO.ssePost)((0,_.getIterationSingleNodeRunUrl)(r,h,a,t),{body:{inputs:e}},{onWorkflowStarted:tg.noop,onWorkflowFinished:e=>{if(ef.current)return;e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Succeeded}});let{data:a}=e;n.created_by=a.created_by.name,eC(n)},onIterationStart:e=>{let t=(0,f.produce)(l,t=>{t.push({...e.data,status:eb.NodeRunningStatus.Running})});l=t,eD(t)},onIterationNext:()=>{if(l.length>=B)return l.length>=B},onIterationFinish:e=>{n=e.data,eC(n);let t=l,a=t.findIndex(t=>t.id===e.data.id),r=(0,f.produce)(t,e=>{a>-1&&(e[a]={...e[a],...s})});l=r,eD(r)},onNodeStarted:e=>{let t=(0,f.produce)(l,t=>{t.push({...e.data,status:eb.NodeRunningStatus.Running})});l=t,eD(t)},onNodeFinished:e=>{let t=l,{data:a}=e,r=t.findIndex(e=>e.id===a.id),s=(0,f.produce)(t,e=>{r>-1&&(e[r]={...e[r],...a})});l=s,eD(s)},onNodeRetry:e=>{let t=(0,f.produce)(l,t=>{t.push(e.data)});l=t,eD(t)},onError:()=>{ef.current||e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Failed}})}})}else if(b){ez([]);let n=[],o=null;(0,tO.ssePost)((0,_.getLoopSingleNodeRunUrl)(r,h,a,t),{body:{inputs:e}},{onWorkflowStarted:tg.noop,onWorkflowFinished:e=>{if(ef.current)return;e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Succeeded}});let{data:a}=e;o.created_by=a.created_by.name,eC(o)},onLoopStart:e=>{let t=(0,f.produce)(n,t=>{t.push({...e.data,status:eb.NodeRunningStatus.Running})});n=t,ez(t)},onLoopNext:()=>{if(n.length>=D)return n.length>=D},onLoopFinish:e=>{o=e.data,eC(o);let t=n,a=t.findIndex(t=>t.id===e.data.id),r=(0,f.produce)(t,e=>{a>-1&&(e[a]={...e[a],...s})});n=r,ez(r)},onNodeStarted:e=>{let t=(0,f.produce)(n,t=>{t.push({...e.data,status:eb.NodeRunningStatus.Running})});n=t,ez(t)},onNodeFinished:e=>{let t=n,{data:a}=e,r=t.findIndex(e=>e.id===a.id),s=(0,f.produce)(t,e=>{r>-1&&(e[r]={...e[r],...a})});n=s,ez(s)},onNodeRetry:e=>{let t=(0,f.produce)(n,t=>{t.push(e.data)});n=t,ez(t)},onError:()=>{ef.current||(e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Failed}}),(0,tf.trackEvent)("workflow_run_failed",{workflow_id:a,node_id:t,reason:l.error,node_type:s?.type}))}})}}else if(ev)l=await eI();else if(ew){if(!(l=await eM()))return en.current&&e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Stopped}}),!1}else if(ej){if(!(l=await eA()))return eu.current&&e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Stopped}}),!1}else{let n=s.type===eb.BlockEnum.Start,o={};if(n){let{"#sys.query#":t,"#sys.files#":a,...r}=e;h&&(o.conversation_id=""),o.inputs=r,o.query=t,o.files=a||[]}else o.inputs=e;l=await (0,_.singleNodeRun)(r,a,t,o)}if(l&&l.error)throw Error(l.error)}catch(e){if(console.error(e),n=!0,X(),!g&&!b){if(ef.current)return;return e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Failed}}),!1}}finally{ew&&eT(),ej&&eS(),ek&&eV(),g||b||J(t,!1),ef.current||g||b||!l||eC({...l,total_tokens:l.execution_metadata?.total_tokens||0,created_by:l.created_by_account?.name||""})}if(!ef.current&&!g&&!b&&!n){if(ef.current)return;e_({id:t,data:{...s,_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Succeeded}})}},eq=(0,y.useCallback)(()=>{if(ek){if(!(el===eb.NodeRunningStatus.Listening||en.current||eu.current))return}else if(el!==eb.NodeRunningStatus.Running)return;eT(),eS(),e_({id:t,data:{_isSingleRun:!1,_singleRunningStatus:eb.NodeRunningStatus.Stopped}}),eV(),J(t,!1);let{workflowRunningData:e,setWorkflowRunningData:a,nodesWithInspectVars:r,deleteNodeInspectVars:s}=T.getState();e&&a((0,f.produce)(e,e=>{e.result.status=eb.WorkflowRunningStatus.Stopped}));let l=r.find(e=>e.nodeId===t);!l||l.isValueFetched||l.vars&&0!==l.vars.length||s(t)},[ek,el,eT,eS,e_,t,eV,J,T]),eU=e=>e?e.filter(e=>!(0,ty.isENV)(e.value_selector)).map(e=>{let t=(e=>{let t="sys"===e[0],{dataSourceList:a}=T.getState(),r=(0,ty.toNodeOutputVars)(w,h,void 0,void 0,x,[],{buildInTools:E||[],customTools:V||[],workflowTools:I||[],mcpTools:R||[],dataSourceList:a||[]},S).find(a=>t?!!a.isStartNode:a.nodeId===e[0]);if(!r)return;if(t)return r.vars.find(t=>t.variable.split(".")[1]===e[1]);let s=r.vars;for(let t=1;t<e.length;t++){let a=e[t],r=t===e.length-1;if(Array.isArray(s)&&(s=s.find(e=>e.variable.replace("conversation.","")===a)),r)return s;(s?.type===eb.VarType.object||s?.type===eb.VarType.file)&&(s=s.children)}})(e.value_selector);return t?{label:("object"==typeof e.label?e.label.variable:e.label)||e.variable,variable:e.variable,type:((e,t)=>{let{isSelect:a,isParagraph:r}=t;return a?eb.InputVarType.select:r?eb.InputVarType.paragraph:e===eb.VarType.number?eb.InputVarType.number:e===eb.VarType.boolean?eb.InputVarType.checkbox:[eb.VarType.object,eb.VarType.array,eb.VarType.arrayNumber,eb.VarType.arrayString,eb.VarType.arrayObject].includes(e)?eb.InputVarType.json:e===eb.VarType.file?eb.InputVarType.singleFile:e===eb.VarType.arrayFile?eb.InputVarType.multiFiles:eb.InputVarType.textInput})(t.type,{isSelect:!!t.isSelect,isParagraph:!!t.isParagraph}),required:!1!==e.required,options:t.options}:{label:e.label||e.variable,variable:e.variable,type:eb.InputVarType.textInput,required:!0,value_selector:e.value_selector}}):[],eK=e=>{let t=[];return e.forEach(e=>{t.push(...(0,tb.getInputVars)(e))}),eU((0,th.unionBy)(t,e=>e.join(".")).map(e=>{let t=(0,ty.getNodeInfoById)(k,e[0])?.data;return{label:{nodeType:t?.type,nodeName:t?.title||k[0]?.data.title,variable:(0,ty.isSystemVar)(e)?e.join("."):e[e.length-1],isChatVar:(0,ty.isConversationVar)(e)},variable:`#${e.join(".")}#`,value_selector:e}}))};return ey?.useSubscription(e=>{e.type===tA.EVENT_WORKFLOW_STOP&&eq()}),{isShowSingleRun:eF,hideSingleRun:()=>{e_({id:t,data:{...s,_isSingleRun:!1}})},showSingleRun:()=>{e_({id:t,data:{...s,_isSingleRun:!0}})},toVarInputs:eU,varSelectorsToVarInputs:e=>e.filter(e=>!!e).map(e=>eK([`{{#${"string"==typeof e?e:e.join(".")}#}}`])[0]),getInputVars:eK,runningStatus:el,isCompleted:eH,handleRun:eW,handleStop:eq,runInputData:A,runInputDataRef:L,setRunInputData:F,runResult:Y,setRunResult:ee,iterationRunResult:eB,loopRunResult:e$,setNodeRunning:()=>{e_({id:t,data:{...s,_singleRunningStatus:eb.NodeRunningStatus.Running}})},checkValid:eO}})({...t,iteratorInputKey:l===eb.BlockEnum.Iteration?`${h}.input_selector`:"",moreDataForCheckValid:p(),isRunAfterSingleRun:m}),{warningNodes:T}=(0,tx.useWorkflowRunValidation)(),S=(0,y.useCallback)(()=>{let e=T.find(e=>e.id===h);if(!e)return!1;let t=e.errorMessage||"This node has unresolved checklist issues";return eR.default.notify({type:"error",message:t}),!0},[T,h]),{hideSingleRun:E,handleRun:V,getInputVars:R,toVarInputs:M,varSelectorsToVarInputs:A,runInputData:P,runInputDataRef:L,setRunInputData:F,showSingleRun:B,runResult:D,iterationRunResult:$,loopRunResult:z,setNodeRunning:H,checkValid:W}=w,{...q}=(e=>am[l]?.(e)||{})({id:h,payload:v,runInputData:P,runInputDataRef:L,getInputVars:R,setRunInputData:F,toVarInputs:M,varSelectorsToVarInputs:A,runResult:D,iterationRunResult:$,loopRunResult:z}),U=(0,y.useCallback)(e=>{if(!o&&!i)return e;let t=q?.allVarObject||{},a={};if(Object.keys(t).forEach(r=>{let[s,l]=r.split(k.VALUE_SELECTOR_DELIMITER);a[`${l}.${t[r].inSingleRunPassedKey}`]=e[s]}),o){let t=`${h}.input_selector`;a[t]=e[t]}return a},[o,i,q?.allVarObject,h]),K=(e,t)=>{u(!0,!0,{onSuccess(){V(U(e)),t?.()}})},{setInitShowLastRunTab:G,setShowVariableInspectPanel:J}=(0,eN.useWorkflowStore)().getState(),X=(0,eN.useStore)(e=>e.initShowLastRunTab),[Y,ee]=(0,y.useState)(X?au.lastRun:au.settings);(0,y.useEffect)(()=>{X&&ee(au.lastRun),G(!1)},[X]);let et=(0,eh.useInvalidLastRun)(b,g,h),er=async e=>{if(S())return;let{isValid:t}=W();t&&(H(),x(!0),ee(au.lastRun),K(e,()=>{et()}),E())},es=(0,y.useCallback)(e=>{x(!1),ee(e)},[]),el=e=>e&&0!==e.length?e.map(e=>{let t={};return e.inputs.forEach(e=>{let{variable:l,getVarValueFromDependent:o}=e,i=o||!l.includes(".");if(i&&!q?.getDependentVar)return;let d=i?q?.getDependentVar(l)||[]:l.slice(1,-1).split(".");if(!d||0===d.length)return;let[c,u]=d.slice(0,2);if(!n&&c===h){t[l]=!0;return}s(c,u,r,a)&&(t[l]=!0)}),t}):[];return{...w,tabType:Y,isRunAfterSingleRun:m,setIsRunAfterSingleRun:x,setTabType:es,handleAfterCustomSingleRun:()=>{et(),ee(au.lastRun),E()},singleRunParams:q,nodeInfo:D,setRunInputData:F,handleSingleRun:()=>{if(S())return;let{isValid:e}=W();if(!e)return;if((l===eb.BlockEnum.TriggerWebhook||l===eb.BlockEnum.TriggerPlugin||l===eb.BlockEnum.TriggerSchedule)&&J(!0),c)return void B();let t=q?.getDependentVars?.();(d?!t||0===t.length||t.every(e=>!e||0===e.length||e.some(e=>{let[t,l]=e.slice(0,2);return s(t,l,r,a)})):!t||0===t.length||t.every(e=>{let[t,l]=e.slice(0,2);return s(t,l,r,a)}))?K({},async()=>{x(!0),H(),et(),ee(au.lastRun)}):B()},handleRunWithParams:er,getExistVarValuesInForms:el,getFilteredExistVarForms:e=>{if(!e||0===e.length)return[];let t=el(e);return e.map((e,a)=>{let r=t[a],s={...e};return s.inputs=e.inputs.filter(e=>!(e.variable in r)),s}).filter(e=>e.inputs.length>0)}}})({id:t,flowId:eF?.flowId||"",flowType:eF?.flowType||ef.FlowType.appFlow,data:a,defaultRunInputData:eL?.[a.type]?.defaultRunInputData||{},isPaused:eM});(0,y.useEffect)(()=>{eA(!1)},[eG]),(0,y.useEffect)(()=>{m&&m.nodeId===t&&("run"===m.action?e4():e3(),h(void 0))},[m,t,e4,e3,h]);let te=(0,ej.useLogs)(),tt=(0,y.useMemo)(()=>[eb.BlockEnum.Tool,eb.BlockEnum.Agent,eb.BlockEnum.Iteration,eb.BlockEnum.Loop].includes(a.type)?te:{},[a.type,te]),tr=(0,eN.useStore)(e=>e.buildInTools),{data:ts}=(0,C.useAllBuiltInTools)(),tl=(0,y.useMemo)(()=>{let e=ts??tr;return e?.find(e=>(0,eE.canFindTool)(e.id,a.provider_id))},[ts,tr,a.provider_id]),to=(0,y.useMemo)(()=>a.type===eb.BlockEnum.Tool&&tl?.allow_delete,[a.type,tl?.allow_delete]),{data:tc=[]}=(0,eS.useAllTriggerPlugins)(a.type===eb.BlockEnum.TriggerPlugin),tu=(0,y.useMemo)(()=>{if(a.type===eb.BlockEnum.TriggerPlugin&&a.plugin_id&&tc?.length)return tc?.find(e=>e.plugin_id===a.plugin_id)},[a.type,a.plugin_id,tc]),{setDetail:tp}=(0,K.usePluginStore)();(0,y.useEffect)(()=>{tu&&tp({name:tu.label[l],plugin_id:tu.plugin_id||"",plugin_unique_identifier:tu.plugin_unique_identifier||"",id:tu.id,provider:tu.name,declaration:{trigger:{subscription_schema:tu.subscription_schema||[],subscription_constructor:tu.subscription_constructor}}})},[tu,l,tp]);let tv=(0,eN.useStore)(e=>e.dataSourceList),tw=(0,y.useMemo)(()=>{if(a.type===eb.BlockEnum.DataSource&&a.provider_type!==ew.DataSourceClassification.localFile)return tv?.find(e=>e.plugin_id===a.plugin_id)},[tv,a.provider_id,a.type,a.provider_type]),tj=(0,y.useCallback)(e=>{ec({id:t,data:{credential_id:e}})},[ec,t]),{setShowAccountSettingModal:tk}=(0,eT.useModalContext)(),tN=(0,y.useCallback)(()=>{tk({payload:D.ACCOUNT_SETTING_TAB.DATA_SOURCE})},[tk]),{appendNodeInspectVars:tC}=(0,ea.default)(),t_=(0,y.useCallback)((e,a)=>{ec({id:t,data:{subscription_id:e.id}},{sync:!0,callback:{onSettled:a}})},[ec,t]),tT=(0,y.useMemo)(()=>{let e;switch(a.type){case eb.BlockEnum.Tool:e=tl;break;case eb.BlockEnum.DataSource:e=tw;break;case eb.BlockEnum.TriggerPlugin:e=tu}return e?(0,x.jsx)(G.ReadmeEntrance,{pluginDetail:e,className:"mt-auto"}):null},[a.type,tl,tw,tu]),tS=(0,y.useMemo)(()=>({id:t,data:a}),[t,a]);if(te.showSpecialResultPanel)return(0,x.jsx)("div",{className:(0,T.cn)("relative mr-1  h-full"),children:(0,x.jsx)("div",{ref:S,className:(0,T.cn)("flex h-full flex-col rounded-2xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-lg",i?"overflow-hidden":"overflow-y-auto"),style:{width:`${c}px`},children:(0,x.jsx)(em,{nodeName:a.title,onHide:eD,children:(0,x.jsx)("div",{className:"h-0 grow overflow-y-auto pb-4",children:(0,x.jsx)(ek.default,{...tt})})})})});if(eB){var tE;let e,r=(e=(tE={nodeId:t,flowId:eF?.flowId||"",flowType:eF?.flowType||ef.FlowType.appFlow,payload:a,setRunResult:eq,setIsRunAfterSingleRun:eQ,isPaused:eM,isRunAfterSingleRun:eJ,onSuccess:e0,onCancel:eD,appendNodeInspectVars:tC}).payload.type)===eb.BlockEnum.DataSource?(0,x.jsx)(ev,{...tE}):(0,x.jsxs)("div",{children:["Custom Run Form:",e," ","not found"]});return(0,x.jsx)("div",{className:(0,T.cn)("relative mr-1  h-full"),children:(0,x.jsx)("div",{ref:S,className:(0,T.cn)("flex h-full flex-col rounded-2xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-lg",i?"overflow-hidden":"overflow-y-auto"),style:{width:`${c}px`},children:(0,eC.isSupportCustomRunForm)(a.type)?r:(0,x.jsx)(eP,{nodeName:a.title,nodeType:a.type,onHide:eD,onRun:e6,...e1,...tt,existVarValuesInForms:e9(e1?.forms),filteredExistVarForms:e7(e1?.forms)})})})}return(0,x.jsxs)("div",{className:(0,T.cn)("relative mr-1 h-full",n&&"absolute z-0 mr-2 w-[400px] overflow-hidden rounded-2xl border-[0.5px] border-components-panel-border shadow-lg transition-all"),style:{right:n?`${u}px`:"0"},children:[(0,x.jsx)("div",{ref:w,className:"absolute -left-1 top-0 flex h-full w-1 cursor-col-resize resize-x items-center justify-center",children:(0,x.jsx)("div",{className:"h-10 w-0.5 rounded-sm bg-state-base-handle hover:h-full hover:bg-state-accent-solid active:h-full active:bg-state-accent-solid"})}),(0,x.jsxs)("div",{ref:S,className:(0,T.cn)("flex h-full flex-col rounded-2xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-lg transition-[width] ease-linear",i?"overflow-hidden":"overflow-y-auto"),style:{width:`${c}px`},children:[(0,x.jsxs)("div",{className:"sticky top-0 z-10 shrink-0 border-b-[0.5px] border-divider-regular bg-components-panel-bg",children:[(0,x.jsxs)("div",{className:"flex items-center px-4 pb-1 pt-4",children:[(0,x.jsx)(J.default,{className:"mr-1 shrink-0",type:a.type,toolIcon:eo,size:"md"}),(0,x.jsx)(ti,{value:a.title||"",onBlur:eu}),(0,x.jsxs)("div",{className:"flex shrink-0 items-center text-text-tertiary",children:[eg&&!el&&(0,x.jsx)(B.default,{popupContent:s("panel.runThisStep",{ns:"workflow"}),popupClassName:"mr-1",disabled:o,children:(0,x.jsx)("div",{className:"mr-1 flex h-6 w-6 cursor-pointer items-center justify-center rounded-md hover:bg-state-base-hover",onClick:()=>{o?e3():e4()},children:o?(0,x.jsx)(F.default,{className:"h-4 w-4 text-text-tertiary"}):(0,x.jsx)(M.RiPlayLargeLine,{className:"h-4 w-4 text-text-tertiary"})})}),(0,x.jsx)(eY,{nodeType:a.type}),(0,x.jsx)(ta,{id:t,data:a,showHelpLink:!1}),(0,x.jsx)("div",{className:"mx-3 h-3.5 w-[1px] bg-divider-regular"}),(0,x.jsx)("div",{className:"flex h-6 w-6 cursor-pointer items-center justify-center",onClick:()=>es(t,!0),children:(0,x.jsx)(M.RiCloseLine,{className:"h-4 w-4 text-text-tertiary"})})]})]}),(0,x.jsx)("div",{className:"p-2",children:(0,x.jsx)(td,{value:a.desc||"",onChange:ep})}),to&&(0,x.jsx)(q.PluginAuth,{className:"px-4 pb-2",pluginPayload:{provider:tl?.name||"",providerType:tl?.type||"",category:z.AuthCategory.tool,detail:tl},children:(0,x.jsxs)("div",{className:"flex items-center justify-between pl-4 pr-3",children:[(0,x.jsx)(ap,{value:eG,onChange:eZ}),(0,x.jsx)(W.default,{pluginPayload:{provider:tl?.name||"",providerType:tl?.type||"",category:z.AuthCategory.tool,detail:tl},onAuthorizationItemClick:tj,credentialId:a.credential_id})]})}),!!tw&&(0,x.jsx)(U.default,{onJumpToDataSourcePage:tN,isAuthorized:tw.is_authorized,children:(0,x.jsxs)("div",{className:"flex items-center justify-between pl-4 pr-3",children:[(0,x.jsx)(ap,{value:eG,onChange:eZ}),(0,x.jsx)(H.default,{onJumpToDataSourcePage:tN,authorizationsNum:3})]})}),tu&&(0,x.jsx)(ab,{subscriptionIdSelected:a.subscription_id,onSubscriptionChange:t_,children:(0,x.jsx)(ap,{value:eG,onChange:eZ})}),!to&&!tw&&!tu&&(0,x.jsx)("div",{className:"flex items-center justify-between pl-4 pr-3",children:(0,x.jsx)(ap,{value:eG,onChange:eZ})}),(0,x.jsx)(er,{})]}),eG===au.settings&&(0,x.jsxs)("div",{className:"flex flex-1 flex-col overflow-y-auto",children:[(0,x.jsx)("div",{children:(0,y.cloneElement)(r,{id:t,data:a,panelProps:{getInputVars:eU,toVarInputs:eK,runInputData:ez,setRunInputData:e5,runResult:eW,runInputDataRef:eH}})}),(0,x.jsx)(er,{}),(0,e_.hasRetryNode)(a.type)&&(0,x.jsx)(tn,{id:t,data:a}),(0,eC.hasErrorHandleNode)(a.type)&&(0,x.jsx)(eX,{id:t,data:a}),!!en.length&&(0,x.jsxs)("div",{className:"border-t-[0.5px] border-divider-regular p-4",children:[(0,x.jsx)("div",{className:"system-sm-semibold-uppercase mb-1 flex items-center text-text-secondary",children:s("panel.nextStep",{ns:"workflow"}).toLocaleUpperCase()}),(0,x.jsx)("div",{className:"system-xs-regular mb-2 text-text-tertiary",children:s("panel.addNextStep",{ns:"workflow"})}),(0,x.jsx)(e8,{selectedNode:tS})]}),tT]}),eG===au.lastRun&&(0,x.jsx)(tm,{appId:ey?.id||"",nodeId:t,canSingleRun:eg,runningStatus:e$,isRunAfterSingleRun:eJ,updateNodeRunningStatus:eO,onSingleRunClicked:e4,nodeInfo:e2,singleRunResult:eW,isPaused:eM,...tt})]})]})});var av=e.i(746628),aw=e.i(91025),aj=e.i(781988),ak=e.i(26012);let aN="overview.appInfo.embedded",aC=e=>{let{content:t}=e,{t:a}=(0,O.useTranslation)(),[r,s]=(0,y.useState)(!1),l=(0,A.debounce)(()=>{(0,ak.default)(t),s(!0)},100),n=(0,A.debounce)(()=>{s(!1)},100);return(0,x.jsx)("div",{className:"inline-flex w-full pb-0.5",onClick:e=>e.stopPropagation(),onMouseLeave:n,children:(0,x.jsx)(B.default,{popupContent:a(r?`${aN}.copied`:`${aN}.copy`,{ns:"appOverview"})||"",children:(0,x.jsxs)("div",{className:"group/copy flex w-full items-center gap-0.5 ",onClick:l,children:[(0,x.jsx)("div",{className:"system-2xs-regular w-0 grow cursor-pointer truncate text-text-quaternary group-hover:text-text-tertiary",children:t}),(0,x.jsx)(M.RiFileCopyLine,{className:"h-3 w-3 shrink-0 text-text-tertiary opacity-0 group-hover/copy:opacity-100"})]})})})};var a_=e.i(892081),aT=e.i(949250),aS=e.i(276925);let aE=()=>{let e=(0,j.useStoreApi)(),t=(0,eN.useWorkflowStore)(),{handleNodeDataUpdate:a}=(0,Q.useNodeDataUpdate)(),r=(0,y.useCallback)((t,r,s,l)=>{let n,{getNodes:o}=e.getState(),i=o().find(e=>e.id===t);if(l&&"target"!==l)n={advanced_settings:{...i.data.advanced_settings,groups:i.data.advanced_settings?.groups.map(e=>e.groupId!==l||e.variables.some(e=>e.join(".")===r.join("."))?e:{...e,variables:[...e.variables,r],output_type:s.type})}};else{if(i.data.variables.some(e=>e.join(".")===r.join(".")))return;n={variables:[...i.data.variables,r],output_type:s.type}}a({id:t,data:n})},[e,a]),s=(0,y.useCallback)((a,s,l,n,o)=>{let{getNodes:i,setNodes:d}=e.getState(),{setShowAssignVariablePopup:c}=t.getState();d((0,f.produce)(i(),e=>{e.forEach(e=>{(e.id===a||e.id===s)&&(e.data={...e.data,_showAddVariablePopup:!1,_holdAddVariablePopup:!1})})})),c(void 0),r(s,n,o,l)},[e,t,r]);return{handleAddVariableInAddVariablePopupWithPosition:s,handleGroupItemMouseEnter:(0,y.useCallback)(e=>{let{setHoveringAssignVariableGroupId:a}=t.getState();a(e)},[t]),handleGroupItemMouseLeave:(0,y.useCallback)(()=>{let{connectingNodePayload:e,setHoveringAssignVariableGroupId:a}=t.getState();e&&a(void 0)},[t]),handleAssignVariableValueChange:r}},aV=()=>{let e=(0,j.useNodes)(),{getBeforeNodesInSameBranchIncludeParent:t}=(0,Z.useWorkflow)(),{getNodeAvailableVars:a}=(0,aT.useWorkflowVariables)(),r=(0,Z.useIsChatMode)();return(0,y.useCallback)(function(s,l,n){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=[],d=e.find(e=>e.id===s);if(!d)return[];let c=t(s);i.push(...c);let u=e.find(e=>e.id===d.parentId);return o?a({parentNode:u,beforeNodes:(0,aS.uniqBy)(i,"id").filter(e=>e.id!==s),isChatMode:r,hideEnv:o,hideChatVar:!1,filterVar:n}).map(e=>({...e,vars:e.isStartNode?e.vars.filter(e=>!e.variable.startsWith("sys.")):e.vars})).filter(e=>e.vars.length>0):a({parentNode:u,beforeNodes:(0,aS.uniqBy)(i,"id").filter(e=>e.id!==s),isChatMode:r,filterVar:n})},[e,t,a,r])},aI=e=>t=>e===eb.VarType.any||t.type===eb.VarType.any||t.type===e;var aR=e.i(139269);let aM=(0,y.memo)(e=>{let{availableVars:t,onSelect:a}=e,{t:r}=(0,O.useTranslation)();return(0,x.jsxs)("div",{className:"w-[240px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-lg",children:[(0,x.jsx)("div",{className:"flex h-[34px] items-center border-b-[0.5px] border-b-divider-regular px-4 text-[13px] font-semibold text-text-secondary",children:r("nodes.variableAssigner.setAssignVariable",{ns:"workflow"})}),(0,x.jsx)("div",{className:"p-1",children:(0,x.jsx)(aR.default,{hideSearch:!0,vars:t,onChange:a,isSupportFileVar:!0})})]})}),aA=(0,y.memo)(e=>{let{nodeId:t,nodeData:a}=e,r=(0,y.useRef)(null),s=(0,eN.useStore)(e=>e.showAssignVariablePopup),l=(0,eN.useStore)(e=>e.setShowAssignVariablePopup),{handleNodeDataUpdate:n}=(0,Q.useNodeDataUpdate)(),{handleAddVariableInAddVariablePopupWithPosition:o}=aE(),i=(0,Z.useIsChatMode)(),{getBeforeNodesInSameBranch:d}=(0,Z.useWorkflow)(),{getNodeAvailableVars:c}=(0,aT.useWorkflowVariables)(),u=(0,y.useMemo)(()=>{if(!s)return"";if(!s.variableAssignerNodeData.advanced_settings?.group_enabled)return s.variableAssignerNodeData.output_type;let e=s.variableAssignerNodeData.advanced_settings?.groups.find(e=>e.groupId===s.variableAssignerNodeHandleId);return e?.output_type||""},[s]),p=(0,y.useMemo)(()=>s?c({parentNode:s.parentNode,beforeNodes:[...d(s.nodeId),{id:s.nodeId,data:s.nodeData}],hideEnv:!0,hideChatVar:!i,isChatMode:i,filterVar:aI(u)}).map(e=>({...e,vars:e.isStartNode?e.vars.filter(e=>!e.variable.startsWith("sys.")):e.vars})).filter(e=>e.vars.length>0):[],[s,c,d,i,u]);(0,a_.useClickAway)(()=>{a._holdAddVariablePopup?n({id:t,data:{_holdAddVariablePopup:!1}}):(n({id:t,data:{_showAddVariablePopup:!1}}),l(void 0))},r);let m=(0,y.useCallback)((e,t)=>{s&&o(s.nodeId,s.variableAssignerNodeId,s.variableAssignerNodeHandleId,e,t)},[s,o]);return s?(0,x.jsx)("div",{className:"absolute z-10",style:{left:s.x,top:s.y},ref:r,children:(0,x.jsx)(aM,{availableVars:p,onSelect:m})}):null});var aO=((s={}).Start="start",s.Trigger="trigger",s);let aP=e=>{let{children:t,customLabel:a,nodeType:r="trigger"}=e,{t:s}=(0,O.useTranslation)(),l=(0,y.useMemo)(()=>{let e="start"===r?"entryNodeStatus":"triggerStatus";return a||s(`${e}.enabled`,{ns:"workflow"})},[a,r,s]);return(0,x.jsxs)("div",{className:"w-fit min-w-[242px] rounded-2xl bg-workflow-block-wrapper-bg-1 px-0 pb-0 pt-0.5",children:[(0,x.jsx)("div",{className:"mb-0.5 flex items-center px-2.5 pt-0.5",children:(0,x.jsx)("span",{className:"text-2xs font-semibold uppercase text-text-tertiary",children:l})}),t]})},aL=(0,y.memo)(e=>{let{id:t,data:a,handleId:r,handleClassName:s,nodeSelectorClassName:l}=e,[n,o]=(0,y.useState)(!1),{handleNodeAdd:i}=(0,V.useNodesInteractions)(),{getNodesReadOnly:d}=(0,Z.useNodesReadOnly)(),c=a._connectedTargetHandleIds?.includes(r),{availablePrevBlocks:u}=(0,X.useAvailableBlocks)(a.type,a.isInIteration||a.isInLoop),p=!!u.length,m=(0,y.useCallback)(e=>{o(e)},[]),h=(0,y.useCallback)(e=>{e.stopPropagation(),c||o(e=>!e)},[c]),g=(0,y.useCallback)((e,a)=>{i({nodeType:e,pluginDefaultValue:a},{nextNodeId:t,nextNodeTargetHandle:r})},[i,t,r]);return(0,x.jsx)(x.Fragment,{children:(0,x.jsx)(j.Handle,{id:r,type:"target",position:j.Position.Left,className:(0,T.cn)("z-[1] !h-4 !w-4 !rounded-none !border-none !bg-transparent !outline-none","after:absolute after:left-1.5 after:top-1 after:h-2 after:w-0.5 after:bg-workflow-link-line-handle","transition-all hover:scale-125",a._runningStatus===eb.NodeRunningStatus.Succeeded&&"after:bg-workflow-link-line-success-handle",a._runningStatus===eb.NodeRunningStatus.Failed&&"after:bg-workflow-link-line-error-handle",a._runningStatus===eb.NodeRunningStatus.Exception&&"after:bg-workflow-link-line-failure-handle",!c&&"after:opacity-0",(a.type===eb.BlockEnum.Start||a.type===eb.BlockEnum.TriggerWebhook||a.type===eb.BlockEnum.TriggerSchedule||a.type===eb.BlockEnum.TriggerPlugin)&&"opacity-0",s),isConnectable:p,onClick:h,children:!c&&p&&!d()&&(0,x.jsx)(eZ.default,{open:n,onOpenChange:m,onSelect:g,asChild:!0,placement:"left",triggerClassName:e=>`
                hidden absolute left-0 top-0 pointer-events-none
                ${l}
                group-hover:!flex
                ${a.selected&&"!flex"}
                ${e&&"!flex"}
              `,availableBlocksTypes:u})})})});aL.displayName="NodeTargetHandle";let aF=(0,y.memo)(e=>{let{id:t,data:a,handleId:r,handleClassName:s,nodeSelectorClassName:l,showExceptionStatus:n}=e,{t:o}=(0,O.useTranslation)(),i=(0,eN.useStore)(e=>e.shouldAutoOpenStartNodeSelector),d=(0,eN.useStore)(e=>e.setShouldAutoOpenStartNodeSelector),c=(0,eN.useStore)(e=>e.setHasSelectedStartNode),u=(0,eN.useWorkflowStore)(),[p,m]=(0,y.useState)(!1),{handleNodeAdd:h}=(0,V.useNodesInteractions)(),{getNodesReadOnly:g}=(0,Z.useNodesReadOnly)(),{availableNextBlocks:f}=(0,X.useAvailableBlocks)(a.type,a.isInIteration||a.isInLoop),b=!!f.length,v=(0,Z.useIsChatMode)(),w=a._connectedSourceHandleIds?.includes(r),k=(0,y.useCallback)(e=>{m(e)},[]),N=(0,y.useCallback)(e=>{e.stopPropagation(),m(e=>!e)},[]),C=(0,y.useCallback)((e,a)=>{h({nodeType:e,pluginDefaultValue:a},{prevNodeId:t,prevNodeSourceHandle:r})},[h,t,r]);return(0,y.useEffect)(()=>{if(i){if(v)return void d?.(!1);(a.type===eb.BlockEnum.Start||a.type===eb.BlockEnum.TriggerSchedule||a.type===eb.BlockEnum.TriggerWebhook||a.type===eb.BlockEnum.TriggerPlugin)&&(m(!0),d?d(!1):u?.setState?.({shouldAutoOpenStartNodeSelector:!1}),c?c(!1):u?.setState?.({hasSelectedStartNode:!1}))}},[i,a.type,v,d,c,u]),(0,x.jsxs)(j.Handle,{id:r,type:"source",position:j.Position.Right,className:(0,T.cn)("group/handle z-[1] !h-4 !w-4 !rounded-none !border-none !bg-transparent !outline-none","after:absolute after:right-1.5 after:top-1 after:h-2 after:w-0.5 after:bg-workflow-link-line-handle","transition-all hover:scale-125",a._runningStatus===eb.NodeRunningStatus.Succeeded&&"after:bg-workflow-link-line-success-handle",a._runningStatus===eb.NodeRunningStatus.Failed&&"after:bg-workflow-link-line-error-handle",n&&a._runningStatus===eb.NodeRunningStatus.Exception&&"after:bg-workflow-link-line-failure-handle",!w&&"after:opacity-0",s),isConnectable:b,onClick:N,children:[(0,x.jsx)("div",{className:"absolute -top-1 left-1/2 hidden -translate-x-1/2 -translate-y-full rounded-lg border-[0.5px] border-components-panel-border bg-components-tooltip-bg p-1.5 shadow-lg group-hover/handle:block",children:(0,x.jsxs)("div",{className:"system-xs-regular text-text-tertiary",children:[(0,x.jsxs)("div",{className:" whitespace-nowrap",children:[(0,x.jsx)("span",{className:"system-xs-medium text-text-secondary",children:o("common.parallelTip.click.title",{ns:"workflow"})}),o("common.parallelTip.click.desc",{ns:"workflow"})]}),(0,x.jsxs)("div",{children:[(0,x.jsx)("span",{className:"system-xs-medium text-text-secondary",children:o("common.parallelTip.drag.title",{ns:"workflow"})}),o("common.parallelTip.drag.desc",{ns:"workflow"})]})]})}),b&&!g()&&(0,x.jsx)(eZ.default,{open:p,onOpenChange:k,onSelect:C,asChild:!0,triggerClassName:e=>`
              hidden absolute top-0 left-0 pointer-events-none
              ${l}
              group-hover:!flex
              ${a.selected&&"!flex"}
              ${e&&"!flex"}
            `,availableBlocksTypes:f})]})});aF.displayName="NodeSourceHandle";let aB=e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{error_strategy:s}=a,l=(0,j.useUpdateNodeInternals)();return((0,y.useEffect)(()=>{s===eH.ErrorHandleTypeEnum.failBranch&&l(t)},[s,t,l]),s)?(0,x.jsx)("div",{className:"relative px-3 pb-2 pt-1",children:(0,x.jsxs)("div",{className:(0,T.cn)("relative flex h-6 items-center justify-between rounded-md bg-workflow-block-parma-bg px-[5px]",a._runningStatus===eb.NodeRunningStatus.Exception&&"border-[0.5px] border-components-badge-status-light-warning-halo bg-state-warning-hover"),children:[(0,x.jsx)("div",{className:"system-xs-medium-uppercase text-text-tertiary",children:r("common.onFailure",{ns:"workflow"})}),(0,x.jsxs)("div",{className:(0,T.cn)("system-xs-medium text-text-secondary",a._runningStatus===eb.NodeRunningStatus.Exception&&"text-text-warning"),children:[s===eH.ErrorHandleTypeEnum.defaultValue&&r("nodes.common.errorHandle.defaultValue.output",{ns:"workflow"}),s===eH.ErrorHandleTypeEnum.failBranch&&r("nodes.common.errorHandle.failBranch.title",{ns:"workflow"})]}),s===eH.ErrorHandleTypeEnum.failBranch&&(0,x.jsx)(aF,{id:t,data:a,handleId:eH.ErrorHandleTypeEnum.failBranch,handleClassName:"!top-1/2 !-right-[21px] !-translate-y-1/2 after:!bg-workflow-link-line-failure-button-bg",nodeSelectorClassName:"!bg-workflow-link-line-failure-button-bg"})]})}):null};var F=F;let aD=(0,y.memo)(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),[s,l]=(0,y.useState)(!1),{handleNodeSelect:n}=(0,V.useNodesInteractions)(),o=(0,eN.useWorkflowStore)(),i=a._singleRunningStatus===eb.NodeRunningStatus.Running,d=(0,y.useCallback)(e=>{l(e)},[]),c=!!(a.isInIteration||a.isInLoop);return(0,x.jsx)("div",{className:`
      absolute -top-7 right-0 hidden h-7 pb-1
      ${!a._pluginInstallLocked&&"group-hover:flex"}
      ${a.selected&&"!flex"}
      ${s&&"!flex"}
      `,children:(0,x.jsxs)("div",{className:"flex h-6 items-center rounded-lg border-[0.5px] border-components-actionbar-border bg-components-actionbar-bg px-0.5 text-text-tertiary shadow-md backdrop-blur-[5px]",onClick:e=>e.stopPropagation(),children:[(0,eC.canRunBySingle)(a.type,c)&&(0,x.jsx)("div",{className:`flex h-5 w-5 items-center justify-center rounded-md ${i&&"cursor-pointer hover:bg-state-base-hover"}`,onClick:()=>{let e=o.getState();e.setInitShowLastRunTab(!0),e.setPendingSingleRun({nodeId:t,action:i?"stop":"run"}),n(t)},children:i?(0,x.jsx)(F.default,{className:"h-3 w-3"}):(0,x.jsx)(B.default,{popupContent:r("panel.runThisStep",{ns:"workflow"}),asChild:!1,children:(0,x.jsx)(M.RiPlayLargeLine,{className:"h-3 w-3"})})}),(0,x.jsx)(ta,{id:t,data:a,offset:0,onOpenChange:d,triggerClassName:"!w-5 !h-5"})]})})});var a$=e.i(796007),az=e.i(394481),aH=e.i(692423);(l=m||(m={})).Line="line",l.Handle="handle";let aW={width:0,height:0,x:0,y:0},aq={...aW,pointerX:0,pointerY:0,aspectRatio:1};var aU=(0,y.memo)(function(e){let{nodeId:t,position:a,variant:r=m.Handle,className:s,style:l={},children:n,color:o,minWidth:i=10,minHeight:d=10,maxWidth:c=Number.MAX_VALUE,maxHeight:u=Number.MAX_VALUE,keepAspectRatio:p=!1,shouldResize:x,onResizeStart:h,onResize:g,onResizeEnd:f}=e,b=(0,j.useNodeId)(),v="string"==typeof t?t:b,w=(0,j.useStoreApi)(),k=(0,y.useRef)(null),N=(0,y.useRef)(aq),C=(0,y.useRef)(aW),_=(0,j.useGetPointerPosition)(),T=r===m.Line?"right":"bottom-right",S=a??T;(0,y.useEffect)(()=>{if(!k.current||!v)return;let e=(0,aH.select)(k.current),t=S.includes("right")||S.includes("left"),a=S.includes("bottom")||S.includes("top"),r=S.includes("left"),s=S.includes("top"),l=(0,az.drag)().on("start",e=>{let t=w.getState().nodeInternals.get(v),{xSnapped:a,ySnapped:r}=_(e);C.current={width:t?.width??0,height:t?.height??0,x:t?.position.x??0,y:t?.position.y??0},N.current={...C.current,pointerX:a,pointerY:r,aspectRatio:C.current.width/C.current.height},h?.(e,{...C.current})}).on("drag",e=>{let{nodeInternals:l,triggerNodeChanges:n}=w.getState(),{xSnapped:o,ySnapped:m}=_(e),h=l.get(v);if(h){let l=[],{pointerX:f,pointerY:b,width:y,height:w,x:k,y:_,aspectRatio:T}=N.current,{x:S,y:E,width:V,height:I}=C.current,R=Math.floor(t?o-f:0),M=Math.floor(a?m-b:0),A=(0,j.clamp)(y+(r?-R:R),i,c),O=(0,j.clamp)(w+(s?-M:M),d,u);if(p){let e=A/O,r=t&&a;A=e<=T&&r||a&&!t?O*T:A,O=e>T&&r||t&&!a?A/T:O,A>=c?(A=c,O=c/T):A<=i&&(A=i,O=i/T),O>=u?(O=u,A=u*T):O<=d&&(O=d,A=d*T)}let P=A!==V,L=O!==I;if(r||s){let e=r?k-(A-y):k,t=s?_-(O-w):_,a=e!==S&&P,n=t!==E&&L;if(a||n){let r={id:h.id,type:"position",position:{x:a?e:S,y:n?t:E}};l.push(r),C.current.x=r.position.x,C.current.y=r.position.y}}if(P||L){let e={id:v,type:"dimensions",updateStyle:!0,resizing:!0,dimensions:{width:A,height:O}};l.push(e),C.current.width=A,C.current.height=O}if(0===l.length)return;let F=function(e){let{width:t,prevWidth:a,height:r,prevHeight:s,invertX:l,invertY:n}=e,o=t-a,i=r-s,d=[o>0?1:o<0?-1:0,i>0?1:i<0?-1:0];return o&&l&&(d[0]=-1*d[0]),i&&n&&(d[1]=-1*d[1]),d}({width:C.current.width,prevWidth:V,height:C.current.height,prevHeight:I,invertX:r,invertY:s}),B={...C.current,direction:F};if(!1===x?.(e,B))return;g?.(e,B),n(l)}}).on("end",e=>{f?.(e,{...C.current}),w.getState().triggerNodeChanges([{id:v,type:"dimensions",resizing:!1}])});return e.call(l),()=>{e.on(".drag",null)}},[v,S,i,d,c,u,p,_,h,g,f]);let E=S.split("-"),V=r===m.Line?"borderColor":"backgroundColor",I=o?{...l,[V]:o}:l;return y.default.createElement("div",{className:(0,a$.default)(["react-flow__resize-control","nodrag",...E,r,s]),ref:k,style:I},n)});let aK=()=>(0,x.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",children:(0,x.jsx)("path",{d:"M5.19009 11.8398C8.26416 10.6196 10.7144 8.16562 11.9297 5.08904",stroke:"black",strokeOpacity:"0.16",strokeWidth:"2",strokeLinecap:"round"})}),aG=(0,y.memo)(e=>{let{nodeId:t,nodeData:a,icon:r=(0,x.jsx)(aK,{}),minWidth:s=258,minHeight:l=152,maxWidth:n}=e,{handleNodeResize:o}=(0,V.useNodesInteractions)(),i=(0,y.useCallback)((e,a)=>{o(t,a)},[t,o]);return(0,x.jsx)("div",{className:(0,T.cn)("hidden group-hover:block",a.selected&&"!block"),children:(0,x.jsx)(aU,{position:"bottom-right",className:"!border-none !bg-transparent",onResize:i,minWidth:s,minHeight:l,maxWidth:n,children:(0,x.jsx)("div",{className:"absolute bottom-[1px] right-[1px]",children:r})})})}),aJ=e=>{let{data:t}=e,{t:a}=(0,O.useTranslation)(),{retry_config:r}=t,s=t.selected||t._isBundled||t._isEntering,{isRunning:l,isSuccessful:n,isException:o,isFailed:i}=(0,y.useMemo)(()=>({isRunning:t._runningStatus===eb.NodeRunningStatus.Running&&!s,isSuccessful:t._runningStatus===eb.NodeRunningStatus.Succeeded&&!s,isFailed:t._runningStatus===eb.NodeRunningStatus.Failed&&!s,isException:t._runningStatus===eb.NodeRunningStatus.Exception&&!s}),[t._runningStatus,s]),d=!l&&!n&&!o&&!i;return r?.retry_enabled&&(d||t._retryIndex)?(0,x.jsx)("div",{className:"mb-1 px-3",children:(0,x.jsxs)("div",{className:(0,T.cn)("system-xs-medium-uppercase flex items-center justify-between rounded-md border-[0.5px] border-transparent bg-workflow-block-parma-bg px-[5px] py-1 text-text-tertiary",l&&"border-state-accent-active bg-state-accent-hover text-text-accent",n&&"border-state-success-active bg-state-success-hover text-text-success",(o||i)&&"border-state-warning-active bg-state-warning-hover text-text-warning"),children:[(0,x.jsxs)("div",{className:"flex items-center",children:[d&&a("nodes.common.retry.retryTimes",{ns:"workflow",times:r.max_retries}),l&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(M.RiLoader2Line,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),a("nodes.common.retry.retrying",{ns:"workflow"})]}),n&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(M.RiCheckboxCircleFill,{className:"mr-1 h-3.5 w-3.5"}),a("nodes.common.retry.retrySuccessful",{ns:"workflow"})]}),(i||o)&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(M.RiAlertFill,{className:"mr-1 h-3.5 w-3.5"}),a("nodes.common.retry.retryFailed",{ns:"workflow"})]})]}),!d&&!!t._retryIndex&&(0,x.jsxs)("div",{children:[t._retryIndex,"/",t.retry_config?.max_retries]})]})}):null},aX=(0,y.memo)(e=>{let{id:t,data:a,children:r}=e,{t:s}=(0,O.useTranslation)(),l=(0,y.useRef)(null),{nodesReadOnly:n}=(0,Z.useNodesReadOnly)(),{handleNodeIterationChildSizeChange:o}=(0,aw.useNodeIterationInteractions)(),{handleNodeLoopChildSizeChange:i}=(0,aj.useNodeLoopInteractions)(),d=(0,ee.useToolIcon)(a);(0,y.useEffect)(()=>{if(l.current&&a.selected&&a.isInIteration){let e=new ResizeObserver(()=>{o(t)});return e.observe(l.current),()=>{e.disconnect()}}},[a.isInIteration,a.selected,t,o]),(0,y.useEffect)(()=>{if(l.current&&a.selected&&a.isInLoop){let e=new ResizeObserver(()=>{i(t)});return e.observe(l.current),()=>{e.disconnect()}}},[a.isInLoop,a.selected,t,i]);let{hasNodeInspectVars:c}=(0,ea.default)(),u=a._runningStatus===eb.NodeRunningStatus.Running||a._singleRunningStatus===eb.NodeRunningStatus.Running,p=c(t),m=a.selected||a._isBundled||a._isEntering,{showRunningBorder:h,showSuccessBorder:g,showFailedBorder:f,showExceptionBorder:b}=(0,y.useMemo)(()=>({showRunningBorder:a._runningStatus===eb.NodeRunningStatus.Running&&!m,showSuccessBorder:(a._runningStatus===eb.NodeRunningStatus.Succeeded||p)&&!m,showFailedBorder:a._runningStatus===eb.NodeRunningStatus.Failed&&!m,showExceptionBorder:a._runningStatus===eb.NodeRunningStatus.Exception&&!m}),[a._runningStatus,p,m]),v=(0,y.useMemo)(()=>{let e="";return(a._runningStatus===eb.NodeRunningStatus.Running&&(e=s("nodes.loop.currentLoopCount",{ns:"workflow",count:a._loopIndex})),(a._runningStatus===eb.NodeRunningStatus.Succeeded||a._runningStatus===eb.NodeRunningStatus.Failed)&&(e=s("nodes.loop.totalLoopCount",{ns:"workflow",count:a._loopIndex})),e)?(0,x.jsx)("div",{className:(0,T.cn)("system-xs-medium mr-2 text-text-tertiary",a._runningStatus===eb.NodeRunningStatus.Running&&"text-text-accent"),children:e}):null},[a._loopIndex,a._runningStatus,s]),w=(0,x.jsxs)("div",{className:(0,T.cn)("relative flex rounded-2xl border",m?"border-components-option-card-option-selected-border":"border-transparent",a._waitingRun&&"opacity-70",a._pluginInstallLocked&&"cursor-not-allowed"),ref:l,style:{width:a.type===eb.BlockEnum.Iteration||a.type===eb.BlockEnum.Loop?a.width:"auto",height:a.type===eb.BlockEnum.Iteration||a.type===eb.BlockEnum.Loop?a.height:"auto"},children:[(a._dimmed||a._pluginInstallLocked)&&(0,x.jsx)("div",{className:(0,T.cn)("absolute inset-0 rounded-2xl transition-opacity",a._pluginInstallLocked?"pointer-events-auto z-30 bg-workflow-block-parma-bg opacity-80 backdrop-blur-[2px]":"pointer-events-none z-20 bg-workflow-block-parma-bg opacity-50"),"data-testid":"workflow-node-install-overlay"}),a.type===eb.BlockEnum.DataSource&&(0,x.jsx)("div",{className:"absolute inset-[-2px] top-[-22px] z-[-1] rounded-[18px] bg-node-data-source-bg p-0.5 backdrop-blur-[6px]",children:(0,x.jsx)("div",{className:"system-2xs-semibold-uppercase flex h-5 items-center px-2.5 text-text-tertiary",children:s("blocks.datasource",{ns:"workflow"})})}),(0,x.jsxs)("div",{className:(0,T.cn)("group relative pb-1 shadow-xs","rounded-[15px] border border-transparent",a.type!==eb.BlockEnum.Iteration&&a.type!==eb.BlockEnum.Loop&&"w-[240px] bg-workflow-block-bg",(a.type===eb.BlockEnum.Iteration||a.type===eb.BlockEnum.Loop)&&"flex h-full w-full flex-col border-workflow-block-border bg-workflow-block-bg-transparent",!a._runningStatus&&"hover:shadow-lg",h&&"!border-state-accent-solid",g&&"!border-state-success-solid",f&&"!border-state-destructive-solid",b&&"!border-state-warning-solid",a._isBundled&&"!shadow-lg"),children:[a._showAddVariablePopup&&(0,x.jsx)(aA,{nodeId:t,nodeData:a}),a.type===eb.BlockEnum.Iteration&&(0,x.jsx)(aG,{nodeId:t,nodeData:a}),a.type===eb.BlockEnum.Loop&&(0,x.jsx)(aG,{nodeId:t,nodeData:a}),!a._isCandidate&&(0,x.jsx)(aL,{id:t,data:a,handleClassName:"!top-4 !-left-[9px] !translate-y-0",handleId:"target"}),a.type!==eb.BlockEnum.IfElse&&a.type!==eb.BlockEnum.QuestionClassifier&&!a._isCandidate&&(0,x.jsx)(aF,{id:t,data:a,handleClassName:"!top-4 !-right-[9px] !translate-y-0",handleId:"source"}),!a._runningStatus&&!n&&!a._isCandidate&&(0,x.jsx)(aD,{id:t,data:a}),(0,x.jsxs)("div",{className:(0,T.cn)("flex items-center rounded-t-2xl px-3 pb-2 pt-3",(a.type===eb.BlockEnum.Iteration||a.type===eb.BlockEnum.Loop)&&"bg-transparent"),children:[(0,x.jsx)(J.default,{className:"mr-2 shrink-0",type:a.type,size:"md",toolIcon:d}),(0,x.jsxs)("div",{title:a.title,className:"system-sm-semibold-uppercase mr-1 flex grow items-center truncate text-text-primary",children:[(0,x.jsx)("div",{children:a.title}),a.type===eb.BlockEnum.Iteration&&a.is_parallel&&(0,x.jsx)(B.default,{popupContent:(0,x.jsxs)("div",{className:"w-[180px]",children:[(0,x.jsx)("div",{className:"font-extrabold",children:s("nodes.iteration.parallelModeEnableTitle",{ns:"workflow"})}),s("nodes.iteration.parallelModeEnableDesc",{ns:"workflow"})]}),children:(0,x.jsx)("div",{className:"system-2xs-medium-uppercase ml-1 flex items-center justify-center rounded-[5px] border-[1px] border-text-warning px-[5px] py-[3px] text-text-warning ",children:s("nodes.iteration.parallelModeUpper",{ns:"workflow"})})})]}),!!(a._iterationLength&&a._iterationIndex&&a._runningStatus===eb.NodeRunningStatus.Running)&&(0,x.jsxs)("div",{className:"mr-1.5 text-xs font-medium text-text-accent",children:[a._iterationIndex>a._iterationLength?a._iterationLength:a._iterationIndex,"/",a._iterationLength]}),!!(a.type===eb.BlockEnum.Loop&&a._loopIndex)&&v,u?(0,x.jsx)(M.RiLoader2Line,{className:"h-3.5 w-3.5 animate-spin text-text-accent"}):a._runningStatus===eb.NodeRunningStatus.Failed?(0,x.jsx)(M.RiErrorWarningFill,{className:"h-3.5 w-3.5 text-text-destructive"}):a._runningStatus===eb.NodeRunningStatus.Exception?(0,x.jsx)(M.RiAlertFill,{className:"h-3.5 w-3.5 text-text-warning-secondary"}):a._runningStatus===eb.NodeRunningStatus.Succeeded||p?(0,x.jsx)(M.RiCheckboxCircleFill,{className:"h-3.5 w-3.5 text-text-success"}):null]}),a.type!==eb.BlockEnum.Iteration&&a.type!==eb.BlockEnum.Loop&&(0,y.cloneElement)(r,{id:t,data:a}),(a.type===eb.BlockEnum.Iteration||a.type===eb.BlockEnum.Loop)&&(0,x.jsx)("div",{className:"grow pb-1 pl-1 pr-1",children:(0,y.cloneElement)(r,{id:t,data:a})}),(0,e_.hasRetryNode)(a.type)&&(0,x.jsx)(aJ,{id:t,data:a}),(0,eC.hasErrorHandleNode)(a.type)&&(0,x.jsx)(aB,{id:t,data:a}),!!(a.desc&&a.type!==eb.BlockEnum.Iteration&&a.type!==eb.BlockEnum.Loop)&&(0,x.jsx)("div",{className:"system-xs-regular whitespace-pre-line break-words px-3 pb-2 pt-1 text-text-tertiary",children:a.desc}),a.type===eb.BlockEnum.Tool&&a.provider_type===av.ToolTypeEnum.MCP&&(0,x.jsx)("div",{className:"px-3 pb-2",children:(0,x.jsx)(aC,{content:a.provider_id||""})})]})]}),j=a.type===eb.BlockEnum.Start;return(0,eb.isTriggerNode)(a.type)||j?(0,x.jsx)(aP,{nodeType:j?aO.Start:aO.Trigger,children:w}):w});var aQ=e.i(566210);let aY=e=>{let{children:t,className:a,...r}=e;return(0,x.jsx)("div",{...r,className:(0,T.cn)("system-2xs-medium-uppercase mb-1 text-text-tertiary",a),children:t})},aZ=e=>{let{children:t,label:a}=e;return(0,x.jsxs)("div",{className:(0,T.cn)("py-1"),children:[a,(0,x.jsx)("div",{className:"space-y-0.5",children:t})]})};var a0=e.i(836340);let a1=(0,y.memo)(e=>{let{label:t,children:a,status:r,tooltip:s}=e,l="error"===r?"red":"warning"===r?"yellow":void 0,n=["error","warning"].includes(r);return(0,x.jsxs)("div",{className:"relative flex items-center justify-between space-x-1 rounded-md bg-workflow-block-parma-bg px-1.5 py-1 text-xs font-normal",children:[(0,x.jsx)("div",{className:(0,T.cn)("system-xs-medium-uppercase max-w-full shrink-0 truncate text-text-tertiary",!!a&&"max-w-[100px]"),children:t}),(0,x.jsx)(B.default,{popupContent:s,disabled:!n,children:(0,x.jsx)("div",{className:"system-xs-medium truncate text-right text-text-secondary",children:a})}),l&&(0,x.jsx)(a0.default,{color:l,className:"absolute -right-0.5 -top-0.5"})]})});a1.displayName="SettingItem";var a2=e.i(117960);let a5=e=>{let{t}=(0,O.useTranslation)(),a=(()=>{let{data:e}=(0,$.useModelList)(t0.ModelTypeEnum.textGeneration),{data:t}=(0,$.useModelList)(t0.ModelTypeEnum.moderation),{data:a}=(0,$.useModelList)(t0.ModelTypeEnum.rerank),{data:r}=(0,$.useModelList)(t0.ModelTypeEnum.speech2text),{data:s}=(0,$.useModelList)(t0.ModelTypeEnum.textEmbedding),{data:l}=(0,$.useModelList)(t0.ModelTypeEnum.tts),n=(0,y.useMemo)(()=>e.concat(t).concat(a).concat(r).concat(s).concat(l),[e,t,a,r,s,l]);if(e&&t&&a&&r&&s&&l)return n})();if(!("provider"in e))return(0,x.jsx)(B.default,{popupContent:t("nodes.agent.modelNotSelected",{ns:"workflow"}),triggerMethod:"hover",children:(0,x.jsxs)("div",{className:"relative",children:[(0,x.jsx)(a2.default,{modelList:[],triggerClassName:"bg-workflow-block-parma-bg !h-6 !rounded-md",defaultModel:void 0,showDeprecatedWarnIcon:!1,readonly:!0,deprecatedClassName:"opacity-50"}),(0,x.jsx)(a0.default,{color:"red",className:"absolute -right-0.5 -top-0.5"})]})});let r=a?.some(t=>t.provider===e.provider&&t.models.some(t=>t.model===e.model)),s=a&&!r;return a&&(0,x.jsx)(B.default,{popupContent:t("nodes.agent.modelNotInstallTooltip",{ns:"workflow"}),triggerMethod:"hover",disabled:!a||r,children:(0,x.jsxs)("div",{className:"relative",children:[(0,x.jsx)(a2.default,{modelList:a,triggerClassName:"bg-workflow-block-parma-bg !h-6 !rounded-md",defaultModel:e,showDeprecatedWarnIcon:!1,readonly:!0,deprecatedClassName:"opacity-50"}),s&&(0,x.jsx)(a0.default,{color:"red",className:"absolute -right-0.5 -top-0.5"})]})})};var a3=e.i(257899);e.i(36860);var a4=e.i(438270),a6=e.i(64732);let a8=(0,y.memo)(e=>{let{providerName:t}=e,a=(0,y.useRef)(null),{data:r}=(0,C.useAllBuiltInTools)(),{data:s}=(0,C.useAllCustomTools)(),{data:l}=(0,C.useAllWorkflowTools)(),{data:n}=(0,C.useAllMCPTools)(),o=!!r&&!!s&&!!l&&!!n,i=(0,y.useMemo)(()=>[...r||[],...s||[],...l||[],...n||[]].find(e=>e.name===t||e.id===t),[r,s,t,l,n]),d=t.split("/"),c=d[0],u=d[1],p=(0,y.useMemo)(()=>o?i?i.icon:(0,a6.getIconFromMarketPlace)(`${c}/${u}`):"",[c,i,u,o]),m=(0,y.useMemo)(()=>{if(o){if(!i)return"not-installed";if(!1===i.is_team_authorization)return"not-authorized"}},[i,o]),h="not-installed"===m?"red":"not-authorized"===m?"yellow":void 0,g=["not-installed","not-authorized"].includes(m),{t:f}=(0,O.useTranslation)(),b=(0,y.useMemo)(()=>{if(g){if("not-installed"===m)return f("nodes.agent.toolNotInstallTooltip",{ns:"workflow",tool:u});if("not-authorized"===m)return f("nodes.agent.toolNotAuthorizedTooltip",{ns:"workflow",tool:u});throw Error("Unknown status")}},[u,g,m,f]),[v,w]=(0,y.useState)(!1);return(0,x.jsx)(B.default,{triggerMethod:"hover",popupContent:b,disabled:!g,children:(0,x.jsxs)("div",{className:(0,T.cn)("relative"),ref:a,children:[(0,x.jsx)("div",{className:"flex size-5 items-center justify-center overflow-hidden rounded-[6px] border-[0.5px] border-components-panel-border-subtle bg-background-default-dodge",children:v||!p?(0,x.jsx)(a4.Group,{className:"h-3 w-3 opacity-35"}):"string"==typeof p?(0,x.jsx)("img",{src:p,alt:"tool icon",className:(0,T.cn)("size-3.5 h-full w-full object-cover",g&&"opacity-50"),onError:()=>w(!0)}):"object"==typeof p?(0,x.jsx)(a3.default,{className:(0,T.cn)("size-3.5 h-full w-full object-cover",g&&"opacity-50"),icon:p?.content,background:p?.background}):(0,x.jsx)(a4.Group,{className:"h-3 w-3 opacity-35"})}),h&&(0,x.jsx)(a0.default,{color:h,className:"absolute -right-[1px] -top-[1px]"})]})})});a8.displayName="ToolIcon";let a9=e=>{let{inputs:t,currentStrategy:a,currentStrategyStatus:r,pluginDetail:s}=t9(e.id,e.data),l=(0,aQ.useRenderI18nObject)(),{t:n}=(0,O.useTranslation)(),o=(0,y.useMemo)(()=>t&&a?.parameters.filter(e=>e.type===t0.FormTypeEnum.modelSelector).reduce((e,a)=>{let r=t.agent_parameters?.[a.name]?.value;if(!r)if(a.required)return e.push({param:a.name}),e;else return e;return e.push({provider:r.provider,model:r.model,param:a.name}),e},[])||[],[a,t]),i=(0,y.useMemo)(()=>{let e=[];return a?.parameters.forEach((a,r)=>{if(a.type===t0.FormTypeEnum.toolSelector){let s=a.name,l=t.agent_parameters?.[s]?.value;l&&e.push({id:`${a.name}-${r}`,providerName:l.provider_name})}if(a.type===t0.FormTypeEnum.multiToolSelector){let r=a.name,s=t.agent_parameters?.[r]?.value;s&&s.forEach((t,r)=>{e.push({id:`${a.name}-${r}`,providerName:t.provider_name})})}}),e},[a?.parameters,t.agent_parameters]);return(0,x.jsxs)("div",{className:"mb-1 space-y-1 px-3",children:[t.agent_strategy_name?(0,x.jsx)(a1,{label:n("nodes.agent.strategy.shortLabel",{ns:"workflow"}),status:r&&!r.isExistInPlugin?"error":void 0,tooltip:r&&!r.isExistInPlugin?n("nodes.agent.strategyNotInstallTooltip",{ns:"workflow",plugin:s?.declaration.label?l(s?.declaration.label):void 0,strategy:t.agent_strategy_label}):void 0,children:t.agent_strategy_label}):(0,x.jsx)(a1,{label:n("nodes.agent.strategyNotSet",{ns:"workflow"})}),o.length>0&&(0,x.jsx)(aZ,{label:(0,x.jsx)(aY,{className:"mt-1",children:n("nodes.agent.model",{ns:"workflow"})}),children:o.map(e=>(0,y.createElement)(a5,{...e,key:e.param}))}),i.length>0&&(0,x.jsx)(aZ,{label:(0,x.jsx)(aY,{className:"mt-1",children:n("nodes.agent.toolbox",{ns:"workflow"})}),children:(0,x.jsx)("div",{className:"grid grid-cols-10 gap-0.5",children:i.map((e,t)=>(0,y.createElement)(a8,{...e,key:e.id+t}))})})]})};a9.displayName="AgentNode";let a7=(0,y.memo)(a9);var re=e.i(523614),rt=e.i(554327);e.i(916131);var ra=e.i(507357),rr=e.i(802859),rs=e.i(64997),rl=e.i(633957),rn=e.i(710522),ro=e.i(123706),ri=e.i(453284),rd=e.i(780783),rc=e.i(222573),ru=e.i(351797),rp=e.i(944911),rm=e.i(225981),rx=e.i(494268),rh=e.i(179377),rg=e.i(831646),rf=e.i(958865),rb=e.i(350988);let ry=[],rv=e=>{let{title:t,description:a}=e,{t:r}=(0,O.useTranslation)();return(0,x.jsx)(B.default,{popupContent:(0,x.jsxs)("div",{className:"space-y-1 text-xs",children:[(0,x.jsx)("h3",{className:"font-semibold text-text-primary",children:t}),(0,x.jsx)("p",{className:"tracking-tight text-text-secondary",children:a}),(0,x.jsx)("p",{children:(0,x.jsx)(rt.default,{href:"/plugins",className:"tracking-tight text-text-accent",children:r("nodes.agent.linkToPlugin",{ns:"workflow"})})})]}),children:(0,x.jsx)("div",{children:(0,x.jsx)(M.RiErrorWarningFill,{className:"size-4 text-text-destructive"})})})},rw=(0,y.memo)(e=>{var t;let{enable_marketplace:a}=(0,rx.useGlobalPublicStore)(e=>e.systemFeatures),{value:r,onChange:s}=e,[l,n]=(0,y.useState)(!1),[o,i]=(0,y.useState)(rg.ViewType.flat),[d,c]=(0,y.useState)(""),u=(0,t5.useStrategyProviders)(),{getIconUrl:p}=(0,rc.default)(),m=u.data?(t=u.data,t.map(e=>({id:e.plugin_unique_identifier,author:e.declaration.identity.author,name:e.declaration.identity.name,description:e.declaration.identity.description,plugin_id:e.plugin_id,icon:p(e.declaration.identity.icon),label:e.declaration.identity.label,type:e9.CollectionType.all,meta:e.meta,tools:e.declaration.strategies.map(e=>({name:e.identity.name,author:e.identity.author,label:e.identity.label,description:e.description,parameters:e.parameters,output_schema:e.output_schema,labels:[]})),team_credentials:{},is_team_authorization:!0,allow_delete:!1,labels:[]}))):void 0,h=(0,y.useMemo)(()=>m?m.filter(e=>e.name.toLowerCase().includes(d.toLowerCase())):[],[d,m]),{strategyStatus:g,refetch:f}=t8(r?.agent_strategy_provider_name,r?.agent_strategy_name),b=g?.plugin?.source==="external"&&!g.plugin.installed&&!!r,v=g?.plugin.source==="external"&&!g?.isExistInPlugin&&!!r,w=!g?.isExistInPlugin&&g?.plugin.source==="marketplace"&&g.plugin.installed&&!!r,j=!g?.isExistInPlugin&&g?.plugin.source==="marketplace"&&!g.plugin.installed&&!!r,k=m?.find(e=>e.tools?.find(e=>e.name===r?.agent_strategy_name))?.icon,{t:N}=(0,O.useTranslation)(),C=(0,y.useRef)(null),{queryPluginsWithDebounced:_,plugins:S=[]}=(0,ru.useMarketplacePlugins)();(0,y.useEffect)(()=>{a&&d&&_({query:d,category:rp.PluginCategoryEnum.agent})},[d]);let E=(0,y.useRef)(null);return(0,x.jsxs)(ez.PortalToFollowElem,{open:l,onOpenChange:n,placement:"bottom",children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{className:"w-full",children:(0,x.jsxs)("div",{className:"flex h-8 w-full select-none items-center gap-0.5 rounded-lg bg-components-input-bg-normal p-1 hover:bg-state-base-hover-alt",onClick:()=>n(e=>!e),children:[k&&(0,x.jsx)("div",{className:"flex h-6 w-6 items-center justify-center",children:(0,x.jsx)("img",{src:k,width:20,height:20,className:"rounded-md border-[0.5px] border-components-panel-border-subtle bg-background-default-dodge",alt:"icon"})}),(0,x.jsx)("p",{className:(0,T.cn)(r?"text-components-input-text-filled":"text-components-input-text-placeholder","px-1 text-xs"),children:r?.agent_strategy_label||N("nodes.agent.strategy.selectTip",{ns:"workflow"})}),(0,x.jsxs)("div",{className:"ml-auto flex items-center gap-1",children:[j&&r&&(0,x.jsx)(rf.InstallPluginButton,{onClick:e=>e.stopPropagation(),size:"small",uniqueIdentifier:r.plugin_unique_identifier}),b?(0,x.jsx)(rv,{title:N("nodes.agent.pluginNotInstalled",{ns:"workflow"}),description:N("nodes.agent.pluginNotInstalledDesc",{ns:"workflow"})}):v?(0,x.jsx)(rv,{title:N("nodes.agent.unsupportedStrategy",{ns:"workflow"}),description:N("nodes.agent.strategyNotFoundDesc",{ns:"workflow"})}):(0,x.jsx)(M.RiArrowDownSLine,{className:"size-4 text-text-tertiary"}),w&&(0,x.jsx)(rb.SwitchPluginVersion,{uniqueIdentifier:r.plugin_unique_identifier,tooltip:(0,x.jsx)(rd.ToolTipContent,{title:N("nodes.agent.unsupportedStrategy",{ns:"workflow"}),children:N("nodes.agent.strategyNotFoundDescAndSwitchVersion",{ns:"workflow"})}),onChange:()=>{f()}})]})]})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-10",children:(0,x.jsxs)("div",{className:"w-[388px] overflow-hidden rounded-md border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow",children:[(0,x.jsxs)("header",{className:"flex gap-1 p-2",children:[(0,x.jsx)(ri.default,{placeholder:N("nodes.agent.strategy.searchPlaceholder",{ns:"workflow"}),value:d,onChange:c,className:"w-full"}),(0,x.jsx)(rg.default,{viewType:o,onChange:i})]}),(0,x.jsxs)("main",{className:"relative flex w-full flex-col overflow-hidden md:max-h-[300px] xl:max-h-[400px] 2xl:max-h-[564px]",ref:C,children:[(0,x.jsx)(rh.default,{tools:h,viewType:o,onSelect:(e,t)=>{s({agent_strategy_name:t.tool_name,agent_strategy_provider_name:t.provider_name,agent_strategy_label:t.tool_label,agent_output_schema:t.output_schema||{},plugin_unique_identifier:t.provider_id,meta:t.meta}),n(!1)},className:"h-full max-h-full max-w-none overflow-y-auto",indexBarClassName:"top-0 xl:top-36",hasSearchText:!1,canNotSelectMultiple:!0,isAgent:!0}),a&&(0,x.jsx)(rm.default,{ref:E,wrapElemRef:C,list:S,searchText:d,tags:ry,category:rp.PluginCategoryEnum.agent,disableMaxWidth:!0})]})]})})]})});rw.displayName="AgentStrategySelector";let rj=y.memo(e=>{let{className:t,title:a,isSubTitle:r,tooltip:s,children:l,operations:n,inline:o,supportFold:i,required:d}=e,[c,{toggle:u}]=(0,an.useBoolean)(!0);return(0,x.jsxs)("div",{className:(0,T.cn)(t,o&&"flex w-full items-center justify-between"),children:[(0,x.jsxs)("div",{onClick:()=>i&&u(),className:(0,T.cn)("flex items-center justify-between",i&&"cursor-pointer"),children:[(0,x.jsxs)("div",{className:"flex h-6 items-center",children:[(0,x.jsxs)("div",{className:(0,T.cn)(r?"system-xs-medium-uppercase text-text-tertiary":"system-sm-semibold-uppercase text-text-secondary"),children:[a," ",d&&(0,x.jsx)("span",{className:"text-text-destructive",children:"*"})]}),!!s&&(0,x.jsx)(B.default,{popupContent:s,popupClassName:"ml-1",triggerClassName:"w-4 h-4 ml-1"})]}),(0,x.jsxs)("div",{className:"flex",children:[!!n&&(0,x.jsx)("div",{children:n}),i&&(0,x.jsx)(M.RiArrowDownSLine,{className:"h-4 w-4 cursor-pointer text-text-tertiary transition-transform",style:{transform:c?"rotate(-90deg)":"rotate(0deg)"}})]})]}),!!(l&&(!i||i&&!c))&&(0,x.jsx)("div",{className:(0,T.cn)(!o&&"mt-1"),children:l})]})});var rk=e.i(654313);e.i(21511);var rN=e.i(389600),rC=e.i(751489);e.i(39598);var r_=e.i(678383),rT=e.i(101588),rT=rT,rS=e.i(758911),rE=e.i(484072),rV=e.i(688393);let rI=y.memo(e=>{let{availableVars:t,varList:a,onAddVar:r,...s}=e,{t:l}=(0,O.useTranslation)(),n=(0,y.useRef)(!1),o=(0,y.useRef)(null),i=(0,y.useRef)(null),d=(0,y.useRef)(null),[c,{setTrue:u,setFalse:p}]=(0,an.useBoolean)(!1),[m,h]=(0,y.useState)({x:0,y:0}),g=e=>{let t=o.current,{position:a}=e,r=t.getModel().getLineContent(a.lineNumber)[a.column-2];if(["/","{"].includes(r)){n.current="{"===r;let e=t.getDomNode().getBoundingClientRect(),s=t.getScrolledVisiblePosition(a);h({x:e.left+s.left,y:e.top+s.top+20}),u()}else p()};(0,y.useEffect)(()=>{if(c&&d.current){let e=window.innerWidth,{width:t,height:a}=d.current.getBoundingClientRect(),r={...m};m.x+t>e-8&&(r.x=e-t-8),m.y+a>window.innerHeight-8&&(r.y=window.innerHeight-a-8),(r.x!==m.x||r.y!==m.y)&&h(r)}},[c,m]);let f=e=>{if(a.find(t=>t.variable===e)){let t=/_(\d+)$/.exec(e),a=t?Number.parseInt(t[1])+1:1;return f(`${e.replace(/_(\d+)$/,"")}_${a}`)}return e};return(0,x.jsxs)("div",{className:(0,T.cn)(s.isExpand&&"h-full"),children:[(0,x.jsx)(eB.default,{...s,onMount:(e,t)=>{o.current=e,i.current=t,e.onDidChangeCursorPosition(g)},placeholder:l("common.jinjaEditorPlaceholder",{ns:"workflow"})}),c&&(0,rV.createPortal)((0,x.jsx)("div",{ref:d,className:"w-[228px] space-y-1 rounded-lg border border-components-panel-border bg-components-panel-bg p-1 shadow-lg",style:{position:"fixed",top:m.y,left:m.x,zIndex:100},children:(0,x.jsx)(aR.default,{hideSearch:!0,vars:t,onChange:e=>{let t,{name:s,isExist:l}=(t=a.find(t=>Array.isArray(t.value_selector)&&t.value_selector.join("@@@")===e.join("@@@")))?{name:t.variable,isExist:!0}:{name:f(e.slice(-1)[0]),isExist:!1};l||r?.({variable:s,value_selector:e});let d=o.current,c=i.current,u=d?.getPosition();d?.executeEdits("",[{range:new c.Range(u.lineNumber,u.column-1,u.lineNumber,u.column),text:`{{ ${s} }${!n.current?"}":""}`}]),p()},isSupportFileVar:!1})}),document.body)]})});var rR=e.i(485587),rM=e.i(280388),rA=e.i(514112),rO=e.i(705557);let rP=y.memo(e=>{let{className:t,onGenerated:a,nodeId:r,editorId:s,currentPrompt:l}=e,[n,{setTrue:o,setFalse:i}]=(0,an.useBoolean)(!1),d=(0,y.useCallback)(e=>{a?.(e.modified),i()},[a,i]),c=(0,et.useHooksStore)(e=>e.configsMap);return(0,x.jsxs)("div",{className:(0,T.cn)(t),children:[(0,x.jsx)(rk.ActionButton,{className:"hover:bg-[#155EFF]/8",onClick:o,children:(0,x.jsx)(rO.Generator,{className:"h-4 w-4 text-primary-600"})}),n&&(0,x.jsx)(rA.default,{mode:eg.AppModeEnum.CHAT,isShow:n,onClose:i,onFinished:d,flowId:c?.flowId||"",nodeId:r,editorId:s,currentPrompt:l})]})});var rL=e.i(882262);let rF=y.memo(e=>{let{className:t,headerClassName:a,instanceId:r,nodeId:s,editorId:l,title:n,value:o,onChange:i,readOnly:d,showRemove:c,onRemove:u,justVar:p,isChatModel:m,isChatApp:h,isShowContext:g,hasSetBlockStatus:f,nodesOutputVars:b,availableNodes:v=[],isSupportFileVar:w,isSupportPromptGenerator:j,isSupportJinja:k,editionType:C,onEditionTypeChange:_,varList:S=[],handleAddVariable:E,onGenerated:V,modelConfig:I,containerBackgroundClassName:R,gradientBorder:A=!0,titleTooltip:P,inputClassName:L,placeholder:F,placeholderClassName:D,titleClassName:$,editorContainerClassName:z,required:H}=e,{t:W}=(0,O.useTranslation)(),{eventEmitter:q}=(0,N.useEventEmitterContextContext)(),U=(0,eN.useStore)(e=>e.controlPromptEditorRerenderKey),K=(0,y.useRef)(null),{wrapClassName:G,wrapStyle:J,isExpand:X,setIsExpand:Q,editorExpandHeight:Y}=(0,rM.default)({ref:K,isInNode:!0}),[Z,ee]=y.useState(!1),et=(0,y.useCallback)(()=>{(0,ak.default)(o),ee(!0)},[o]),[ea,{setTrue:er,setFalse:es}]=(0,an.useBoolean)(!1),el=(0,aT.useWorkflowVariableType)(),en=(0,eN.useStore)(e=>e.pipelineId),eo=(0,eN.useStore)(e=>e.setShowInputFieldPanel);return(0,x.jsx)(rL.default,{className:(0,T.cn)(t,G),style:J,isInNode:!0,isExpand:X,children:(0,x.jsx)("div",{ref:K,className:(0,T.cn)(ea?A&&"bg-gradient-to-r from-components-input-border-active-prompt-1 to-components-input-border-active-prompt-2":"bg-transparent",X&&"h-full","!rounded-[9px] p-0.5",R),children:(0,x.jsxs)("div",{className:(0,T.cn)(ea?"bg-background-default":"bg-components-input-bg-normal",X&&"flex h-full flex-col","rounded-lg",R),children:[(0,x.jsxs)("div",{className:(0,T.cn)("flex items-center justify-between pl-3 pr-2 pt-1",a),children:[(0,x.jsxs)("div",{className:"flex gap-2",children:[(0,x.jsxs)("div",{className:(0,T.cn)("text-xs font-semibold uppercase leading-4 text-text-secondary",$),children:[n," ",H&&(0,x.jsx)("span",{className:"text-text-destructive",children:"*"})]}),!!P&&(0,x.jsx)(B.default,{popupContent:P})]}),(0,x.jsxs)("div",{className:"flex items-center",children:[(0,x.jsx)("div",{className:"text-xs font-medium leading-[18px] text-text-tertiary",children:o?.length||0}),j&&(0,x.jsx)(rP,{nodeId:s,editorId:l,className:"ml-[5px]",onGenerated:V,modelConfig:I,currentPrompt:o}),(0,x.jsx)("div",{className:"ml-2 mr-2 h-3 w-px bg-divider-regular"}),(0,x.jsxs)("div",{className:"flex items-center space-x-[2px]",children:[k&&(0,x.jsx)(B.default,{popupContent:(0,x.jsxs)("div",{children:[(0,x.jsx)("div",{children:W("common.enableJinja",{ns:"workflow"})}),(0,x.jsx)("a",{className:"text-text-accent",target:"_blank",href:"https://jinja.palletsprojects.com/en/2.10.x/",children:W("common.learnMore",{ns:"workflow"})})]}),children:(0,x.jsxs)("div",{className:(0,T.cn)(C===eb.EditionType.jinja2&&"border-components-button-ghost-bg-hover bg-components-button-ghost-bg-hover","flex h-[22px] items-center space-x-0.5 rounded-[5px] border border-transparent px-1.5 hover:border-components-button-ghost-bg-hover"),children:[(0,x.jsx)(rT.default,{className:"h-3 w-6 text-text-quaternary"}),(0,x.jsx)(ts.default,{size:"sm",defaultValue:C===eb.EditionType.jinja2,onChange:e=>{_?.(e?eb.EditionType.jinja2:eb.EditionType.basic)}})]})}),!d&&(0,x.jsx)(B.default,{popupContent:`${W("common.insertVarTip",{ns:"workflow"})}`,children:(0,x.jsx)(rk.default,{onClick:()=>{er(),q?.emit({type:rE.PROMPT_EDITOR_INSERT_QUICKLY,instanceId:r})},children:(0,x.jsx)(r_.Variable02,{className:"h-4 w-4"})})}),c&&(0,x.jsx)(rk.default,{onClick:u,children:(0,x.jsx)(M.RiDeleteBinLine,{className:"h-4 w-4"})}),Z?(0,x.jsx)(rk.default,{children:(0,x.jsx)(rC.CopyCheck,{className:"h-4 w-4"})}):(0,x.jsx)(rk.default,{onClick:et,children:(0,x.jsx)(rN.Copy,{className:"h-4 w-4"})}),(0,x.jsx)(rR.default,{isExpand:X,onExpandChange:Q})]})]})]}),(0,x.jsx)("div",{className:(0,T.cn)("pb-2",X&&"flex grow flex-col"),children:k&&C===eb.EditionType.jinja2?(0,x.jsx)("div",{className:(0,T.cn)(X?"grow":"max-h-[536px]","relative min-h-[56px] overflow-y-auto  px-3",z),children:(0,x.jsx)(rI,{availableVars:b||[],varList:S,onAddVar:E,isInNode:!0,readOnly:d,language:eD.CodeLanguage.python3,value:o,onChange:i,noWrapper:!0,isExpand:X,className:L})}):(0,x.jsxs)("div",{className:(0,T.cn)(X?"grow":"max-h-[536px]","relative min-h-[56px] overflow-y-auto  px-3",z),children:[(0,x.jsx)(rS.default,{placeholder:F,placeholderClassName:D,instanceId:r,compact:!0,className:(0,T.cn)("min-h-[56px]",L),style:X?{height:Y-5}:{},value:o,contextBlock:{show:!p&&g,selectable:!f?.context,canNotAddContext:!0},historyBlock:{show:!p&&!m&&h,selectable:!f?.history,history:{user:"Human",assistant:"Assistant"}},queryBlock:{show:!1,selectable:!1},workflowVariableBlock:{show:!0,variables:b||[],getVarType:el,workflowNodesMap:v.reduce((e,t)=>(e[t.id]={title:t.data.title,type:t.data.type,width:t.width,height:t.height,position:t.position},t.data.type===eb.BlockEnum.Start&&(e.sys={title:W("blocks.start",{ns:"workflow"}),type:eb.BlockEnum.Start}),e),{}),showManageInputField:!!en,onManageInputField:()=>eo?.(!0)},onChange:i,onBlur:es,onFocus:er,editable:!d,isSupportFileVar:w},U),d&&(0,x.jsx)("div",{className:"absolute inset-0 z-10"})]})})]})})})}),rB=(0,y.memo)(e=>{let{strategy:t,onStrategyChange:a,formSchema:r,formValue:s,onFormValueChange:l,nodeOutputVars:n,availableNodes:o,nodeId:i}=e,{t:d}=(0,O.useTranslation)(),c=(0,eq.useDocLink)(),u=(0,$.useDefaultModel)(t0.ModelTypeEnum.textGeneration),p=(0,aQ.useRenderI18nObject)(),{setControlPromptEditorRerenderKey:m}=(0,eN.useWorkflowStore)().getState(),h=[[t0.FormTypeEnum.textNumber,t0.FormTypeEnum.textInput],(e,t)=>{switch(e.type){case t0.FormTypeEnum.textInput:{let a=t.value[e.variable]||e.default,r=e.variable,s=a=>{t.onChange({...t.value,[e.variable]:a})};return(0,x.jsx)(rF,{value:a,onChange:s,onGenerated:e=>{s(e),m(Math.random())},instanceId:r,title:p(e.label),headerClassName:"bg-transparent px-0 text-text-secondary system-sm-semibold-uppercase",containerBackgroundClassName:"bg-transparent",gradientBorder:!1,nodeId:i,isSupportPromptGenerator:!!e.auto_generate?.type,titleTooltip:e.tooltip&&p(e.tooltip),editorContainerClassName:"px-0 bg-components-input-bg-normal focus-within:bg-components-input-bg-active rounded-lg",availableNodes:o,nodesOutputVars:n,isSupportJinja:e.template?.enabled,required:e.required,varList:[],modelConfig:u.data?{mode:eg.AppModeEnum.CHAT,name:u.data.model,provider:u.data.provider.provider,completion_params:{}}:void 0,placeholderClassName:"px-2 py-1",titleClassName:"system-sm-semibold-uppercase text-text-secondary text-[13px]",inputClassName:"px-2 py-1"},r)}case t0.FormTypeEnum.textNumber:{if(!e.max||!e.min)return!1;let a=e.default?Number.parseInt(e.default):1,r=t.value[e.variable]||a,s=a=>{t.onChange({...t.value,[e.variable]:a})};return(0,x.jsx)(rj,{title:(0,x.jsxs)(x.Fragment,{children:[p(e.label)," ",e.required&&(0,x.jsx)("span",{className:"text-red-500",children:"*"})]}),tooltip:e.tooltip&&p(e.tooltip),inline:!0,children:(0,x.jsxs)("div",{className:"flex w-[200px] items-center gap-3",children:[(0,x.jsx)(tr.default,{value:r,onChange:s,className:"w-full",min:e.min,max:e.max}),(0,x.jsx)(rr.InputNumber,{value:r,onChange:s,defaultValue:a,size:"regular",min:e.min,max:e.max,className:"w-12"})]})},e.variable)}}}];return(0,x.jsxs)("div",{className:"space-y-2",children:[(0,x.jsx)(rw,{value:t,onChange:a}),t?(0,x.jsx)("div",{children:(0,x.jsx)(rl.default,{formSchemas:[...r],value:s,onChange:l,validating:!1,showOnVariableMap:{},isEditMode:!0,isAgentStrategy:!0,fieldLabelClassName:"uppercase",customRenderField:(e,t)=>{switch(e.type){case t0.FormTypeEnum.toolSelector:{let a=t.value[e.variable],r=a=>{t.onChange({...t.value,[e.variable]:a})};return(0,x.jsx)(rj,{title:(0,x.jsxs)(x.Fragment,{children:[p(e.label)," ",e.required&&(0,x.jsx)("span",{className:"text-red-500",children:"*"})]}),tooltip:e.tooltip&&p(e.tooltip),children:(0,x.jsx)(ro.default,{nodeId:t.nodeId||"",nodeOutputVars:t.nodeOutputVars||[],availableNodes:t.availableNodes||[],scope:e.scope,value:a,onSelect:e=>r(e),onDelete:()=>r(null),onSelectMultiple:tg.noop})})}case t0.FormTypeEnum.multiToolSelector:{let a=t.value[e.variable];return(0,x.jsx)(rn.default,{nodeId:t.nodeId||"",nodeOutputVars:t.nodeOutputVars||[],availableNodes:t.availableNodes||[],scope:e.scope,value:a||[],label:p(e.label),tooltip:e.tooltip&&p(e.tooltip),onChange:a=>{t.onChange({...t.value,[e.variable]:a})},supportCollapse:!0,required:e.required})}}},override:h,nodeId:i,nodeOutputVars:n||[],availableNodes:o||[]})}):(0,x.jsx)(rs.default,{icon:(0,x.jsx)(ra.Agent,{className:"h-5 w-5 shrink-0 text-text-accent"}),title:d("nodes.agent.strategy.configureTip",{ns:"workflow"}),description:(0,x.jsxs)("div",{className:"text-xs text-text-tertiary",children:[d("nodes.agent.strategy.configureTipDesc",{ns:"workflow"})," ",(0,x.jsx)("br",{}),(0,x.jsx)(rt.default,{href:c("/use-dify/nodes/agent"),className:"text-text-accent-secondary",target:"_blank",children:d("nodes.agent.learnMore",{ns:"workflow"})})]})})]})});rB.displayName="AgentStrategy";var rD=e.i(802105);let r$="nodes.common.memory",rz=e=>{let{readonly:t,title:a,value:r,onChange:s}=e,l=(0,y.useCallback)(e=>{s(e.target.value)},[s]);return(0,x.jsxs)("div",{className:"flex items-center justify-between",children:[(0,x.jsx)("div",{className:"text-[13px] font-normal text-text-secondary",children:a}),(0,x.jsx)(eF.default,{readOnly:t,value:r,onChange:l,className:"h-8 w-[200px]",type:"text"})]})},rH={window:{enabled:!1,size:50},query_prompt_template:"{{#sys.query#}}\n\n{{#sys.files#}}"},rW=y.memo(e=>{let{className:t,readonly:a,config:r={data:rH},onChange:s,canSetRoleName:l=!1}=e,{t:n}=(0,O.useTranslation)(),o=r.data,i=(0,y.useCallback)(e=>{s(e?rH:void 0)},[s]),d=(0,y.useCallback)(e=>{s((0,f.produce)(r.data||rH,t=>{t.window||(t.window={enabled:!1,size:50}),t.window.enabled=e}))},[r,s]),c=(0,y.useCallback)(e=>{s((0,f.produce)(o||rH,t=>{t.window||(t.window={enabled:!0,size:50});let a=e;""===a?a=null:(isNaN(a=Number.parseInt(a,10))&&(a=50),a<1&&(a=1),a>100&&(a=100)),t.window.size=a}))},[o,s]),u=(0,y.useCallback)(()=>{let e=r.data;e&&(""===e.window.size||null===e.window.size)&&c(50)},[c,r]),p=(0,y.useCallback)(e=>t=>{s((0,f.produce)(r.data||rH,a=>{a.role_prefix||(a.role_prefix={user:"",assistant:""}),a.role_prefix[e]=t}))},[r,s]);return(0,x.jsx)("div",{className:(0,T.cn)(t),children:(0,x.jsx)(rj,{title:n(`${r$}.memory`,{ns:"workflow"}),tooltip:n(`${r$}.memoryTip`,{ns:"workflow"}),operations:(0,x.jsx)(ts.default,{defaultValue:!!o,onChange:i,size:"md",disabled:a}),children:o&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)("div",{className:"flex justify-between",children:[(0,x.jsxs)("div",{className:"flex h-8 items-center space-x-2",children:[(0,x.jsx)(ts.default,{defaultValue:o?.window?.enabled,onChange:d,size:"md",disabled:a}),(0,x.jsx)("div",{className:"system-xs-medium-uppercase text-text-tertiary",children:n(`${r$}.windowSize`,{ns:"workflow"})})]}),(0,x.jsxs)("div",{className:"flex h-8 items-center space-x-2",children:[(0,x.jsx)(tr.default,{className:"w-[144px]",value:o.window?.size||50,min:1,max:100,step:1,onChange:c,disabled:a||!o.window?.enabled}),(0,x.jsx)(eF.default,{value:o.window?.size||50,wrapperClassName:"w-12",className:"appearance-none pr-0",type:"number",min:1,max:100,step:1,onChange:e=>c(e.target.value),onBlur:u,disabled:a||!o.window?.enabled})]})]}),l&&(0,x.jsxs)("div",{className:"mt-4",children:[(0,x.jsx)("div",{className:"text-xs font-medium uppercase leading-6 text-text-tertiary",children:n(`${r$}.conversationRoleName`,{ns:"workflow"})}),(0,x.jsxs)("div",{className:"mt-1 space-y-2",children:[(0,x.jsx)(rz,{readonly:a,title:n(`${r$}.user`,{ns:"workflow"}),value:o.role_prefix?.user||"",onChange:p(eb.MemoryRole.user)}),(0,x.jsx)(rz,{readonly:a,title:n(`${r$}.assistant`,{ns:"workflow"}),value:o.role_prefix?.assistant||"",onChange:p(eb.MemoryRole.assistant)})]})]})]})})})});var rq=e.i(160659),rq=rq,rU=e.i(942695);let rK=e=>{let{name:t,type:a,description:r,subItems:s,isIndent:l}=e;return(0,x.jsxs)("div",{className:(0,T.cn)("flex",l&&"relative left-[-7px]"),children:[l&&(0,x.jsx)(rU.default,{depth:1}),(0,x.jsxs)("div",{className:"py-1",children:[(0,x.jsx)("div",{className:"flex",children:(0,x.jsxs)("div",{className:"flex items-center leading-[18px]",children:[(0,x.jsx)("div",{className:"code-sm-semibold text-text-secondary",children:t}),(0,x.jsx)("div",{className:"system-xs-regular ml-2 text-text-tertiary",children:a})]})}),(0,x.jsxs)("div",{className:"system-xs-regular mt-0.5 text-text-tertiary",children:[r,s&&(0,x.jsx)("div",{className:"ml-2 border-l border-gray-200 pl-2",children:s.map((e,t)=>(0,x.jsx)(rK,{name:e.name,type:e.type,description:e.description},t))})]})]})]})},rG=y.memo(e=>{let{title:t,children:a,operations:r,collapsed:s,onCollapse:l}=e,{t:n}=(0,O.useTranslation)();return(0,x.jsx)(rq.default,{title:t||n("nodes.common.outputVars",{ns:"workflow"}),operations:r,collapsed:s,onCollapse:l,children:a})});var rJ=((n={}).HISTORY_MESSAGES="history-messages",n);let rX="nodes.agent";function rQ(e){return{...e,variable:e.name,show_on:[],type:(0,t1.toType)(e.type),tooltip:e.help}}let rY=e=>{var t;let{inputs:a,setInputs:r,currentStrategy:s,formData:l,onFormChange:n,isChatMode:o,availableNodesWithParent:i,availableVars:d,readOnly:c,outputSchema:u,handleMemoryChange:p}=t9(e.id,e.data),{t:m}=(0,O.useTranslation)(),h=!!(t=a.meta?.version)&&(0,re.isEqualOrLaterThanVersion)(t,"0.0.2"),g=(0,eN.useStore)(e=>e.setControlPromptEditorRerenderKey);return(0,x.jsxs)("div",{className:"my-2",children:[(0,x.jsx)(rj,{required:!0,title:m("nodes.agent.strategy.label",{ns:"workflow"}),className:"px-4 py-2",tooltip:m("nodes.agent.strategy.tooltip",{ns:"workflow"}),children:(0,x.jsx)(rD.MCPToolAvailabilityProvider,{versionSupported:h,children:(0,x.jsx)(rB,{strategy:a.agent_strategy_name?{agent_strategy_provider_name:a.agent_strategy_provider_name,agent_strategy_name:a.agent_strategy_name,agent_strategy_label:a.agent_strategy_label,agent_output_schema:a.output_schema,plugin_unique_identifier:a.plugin_unique_identifier,meta:a.meta}:void 0,onStrategyChange:e=>{r({...a,agent_strategy_provider_name:e?.agent_strategy_provider_name,agent_strategy_name:e?.agent_strategy_name,agent_strategy_label:e?.agent_strategy_label,output_schema:e.agent_output_schema,plugin_unique_identifier:e.plugin_unique_identifier,meta:e?.meta}),g(Date.now())},formSchema:s?.parameters?.map(rQ)||[],formValue:l,onFormValueChange:n,nodeOutputVars:d,availableNodes:i,nodeId:e.id})})}),(0,x.jsx)("div",{className:"px-4 py-2",children:o&&s?.features?.includes(rJ.HISTORY_MESSAGES)&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(er,{}),(0,x.jsx)(rW,{className:"mt-4",readonly:c,config:{data:a.memory},onChange:p,canSetRoleName:!1})]})}),(0,x.jsx)("div",{children:(0,x.jsxs)(rG,{children:[(0,x.jsx)(rK,{name:"text",type:"String",description:m(`${rX}.outputVars.text`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"usage",type:"object",description:m(`${rX}.outputVars.usage`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"files",type:"Array[File]",description:m(`${rX}.outputVars.files.title`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"json",type:"Array[Object]",description:m(`${rX}.outputVars.json`,{ns:"workflow"})}),u.map(e=>{let{name:t,type:a,description:r}=e;return(0,x.jsx)(rK,{name:t,type:a,description:r},t)})]})})]})};rY.displayName="AgentPanel";let rZ=(0,y.memo)(rY);var r0=e.i(617178);e.i(603198);var r1=e.i(543421);let r2="@#!@#!",r5=y.memo(e=>{let t,{nodeId:a,value:r,className:s}=e,{getBeforeNodesInSameBranchIncludeParent:l}=(0,Z.useWorkflow)(),n=l(a),o=n.find(e=>e.data.type===eb.BlockEnum.Start),i=(t=[],r.replaceAll(/\{\{#([^#]*)#\}\}/g,(e,a)=>(t.push(a),r2)).split(r2).map((e,a)=>{if(!t[a])return(0,x.jsx)("span",{className:"relative top-[-3px] leading-[16px]",children:e},a);let r=t[a].split("."),s=(0,ty.isSystemVar)(r),l=(s?o:(0,ty.getNodeInfoById)(n,r[0]))?.data,i=r.length>2;return(0,x.jsxs)("span",{children:[(0,x.jsx)("span",{className:"relative top-[-3px] leading-[16px]",children:e}),(0,x.jsx)(r1.VariableLabelInText,{nodeTitle:l?.title,nodeType:l?.type,notShowFullPath:i,variables:r})]},a)}));return(0,x.jsx)("div",{className:(0,T.cn)("break-all text-xs",s),children:i})}),r3=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)();return(0,x.jsx)("div",{className:"mb-1 px-3 py-1",children:(0,x.jsx)(r0.default,{title:r("nodes.answer.answer",{ns:"workflow"}),content:(0,x.jsx)(r5,{value:a.answer,nodeId:t})})})}),r4=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,handleAnswerChange:n,filterVar:o}=((e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),{inputs:r,setInputs:s}=(0,tZ.default)(e,t),{handleVarListChange:l,handleAddVariable:n}=t4({inputs:r,setInputs:s}),o=(0,y.useCallback)(e=>{s((0,f.produce)(r,t=>{t.answer=e}))},[r,s]);return{readOnly:a,inputs:r,handleVarListChange:l,handleAddVariable:n,handleAnswerChange:o,filterVar:(0,y.useCallback)(e=>e.type!==eb.VarType.arrayObject,[])}})(t,a),{availableVars:i,availableNodesWithParent:d}=(0,t3.default)(t,{onlyLeafNodeVar:!1,hideChatVar:!1,hideEnv:!1,filterVar:o});return(0,x.jsx)("div",{className:"mb-2 mt-2 space-y-4 px-4",children:(0,x.jsx)(rF,{readOnly:s,justVar:!0,title:r("nodes.answer.answer",{ns:"workflow"}),value:l.answer,onChange:n,nodesOutputVars:i,availableNodes:d,isSupportFileVar:!0})})});var r6=e.i(83278),r8=e.i(758905);let r9="nodes.assigner",r7=y.memo(e=>{let{data:t}=e,{t:a}=(0,O.useTranslation)(),r=(0,j.useNodes)();if("2"===t.version){let{items:e}=t;return 0===(e?.filter(e=>e.variable_selector&&e.variable_selector.length>0)||[]).length?(0,x.jsx)("div",{className:"relative flex flex-col items-start gap-0.5 self-stretch px-3 py-1",children:(0,x.jsx)("div",{className:"flex flex-col items-start gap-1 self-stretch",children:(0,x.jsx)("div",{className:"flex items-center gap-1 self-stretch rounded-md bg-workflow-block-parma-bg px-[5px] py-1",children:(0,x.jsx)("div",{className:"system-xs-medium flex-1 text-text-tertiary",children:a(`${r9}.varNotSet`,{ns:"workflow"})})})})}):(0,x.jsx)("div",{className:"relative flex flex-col items-start gap-0.5 self-stretch px-3 py-1",children:e.map((e,t)=>{let s=e.variable_selector;if(!s||0===s.length)return null;let l=(0,ty.isSystemVar)(s)?r.find(e=>e.data.type===eb.BlockEnum.Start):r.find(e=>e.id===s[0]);return(0,x.jsx)(r8.VariableLabelInNode,{variables:s,nodeType:l?.data.type,nodeTitle:l?.data.title,rightSlot:!!e.operation&&(0,x.jsx)(r6.default,{className:"!ml-auto shrink-0",text:a(`${r9}.operations.${e.operation}`,{ns:"workflow"})})},t)})})}let{assigned_variable_selector:s,write_mode:l}=t;if(!s||0===s.length)return null;let n=(0,ty.isSystemVar)(s)?r.find(e=>e.data.type===eb.BlockEnum.Start):r.find(e=>e.id===s[0]);return(0,x.jsx)("div",{className:"relative flex flex-col items-start gap-0.5 self-stretch px-3 py-1",children:(0,x.jsx)(r8.VariableLabelInNode,{variables:s,nodeType:n?.data.type,nodeTitle:n?.data.title,rightSlot:l&&(0,x.jsx)(r6.default,{className:"!ml-auto shrink-0",text:a(`nodes.assigner.operations.${l}`,{ns:"workflow"})})})})});var se=e.i(873517);let st=y.memo(e=>{let{children:t}=e;return(0,x.jsx)("div",{className:"system-xs-regular flex min-h-[42px] w-full items-center justify-center rounded-[10px] bg-background-section text-text-tertiary",children:t})});var sa=e.i(22461),sr=e.i(220017),ss=e.i(757198);function sl(e){return"divider"!==e.value}let sn=e=>{let{value:t,onSelect:a,disabled:r=!1,className:s,popupClassName:l,assignedVarType:n,writeModeTypes:o,writeModeTypesArr:i,writeModeTypesNum:d}=e,{t:c}=(0,O.useTranslation)(),[u,p]=(0,y.useState)(!1),m=n?.startsWith("array")&&i?i.map(e=>({value:e,name:e})):"number"===n&&o&&d?[...o.map(e=>({value:e,name:e})),{value:"divider",name:"divider"},...d.map(e=>({value:e,name:e}))]:o&&["string","boolean","object"].includes(n||"")?o.map(e=>({value:e,name:e})):[],h=m.find(e=>e.value===t);return(0,x.jsxs)(ez.PortalToFollowElem,{open:u,onOpenChange:p,placement:"bottom-start",offset:4,children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>!r&&p(e=>!e),children:(0,x.jsxs)("div",{className:(0,T.cn)("flex items-center gap-0.5 rounded-lg bg-components-input-bg-normal px-2 py-1",r?"cursor-not-allowed !bg-components-input-bg-disabled":"cursor-pointer hover:bg-state-base-hover-alt",u&&"bg-state-base-hover-alt",s),children:[(0,x.jsx)("div",{className:"flex items-center p-1",children:(0,x.jsx)("span",{className:`system-sm-regular overflow-hidden truncate text-ellipsis
                ${h?"text-components-input-text-filled":"text-components-input-text-disabled"}`,children:h&&sl(h)?c(`nodes.assigner.operations.${h.name}`,{ns:"workflow"}):c("nodes.assigner.operations.title",{ns:"workflow"})})}),(0,x.jsx)(M.RiArrowDownSLine,{className:`h-4 w-4 text-text-quaternary ${r&&"text-components-input-text-placeholder"} ${u&&"text-text-secondary"}`})]})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:`z-20 ${l}`,children:(0,x.jsx)("div",{className:"flex w-[140px] flex-col items-start rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow-lg",children:(0,x.jsxs)("div",{className:"flex flex-col items-start self-stretch p-1",children:[(0,x.jsx)("div",{className:"flex items-start self-stretch px-3 pb-0.5 pt-1",children:(0,x.jsx)("div",{className:"system-xs-medium-uppercase flex grow text-text-tertiary",children:c("nodes.assigner.operations.title",{ns:"workflow"})})}),m.map(e=>sl(e)?(0,x.jsxs)("div",{className:(0,T.cn)("flex items-center gap-1 self-stretch rounded-lg px-2 py-1","cursor-pointer hover:bg-state-base-hover"),onClick:()=>{a(e),p(!1)},children:[(0,x.jsx)("div",{className:"flex min-h-5 grow items-center gap-1 px-1",children:(0,x.jsx)("span",{className:"system-sm-medium flex grow text-text-secondary",children:c(`nodes.assigner.operations.${e.name}`,{ns:"workflow"})})}),e.value===t&&(0,x.jsx)("div",{className:"flex items-center justify-center",children:(0,x.jsx)(M.RiCheckLine,{className:"h-4 w-4 text-text-accent"})})]},e.value):(0,x.jsx)(ss.default,{className:"my-1"},"divider"))]})})})]})},so=y.memo(e=>{let{readonly:t,nodeId:a,list:r,onChange:s,onOpen:l=tg.noop,filterVar:n,filterToAssignedVar:o,getAssignedVarType:i,getToAssignedVarType:d,writeModeTypes:c,writeModeTypesArr:u,writeModeTypesNum:p}=e,{t:m}=(0,O.useTranslation)(),h=(0,y.useCallback)(e=>t=>{s((0,f.produce)(r,a=>{a[e].variable_selector=t,a[e].operation=t7.WriteMode.overwrite,a[e].input_type=t7.AssignerNodeInputType.variable,a[e].value=void 0}),t)},[r,s]),g=(0,y.useCallback)((e,t)=>a=>{s((0,f.produce)(r,r=>{r[e].operation=a.value,r[e].value="",a.value===t7.WriteMode.set||a.value===t7.WriteMode.increment||a.value===t7.WriteMode.decrement||a.value===t7.WriteMode.multiply||a.value===t7.WriteMode.divide?(t===eb.VarType.boolean&&(r[e].value=!1),r[e].input_type=t7.AssignerNodeInputType.constant):r[e].input_type=t7.AssignerNodeInputType.variable}))},[r,s]),b=(0,y.useCallback)(e=>t=>{s((0,f.produce)(r,a=>{a[e].value=t}),t)},[r,s]),v=(0,y.useCallback)(e=>()=>{s((0,f.produce)(r,t=>{t.splice(e,1)}))},[r,s]),w=(0,y.useCallback)(e=>()=>l(e),[l]),j=(0,y.useCallback)(e=>t=>{let{variable_selector:a,operation:s}=r[e];if(!a||!s||!o)return!0;let l=i?.(a);return!(Array.isArray(a)&&a.join(".")===`${t.nodeId}.${t.variable}`)&&(!l||o(t,l,s))},[r,o,i]);return 0===r.length?(0,x.jsx)(st,{children:m("nodes.assigner.noVarTip",{ns:"workflow"})}):(0,x.jsx)("div",{className:"flex flex-col items-start gap-4 self-stretch",children:r.map((e,r)=>{let s=e.variable_selector?i?.(e.variable_selector):void 0,l=s&&e.operation&&d?d(s,e.operation):void 0;return(0,x.jsxs)("div",{className:"flex items-start gap-1 self-stretch",children:[(0,x.jsxs)("div",{className:"flex grow flex-col items-start gap-1",children:[(0,x.jsxs)("div",{className:"flex items-center gap-1 self-stretch",children:[(0,x.jsx)(sa.default,{readonly:t,nodeId:a,isShowNodeName:!0,value:e.variable_selector||[],onChange:h(r),onOpen:w(r),filterVar:n,placeholder:m("nodes.assigner.selectAssignedVariable",{ns:"workflow"}),minWidth:352,popupFor:"assigned",className:"w-full"}),(0,x.jsx)(sn,{value:e.operation,placeholder:"Operation",disabled:!e.variable_selector||0===e.variable_selector.length,onSelect:g(r,s),assignedVarType:s,writeModeTypes:c,writeModeTypesArr:u,writeModeTypesNum:p})]}),e.operation!==t7.WriteMode.clear&&e.operation!==t7.WriteMode.set&&e.operation!==t7.WriteMode.removeFirst&&e.operation!==t7.WriteMode.removeLast&&!p?.includes(e.operation)&&(0,x.jsx)(sa.default,{readonly:t||!e.variable_selector||!e.operation,nodeId:a,isShowNodeName:!0,value:e.value,onChange:b(r),filterVar:j(r),valueTypePlaceHolder:l,placeholder:m("nodes.assigner.setParameter",{ns:"workflow"}),minWidth:352,popupFor:"toAssigned",className:"w-full"}),!!(e.operation===t7.WriteMode.set&&s)&&(0,x.jsxs)(x.Fragment,{children:["number"===s&&(0,x.jsx)(eF.default,{type:"number",value:e.value,onChange:e=>b(r)(Number(e.target.value)),className:"w-full"}),"string"===s&&(0,x.jsx)(se.default,{value:e.value,onChange:e=>b(r)(e.target.value),className:"w-full"}),"boolean"===s&&(0,x.jsx)(sr.default,{value:e.value,onChange:e=>b(r)(e)}),"object"===s&&(0,x.jsx)(eB.default,{value:e.value,language:eD.CodeLanguage.json,onChange:e=>b(r)(e),className:"w-full",readOnly:t})]}),p?.includes(e.operation)&&(0,x.jsx)(eF.default,{type:"number",value:e.value,onChange:e=>b(r)(Number(e.target.value)),placeholder:"Enter number value...",className:"w-full"})]}),(0,x.jsx)(rk.default,{size:"l",className:"group shrink-0 hover:!bg-state-destructive-hover",onClick:v(r),children:(0,x.jsx)(M.RiDeleteBinLine,{className:"h-4 w-4 text-text-tertiary group-hover:text-text-destructive"})})]},r)})})}),si=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),s=(0,y.useCallback)(e=>[...e,{variable_selector:[],write_mode:t7.WriteMode.overwrite,input_type:t7.AssignerNodeInputType.variable,value:""}],[]),{readOnly:l,inputs:n,handleOperationListChanges:o,getAssignedVarType:i,getToAssignedVarType:d,writeModeTypesNum:c,writeModeTypesArr:u,writeModeTypes:p,filterAssignedVar:m,filterToAssignedVar:h}=((e,t)=>{let a=(0,y.useMemo)(()=>"2"===t.version&&t.items?t:{version:"2",items:[{variable_selector:t.assigned_variable_selector||[],input_type:t7.AssignerNodeInputType.variable,operation:(e=>{switch(e){case"over-write":default:return t7.WriteMode.overwrite;case"append":return t7.WriteMode.append;case"clear":return t7.WriteMode.clear}})(t.write_mode),value:t.input_variable_selector||[]}],...t},[t]),{nodesReadOnly:r}=(0,Z.useNodesReadOnly)(),s=(0,Z.useIsChatMode)(),l=(()=>{let e=(0,j.useNodes)(),{getBeforeNodesInSameBranchIncludeParent:t}=(0,Z.useWorkflow)(),{getNodeAvailableVars:a}=(0,aT.useWorkflowVariables)(),r=(0,Z.useIsChatMode)();return(0,y.useCallback)(function(s,l,n){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=[],d=e.find(e=>e.id===s);if(!d)return[];let c=t(s);i.push(...c);let u=e.find(e=>e.id===d.parentId);return o?a({parentNode:u,beforeNodes:(0,aS.uniqBy)(i,"id").filter(e=>e.id!==s),isChatMode:r,hideEnv:o,hideChatVar:o,filterVar:n}).map(e=>({...e,vars:e.isStartNode?e.vars.filter(e=>!e.variable.startsWith("sys.")):e.vars})).filter(e=>e.vars.length>0):a({parentNode:u,beforeNodes:(0,aS.uniqBy)(i,"id").filter(e=>e.id!==s),isChatMode:r,filterVar:n})},[e,t,a,r])})(),n=(0,j.useStoreApi)(),{getBeforeNodesInSameBranchIncludeParent:o}=(0,Z.useWorkflow)(),{getNodes:i}=n.getState(),d=i().find(t=>t.id===e),c=a.isInIteration,u=c?i().find(e=>e.id===d.parentId):null,p=(0,y.useMemo)(()=>o(e),[o,e]),{inputs:m,setInputs:x}=(0,tZ.default)(e,a),h=(0,y.useCallback)(e=>{x((0,f.produce)(e,e=>{"2"!==e.version&&(e.version="2")}))},[x]),{getCurrentVariableType:g}=(0,aT.useWorkflowVariables)(),b=(0,y.useCallback)(e=>g({parentNode:c?u:null,valueSelector:e||[],availableNodes:p,isChatMode:s,isConstant:!1}),[g,c,u,p,s]),v=(0,y.useCallback)(e=>{h((0,f.produce)(m,t=>{t.items=[...e]}))},[m,h]),w=[t7.WriteMode.overwrite,t7.WriteMode.clear,t7.WriteMode.append,t7.WriteMode.extend,t7.WriteMode.removeFirst,t7.WriteMode.removeLast],k=[t7.WriteMode.overwrite,t7.WriteMode.clear,t7.WriteMode.set],N=(0,y.useCallback)((e,t)=>{if(t===t7.WriteMode.overwrite||t===t7.WriteMode.increment||t===t7.WriteMode.decrement||t===t7.WriteMode.multiply||t===t7.WriteMode.divide||t===t7.WriteMode.extend)return e;if(t===t7.WriteMode.append){if(e===eb.VarType.arrayString)return eb.VarType.string;if(e===eb.VarType.arrayNumber)return eb.VarType.number;if(e===eb.VarType.arrayObject)return eb.VarType.object}return eb.VarType.string},[]),C=(0,y.useCallback)((e,t)=>!!e.isLoopVariable||t.join(".").startsWith("conversation"),[]),_=(0,y.useCallback)((e,t,a)=>{if(a===t7.WriteMode.overwrite||a===t7.WriteMode.extend||a===t7.WriteMode.increment||a===t7.WriteMode.decrement||a===t7.WriteMode.multiply||a===t7.WriteMode.divide)return e.type===t;if(a===t7.WriteMode.append)switch(t){case eb.VarType.arrayString:return e.type===eb.VarType.string;case eb.VarType.arrayNumber:return e.type===eb.VarType.number;case eb.VarType.arrayObject:return e.type===eb.VarType.object;default:return!1}return!0},[]);return{readOnly:r,inputs:m,handleOperationListChanges:v,getAssignedVarType:b,getToAssignedVarType:N,writeModeTypes:k,writeModeTypesArr:w,writeModeTypesNum:t7.writeModeTypesNum,filterAssignedVar:C,filterToAssignedVar:_,getAvailableVars:l,filterVar:e=>t=>e===eb.VarType.any||t.type===eb.VarType.any||t.type===e}})(t,a);return(0,x.jsx)("div",{className:"flex flex-col items-start self-stretch py-2",children:(0,x.jsxs)("div",{className:"flex w-full flex-col items-start justify-center gap-1 self-stretch px-4 py-2",children:[(0,x.jsxs)("div",{className:"flex items-start gap-2 self-stretch",children:[(0,x.jsx)("div",{className:"system-sm-semibold-uppercase flex grow flex-col items-start justify-center text-text-secondary",children:r("nodes.assigner.variables",{ns:"workflow"})}),(0,x.jsx)(rk.default,{onClick:()=>{o(s(n.items||[]))},children:(0,x.jsx)(M.RiAddLine,{className:"h-4 w-4 shrink-0 text-text-tertiary"})})]}),(0,x.jsx)(so,{readonly:l,nodeId:t,list:n.items||[],onChange:e=>{o(e)},filterVar:m,filterToAssignedVar:h,getAssignedVarType:i,writeModeTypes:p,writeModeTypesArr:u,writeModeTypesNum:c,getToAssignedVarType:d})]})})}),sd=y.memo(()=>(0,x.jsx)("div",{})),sc=y.memo(e=>{let{className:t,popupContent:a="",onClick:r}=e;return(0,x.jsx)(B.default,{popupContent:a,children:(0,x.jsx)("div",{className:(0,T.cn)(t,"cursor-pointer select-none rounded-md p-1 hover:bg-state-base-hover"),onClick:r,children:(0,x.jsx)(M.RiRefreshLine,{className:"h-4 w-4 text-text-tertiary"})})})});var su=e.i(116546),sp=e.i(38532),sm=e.i(168014),sx=e.i(249385);e.i(47690);var sh=e.i(490774);let sg=[eb.VarType.string,eb.VarType.number,eb.VarType.boolean,eb.VarType.arrayNumber,eb.VarType.arrayString,eb.VarType.arrayBoolean,eb.VarType.arrayObject,eb.VarType.object],sf=y.memo(e=>{let{readonly:t,className:a,value:r,onChange:s}=e,[l,n]=(0,y.useState)(!1),o=(0,y.useCallback)(e=>()=>{n(!1),s(e)},[s]);return(0,x.jsx)("div",{className:(0,T.cn)(a,!t&&"cursor-pointer select-none"),children:(0,x.jsxs)(ez.PortalToFollowElem,{open:l,onOpenChange:n,placement:"bottom-start",offset:4,children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>n(!l),className:"w-[120px] cursor-pointer",children:(0,x.jsxs)("div",{className:"flex h-8 items-center justify-between rounded-lg border-0 bg-components-input-bg-normal px-2.5 text-[13px] text-text-primary",children:[(0,x.jsx)("div",{className:"w-0 grow truncate capitalize",title:r,children:r}),(0,x.jsx)(M.RiArrowDownSLine,{className:"h-3.5 w-3.5 shrink-0 text-text-secondary"})]})}),(0,x.jsx)(ez.PortalToFollowElemContent,{style:{zIndex:100},children:(0,x.jsx)("div",{className:"w-[120px] rounded-lg bg-components-panel-bg p-1 shadow-sm",children:sg.map(e=>(0,x.jsxs)("div",{className:"flex h-[30px] cursor-pointer items-center justify-between rounded-lg pl-3 pr-2 text-[13px] text-text-primary hover:bg-state-base-hover",onClick:o(e),children:[(0,x.jsx)("div",{className:"w-0 grow truncate capitalize",children:e}),e===r&&(0,x.jsx)(sh.Check,{className:"h-4 w-4 shrink-0 text-text-accent"})]},e))})})]})})}),sb=y.memo(e=>{let{readonly:t,outputs:a,outputKeyOrders:r,onChange:s,onRemove:l}=e,{t:n}=(0,O.useTranslation)(),[o,i]=(0,y.useState)(),d=r.map(e=>({variable:e,variable_type:a[e]?.type})),{run:c}=(0,sp.useDebounceFn)((e,t)=>{let a=(0,sm.checkKeys)([t],!0);a.isValid?e.some(e=>e.variable?.trim()===t.trim())?i(eR.default.notify({type:"error",message:n("varKeyError.keyAlreadyExists",{ns:"appDebug",key:t})})):o?.clear?.():i(eR.default.notify({type:"error",message:n(`varKeyError.${a.errorMessageKey}`,{ns:"appDebug",key:a.errorKey})}))},{wait:500}),u=(0,y.useCallback)(e=>t=>{let r=d[e].variable;(0,sm.replaceSpaceWithUnderscoreInVarNameInput)(t.target);let l=t.target.value;o?.clear?.(),c(d.toSpliced(e,1),l),s((0,f.produce)(a,e=>{e[l]=e[r],delete e[r]}),e,l)},[d,s,a,r,c]),p=(0,y.useCallback)(e=>t=>{let r=d[e].variable;s((0,f.produce)(a,e=>{e[r].type=t}))},[d,s,a,r]),m=(0,y.useCallback)(e=>()=>{l(e)},[l]);return(0,x.jsx)("div",{className:"space-y-2",children:d.map((e,a)=>(0,x.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,x.jsx)(eF.default,{readOnly:t,value:e.variable,onChange:u(a),wrapperClassName:"grow"}),(0,x.jsx)(sf,{readonly:t,value:e.variable_type,onChange:p(a)}),(0,x.jsx)(sx.default,{className:"!bg-gray-100 !p-2 hover:!bg-gray-200",onClick:m(a)})]},a))})});var sy=e.i(858871),sv=e.i(503144);let sw=y.memo(e=>{let{nodeId:t,readonly:a,list:r,onChange:s,onVarNameChange:l,isSupportConstantValue:n,onlyLeafNodeVar:o,filterVar:i,isSupportFileVar:d=!0}=e,{t:c}=(0,O.useTranslation)(),[u,p]=(0,y.useState)(),m=(0,y.useMemo)(()=>r.map(e=>({id:(0,sv.v4)(),variable:{...e}})),[r]),{run:h}=(0,sp.useDebounceFn)((e,t)=>{let a=(0,sm.checkKeys)([t],!0);a.isValid?e.some(e=>e.variable?.trim()===t.trim())?p(eR.default.notify({type:"error",message:c("varKeyError.keyAlreadyExists",{ns:"appDebug",key:t})})):u?.clear?.():p(eR.default.notify({type:"error",message:c(`varKeyError.${a.errorMessageKey}`,{ns:"appDebug",key:a.errorKey})}))},{wait:500}),g=(0,y.useCallback)(e=>t=>{(0,sm.replaceSpaceWithUnderscoreInVarNameInput)(t.target);let a=t.target.value;u?.clear?.(),h(r.toSpliced(e,1),a),l?.(r[e].variable,a),s((0,f.produce)(r,t=>{t[e].variable=a}))},[r,l,s,h]),b=(0,y.useCallback)(e=>(t,a,l)=>{s((0,f.produce)(r,r=>{if(n&&a!==t6.VarType.variable)r[e].variable_type=t6.VarType.constant,r[e].value_selector=t,r[e].value=t;else if(r[e].value_selector=t,r[e].value_type=l?.type,n&&(r[e].variable_type=t6.VarType.variable),!r[e].variable){let a=r.map(e=>e.variable),s=t[t.length-1],l=1;for(;a.includes(s);)s=`${t[t.length-1]}_${l}`,l++;r[e].variable=s}}))},[n,r,s]),v=(0,y.useCallback)(e=>()=>{s((0,f.produce)(r,t=>{t.splice(e,1)}))},[r,s]),w=r.length;return(0,x.jsx)(sy.ReactSortable,{className:"space-y-2",list:m,setList:e=>{s(e.map(e=>e.variable))},handle:".handle",ghostClass:"opacity-50",animation:150,children:r.map((e,r)=>{let s=!a&&w>1;return(0,x.jsxs)("div",{className:(0,T.cn)("flex items-center space-x-1","group relative"),children:[(0,x.jsx)(eF.default,{wrapperClassName:"w-[120px]",disabled:a,value:e.variable,onChange:g(r),placeholder:c("common.variableNamePlaceholder",{ns:"workflow"})}),(0,x.jsx)(sa.default,{nodeId:t,readonly:a,isShowNodeName:!0,className:"grow",value:e.variable_type===t6.VarType.constant?e.value||"":e.value_selector||[],isSupportConstantValue:n,onChange:b(r),defaultVarKindType:e.variable_type,onlyLeafNodeVar:o,filterVar:i,isSupportFileVar:d}),!a&&(0,x.jsx)(sx.default,{onClick:v(r)}),s&&(0,x.jsx)(M.RiDraggable,{className:(0,T.cn)("handle absolute -left-4 top-2.5 hidden h-3 w-3 cursor-pointer text-text-quaternary","group-hover:block")})]},r)})})});var sj=e.i(370869);let sk=function(e){let{id:t,inputs:a,setInputs:r,varKey:s="outputs",outputKeyOrders:l=[],onOutputKeyOrdersChange:n}=e,{renameInspectVarName:o,deleteInspectVar:i,nodesWithInspectVars:d}=(0,ea.default)(),{handleOutVarRenameChange:c,isVarUsedInNodes:u,removeUsedVarInNodes:p}=(0,Z.useWorkflow)(),m=(0,y.useRef)({}),{run:x}=(0,sp.useDebounceFn)((e,t)=>{let a=m.current[e];o(e,a,t),delete m.current[e]},{wait:500}),h=(0,y.useCallback)((e,o,u)=>{if(r((0,f.produce)(a,t=>{t[s]=e,a.type===eb.BlockEnum.Code&&a.error_strategy===eH.ErrorHandleTypeEnum.defaultValue&&"outputs"===s&&(t.default_value=eJ(t))})),void 0!==o&&n((0,f.produce)(l,e=>{e[o]=u})),u)c(t,[t,l[o]],[t,u]),t in m.current||(m.current[t]=l[o]),x(t,u);else if(void 0===o){let a=d.find(e=>e.nodeId===t)?.vars.find(t=>t.name===Object.keys(e)[0])?.id;a&&i(t,a)}},[a,r,s,l,n,c,t,x,d,i]),g=(0,y.useCallback)(()=>{let e=Object.keys(a[s]).length+1;for(;a[s][`var_${e}`];)e++;return`var_${e}`},[a,s]),b=(0,y.useCallback)(()=>{let e=g();r((0,f.produce)(a,t=>{t[s]={...t[s],[e]:{type:eb.VarType.string,children:null}},a.type===eb.BlockEnum.Code&&a.error_strategy===eH.ErrorHandleTypeEnum.defaultValue&&"outputs"===s&&(t.default_value=eJ(t))})),n([...l,e])},[g,a,r,n,l,s]),[v,{setTrue:w,setFalse:j}]=(0,an.useBoolean)(!1),[k,N]=(0,y.useState)([]),C=(0,y.useCallback)(()=>{let e=d.find(e=>e.nodeId===t)?.vars.find(e=>e.name===k[1])?.id;e&&i(t,e),p(k),j()},[i,j,t,d,p,k]);return{handleVarsChange:h,handleAddVariable:b,handleRemoveVariable:(0,y.useCallback)(e=>{let o=l[e];if(u([t,o])){w(),N([t,o]);return}r((0,f.produce)(a,e=>{delete e[s][o],a.type===eb.BlockEnum.Code&&a.error_strategy===eH.ErrorHandleTypeEnum.defaultValue&&"outputs"===s&&(e.default_value=eJ(e))})),n(l.filter((t,a)=>a!==e));let c=d.find(e=>e.nodeId===t)?.vars.find(e=>e.name===o)?.id;c&&i(t,c)},[l,u,t,a,r,n,d,i,w,s]),isShowRemoveVarConfirm:v,hideRemoveVarConfirm:j,onRemoveVarConfirm:C}},sN="nodes.code",sC=[{label:"Python3",value:eD.CodeLanguage.python3},{label:"JavaScript",value:eD.CodeLanguage.javascript}],s_=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,outputKeyOrders:n,handleCodeAndVarsChange:o,handleVarListChange:i,handleAddVariable:d,handleRemoveVariable:c,handleSyncFunctionSignature:u,handleCodeChange:p,handleCodeLanguageChange:m,handleVarsChange:h,handleAddOutputVariable:g,filterVar:b,isShowRemoveVarConfirm:v,hideRemoveVarConfirm:w,onRemoveVarConfirm:j}=((e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),r=(0,eN.useStore)(e=>e.appId),s=(0,eN.useStore)(e=>e.pipelineId),[l,n]=(0,y.useState)(null);(0,y.useEffect)(()=>{r&&(async()=>{let{config:e}=await (0,_.fetchNodeDefault)(r,eb.BlockEnum.Code,{code_language:eD.CodeLanguage.javascript}),{config:t}=await (0,_.fetchNodeDefault)(r,eb.BlockEnum.Code,{code_language:eD.CodeLanguage.python3});n({[eD.CodeLanguage.javascript]:e,[eD.CodeLanguage.python3]:t})})()},[r]),(0,y.useEffect)(()=>{s&&(async()=>{let{config:e}=await (0,_.fetchPipelineNodeDefault)(s,eb.BlockEnum.Code,{code_language:eD.CodeLanguage.javascript}),{config:t}=await (0,_.fetchPipelineNodeDefault)(s,eb.BlockEnum.Code,{code_language:eD.CodeLanguage.python3});n({[eD.CodeLanguage.javascript]:e,[eD.CodeLanguage.python3]:t})})()},[s]);let o=(0,eN.useStore)(e=>e.nodesDefaultConfigs)?.[t.type],{inputs:i,setInputs:d}=(0,tZ.default)(e,t),{handleVarListChange:c,handleAddVariable:u}=t4({inputs:i,setInputs:d}),[p,m]=(0,y.useState)([]),x=(0,y.useCallback)(e=>{m(Object.keys(e))},[]);(0,y.useEffect)(()=>{if(i.code){i.outputs&&Object.keys(i.outputs).length>0&&x(i.outputs);return}o&&Object.keys(o).length>0&&(d({...i,...o}),x(o.outputs))},[o]);let h=(0,y.useCallback)(e=>{d((0,f.produce)(i,t=>{t.code=e}))},[i,d]),g=(0,y.useCallback)(e=>{let t=l?.[e];d((0,f.produce)(i,a=>{a.code_language=e,t&&(a.code=t.code,a.variables=t.variables,a.outputs=t.outputs)}))},[l,i,d]),b=(0,y.useCallback)(()=>{d((0,f.produce)(i,e=>{e.code=(e=>{let t,a;if(i.code_language===eD.CodeLanguage.javascript){t=/function\s+main\b\s*\([\s\S]*?\)/g,a="function main({{var_list}})";let e=i.variables?.map(e=>e.variable).join(", ")||"";e=e?`{${e}}`:"",a=a.replace("{{var_list}}",e)}else{if(i.code_language!==eD.CodeLanguage.python3)return e;t=/def\s+main\b\s*\([\s\S]*?\)/g;let r=[];for(let e of i.variables){let t=e.variable,a="";switch(e.value_type){case eb.VarType.string:a=": str";break;case eb.VarType.number:a=": float";break;case eb.VarType.object:a=": dict";break;case eb.VarType.array:a=": list";break;case eb.VarType.arrayNumber:a=": list[float]";break;case eb.VarType.arrayString:a=": list[str]";break;case eb.VarType.arrayObject:a=": list[dict]"}t+=a,r.push(`${t}`)}a=`def main(${r.join(", ")})`}return e.replace(t,a)})(e.code)}))},[i,d]),{handleVarsChange:v,handleAddVariable:w,handleRemoveVariable:j,isShowRemoveVarConfirm:k,hideRemoveVarConfirm:N,onRemoveVarConfirm:C}=sk({id:e,inputs:i,setInputs:d,outputKeyOrders:p,onOutputKeyOrdersChange:m}),T=(0,y.useCallback)(e=>[eb.VarType.string,eb.VarType.number,eb.VarType.boolean,eb.VarType.secret,eb.VarType.object,eb.VarType.array,eb.VarType.arrayNumber,eb.VarType.arrayString,eb.VarType.arrayObject,eb.VarType.arrayBoolean,eb.VarType.file,eb.VarType.arrayFile].includes(e.type),[]),S=(0,y.useCallback)((e,t,a)=>{d((0,f.produce)(i,r=>{r.code=e,r.variables=t,r.outputs=a})),x(a)},[i,d,x]);return{readOnly:a,inputs:i,outputKeyOrders:p,handleVarListChange:c,handleAddVariable:u,handleRemoveVariable:j,handleSyncFunctionSignature:b,handleCodeChange:h,handleCodeLanguageChange:g,handleVarsChange:v,filterVar:T,handleAddOutputVariable:w,isShowRemoveVarConfirm:k,hideRemoveVarConfirm:N,onRemoveVarConfirm:C,handleCodeAndVarsChange:S}})(t,a);return(0,x.jsxs)("div",{className:"mt-2",children:[(0,x.jsxs)("div",{className:"space-y-4 px-4 pb-4",children:[(0,x.jsx)(rj,{title:r(`${sN}.inputVars`,{ns:"workflow"}),operations:s?void 0:(0,x.jsxs)("div",{className:"flex gap-2",children:[(0,x.jsx)(sc,{popupContent:r(`${sN}.syncFunctionSignature`,{ns:"workflow"}),onClick:u}),(0,x.jsx)(eM.default,{onClick:d})]}),children:(0,x.jsx)(sw,{readonly:s,nodeId:t,list:l.variables,onChange:i,filterVar:b,isSupportFileVar:!1})}),(0,x.jsx)(er,{}),(0,x.jsx)(eB.default,{nodeId:t,isInNode:!0,readOnly:s,title:(0,x.jsx)(su.default,{options:sC,value:l.code_language,onChange:m}),language:l.code_language,value:l.code,onChange:p,onGenerated:e=>{let t=((e,t)=>{if(t===eD.CodeLanguage.json)return[];let a=({[eD.CodeLanguage.python3]:/def\s+main\s*\((.*?)\)/,[eD.CodeLanguage.javascript]:/function\s+main\s*\((.*?)\)/})[t].exec(e),r=[];return a?.[1]&&r.push(...a[1].split(",").map(e=>e.trim()).filter(Boolean).map(e=>e.split(":")[0].trim())),r})(e,l.code_language).map(e=>({variable:e,value_selector:[]})),a=((e,t)=>{let a=e.replace(/\/\*\*[\s\S]*?\*\//,""),r=a.indexOf("return");if(-1===r)return{};let s=a.slice(r),l=0,n=s.indexOf("{");if(t===eD.CodeLanguage.javascript&&-1===n){let e=s.indexOf("(");-1!==e&&(n=s.indexOf("{",e))}if(-1===n)return{};let o=-1;for(let e=n;e<s.length;e++)if("{"===s[e]&&l++,"}"===s[e]&&0==--l){o=e+1;break}if(-1===o)return{};let i=s.slice(n+1,o-1),d={};for(let e of i.matchAll(/['"]?(\w+)['"]?\s*:(?![^{]*\})/g))d[e[1]]={type:eb.VarType.string,children:null};return d})(e,l.code_language);o(e,t,a)},showCodeGenerator:!0})]}),(0,x.jsx)(er,{}),(0,x.jsx)("div",{className:"px-4 pb-2 pt-4",children:(0,x.jsx)(rj,{title:r(`${sN}.outputVars`,{ns:"workflow"}),operations:(0,x.jsx)(eM.default,{onClick:g}),required:!0,children:(0,x.jsx)(sb,{readonly:s,outputs:l.outputs,outputKeyOrders:n,onChange:h,onRemove:c})})}),(0,x.jsx)(sj.default,{isShow:v,onCancel:w,onConfirm:j})]})}),sT=e=>{let t,a,r,s,l,n,o,i,d,c,u,p,m,x,h,g,f,b,v,w,j,k,N,_,T,S,E,V,I,R,M=(t=(0,C.useAllBuiltInTools)(),a=(0,C.useAllCustomTools)(),r=(0,C.useAllWorkflowTools)(),s=(0,C.useAllMCPTools)(),l=(0,C.useInvalidToolsByType)(e.provider_type),n=(0,y.useMemo)(()=>{switch(e.provider_type){case e9.CollectionType.builtIn:return{list:t.data,isLoading:t.isLoading};case e9.CollectionType.custom:return{list:a.data,isLoading:a.isLoading};case e9.CollectionType.workflow:return{list:r.data,isLoading:r.isLoading};case e9.CollectionType.mcp:return{list:s.data,isLoading:s.isLoading};default:return}},[t.data,t.isLoading,a.data,a.isLoading,e.provider_type,s.data,s.isLoading,r.data,r.isLoading]),o=n?.list,i=n?.isLoading??!1,d=!!n&&!i,c=(0,y.useMemo)(()=>{if(o&&o.length)return o.find(t=>!!(e.plugin_id&&t.plugin_id===e.plugin_id||(0,eE.canFindTool)(t.id,e.provider_id))||t.name===e.provider_name)},[o,e.plugin_id,e.provider_id,e.provider_name]),u=e.plugin_unique_identifier||e.plugin_id||e.provider_id,p=!!e.plugin_unique_identifier,m=(0,y.useCallback)(()=>{l&&l()},[l]),x=!!n&&!d||d&&!c,{isChecking:!!n&&!d,isMissing:d&&!c,uniqueIdentifier:u,canInstall:p,onInstallSuccess:m,shouldDim:x}),A=(h=(0,eS.useAllTriggerPlugins)(),g=(0,eS.useInvalidateAllTriggerPlugins)(),f=h.data,b=h.isLoading,v=(0,y.useMemo)(()=>{if(f&&f.length)return f.find(t=>t.name===e.provider_name||t.id===e.provider_id||e.plugin_id&&t.plugin_id===e.plugin_id)},[e.plugin_id,e.provider_id,e.provider_name,f]),w=e.plugin_unique_identifier||e.plugin_id||e.provider_id,j=!!e.plugin_unique_identifier,k=(0,y.useCallback)(()=>{g()},[g]),N=b||!b&&!!f&&!v,{isChecking:b,isMissing:!b&&!!f&&!v,uniqueIdentifier:w,canInstall:j,onInstallSuccess:k,shouldDim:N}),O=(_=(0,eN.useStore)(e=>e.dataSourceList),T=(0,ex.useInvalidDataSourceList)(),S=(0,y.useMemo)(()=>{if(_&&_.length)return _.find(t=>!!e.plugin_unique_identifier&&t.plugin_unique_identifier===e.plugin_unique_identifier||!!e.plugin_id&&t.plugin_id===e.plugin_id||!!e.provider_name&&t.provider===e.provider_name)},[e.plugin_id,e.plugin_unique_identifier,e.provider_name,_]),E=e.plugin_unique_identifier||e.plugin_id,V=!!e.plugin_unique_identifier,I=(0,y.useCallback)(()=>{T()},[T]),{isChecking:!(R=void 0!==_),isMissing:R&&!S,uniqueIdentifier:E,canInstall:V,onInstallSuccess:I,shouldDim:!R||R&&!S});switch(e.type){case eb.BlockEnum.Tool:return M;case eb.BlockEnum.TriggerPlugin:return A;case eb.BlockEnum.DataSource:return O;default:return{isChecking:!1,isMissing:!1,uniqueIdentifier:void 0,canInstall:!1,onInstallSuccess:()=>void 0,shouldDim:!1}}},sS=(0,y.memo)(e=>{let{id:t,data:a}=e,{isChecking:r,isMissing:s,uniqueIdentifier:l,canInstall:n,onInstallSuccess:o,shouldDim:i}=sT(a),{handleNodeDataUpdate:d}=(0,Q.useNodeDataUpdate)(),c=!r&&s&&n&&!!l;return((0,y.useEffect)(()=>{(a._pluginInstallLocked!==c||a._dimmed!==i)&&d({id:t,data:{_pluginInstallLocked:c,_dimmed:i}})},[a._pluginInstallLocked,a._dimmed,d,t,i,c]),!r&&s&&n&&l)?(0,x.jsx)("div",{className:"relative mb-1 px-3 py-1",children:(0,x.jsx)("div",{className:"pointer-events-auto absolute right-3 top-[-32px] z-40",children:(0,x.jsx)(rf.InstallPluginButton,{size:"small",extraIdentifiers:[a.plugin_id,a.provider_name].filter(Boolean),className:"!font-medium !text-text-accent",uniqueIdentifier:l,onSuccess:o})})}):null});var sE=e.i(522977);let sV=(0,y.memo)(e=>{let{className:t,children:a,withBorderBottom:r}=e;return(0,x.jsx)("div",{className:(0,T.cn)("py-2",r&&"border-b border-divider-subtle",t),children:a})}),sI=(0,y.memo)(e=>{let{className:t,children:a,withBorderBottom:r}=e;return(0,x.jsx)("div",{className:(0,T.cn)("px-4 py-2",r&&"border-b border-divider-subtle",t),children:a})}),sR=(0,y.memo)(e=>{let{children:t,boxProps:a,groupProps:r}=e;return(0,x.jsx)(sV,{...a,children:(0,x.jsx)(sI,{...r,children:t})})});e.i(288243);var sM=e.i(670977);let sA=(0,y.memo)(e=>{let{title:t,operation:a,subTitle:r,tooltip:s,showArrow:l,disabled:n,collapsed:o,onCollapse:i}=e,[d,c]=(0,y.useState)(!0),u=void 0!==o?o:d;return(0,x.jsxs)("div",{className:(0,T.cn)("mb-0.5",!!r&&"mb-1"),children:[(0,x.jsxs)("div",{className:"group/collapse flex items-center justify-between py-1",onClick:()=>{n||(c(!u),i?.(!u))},children:[(0,x.jsxs)("div",{className:"system-sm-semibold-uppercase flex items-center text-text-secondary",children:[t,l&&(0,x.jsx)(sM.ArrowDownRoundFill,{className:(0,T.cn)("h-4 w-4 cursor-pointer text-text-quaternary group-hover/collapse:text-text-secondary",u&&"rotate-[270deg]")}),s&&(0,x.jsx)(B.default,{popupContent:s,triggerClassName:"w-4 h-4 ml-1"})]}),a]}),r]})}),sO=(0,y.memo)(e=>{let{fieldTitleProps:t,children:a,supportCollapse:r,disabled:s}=e,[l,n]=(0,y.useState)(!1);return(0,x.jsxs)("div",{children:[(0,x.jsx)(sA,{...t,collapsed:l,onCollapse:n,showArrow:r,disabled:s}),r&&!l&&a,!r&&a]})}),sP=(0,y.memo)(e=>{let{children:t,fieldProps:a,boxGroupProps:r}=e;return(0,x.jsx)(sR,{...r,children:(0,x.jsx)(sO,{...a,children:t})})});var sL=e.i(224651);let sF=y.memo(e=>{let{payload:t,rootClassName:a}=e,{t:r}=(0,O.useTranslation)(),s={...t,schema:{...t.schema,description:r("structOutput.LLMResponse",{ns:"app"})}};return(0,x.jsx)("div",{className:"relative left-[-7px]",children:Object.keys(s.schema.properties).map(e=>(0,x.jsx)(sL.default,{name:e,payload:s.schema.properties[e],required:!!s.schema.required?.includes(e),rootClassName:a},e))})});var sB=e.i(476285),sD=e.i(527525),s$=e.i(754210);let sz=(0,y.memo)(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{nodesReadOnly:s}=(0,Z.useNodesReadOnly)(),l=(0,eN.useStore)(e=>e.dataSourceList),{provider_type:n,plugin_id:o,fileExtensions:i=[],datasource_parameters:d}=a,{handleFileExtensionsChange:c,handleParametersChange:u,outputSchema:p,hasObjectOutput:m}=((e,t)=>{let a=(0,j.useStoreApi)(),{handleNodeDataUpdateWithSyncDraft:r}=(0,Q.useNodeDataUpdate)(),s=(0,y.useCallback)(()=>{let{getNodes:t}=a.getState();return t().find(t=>t.id===e)},[a,e]),l=(0,y.useCallback)(t=>{r({id:e,data:t})},[e,r]),n=(0,y.useCallback)(()=>{let e=s();e?.data._dataSourceStartToAdd&&e?.data.provider_type==="local_file"&&l({...e.data,_dataSourceStartToAdd:!1})},[s,l]);(0,y.useEffect)(()=>{n()},[n]);let o=(0,y.useCallback)(e=>{let t=s();l({...t?.data,fileExtensions:e})},[l,s]),i=(0,y.useCallback)(e=>{let t=s();l({...t?.data,datasource_parameters:e})},[l,s]);return{handleFileExtensionsChange:o,handleParametersChange:i,outputSchema:(0,y.useMemo)(()=>{let e=s();if(!e?.data||!t)return[];let a=t.find(t=>t.plugin_id===e.data.plugin_id),r=a?.tools?.find(t=>t.name===e.data.datasource_name),l=r?.output_schema,n=[];return l&&l.properties&&Object.keys(l.properties).forEach(e=>{let t=l.properties[e];"object"===t.type?n.push({name:e,value:t}):n.push({name:e,type:"array"===t.type?`Array[${t.items?.type.slice(0,1).toLocaleUpperCase()}${t.items?.type.slice(1)}]`:`${t.type.slice(0,1).toLocaleUpperCase()}${t.type.slice(1)}`,description:t.description})}),n},[s,t]),hasObjectOutput:(0,y.useMemo)(()=>{let e=s();if(!e?.data||!t)return!1;let a=t.find(t=>t.plugin_id===e.data.plugin_id),r=a?.tools?.find(t=>t.name===e.data.datasource_name),l=r?.output_schema;if(!l||!l.properties)return!1;let n=l.properties;return Object.keys(n).some(e=>"object"===n[e].type)},[s,t])}})(t,l),h=n===ew.DataSourceClassification.localFile,g=l?.find(e=>e.plugin_id===o),f=g?.tools?.find(e=>e.name===a.datasource_name),b=(0,y.useMemo)(()=>f?(0,t1.toolParametersToFormSchemas)(f.parameters):[],[f]),v=(0,eN.useStore)(e=>e.pipelineId),w=(0,eN.useStore)(e=>e.setShowInputFieldPanel),{schemaTypeDefinitions:k}=(0,tP.default)();return(0,x.jsxs)("div",{children:[g?.is_authorized&&!h&&!!b?.length&&(0,x.jsx)(sP,{boxGroupProps:{boxProps:{withBorderBottom:!0}},fieldProps:{fieldTitleProps:{title:r("nodes.tool.inputVars",{ns:"workflow"})},supportCollapse:!0},children:b.length>0&&(0,x.jsx)(sD.default,{readOnly:s,nodeId:t,schema:b,value:d,onChange:u,currentProvider:g,currentTool:f,showManageInputField:!!v,onManageInputField:()=>w?.(!0)})}),h&&(0,x.jsx)(sP,{boxGroupProps:{boxProps:{withBorderBottom:!0}},fieldProps:{fieldTitleProps:{title:r("nodes.dataSource.supportedFileFormats",{ns:"workflow"})}},children:(0,x.jsx)("div",{className:"rounded-lg bg-components-input-bg-normal p-1 pt-0",children:(0,x.jsx)(sE.default,{items:i,onChange:c,placeholder:r("nodes.dataSource.supportedFileFormatsPlaceholder",{ns:"workflow"}),inputClassName:"bg-transparent",disableAdd:s,disableRemove:s})})}),(0,x.jsxs)(rG,{children:[s$.COMMON_OUTPUT.map((e,t)=>(0,x.jsx)(rK,{name:e.name,type:e.type,description:e.description,isIndent:m},t)),h&&s$.LOCAL_FILE_OUTPUT.map((e,t)=>(0,x.jsx)(rK,{name:e.name,type:e.type,description:e.description,subItems:e.subItems.map(e=>({name:e.name,type:e.type,description:e.description}))},t)),p.map(e=>{let t=(0,tP.getMatchedSchemaType)(e.value,k);return(0,x.jsx)("div",{children:e.value?.type==="object"?(0,x.jsx)(sF,{rootClassName:"code-sm-semibold text-text-secondary",payload:(0,sB.wrapStructuredVarItem)(e,t)}):(0,x.jsx)(rK,{name:e.name,type:`${e.type.toLocaleLowerCase()}${t?` (${t})`:""}`,description:e.description,isIndent:m})},e.name)})]})]})}),sH=y.memo(e=>{let{data:t}=e,{t:a}=(0,O.useTranslation)(),r=(0,j.useNodes)(),{variable_selector:s}=t;if(!s||0===s.length)return null;let l=(0,ty.isSystemVar)(s)?r.find(e=>e.data.type===eb.BlockEnum.Start):r.find(e=>e.id===s[0]);return(0,x.jsxs)("div",{className:"relative mb-1 px-3 py-1",children:[(0,x.jsx)("div",{className:"system-2xs-medium-uppercase mb-1 text-text-tertiary",children:a("nodes.docExtractor.inputVar",{ns:"workflow"})}),(0,x.jsx)(r8.VariableLabelInNode,{variables:s,nodeType:l?.data.type,nodeTitle:l?.data.title})]})});var sW=e.i(491234),sq=e.i(652669);let sU="nodes.docExtractor",sK=y.memo(e=>{let t,{id:a,data:r}=e,{t:s}=(0,O.useTranslation)(),l=(0,eq.useLocale)(),n=eQ(eb.BlockEnum.DocExtractor),{data:o}=(0,sq.useFileSupportTypes)(),i=(t={md:"markdown",pptx:"pptx",htm:"html",xlsx:"xlsx",docx:"docx"},[...o?.allowed_extensions||[]].map(e=>t[e]||e).map(e=>e.toLowerCase()).filter((e,t,a)=>a.indexOf(e)===t).join(l!==sW.LanguagesSupported[1]?", ":"、 ")),{readOnly:d,inputs:c,handleVarChanges:u,filterVar:p}=((e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),{inputs:r,setInputs:s}=(0,tZ.default)(e,t),l=(0,y.useCallback)(e=>e.type===eb.VarType.file||e.type===eb.VarType.arrayFile,[]),n=(0,Z.useIsChatMode)(),o=(0,j.useStoreApi)(),{getBeforeNodesInSameBranch:i}=(0,Z.useWorkflow)(),{getNodes:d}=o.getState(),c=d().find(t=>t.id===e),u=t.isInIteration,p=u?d().find(e=>e.id===c.parentId):null,m=t.isInLoop?d().find(e=>e.id===c.parentId):null,x=(0,y.useMemo)(()=>i(e),[i,e]),{getCurrentVariableType:h}=(0,aT.useWorkflowVariables)(),g=(0,y.useCallback)(e=>h({parentNode:u?p:m,valueSelector:e||[],availableNodes:x,isChatMode:n,isConstant:!1}),[h,u,x,n,p,m]),b=(0,y.useCallback)(e=>{s((0,f.produce)(r,t=>{t.variable_selector=e,t.is_array_file=g(t.variable_selector)===eb.VarType.arrayFile}))},[g,r,s]);return{readOnly:a,inputs:r,filterVar:l,handleVarChanges:b}})(a,r);return(0,x.jsxs)("div",{className:"mt-2",children:[(0,x.jsx)("div",{className:"space-y-4 px-4 pb-4",children:(0,x.jsx)(rj,{title:s(`${sU}.inputVar`,{ns:"workflow"}),required:!0,children:(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(sa.default,{readonly:d,nodeId:a,isShowNodeName:!0,value:c.variable_selector||[],onChange:u,filterVar:p,typePlaceHolder:"File | Array[File]"}),(0,x.jsxs)("div",{className:"body-xs-regular mt-1 py-0.5 text-text-tertiary",children:[s(`${sU}.supportFileTypes`,{ns:"workflow",types:i}),(0,x.jsx)("a",{className:"text-text-accent",href:n,target:"_blank",children:s(`${sU}.learnMore`,{ns:"workflow"})})]})]})})}),(0,x.jsx)(er,{}),(0,x.jsx)("div",{children:(0,x.jsx)(rG,{children:(0,x.jsx)(rK,{name:"text",type:c.is_array_file?"array[string]":"string",description:s(`${sU}.outputVars.text`,{ns:"workflow"})})})})]})}),sG=y.memo(e=>{let{id:t,data:a}=e,{getBeforeNodesInSameBranch:r}=(0,Z.useWorkflow)(),s=r(t),{getCurrentVariableType:l}=(0,aT.useWorkflowVariables)(),n=(0,Z.useIsChatMode)(),o=s.find(e=>e.data.type===eb.BlockEnum.Start),{outputs:i}=a,d=i.filter(e=>{let{value_selector:t}=e;return t.length>0});return d.length?(0,x.jsx)("div",{className:"mb-1 space-y-0.5 px-3 py-1",children:d.map((e,t)=>{let a,{value_selector:r}=e,i=(a=r[0],s.find(e=>e.id===a)||o),d=l({valueSelector:r,availableNodes:s,isChatMode:n});return(0,x.jsx)(r8.VariableLabelInNode,{variables:r,nodeType:i?.data.type,nodeTitle:i?.data.title,variableType:d},t)})}):null}),sJ=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,handleVarListChange:n,handleAddVariable:o}=((e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),{inputs:r,setInputs:s}=(0,tZ.default)(e,t),{handleVarListChange:l,handleAddVariable:n}=t4({inputs:r,setInputs:e=>{s(e)},varKey:"outputs"});return{readOnly:a,inputs:r,handleVarListChange:l,handleAddVariable:n}})(t,a),i=l.outputs;return(0,x.jsx)("div",{className:"mt-2",children:(0,x.jsx)("div",{className:"space-y-4 px-4 pb-4",children:(0,x.jsx)(rj,{title:r("nodes.end.output.variable",{ns:"workflow"}),required:!0,operations:s?void 0:(0,x.jsx)(eM.default,{onClick:o}),children:(0,x.jsx)(sw,{nodeId:t,readonly:s,list:i,onChange:n})})})})}),sX=y.memo(e=>{let{id:t,data:a}=e,{method:r,url:s}=a;return s?(0,x.jsx)("div",{className:"mb-1 px-3 py-1",children:(0,x.jsxs)("div",{className:"flex items-center justify-start rounded-md bg-workflow-block-parma-bg p-1",children:[(0,x.jsx)("div",{className:"flex h-4 shrink-0 items-center rounded bg-components-badge-white-to-dark px-1 text-xs font-semibold uppercase text-text-secondary",children:r}),(0,x.jsx)("div",{className:"w-0 grow pl-1 pt-1",children:(0,x.jsx)(r5,{className:"text-text-secondary",value:s,nodeId:t})})]})}):null});var sQ=e.i(823341),sY=e.i(483561);let sZ=y.memo(e=>{let{instanceId:t,className:a,placeholder:r,placeholderClassName:s,promptMinHeightClassName:l="min-h-[20px]",value:n,onChange:o,onFocusChange:i,readOnly:d,nodesOutputVars:c,availableNodes:u=[],insertVarTipToLeft:p}=e,{t:m}=(0,O.useTranslation)(),[h,{setTrue:g,setFalse:f}]=(0,an.useBoolean)(!1);(0,y.useEffect)(()=>{i?.(h)},[h]);let b=(0,eN.useStore)(e=>e.pipelineId),v=(0,eN.useStore)(e=>e.setShowInputFieldPanel);return(0,x.jsx)("div",{className:(0,T.cn)(a,"relative"),children:(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(rS.default,{instanceId:t,className:(0,T.cn)(l,"!leading-[18px]"),placeholder:r,placeholderClassName:s,value:n,contextBlock:{show:!1,selectable:!1,datasets:[],onAddContext:tg.noop},historyBlock:{show:!1,selectable:!1,history:{user:"Human",assistant:"Assistant"},onEditRole:tg.noop},queryBlock:{show:!1,selectable:!1},workflowVariableBlock:{show:!0,variables:c||[],workflowNodesMap:u.reduce((e,t)=>(e[t.id]={title:t.data.title,type:t.data.type,width:t.width,height:t.height,position:t.position},t.data.type===eb.BlockEnum.Start&&(e.sys={title:m("blocks.start",{ns:"workflow"}),type:eb.BlockEnum.Start}),e),{}),showManageInputField:!!b,onManageInputField:()=>v?.(!0)},onChange:o,editable:!d,onBlur:f,onFocus:g}),d&&(0,x.jsx)("div",{className:"absolute inset-0 z-10"}),h&&(0,x.jsx)("div",{className:(0,T.cn)("absolute z-10",p?"left-[-12px] top-1.5":" right-1 top-[-9px]"),children:(0,x.jsx)(B.default,{popupContent:`${m("common.insertVarTip",{ns:"workflow"})}`,children:(0,x.jsx)("div",{className:"cursor-pointer rounded-[5px] border-[0.5px] border-divider-regular bg-components-badge-white-to-dark p-0.5 shadow-lg",children:(0,x.jsx)(r_.Variable02,{className:"h-3.5 w-3.5 text-components-button-secondary-accent-text"})})})})]})})});var s0=e.i(202259);let s1=[{label:"GET",value:s0.Method.get},{label:"POST",value:s0.Method.post},{label:"HEAD",value:s0.Method.head},{label:"PATCH",value:s0.Method.patch},{label:"PUT",value:s0.Method.put},{label:"DELETE",value:s0.Method.delete}],s2=y.memo(e=>{let{nodeId:t,readonly:a,method:r,onMethodChange:s,url:l,onUrlChange:n}=e,{t:o}=(0,O.useTranslation)(),[i,d]=(0,y.useState)(!1),{availableVars:c,availableNodesWithParent:u}=(0,t3.default)(t,{onlyLeafNodeVar:!1,filterVar:e=>[eb.VarType.string,eb.VarType.number,eb.VarType.secret].includes(e.type)});return(0,x.jsxs)("div",{className:"flex items-start  space-x-1",children:[(0,x.jsx)(su.default,{value:r,onChange:s,options:s1,trigger:(0,x.jsxs)("div",{className:(0,T.cn)(a&&"cursor-pointer","flex h-8 shrink-0 items-center rounded-lg border border-components-button-secondary-border bg-components-button-secondary-bg px-2.5"),children:[(0,x.jsx)("div",{className:"w-12 pl-0.5 text-xs font-medium uppercase leading-[18px] text-text-primary",children:r}),!a&&(0,x.jsx)(M.RiArrowDownSLine,{className:"ml-1 h-3.5 w-3.5 text-text-secondary"})]}),popupClassName:"top-[34px] w-[108px]",showChecked:!0,readonly:a}),(0,x.jsx)(sZ,{instanceId:"http-api-url",className:(0,T.cn)(i?"border-components-input-border-active bg-components-input-bg-active shadow-xs":"border-components-input-border-hover bg-components-input-bg-normal","w-0 grow rounded-lg border px-3 py-[6px]"),value:l,onChange:n,readOnly:a,nodesOutputVars:c,availableNodes:u,onFocusChange:d,placeholder:a?"":o("nodes.http.apiPlaceholder",{ns:"workflow"}),placeholderClassName:"!leading-[21px]"})]})});var s5=e.i(21151);let s3=e=>{let{title:t,onClick:a,isSelected:r}=e;return(0,x.jsx)("div",{className:(0,T.cn)("system-sm-regular flex h-8 grow cursor-default items-center rounded-md border border-components-option-card-option-border bg-components-option-card-option-bg px-2 text-text-secondary",!r&&"cursor-pointer hover:border-components-option-card-option-border-hover hover:bg-components-option-card-option-bg-hover hover:shadow-xs",r&&"system-sm-medium border-[1.5px] border-components-option-card-option-selected-border bg-components-option-card-option-selected-bg shadow-xs"),onClick:a,children:t})},s4=y.memo(e=>{let{options:t,value:a,onChange:r}=e,s=(0,y.useCallback)(e=>()=>r(e),[r]);return(0,x.jsx)("div",{className:"flex space-x-2",children:t.map(e=>(0,x.jsx)(s3,{title:e.label,onClick:s(e.value),isSelected:e.value===a},e.value))})}),s6="nodes.http.authorization",s8=e=>{let{title:t,isRequired:a,children:r}=e;return(0,x.jsxs)("div",{children:[(0,x.jsxs)("div",{className:"text-[13px] font-medium leading-8 text-text-secondary",children:[t,a&&(0,x.jsx)("span",{className:"ml-0.5 text-text-destructive",children:"*"})]}),(0,x.jsx)("div",{children:r})]})},s9=y.memo(e=>{let{nodeId:t,payload:a,onChange:r,isShow:s,onHide:l}=e,{t:n}=(0,O.useTranslation)(),[o,i]=(0,y.useState)(!1),{availableVars:d,availableNodesWithParent:c}=(0,t3.default)(t,{onlyLeafNodeVar:!1,filterVar:e=>[eb.VarType.string,eb.VarType.number,eb.VarType.secret].includes(e.type)}),[u,p]=y.useState(a),m=(0,y.useCallback)(e=>{p((0,f.produce)(u,t=>{t.type=e,t.type!==s0.AuthorizationType.apiKey||t.config||(t.config={type:s0.APIType.basic,api_key:""})}))},[u,p]),h=(0,y.useCallback)(e=>{p((0,f.produce)(u,t=>{t.config||(t.config={type:s0.APIType.basic,api_key:""}),t.config.type=e}))},[u,p]),g=(0,y.useCallback)(e=>t=>{p((0,f.produce)(u,a=>{a.config||(a.config={type:s0.APIType.basic,api_key:""}),a.config[e]=t.target.value}))},[u,p]),b=(0,y.useCallback)(e=>{p((0,f.produce)(u,t=>{t.config||(t.config={type:s0.APIType.basic,api_key:""}),t.config.api_key=e}))},[u,p]),v=(0,y.useCallback)(()=>{r(u),l()},[u,r,l]);return(0,x.jsx)(s5.default,{title:n(`${s6}.authorization`,{ns:"workflow"}),isShow:s,onClose:l,children:(0,x.jsxs)("div",{children:[(0,x.jsxs)("div",{className:"space-y-2",children:[(0,x.jsx)(s8,{title:n(`${s6}.authorizationType`,{ns:"workflow"}),children:(0,x.jsx)(s4,{options:[{value:s0.AuthorizationType.none,label:n(`${s6}.no-auth`,{ns:"workflow"})},{value:s0.AuthorizationType.apiKey,label:n(`${s6}.api-key`,{ns:"workflow"})}],value:u.type,onChange:m})}),u.type===s0.AuthorizationType.apiKey&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(s8,{title:n(`${s6}.auth-type`,{ns:"workflow"}),children:(0,x.jsx)(s4,{options:[{value:s0.APIType.basic,label:n(`${s6}.basic`,{ns:"workflow"})},{value:s0.APIType.bearer,label:n(`${s6}.bearer`,{ns:"workflow"})},{value:s0.APIType.custom,label:n(`${s6}.custom`,{ns:"workflow"})}],value:u.config?.type||s0.APIType.basic,onChange:h})}),u.config?.type===s0.APIType.custom&&(0,x.jsx)(s8,{title:n(`${s6}.header`,{ns:"workflow"}),isRequired:!0,children:(0,x.jsx)(eF.default,{value:u.config?.header||"",onChange:g("header")})}),(0,x.jsx)(s8,{title:n(`${s6}.api-key-title`,{ns:"workflow"}),isRequired:!0,children:(0,x.jsx)("div",{className:"flex",children:(0,x.jsx)(sZ,{instanceId:"http-api-key",className:(0,T.cn)(o?"border-components-input-border-active bg-components-input-bg-active shadow-xs":"border-components-input-border-hover bg-components-input-bg-normal","w-0 grow rounded-lg border px-3 py-[6px]"),value:u.config?.api_key||"",onChange:b,nodesOutputVars:d,availableNodes:c,onFocusChange:i,placeholder:" ",placeholderClassName:"!leading-[21px]"})})})]})]}),(0,x.jsxs)("div",{className:"mt-6 flex justify-end space-x-2",children:[(0,x.jsx)(es.default,{onClick:l,children:n("operation.cancel",{ns:"common"})}),(0,x.jsx)(es.default,{variant:"primary",onClick:v,children:n("operation.save",{ns:"common"})})]})]})})}),s7=y.memo(e=>{let{nodeId:t,isShow:a,onHide:r,handleCurlImport:s}=e,[l,n]=(0,y.useState)(""),{handleNodeSelect:o}=(0,V.useNodesInteractions)(),{t:i}=(0,O.useTranslation)(),d=(0,y.useCallback)(()=>{let{node:e,error:a}=(e=>{if(!e.trim().toLowerCase().startsWith("curl"))return{node:null,error:'Invalid cURL command. Command must start with "curl".'};let t={title:"HTTP Request",desc:"Imported from cURL",method:void 0,url:"",headers:"",params:"",body:{type:s0.BodyType.none,data:""}},a=e.match(/(?:[^\s"']|"[^"]*"|'[^']*')+/g)||[],r=!1;for(let e=1;e<a.length;e++){let s=a[e].replace(/^['"]|['"]$/g,"");switch(s){case"-X":case"--request":if(e+1>=a.length)return{node:null,error:"Missing HTTP method after -X or --request."};t.method=a[++e].replace(/^['"]|['"]$/g,"").toLowerCase()||s0.Method.get,r=!0;break;case"-H":case"--header":if(e+1>=a.length)return{node:null,error:"Missing header value after -H or --header."};t.headers+=(t.headers?"\n":"")+a[++e].replace(/^['"]|['"]$/g,"");break;case"-d":case"--data":case"--data-raw":case"--data-binary":{if(e+1>=a.length)return{node:null,error:"Missing data value after -d, --data, --data-raw, or --data-binary."};let r=[{type:s0.BodyPayloadValueType.text,value:a[++e].replace(/^['"]|['"]$/g,"")}];t.body={type:s0.BodyType.rawText,data:r};break}case"-F":case"--form":{if(e+1>=a.length)return{node:null,error:"Missing form data after -F or --form."};t.body?.type!==s0.BodyType.formData&&(t.body={type:s0.BodyType.formData,data:""});let[r,...s]=a[++e].replace(/^['"]|['"]$/g,"").split("=");if(!r)return{node:null,error:"Invalid form data format."};let l=s.join("="),n=/^(.+?);type=(.+)$/.exec(l);if(n){let[,e,a]=n;l=e,t.headers+=`${t.headers?"\n":""}Content-Type: ${a}`}t.body.data+=`${t.body.data?"\n":""}${r}:${l}`;break}case"--json":if(e+1>=a.length)return{node:null,error:"Missing JSON data after --json."};t.body={type:s0.BodyType.json,data:a[++e].replace(/^['"]|['"]$/g,"")};break;default:s.startsWith("http")&&!t.url&&(t.url=s)}}if(t.method=t.method||(r?s0.Method.post:s0.Method.get),!t.url)return{node:null,error:"Missing URL or url not start with http."};let s=t.url?.split("?")||[];return s.length>1&&(t.url=s[0],t.params=s[1].replace(/&/g,"\n").replace(/=/g,": ")),{node:t,error:null}})(l);a?eR.default.notify({type:"error",message:a}):e&&(r(),s(e),o(t,!0),setTimeout(()=>{o(t)},0))},[r,t,l,o,s]);return(0,x.jsxs)(s5.default,{title:i("nodes.http.curl.title",{ns:"workflow"}),isShow:a,onClose:r,className:"!w-[400px] !max-w-[400px] !p-4",children:[(0,x.jsx)("div",{children:(0,x.jsx)(se.default,{value:l,className:"my-3 h-40 w-full grow",onChange:e=>n(e.target.value),placeholder:i("nodes.http.curl.placeholder",{ns:"workflow"})})}),(0,x.jsxs)("div",{className:"mt-4 flex justify-end space-x-2",children:[(0,x.jsx)(es.default,{className:"!w-[95px]",onClick:r,children:i("operation.cancel",{ns:"common"})}),(0,x.jsxs)(es.default,{className:"!w-[95px]",variant:"primary",onClick:d,children:[" ",i("operation.save",{ns:"common"})]})]})]})}),le=0;function lt(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=++le;return`${e}${t}`}var la=e.i(299951);let lr=y.memo(e=>{let{className:t,instanceId:a,nodeId:r,value:s,onChange:l,hasRemove:n,onRemove:o,placeholder:i,readOnly:d,isSupportFile:c,insertVarTipToLeft:u}=e,{t:p}=(0,O.useTranslation)(),m=!!s,[h,g]=(0,y.useState)(!1),{availableVars:f,availableNodesWithParent:b}=(0,t3.default)(r,{onlyLeafNodeVar:!1,filterVar:e=>{let t=[eb.VarType.string,eb.VarType.number,eb.VarType.secret];return c&&t.push(eb.VarType.file,eb.VarType.arrayFile),t.includes(e.type)}}),v=(0,y.useCallback)(e=>{e.stopPropagation(),o?.()},[o]);return(0,x.jsxs)("div",{className:(0,T.cn)(t,"hover:cursor-text hover:bg-state-base-hover","relative flex !h-[30px] items-center"),children:[d?(0,x.jsxs)("div",{className:"h-full w-full pl-0.5 leading-[18px]",children:[!m&&(0,x.jsx)("div",{className:"text-xs font-normal text-text-quaternary",children:i}),m&&(0,x.jsx)(sZ,{instanceId:a,className:(0,T.cn)(h?"border-components-input-border-active bg-components-input-bg-active shadow-xs":"border-components-input-border-hover bg-components-input-bg-normal","h-full w-0 grow rounded-lg border px-3 py-[6px]"),value:s,onChange:l,readOnly:d,nodesOutputVars:f,availableNodes:b,onFocusChange:g,placeholder:p("nodes.http.insertVarPlaceholder",{ns:"workflow"}),placeholderClassName:"!leading-[21px]",promptMinHeightClassName:"h-full",insertVarTipToLeft:u})]}):(0,x.jsx)(sZ,{instanceId:a,className:(0,T.cn)(h?"bg-components-input-bg-active":"bg-width","h-full w-0 grow px-3 py-1"),value:s,onChange:l,readOnly:d,nodesOutputVars:f,availableNodes:b,onFocusChange:g,placeholder:p("nodes.http.insertVarPlaceholder",{ns:"workflow"}),placeholderClassName:"!leading-[21px]",promptMinHeightClassName:"h-full",insertVarTipToLeft:u}),n&&!h&&(0,x.jsx)(sx.default,{className:"absolute right-1 top-0.5 hidden group-hover:block",onClick:v})]})}),ls="nodes.http",ll=y.memo(e=>{let{instanceId:t,className:a,nodeId:r,readonly:s,canRemove:l,payload:n,onChange:o,onRemove:i,isLastItem:d,onAdd:c,isSupportFile:u,keyNotSupportVar:p,insertVarTipToLeft:m}=e,{t:h}=(0,O.useTranslation)(),g=(0,y.useCallback)(e=>t=>{o((0,f.produce)(n,a=>{a[e]=t}))},[o,n]);return(0,x.jsxs)("div",{className:(0,T.cn)(a,"h-min-7 group flex border-t border-divider-regular"),children:[(0,x.jsx)("div",{className:(0,T.cn)("shrink-0 border-r border-divider-regular",u?"w-[140px]":"w-1/2"),children:p?(0,x.jsx)("input",{className:"system-sm-regular focus:bg-gray-100! appearance-none rounded-none border-none bg-transparent outline-none hover:bg-components-input-bg-hover focus:ring-0",value:n.key,onChange:e=>g("key")(e.target.value)}):(0,x.jsx)(lr,{instanceId:`http-key-${t}`,nodeId:r,value:n.key,onChange:g("key"),hasRemove:!1,placeholder:h(`${ls}.key`,{ns:"workflow"}),readOnly:s,insertVarTipToLeft:m})}),u&&(0,x.jsx)("div",{className:"w-[70px] shrink-0 border-r border-divider-regular",children:(0,x.jsx)(la.PortalSelect,{value:n.type,onSelect:e=>g("type")(e.value),items:[{name:"text",value:"text"},{name:"file",value:"file"}],readonly:s,triggerClassName:"rounded-none h-7 text-text-primary",triggerClassNameFn:e=>e?"bg-state-base-hover":"bg-transparent",popupClassName:"w-[80px] h-7"})}),(0,x.jsx)("div",{className:(0,T.cn)(u?"grow":"w-1/2"),onClick:()=>d&&c(),children:u&&"file"===n.type?(0,x.jsx)(sa.default,{nodeId:r,readonly:s,value:n.file||[],onChange:g("file"),filterVar:e=>[eb.VarType.file,eb.VarType.arrayFile].includes(e.type),isInTable:!0,onRemove:i}):(0,x.jsx)(lr,{instanceId:`http-value-${t}`,nodeId:r,value:n.value,onChange:g("value"),hasRemove:!s&&l,onRemove:i,placeholder:h(`${ls}.value`,{ns:"workflow"}),readOnly:s,isSupportFile:u,insertVarTipToLeft:m})})]})}),ln="nodes.http",lo=y.memo(e=>{let{readonly:t,nodeId:a,list:r,onChange:s,onAdd:l,isSupportFile:n,keyNotSupportVar:o,insertVarTipToLeft:i}=e,{t:d}=(0,O.useTranslation)(),c=(0,y.useCallback)(e=>t=>{s((0,f.produce)(r,a=>{a[e]=t}))},[r,s]),u=(0,y.useCallback)(e=>()=>{s((0,f.produce)(r,t=>{t.splice(e,1)}))},[r,s]);return Array.isArray(r)?(0,x.jsxs)("div",{className:"overflow-hidden rounded-lg border border-divider-regular",children:[(0,x.jsxs)("div",{className:(0,T.cn)("system-xs-medium-uppercase flex h-7 items-center leading-7 text-text-tertiary"),children:[(0,x.jsx)("div",{className:(0,T.cn)("h-full border-r border-divider-regular pl-3",n?"w-[140px]":"w-1/2"),children:d(`${ln}.key`,{ns:"workflow"})}),n&&(0,x.jsx)("div",{className:"h-full w-[70px] shrink-0 border-r border-divider-regular pl-3",children:d(`${ln}.type`,{ns:"workflow"})}),(0,x.jsx)("div",{className:(0,T.cn)("h-full items-center justify-between pl-3 pr-1",n?"grow":"w-1/2"),children:d(`${ln}.value`,{ns:"workflow"})})]}),r.map((e,s)=>(0,x.jsx)(ll,{instanceId:e.id,nodeId:a,payload:e,onChange:c(s),onRemove:u(s),isLastItem:s===r.length-1,onAdd:l,readonly:t,canRemove:r.length>1,isSupportFile:n,keyNotSupportVar:o,insertVarTipToLeft:i},e.id))]}):null}),li=y.memo(e=>{let{readonly:t,nodeId:a,list:r,onChange:s,onAdd:l,isSupportFile:n}=e;return(0,x.jsx)(lo,{readonly:t,nodeId:a,list:r,onChange:s,onAdd:l,isSupportFile:n})}),ld="key-value-",lc=[s0.BodyType.none,s0.BodyType.formData,s0.BodyType.xWwwFormUrlencoded,s0.BodyType.json,s0.BodyType.rawText,s0.BodyType.binary],lu={[s0.BodyType.none]:"none",[s0.BodyType.formData]:"form-data",[s0.BodyType.xWwwFormUrlencoded]:"x-www-form-urlencoded",[s0.BodyType.rawText]:"raw",[s0.BodyType.json]:"JSON",[s0.BodyType.binary]:"binary"},lp=y.memo(e=>{let{readonly:t,nodeId:a,payload:r,onChange:s}=e,{type:l,data:n}=r,o=(0,y.useMemo)(()=>"string"==typeof n?[]:n,[n]),i=[s0.BodyType.formData,s0.BodyType.xWwwFormUrlencoded].includes(l)?"":o[0]?.value||"",{availableVars:d,availableNodes:c}=(0,t3.default)(a,{onlyLeafNodeVar:!1,filterVar:e=>[eb.VarType.string,eb.VarType.number,eb.VarType.secret,eb.VarType.arrayNumber,eb.VarType.arrayString].includes(e.type)}),u=(0,y.useCallback)(e=>{let t=e.target.value,a=[s0.BodyType.formData,s0.BodyType.xWwwFormUrlencoded].includes(t);s({type:t,data:a?[{id:lt(ld),type:s0.BodyPayloadValueType.text,key:"",value:""}]:[]})},[s]),p=(0,y.useCallback)(()=>{s((0,f.produce)(r,e=>{e.data.push({id:lt(ld),type:s0.BodyPayloadValueType.text,key:"",value:""})}))},[s,r]),m=(0,y.useCallback)(e=>{s((0,f.produce)(r,t=>{t.data=e}))},[s,r]),h=(0,y.useCallback)(e=>{s((0,f.produce)(r,t=>{0===t.data.length&&t.data.push({id:lt(ld),type:s0.BodyPayloadValueType.text,key:"",value:""}),t.data[0].value=e}))},[s,r]),g=(0,y.useCallback)(e=>{s((0,f.produce)(r,t=>{0===t.data.length&&t.data.push({id:lt(ld),type:s0.BodyPayloadValueType.file}),t.data[0].file=e}))},[s,r]);return(0,x.jsxs)("div",{children:[(0,x.jsx)("div",{className:"flex flex-wrap",children:lc.map(e=>(0,x.jsxs)("label",{htmlFor:`body-type-${e}`,className:"mr-4 flex h-7 items-center space-x-2",children:[(0,x.jsx)("input",{type:"radio",id:`body-type-${e}`,value:e,checked:l===e,onChange:u,disabled:t}),(0,x.jsx)("div",{className:"text-[13px] font-normal leading-[18px] text-text-secondary",children:lu[e]})]},e))}),(0,x.jsxs)("div",{className:(0,T.cn)(l!==s0.BodyType.none&&"mt-1"),children:[l===s0.BodyType.none&&null,(l===s0.BodyType.formData||l===s0.BodyType.xWwwFormUrlencoded)&&(0,x.jsx)(li,{readonly:t,nodeId:a,list:o,onChange:m,onAdd:p,isSupportFile:l===s0.BodyType.formData}),l===s0.BodyType.rawText&&(0,x.jsx)(rF,{instanceId:"http-body-raw",title:(0,x.jsx)("div",{className:"uppercase",children:"Raw text"}),onChange:h,value:i,justVar:!0,nodesOutputVars:d,availableNodes:c,readOnly:t}),l===s0.BodyType.json&&(0,x.jsx)(rF,{instanceId:"http-body-json",title:"JSON",value:i,onChange:h,justVar:!0,nodesOutputVars:d,availableNodes:c,readOnly:t}),l===s0.BodyType.binary&&(0,x.jsx)(sa.default,{nodeId:a,readonly:t,value:o[0]?.file||[],onChange:g,filterVar:e=>[eb.VarType.file,eb.VarType.arrayFile].includes(e.type)})]})]})});var rq=rq;let lm=e=>{let{title:t,description:a,placeholder:r,value:s,onChange:l,readOnly:n,min:o,max:i}=e;return(0,x.jsxs)("div",{className:"space-y-1",children:[(0,x.jsxs)("div",{className:"flex h-[18px] items-center space-x-2",children:[(0,x.jsx)("span",{className:"text-[13px] font-medium text-text-primary",children:t}),(0,x.jsx)("span",{className:"text-xs font-normal text-text-tertiary",children:a})]}),(0,x.jsx)(eF.default,{type:"number",value:s,onChange:e=>{let t=e.target.value;if(""===t)l(void 0);else{let e=Number.parseInt(t,10);Number.isNaN(e)||l(Math.max(o,Math.min(i,e)))}},placeholder:r,readOnly:n,min:o,max:i})]})},lx=y.memo(e=>{let{readonly:t,payload:a,onChange:r}=e,{t:s}=(0,O.useTranslation)(),{connect:l,read:n,write:o,max_connect_timeout:i,max_read_timeout:d,max_write_timeout:c}=a??{},u=(0,eN.useStore)(e=>e.nodesDefaultConfigs),p=u?.[eb.BlockEnum.HttpRequest],m=p?.timeout||{};return(0,x.jsx)(rq.default,{title:s("nodes.http.timeout.title",{ns:"workflow"}),children:(0,x.jsx)("div",{className:"mt-2 space-y-1",children:(0,x.jsxs)("div",{className:"space-y-3",children:[(0,x.jsx)(lm,{title:s("nodes.http.timeout.connectLabel",{ns:"workflow"}),description:s("nodes.http.timeout.connectPlaceholder",{ns:"workflow"}),placeholder:s("nodes.http.timeout.connectPlaceholder",{ns:"workflow"}),readOnly:t,value:l,onChange:e=>r?.({...a,connect:e}),min:1,max:i||m.max_connect_timeout||10}),(0,x.jsx)(lm,{title:s("nodes.http.timeout.readLabel",{ns:"workflow"}),description:s("nodes.http.timeout.readPlaceholder",{ns:"workflow"}),placeholder:s("nodes.http.timeout.readPlaceholder",{ns:"workflow"}),readOnly:t,value:n,onChange:e=>r?.({...a,read:e}),min:1,max:d||m.max_read_timeout||600}),(0,x.jsx)(lm,{title:s("nodes.http.timeout.writeLabel",{ns:"workflow"}),description:s("nodes.http.timeout.writePlaceholder",{ns:"workflow"}),placeholder:s("nodes.http.timeout.writePlaceholder",{ns:"workflow"}),readOnly:t,value:o,onChange:e=>r?.({...a,write:e}),min:1,max:c||m.max_write_timeout||600})]})})})}),lh="key-value-",lg=(e,t,a)=>{let[r,s]=(0,y.useState)(()=>e?e.split("\n").map(e=>{let[t,...a]=e.split(":");return{id:lt(lh),key:t.trim(),value:a.join(":").trim()}}):[]),l=e=>{s(e.map(e=>({...e,id:e.id||lt(lh)})))};(0,y.useEffect)(()=>{if(a)return;let s=r.filter(e=>e.key&&e.value).map(e=>`${e.key}:${e.value}`).join("\n");s!==e&&t(s)},[r,a]);let n=(0,y.useCallback)(()=>{l([...r,{id:lt(lh),key:"",value:""}])},[r]),[o,{toggle:i}]=(0,an.useBoolean)(!0);return{list:0===r.length?[{id:lt(lh),key:"",value:""}]:r,setList:l,addItem:n,isKeyValueEdit:o,toggleIsKeyValueEdit:i}},lf="nodes.http",lb=(0,y.memo)(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,isDataReady:l,inputs:n,handleMethodChange:o,handleUrlChange:i,headers:d,setHeaders:c,addHeader:u,params:p,setParams:m,addParam:h,setBody:g,isShowAuthorization:b,showAuthorization:v,hideAuthorization:w,setAuthorization:j,setTimeout:k,isShowCurlPanel:N,showCurlPanel:C,hideCurlPanel:_,handleCurlImport:S,handleSSLVerifyChange:E}=((e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),r=(0,eN.useStore)(e=>e.nodesDefaultConfigs?.[t.type]),{inputs:s,setInputs:l}=(0,tZ.default)(e,t),{handleVarListChange:n,handleAddVariable:o}=t4({inputs:s,setInputs:l}),[i,d]=(0,y.useState)(!1);(0,y.useEffect)(()=>{if(r&&Object.keys(r).length>0){let e={...r,...s},t=e.body.data;if("string"==typeof t)e.body={...e.body,data:[s0.BodyType.formData,s0.BodyType.xWwwFormUrlencoded].includes(e.body.type)?t.split("\n").map(e=>{let[t,a]=e.split(":");return{key:t||"",type:s0.BodyPayloadValueType.text,value:a||""}}):[{type:s0.BodyPayloadValueType.text,value:t}]};else t||(e.body={...e.body,data:[]});l(e),d(!0)}},[r]);let c=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.method=e}))},[s,l]),u=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.url=e}))},[s,l]),p=(0,y.useCallback)(e=>t=>{l((0,f.produce)(s,a=>{a[e]=t}))},[s,l]),{list:m,setList:x,addItem:h,isKeyValueEdit:g,toggleIsKeyValueEdit:b}=lg(s.headers,p("headers")),{list:v,setList:w,addItem:j,isKeyValueEdit:k,toggleIsKeyValueEdit:N}=lg(s.params,p("params")),C=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.body=e}))},[s,l]),[_,{setTrue:T,setFalse:S}]=(0,an.useBoolean)(!1),E=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.authorization=e}))},[s,l]),V=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.timeout=e}))},[s,l]),I=(0,y.useCallback)(e=>[eb.VarType.string,eb.VarType.number,eb.VarType.secret].includes(e.type),[]),[R,{setTrue:M,setFalse:A}]=(0,an.useBoolean)(!1),O=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.method=e.method,t.url=e.url,t.headers=e.headers,t.params=e.params,t.body=e.body}))},[s,l]),P=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.ssl_verify=e}))},[s,l]);return{readOnly:a,isDataReady:i,inputs:s,handleVarListChange:n,handleAddVariable:o,filterVar:I,handleMethodChange:c,handleUrlChange:u,headers:m,setHeaders:x,addHeader:h,isHeaderKeyValueEdit:g,toggleIsHeaderKeyValueEdit:b,params:v,setParams:w,addParam:j,isParamKeyValueEdit:k,toggleIsParamKeyValueEdit:N,setBody:C,handleSSLVerifyChange:P,isShowAuthorization:_,showAuthorization:T,hideAuthorization:S,setAuthorization:E,setTimeout:V,isShowCurlPanel:R,showCurlPanel:M,hideCurlPanel:A,handleCurlImport:O}})(t,a);return l?(0,x.jsxs)("div",{className:"pt-2",children:[(0,x.jsxs)("div",{className:"space-y-4 px-4 pb-4",children:[(0,x.jsx)(rj,{title:r(`${lf}.api`,{ns:"workflow"}),required:!0,operations:(0,x.jsxs)("div",{className:"flex",children:[(0,x.jsxs)("div",{onClick:v,className:(0,T.cn)(!s&&"cursor-pointer hover:bg-state-base-hover","flex h-6 items-center space-x-1 rounded-md px-2 "),children:[!s&&(0,x.jsx)(sY.Settings01,{className:"h-3 w-3 text-text-tertiary"}),(0,x.jsxs)("div",{className:"text-xs font-medium text-text-tertiary",children:[r(`${lf}.authorization.authorization`,{ns:"workflow"}),(0,x.jsx)("span",{className:"ml-1 text-text-secondary",children:r(`${lf}.authorization.${n.authorization.type}`,{ns:"workflow"})})]})]}),(0,x.jsxs)("div",{onClick:C,className:(0,T.cn)(!s&&"cursor-pointer hover:bg-state-base-hover","flex h-6 items-center space-x-1 rounded-md px-2 "),children:[!s&&(0,x.jsx)(sQ.FileArrow01,{className:"h-3 w-3 text-text-tertiary"}),(0,x.jsx)("div",{className:"text-xs font-medium text-text-tertiary",children:r(`${lf}.curl.title`,{ns:"workflow"})})]})]}),children:(0,x.jsx)(s2,{nodeId:t,readonly:s,method:n.method,onMethodChange:o,url:n.url,onUrlChange:i})}),(0,x.jsx)(rj,{title:r(`${lf}.headers`,{ns:"workflow"}),children:(0,x.jsx)(li,{nodeId:t,list:d,onChange:c,onAdd:u,readonly:s})}),(0,x.jsx)(rj,{title:r(`${lf}.params`,{ns:"workflow"}),children:(0,x.jsx)(li,{nodeId:t,list:p,onChange:m,onAdd:h,readonly:s})}),(0,x.jsx)(rj,{title:r(`${lf}.body`,{ns:"workflow"}),required:!0,children:(0,x.jsx)(lp,{nodeId:t,readonly:s,payload:n.body,onChange:g})}),(0,x.jsx)(rj,{title:r(`${lf}.verifySSL.title`,{ns:"workflow"}),tooltip:r(`${lf}.verifySSL.warningTooltip`,{ns:"workflow"}),operations:(0,x.jsx)(ts.default,{defaultValue:!!n.ssl_verify,onChange:E,size:"md",disabled:s})})]}),(0,x.jsx)(er,{}),(0,x.jsx)(lx,{nodeId:t,readonly:s,payload:n.timeout,onChange:k}),b&&!s&&(0,x.jsx)(s9,{nodeId:t,isShow:!0,onHide:w,payload:n.authorization,onChange:j}),(0,x.jsx)(er,{}),(0,x.jsx)("div",{className:"",children:(0,x.jsx)(rG,{children:(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(rK,{name:"body",type:"string",description:r(`${lf}.outputVars.body`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"status_code",type:"number",description:r(`${lf}.outputVars.statusCode`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"headers",type:"object",description:r(`${lf}.outputVars.headers`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"files",type:"Array[File]",description:r(`${lf}.outputVars.files`,{ns:"workflow"})})]})})}),N&&!s&&(0,x.jsx)(s7,{nodeId:t,isShow:!0,onHide:_,handleCurlImport:S})]}):null});var ly=e.i(555503),lv=e.i(166211),lw=e.i(146106);let lj="nodes.ifElse",lk=y.memo(e=>{let{data:t}=e,{t:a}=(0,O.useTranslation)(),{cases:r}=t,s=r.length,l=(0,y.useCallback)(e=>!!e.variable_selector&&0!==e.variable_selector.length&&(e.sub_variable_condition?e.sub_variable_condition.conditions.every(e=>!!e.comparison_operator&&(e.varType===eb.VarType.boolean||e.varType===eb.VarType.arrayBoolean||!!e.value)):!!(0,lw.isEmptyRelatedOperator)(e.comparison_operator)||e.varType===eb.VarType.boolean||e.varType===eb.VarType.arrayBoolean||!!e.value),[]),n=(0,x.jsx)("div",{className:"flex h-6 items-center space-x-1 rounded-md bg-workflow-block-parma-bg px-1 text-xs font-normal text-text-secondary",children:a(`${lj}.conditionNotSetup`,{ns:"workflow"})});return(0,x.jsxs)("div",{className:"px-3",children:[r.map((t,r)=>(0,x.jsxs)("div",{children:[(0,x.jsxs)("div",{className:"relative flex h-6 items-center px-1",children:[(0,x.jsxs)("div",{className:"flex w-full items-center justify-between",children:[(0,x.jsx)("div",{className:"text-[10px] font-semibold text-text-tertiary",children:s>1&&`CASE ${r+1}`}),(0,x.jsx)("div",{className:"text-[12px] font-semibold text-text-secondary",children:0===r?"IF":"ELIF"})]}),(0,x.jsx)(aF,{...e,handleId:t.case_id,handleClassName:"!top-1/2 !-right-[21px] !-translate-y-1/2"})]}),(0,x.jsx)("div",{className:"space-y-0.5",children:t.conditions.map((e,r)=>(0,x.jsxs)("div",{className:"relative",children:[l(e)?!(0,lw.isEmptyRelatedOperator)(e.comparison_operator)&&e.sub_variable_condition?(0,x.jsx)(ly.default,{condition:e}):(0,x.jsx)(lv.default,{variableSelector:e.variable_selector,operator:e.comparison_operator,value:e.varType===eb.VarType.boolean?e.value?e.value:"False":e.value}):n,r!==t.conditions.length-1&&(0,x.jsx)("div",{className:"absolute bottom-[-10px] right-1 z-10 text-[10px] font-medium uppercase leading-4 text-text-accent",children:a(`${lj}.${t.logical_operator}`,{ns:"workflow"})})]},e.id))})]},t.case_id)),(0,x.jsxs)("div",{className:"relative flex h-6 items-center px-1",children:[(0,x.jsx)("div",{className:"w-full text-right text-xs font-semibold text-text-secondary",children:"ELSE"}),(0,x.jsx)(aF,{...e,handleId:"false",handleClassName:"!top-1/2 !-right-[21px] !-translate-y-1/2"})]})]})});var lN=e.i(245695);let lC=e=>{let{className:t,caseId:a,variables:r,onSelectVariable:s,disabled:l}=e,{t:n}=(0,O.useTranslation)(),[o,i]=(0,y.useState)(!1),d=(0,y.useCallback)((e,t)=>{s(a,e,t),i(!1)},[a,s,i]);return(0,x.jsxs)(ez.PortalToFollowElem,{open:o,onOpenChange:i,placement:"bottom-start",offset:{mainAxis:4,crossAxis:0},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>i(!o),children:(0,x.jsxs)(es.default,{size:"small",className:t,disabled:l,children:[(0,x.jsx)(M.RiAddLine,{className:"mr-1 h-3.5 w-3.5"}),n("nodes.ifElse.addCondition",{ns:"workflow"})]})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[1000]",children:(0,x.jsx)("div",{className:"w-[296px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow-lg",children:(0,x.jsx)(aR.default,{vars:r,isSupportFileVar:!0,onChange:d})})})]})};var l_=e.i(670082),lT=e.i(403861),lS=e.i(48498),lE=e.i(269398);let lV=[t6.VarType.variable,t6.VarType.constant],lI=(0,y.memo)(e=>{let{numberVarType:t=t6.VarType.constant,onNumberVarTypeChange:a,value:r,onValueChange:s,variables:l,isShort:n,unit:o}=e,{t:i}=(0,O.useTranslation)(),[d,c]=(0,y.useState)(!1),[u,p]=(0,y.useState)(!1),[m,{setTrue:h,setFalse:g}]=(0,an.useBoolean)(),f=(0,y.useCallback)(e=>{s((0,lS.variableTransformer)(e)),p(!1)},[s]);return(0,x.jsxs)("div",{className:"flex cursor-pointer items-center",children:[(0,x.jsxs)(ez.PortalToFollowElem,{open:d,onOpenChange:c,placement:"bottom-start",offset:{mainAxis:2,crossAxis:0},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>c(e=>!e),children:(0,x.jsxs)(es.default,{className:"shrink-0",variant:"ghost",size:"small",children:[(0,lT.capitalize)(t),(0,x.jsx)(M.RiArrowDownSLine,{className:"ml-[1px] h-3.5 w-3.5"})]})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[1000]",children:(0,x.jsx)("div",{className:"w-[112px] rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur p-1 shadow-lg",children:lV.map(e=>(0,x.jsx)("div",{className:(0,T.cn)("flex h-7 cursor-pointer items-center rounded-md px-3 hover:bg-state-base-hover","text-[13px] font-medium text-text-secondary",t===e&&"bg-state-base-hover"),onClick:()=>{a(e),c(!1)},children:(0,lT.capitalize)(e)},e))})})]}),(0,x.jsx)("div",{className:"mx-1 h-4 w-[1px] bg-divider-regular"}),(0,x.jsxs)("div",{className:"ml-0.5 w-0 grow",children:[t===t6.VarType.variable&&(0,x.jsxs)(ez.PortalToFollowElem,{open:u,onOpenChange:p,placement:"bottom-start",offset:{mainAxis:2,crossAxis:0},children:[(0,x.jsxs)(ez.PortalToFollowElemTrigger,{className:"w-full",onClick:()=>p(e=>!e),children:[r&&(0,x.jsx)(lE.default,{valueSelector:(0,lS.variableTransformer)(r),varType:eb.VarType.number,isShort:n}),!r&&(0,x.jsxs)("div",{className:"flex h-6 items-center p-1 text-[13px] text-components-input-text-placeholder",children:[(0,x.jsx)(r_.Variable02,{className:"mr-1 h-4 w-4 shrink-0"}),(0,x.jsx)("div",{className:"w-0 grow truncate",children:i("nodes.ifElse.selectVariable",{ns:"workflow"})})]})]}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[1000]",children:(0,x.jsx)("div",{className:(0,T.cn)("w-[296px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg-blur pt-1 shadow-lg",n&&"w-[200px]"),children:(0,x.jsx)(aR.default,{vars:l,onChange:f})})})]}),t===t6.VarType.constant&&(0,x.jsxs)("div",{className:" relative",children:[(0,x.jsx)("input",{className:(0,T.cn)("block w-full appearance-none bg-transparent px-2 text-[13px] text-components-input-text-filled outline-none placeholder:text-components-input-text-placeholder",o&&"pr-6"),type:"number",value:r,onChange:e=>s(e.target.value),placeholder:i("nodes.ifElse.enterValue",{ns:"workflow"})||"",onFocus:h,onBlur:g}),!m&&o&&(0,x.jsx)("div",{className:"system-sm-regular absolute right-2 top-[50%] translate-y-[-50%] text-text-tertiary",children:o})]})]})]})}),lR=e=>{let{value:t,onChange:a,disabled:r,nodesOutputVars:s,availableNodes:l}=e,{t:n}=(0,O.useTranslation)(),o=(0,eN.useStore)(e=>e.controlPromptEditorRerenderKey),i=(0,eN.useStore)(e=>e.pipelineId),d=(0,eN.useStore)(e=>e.setShowInputFieldPanel);return(0,x.jsx)(rS.default,{compact:!0,value:t,placeholder:n("nodes.ifElse.enterValue",{ns:"workflow"})||"",workflowVariableBlock:{show:!0,variables:s||[],workflowNodesMap:l.reduce((e,t)=>(e[t.id]={title:t.data.title,type:t.data.type,width:t.width,height:t.height,position:t.position},t.data.type===eb.BlockEnum.Start&&(e.sys={title:n("blocks.start",{ns:"workflow"}),type:eb.BlockEnum.Start}),e),{}),showManageInputField:!!i,onManageInputField:()=>d?.(!0)},onChange:a,editable:!r},o)},lM="nodes.ifElse",lA=e=>{let{className:t,disabled:a,varType:r,file:s,value:l,onSelect:n}=e,{t:o}=(0,O.useTranslation)(),[i,d]=(0,y.useState)(!1),c=(0,y.useMemo)(()=>(0,lw.getOperators)(r,s).map(e=>({label:(0,lw.isComparisonOperatorNeedTranslate)(e)?o(`${lM}.comparisonOperator.${e}`,{ns:"workflow"}):e,value:e})),[o,r,s]),u=c.find(e=>Array.isArray(l)?e.value===l[0]:e.value===l);return(0,x.jsxs)(ez.PortalToFollowElem,{open:i,onOpenChange:d,placement:"bottom-end",offset:{mainAxis:4,crossAxis:0},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>d(e=>!e),children:(0,x.jsxs)(es.default,{className:(0,T.cn)("shrink-0",!u&&"opacity-50",t),size:"small",variant:"ghost",disabled:a,children:[u?u.label:o(`${lM}.select`,{ns:"workflow"}),(0,x.jsx)(M.RiArrowDownSLine,{className:"ml-1 h-3.5 w-3.5"})]})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[11]",children:(0,x.jsx)("div",{className:"rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur p-1 shadow-lg",children:c.map(e=>(0,x.jsx)("div",{className:"flex h-7 cursor-pointer items-center rounded-lg px-3 py-1.5 text-[13px] font-medium text-text-secondary hover:bg-state-base-hover",onClick:()=>{n(e.value),d(!1)},children:e.label},e.value))})})]})},lO=e=>{let{open:t,onOpenChange:a,valueSelector:r,varType:s,availableNodes:l,nodesOutputVars:n,onChange:o}=e;return(0,x.jsxs)(ez.PortalToFollowElem,{open:t,onOpenChange:a,placement:"bottom-start",offset:{mainAxis:4,crossAxis:0},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{asChild:!0,onClick:()=>a(!t),children:(0,x.jsx)("div",{className:"w-full cursor-pointer",children:(0,x.jsx)(lE.default,{valueSelector:r,varType:s,availableNodes:l,isShort:!0})})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[1000]",children:(0,x.jsx)("div",{className:"w-[296px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow-lg",children:(0,x.jsx)(aR.default,{vars:n,isSupportFileVar:!0,onChange:o})})})]})},lP="nodes.ifElse.optionName",lL=e=>{let{className:t,disabled:a,caseId:r,conditionId:s,condition:l,file:n,isSubVariableKey:o,isValueFieldShort:i,onRemoveCondition:d,onUpdateCondition:c,onAddSubVariableCondition:u,onRemoveSubVariableCondition:p,onUpdateSubVariableCondition:m,onToggleSubVariableConditionLogicalOperator:h,nodeId:g,nodesOutputVars:b,availableNodes:v,numberVariables:w,filterVar:j}=e,{t:k}=(0,O.useTranslation)(),N=(0,Z.useIsChatMode)(),[_,S]=(0,y.useState)(!1),[E,V]=(0,y.useState)(!1),{data:I}=(0,C.useAllBuiltInTools)(),{data:R}=(0,C.useAllCustomTools)(),{data:A}=(0,C.useAllWorkflowTools)(),{data:P}=(0,C.useAllMCPTools)(),L=(0,eN.useWorkflowStore)(),F=(0,y.useCallback)(e=>{o?m?.(r,s,l.id,e):c?.(r,l.id,e)},[r,l,s,o,c,m]),B=(0,y.useMemo)(()=>!a&&(!o||!!l.key),[l.key,a,o]),D=(0,y.useCallback)(e=>{F({...l,comparison_operator:e})},[l,F]),$=(0,y.useCallback)(e=>{F({...l,numberVarType:e,value:""})},[l,F]),z=l.varType===eb.VarType.arrayFile&&[l_.ComparisonOperator.contains,l_.ComparisonOperator.notContains,l_.ComparisonOperator.allOf].includes(l.comparison_operator),H=(0,y.useMemo)(()=>n||(o?{key:l.key}:void 0),[l.key,n,o]),W=H?.key==="transfer_method"||H?.key==="type",q=(0,y.useCallback)(e=>{e===l.value||W&&e===l.value?.[0]||F({...l,value:W?[e]:e})},[l,F,W]),U=l.comparison_operator&&[l_.ComparisonOperator.in,l_.ComparisonOperator.notIn].includes(l.comparison_operator),K=(0,y.useMemo)(()=>{if(U){if(H?.key==="type"||l.comparison_operator===l_.ComparisonOperator.allOf)return lN.FILE_TYPE_OPTIONS.map(e=>({name:k(`${lP}.${e.i18nKey}`,{ns:"workflow"}),value:e.value}));if(H?.key==="transfer_method")return lN.TRANSFER_METHOD.map(e=>({name:k(`${lP}.${e.i18nKey}`,{ns:"workflow"}),value:e.value}))}return[]},[l.comparison_operator,H?.key,U,k]),G=U||z,J=lN.SUB_VARIABLES.map(e=>({name:e,value:e})),X=(0,y.useCallback)(e=>{let t=(0,f.produce)(l,t=>{t.key=e,"size"===e?t.varType=eb.VarType.number:t.varType=eb.VarType.string,t.value="",t.comparison_operator=(0,lw.getOperators)(void 0,{key:e})[0]});m?.(r,s,l.id,t)},[r,l,s,m]),Q=(0,y.useCallback)(()=>{o?p?.(r,s,l.id):d?.(r,l.id)},[r,l,s,o,d,p]),{schemaTypeDefinitions:Y}=(0,tP.default)(),ee=(0,y.useCallback)((e,t)=>{let{conversationVariables:a,setControlPromptEditorRerenderKey:r,dataSourceList:s}=L.getState(),n=(0,ty.getVarType)({valueSelector:e,conversationVariables:a,availableNodes:v,isChatMode:N,allPluginInfoList:{buildInTools:I||[],customTools:R||[],mcpTools:P||[],workflowTools:A||[],dataSourceList:s||[]},schemaTypeDefinitions:Y});F((0,f.produce)(l,t=>{t.variable_selector=e,t.varType=n,t.value=n!==eb.VarType.boolean&&"",t.comparison_operator=(0,lw.getOperators)(n)[0],delete t.key,delete t.sub_variable_condition,delete t.numberVarType,setTimeout(()=>r(Date.now()))})),V(!1)},[l,F,v,N,Y,I,R,P,A]),et=(0,y.useMemo)(()=>!!(l.varType===eb.VarType.boolean||l.varType===eb.VarType.arrayBoolean&&[l_.ComparisonOperator.contains,l_.ComparisonOperator.notContains].includes(l.comparison_operator)),[l]);return(0,x.jsxs)("div",{className:(0,T.cn)("mb-1 flex last-of-type:mb-0",t),children:[(0,x.jsxs)("div",{className:(0,T.cn)("grow rounded-lg bg-components-input-bg-normal",_&&"bg-state-destructive-hover"),children:[(0,x.jsxs)("div",{className:"flex items-center p-1",children:[(0,x.jsx)("div",{className:"w-0 grow",children:o?(0,x.jsx)(la.SimpleSelect,{wrapperClassName:"h-6",className:"pl-0 text-xs",optionWrapClassName:"w-[165px] max-h-none",defaultValue:l.key,items:J,onSelect:e=>X(e.value),renderTrigger:e=>e?(0,x.jsx)("div",{className:"flex cursor-pointer justify-start",children:(0,x.jsxs)("div",{className:"inline-flex h-6 max-w-full items-center rounded-md border-[0.5px] border-components-panel-border-subtle bg-components-badge-white-to-dark px-1.5 text-text-accent shadow-xs",children:[(0,x.jsx)(r_.Variable02,{className:"h-3.5 w-3.5 shrink-0 text-text-accent"}),(0,x.jsx)("div",{className:"system-xs-medium ml-0.5 truncate",children:e?.name})]})}):(0,x.jsx)("div",{className:"system-sm-regular text-left text-components-input-text-placeholder",children:k("placeholder.select",{ns:"common"})}),hideChecked:!0}):(0,x.jsx)(lO,{open:E,onOpenChange:V,valueSelector:l.variable_selector||[],varType:l.varType,availableNodes:v,nodesOutputVars:b,onChange:ee})}),(0,x.jsx)("div",{className:"mx-1 h-3 w-[1px] bg-divider-regular"}),(0,x.jsx)(lA,{disabled:!B,varType:l.varType,value:l.comparison_operator,onSelect:D,file:H})]}),!(0,lw.comparisonOperatorNotRequireValue)(l.comparison_operator)&&!G&&l.varType!==eb.VarType.number&&!et&&(0,x.jsx)("div",{className:"max-h-[100px] overflow-y-auto border-t border-t-divider-subtle px-2 py-1",children:(0,x.jsx)(lR,{disabled:a,value:l.value,onChange:q,nodesOutputVars:b,availableNodes:v})}),!(0,lw.comparisonOperatorNotRequireValue)(l.comparison_operator)&&!G&&et&&(0,x.jsx)("div",{className:"p-1",children:(0,x.jsx)(sr.default,{value:l.value,onChange:q})}),!(0,lw.comparisonOperatorNotRequireValue)(l.comparison_operator)&&!G&&l.varType===eb.VarType.number&&(0,x.jsx)("div",{className:"border-t border-t-divider-subtle px-2 py-1 pt-[3px]",children:(0,x.jsx)(lI,{numberVarType:l.numberVarType,onNumberVarTypeChange:$,value:l.value,onValueChange:q,variables:w,isShort:i,unit:H?.key==="size"?"Byte":void 0})}),!(0,lw.comparisonOperatorNotRequireValue)(l.comparison_operator)&&U&&(0,x.jsx)("div",{className:"border-t border-t-divider-subtle",children:(0,x.jsx)(la.SimpleSelect,{wrapperClassName:"h-8",className:"rounded-t-none px-2 text-xs",defaultValue:W?l.value?.[0]:l.value,items:K,onSelect:e=>q(e.value),hideChecked:!0,notClearable:!0})}),!(0,lw.comparisonOperatorNotRequireValue)(l.comparison_operator)&&z&&(0,x.jsx)("div",{className:"p-1",children:(0,x.jsx)(lB,{isSubVariable:!0,caseId:r,conditionId:s,readOnly:!!a,cases:l.sub_variable_condition?[l.sub_variable_condition]:[],handleAddSubVariableCondition:u,handleRemoveSubVariableCondition:p,handleUpdateSubVariableCondition:m,handleToggleSubVariableConditionLogicalOperator:h,nodeId:g,nodesOutputVars:b,availableNodes:v,filterVar:j})})]}),(0,x.jsx)("div",{className:"ml-1 mt-1 flex h-6 w-6 shrink-0 cursor-pointer items-center justify-center rounded-lg text-text-tertiary hover:bg-state-destructive-hover hover:text-text-destructive",onMouseEnter:()=>S(!0),onMouseLeave:()=>S(!1),onClick:Q,children:(0,x.jsx)(M.RiDeleteBinLine,{className:"h-4 w-4"})})]})},lF=e=>{let{isSubVariable:t,disabled:a,caseId:r,conditionId:s,caseItem:l,onUpdateCondition:n,onRemoveCondition:o,onToggleConditionLogicalOperator:i,onAddSubVariableCondition:d,onRemoveSubVariableCondition:c,onUpdateSubVariableCondition:u,onToggleSubVariableConditionLogicalOperator:p,nodeId:m,nodesOutputVars:h,availableNodes:g,numberVariables:f,varsIsVarFileAttribute:b,filterVar:v}=e,{conditions:w,logical_operator:j}=l,k=(0,y.useCallback)(()=>{t?p?.(r,s):i?.(r)},[r,s,t,i,p]),N=(0,y.useMemo)(()=>!!t&&!!(w.length>1),[w.length,t]),C=(0,y.useMemo)(()=>!t||w.length<2?"":j===l_.LogicalOperator.and?"pl-[51px]":"pl-[42px]",[w.length,t,j]);return(0,x.jsxs)("div",{className:(0,T.cn)("relative",!t&&"pl-[60px]"),children:[w.length>1&&(0,x.jsxs)("div",{className:(0,T.cn)("absolute bottom-0 left-0 top-0 w-[60px]",t&&j===l_.LogicalOperator.and&&"left-[-10px]",t&&j===l_.LogicalOperator.or&&"left-[-18px]"),children:[(0,x.jsx)("div",{className:"absolute bottom-4 left-[46px] top-4 w-2.5 rounded-l-[8px] border border-r-0 border-divider-deep"}),(0,x.jsx)("div",{className:"absolute right-0 top-1/2 h-[29px] w-4 -translate-y-1/2 bg-components-panel-bg"}),(0,x.jsxs)("div",{className:"absolute right-1 top-1/2 flex h-[21px] -translate-y-1/2 cursor-pointer select-none items-center rounded-md border-[0.5px] border-components-button-secondary-border bg-components-button-secondary-bg px-1 text-[10px] font-semibold text-text-accent-secondary shadow-xs",onClick:k,children:[j.toUpperCase(),(0,x.jsx)(M.RiLoopLeftLine,{className:"ml-0.5 h-3 w-3"})]})]}),l.conditions.map(e=>(0,x.jsx)(lL,{className:C,disabled:a,caseId:r,conditionId:t?s:e.id,condition:e,isValueFieldShort:N,onUpdateCondition:n,onRemoveCondition:o,onAddSubVariableCondition:d,onRemoveSubVariableCondition:c,onUpdateSubVariableCondition:u,onToggleSubVariableConditionLogicalOperator:p,nodeId:m,nodesOutputVars:h,availableNodes:g,filterVar:v,numberVariables:f,file:b[e.id]?{key:(e.variable_selector||[]).slice(-1)[0]}:void 0,isSubVariableKey:t},e.id))]})},lB=y.memo(e=>{let{isSubVariable:t,caseId:a,conditionId:r,nodeId:s="",cases:l=[],readOnly:n,handleSortCase:o=tg.noop,handleRemoveCase:i,handleUpdateCondition:d,handleAddCondition:c,handleRemoveCondition:u,handleToggleConditionLogicalOperator:p,handleAddSubVariableCondition:m,handleRemoveSubVariableCondition:h,handleUpdateSubVariableCondition:g,handleToggleSubVariableConditionLogicalOperator:f,nodesOutputVars:b=[],availableNodes:v=[],varsIsVarFileAttribute:w={},filterVar:j=()=>!0}=e,{t:k}=(0,O.useTranslation)(),N=aV(),[C,_]=(0,y.useState)(""),S=l.length,E=(0,y.useCallback)(e=>e.type===eb.VarType.number,[]),V=lN.SUB_VARIABLES.map(e=>({name:e,value:e}));return(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(sy.ReactSortable,{list:l.map(e=>({...e,id:e.case_id})),setList:o,handle:".handle",ghostClass:"bg-components-panel-bg",animation:150,disabled:n||t,children:l.map((e,l)=>(0,x.jsxs)("div",{children:[(0,x.jsxs)("div",{className:(0,T.cn)("group relative rounded-[10px] bg-components-panel-bg",C===e.case_id&&"bg-state-destructive-hover",!t&&"min-h-[40px] px-3 py-1 ",t&&"px-1 py-2"),children:[!t&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(M.RiDraggable,{className:(0,T.cn)("handle absolute left-1 top-2 hidden h-3 w-3 cursor-pointer text-text-quaternary",S>1&&"group-hover:block")}),(0,x.jsxs)("div",{className:(0,T.cn)("absolute left-4 text-[13px] font-semibold leading-4 text-text-secondary",1===S?"top-2.5":"top-1"),children:[0===l?"IF":"ELIF",S>1&&(0,x.jsxs)("div",{className:"text-[10px] font-medium text-text-tertiary",children:["CASE",l+1]})]})]}),!!e.conditions.length&&(0,x.jsx)("div",{className:"mb-2",children:(0,x.jsx)(lF,{disabled:n,caseItem:e,caseId:t?a:e.case_id,conditionId:r,onUpdateCondition:d,onRemoveCondition:u,onToggleConditionLogicalOperator:p,nodeId:s,nodesOutputVars:b,availableNodes:v,filterVar:j,numberVariables:N(s,"",E),varsIsVarFileAttribute:w,onAddSubVariableCondition:m,onRemoveSubVariableCondition:h,onUpdateSubVariableCondition:g,onToggleSubVariableConditionLogicalOperator:f,isSubVariable:t})}),(0,x.jsxs)("div",{className:(0,T.cn)("flex items-center justify-between pr-[30px]",!e.conditions.length&&!t&&"mt-1",!e.conditions.length&&t&&"mt-2",!t&&" pl-[60px]"),children:[t?(0,x.jsx)(la.PortalSelect,{popupInnerClassName:"w-[165px] max-h-none",onSelect:e=>m?.(a,r,e.value),items:V,value:"",renderTrigger:()=>(0,x.jsxs)(es.default,{size:"small",disabled:n,children:[(0,x.jsx)(M.RiAddLine,{className:"mr-1 h-3.5 w-3.5"}),k("nodes.ifElse.addSubVariable",{ns:"workflow"})]}),hideChecked:!0}):(0,x.jsx)(lC,{disabled:n,caseId:e.case_id,variables:N(s,"",j),onSelectVariable:c}),(0===l&&S>1||l>0)&&(0,x.jsxs)(es.default,{className:"hover:bg-components-button-destructive-ghost-bg-hover hover:text-components-button-destructive-ghost-text",size:"small",variant:"ghost",disabled:n,onClick:()=>i?.(e.case_id),onMouseEnter:()=>_(e.case_id),onMouseLeave:()=>_(""),children:[(0,x.jsx)(M.RiDeleteBinLine,{className:"mr-1 h-3.5 w-3.5"}),k("operation.remove",{ns:"common"})]})]})]}),!t&&(0,x.jsx)("div",{className:"mx-3 my-2 h-px bg-divider-subtle"})]},e.case_id))}),0===l.length&&(0,x.jsxs)(es.default,{size:"small",disabled:n,onClick:()=>m?.(a,r),children:[(0,x.jsx)(M.RiAddLine,{className:"mr-1 h-3.5 w-3.5"}),k("nodes.ifElse.addSubVariable",{ns:"workflow"})]})]})}),lD="nodes.ifElse",l$=(0,y.memo)(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,filterVar:n,handleAddCase:o,handleRemoveCase:i,handleSortCase:d,handleAddCondition:c,handleUpdateCondition:u,handleRemoveCondition:p,handleToggleConditionLogicalOperator:m,handleAddSubVariableCondition:h,handleRemoveSubVariableCondition:g,handleUpdateSubVariableCondition:b,handleToggleSubVariableConditionLogicalOperator:v,nodesOutputVars:w,availableNodes:k,varsIsVarFileAttribute:N}=((e,t)=>{let a=(0,j.useUpdateNodeInternals)(),{nodesReadOnly:r}=(0,Z.useNodesReadOnly)(),{handleEdgeDeleteByDeleteBranch:s}=(0,eK.useEdgesInteractions)(),{inputs:l,setInputs:n}=(0,tZ.default)(e,t),o=(0,y.useCallback)(()=>!0,[]),{availableVars:i,availableNodesWithParent:d}=(0,t3.default)(e,{onlyLeafNodeVar:!1,filterVar:o}),c=(0,y.useCallback)(e=>e.type===eb.VarType.number,[]),{getIsVarFileAttribute:u}=(e=>{let{nodeId:t,isInIteration:a,isInLoop:r}=e,s=(0,Z.useIsChatMode)(),l=(0,j.useStoreApi)(),{getBeforeNodesInSameBranch:n}=(0,Z.useWorkflow)(),{getNodes:o}=l.getState(),i=o().find(e=>e.id===t),d=a?o().find(e=>e.id===i.parentId):null,c=r?o().find(e=>e.id===i.parentId):null,u=(0,y.useMemo)(()=>n(t),[n,t]),{getCurrentVariableType:p}=(0,aT.useWorkflowVariables)();return{getIsVarFileAttribute:e=>3===e.length&&p({parentNode:a?d:c,valueSelector:e.slice(0,2),availableNodes:u,isChatMode:s,isConstant:!1})===eb.VarType.file}})({nodeId:e,isInIteration:t.isInIteration,isInLoop:t.isInLoop}),p=(0,y.useMemo)(()=>{let e={};return l.cases?.forEach(t=>{t.conditions.forEach(t=>{e[t.id]=u(t.variable_selector)})}),e},[l.cases,u]),{availableVars:m,availableNodesWithParent:x}=(0,t3.default)(e,{onlyLeafNodeVar:!1,filterVar:c}),h=(0,y.useCallback)(()=>{n((0,f.produce)(l,e=>{if(e.cases){let t=(0,sv.v4)();if(e.cases.push({case_id:t,logical_operator:l_.LogicalOperator.and,conditions:[]}),e._targetBranches){let a=e._targetBranches.findIndex(e=>"false"===e.id);a>-1&&(e._targetBranches=(0,lw.branchNameCorrect)([...e._targetBranches.slice(0,a),{id:t,name:""},...e._targetBranches.slice(a)]))}}}))},[l,n]),g=(0,y.useCallback)(t=>{n((0,f.produce)(l,a=>{a.cases=a.cases?.filter(e=>e.case_id!==t),a._targetBranches&&(a._targetBranches=(0,lw.branchNameCorrect)(a._targetBranches.filter(e=>e.id!==t))),s(e,t)}))},[l,n,e,s]),b=(0,y.useCallback)(t=>{n((0,f.produce)(l,e=>{e.cases=t.filter(Boolean).map(e=>({id:e.id,case_id:e.case_id,logical_operator:e.logical_operator,conditions:e.conditions})),e._targetBranches=(0,lw.branchNameCorrect)([...t.filter(Boolean).map(e=>({id:e.case_id,name:""})),{id:"false",name:""}])})),a(e)},[e,l,n,a]),v=(0,y.useCallback)((e,t,a)=>{n((0,f.produce)(l,r=>{let s=r.cases?.find(t=>t.case_id===e);s&&s.conditions.push({id:(0,sv.v4)(),varType:a.type,variable_selector:t,comparison_operator:(0,lw.getOperators)(a.type,u(t)?{key:t.slice(-1)[0]}:void 0)[0],value:a.type!==eb.VarType.boolean&&a.type!==eb.VarType.arrayBoolean&&""})}))},[u,l,n]),w=(0,y.useCallback)((e,t)=>{n((0,f.produce)(l,a=>{let r=a.cases?.find(t=>t.case_id===e);r&&(r.conditions=r.conditions.filter(e=>e.id!==t))}))},[l,n]),k=(0,y.useCallback)((e,t,a)=>{n((0,f.produce)(l,r=>{let s=r.cases?.find(t=>t.case_id===e);if(s){let e=s.conditions.find(e=>e.id===t);e&&Object.assign(e,a)}}))},[l,n]),N=(0,y.useCallback)(e=>{n((0,f.produce)(l,t=>{let a=t.cases?.find(t=>t.case_id===e);a&&(a.logical_operator=a.logical_operator===l_.LogicalOperator.and?l_.LogicalOperator.or:l_.LogicalOperator.and)}))},[l,n]),C=(0,y.useCallback)((e,t,a)=>{n((0,f.produce)(l,r=>{let s=r.cases?.find(t=>t.case_id===e)?.conditions.find(e=>e.id===t);if(!s)return;s?.sub_variable_condition||(s.sub_variable_condition={case_id:(0,sv.v4)(),logical_operator:l_.LogicalOperator.and,conditions:[]});let l=s.sub_variable_condition;l&&(l.conditions||(l.conditions=[]),l.conditions.push({id:(0,sv.v4)(),key:a||"",varType:eb.VarType.string,comparison_operator:void 0,value:""}))}))},[l,n]),_=(0,y.useCallback)((e,t,a)=>{n((0,f.produce)(l,r=>{let s=r.cases?.find(t=>t.case_id===e)?.conditions.find(e=>e.id===t);if(!s||!s?.sub_variable_condition)return;let l=s.sub_variable_condition;l&&(l.conditions=l.conditions.filter(e=>e.id!==a))}))},[l,n]),T=(0,y.useCallback)((e,t,a,r)=>{n((0,f.produce)(l,s=>{let l=s.cases?.find(t=>t.case_id===e);if(l){let e=l.conditions.find(e=>e.id===t);if(e&&e.sub_variable_condition){let t=e.sub_variable_condition.conditions.find(e=>e.id===a);t&&Object.assign(t,r)}}}))},[l,n]),S=(0,y.useCallback)((e,t)=>{n((0,f.produce)(l,a=>{let r=a.cases?.find(t=>t.case_id===e);if(r){let e=r.conditions.find(e=>e.id===t);e&&e.sub_variable_condition&&(e.sub_variable_condition.logical_operator=e.sub_variable_condition.logical_operator===l_.LogicalOperator.and?l_.LogicalOperator.or:l_.LogicalOperator.and)}}))},[l,n]);return{readOnly:r,inputs:l,filterVar:o,filterNumberVar:c,handleAddCase:h,handleRemoveCase:g,handleSortCase:b,handleAddCondition:v,handleRemoveCondition:w,handleUpdateCondition:k,handleToggleConditionLogicalOperator:N,handleAddSubVariableCondition:C,handleUpdateSubVariableCondition:T,handleRemoveSubVariableCondition:_,handleToggleSubVariableConditionLogicalOperator:S,nodesOutputVars:i,availableNodes:d,nodesOutputNumberVars:m,availableNumberNodes:x,varsIsVarFileAttribute:p}})(t,a),C=l.cases||[];return(0,x.jsxs)("div",{className:"p-1",children:[(0,x.jsx)(lB,{nodeId:t,cases:C,readOnly:s,handleSortCase:d,handleRemoveCase:i,handleAddCondition:c,handleRemoveCondition:p,handleUpdateCondition:u,handleToggleConditionLogicalOperator:m,handleAddSubVariableCondition:h,handleRemoveSubVariableCondition:g,handleUpdateSubVariableCondition:b,handleToggleSubVariableConditionLogicalOperator:v,nodesOutputVars:w,availableNodes:k,varsIsVarFileAttribute:N,filterVar:n}),(0,x.jsx)("div",{className:"px-4 py-2",children:(0,x.jsxs)(es.default,{className:"w-full",variant:"tertiary",onClick:()=>o(),disabled:s,children:[(0,x.jsx)(M.RiAddLine,{className:"mr-1 h-4 w-4"}),"ELIF"]})}),(0,x.jsx)("div",{className:"mx-3 my-2 h-px bg-divider-subtle"}),(0,x.jsx)(rj,{title:r(`${lD}.else`,{ns:"workflow"}),className:"px-4 py-2",children:(0,x.jsx)("div",{className:"text-xs font-normal leading-[18px] text-text-tertiary",children:r(`${lD}.elseDescription`,{ns:"workflow"})})})]})}),lz=()=>{let{t:e}=(0,O.useTranslation)();return(0,x.jsx)("div",{className:"nodrag relative left-[17px] top-[21px] z-[11] flex h-11 w-11 items-center justify-center rounded-2xl border border-workflow-block-border bg-workflow-block-bg",children:(0,x.jsx)(B.default,{popupContent:e("blocks.iteration-start",{ns:"workflow"}),asChild:!1,children:(0,x.jsx)("div",{className:"flex h-6 w-6 items-center justify-center rounded-full border-[0.5px] border-components-panel-border-subtle bg-util-colors-blue-brand-blue-brand-500",children:(0,x.jsx)(M.RiHome5Fill,{className:"h-3 w-3 text-text-primary-on-surface"})})})})},lH=(0,y.memo)(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)();return(0,x.jsxs)("div",{className:"nodrag group mt-1 flex h-11 w-11 items-center justify-center rounded-2xl border border-workflow-block-border bg-workflow-block-bg shadow-xs",children:[(0,x.jsx)(B.default,{popupContent:r("blocks.iteration-start",{ns:"workflow"}),asChild:!1,children:(0,x.jsx)("div",{className:"flex h-6 w-6 items-center justify-center rounded-full border-[0.5px] border-components-panel-border-subtle bg-util-colors-blue-brand-blue-brand-500",children:(0,x.jsx)(M.RiHome5Fill,{className:"h-3 w-3 text-text-primary-on-surface"})})}),(0,x.jsx)(aF,{id:t,data:a,handleClassName:"!top-1/2 !-right-[9px] !-translate-y-1/2",handleId:"source"})]})}),lW=(0,y.memo)(e=>{let{iterationNodeData:t}=e,{t:a}=(0,O.useTranslation)(),{nodesReadOnly:r}=(0,Z.useNodesReadOnly)(),{handleNodeAdd:s}=(0,V.useNodesInteractions)(),{availableNextBlocks:l}=(0,X.useAvailableBlocks)(eb.BlockEnum.Start,!0),n=(0,y.useCallback)((e,a)=>{s({nodeType:e,pluginDefaultValue:a},{prevNodeId:t.start_node_id,prevNodeSourceHandle:"source"})},[s,t.start_node_id]),o=(0,y.useCallback)(e=>(0,x.jsxs)("div",{className:(0,T.cn)("system-sm-medium relative inline-flex h-8 cursor-pointer items-center rounded-lg border-[0.5px] border-components-button-secondary-border bg-components-button-secondary-bg px-3 text-components-button-secondary-text shadow-xs backdrop-blur-[5px] hover:bg-components-button-secondary-bg-hover",`${r&&"!cursor-not-allowed bg-components-button-secondary-bg-disabled"}`,e&&"bg-components-button-secondary-bg-hover"),children:[(0,x.jsx)(M.RiAddLine,{className:"mr-1 h-4 w-4"}),a("common.addBlock",{ns:"workflow"})]}),[r,a]);return(0,x.jsxs)("div",{className:"absolute left-14 top-7 z-10 flex h-8 items-center",children:[(0,x.jsx)("div",{className:"group/insert relative h-0.5 w-16 bg-gray-300",children:(0,x.jsx)("div",{className:"absolute right-0 top-1/2 h-2 w-0.5 -translate-y-1/2 bg-primary-500"})}),(0,x.jsx)(eZ.default,{disabled:r,onSelect:n,trigger:o,triggerInnerClassName:"inline-flex",popupClassName:"!min-w-[256px]",availableBlocksTypes:l})]})}),lq=(0,y.memo)(e=>{let{id:t,data:a}=e,{zoom:r}=(0,j.useViewport)(),s=(0,j.useNodesInitialized)(),{handleNodeIterationRerender:l}=(0,aw.useNodeIterationInteractions)(),{t:n}=(0,O.useTranslation)(),[o,i]=(0,y.useState)(a._isShowTips);return(0,y.useEffect)(()=>{s&&l(t),a.is_parallel&&o&&(eR.default.notify({type:"warning",message:n("nodes.iteration.answerNodeWarningDesc",{ns:"workflow"}),duration:5e3}),i(!1))},[s,t,l,a.is_parallel,o,n]),(0,x.jsxs)("div",{className:(0,T.cn)("relative h-full min-h-[90px] w-full min-w-[240px] rounded-2xl bg-workflow-canvas-workflow-bg"),children:[(0,x.jsx)(w.Background,{id:`iteration-background-${t}`,className:"!z-0 rounded-2xl",gap:[14/r,14/r],size:2/r,color:"var(--color-workflow-canvas-workflow-dot-color)"}),a._isCandidate&&(0,x.jsx)(lz,{}),1===a._children.length&&(0,x.jsx)(lW,{iterationNodeId:t,iterationNodeData:a})]})}),lU="nodes.iteration",lK=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),s=[{value:eb.ErrorHandleMode.Terminated,name:r(`${lU}.ErrorMethod.operationTerminated`,{ns:"workflow"})},{value:eb.ErrorHandleMode.ContinueOnError,name:r(`${lU}.ErrorMethod.continueOnError`,{ns:"workflow"})},{value:eb.ErrorHandleMode.RemoveAbnormalOutput,name:r(`${lU}.ErrorMethod.removeAbnormalOutput`,{ns:"workflow"})}],{readOnly:l,inputs:n,filterInputVar:o,handleInputChange:i,childrenNodeVars:d,iterationChildrenNodes:c,handleOutputVarChange:u,changeParallel:p,changeErrorResponseMode:m,changeParallelNums:h,changeFlattenOutput:b}=((e,t)=>{let{deleteNodeInspectorVars:a}=(0,ea.default)(),{nodesReadOnly:r}=(0,Z.useNodesReadOnly)(),s=(0,Z.useIsChatMode)(),{inputs:l,setInputs:n}=(0,tZ.default)(e,t),o=(0,y.useCallback)(e=>[eb.VarType.array,eb.VarType.arrayString,eb.VarType.arrayBoolean,eb.VarType.arrayNumber,eb.VarType.arrayObject,eb.VarType.arrayFile].includes(e.type),[]),i=(0,y.useCallback)((e,t,a)=>{n((0,f.produce)(l,t=>{t.iterator_selector=e||[],t.iterator_input_type=a?.type||eb.VarType.arrayString}))},[l,n]),{getIterationNodeChildren:d}=(0,Z.useWorkflow)(),c=d(e),{data:u}=(0,C.useAllBuiltInTools)(),{data:p}=(0,C.useAllCustomTools)(),{data:m}=(0,C.useAllWorkflowTools)(),{data:x}=(0,C.useAllMCPTools)(),h=(0,eN.useStore)(e=>e.dataSourceList),b=(0,ty.toNodeOutputVars)(c,s,void 0,[],[],[],{buildInTools:u||[],customTools:p||[],workflowTools:m||[],mcpTools:x||[],dataSourceList:h||[]}),v=(0,y.useCallback)((t,r,s)=>{(0,g.isEqual)(l.output_selector,t)||(n((0,f.produce)(l,e=>{e.output_selector=t||[];let a=s?.type||eb.VarType.string;e.output_type=({[eb.VarType.string]:eb.VarType.arrayString,[eb.VarType.number]:eb.VarType.arrayNumber,[eb.VarType.object]:eb.VarType.arrayObject,[eb.VarType.file]:eb.VarType.arrayFile,[eb.VarType.array]:eb.VarType.array,[eb.VarType.arrayFile]:eb.VarType.arrayFile,[eb.VarType.arrayString]:eb.VarType.arrayString,[eb.VarType.arrayNumber]:eb.VarType.arrayNumber,[eb.VarType.arrayObject]:eb.VarType.arrayObject})[a]||eb.VarType.arrayString})),a(e))},[a,e,l,n]),w=(0,y.useCallback)(e=>{n((0,f.produce)(l,t=>{t.is_parallel=e}))},[l,n]),j=(0,y.useCallback)(e=>{n((0,f.produce)(l,t=>{t.error_handle_mode=e.value}))},[l,n]),k=(0,y.useCallback)(e=>{n((0,f.produce)(l,t=>{t.parallel_nums=e}))},[l,n]),N=(0,y.useCallback)(e=>{n((0,f.produce)(l,t=>{t.flatten_output=e}))},[l,n]);return{readOnly:r,inputs:l,filterInputVar:o,handleInputChange:i,childrenNodeVars:b,iterationChildrenNodes:c,handleOutputVarChange:v,changeParallel:w,changeErrorResponseMode:j,changeParallelNums:k,changeFlattenOutput:N}})(t,a);return(0,x.jsxs)("div",{className:"pb-2 pt-2",children:[(0,x.jsx)("div",{className:"space-y-4 px-4 pb-4",children:(0,x.jsx)(rj,{title:r(`${lU}.input`,{ns:"workflow"}),required:!0,operations:(0,x.jsx)("div",{className:"system-2xs-medium-uppercase flex h-[18px] items-center rounded-[5px] border border-divider-deep px-1 capitalize text-text-tertiary",children:"Array"}),children:(0,x.jsx)(sa.default,{readonly:l,nodeId:t,isShowNodeName:!0,value:n.iterator_selector||[],onChange:i,filterVar:o})})}),(0,x.jsx)(er,{}),(0,x.jsx)("div",{className:"mt-2 space-y-4 px-4 pb-4",children:(0,x.jsx)(rj,{title:r(`${lU}.output`,{ns:"workflow"}),required:!0,operations:(0,x.jsx)("div",{className:"system-2xs-medium-uppercase flex h-[18px] items-center rounded-[5px] border border-divider-deep px-1 capitalize text-text-tertiary",children:"Array"}),children:(0,x.jsx)(sa.default,{readonly:l,nodeId:t,isShowNodeName:!0,value:n.output_selector||[],onChange:u,availableNodes:c,availableVars:d})})}),(0,x.jsx)("div",{className:"px-4 pb-2",children:(0,x.jsx)(rj,{title:r(`${lU}.parallelMode`,{ns:"workflow"}),tooltip:(0,x.jsx)("div",{className:"w-[230px]",children:r(`${lU}.parallelPanelDesc`,{ns:"workflow"})}),inline:!0,children:(0,x.jsx)(ts.default,{defaultValue:n.is_parallel,onChange:p})})}),n.is_parallel&&(0,x.jsx)("div",{className:"px-4 pb-2",children:(0,x.jsx)(rj,{title:r(`${lU}.MaxParallelismTitle`,{ns:"workflow"}),isSubTitle:!0,tooltip:(0,x.jsx)("div",{className:"w-[230px]",children:r(`${lU}.MaxParallelismDesc`,{ns:"workflow"})}),children:(0,x.jsxs)("div",{className:"row flex",children:[(0,x.jsx)(eF.default,{type:"number",wrapperClassName:"w-18 mr-4 ",max:k.MAX_PARALLEL_LIMIT,min:S.MIN_ITERATION_PARALLEL_NUM,value:n.parallel_nums,onChange:e=>{h(Number(e.target.value))}}),(0,x.jsx)(tr.default,{value:n.parallel_nums,onChange:h,max:k.MAX_PARALLEL_LIMIT,min:S.MIN_ITERATION_PARALLEL_NUM,className:" mt-4 flex-1 shrink-0"})]})})}),(0,x.jsx)(er,{}),(0,x.jsx)("div",{className:"px-4 py-2",children:(0,x.jsx)(rj,{title:r(`${lU}.errorResponseMethod`,{ns:"workflow"}),children:(0,x.jsx)(la.default,{items:s,defaultValue:n.error_handle_mode,onSelect:m,allowSearch:!1})})}),(0,x.jsx)(er,{}),(0,x.jsx)("div",{className:"px-4 py-2",children:(0,x.jsx)(rj,{title:r(`${lU}.flattenOutput`,{ns:"workflow"}),tooltip:(0,x.jsx)("div",{className:"w-[230px]",children:r(`${lU}.flattenOutputDesc`,{ns:"workflow"})}),inline:!0,children:(0,x.jsx)(ts.default,{defaultValue:n.flatten_output,onChange:b})})})]})});e.i(698628);var lG=e.i(621379),lJ=((o={}).general="text_model",o.parent_child="hierarchical_model",o.question_answer="qa_model",o),lX=e.i(127210),lX=lX,lQ=eg;let lY=(0,y.memo)(e=>{let{data:t}=e,{t:a}=(0,O.useTranslation)(),r=(()=>{let{t:e}=(0,O.useTranslation)();return{[lX.IndexingType.QUALIFIED]:e("stepTwo.qualified",{ns:"datasetCreation"}),[lX.IndexingType.ECONOMICAL]:e("form.indexMethodEconomy",{ns:"datasetSettings"}),[lQ.RETRIEVE_METHOD.semantic]:e("retrieval.semantic_search.title",{ns:"dataset"}),[lQ.RETRIEVE_METHOD.fullText]:e("retrieval.full_text_search.title",{ns:"dataset"}),[lQ.RETRIEVE_METHOD.hybrid]:e("retrieval.hybrid_search.title",{ns:"dataset"}),[lQ.RETRIEVE_METHOD.keywordSearch]:e("retrieval.keyword_search.title",{ns:"dataset"})}})();return(0,x.jsxs)("div",{className:"mb-1 space-y-0.5 px-3 py-1",children:[(0,x.jsxs)("div",{className:"flex h-6 items-center rounded-md bg-workflow-block-parma-bg px-1.5",children:[(0,x.jsx)("div",{className:"system-xs-medium-uppercase mr-2 shrink-0 text-text-tertiary",children:a("stepTwo.indexMode",{ns:"datasetCreation"})}),(0,x.jsx)("div",{className:"system-xs-medium grow truncate text-right text-text-secondary",title:t.indexing_technique,children:r[t.indexing_technique]})]}),(0,x.jsxs)("div",{className:"flex h-6 items-center rounded-md bg-workflow-block-parma-bg px-1.5",children:[(0,x.jsx)("div",{className:"system-xs-medium-uppercase mr-2 shrink-0 text-text-tertiary",children:a("form.retrievalSetting.title",{ns:"datasetSettings"})}),(0,x.jsx)("div",{className:"system-xs-medium grow truncate text-right text-text-secondary",title:t.retrieval_model?.search_method,children:r[t.retrieval_model?.search_method]})]})]})});var lZ=e.i(890644),l0=e.i(616629);e.i(422077);var l1=e.i(347056),l1=l1,l2=e.i(470046),l2=l2,l5=e.i(648203),l5=l5,l3=e.i(843569),l3=l3,l4=e.i(312178),l4=l4;e.i(9633);var l6=e.i(19412);let l8={blue:(0,x.jsx)(l1.default,{}),"blue-light":(0,x.jsx)(l2.default,{}),orange:(0,x.jsx)(l5.default,{}),purple:(0,x.jsx)(l3.default,{}),teal:(0,x.jsx)(l4.default,{})},l9=(0,y.memo)(e=>{let{id:t,selectedId:a,enableSelect:r=!0,enableHighlightBorder:s=!0,enableRadio:l,wrapperClassName:n,className:o,icon:i,title:d,description:c,isRecommended:u,children:p,effectColor:m,onClick:h,readonly:g}=e,{t:f}=(0,O.useTranslation)(),b=(0,y.useMemo)(()=>t===a,[t,a]),v=(0,y.useMemo)(()=>m?(0,x.jsx)("div",{className:(0,T.cn)("absolute left-[-2px] top-[-2px] hidden h-14 w-14 rounded-full","group-hover:block",b&&"block"),children:l8[m]}):null,[m,b]);return(0,x.jsxs)("div",{className:(0,T.cn)("group overflow-hidden rounded-xl border border-components-option-card-option-border bg-components-option-card-option-bg",b&&s&&"border-[1.5px] border-components-option-card-option-selected-border",r&&"cursor-pointer hover:shadow-xs",g&&"cursor-not-allowed",n&&("function"==typeof n?n(b):n)),onClick:e=>{e.stopPropagation(),!g&&r&&t&&h?.(t)},children:[(0,x.jsxs)("div",{className:(0,T.cn)("relative flex rounded-t-xl p-2",o&&("function"==typeof o?o(b):o)),children:[v,!!i&&(0,x.jsx)("div",{className:"mr-1 flex h-[18px] w-[18px] shrink-0 items-center justify-center",children:"function"==typeof i?i(b):i}),(0,x.jsxs)("div",{className:"grow py-1 pt-[1px]",children:[(0,x.jsxs)("div",{className:"flex items-center",children:[(0,x.jsxs)("div",{className:"system-sm-medium flex grow items-center text-text-secondary",children:[d,u&&(0,x.jsx)(r6.default,{className:"ml-1 h-4 border-text-accent-secondary text-text-accent-secondary",children:f("stepTwo.recommend",{ns:"datasetCreation"})})]}),l&&(0,x.jsx)("div",{className:(0,T.cn)("ml-2 h-4 w-4 shrink-0 rounded-full border border-components-radio-border bg-components-radio-bg",b&&"border-[5px] border-components-radio-border-checked")})]}),c&&(0,x.jsx)("div",{className:"system-xs-regular mt-1 text-text-tertiary",children:c})]})]}),!!(p&&b)&&(0,x.jsxs)("div",{className:"relative rounded-b-xl bg-components-panel-bg p-3",children:[(0,x.jsx)(l6.ArrowShape,{className:"absolute left-[14px] top-[-11px] h-4 w-4 text-components-panel-bg"}),p]})]})});var l7=e.i(334163),ne=e.i(684040),nt=e.i(92234),na=e.i(774330),na=na;let nr=y.memo(e=>{let{type:t="vertical",className:a}=e;return"vertical"===t?(0,x.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"2",height:"132",viewBox:"0 0 2 132",fill:"none",className:a,children:[(0,x.jsx)("path",{d:"M1 0L1 132",stroke:"url(#paint0_linear_10882_18766)"}),(0,x.jsx)("defs",{children:(0,x.jsxs)("linearGradient",{id:"paint0_linear_10882_18766",x1:"-7.99584",y1:"132",x2:"-7.96108",y2:"6.4974e-07",gradientUnits:"userSpaceOnUse",children:[(0,x.jsx)("stop",{stopColor:"var(--color-background-gradient-mask-transparent)"}),(0,x.jsx)("stop",{offset:"0.877606",stopColor:"var(--color-divider-subtle)"}),(0,x.jsx)("stop",{offset:"1",stopColor:"var(--color-background-gradient-mask-transparent)"})]})})]}):(0,x.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"240",height:"2",viewBox:"0 0 240 2",fill:"none",className:a,children:[(0,x.jsx)("path",{d:"M0 1H240",stroke:"url(#paint0_linear_10882_18763)"}),(0,x.jsx)("defs",{children:(0,x.jsxs)("linearGradient",{id:"paint0_linear_10882_18763",x1:"240",y1:"9.99584",x2:"3.95539e-05",y2:"9.88094",gradientUnits:"userSpaceOnUse",children:[(0,x.jsx)("stop",{stopColor:"var(--color-background-gradient-mask-transparent)"}),(0,x.jsx)("stop",{offset:"0.9031",stopColor:"var(--color-divider-subtle)"}),(0,x.jsx)("stop",{offset:"1",stopColor:"var(--color-background-gradient-mask-transparent)"})]})})]})}),ns=y.memo(e=>{let{className:t}=e,{t:a}=(0,O.useTranslation)(),r=(0,eq.useDocLink)();return(0,x.jsxs)("div",{className:(0,T.cn)("flex flex-col gap-y-2 overflow-hidden rounded-[10px] bg-workflow-process-bg p-4",t),children:[(0,x.jsxs)("div",{className:"relative flex size-10 items-center justify-center rounded-[10px] border-[0.5px] border-components-card-border bg-components-card-bg shadow-lg backdrop-blur-[5px]",children:[(0,x.jsx)(na.default,{className:"size-5 text-text-accent"}),(0,x.jsx)(nr,{className:"absolute -left-px bottom-[-76px]",type:"vertical"}),(0,x.jsx)(nr,{className:"absolute -right-px bottom-[-76px]",type:"vertical"}),(0,x.jsx)(nr,{className:"absolute -top-px right-[-184px]",type:"horizontal"}),(0,x.jsx)(nr,{className:"absolute -bottom-px right-[-184px]",type:"horizontal"})]}),(0,x.jsxs)("div",{className:"flex flex-col gap-y-1",children:[(0,x.jsx)("div",{className:"system-sm-medium text-text-secondary",children:a("nodes.knowledgeBase.chunkStructureTip.title",{ns:"workflow"})}),(0,x.jsxs)("div",{className:"system-xs-regular",children:[(0,x.jsx)("p",{className:"text-text-tertiary",children:a("nodes.knowledgeBase.chunkStructureTip.message",{ns:"workflow"})}),(0,x.jsx)("a",{href:r("/use-dify/knowledge/create-knowledge/chunking-and-cleaning-text"),target:"_blank",rel:"noopener noreferrer",className:"text-text-accent",children:a("nodes.knowledgeBase.chunkStructureTip.learnMore",{ns:"workflow"})})]})]})]})}),nl=e=>{let{options:t,value:a,onChange:r,readonly:s,trigger:l}=e,{t:n}=(0,O.useTranslation)(),[o,i]=(0,y.useState)(!1),d=(0,y.useCallback)(e=>{r(e),i(!1)},[r]);return(0,x.jsxs)(ez.PortalToFollowElem,{placement:"bottom-end",offset:{mainAxis:0,crossAxis:-8},open:o,onOpenChange:i,children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{asChild:!0,onClick:()=>{s||i(!o)},children:l||(0,x.jsx)(es.default,{size:"small",variant:"ghost-accent",children:n("panel.change",{ns:"workflow"})})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-10",children:(0,x.jsxs)("div",{className:"w-[404px] rounded-2xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow-xl backdrop-blur-[5px]",children:[(0,x.jsx)("div",{className:"system-sm-semibold px-3 pt-3.5 text-text-primary",children:n("nodes.knowledgeBase.changeChunkStructure",{ns:"workflow"})}),(0,x.jsx)("div",{className:"space-y-1 p-3 pt-2",children:t.map(e=>(0,x.jsx)(l9,{id:e.id,selectedId:a,icon:e.icon,title:e.title,description:e.description,readonly:s,onClick:d,effectColor:e.effectColor},e.id))})]})})]})},nn=(0,y.memo)(e=>{let{chunkStructure:t,onChunkStructureChange:a,readonly:r=!1}=e,{t:s}=(0,O.useTranslation)(),{options:l,optionMap:n}=(()=>{let{t:e}=(0,O.useTranslation)(),t={id:lJ.general,icon:e=>(0,x.jsx)(l7.GeneralChunk,{className:(0,T.cn)("h-[18px] w-[18px] text-text-tertiary group-hover:text-util-colors-indigo-indigo-600",e&&"text-util-colors-indigo-indigo-600")}),title:e("stepTwo.general",{ns:"datasetCreation"}),description:e("stepTwo.generalTip",{ns:"datasetCreation"}),effectColor:"blue"},a={id:lJ.parent_child,icon:e=>(0,x.jsx)(ne.ParentChildChunk,{className:(0,T.cn)("h-[18px] w-[18px] text-text-tertiary group-hover:text-util-colors-blue-light-blue-light-500",e&&"text-util-colors-blue-light-blue-light-500")}),title:e("stepTwo.parentChild",{ns:"datasetCreation"}),description:e("stepTwo.parentChildTip",{ns:"datasetCreation"}),effectColor:"blue-light"},r={id:lJ.question_answer,icon:e=>(0,x.jsx)(nt.QuestionAndAnswer,{className:(0,T.cn)("h-[18px] w-[18px] text-text-tertiary group-hover:text-util-colors-teal-teal-600",e&&"text-util-colors-teal-teal-600")}),title:"Q&A",description:e("stepTwo.qaTip",{ns:"datasetCreation"}),effectColor:"teal"},s={[lJ.general]:t,[lJ.parent_child]:a,[lJ.question_answer]:r};return{options:[t,a,r],optionMap:s}})();return(0,x.jsxs)(sO,{fieldTitleProps:{title:s("nodes.knowledgeBase.chunkStructure",{ns:"workflow"}),tooltip:s("nodes.knowledgeBase.chunkStructureTip.message",{ns:"workflow"}),operation:t&&(0,x.jsx)(nl,{options:l,value:t,onChange:a,readonly:r})},children:[!!t&&(0,x.jsx)(l9,{...n[t],selectedId:t,enableSelect:!1,enableHighlightBorder:!1}),!t&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(nl,{options:l,onChange:a,readonly:r,trigger:(0,x.jsxs)(es.default,{className:"w-full",variant:"secondary-accent",children:[(0,x.jsx)(M.RiAddLine,{className:"mr-1 h-4 w-4"}),s("nodes.knowledgeBase.chooseChunkStructure",{ns:"workflow"})]})}),(0,x.jsx)(ns,{className:"mt-2"})]})]})}),no=(0,y.memo)(e=>{let{embeddingModel:t,embeddingModelProvider:a,onEmbeddingModelChange:r,readonly:s=!1}=e,{t:l}=(0,O.useTranslation)(),{data:n}=(0,$.useModelList)(t0.ModelTypeEnum.textEmbedding),o=(0,y.useMemo)(()=>{if(t&&a)return{providerName:a,modelName:t}},[t,a]),i=(0,y.useCallback)(e=>{r?.({embeddingModelProvider:e.provider,embeddingModel:e.model})},[r]);return(0,x.jsx)(sO,{fieldTitleProps:{title:l("form.embeddingModel",{ns:"datasetSettings"})},children:(0,x.jsx)(a2.default,{defaultModel:o&&{provider:o.providerName,model:o.modelName},modelList:n,onSelect:i,readonly:s,showDeprecatedWarnIcon:!0})})});var ni=e.i(459946),nd=e.i(229897),lX=lX;let nc=(0,y.memo)(e=>{let{chunkStructure:t,indexMethod:a,onIndexMethodChange:r,keywordNumber:s,onKeywordNumberChange:l,readonly:n=!1}=e,{t:o}=(0,O.useTranslation)(),i=a===lX.IndexingType.QUALIFIED,d=a===lX.IndexingType.ECONOMICAL,c=(0,y.useCallback)(e=>{r(e)},[r]),u=(0,y.useCallback)(e=>{let t=Number(e.target.value);Number.isNaN(t)||l(t)},[l]);return(0,x.jsx)(sO,{fieldTitleProps:{title:o("stepTwo.indexMode",{ns:"datasetCreation"})},children:(0,x.jsxs)("div",{className:"space-y-1",children:[(0,x.jsx)(l9,{id:lX.IndexingType.QUALIFIED,selectedId:a,icon:(0,x.jsx)(nd.HighQuality,{className:(0,T.cn)("h-[15px] w-[15px] text-text-tertiary group-hover:text-util-colors-orange-orange-500",i&&"text-util-colors-orange-orange-500")}),title:o("stepTwo.qualified",{ns:"datasetCreation"}),description:o("form.indexMethodHighQualityTip",{ns:"datasetSettings"}),onClick:c,isRecommended:!0,effectColor:"orange"}),t===lJ.general&&(0,x.jsx)(l9,{id:lX.IndexingType.ECONOMICAL,selectedId:a,icon:(0,x.jsx)(ni.Economic,{className:(0,T.cn)("h-[15px] w-[15px] text-text-tertiary group-hover:text-util-colors-indigo-indigo-500",d&&"text-util-colors-indigo-indigo-500")}),title:o("form.indexMethodEconomy",{ns:"datasetSettings"}),description:o("form.indexMethodEconomyTip",{ns:"datasetSettings",count:s}),onClick:c,effectColor:"blue",children:(0,x.jsxs)("div",{className:"flex items-center",children:[(0,x.jsxs)("div",{className:"flex grow items-center",children:[(0,x.jsx)("div",{className:"system-xs-medium truncate text-text-secondary",children:o("form.numberOfKeywords",{ns:"datasetSettings"})}),(0,x.jsx)(B.default,{popupContent:"number of keywords",children:(0,x.jsx)(M.RiQuestionLine,{className:"ml-0.5 h-3.5 w-3.5 text-text-quaternary"})})]}),(0,x.jsx)(tr.default,{disabled:n,className:"mr-3 w-24 shrink-0",value:s,onChange:l}),(0,x.jsx)(eF.default,{disabled:n,className:"shrink-0",wrapperClassName:"shrink-0 w-[72px]",type:"number",value:s,onChange:u})]})})]})})});var nu=e.i(976650),np=e.i(713669),nm=e.i(526016),nx=lG,lX=lX,lQ=eg,nh=e.i(536500);e.i(793622);var ng=e.i(259509),nx=lG,lQ=eg;let nf=(0,y.memo)(e=>{let{rerankingModel:t,onRerankingModelChange:a,readonly:r=!1}=e,{modelList:s}=(0,$.useModelListAndDefaultModel)(t0.ModelTypeEnum.rerank),l=(0,y.useMemo)(()=>{if(t)return{providerName:t.reranking_provider_name,modelName:t.reranking_model_name}},[t]);return(0,x.jsx)(a2.default,{defaultModel:l&&{provider:l.providerName,model:l.modelName},modelList:s,onSelect:e=>{a?.({reranking_provider_name:e.provider,reranking_model_name:e.model})},readonly:r,showDeprecatedWarnIcon:!0})}),nb={amount:1,min:1,max:(t=Number.parseInt(globalThis.document?.body?.getAttribute("data-public-top-k-max-value")||"",10))&&!isNaN(t)?t:10},ny={step:.01,min:0,max:1},nv=(0,y.memo)(e=>{let{topK:t,onTopKChange:a,scoreThreshold:r,onScoreThresholdChange:s,isScoreThresholdEnabled:l,onScoreThresholdEnabledChange:n,readonly:o,hiddenScoreThreshold:i}=e,{t:d}=(0,O.useTranslation)(),c=(0,y.useCallback)(e=>{let t=Number.parseInt(e.toFixed(0));t=Math.max(nb.min,t),t=Math.min(nb.max,t),a?.(t)},[a]);return(0,x.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,x.jsxs)("div",{children:[(0,x.jsxs)("div",{className:"system-xs-medium mb-0.5 flex h-6 items-center text-text-secondary",children:[d("datasetConfig.top_k",{ns:"appDebug"}),(0,x.jsx)(B.default,{triggerClassName:"ml-0.5 shrink-0 w-3.5 h-3.5",popupContent:d("datasetConfig.top_kTip",{ns:"appDebug"})})]}),(0,x.jsx)(rr.InputNumber,{disabled:o,type:"number",...nb,size:"regular",value:t,onChange:c})]}),!i&&(0,x.jsxs)("div",{children:[(0,x.jsxs)("div",{className:"mb-0.5 flex h-6 items-center",children:[(0,x.jsx)(ts.default,{className:"mr-2",defaultValue:l,onChange:n,disabled:o}),(0,x.jsx)("div",{className:"system-sm-medium grow truncate text-text-secondary",children:d("datasetConfig.score_threshold",{ns:"appDebug"})}),(0,x.jsx)(B.default,{triggerClassName:"shrink-0 ml-0.5 w-3.5 h-3.5",popupContent:d("datasetConfig.score_thresholdTip",{ns:"appDebug"})})]}),(0,x.jsx)(rr.InputNumber,{disabled:o||!l,type:"number",...ny,size:"regular",value:r,onChange:e=>{let t=Number.parseFloat(e.toFixed(2));t=Math.max(ny.min,t),t=Math.min(ny.max,t),s?.(t)}})]})]})}),nw=(0,y.memo)(e=>{let{readonly:t,option:a,hybridSearchModeOptions:r,searchMethod:s,onRetrievalSearchMethodChange:l,hybridSearchMode:n,onHybridSearchModeChange:o,weightedScore:i,onWeightedScoreChange:d,rerankingModelEnabled:c,onRerankingModelEnabledChange:u,rerankingModel:p,onRerankingModelChange:m,topK:h,onTopKChange:g,scoreThreshold:f,onScoreThresholdChange:b,isScoreThresholdEnabled:v,onScoreThresholdEnabledChange:w,showMultiModalTip:j=!1}=e,{t:k}=(0,O.useTranslation)(),N=a.icon,C=a.id===lQ.RETRIEVE_METHOD.hybrid,_=n===nx.RerankingModeEnum.WeightedScore,S=(0,y.useMemo)(()=>({value:[i?.vector_setting.vector_weight??lG.DEFAULT_WEIGHTED_SCORE.other.semantic,i?.keyword_setting.keyword_weight??lG.DEFAULT_WEIGHTED_SCORE.other.keyword]}),[i]),E=(0,y.useCallback)(e=>(0,x.jsx)(N,{className:(0,T.cn)("h-[15px] w-[15px] text-text-tertiary group-hover:text-util-colors-purple-purple-600",e&&"text-util-colors-purple-purple-600")}),[N]),V=(0,y.useCallback)(e=>e?"border-[1.5px] bg-components-option-card-option-selected-bg":"",[]),I=(0,y.useMemo)(()=>s===lQ.RETRIEVE_METHOD.semantic||s===lQ.RETRIEVE_METHOD.fullText,[s]),R=(0,y.useMemo)(()=>s===lQ.RETRIEVE_METHOD.semantic||s===lQ.RETRIEVE_METHOD.fullText||s===lQ.RETRIEVE_METHOD.hybrid&&n!==nx.RerankingModeEnum.WeightedScore,[n,s]);return(0,x.jsx)(l9,{id:a.id,selectedId:s,icon:E,title:a.title,description:a.description,effectColor:a.effectColor,isRecommended:a.id===lQ.RETRIEVE_METHOD.hybrid,onClick:l,readonly:t,children:(0,x.jsxs)("div",{className:"space-y-3",children:[C&&(0,x.jsx)("div",{className:"space-y-1",children:r.map(e=>(0,x.jsx)(l9,{id:e.id,selectedId:n,enableHighlightBorder:!1,enableRadio:!0,wrapperClassName:V,className:"p-3",title:e.title,description:e.description,onClick:o,readonly:t},e.id))}),C&&_&&(0,x.jsx)(nh.default,{value:S,onChange:d,readonly:t}),R&&(0,x.jsxs)("div",{children:[I&&(0,x.jsxs)("div",{className:"system-sm-semibold mb-1 flex items-center text-text-secondary",children:[(0,x.jsx)(ts.default,{className:"mr-1",defaultValue:c,onChange:u,disabled:t}),k("modelProvider.rerankModel.key",{ns:"common"}),(0,x.jsx)(B.default,{triggerClassName:"ml-0.5 shrink-0 w-3.5 h-3.5",popupContent:k("modelProvider.rerankModel.tip",{ns:"common"})})]}),(0,x.jsx)(nf,{rerankingModel:p,onRerankingModelChange:m,readonly:t}),j&&(0,x.jsxs)("div",{className:"mt-2 flex h-10 items-center gap-x-0.5 overflow-hidden rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur p-2 shadow-xs backdrop-blur-[5px]",children:[(0,x.jsx)("div",{className:"absolute bottom-0 left-0 right-0 top-0 bg-dataset-warning-message-bg opacity-40"}),(0,x.jsx)("div",{className:"p-1",children:(0,x.jsx)(ng.AlertTriangle,{className:"size-4 text-text-warning-secondary"})}),(0,x.jsx)("span",{className:"system-xs-medium text-text-primary",children:k("form.retrievalSetting.multiModalTip",{ns:"datasetSettings"})})]})]}),(0,x.jsx)(nv,{topK:h,onTopKChange:g,scoreThreshold:f,onScoreThresholdChange:b,isScoreThresholdEnabled:v,onScoreThresholdEnabledChange:w,readonly:t,hiddenScoreThreshold:s===lQ.RETRIEVE_METHOD.keywordSearch})]})},a.id)}),nj=(0,y.memo)(e=>{let{indexMethod:t,readonly:a,searchMethod:r,onRetrievalSearchMethodChange:s,hybridSearchMode:l,onHybridSearchModeChange:n,weightedScore:o,onWeightedScoreChange:i,rerankingModelEnabled:d,onRerankingModelEnabledChange:c,rerankingModel:u,onRerankingModelChange:p,topK:m,onTopKChange:h,scoreThreshold:g,onScoreThresholdChange:f,isScoreThresholdEnabled:b,onScoreThresholdEnabledChange:v,showMultiModalTip:w}=e,{t:j}=(0,O.useTranslation)(),k=(0,eq.useDocLink)(),{options:N,hybridSearchModeOptions:C}=(e=>{let{t}=(0,O.useTranslation)(),a=(0,y.useMemo)(()=>({id:lQ.RETRIEVE_METHOD.semantic,icon:nm.VectorSearch,title:t("retrieval.semantic_search.title",{ns:"dataset"}),description:t("retrieval.semantic_search.description",{ns:"dataset"}),effectColor:"purple"}),[t]),r=(0,y.useMemo)(()=>({id:lQ.RETRIEVE_METHOD.fullText,icon:nu.FullTextSearch,title:t("retrieval.full_text_search.title",{ns:"dataset"}),description:t("retrieval.full_text_search.description",{ns:"dataset"}),effectColor:"purple"}),[t]),s=(0,y.useMemo)(()=>({id:lQ.RETRIEVE_METHOD.hybrid,icon:np.HybridSearch,title:t("retrieval.hybrid_search.title",{ns:"dataset"}),description:t("retrieval.hybrid_search.description",{ns:"dataset"}),effectColor:"purple"}),[t]),l=(0,y.useMemo)(()=>({id:lQ.RETRIEVE_METHOD.keywordSearch,icon:np.HybridSearch,title:t("retrieval.keyword_search.title",{ns:"dataset"}),description:t("retrieval.keyword_search.description",{ns:"dataset"}),effectColor:"purple"}),[t]),n=(0,y.useMemo)(()=>({id:nx.RerankingModeEnum.WeightedScore,title:t("weightedScore.title",{ns:"dataset"}),description:t("weightedScore.description",{ns:"dataset"})}),[t]),o=(0,y.useMemo)(()=>({id:nx.RerankingModeEnum.RerankingModel,title:t("modelProvider.rerankModel.key",{ns:"common"}),description:t("modelProvider.rerankModel.tip",{ns:"common"})}),[t]);return(0,y.useMemo)(()=>({options:e===lX.IndexingType.ECONOMICAL?[l]:[a,r,s],hybridSearchModeOptions:[n,o]}),[a,r,s,l,e,n,o])})(t);return(0,x.jsx)(sO,{fieldTitleProps:{title:j("form.retrievalSetting.title",{ns:"datasetSettings"}),subTitle:(0,x.jsxs)("div",{className:"body-xs-regular flex items-center text-text-tertiary",children:[(0,x.jsx)("a",{target:"_blank",rel:"noopener noreferrer",href:k("/use-dify/knowledge/create-knowledge/setting-indexing-methods"),className:"text-text-accent",children:j("form.retrievalSetting.learnMore",{ns:"datasetSettings"})})," ",j("nodes.knowledgeBase.aboutRetrieval",{ns:"workflow"})]})},children:(0,x.jsx)("div",{className:"space-y-1",children:N.map(e=>(0,x.jsx)(nw,{option:e,hybridSearchModeOptions:C,searchMethod:r,onRetrievalSearchMethodChange:s,hybridSearchMode:l,onHybridSearchModeChange:n,weightedScore:o,onWeightedScoreChange:i,topK:m,onTopKChange:h,scoreThreshold:g,onScoreThresholdChange:f,isScoreThresholdEnabled:b,onScoreThresholdEnabledChange:v,rerankingModelEnabled:d,onRerankingModelEnabledChange:c,rerankingModel:u,onRerankingModelChange:p,readonly:a,showMultiModalTip:w},e.id))})})});var nx=lG,lX=lX,lQ=eg,lX=lX;let nk=(0,y.memo)(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{nodesReadOnly:s}=(0,Z.useNodesReadOnly)(),{data:l}=(0,$.useModelList)(t0.ModelTypeEnum.textEmbedding),{data:n}=(0,$.useModelList)(t0.ModelTypeEnum.rerank),{handleChunkStructureChange:o,handleIndexMethodChange:i,handleKeywordNumberChange:d,handleEmbeddingModelChange:c,handleRetrievalSearchMethodChange:u,handleHybridSearchModeChange:p,handleRerankingModelEnabledChange:m,handleWeighedScoreChange:h,handleRerankingModelChange:g,handleTopKChange:b,handleScoreThresholdChange:v,handleScoreThresholdEnabledChange:w,handleInputVariableChange:k,handleSummaryIndexSettingChange:N}=(e=>{let t=(0,j.useStoreApi)(),{handleNodeDataUpdateWithSyncDraft:a}=(0,Q.useNodeDataUpdate)(),r=(0,y.useCallback)(()=>{let{getNodes:a}=t.getState();return a().find(t=>t.id===e)},[t,e]),s=(0,y.useCallback)(t=>{a({id:e,data:t})},[e,a]),l=(0,y.useCallback)(e=>{let{embeddingModel:t,embeddingModelProvider:a}=e;return{vector_setting:{vector_weight:lG.DEFAULT_WEIGHTED_SCORE.other.semantic,embedding_provider_name:a||"",embedding_model_name:t},keyword_setting:{keyword_weight:lG.DEFAULT_WEIGHTED_SCORE.other.keyword}}},[]),n=(0,y.useCallback)(e=>{let t=r(),{indexing_technique:a,retrieval_model:l,chunk_structure:n,index_chunk_variable_selector:o}=t?.data||{},{search_method:i}=l||{};s({chunk_structure:e,indexing_technique:e===lJ.parent_child||e===lJ.question_answer?lX.IndexingType.QUALIFIED:a,retrieval_model:{...l,search_method:e!==lJ.parent_child&&e!==lJ.question_answer||i===lQ.RETRIEVE_METHOD.semantic||i===lQ.RETRIEVE_METHOD.hybrid||i===lQ.RETRIEVE_METHOD.fullText?i:lQ.RETRIEVE_METHOD.keywordSearch},index_chunk_variable_selector:e===n?o:[]})},[s,r]),o=(0,y.useCallback)(e=>{let t=r();s((0,f.produce)(t?.data,t=>{t.indexing_technique=e,e===lX.IndexingType.ECONOMICAL?t.retrieval_model.search_method=lQ.RETRIEVE_METHOD.keywordSearch:e===lX.IndexingType.QUALIFIED&&(t.retrieval_model.search_method=lQ.RETRIEVE_METHOD.semantic)}))},[s,r]),i=(0,y.useCallback)(e=>{s({keyword_number:e})},[s]),d=(0,y.useCallback)(e=>{let{embeddingModel:t,embeddingModelProvider:a}=e,n=r(),o=l({embeddingModel:t,embeddingModelProvider:a}),i={embedding_model:t,embedding_model_provider:a,retrieval_model:{...n?.data.retrieval_model}};i.retrieval_model.weights?i.retrieval_model={...i.retrieval_model,weights:{...i.retrieval_model.weights,vector_setting:{...i.retrieval_model.weights.vector_setting,embedding_provider_name:a,embedding_model_name:t}}}:i.retrieval_model={...i.retrieval_model,weights:o},s(i)},[r,l,s]),c=(0,y.useCallback)(e=>{let t=r(),a={retrieval_model:{...t?.data.retrieval_model,search_method:e,reranking_mode:t?.data.retrieval_model.reranking_mode||lG.RerankingModeEnum.RerankingModel}};e===lQ.RETRIEVE_METHOD.hybrid&&(a.retrieval_model={...a.retrieval_model,reranking_enable:a.retrieval_model.reranking_mode===lG.RerankingModeEnum.RerankingModel}),s(a)},[r,s]),u=(0,y.useCallback)(e=>{let t=r(),a=l({embeddingModel:t?.data.embedding_model||"",embeddingModelProvider:t?.data.embedding_model_provider||""});s({retrieval_model:{...t?.data.retrieval_model,reranking_mode:e,reranking_enable:e===nx.RerankingModeEnum.RerankingModel,weights:t?.data.retrieval_model.weights||a}})},[r,l,s]),p=(0,y.useCallback)(e=>{let t=r();s({retrieval_model:{...t?.data.retrieval_model,reranking_enable:e}})},[r,s]),m=(0,y.useCallback)(e=>{let t=r();s({retrieval_model:{...t?.data.retrieval_model,weights:{weight_type:lG.WeightedScoreEnum.Customized,vector_setting:{...t?.data.retrieval_model.weights?.vector_setting,vector_weight:e.value[0]},keyword_setting:{keyword_weight:e.value[1]}}}})},[r,s]),x=(0,y.useCallback)(e=>{let t=r();s({retrieval_model:{...t?.data.retrieval_model,reranking_model:{reranking_provider_name:e.reranking_provider_name,reranking_model_name:e.reranking_model_name}}})},[r,s]),h=(0,y.useCallback)(e=>{let t=r();s({retrieval_model:{...t?.data.retrieval_model,top_k:e}})},[r,s]),g=(0,y.useCallback)(e=>{let t=r();s({retrieval_model:{...t?.data.retrieval_model,score_threshold:e}})},[r,s]),b=(0,y.useCallback)(e=>{let t=r();s({retrieval_model:{...t?.data.retrieval_model,score_threshold_enabled:e}})},[r,s]);return{handleChunkStructureChange:n,handleIndexMethodChange:o,handleKeywordNumberChange:i,handleEmbeddingModelChange:d,handleRetrievalSearchMethodChange:c,handleHybridSearchModeChange:u,handleRerankingModelEnabledChange:p,handleWeighedScoreChange:m,handleRerankingModelChange:x,handleTopKChange:h,handleScoreThresholdChange:g,handleScoreThresholdEnabledChange:b,handleInputVariableChange:(0,y.useCallback)(e=>{s({index_chunk_variable_selector:Array.isArray(e)?e:[]})},[s]),handleSummaryIndexSettingChange:(0,y.useCallback)(e=>{let t=r();s({summary_index_setting:{...t?.data.summary_index_setting,...e}})},[s,r])}})(t),C=(0,y.useCallback)(e=>{if(!a.chunk_structure)return!1;switch(a.chunk_structure){case lJ.general:return"general_structure"===e.schemaType||"multimodal_general_structure"===e.schemaType;case lJ.parent_child:return"parent_child_structure"===e.schemaType||"multimodal_parent_child_structure"===e.schemaType;case lJ.question_answer:return"qa_structure"===e.schemaType;default:return!1}},[a.chunk_structure]),_=(0,y.useMemo)(()=>{if(!a.chunk_structure)return"";let e="";switch(a.chunk_structure){case lJ.general:e="(multimodal_)general_structure";break;case lJ.parent_child:e="(multimodal_)parent_child_structure";break;case lJ.question_answer:e="qa_structure";break;default:return""}return e.charAt(0).toUpperCase()+e.slice(1)},[a.chunk_structure]),T=(0,y.useMemo)(()=>(0,l0.checkShowMultiModalTip)({embeddingModel:{provider:a.embedding_model_provider??"",model:a.embedding_model??""},rerankingEnable:!!a.retrieval_model?.reranking_enable,rerankModel:{rerankingProviderName:a.retrieval_model?.reranking_model?.reranking_provider_name??"",rerankingModelName:a.retrieval_model?.reranking_model?.reranking_model_name??""},indexMethod:a.indexing_technique,embeddingModelList:l,rerankModelList:n}),[a.embedding_model_provider,a.embedding_model,a.retrieval_model?.reranking_enable,a.retrieval_model?.reranking_model,a.indexing_technique,l,n]);return(0,x.jsxs)("div",{children:[(0,x.jsx)(sI,{className:"py-3",withBorderBottom:!!a.chunk_structure,children:(0,x.jsx)(nn,{chunkStructure:a.chunk_structure,onChunkStructureChange:o,readonly:s})}),!!a.chunk_structure&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(sP,{boxGroupProps:{boxProps:{withBorderBottom:!0}},fieldProps:{fieldTitleProps:{title:r("nodes.knowledgeBase.chunksInput",{ns:"workflow"}),tooltip:r("nodes.knowledgeBase.chunksInputTip",{ns:"workflow"})}},children:(0,x.jsx)(sa.default,{nodeId:t,isShowNodeName:!0,value:a.index_chunk_variable_selector,onChange:k,readonly:s,filterVar:C,isFilterFileVar:!0,isSupportFileVar:!1,preferSchemaType:!0,typePlaceHolder:_})}),(0,x.jsx)(sR,{children:(0,x.jsxs)("div",{className:"space-y-3",children:[(0,x.jsx)(nc,{chunkStructure:a.chunk_structure,indexMethod:a.indexing_technique,onIndexMethodChange:i,keywordNumber:a.keyword_number,onKeywordNumberChange:d,readonly:s}),a.indexing_technique===lX.IndexingType.QUALIFIED&&(0,x.jsx)(no,{embeddingModel:a.embedding_model,embeddingModelProvider:a.embedding_model_provider,onEmbeddingModelChange:c,readonly:s}),(0,x.jsx)("div",{className:"pt-1",children:(0,x.jsx)(er,{className:"h-[1px]"})}),a.indexing_technique===lX.IndexingType.QUALIFIED&&[lJ.general,lJ.parent_child].includes(a.chunk_structure)&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(lZ.default,{summaryIndexSetting:a.summary_index_setting,onSummaryIndexSettingChange:N,readonly:s}),(0,x.jsx)("div",{className:"pt-1",children:(0,x.jsx)(er,{className:"h-[1px]"})})]}),(0,x.jsx)(nj,{indexMethod:a.indexing_technique,searchMethod:a.retrieval_model.search_method,onRetrievalSearchMethodChange:u,hybridSearchMode:a.retrieval_model.reranking_mode,onHybridSearchModeChange:p,weightedScore:a.retrieval_model.weights,onWeightedScoreChange:h,rerankingModelEnabled:a.retrieval_model.reranking_enable,onRerankingModelEnabledChange:m,rerankingModel:a.retrieval_model.reranking_model,onRerankingModelChange:g,topK:a.retrieval_model.top_k,onTopKChange:b,scoreThreshold:a.retrieval_model.score_threshold,onScoreThresholdChange:v,isScoreThresholdEnabled:a.retrieval_model.score_threshold_enabled,onScoreThresholdEnabledChange:w,showMultiModalTip:T,readonly:s})]})})]})]})}),nN=y.memo(e=>{let{data:t}=e,[a,r]=(0,y.useState)([]),s=(0,ae.useDatasetsDetailStore)(e=>e.datasetsDetail);return((0,y.useEffect)(()=>{t.dataset_ids?.length>0?r(t.dataset_ids.reduce((e,t)=>(s[t]&&e.push(s[t]),e),[])):r([])},[t.dataset_ids,s]),a.length)?(0,x.jsx)("div",{className:"mb-1 px-3 py-1",children:(0,x.jsx)("div",{className:"space-y-0.5",children:a.map(e=>{let{id:t,name:a,icon_info:r}=e;return(0,x.jsxs)("div",{className:"flex h-[26px] items-center gap-x-1 rounded-md bg-workflow-block-parma-bg px-1",children:[(0,x.jsx)(a3.default,{size:"xs",iconType:r.icon_type,icon:r.icon,background:"image"===r.icon_type?void 0:r.icon_background,imageUrl:"image"===r.icon_type?r.icon_url:void 0,className:"shrink-0"}),(0,x.jsx)("div",{className:"system-xs-regular w-0 grow truncate text-text-secondary",children:a})]},t)})})}):null});var nC=e.i(966739),n_=e.i(766293);let nT=y.memo(e=>{let{selectedIds:t,onChange:a}=e,[r,{setTrue:s,setFalse:l}]=(0,an.useBoolean)(!1),n=(0,y.useCallback)(e=>{a(e),l()},[a,l]);return(0,x.jsxs)("div",{children:[(0,x.jsx)(eM.default,{onClick:s}),r&&(0,x.jsx)(n_.default,{isShow:r,onClose:l,selectedIds:t,onSelect:n})]})});var nS=e.i(711536),nE=e.i(221927),nV=e.i(619434),nI=e.i(521632),nR=e.i(500841),nM=e.i(271743),nA=e.i(216425);let nO=y.memo(e=>{let{payload:t,onRemove:a,onChange:r,readonly:s,editable:l=!0}=e,n=(0,nM.default)(),{t:o}=(0,O.useTranslation)(),i=n===nM.MediaType.mobile,{formatIndexingTechniqueAndMethod:d}=(0,nA.useKnowledge)(),[c,u]=(0,y.useState)(!1),[p,{setTrue:m,setFalse:h}]=(0,an.useBoolean)(!1),g=(0,y.useCallback)(e=>{r(e),h()},[h,r]),f=(0,y.useCallback)(e=>{e.stopPropagation(),a()},[a]),b=t.icon_info||{icon:"📙",icon_type:"emoji",icon_background:"#FFF4ED",icon_url:""};return(0,x.jsxs)("div",{className:`group/dataset-item flex h-10 cursor-pointer items-center justify-between rounded-lg
      border-[0.5px] border-components-panel-border-subtle px-2
      ${c?"border-state-destructive-border bg-state-destructive-hover":"bg-components-panel-on-panel-item-bg hover:bg-components-panel-on-panel-item-bg-hover"}`,children:[(0,x.jsxs)("div",{className:"flex w-0 grow items-center space-x-1.5",children:[(0,x.jsx)(a3.default,{size:"tiny",iconType:b.icon_type,icon:b.icon,background:"image"===b.icon_type?void 0:b.icon_background,imageUrl:"image"===b.icon_type?b.icon_url:void 0}),(0,x.jsx)("div",{className:"system-sm-medium w-0 grow truncate text-text-secondary",children:t.name})]}),!s&&(0,x.jsxs)("div",{className:"ml-2 hidden shrink-0 items-center  space-x-1 group-hover/dataset-item:flex",children:[l&&(0,x.jsx)(rk.default,{onClick:e=>{e.stopPropagation(),m()},children:(0,x.jsx)(M.RiEditLine,{className:"h-4 w-4 shrink-0 text-text-tertiary"})}),(0,x.jsx)(rk.default,{onClick:f,state:c?rk.ActionButtonState.Destructive:rk.ActionButtonState.Default,onMouseEnter:()=>u(!0),onMouseLeave:()=>u(!1),children:(0,x.jsx)(M.RiDeleteBinLine,{className:`h-4 w-4 shrink-0 ${c?"text-text-destructive":"text-text-tertiary"}`})})]}),t.is_multimodal&&(0,x.jsx)("div",{className:"mr-1 shrink-0 group-hover/dataset-item:hidden",children:(0,x.jsx)(nR.default,{feature:t0.ModelFeatureEnum.vision})}),!!t.indexing_technique&&(0,x.jsx)(r6.default,{className:"shrink-0 group-hover/dataset-item:hidden",text:d(t.indexing_technique,t.retrieval_model_dict?.search_method)}),"external"===t.provider&&(0,x.jsx)(r6.default,{className:"shrink-0 group-hover/dataset-item:hidden",text:o("externalTag",{ns:"dataset"})}),p&&(0,x.jsx)(nI.default,{isOpen:p,onClose:h,footer:null,mask:i,panelClassName:"mt-16 mx-2 sm:mr-2 mb-3 !p-0 !max-w-[640px] rounded-xl",children:(0,x.jsx)(nV.default,{currentDataset:t,onCancel:h,onSave:g})})]})}),nP=y.memo(e=>{let{list:t,onChange:a,readonly:r}=e,{t:s}=(0,O.useTranslation)(),l=(0,nS.useSelector)(e=>e.userProfile),n=(0,y.useCallback)(e=>()=>{a((0,f.produce)(t,t=>{t.splice(e,1)}))},[t,a]),o=(0,y.useCallback)(e=>r=>{a((0,f.produce)(t,t=>{t[e]=r}))},[t,a]),i=(0,y.useMemo)(()=>t.map(e=>{let t={createdBy:e.created_by,partialMemberList:e.partial_member_list||[],permission:e.permission};return{...e,editable:(0,nE.hasEditPermissionForDataset)(l?.id||"",t)}}),[t,l?.id]);return(0,x.jsx)("div",{className:"space-y-1",children:i.length?i.map((e,t)=>(0,x.jsx)(nO,{payload:e,onRemove:n(t),onChange:o(t),readonly:r,editable:e.editable},t)):(0,x.jsx)("div",{className:"cursor-default select-none rounded-lg bg-background-section p-3 text-center text-xs text-text-tertiary",children:s("datasetConfig.knowledgeTip",{ns:"appDebug"})})})});var nL=e.i(428594),nF=e.i(621708);let nB=y.memo(e=>{let{payload:t,onRetrievalModeChange:a,onMultipleRetrievalConfigChange:r,singleRetrievalModelConfig:s,onSingleRetrievalModelChange:l,onSingleRetrievalModelParamsChange:n,readonly:o,rerankModalOpen:i,onRerankModelOpenChange:d,selectedDatasets:c}=e,{t:u}=(0,O.useTranslation)(),{retrieval_mode:p,multiple_retrieval_config:m}=t,h=(0,y.useCallback)(e=>{d(e)},[d]),g=(0,y.useMemo)(()=>{let{reranking_model:e,top_k:t,score_threshold:a,reranking_mode:r,weights:s,reranking_enable:l}=m||{};return{retrieval_model:p,reranking_model:e?.provider&&e?.model?{reranking_provider_name:e?.provider,reranking_model_name:e?.model}:{reranking_provider_name:"",reranking_model_name:""},top_k:t||k.DATASET_DEFAULT.top_k,score_threshold_enabled:null!=a,score_threshold:a,datasets:{datasets:[]},reranking_mode:r,weights:s,reranking_enable:l}},[p,m]),f=(0,y.useCallback)((e,t)=>{t?a(e.retrieval_model):r({top_k:e.top_k,score_threshold:e.score_threshold_enabled?e.score_threshold??k.DATASET_DEFAULT.score_threshold:null,reranking_model:p===eg.RETRIEVE_TYPE.oneWay?void 0:e.reranking_model?.reranking_provider_name?{provider:e.reranking_model?.reranking_provider_name,model:e.reranking_model?.reranking_model_name}:void 0,reranking_mode:e.reranking_mode,weights:e.weights,reranking_enable:e.reranking_enable})},[r,p,a]);return(0,x.jsxs)(ez.PortalToFollowElem,{open:i,onOpenChange:h,placement:"bottom-end",offset:{crossAxis:-2},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>{o||h(!i)},children:(0,x.jsxs)(es.default,{variant:"ghost",size:"small",disabled:o,className:(0,T.cn)(i&&"bg-components-button-ghost-bg-hover"),children:[(0,x.jsx)(M.RiEqualizer2Line,{className:"mr-1 h-3.5 w-3.5"}),u("retrievalSettings",{ns:"dataset"})]})}),(0,x.jsx)(ez.PortalToFollowElemContent,{style:{zIndex:1001},children:(0,x.jsx)("div",{className:"w-[404px] rounded-2xl border border-components-panel-border bg-components-panel-bg  px-4 pb-4 pt-3  shadow-xl",children:(0,x.jsx)(nF.default,{datasetConfigs:g,onChange:f,selectedDatasets:c,isInWorkflow:!0,singleRetrievalModelConfig:s,onSingleRetrievalModelChange:l,onSingleRetrievalModelParamsChange:n})})})]})});var nD=e.i(211857),n$=e.i(684194),nz=e.i(88961);let nH="nodes.knowledgeRetrieval",nW=(0,y.memo)(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,handleQueryVarChange:n,handleQueryAttachmentChange:o,filterStringVar:i,filterFileVar:d,handleModelChanged:c,handleCompletionParamsChange:u,handleRetrievalModeChange:p,handleMultipleRetrievalConfigChange:m,selectedDatasets:h,selectedDatasetsLoaded:b,handleOnDatasetsChange:v,rerankModelOpen:w,setRerankModelOpen:j,handleAddCondition:N,handleMetadataFilterModeChange:C,handleRemoveCondition:_,handleToggleConditionLogicalOperator:T,handleUpdateCondition:S,handleMetadataModelChange:E,handleMetadataCompletionParamsChange:V,availableStringVars:I,availableStringNodesWithParent:R,availableNumberVars:M,availableNumberNodesWithParent:A,showImageQueryVarSelector:P}=((e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),r=(0,Z.useIsChatMode)(),{getBeforeNodesInSameBranch:s}=(0,Z.useWorkflow)(),l=s(e).find(e=>e.data.type===eb.BlockEnum.Start),n=l?.id,{inputs:o,setInputs:i}=(0,tZ.default)(e,t),d=(0,ae.useDatasetsDetailStore)(e=>e.updateDatasetsDetail),c=(0,y.useRef)(o),u=(0,y.useCallback)(e=>{let t=(0,f.produce)(e,t=>{e.retrieval_mode===eg.RETRIEVE_TYPE.multiWay?delete t.single_retrieval_config:delete t.multiple_retrieval_config});i(t),c.current=t},[i]),p=(0,y.useCallback)(e=>{u((0,f.produce)(o,t=>{t.query_variable_selector=e}))},[o,u]),m=(0,y.useCallback)(e=>{u((0,f.produce)(o,t=>{t.query_attachment_selector=e}))},[o,u]),{currentProvider:x,currentModel:h}=(0,$.useModelListAndDefaultModelAndCurrentProviderAndModel)(t0.ModelTypeEnum.textGeneration),{modelList:b,defaultModel:v}=(0,$.useModelListAndDefaultModelAndCurrentProviderAndModel)(t0.ModelTypeEnum.rerank),{currentModel:w,currentProvider:j}=(0,$.useCurrentProviderAndModel)(b,v?{...v,provider:v.provider.provider}:void 0),N=(0,y.useCallback)(e=>{u((0,f.produce)(c.current,t=>{t.single_retrieval_config||(t.single_retrieval_config={model:{provider:"",name:"",mode:"",completion_params:{}}});let a=t.single_retrieval_config?.model;a.provider=e.provider,a.name=e.modelId,a.mode=e.mode}))},[u]),C=(0,y.useCallback)(e=>{(0,g.isEqual)(e,c.current.single_retrieval_config?.model.completion_params)||u((0,f.produce)(c.current,t=>{t.single_retrieval_config||(t.single_retrieval_config={model:{provider:"",name:"",mode:"",completion_params:{}}}),t.single_retrieval_config.model.completion_params=e}))},[u]);(0,y.useEffect)(()=>{let e=c.current;e.retrieval_mode===eg.RETRIEVE_TYPE.multiWay&&e.multiple_retrieval_config?.reranking_model?.provider&&w&&v||e.retrieval_mode===eg.RETRIEVE_TYPE.oneWay&&e.single_retrieval_config?.model?.provider||u((0,f.produce)(e,e=>{x?.provider&&h?.model&&(e.single_retrieval_config?.model?.provider||(e.single_retrieval_config={model:{provider:x?.provider,name:h?.model,mode:h?.model_properties?.mode,completion_params:{}}}));let t=e.multiple_retrieval_config;e.multiple_retrieval_config={top_k:t?.top_k||k.DATASET_DEFAULT.top_k,score_threshold:t?.score_threshold,reranking_model:t?.reranking_model,reranking_mode:t?.reranking_mode,weights:t?.weights,reranking_enable:t?.reranking_enable!==void 0?t.reranking_enable:!!(w&&v)}}))},[x?.provider,h,w,v]);let[_,T]=(0,y.useState)([]),[S,E]=(0,y.useState)(!1),V=(0,y.useCallback)(e=>{u((0,f.produce)(o,t=>{if(t.retrieval_mode=e,e===eg.RETRIEVE_TYPE.multiWay){let e=t.multiple_retrieval_config;t.multiple_retrieval_config=(0,nz.getMultipleRetrievalConfig)(e,_,_,{provider:j?.provider,model:w?.model})}else t.single_retrieval_config?.model?.provider||(t.single_retrieval_config={model:{provider:x?.provider||"",name:h?.model||"",mode:h?.model_properties?.mode,completion_params:{}}})}))},[h?.model,h?.model_properties?.mode,x?.provider,o,u,_,w,j]),I=(0,y.useCallback)(e=>{u((0,f.produce)(o,t=>{t.multiple_retrieval_config=(0,nz.getMultipleRetrievalConfig)(e,_,_,{provider:j?.provider,model:w?.model})}))},[o,u,_,w,j]),[R,M]=(0,y.useState)(!1);(0,y.useEffect)(()=>{(async()=>{let e=c.current,t=e.dataset_ids;if(t?.length>0){let{data:e}=await (0,nD.fetchDatasets)({url:"/datasets",params:{page:1,ids:t}});T(e)}u((0,f.produce)(e,e=>{e.dataset_ids=t})),M(!0)})()},[]),(0,y.useEffect)(()=>{let e=c.current,t=e.query_variable_selector;r&&0===e.query_variable_selector.length&&n&&(t=[n,"sys.query"]),u((0,f.produce)(e,e=>{e.query_variable_selector=t}))},[]);let A=(0,y.useCallback)(e=>{let{mixtureHighQualityAndEconomic:a,mixtureInternalAndExternal:r,inconsistentEmbeddingModel:s,allInternal:l,allExternal:n}=(0,nz.getSelectedDatasetsMode)(e),i=e.every(e=>!e.is_multimodal),c=(0,f.produce)(o,a=>{if(a.dataset_ids=e.map(e=>e.id),t.retrieval_mode===eg.RETRIEVE_TYPE.multiWay&&e.length>0){let t=a.multiple_retrieval_config;a.multiple_retrieval_config=(0,nz.getMultipleRetrievalConfig)(t,e,_,{provider:j?.provider,model:w?.model})}i&&(a.query_attachment_selector=[])});d(e),u(c),T(e),(l&&(a||s)||r||n)&&E(!0)},[o,u,t.retrieval_mode,_,w,j,d]),O=(0,y.useCallback)(e=>e.type===eb.VarType.string,[]),P=(0,y.useCallback)(e=>e.type===eb.VarType.number,[]),L=(0,y.useCallback)(e=>e.type===eb.VarType.file||e.type===eb.VarType.arrayFile,[]),F=(0,y.useCallback)(e=>{u((0,f.produce)(c.current,t=>{t.metadata_filtering_mode=e}))},[u]),B=(0,y.useCallback)(e=>{let{id:t,name:a,type:r}=e,s=n$.ComparisonOperator.is;r===n$.MetadataFilteringVariableType.number&&(s=n$.ComparisonOperator.equal);let l={id:(0,sv.v4)(),metadata_id:t,name:a,comparison_operator:s};u((0,f.produce)(c.current,e=>{e.metadata_filtering_conditions?e.metadata_filtering_conditions.conditions.push(l):e.metadata_filtering_conditions={logical_operator:n$.LogicalOperator.and,conditions:[l]}}))},[u]),D=(0,y.useCallback)(e=>{let t=(c.current.metadata_filtering_conditions?.conditions||[]).findIndex(t=>t.id===e);u((0,f.produce)(c.current,e=>{t>-1&&e.metadata_filtering_conditions?.conditions.splice(t,1)}))},[u]),z=(0,y.useCallback)((e,t)=>{let a=(c.current.metadata_filtering_conditions?.conditions||[]).findIndex(t=>t.id===e);u((0,f.produce)(c.current,e=>{a>-1&&(e.metadata_filtering_conditions.conditions[a]=t)}))},[u]),H=(0,y.useCallback)(()=>{let e=c.current.metadata_filtering_conditions?.logical_operator===n$.LogicalOperator.and?n$.LogicalOperator.or:n$.LogicalOperator.and;u((0,f.produce)(c.current,t=>{t.metadata_filtering_conditions.logical_operator=e}))},[u]),W=(0,y.useCallback)(e=>{u((0,f.produce)(c.current,t=>{t.metadata_model_config={provider:e.provider,name:e.modelId,mode:e.mode||eg.AppModeEnum.CHAT,completion_params:t.metadata_model_config?.completion_params||{temperature:.7}}}))},[u]),q=(0,y.useCallback)(e=>{u((0,f.produce)(c.current,t=>{t.metadata_model_config={...t.metadata_model_config,completion_params:e}}))},[u]),{availableVars:U,availableNodesWithParent:K}=(0,t3.default)(e,{onlyLeafNodeVar:!1,filterVar:O}),{availableVars:G,availableNodesWithParent:J}=(0,t3.default)(e,{onlyLeafNodeVar:!1,filterVar:P}),X=(0,y.useMemo)(()=>_.some(e=>e.is_multimodal),[_]);return{readOnly:a,inputs:o,handleQueryVarChange:p,handleQueryAttachmentChange:m,filterStringVar:O,filterFileVar:L,handleRetrievalModeChange:V,handleMultipleRetrievalConfigChange:I,handleModelChanged:N,handleCompletionParamsChange:C,selectedDatasets:_.filter(e=>e.name),selectedDatasetsLoaded:R,handleOnDatasetsChange:A,rerankModelOpen:S,setRerankModelOpen:E,handleMetadataFilterModeChange:F,handleUpdateCondition:z,handleAddCondition:B,handleRemoveCondition:D,handleToggleConditionLogicalOperator:H,handleMetadataModelChange:W,handleMetadataCompletionParamsChange:q,availableStringVars:U,availableStringNodesWithParent:K,availableNumberVars:G,availableNumberNodesWithParent:J,showImageQueryVarSelector:X}})(t,a),L=(0,y.useMemo)(()=>(0,nC.intersectionBy)(...h.filter(e=>!!e.doc_metadata).map(e=>e.doc_metadata),"name"),[h]);return(0,x.jsxs)("div",{className:"pt-2",children:[(0,x.jsxs)("div",{className:"space-y-4 px-4 pb-2",children:[(0,x.jsx)(rj,{title:r(`${nH}.queryText`,{ns:"workflow"}),children:(0,x.jsx)(sa.default,{nodeId:t,readonly:s,isShowNodeName:!0,value:l.query_variable_selector,onChange:n,filterVar:i})}),P&&(0,x.jsx)(rj,{title:r(`${nH}.queryAttachment`,{ns:"workflow"}),children:(0,x.jsx)(sa.default,{nodeId:t,readonly:s,isShowNodeName:!0,value:l.query_attachment_selector,onChange:o,filterVar:d})}),(0,x.jsx)(rj,{title:r(`${nH}.knowledge`,{ns:"workflow"}),required:!0,operations:(0,x.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,x.jsx)(nB,{payload:{retrieval_mode:l.retrieval_mode,multiple_retrieval_config:l.multiple_retrieval_config,single_retrieval_config:l.single_retrieval_config},onRetrievalModeChange:p,onMultipleRetrievalConfigChange:m,singleRetrievalModelConfig:l.single_retrieval_config?.model,onSingleRetrievalModelChange:c,onSingleRetrievalModelParamsChange:u,readonly:s||!h.length,rerankModalOpen:w,onRerankModelOpenChange:j,selectedDatasets:h}),!s&&(0,x.jsx)("div",{className:"h-3 w-px bg-divider-regular"}),!s&&(0,x.jsx)(nT,{selectedIds:l.dataset_ids,onChange:v})]}),children:(0,x.jsx)(nP,{list:h,onChange:v,readonly:s})})]}),(0,x.jsx)("div",{className:"mb-2 py-2",children:(0,x.jsx)(nL.default,{metadataList:L,selectedDatasetsLoaded:b,metadataFilterMode:l.metadata_filtering_mode,metadataFilteringConditions:l.metadata_filtering_conditions,handleAddCondition:N,handleMetadataFilterModeChange:C,handleRemoveCondition:_,handleToggleConditionLogicalOperator:T,handleUpdateCondition:S,metadataModelConfig:l.metadata_model_config,handleMetadataModelChange:E,handleMetadataCompletionParamsChange:V,availableStringVars:I,availableStringNodesWithParent:R,availableNumberVars:M,availableNumberNodesWithParent:A})}),(0,x.jsx)(er,{}),(0,x.jsx)("div",{children:(0,x.jsx)(rG,{children:(0,x.jsx)(x.Fragment,{children:(0,x.jsx)(rK,{name:"result",type:"Array[Object]",description:r(`${nH}.outputVars.output`,{ns:"workflow"}),subItems:[{name:"content",type:"string",description:r(`${nH}.outputVars.content`,{ns:"workflow"})},{name:"title",type:"string",description:r(`${nH}.outputVars.title`,{ns:"workflow"})},{name:"url",type:"string",description:r(`${nH}.outputVars.url`,{ns:"workflow"})},{name:"icon",type:"string",description:r(`${nH}.outputVars.icon`,{ns:"workflow"})},{name:"metadata",type:"object",description:r(`${nH}.outputVars.metadata`,{ns:"workflow"})},{name:"files",type:"Array[File]",description:r(`${nH}.outputVars.files`,{ns:"workflow"})}]})})})})]})}),nq=y.memo(e=>{let{data:t}=e,{t:a}=(0,O.useTranslation)(),r=(0,j.useNodes)(),{variable:s}=t;if(!s||0===s.length)return null;let l=(0,ty.isSystemVar)(s)?r.find(e=>e.data.type===eb.BlockEnum.Start):r.find(e=>e.id===s[0]);return(0,x.jsxs)("div",{className:"relative px-3",children:[(0,x.jsx)("div",{className:"system-2xs-medium-uppercase mb-1 text-text-tertiary",children:a("nodes.listFilter.inputVar",{ns:"workflow"})}),(0,x.jsx)(r8.VariableLabelInNode,{variables:s,nodeType:l?.data.type,nodeTitle:l?.data.title})]})}),nU=y.memo(e=>{let{nodeId:t,readOnly:a,value:r,onChange:s}=e,{t:l}=(0,O.useTranslation)(),[n,o]=(0,y.useState)(!1),{availableVars:i,availableNodesWithParent:d}=(0,t3.default)(t,{onlyLeafNodeVar:!1,filterVar:e=>[eb.VarType.number].includes(e.type)});return(0,x.jsx)("div",{className:"flex items-start  space-x-1",children:(0,x.jsx)(sZ,{instanceId:"http-extract-number",className:(0,T.cn)(n?"border-components-input-border-active bg-components-input-bg-active shadow-xs":"border-components-input-border-hover bg-components-input-bg-normal","w-0 grow rounded-lg border px-3 py-[6px]"),value:r,onChange:s,readOnly:a,nodesOutputVars:i,availableNodes:d,onFocusChange:o,placeholder:a?"":l("nodes.http.extractListPlaceholder",{ns:"workflow"}),placeholderClassName:"!leading-[21px]"})})});var nK=e.i(597280);let nG=y.memo(e=>{let{value:t,onChange:a,className:r}=e,{t:s}=(0,O.useTranslation)(),l=lN.SUB_VARIABLES.map(e=>({value:e,name:e})),n=(0,y.useCallback)(e=>{let{value:t}=e;a(t)},[a]);return(0,x.jsx)("div",{className:(0,T.cn)(r),children:(0,x.jsx)(la.SimpleSelect,{items:l,defaultValue:t,onSelect:n,className:"!text-[13px]",placeholder:s("nodes.listFilter.selectVariableKeyPlaceholder",{ns:"workflow"}),optionClassName:"pl-1 pr-5 py-0",renderOption:e=>{let{item:t}=e;return(0,x.jsxs)("div",{className:"flex h-6 items-center justify-between",children:[(0,x.jsxs)("div",{className:"flex h-full items-center",children:[(0,x.jsx)(r_.Variable02,{className:"mr-[5px] h-3.5 w-3.5 text-text-accent"}),(0,x.jsx)("span",{className:"system-sm-medium text-text-secondary",children:t.name})]}),(0,x.jsx)("span",{className:"system-xs-regular text-text-tertiary",children:t.type})]})},renderTrigger:e=>(0,x.jsx)("div",{className:"group/sub-variable-picker flex h-8 items-center rounded-lg bg-components-input-bg-normal pl-1 hover:bg-state-base-hover-alt",children:e?(0,x.jsx)("div",{className:"flex cursor-pointer justify-start",children:(0,x.jsxs)("div",{className:"inline-flex h-6 max-w-full items-center rounded-md border-[0.5px] border-components-panel-border-subtle bg-components-badge-white-to-dark px-1.5 text-text-accent shadow-xs",children:[(0,x.jsx)(r_.Variable02,{className:"h-3.5 w-3.5 shrink-0 text-text-accent"}),(0,x.jsx)("div",{className:"system-xs-medium ml-0.5 truncate",children:e?.name})]})}):(0,x.jsxs)("div",{className:"system-sm-regular flex pl-1 text-components-input-text-placeholder  group-hover/sub-variable-picker:text-text-tertiary",children:[(0,x.jsx)(r_.Variable02,{className:"mr-1 h-4 w-4 shrink-0"}),(0,x.jsx)("span",{children:s("placeholder.select",{ns:"common"})})]})})})})}),nJ="nodes.ifElse.optionName",nX={name:eb.VarType.string,url:eb.VarType.string,extension:eb.VarType.string,mime_type:eb.VarType.string,related_id:eb.VarType.string,size:eb.VarType.number},nQ=y.memo(e=>{let{condition:t={key:"",comparison_operator:l_.ComparisonOperator.equal,value:""},varType:a,onChange:r,hasSubVariable:s,readOnly:l,nodeId:n}=e,{t:o}=(0,O.useTranslation)(),[i,d]=(0,y.useState)(!1),c=t.key?nX[t.key]:a,u=!!c,{availableVars:p,availableNodesWithParent:m}=(0,t3.default)(n,{onlyLeafNodeVar:!1,filterVar:e=>!c||e.type===c}),h=[l_.ComparisonOperator.in,l_.ComparisonOperator.notIn,l_.ComparisonOperator.allOf].includes(t.comparison_operator),g="transfer_method"===t.key||"type"===t.key,f=a===eb.VarType.boolean,b=(0,y.useMemo)(()=>{if(h){if("type"===t.key||t.comparison_operator===l_.ComparisonOperator.allOf)return lN.FILE_TYPE_OPTIONS.map(e=>({name:o(`${nJ}.${e.i18nKey}`,{ns:"workflow"}),value:e.value}));if("transfer_method"===t.key)return lN.TRANSFER_METHOD.map(e=>({name:o(`${nJ}.${e.i18nKey}`,{ns:"workflow"}),value:e.value}))}return[]},[t.comparison_operator,t.key,h,o]),v=(0,y.useCallback)(e=>a=>{r({...t,[e]:g&&"value"===e?[a]:a})},[t,r,g]),w=(0,y.useCallback)(e=>{let t=(0,lw.getOperators)(c??eb.VarType.string,{key:e});r({key:e,comparison_operator:t.length>0?t[0]:l_.ComparisonOperator.equal,value:""})},[r,c]),j=null;return(0,lw.comparisonOperatorNotRequireValue)(t.comparison_operator)||(j=h?(0,x.jsx)(la.SimpleSelect,{items:b,defaultValue:g?t.value[0]:t.value,onSelect:e=>v("value")(e.value),className:"!text-[13px]",wrapperClassName:"grow h-8",placeholder:"Select value"}):f?(0,x.jsx)(sr.default,{value:t.value,onChange:v("value")}):u?(0,x.jsx)(sZ,{instanceId:"filter-condition-input",className:(0,T.cn)(i?"border-components-input-border-active bg-components-input-bg-active shadow-xs":"border-components-input-border-hover bg-components-input-bg-normal","w-0 grow rounded-lg border px-3 py-[6px]"),value:aa(t),onChange:v("value"),readOnly:l,nodesOutputVars:p,availableNodes:m,onFocusChange:d,placeholder:l?"":o("nodes.http.insertVarPlaceholder",{ns:"workflow"}),placeholderClassName:"!leading-[21px]"}):(0,x.jsx)("input",{type:s&&"size"===t.key||!s&&a===eb.VarType.number?"number":"text",className:"grow rounded-lg border border-components-input-border-hover bg-components-input-bg-normal px-3 py-[6px]",value:aa(t),onChange:e=>v("value")(e.target.value),readOnly:l})),(0,x.jsxs)("div",{children:[s&&(0,x.jsx)(nG,{className:"mb-2",value:t.key,onChange:w}),(0,x.jsxs)("div",{className:"flex space-x-1",children:[(0,x.jsx)(lA,{className:"h-8 bg-components-input-bg-normal",varType:c??a??eb.VarType.string,value:t.comparison_operator,onSelect:v("comparison_operator"),file:s?{key:t.key}:void 0,disabled:l}),j]})]})});var nY=e.i(441246);let nZ={enabled:!1,size:10},n0=y.memo(e=>{let{className:t,readonly:a,config:r=nZ,onChange:s}=e,{t:l}=(0,O.useTranslation)(),n=(0,y.useCallback)(e=>{s({...r,enabled:e})},[r,s]),o=(0,y.useCallback)(e=>{s({...r,size:Number.parseInt(e)})},[s,r]);return(0,x.jsx)("div",{className:(0,T.cn)(t),children:(0,x.jsx)(rj,{title:l("nodes.listFilter.limit",{ns:"workflow"}),operations:(0,x.jsx)(ts.default,{defaultValue:r.enabled,onChange:n,size:"md",disabled:a}),children:r?.enabled?(0,x.jsx)(nY.default,{value:r?.size||10,min:1,max:20,onChange:o,readonly:a||!r?.enabled}):null})})});var n1=e.i(827377);let n2="nodes.listFilter",n5=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,itemVarType:n,itemVarTypeShowName:o,hasSubVariable:i,handleVarChanges:d,filterVar:c,handleFilterEnabledChange:u,handleFilterChange:p,handleExtractsEnabledChange:m,handleExtractsChange:h,handleLimitChange:g,handleOrderByEnabledChange:b,handleOrderByKeyChange:v,handleOrderByTypeChange:w}=((e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),r=(0,Z.useIsChatMode)(),s=(0,j.useStoreApi)(),{getBeforeNodesInSameBranch:l}=(0,Z.useWorkflow)(),{getNodes:n}=s.getState(),o=n().find(t=>t.id===e),i=t.isInIteration,d=i?n().find(e=>e.id===o.parentId):null,c=t.isInLoop?n().find(e=>e.id===o.parentId):null,u=(0,y.useMemo)(()=>l(e),[l,e]),{inputs:p,setInputs:m}=(0,tZ.default)(e,t),{getCurrentVariableType:x}=(0,aT.useWorkflowVariables)(),h=(0,y.useCallback)(e=>{let t,a=x({parentNode:i?d:c,valueSelector:e||p.variable||[],availableNodes:u,isChatMode:r,isConstant:!1});switch(a){case eb.VarType.arrayNumber:t=eb.VarType.number;break;case eb.VarType.arrayString:t=eb.VarType.string;break;case eb.VarType.arrayFile:t=eb.VarType.file;break;case eb.VarType.arrayObject:t=eb.VarType.object;break;case eb.VarType.arrayBoolean:t=eb.VarType.boolean;break;default:t=a}return{varType:a,itemVarType:t}},[u,x,p.variable,r,i,d,c]),{varType:g,itemVarType:b}=h(),v=(0,y.useMemo)(()=>p.variable?[(b||eb.VarType.string).substring(0,1).toUpperCase(),(b||eb.VarType.string).substring(1)].join(""):"?",[p.variable,b]),w=[eb.VarType.arrayFile].includes(g),k=(0,y.useCallback)(e=>{m((0,f.produce)(p,t=>{t.variable=e;let{varType:a,itemVarType:r}=h(t.variable),s=a===eb.VarType.arrayFile;t.var_type=a,t.item_var_type=r,t.filter_by.conditions=[{key:s&&!t.filter_by.conditions[0]?.key?"name":"",comparison_operator:(0,lw.getOperators)(r,s?{key:"name"}:void 0)[0],value:r!==eb.VarType.boolean&&""}],s&&t.order_by.enabled&&!t.order_by.key&&(t.order_by.key="name")}))},[h,p,m]),N=(0,y.useCallback)(e=>[eb.VarType.arrayNumber,eb.VarType.arrayString,eb.VarType.arrayBoolean,eb.VarType.arrayFile].includes(e.type),[]),C=(0,y.useCallback)(e=>{m((0,f.produce)(p,t=>{t.filter_by.enabled=e,e&&!t.filter_by.conditions&&(t.filter_by.conditions=[])}))},[w,p,m]),_=(0,y.useCallback)(e=>{m((0,f.produce)(p,t=>{t.filter_by.conditions[0]=e}))},[p,m]),T=(0,y.useCallback)(e=>{m((0,f.produce)(p,t=>{t.limit=e}))},[p,m]),S=(0,y.useCallback)(e=>{m((0,f.produce)(p,t=>{t.extract_by.enabled=e,e&&(t.extract_by.serial="1")}))},[p,m]),E=(0,y.useCallback)(e=>{m((0,f.produce)(p,t=>{t.extract_by.serial=e}))},[p,m]),V=(0,y.useCallback)(e=>{m((0,f.produce)(p,t=>{t.order_by.enabled=e,e&&(t.order_by.value=n1.OrderBy.ASC,w&&!t.order_by.key&&(t.order_by.key="name"))}))},[w,p,m]),I=(0,y.useCallback)(e=>{m((0,f.produce)(p,t=>{t.order_by.key=e}))},[p,m]),R=(0,y.useCallback)(e=>()=>{m((0,f.produce)(p,t=>{t.order_by.value=e}))},[p,m]);return{readOnly:a,inputs:p,filterVar:N,varType:g,itemVarType:b,itemVarTypeShowName:v,hasSubVariable:w,handleVarChanges:k,handleFilterEnabledChange:C,handleFilterChange:_,handleLimitChange:T,handleOrderByEnabledChange:V,handleOrderByKeyChange:I,handleOrderByTypeChange:R,handleExtractsEnabledChange:S,handleExtractsChange:E}})(t,a);return(0,x.jsxs)("div",{className:"pt-2",children:[(0,x.jsxs)("div",{className:"space-y-4 px-4",children:[(0,x.jsx)(rj,{title:r(`${n2}.inputVar`,{ns:"workflow"}),required:!0,children:(0,x.jsx)(sa.default,{readonly:s,nodeId:t,isShowNodeName:!0,value:l.variable||[],onChange:d,filterVar:c,isSupportFileVar:!1,typePlaceHolder:"Array"})}),(0,x.jsx)(rj,{title:r(`${n2}.filterCondition`,{ns:"workflow"}),operations:(0,x.jsx)(ts.default,{defaultValue:l.filter_by?.enabled,onChange:u,size:"md",disabled:s}),children:l.filter_by?.enabled?(0,x.jsx)(nQ,{condition:l.filter_by.conditions[0],onChange:p,varType:n,hasSubVariable:i,readOnly:s,nodeId:t}):null}),(0,x.jsx)(er,{}),(0,x.jsx)(rj,{title:r(`${n2}.extractsCondition`,{ns:"workflow"}),operations:(0,x.jsx)(ts.default,{defaultValue:l.extract_by?.enabled,onChange:m,size:"md",disabled:s}),children:l.extract_by?.enabled?(0,x.jsx)("div",{className:"flex items-center justify-between",children:(0,x.jsx)("div",{className:"mr-2 grow",children:(0,x.jsx)(nU,{value:l.extract_by.serial,onChange:h,readOnly:s,nodeId:t})})}):null}),(0,x.jsx)(er,{}),(0,x.jsx)(n0,{config:l.limit,onChange:g,readonly:s}),(0,x.jsx)(er,{}),(0,x.jsx)(rj,{title:r(`${n2}.orderBy`,{ns:"workflow"}),operations:(0,x.jsx)(ts.default,{defaultValue:l.order_by?.enabled,onChange:b,size:"md",disabled:s}),children:l.order_by?.enabled?(0,x.jsxs)("div",{className:"flex items-center justify-between",children:[i&&(0,x.jsx)("div",{className:"mr-2 grow",children:(0,x.jsx)(nG,{value:l.order_by.key,onChange:v})}),(0,x.jsxs)("div",{className:i?"flex shrink-0 space-x-1":"grid w-full grid-cols-2 gap-1",children:[(0,x.jsx)(nK.default,{title:r(`${n2}.asc`,{ns:"workflow"}),onSelect:w(n1.OrderBy.ASC),selected:l.order_by.value===n1.OrderBy.ASC}),(0,x.jsx)(nK.default,{title:r(`${n2}.desc`,{ns:"workflow"}),onSelect:w(n1.OrderBy.DESC),selected:l.order_by.value===n1.OrderBy.DESC})]})]}):null}),(0,x.jsx)(er,{})]}),(0,x.jsx)("div",{children:(0,x.jsx)(rG,{children:(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(rK,{name:"result",type:`Array[${o}]`,description:r(`${n2}.outputVars.result`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"first_record",type:o,description:r(`${n2}.outputVars.first_record`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"last_record",type:o,description:r(`${n2}.outputVars.last_record`,{ns:"workflow"})})]})})})]})}),n3=y.memo(e=>{let{data:t}=e,{provider:a,name:r}=t.model||{},{textGenerationModelList:s}=(0,$.useTextGenerationCurrentProviderAndModelAndModelList)(),l=a&&r;return l?(0,x.jsx)("div",{className:"mb-1 px-3 py-1",children:l&&(0,x.jsx)(a2.default,{defaultModel:{provider:a,model:r},modelList:s,triggerClassName:"!h-6 !rounded-md",readonly:!0})}):null});var n4=e.i(337464),n6=e.i(495620);let n8="nodes.llm",n9=y.memo(e=>{let{value:t,onChange:a}=e,{t:r}=(0,O.useTranslation)(),s=(0,y.useCallback)(e=>()=>{a(e)},[a]);return(0,x.jsxs)("div",{className:"flex items-center justify-between",children:[(0,x.jsx)("div",{className:"mr-2 text-xs font-medium uppercase text-text-secondary",children:r(`${n8}.resolution.name`,{ns:"workflow"})}),(0,x.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,x.jsx)(nK.default,{title:r(`${n8}.resolution.high`,{ns:"workflow"}),onSelect:s(eg.Resolution.high),selected:t===eg.Resolution.high}),(0,x.jsx)(nK.default,{title:r(`${n8}.resolution.low`,{ns:"workflow"}),onSelect:s(eg.Resolution.low),selected:t===eg.Resolution.low})]})]})}),n7=y.memo(e=>{let{isVisionModel:t,readOnly:a,enabled:r,onEnabledChange:s,nodeId:l,config:n={detail:eg.Resolution.high,variable_selector:[]},onConfigChange:o}=e,{t:i}=(0,O.useTranslation)(),d=(0,y.useCallback)(e=>[eb.VarType.file,eb.VarType.arrayFile].includes(e.type),[]),c=(0,y.useCallback)(e=>{o((0,f.produce)(n,t=>{t.detail=e}))},[n,o]),u=(0,y.useCallback)(e=>{o((0,f.produce)(n,t=>{t.variable_selector=e}))},[n,o]);return(0,x.jsx)(rj,{title:i("nodes.llm.vision",{ns:"workflow"}),tooltip:i("vision.description",{ns:"appDebug"}),operations:(0,x.jsx)(B.default,{popupContent:i("vision.onlySupportVisionModelTip",{ns:"appDebug"}),disabled:t,children:(0,x.jsx)(ts.default,{disabled:a||!t,size:"md",defaultValue:!!t&&r,onChange:s})}),children:r&&t?(0,x.jsxs)("div",{children:[(0,x.jsx)(sa.default,{className:"mb-4",filterVar:d,nodeId:l,value:n.variable_selector||[],onChange:u,readonly:a}),(0,x.jsx)(n9,{value:n.detail,onChange:c})]}):null})});e.i(42241);var oe=e.i(370546),oe=oe;let ot=y.memo(e=>{let{className:t,text:a,onClick:r}=e;return(0,x.jsxs)(es.default,{className:(0,T.cn)("w-full",t),variant:"tertiary",size:"medium",onClick:r,children:[(0,x.jsx)(M.RiAddLine,{className:"mr-1 h-3.5 w-3.5"}),(0,x.jsx)("div",{children:a})]})});var oa=e.i(923978);let or=[{label:"system",value:oa.PromptRole.system},{label:"user",value:oa.PromptRole.user},{label:"assistant",value:oa.PromptRole.assistant}],os=or.filter(e=>e.value!==oa.PromptRole.system),ol=y.memo(e=>{let{instanceId:t,className:a,headerClassName:r,canNotChooseSystemRole:s,readOnly:l,id:n,nodeId:o,canRemove:i,handleChatModeMessageRoleChange:d,isChatModel:c,isChatApp:u,payload:p,onPromptChange:m,onEditionTypeChange:h,onRemove:g,isShowContext:f,hasSetBlockStatus:b,availableVars:v,availableNodes:w,varList:j,handleAddVariable:k,modelConfig:N}=e,{t:C}=(0,O.useTranslation)(),{setControlPromptEditorRerenderKey:_}=(0,eN.useWorkflowStore)().getState(),T=(0,y.useCallback)(e=>{m(e),setTimeout(()=>_(Date.now()))},[m,_]);return(0,x.jsx)(rF,{className:a,headerClassName:r,instanceId:t,title:(0,x.jsxs)("div",{className:"relative left-1 flex items-center",children:[p.role===oa.PromptRole.system?(0,x.jsx)("div",{className:"relative left-[-4px] text-xs font-semibold uppercase text-text-secondary",children:"SYSTEM"}):(0,x.jsx)(su.default,{value:p.role,allOptions:or,options:s?os:or,onChange:d,triggerClassName:"text-xs font-semibold text-text-secondary uppercase",itemClassName:"text-[13px] font-medium text-text-secondary"}),(0,x.jsx)(B.default,{popupContent:(0,x.jsx)("div",{className:"max-w-[180px]",children:!!p.role&&C(`nodes.llm.roleDescription.${p.role}`,{ns:"workflow"})}),triggerClassName:"w-4 h-4"})]}),value:p.edition_type===eb.EditionType.jinja2?p.jinja2_text||"":p.text,onChange:m,readOnly:l,showRemove:i,onRemove:g,isChatModel:c,isChatApp:u,isShowContext:f,hasSetBlockStatus:b,nodesOutputVars:v,availableNodes:w,nodeId:o,editorId:n,isSupportPromptGenerator:!0,onGenerated:T,modelConfig:N,isSupportJinja:!0,editionType:p.edition_type,onEditionTypeChange:h,varList:j,handleAddVariable:k,isSupportFileVar:!0},t)}),on="nodes.llm",oo=y.memo(e=>{let{readOnly:t,nodeId:a,filterVar:r,isChatModel:s,isChatApp:l,payload:n,onChange:o,isShowContext:i,hasSetBlockStatus:d,varList:c=[],handleAddVariable:u,modelConfig:p}=e,{t:m}=(0,O.useTranslation)(),{setControlPromptEditorRerenderKey:h}=(0,eN.useWorkflowStore)().getState(),g=s&&Array.isArray(n)?n.map(e=>{let t=(0,sv.v4)();return{id:e.id||t,p:{...e,id:e.id||t}}}):[],{availableVars:b,availableNodesWithParent:v}=(0,t3.default)(a,{onlyLeafNodeVar:!1,filterVar:r}),w=(0,y.useCallback)(e=>t=>{o((0,f.produce)(n,a=>{a[e][a[e].edition_type===eb.EditionType.jinja2?"jinja2_text":"text"]=t}))},[o,n]),j=(0,y.useCallback)(e=>t=>{o((0,f.produce)(n,a=>{a[e].edition_type=t}))},[o,n]),k=(0,y.useCallback)(e=>t=>{o((0,f.produce)(n,a=>{a[e].role=t}))},[o,n]),N=(0,y.useCallback)(()=>{o((0,f.produce)(n,e=>{if(0===e.length)return void e.push({role:eb.PromptRole.system,text:"",id:(0,sv.v4)()});let t=e[e.length-1].role===eb.PromptRole.user;e.push({role:t?eb.PromptRole.assistant:eb.PromptRole.user,text:"",id:(0,sv.v4)()})}))},[o,n]),C=(0,y.useCallback)(e=>()=>{o((0,f.produce)(n,t=>{t.splice(e,1)}))},[o,n]),_=(0,y.useCallback)(e=>{o((0,f.produce)(n,t=>{t[t.edition_type===eb.EditionType.jinja2?"jinja2_text":"text"]=e}))},[o,n]),S=(0,y.useCallback)(e=>{_(e),setTimeout(()=>h(Date.now()))},[_,h]),E=(0,y.useCallback)(e=>{o((0,f.produce)(n,t=>{t.edition_type=e}))},[o,n]),V=!!(s&&Array.isArray(n))&&!n.find(e=>e.role===eb.PromptRole.system);return(0,x.jsx)("div",{children:s&&Array.isArray(n)?(0,x.jsxs)("div",{children:[(0,x.jsx)("div",{className:"space-y-2",children:(0,x.jsx)(sy.ReactSortable,{className:"space-y-1",list:g,setList:e=>{(n?.[0]?.role!==eb.PromptRole.system||e[0].p?.role===eb.PromptRole.system)&&o(e.map(e=>e.p))},handle:".handle",ghostClass:"opacity-50",animation:150,children:n.map((e,r)=>{let o=!t&&(0!==r||e.role!==eb.PromptRole.system);return(0,x.jsxs)("div",{className:"group relative",children:[o&&(0,x.jsx)(oe.default,{className:"absolute left-[-14px] top-2 hidden h-3.5 w-3.5 text-text-quaternary group-hover:block"}),(0,x.jsx)(ol,{instanceId:e.role===eb.PromptRole.system?`${a}-chat-workflow-llm-prompt-editor`:`${a}-chat-workflow-llm-prompt-editor-${r}`,className:(0,T.cn)(o&&"handle"),headerClassName:(0,T.cn)(o&&"cursor-grab"),canNotChooseSystemRole:!V,canRemove:n.length>1&&(0!==r||e.role!==eb.PromptRole.system),readOnly:t,id:e.id,nodeId:a,handleChatModeMessageRoleChange:k(r),isChatModel:s,isChatApp:l,payload:e,onPromptChange:w(r),onEditionTypeChange:j(r),onRemove:C(r),isShowContext:i,hasSetBlockStatus:d,availableVars:b,availableNodes:v,varList:c,handleAddVariable:u,modelConfig:p})]},e.id||r)})})}),(0,x.jsx)(ot,{className:"mt-2",text:m(`${on}.addMessage`,{ns:"workflow"}),onClick:N})]}):(0,x.jsx)("div",{children:(0,x.jsx)(rF,{instanceId:`${a}-chat-workflow-llm-prompt-editor`,title:(0,x.jsx)("span",{className:"capitalize",children:m(`${on}.prompt`,{ns:"workflow"})}),value:n.edition_type!==eb.EditionType.basic&&n.edition_type?n.jinja2_text||"":n.text,onChange:_,readOnly:t,isChatModel:s,isChatApp:l,isShowContext:i,hasSetBlockStatus:d,nodesOutputVars:b,availableNodes:v,isSupportPromptGenerator:!0,isSupportJinja:!0,editionType:n.edition_type,varList:c,onEditionTypeChange:E,handleAddVariable:u,onGenerated:S,modelConfig:p})})})}),oi=e=>{let{value:t="tagged",onChange:a,readonly:r=!1}=e,{t:s}=(0,O.useTranslation)();return(0,x.jsx)(rj,{title:s("nodes.llm.reasoningFormat.title",{ns:"workflow"}),tooltip:s("nodes.llm.reasoningFormat.tooltip",{ns:"workflow"}),operations:(0,x.jsx)(ts.default,{defaultValue:"separated"===t,onChange:e=>a(e?"separated":"tagged"),size:"md",disabled:r},t),children:(0,x.jsx)("div",{})})};var od=e.i(669744),oc=e.i(294237);let ou=(0,oc.cva)("segmented-control",{variants:{size:{regular:"segmented-control-regular",small:"segmented-control-small",large:"segmented-control-large"},padding:{none:"no-padding",with:"padding"}},defaultVariants:{size:"regular",padding:"with"}}),op=(0,oc.cva)("segmented-control-item disabled:segmented-control-item-disabled",{variants:{size:{regular:["segmented-control-item-regular","system-sm-medium"],small:["segmented-control-item-small","system-xs-medium"],large:["segmented-control-item-large","system-md-semibold"]},activeState:{default:"",accent:"accent",accentLight:"accent-light"}},defaultVariants:{size:"regular",activeState:"default"}}),om=(0,oc.cva)("item-text",{variants:{size:{regular:"item-text-regular",small:"item-text-small",large:"item-text-large"}},defaultVariants:{size:"regular"}}),ox=e=>{let{options:t,value:a,onChange:r,className:s,size:l,padding:n,activeState:o,activeClassName:i,btnClassName:d}=e,c=t.findIndex(e=>e.value===a);return(0,x.jsx)("div",{className:(0,T.cn)(ou({size:l,padding:n}),s),children:t.map((e,a)=>{let{Icon:s,text:n,count:u,disabled:p}=e,m=a===c,h=a===t.length-1;return(0,x.jsxs)("button",{type:"button",className:(0,T.cn)(m?"active":"default",op({size:l,activeState:m?o:"default"}),m&&i,p&&"disabled",d),onClick:()=>{m||r(e.value)},disabled:p,children:[s&&(0,x.jsx)(s,{className:"size-4 shrink-0"}),n&&(0,x.jsxs)("div",{className:(0,T.cn)("inline-flex items-center gap-x-1",om({size:l})),children:[(0,x.jsx)("span",{children:n}),!!(u&&"large"===l)&&(0,x.jsx)("div",{className:"system-2xs-medium-uppercase inline-flex h-[18px] min-w-[18px] items-center justify-center rounded-[5px] border border-divider-deep bg-components-badge-bg-dimm px-[5px] text-text-tertiary",children:u})]}),!h&&!m&&a!==c-1&&(0,x.jsx)("div",{"data-testid":`segmented-control-divider-${a}`,className:"absolute right-[-1px] top-0 flex h-full items-center",children:(0,x.jsx)(ss.default,{type:"vertical",className:"mx-0 h-3.5"})})]},String(e.value))})})};var oh=e.i(858314);let og=y.memo(e=>{let{message:t,className:a}=e;return(0,x.jsxs)("div",{className:(0,T.cn)("mt-1 flex gap-x-1 rounded-lg border-[0.5px] border-components-panel-border bg-toast-error-bg p-2",a),children:[(0,x.jsx)(M.RiErrorWarningFill,{className:"h-4 w-4 shrink-0 text-text-destructive"}),(0,x.jsx)("div",{className:"system-xs-medium max-h-12 grow overflow-y-auto whitespace-pre-line break-words text-text-primary",children:t})]})});var of=e.i(473617),ob=e.i(207826),oy=e.i(288716);let ov=e=>{let{onSubmit:t,updateBtnWidth:a}=e,{t:r}=(0,O.useTranslation)(),[s,l]=(0,y.useState)(!1),[n,o]=(0,y.useState)(""),[i,d]=(0,y.useState)(null),c=(0,y.useRef)(null),u=(0,oy.useVisualEditorStore)(e=>e.advancedEditing),p=(0,oy.useVisualEditorStore)(e=>e.isAddingNewField),{emit:m}=(0,ob.useMittContext)();(0,y.useEffect)(()=>{c.current&&a(c.current.getBoundingClientRect().width)},[]);let h=(0,y.useCallback)(e=>{e.stopPropagation(),(u||p)&&m("quitEditing",{}),l(!s)},[s,u,p,m]),g=(0,y.useCallback)(()=>{l(!1)},[]),f=(0,y.useCallback)(()=>{try{let e=JSON.parse(n);if("object"!=typeof e||Array.isArray(e))return void d(Error("Root must be an object, not an array or primitive value."));if((0,oh.checkJsonDepth)(e)>k.JSON_SCHEMA_MAX_DEPTH)return void d({type:"error",message:`Schema exceeds maximum depth of ${k.JSON_SCHEMA_MAX_DEPTH}.`});t(e),d(null),l(!1)}catch(e){e instanceof Error?d(e):d(Error("Invalid JSON"))}},[t,n]);return(0,x.jsxs)(ez.PortalToFollowElem,{open:s,onOpenChange:l,placement:"bottom-end",offset:{mainAxis:4,crossAxis:16},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{ref:c,onClick:h,children:(0,x.jsx)("button",{type:"button",className:(0,T.cn)("system-xs-medium flex shrink-0 rounded-md px-1.5 py-1 text-text-tertiary hover:bg-components-button-ghost-bg-hover",s&&"bg-components-button-ghost-bg-hover"),children:(0,x.jsx)("span",{className:"px-0.5",children:r("nodes.llm.jsonSchema.import",{ns:"workflow"})})})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[100]",children:(0,x.jsxs)("div",{className:"flex w-[400px] flex-col rounded-2xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-2xl shadow-shadow-shadow-9",children:[(0,x.jsxs)("div",{className:"relative px-3 pb-1 pt-3.5",children:[(0,x.jsx)("div",{className:"absolute bottom-0 right-2.5 flex h-8 w-8 items-center justify-center",onClick:g,children:(0,x.jsx)(M.RiCloseLine,{className:"h-4 w-4 text-text-tertiary"})}),(0,x.jsx)("div",{className:"system-xl-semibold flex pl-1 pr-8 text-text-primary",children:r("nodes.llm.jsonSchema.import",{ns:"workflow"})})]}),(0,x.jsxs)("div",{className:"px-4 py-2",children:[(0,x.jsx)(of.default,{className:"rounded-lg",editorWrapperClassName:"h-[340px]",value:n,onUpdate:o,showFormatButton:!1}),i&&(0,x.jsx)(og,{message:i.message})]}),(0,x.jsxs)("div",{className:"flex items-center justify-end gap-x-2 p-4 pt-2",children:[(0,x.jsx)(es.default,{variant:"secondary",onClick:g,children:r("operation.cancel",{ns:"common"})}),(0,x.jsx)(es.default,{variant:"primary",onClick:f,children:r("operation.submit",{ns:"common"})})]})]})})]})};var ow=e.i(922521);let oj=()=>(0,x.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",children:[(0,x.jsx)("path",{d:"M9.33329 2.95825C10.2308 2.95825 10.9583 2.23071 10.9583 1.33325H11.7083C11.7083 2.23071 12.4358 2.95825 13.3333 2.95825V3.70825C12.4358 3.70825 11.7083 4.43579 11.7083 5.33325H10.9583C10.9583 4.43579 10.2308 3.70825 9.33329 3.70825V2.95825ZM0.666626 7.33325C2.87577 7.33325 4.66663 5.54239 4.66663 3.33325H5.99996C5.99996 5.54239 7.79083 7.33325 9.99996 7.33325V8.66659C7.79083 8.66659 5.99996 10.4575 5.99996 12.6666H4.66663C4.66663 10.4575 2.87577 8.66659 0.666626 8.66659V7.33325ZM11.5 9.33325C11.5 10.5299 10.5299 11.4999 9.33329 11.4999V12.4999C10.5299 12.4999 11.5 13.47 11.5 14.6666H12.5C12.5 13.47 13.47 12.4999 14.6666 12.4999V11.4999C13.47 11.4999 12.5 10.5299 12.5 9.33325H11.5Z",fill:"url(#paint0_linear_13059_32065)",fillOpacity:"0.95"}),(0,x.jsx)("defs",{children:(0,x.jsxs)("linearGradient",{id:"paint0_linear_13059_32065",x1:"14.9996",y1:"15",x2:"-2.55847",y2:"16.6207",gradientUnits:"userSpaceOnUse",children:[(0,x.jsx)("stop",{stopColor:"#36BFFA"}),(0,x.jsx)("stop",{offset:"1",stopColor:"#296DFF"})]})})]}),ok=()=>(0,x.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",children:[(0,x.jsx)("path",{d:"M9.33329 2.95837C10.2308 2.95837 10.9583 2.23083 10.9583 1.33337H11.7083C11.7083 2.23083 12.4358 2.95837 13.3333 2.95837V3.70837C12.4358 3.70837 11.7083 4.43591 11.7083 5.33337H10.9583C10.9583 4.43591 10.2308 3.70837 9.33329 3.70837V2.95837ZM0.666626 7.33337C2.87577 7.33337 4.66663 5.54251 4.66663 3.33337H5.99996C5.99996 5.54251 7.79083 7.33337 9.99996 7.33337V8.66671C7.79083 8.66671 5.99996 10.4576 5.99996 12.6667H4.66663C4.66663 10.4576 2.87577 8.66671 0.666626 8.66671V7.33337ZM11.5 9.33337C11.5 10.53 10.5299 11.5 9.33329 11.5V12.5C10.5299 12.5 11.5 13.4701 11.5 14.6667H12.5C12.5 13.4701 13.47 12.5 14.6666 12.5V11.5C13.47 11.5 12.5 10.53 12.5 9.33337H11.5Z",fill:"url(#paint0_linear_13059_18704)",fillOpacity:"0.95"}),(0,x.jsx)("defs",{children:(0,x.jsxs)("linearGradient",{id:"paint0_linear_13059_18704",x1:"14.9996",y1:"15.0001",x2:"-2.55847",y2:"16.6209",gradientUnits:"userSpaceOnUse",children:[(0,x.jsx)("stop",{stopColor:"#0BA5EC"}),(0,x.jsx)("stop",{offset:"1",stopColor:"#155AEF"})]})})]});var oN=e.i(449980);let oC=y.memo(e=>{let{schema:t,isGenerating:a,onBack:r,onRegenerate:s,onClose:l,onApply:n}=e,{t:o}=(0,O.useTranslation)(),[i,d]=(0,y.useState)(null),[c,u]=(0,y.useState)(""),p=(0,y.useMemo)(()=>(e=>{try{let t=JSON.stringify(e,null,2);return d(null),t}catch(e){return e instanceof Error?d(e):d(Error("Invalid JSON")),""}})(t),[t]),m=(0,y.useCallback)(()=>{let e=(0,oh.validateSchemaAgainstDraft7)(t);e.length>0?u((0,oh.getValidationErrorMessage)(e)):(n(),u(""))},[t,n]);return(0,x.jsx)("div",{className:"flex w-[480px] flex-col rounded-2xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-2xl shadow-shadow-shadow-9",children:a?(0,x.jsxs)("div",{className:"flex h-[600px] flex-col items-center justify-center gap-y-3",children:[(0,x.jsx)(oN.default,{type:"area"}),(0,x.jsx)("div",{className:"system-xs-regular text-text-tertiary",children:o("nodes.llm.jsonSchema.generating",{ns:"workflow"})})]}):(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"absolute right-2.5 top-2.5 flex h-8 w-8 items-center justify-center",onClick:l,children:(0,x.jsx)(M.RiCloseLine,{className:"h-4 w-4 text-text-tertiary"})}),(0,x.jsxs)("div",{className:"flex flex-col gap-y-[0.5px] px-3 pb-1 pt-3.5",children:[(0,x.jsx)("div",{className:"system-xl-semibold flex pl-1 pr-8 text-text-primary",children:o("nodes.llm.jsonSchema.generatedResult",{ns:"workflow"})}),(0,x.jsx)("div",{className:"system-xs-regular flex px-1 text-text-tertiary",children:o("nodes.llm.jsonSchema.resultTip",{ns:"workflow"})})]}),(0,x.jsxs)("div",{className:"px-4 py-2",children:[(0,x.jsx)(of.default,{className:"rounded-lg",editorWrapperClassName:"h-[424px]",value:p,readOnly:!0,showFormatButton:!1}),i&&(0,x.jsx)(og,{message:i.message}),c&&(0,x.jsx)(og,{message:c})]}),(0,x.jsxs)("div",{className:"flex items-center justify-between p-4 pt-2",children:[(0,x.jsxs)(es.default,{variant:"secondary",className:"flex items-center gap-x-0.5",onClick:r,children:[(0,x.jsx)(M.RiArrowLeftLine,{className:"h-4 w-4"}),(0,x.jsx)("span",{children:o("nodes.llm.jsonSchema.back",{ns:"workflow"})})]}),(0,x.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,x.jsxs)(es.default,{variant:"secondary",className:"flex items-center gap-x-0.5",onClick:s,children:[(0,x.jsx)(M.RiSparklingLine,{className:"h-4 w-4"}),(0,x.jsx)("span",{children:o("nodes.llm.jsonSchema.regenerate",{ns:"workflow"})})]}),(0,x.jsx)(es.default,{variant:"primary",onClick:m,children:o("nodes.llm.jsonSchema.apply",{ns:"workflow"})})]})]})]})})}),o_=y.memo(e=>{let{instruction:t,model:a,onInstructionChange:r,onCompletionParamsChange:s,onClose:l,onGenerate:n,onModelChange:o}=e,{t:i}=(0,O.useTranslation)(),d=(0,y.useCallback)(e=>{r(e.target.value)},[r]);return(0,x.jsxs)("div",{className:"relative flex w-[480px] flex-col rounded-2xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-2xl shadow-shadow-shadow-9",children:[(0,x.jsx)("div",{className:"absolute right-2.5 top-2.5 flex h-8 w-8 items-center justify-center",onClick:l,children:(0,x.jsx)(M.RiCloseLine,{className:"h-4 w-4 text-text-tertiary"})}),(0,x.jsxs)("div",{className:"flex flex-col gap-y-[0.5px] px-3 pb-1 pt-3.5",children:[(0,x.jsx)("div",{className:"system-xl-semibold flex pl-1 pr-8 text-text-primary",children:i("nodes.llm.jsonSchema.generateJsonSchema",{ns:"workflow"})}),(0,x.jsx)("div",{className:"system-xs-regular flex px-1 text-text-tertiary",children:i("nodes.llm.jsonSchema.generationTip",{ns:"workflow"})})]}),(0,x.jsxs)("div",{className:"flex flex-col gap-y-1 px-4 py-2",children:[(0,x.jsx)("div",{className:"system-sm-semibold-uppercase flex h-6 items-center text-text-secondary",children:i("modelProvider.model",{ns:"common"})}),(0,x.jsx)(n4.default,{popupClassName:"!w-[448px]",portalToFollowElemContentClassName:"z-[1000]",isAdvancedMode:!0,provider:a.provider,completionParams:a.completion_params,modelId:a.name,setModel:o,onCompletionParamsChange:s,hideDebugWithMultipleModel:!0})]}),(0,x.jsxs)("div",{className:"flex flex-col gap-y-1 px-4 py-2",children:[(0,x.jsxs)("div",{className:"system-sm-semibold-uppercase flex h-6 items-center text-text-secondary",children:[(0,x.jsx)("span",{children:i("nodes.llm.jsonSchema.instruction",{ns:"workflow"})}),(0,x.jsx)(B.default,{popupContent:i("nodes.llm.jsonSchema.promptTooltip",{ns:"workflow"})})]}),(0,x.jsx)("div",{className:"flex items-center",children:(0,x.jsx)(se.default,{className:"h-[364px] resize-none px-2 py-1",value:t,placeholder:i("nodes.llm.jsonSchema.promptPlaceholder",{ns:"workflow"}),onChange:d})})]}),(0,x.jsxs)("div",{className:"flex justify-end gap-x-2 p-4 pt-2",children:[(0,x.jsx)(es.default,{variant:"secondary",onClick:l,children:i("operation.cancel",{ns:"common"})}),(0,x.jsxs)(es.default,{variant:"primary",className:"flex items-center gap-x-0.5",onClick:n,children:[(0,x.jsx)(M.RiSparklingFill,{className:"h-4 w-4"}),(0,x.jsx)("span",{children:i("nodes.llm.jsonSchema.generate",{ns:"workflow"})})]})]})]})});var oT=((i=oT||{}).promptEditor="promptEditor",i.result="result",i);let oS=e=>{let{onApply:t,crossAxisOffset:a}=e,r=localStorage.getItem("auto-gen-model")?JSON.parse(localStorage.getItem("auto-gen-model")):null,[s,l]=(0,y.useState)(!1),[n,o]=(0,y.useState)("promptEditor"),[i,d]=(0,y.useState)(r||{name:"",provider:"",mode:eg.ModelModeType.completion,completion_params:{}}),[c,u]=(0,y.useState)(""),[p,m]=(0,y.useState)(null),{theme:h}=(0,ow.default)(),{defaultModel:g}=(0,$.useModelListAndDefaultModelAndCurrentProviderAndModel)(t0.ModelTypeEnum.textGeneration),f=(0,oy.useVisualEditorStore)(e=>e.advancedEditing),b=(0,oy.useVisualEditorStore)(e=>e.isAddingNewField),{emit:v}=(0,ob.useMittContext)(),w=h===eg.Theme.light?ok:oj;(0,y.useEffect)(()=>{if(g){let e=localStorage.getItem("auto-gen-model")?JSON.parse(localStorage.getItem("auto-gen-model")||""):null;e?d(e):d(e=>({...e,name:g.model,provider:g.provider.provider}))}},[g]);let j=(0,y.useCallback)(e=>{e.stopPropagation(),(f||b)&&v("quitEditing",{}),l(!s)},[s,f,b,v]),k=(0,y.useCallback)(()=>{l(!1)},[]),N=(0,y.useCallback)(e=>{let t={...i,provider:e.provider,name:e.modelId,mode:e.mode};d(t),localStorage.setItem("auto-gen-model",JSON.stringify(t))},[i,d]),C=(0,y.useCallback)(e=>{let t={...i,completion_params:e};d(t),localStorage.setItem("auto-gen-model",JSON.stringify(t))},[i,d]),{mutateAsync:_,isPending:S}=(0,sq.useGenerateStructuredOutputRules)(),E=(0,y.useCallback)(async()=>{let{output:e,error:t}=await _({instruction:c,model_config:i});if(t){eR.default.notify({type:"error",message:t}),m(null),o("promptEditor");return}return e},[c,i,_]),V=(0,y.useCallback)(async()=>{o("result");let e=await E();void 0!==e&&m(JSON.parse(e))},[E]),I=(0,y.useCallback)(async()=>{let e=await E();void 0!==e&&m(JSON.parse(e))},[E]);return(0,x.jsxs)(ez.PortalToFollowElem,{open:s,onOpenChange:l,placement:"bottom-end",offset:{mainAxis:4,crossAxis:a??0},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:j,children:(0,x.jsx)("button",{type:"button",className:(0,T.cn)("flex h-6 w-6 items-center justify-center rounded-md p-0.5 hover:bg-state-accent-hover",s&&"bg-state-accent-active"),children:(0,x.jsx)(w,{})})}),(0,x.jsxs)(ez.PortalToFollowElemContent,{className:"z-[100]",children:["promptEditor"===n&&(0,x.jsx)(o_,{instruction:c,model:i,onInstructionChange:u,onCompletionParamsChange:C,onGenerate:V,onClose:k,onModelChange:N}),"result"===n&&(0,x.jsx)(oC,{schema:p,isGenerating:S,onBack:()=>{o("promptEditor")},onRegenerate:I,onApply:()=>{t(p),l(!1)},onClose:k})]})]})};var oE=e.i(70380);let oV=e=>{let{schema:t,onUpdate:a,hideTopMenu:r,className:s,readonly:l=!1,onFocus:n,onBlur:o,isTruncated:i}=e;return(0,x.jsx)(of.default,{readOnly:l,className:(0,T.cn)("grow rounded-xl",s),editorWrapperClassName:"grow",value:t,onUpdate:a,hideTopMenu:r,onFocus:n,onBlur:o,topContent:i&&(0,x.jsx)(oE.default,{className:"mx-1 mb-3 mt-[-4px]"})})};var oI=e.i(609995),oR=((d=oR||{}).VisualEditor="visualEditor",d.JsonSchema="jsonSchema",d);let oM=[{Icon:M.RiTimelineView,text:"Visual Editor",value:"visualEditor"},{Icon:M.RiBracesLine,text:"JSON Schema",value:"jsonSchema"}],oA={type:od.Type.object,properties:{},required:[],additionalProperties:!1},oO=e=>{let{defaultSchema:t,onSave:a,onClose:r}=e,{t:s}=(0,O.useTranslation)(),[l,n]=(0,y.useState)("visualEditor"),[o,i]=(0,y.useState)(t||oA),[d,c]=(0,y.useState)(()=>JSON.stringify(o,null,2)),[u,p]=(0,y.useState)(0),[m,h]=(0,y.useState)(null),[g,f]=(0,y.useState)(""),b=(0,oy.useVisualEditorStore)(e=>e.advancedEditing),v=(0,oy.useVisualEditorStore)(e=>e.setAdvancedEditing),w=(0,oy.useVisualEditorStore)(e=>e.isAddingNewField),j=(0,oy.useVisualEditorStore)(e=>e.setIsAddingNewField),N=(0,oy.useVisualEditorStore)(e=>e.setHoveringProperty),{emit:C}=(0,ob.useMittContext)(),_=(0,y.useCallback)(e=>{p(e+32)},[]),T=(0,y.useCallback)(e=>{if(l!==e){if("jsonSchema"===l)try{let e=JSON.parse(d);h(null);let t=(0,oh.preValidateSchema)(e);if(!t.success)return void f(t.error.message);if((0,oh.checkJsonSchemaDepth)(e)>k.JSON_SCHEMA_MAX_DEPTH)return void f(`Schema exceeds maximum depth of ${k.JSON_SCHEMA_MAX_DEPTH}.`);let a=(0,oh.validateSchemaAgainstDraft7)(e);if(a.length>0)return void f((0,oh.getValidationErrorMessage)(a));i(e),f("")}catch(e){f(""),e instanceof Error?h(e):h(Error("Invalid JSON"));return}else"visualEditor"===l&&(b||w?C("quitEditing",{callback:e=>c(JSON.stringify(e||o,null,2))}):c(JSON.stringify(o,null,2)));n(e)}},[l,o,d,b,w,C]),S=(0,y.useCallback)(e=>{"visualEditor"===l?i(e):"jsonSchema"===l&&c(JSON.stringify(e,null,2))},[l]),E=(0,y.useCallback)(e=>{let t=(0,oh.jsonToSchema)(e);"visualEditor"===l?i(t):"jsonSchema"===l&&c(JSON.stringify(t,null,2))},[l]),V=(0,y.useCallback)(e=>{i(e)},[]),I=(0,y.useCallback)(e=>{c(e)},[]),R=(0,y.useCallback)(()=>{"visualEditor"===l&&(N(null),b&&v(!1),w&&j(!1)),i(oA),c(JSON.stringify(oA,null,2))},[l,b,w,v,j,N]),A=(0,y.useCallback)(()=>{r()},[r]),P=(0,y.useCallback)(()=>{let e=o;if("jsonSchema"===l)try{e=JSON.parse(d),h(null);let t=(0,oh.preValidateSchema)(e);if(!t.success)return void f(t.error.message);if((0,oh.checkJsonSchemaDepth)(e)>k.JSON_SCHEMA_MAX_DEPTH)return void f(`Schema exceeds maximum depth of ${k.JSON_SCHEMA_MAX_DEPTH}.`);let a=(0,oh.validateSchemaAgainstDraft7)(e);if(a.length>0)return void f((0,oh.getValidationErrorMessage)(a));i(e),f("")}catch(e){f(""),e instanceof Error?h(e):h(Error("Invalid JSON"));return}else if("visualEditor"===l&&(b||w))return void eR.default.notify({type:"warning",message:s("nodes.llm.jsonSchema.warningTips.saveSchema",{ns:"workflow"})});a(e),r()},[l,o,d,a,r,b,w,s]);return(0,x.jsxs)("div",{className:"flex h-full flex-col",children:[(0,x.jsxs)("div",{className:"relative flex p-6 pb-3 pr-14",children:[(0,x.jsx)("div",{className:"title-2xl-semi-bold grow truncate text-text-primary",children:s("nodes.llm.jsonSchema.title",{ns:"workflow"})}),(0,x.jsx)("div",{className:"absolute right-5 top-5 flex h-8 w-8 items-center justify-center p-1.5",onClick:r,children:(0,x.jsx)(M.RiCloseLine,{className:"h-[18px] w-[18px] text-text-tertiary"})})]}),(0,x.jsxs)("div",{className:"flex items-center justify-between px-6 py-2",children:[(0,x.jsx)(ox,{options:oM,value:l,onChange:T}),(0,x.jsxs)("div",{className:"flex items-center gap-x-0.5",children:[(0,x.jsx)(oS,{crossAxisOffset:u,onApply:S}),(0,x.jsx)(ss.default,{type:"vertical",className:"h-3"}),(0,x.jsx)(ov,{updateBtnWidth:_,onSubmit:E})]})]}),(0,x.jsxs)("div",{className:"flex grow flex-col gap-y-1 overflow-hidden px-6",children:["visualEditor"===l&&(0,x.jsx)(oI.default,{schema:o,onChange:V}),"jsonSchema"===l&&(0,x.jsx)(oV,{schema:d,onUpdate:I}),m&&(0,x.jsx)(og,{message:m.message}),g&&(0,x.jsx)(og,{message:g})]}),(0,x.jsx)("div",{className:"flex items-center gap-x-2 p-6 pt-5",children:(0,x.jsxs)("div",{className:"flex items-center gap-x-3",children:[(0,x.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,x.jsx)(es.default,{variant:"secondary",onClick:R,children:s("nodes.llm.jsonSchema.resetDefaults",{ns:"workflow"})}),(0,x.jsx)(ss.default,{type:"vertical",className:"ml-1 mr-0 h-4"})]}),(0,x.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,x.jsx)(es.default,{variant:"secondary",onClick:A,children:s("operation.cancel",{ns:"common"})}),(0,x.jsx)(es.default,{variant:"primary",onClick:P,children:s("operation.save",{ns:"common"})})]})]})})]})},oP=e=>(0,x.jsx)(ob.MittProvider,{children:(0,x.jsx)(ob.VisualEditorContextProvider,{children:(0,x.jsx)(oO,{...e})})}),oL=e=>{let{isShow:t,defaultSchema:a,onSave:r,onClose:s}=e;return(0,x.jsx)(s5.default,{isShow:t,onClose:s,className:"h-[800px] max-w-[960px] p-0",children:(0,x.jsx)(oP,{defaultSchema:a,onSave:r,onClose:s})})},oF=y.memo(e=>{let{className:t,value:a,onChange:r}=e,{t:s}=(0,O.useTranslation)(),[l,{setTrue:n,setFalse:o}]=(0,an.useBoolean)(!1),i=(0,y.useCallback)(e=>{r({schema:e})},[r]);return(0,x.jsxs)("div",{className:(0,T.cn)(t),children:[(0,x.jsxs)("div",{className:"flex justify-between",children:[(0,x.jsxs)("div",{className:"flex items-center leading-[18px]",children:[(0,x.jsx)("div",{className:"code-sm-semibold text-text-secondary",children:"structured_output"}),(0,x.jsx)("div",{className:"system-xs-regular ml-2 text-text-tertiary",children:"object"})]}),(0,x.jsxs)(es.default,{size:"small",variant:"secondary",className:"flex",onClick:n,children:[(0,x.jsx)(M.RiEditLine,{className:"mr-1 size-3.5"}),(0,x.jsx)("div",{className:"system-xs-medium text-components-button-secondary-text",children:s("structOutput.configure",{ns:"app"})})]})]}),a?.schema&&a.schema.properties&&Object.keys(a.schema.properties).length>0?(0,x.jsx)(sF,{payload:a}):(0,x.jsx)("div",{className:"system-xs-regular mt-1.5 flex h-10 cursor-pointer items-center justify-center rounded-[10px] bg-background-section text-text-tertiary",onClick:n,children:s("structOutput.notConfiguredTip",{ns:"app"})}),l&&(0,x.jsx)(oL,{isShow:!0,defaultSchema:a?.schema||{type:od.Type.object,properties:{},required:[],additionalProperties:!1},onSave:i,onClose:o})]})}),oB="nodes.llm",oD=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,isChatModel:n,isChatMode:o,isCompletionModel:i,shouldShowContextTip:d,isVisionModel:c,handleModelChanged:u,hasSetBlockStatus:p,handleCompletionParamsChange:m,handleContextVarChange:h,filterInputVar:g,filterVar:b,availableVars:v,availableNodesWithParent:w,isShowVars:j,handlePromptChange:k,handleAddEmptyVariable:N,handleAddVariable:C,handleVarListChange:_,handleVarNameChange:T,handleSyeQueryChange:S,handleMemoryChange:E,handleVisionResolutionEnabledChange:V,handleVisionResolutionChange:I,isModelSupportStructuredOutput:R,structuredOutputCollapsed:A,setStructuredOutputCollapsed:P,handleStructureOutputEnableChange:L,handleStructureOutputChange:F,filterJinja2InputVar:D,handleReasoningFormatChange:z}=((e,t)=>{let a,r,{nodesReadOnly:s}=(0,Z.useNodesReadOnly)(),l=(0,Z.useIsChatMode)(),n=(0,eN.useStore)(e=>e.nodesDefaultConfigs)?.[t.type],[o,i]=(0,y.useState)({user:"",assistant:""}),{inputs:d,setInputs:c}=(0,tZ.default)(e,t),u=(0,y.useRef)(d);(0,y.useEffect)(()=>{u.current=d},[d]);let{deleteNodeInspectorVars:p}=(0,ea.default)(),m=(0,y.useCallback)(e=>{if(e.memory&&!e.memory.role_prefix){let t=(0,f.produce)(e,e=>{e.memory.role_prefix=o});c(t),u.current=t;return}c(e),u.current=e},[c,o]),x=d.model,h=d.model?.mode===eg.AppModeEnum.CHAT,g=!h,b=(a=d.prompt_template,r=h?a.some(e=>(0,tb.checkHasContextBlock)(e.text)):(0,tb.checkHasContextBlock)(a.text),l?h?{history:!1,query:a.some(e=>(0,tb.checkHasQueryBlock)(e.text)),context:r}:{history:(0,tb.checkHasHistoryBlock)(a.text),query:(0,tb.checkHasQueryBlock)(a.text),context:r}:{history:!1,query:!1,context:r}),v=!b.context&&d.context.enabled,w=(0,y.useCallback)((e,t,a)=>{let r=t.prompt_templates;(void 0===a?h:a)?e.prompt_template=r.chat_model.prompts:(e.prompt_template=r.completion_model.prompt,i({user:r.completion_model.conversation_histories_role.user_prefix,assistant:r.completion_model.conversation_histories_role.assistant_prefix}))},[h]);(0,y.useEffect)(()=>{n&&Object.keys(n).length>0&&!d.prompt_template&&m((0,f.produce)(d,e=>{w(e,n)}))},[n,h]);let[j,k]=(0,y.useState)(!1),{currentProvider:N,currentModel:C}=(0,$.useModelListAndDefaultModelAndCurrentProviderAndModel)(t0.ModelTypeEnum.textGeneration),{isVisionModel:_,handleVisionResolutionEnabledChange:T,handleVisionResolutionChange:S,handleModelChanged:E}=as(x,{payload:d.vision,onChange:e=>{m((0,f.produce)(u.current,t=>{t.vision=e}))}}),V=(0,y.useCallback)(e=>{m((0,f.produce)(u.current,t=>{t.model.provider=e.provider,t.model.name=e.modelId,t.model.mode=e.mode,e.mode!==u.current.model.mode&&n&&Object.keys(n).length>0&&w(t,n,e.mode===eg.AppModeEnum.CHAT)})),k(!0)},[m,n,w]);(0,y.useEffect)(()=>{N?.provider&&C?.model&&!x.provider&&V({provider:N?.provider,modelId:C?.model,mode:C?.model_properties?.mode})},[x.provider,N,C,V]);let I=(0,y.useCallback)(e=>{m((0,f.produce)(u.current,t=>{t.model.completion_params=e}))},[m]);(0,y.useEffect)(()=>{j&&(k(!1),E())},[_,j]);let R=h?d.prompt_template.some(e=>e.edition_type===eb.EditionType.jinja2):d.prompt_template.edition_type===eb.EditionType.jinja2,M=(0,y.useCallback)(()=>{m((0,f.produce)(u.current,e=>{e.prompt_config||(e.prompt_config={jinja2_variables:[]}),e.prompt_config.jinja2_variables||(e.prompt_config.jinja2_variables=[]),e.prompt_config.jinja2_variables.push({variable:"",value_selector:[]})}))},[m]),A=(0,y.useCallback)(e=>{m((0,f.produce)(u.current,t=>{t.prompt_config||(t.prompt_config={jinja2_variables:[]}),t.prompt_config.jinja2_variables||(t.prompt_config.jinja2_variables=[]),t.prompt_config.jinja2_variables.push(e)}))},[m]),O=(0,y.useCallback)(e=>{m((0,f.produce)(u.current,t=>{t.prompt_config||(t.prompt_config={jinja2_variables:[]}),t.prompt_config.jinja2_variables||(t.prompt_config.jinja2_variables=[]),t.prompt_config.jinja2_variables=e}))},[m]),P=(0,y.useCallback)((e,t)=>{m((0,f.produce)(u.current,a=>{if(h)a.prompt_template.filter(e=>e.edition_type===eb.EditionType.jinja2).forEach(a=>{a.jinja2_text=(a.jinja2_text||"").replaceAll(`{{ ${e} }}`,`{{ ${t} }}`)});else{if(a.prompt_template.edition_type!==eb.EditionType.jinja2)return;let r=a.prompt_template;r.jinja2_text=(r.jinja2_text||"").replaceAll(`{{ ${e} }}`,`{{ ${t} }}`)}}))},[h,m]),L=(0,y.useCallback)(e=>{m((0,f.produce)(u.current,t=>{t.context.variable_selector=e||[],t.context.enabled=!!(e&&e.length>0)}))},[m]),F=(0,y.useCallback)(e=>{m((0,f.produce)(u.current,t=>{t.prompt_template=e}))},[m]),B=(0,y.useCallback)(e=>{m((0,f.produce)(u.current,t=>{t.memory=e}))},[m]),D=(0,y.useCallback)(e=>{m((0,f.produce)(u.current,t=>{t.memory?t.memory.query_prompt_template=e:t.memory={window:{enabled:!1,size:10},query_prompt_template:e}}))},[m]),{data:z}=(0,$.useModelList)(t0.ModelTypeEnum.textGeneration),H=z?.find(e=>e.provider===x?.provider)?.models.find(e=>e.model===x?.name)?.features?.includes(t0.ModelFeatureEnum.StructuredOutput),[W,q]=(0,y.useState)(!0),U=(0,y.useCallback)(t=>{m((0,f.produce)(u.current,e=>{e.structured_output_enabled=t})),t&&q(!1),p(e)},[m,p,e]),K=(0,y.useCallback)(t=>{m((0,f.produce)(u.current,e=>{e.structured_output=t})),p(e)},[m,p,e]),G=(0,y.useCallback)(e=>[eb.VarType.number,eb.VarType.string,eb.VarType.secret,eb.VarType.arrayString,eb.VarType.arrayNumber,eb.VarType.file,eb.VarType.arrayFile].includes(e.type),[]),J=(0,y.useCallback)(e=>[eb.VarType.number,eb.VarType.string,eb.VarType.secret,eb.VarType.arrayString,eb.VarType.arrayNumber,eb.VarType.arrayBoolean,eb.VarType.arrayObject,eb.VarType.object,eb.VarType.array,eb.VarType.boolean].includes(e.type),[]),X=(0,y.useCallback)(e=>[eb.VarType.arrayObject,eb.VarType.array,eb.VarType.number,eb.VarType.string,eb.VarType.secret,eb.VarType.arrayString,eb.VarType.arrayNumber,eb.VarType.file,eb.VarType.arrayFile].includes(e.type),[]),Q=(0,y.useCallback)(e=>{m((0,f.produce)(u.current,t=>{t.reasoning_format=e}))},[m]),{availableVars:Y,availableNodesWithParent:ee}=(0,t3.default)(e,{onlyLeafNodeVar:!1,filterVar:X});return{readOnly:s,isChatMode:l,inputs:d,isChatModel:h,isCompletionModel:g,hasSetBlockStatus:b,shouldShowContextTip:v,isVisionModel:_,handleModelChanged:V,handleCompletionParamsChange:I,isShowVars:R,handleVarListChange:O,handleVarNameChange:P,handleAddVariable:A,handleAddEmptyVariable:M,handleContextVarChange:L,filterInputVar:G,filterVar:X,availableVars:Y,availableNodesWithParent:ee,handlePromptChange:F,handleMemoryChange:B,handleSyeQueryChange:D,handleVisionResolutionEnabledChange:T,handleVisionResolutionChange:S,isModelSupportStructuredOutput:H,handleStructureOutputChange:K,structuredOutputCollapsed:W,setStructuredOutputCollapsed:q,handleStructureOutputEnableChange:U,filterJinja2InputVar:J,handleReasoningFormatChange:Q}})(t,a),H=l.model,W=(0,y.useCallback)(e=>{(async()=>{try{let{params:t,removedDetails:a}=await (0,n6.fetchAndMergeValidCompletionParams)(e.provider,e.modelId,l.model.completion_params,!0),s=Object.keys(a);s.length&&eR.default.notify({type:"warning",message:`${r("modelProvider.parametersInvalidRemoved",{ns:"common"})}: ${s.map(e=>`${e} (${a[e]})`).join(", ")}`}),m(t)}catch{eR.default.notify({type:"error",message:r("error",{ns:"common"})}),m({})}finally{u(e)}})()},[l.model.completion_params]);return(0,x.jsxs)("div",{className:"mt-2",children:[(0,x.jsxs)("div",{className:"space-y-4 px-4 pb-4",children:[(0,x.jsx)(rj,{title:r(`${oB}.model`,{ns:"workflow"}),required:!0,children:(0,x.jsx)(n4.default,{popupClassName:"!w-[387px]",isInWorkflow:!0,isAdvancedMode:!0,provider:H?.provider,completionParams:H?.completion_params,modelId:H?.name,setModel:W,onCompletionParamsChange:m,hideDebugWithMultipleModel:!0,debugWithMultipleModel:!1,readonly:s})}),(0,x.jsx)(rj,{title:r(`${oB}.context`,{ns:"workflow"}),tooltip:r(`${oB}.contextTooltip`,{ns:"workflow"}),children:(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(sa.default,{readonly:s,nodeId:t,isShowNodeName:!0,value:l.context?.variable_selector||[],onChange:h,filterVar:b}),d&&(0,x.jsx)("div",{className:"text-xs font-normal leading-[18px] text-[#DC6803]",children:r(`${oB}.notSetContextInPromptTip`,{ns:"workflow"})})]})}),H.name&&(0,x.jsx)(oo,{readOnly:s,nodeId:t,filterVar:j?D:g,isChatModel:n,isChatApp:o,isShowContext:!0,payload:l.prompt_template,onChange:k,hasSetBlockStatus:p,varList:l.prompt_config?.jinja2_variables||[],handleAddVariable:C,modelConfig:H}),j&&(0,x.jsx)(rj,{title:r("nodes.templateTransform.inputVars",{ns:"workflow"}),operations:s?void 0:(0,x.jsx)(eM.default,{onClick:N}),children:(0,x.jsx)(sw,{nodeId:t,readonly:s,list:l.prompt_config?.jinja2_variables||[],onChange:_,onVarNameChange:T,filterVar:D,isSupportFileVar:!1})}),o&&n&&!!l.memory&&(0,x.jsxs)("div",{className:"mt-4",children:[(0,x.jsxs)("div",{className:"flex h-8 items-center justify-between rounded-lg bg-components-input-bg-normal pl-3 pr-2",children:[(0,x.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,x.jsx)("div",{className:"text-xs font-semibold uppercase text-text-secondary",children:r("nodes.common.memories.title",{ns:"workflow"})}),(0,x.jsx)(B.default,{popupContent:r("nodes.common.memories.tip",{ns:"workflow"}),triggerClassName:"w-4 h-4"})]}),(0,x.jsx)("div",{className:"flex h-[18px] items-center rounded-[5px] border border-divider-deep bg-components-badge-bg-dimm px-1 text-xs font-semibold uppercase text-text-tertiary",children:r("nodes.common.memories.builtIn",{ns:"workflow"})})]}),(0,x.jsxs)("div",{className:"mt-4",children:[(0,x.jsx)(rF,{title:(0,x.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,x.jsx)("div",{className:"text-xs font-semibold uppercase text-text-secondary",children:"user"}),(0,x.jsx)(B.default,{popupContent:(0,x.jsx)("div",{className:"max-w-[180px]",children:r("nodes.llm.roleDescription.user",{ns:"workflow"})}),triggerClassName:"w-4 h-4"})]}),value:l.memory.query_prompt_template||"{{#sys.query#}}",onChange:S,readOnly:s,isShowContext:!1,isChatApp:!0,isChatModel:!0,hasSetBlockStatus:p,nodesOutputVars:v,availableNodes:w,isSupportFileVar:!0}),l.memory.query_prompt_template&&!l.memory.query_prompt_template.includes("{{#sys.query#}}")&&(0,x.jsx)("div",{className:"text-xs font-normal leading-[18px] text-[#DC6803]",children:r(`${oB}.sysQueryInUser`,{ns:"workflow"})})]})]}),o&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(er,{}),(0,x.jsx)(rW,{readonly:s,config:{data:l.memory},onChange:E,canSetRoleName:i})]}),(0,x.jsx)(n7,{nodeId:t,readOnly:s,isVisionModel:c,enabled:l.vision?.enabled,onEnabledChange:V,config:l.vision?.configs,onConfigChange:I}),(0,x.jsx)(oi,{value:l.reasoning_format||"tagged",onChange:z,readonly:s})]}),(0,x.jsx)(er,{}),(0,x.jsx)(rG,{collapsed:A,onCollapse:P,operations:(0,x.jsxs)("div",{className:"mr-4 flex shrink-0 items-center",children:[!R&&!!l.structured_output_enabled&&(0,x.jsx)(B.default,{noDecoration:!0,popupContent:(0,x.jsxs)("div",{className:"w-[232px] rounded-xl border-[0.5px] border-components-panel-border bg-components-tooltip-bg px-4 py-3.5 shadow-lg backdrop-blur-[5px]",children:[(0,x.jsx)("div",{className:"title-xs-semi-bold text-text-primary",children:r("structOutput.modelNotSupported",{ns:"app"})}),(0,x.jsx)("div",{className:"body-xs-regular mt-1 text-text-secondary",children:r("structOutput.modelNotSupportedTip",{ns:"app"})})]}),children:(0,x.jsx)("div",{children:(0,x.jsx)(M.RiAlertFill,{className:"mr-1 size-4 text-text-warning-secondary"})})}),(0,x.jsx)("div",{className:"system-xs-medium-uppercase mr-0.5 text-text-tertiary",children:r("structOutput.structured",{ns:"app"})}),(0,x.jsx)(B.default,{popupContent:(0,x.jsx)("div",{className:"max-w-[150px]",children:r("structOutput.structuredTip",{ns:"app"})}),children:(0,x.jsx)("div",{children:(0,x.jsx)(M.RiQuestionLine,{className:"size-3.5 text-text-quaternary"})})}),(0,x.jsx)(ts.default,{className:"ml-2",defaultValue:!!l.structured_output_enabled,onChange:L,size:"md",disabled:s})]}),children:(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(rK,{name:"text",type:"string",description:r(`${oB}.outputVars.output`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"reasoning_content",type:"string",description:r(`${oB}.outputVars.reasoning_content`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"usage",type:"object",description:r(`${oB}.outputVars.usage`,{ns:"workflow"})}),l.structured_output_enabled&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(er,{className:"mt-3"}),(0,x.jsx)(oF,{className:"mt-4",value:l.structured_output,onChange:F})]})]})})]})}),o$=()=>{let{t:e}=(0,O.useTranslation)();return(0,x.jsx)("div",{className:"nodrag relative left-[17px] top-[21px] z-[11] flex h-11 w-11 items-center justify-center rounded-2xl border border-workflow-block-border bg-workflow-block-bg",children:(0,x.jsx)(B.default,{popupContent:e("blocks.loop-start",{ns:"workflow"}),asChild:!1,children:(0,x.jsx)("div",{className:"flex h-6 w-6 items-center justify-center rounded-full border-[0.5px] border-components-panel-border-subtle bg-util-colors-blue-brand-blue-brand-500",children:(0,x.jsx)(M.RiHome5Fill,{className:"h-3 w-3 text-text-primary-on-surface"})})})})},oz=(0,y.memo)(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)();return(0,x.jsxs)("div",{className:"nodrag group mt-1 flex h-11 w-11 items-center justify-center rounded-2xl border border-workflow-block-border bg-workflow-block-bg",children:[(0,x.jsx)(B.default,{popupContent:r("blocks.loop-start",{ns:"workflow"}),asChild:!1,children:(0,x.jsx)("div",{className:"flex h-6 w-6 items-center justify-center rounded-full border-[0.5px] border-components-panel-border-subtle bg-util-colors-blue-brand-blue-brand-500",children:(0,x.jsx)(M.RiHome5Fill,{className:"h-3 w-3 text-text-primary-on-surface"})})}),(0,x.jsx)(aF,{id:t,data:a,handleClassName:"!top-1/2 !-right-[9px] !-translate-y-1/2",handleId:"source"})]})}),oH=(0,y.memo)(e=>{let{loopNodeData:t}=e,{t:a}=(0,O.useTranslation)(),{nodesReadOnly:r}=(0,Z.useNodesReadOnly)(),{handleNodeAdd:s}=(0,V.useNodesInteractions)(),{availableNextBlocks:l}=(0,X.useAvailableBlocks)(eb.BlockEnum.Start,!0),n=(0,y.useCallback)((e,a)=>{s({nodeType:e,pluginDefaultValue:a},{prevNodeId:t.start_node_id,prevNodeSourceHandle:"source"})},[s,t.start_node_id]),o=(0,y.useCallback)(e=>(0,x.jsxs)("div",{className:(0,T.cn)("system-sm-medium relative inline-flex h-8 cursor-pointer items-center rounded-lg border-[0.5px] border-components-button-secondary-border bg-components-button-secondary-bg px-3 text-components-button-secondary-text shadow-xs backdrop-blur-[5px] hover:bg-components-button-secondary-bg-hover",`${r&&"!cursor-not-allowed bg-components-button-secondary-bg-disabled"}`,e&&"bg-components-button-secondary-bg-hover"),children:[(0,x.jsx)(M.RiAddLine,{className:"mr-1 h-4 w-4"}),a("common.addBlock",{ns:"workflow"})]}),[r,a]);return(0,x.jsxs)("div",{className:"absolute left-14 top-7 z-10 flex h-8 items-center",children:[(0,x.jsx)("div",{className:"group/insert relative h-0.5 w-16 bg-gray-300",children:(0,x.jsx)("div",{className:"absolute right-0 top-1/2 h-2 w-0.5 -translate-y-1/2 bg-primary-500"})}),(0,x.jsx)(eZ.default,{disabled:r,onSelect:n,trigger:o,triggerInnerClassName:"inline-flex",popupClassName:"!min-w-[256px]",availableBlocksTypes:l})]})}),oW=(0,y.memo)(e=>{let{id:t,data:a}=e,{zoom:r}=(0,j.useViewport)(),s=(0,j.useNodesInitialized)(),{handleNodeLoopRerender:l}=(0,aj.useNodeLoopInteractions)();return(0,y.useEffect)(()=>{s&&l(t)},[s,t,l]),(0,x.jsxs)("div",{className:(0,T.cn)("relative h-full min-h-[90px] w-full min-w-[240px] rounded-2xl bg-workflow-canvas-workflow-bg"),children:[(0,x.jsx)(w.Background,{id:`loop-background-${t}`,className:"!z-0 rounded-2xl",gap:[14/r,14/r],size:2/r,color:"var(--color-workflow-canvas-workflow-dot-color)"}),a._isCandidate&&(0,x.jsx)(o$,{}),1===a._children.length&&(0,x.jsx)(oH,{loopNodeId:t,loopNodeData:a})]})}),oq=e=>{let{className:t,variables:a,onSelectVariable:r,disabled:s}=e,{t:l}=(0,O.useTranslation)(),[n,o]=(0,y.useState)(!1),i=(0,y.useCallback)((e,t)=>{r(e,t),o(!1)},[r,o]);return(0,x.jsxs)(ez.PortalToFollowElem,{open:n,onOpenChange:o,placement:"bottom-start",offset:{mainAxis:4,crossAxis:0},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>o(!n),children:(0,x.jsxs)(es.default,{size:"small",className:t,disabled:s,children:[(0,x.jsx)(M.RiAddLine,{className:"mr-1 h-3.5 w-3.5"}),l("nodes.ifElse.addCondition",{ns:"workflow"})]})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[1000]",children:(0,x.jsx)("div",{className:"w-[296px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow-lg",children:(0,x.jsx)(aR.default,{vars:a,isSupportFileVar:!0,onChange:i})})})]})};var oU=e.i(612594);let oK=[t6.VarType.variable,t6.VarType.constant],oG=(0,y.memo)(e=>{let{numberVarType:t=t6.VarType.constant,onNumberVarTypeChange:a,value:r,onValueChange:s,variables:l,isShort:n,unit:o}=e,{t:i}=(0,O.useTranslation)(),[d,c]=(0,y.useState)(!1),[u,p]=(0,y.useState)(!1),[m,{setTrue:h,setFalse:g}]=(0,an.useBoolean)(),f=(0,y.useCallback)(e=>{s((0,lS.variableTransformer)(e)),p(!1)},[s]);return(0,x.jsxs)("div",{className:"flex cursor-pointer items-center",children:[(0,x.jsxs)(ez.PortalToFollowElem,{open:d,onOpenChange:c,placement:"bottom-start",offset:{mainAxis:2,crossAxis:0},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>c(e=>!e),children:(0,x.jsxs)(es.default,{className:"shrink-0",variant:"ghost",size:"small",children:[(0,lT.capitalize)(t),(0,x.jsx)(M.RiArrowDownSLine,{className:"ml-[1px] h-3.5 w-3.5"})]})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[1000]",children:(0,x.jsx)("div",{className:"w-[112px] rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur p-1 shadow-lg",children:oK.map(e=>(0,x.jsx)("div",{className:(0,T.cn)("flex h-7 cursor-pointer items-center rounded-md px-3 hover:bg-state-base-hover","text-[13px] font-medium text-text-secondary",t===e&&"bg-state-base-hover"),onClick:()=>{a(e),c(!1)},children:(0,lT.capitalize)(e)},e))})})]}),(0,x.jsx)("div",{className:"mx-1 h-4 w-[1px] bg-divider-regular"}),(0,x.jsxs)("div",{className:"ml-0.5 w-0 grow",children:[t===t6.VarType.variable&&(0,x.jsxs)(ez.PortalToFollowElem,{open:u,onOpenChange:p,placement:"bottom-start",offset:{mainAxis:2,crossAxis:0},children:[(0,x.jsxs)(ez.PortalToFollowElemTrigger,{className:"w-full",onClick:()=>p(e=>!e),children:[r&&(0,x.jsx)(lE.default,{valueSelector:(0,lS.variableTransformer)(r),varType:eb.VarType.number,isShort:n}),!r&&(0,x.jsxs)("div",{className:"flex h-6 items-center p-1 text-[13px] text-components-input-text-placeholder",children:[(0,x.jsx)(r_.Variable02,{className:"mr-1 h-4 w-4 shrink-0"}),(0,x.jsx)("div",{className:"w-0 grow truncate",children:i("nodes.ifElse.selectVariable",{ns:"workflow"})})]})]}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[1000]",children:(0,x.jsx)("div",{className:(0,T.cn)("w-[296px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg-blur pt-1 shadow-lg",n&&"w-[200px]"),children:(0,x.jsx)(aR.default,{vars:l,onChange:f})})})]}),t===t6.VarType.constant&&(0,x.jsxs)("div",{className:" relative",children:[(0,x.jsx)("input",{className:(0,T.cn)("block w-full appearance-none bg-transparent px-2 text-[13px] text-components-input-text-filled outline-none placeholder:text-components-input-text-placeholder",o&&"pr-6"),type:"number",value:r,onChange:e=>s(e.target.value),placeholder:i("nodes.ifElse.enterValue",{ns:"workflow"})||"",onFocus:h,onBlur:g}),!m&&o&&(0,x.jsx)("div",{className:"system-sm-regular absolute right-2 top-[50%] translate-y-[-50%] text-text-tertiary",children:o})]})]})]})});var oJ=e.i(883354);let oX=e=>{let{value:t,onChange:a,disabled:r,availableNodes:s}=e,{t:l}=(0,O.useTranslation)(),n=(0,eN.useStore)(e=>e.controlPromptEditorRerenderKey),o=(0,eN.useStore)(e=>e.pipelineId),i=(0,eN.useStore)(e=>e.setShowInputFieldPanel);return(0,x.jsx)(rS.default,{compact:!0,value:t,placeholder:l("nodes.ifElse.enterValue",{ns:"workflow"})||"",workflowVariableBlock:{show:!0,variables:[],workflowNodesMap:s.reduce((e,t)=>(e[t.id]={title:t.data.title,type:t.data.type},t.data.type===eb.BlockEnum.Start&&(e.sys={title:l("blocks.start",{ns:"workflow"}),type:eb.BlockEnum.Start}),e),{}),showManageInputField:!!o,onManageInputField:()=>i?.(!0)},onChange:a,editable:!r},n)},oQ="nodes.ifElse",oY=e=>{let{className:t,disabled:a,varType:r,file:s,value:l,onSelect:n}=e,{t:o}=(0,O.useTranslation)(),[i,d]=(0,y.useState)(!1),c=(0,y.useMemo)(()=>(0,oJ.getOperators)(r,s).map(e=>({label:(0,oJ.isComparisonOperatorNeedTranslate)(e)?o(`${oQ}.comparisonOperator.${e}`,{ns:"workflow"}):e,value:e})),[o,r,s]),u=c.find(e=>Array.isArray(l)?e.value===l[0]:e.value===l);return(0,x.jsxs)(ez.PortalToFollowElem,{open:i,onOpenChange:d,placement:"bottom-end",offset:{mainAxis:4,crossAxis:0},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>d(e=>!e),children:(0,x.jsxs)(es.default,{className:(0,T.cn)("shrink-0",!u&&"opacity-50",t),size:"small",variant:"ghost",disabled:a,children:[u?u.label:o(`${oQ}.select`,{ns:"workflow"}),(0,x.jsx)(M.RiArrowDownSLine,{className:"ml-1 h-3.5 w-3.5"})]})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-10",children:(0,x.jsx)("div",{className:"rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur p-1 shadow-lg",children:c.map(e=>(0,x.jsx)("div",{className:"flex h-7 cursor-pointer items-center rounded-lg px-3 py-1.5 text-[13px] font-medium text-text-secondary hover:bg-state-base-hover",onClick:()=>{n(e.value),d(!1)},children:e.label},e.value))})})]})},oZ=e=>{let{open:t,onOpenChange:a,valueSelector:r,varType:s,availableNodes:l,nodesOutputVars:n,onChange:o}=e;return(0,x.jsxs)(ez.PortalToFollowElem,{open:t,onOpenChange:a,placement:"bottom-start",offset:{mainAxis:4,crossAxis:0},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>a(!t),children:(0,x.jsx)("div",{className:"cursor-pointer",children:(0,x.jsx)(lE.default,{valueSelector:r,varType:s,availableNodes:l,isShort:!0})})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[1000]",children:(0,x.jsx)("div",{className:"w-[296px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow-lg",children:(0,x.jsx)(aR.default,{vars:n,isSupportFileVar:!0,onChange:o})})})]})},o0="nodes.ifElse.optionName",o1=e=>{let{className:t,disabled:a,conditionId:r,condition:s,file:l,isSubVariableKey:n,isValueFieldShort:o,onRemoveCondition:i,onUpdateCondition:d,onAddSubVariableCondition:c,onRemoveSubVariableCondition:u,onUpdateSubVariableCondition:p,onToggleSubVariableConditionLogicalOperator:m,nodeId:h,availableNodes:g,numberVariables:b,availableVars:v}=e,{t:w}=(0,O.useTranslation)(),[j,k]=(0,y.useState)(!1),[N,C]=(0,y.useState)(!1),_=(0,y.useCallback)(e=>{n?p?.(r,s.id,e):d?.(s.id,e)},[s,r,n,d,p]),S=(0,y.useMemo)(()=>!a&&(!n||!!s.key),[s.key,a,n]),E=(0,y.useCallback)(e=>{_({...s,comparison_operator:e})},[s,_]),V=(0,y.useCallback)(e=>{_({...s,numberVarType:e,value:""})},[s,_]),I=s.varType===eb.VarType.arrayFile&&[oU.ComparisonOperator.contains,oU.ComparisonOperator.notContains,oU.ComparisonOperator.allOf].includes(s.comparison_operator),R=(0,y.useMemo)(()=>l||(n?{key:s.key}:void 0),[s.key,l,n]),A=R?.key==="transfer_method"||R?.key==="type",P=(0,y.useCallback)(e=>{e===s.value||A&&e===s.value?.[0]||_({...s,value:A?[e]:e})},[s,_,A]),L=s.comparison_operator&&[oU.ComparisonOperator.in,oU.ComparisonOperator.notIn].includes(s.comparison_operator),F=(0,y.useMemo)(()=>{if(L){if(R?.key==="type"||s.comparison_operator===oU.ComparisonOperator.allOf)return tS.FILE_TYPE_OPTIONS.map(e=>({name:w(`${o0}.${e.i18nKey}`,{ns:"workflow"}),value:e.value}));if(R?.key==="transfer_method")return tS.TRANSFER_METHOD.map(e=>({name:w(`${o0}.${e.i18nKey}`,{ns:"workflow"}),value:e.value}))}return[]},[s.comparison_operator,R?.key,L,w]),B=L||I,D=tS.SUB_VARIABLES.map(e=>({name:e,value:e})),$=(0,y.useCallback)(e=>{let t=(0,f.produce)(s,t=>{t.key=e,"size"===e?t.varType=eb.VarType.number:t.varType=eb.VarType.string,t.value="",t.comparison_operator=(0,oJ.getOperators)(void 0,{key:e})[0]});p?.(r,s.id,t)},[s,r,p]),z=(0,y.useCallback)(()=>{n?u?.(r,s.id):i?.(s.id)},[s,r,n,i,u]),H=(0,y.useCallback)((e,t)=>{_((0,f.produce)(s,a=>{a.variable_selector=e,a.varType=t.type,a.value="",a.comparison_operator=(0,oJ.getOperators)(t.type)[0],delete a.key,delete a.sub_variable_condition,delete a.numberVarType})),C(!1)},[s,_]);return(0,x.jsxs)("div",{className:(0,T.cn)("mb-1 flex last-of-type:mb-0",t),children:[(0,x.jsxs)("div",{className:(0,T.cn)("grow rounded-lg bg-components-input-bg-normal",j&&"bg-state-destructive-hover"),children:[(0,x.jsxs)("div",{className:"flex items-center p-1",children:[(0,x.jsx)("div",{className:"w-0 grow",children:n?(0,x.jsx)(la.SimpleSelect,{wrapperClassName:"h-6",className:"pl-0 text-xs",optionWrapClassName:"w-[165px] max-h-none",defaultValue:s.key,items:D,onSelect:e=>$(e.value),renderTrigger:e=>e?(0,x.jsx)("div",{className:"flex cursor-pointer justify-start",children:(0,x.jsxs)("div",{className:"inline-flex h-6 max-w-full items-center rounded-md border-[0.5px] border-components-panel-border-subtle bg-components-badge-white-to-dark px-1.5 text-text-accent shadow-xs",children:[(0,x.jsx)(r_.Variable02,{className:"h-3.5 w-3.5 shrink-0 text-text-accent"}),(0,x.jsx)("div",{className:"system-xs-medium ml-0.5 truncate",children:e?.name})]})}):(0,x.jsx)("div",{className:"system-sm-regular text-left text-components-input-text-placeholder",children:w("placeholder.select",{ns:"common"})}),hideChecked:!0}):(0,x.jsx)(oZ,{open:N,onOpenChange:C,valueSelector:s.variable_selector||[],varType:s.varType,availableNodes:g,nodesOutputVars:v,onChange:H})}),(0,x.jsx)("div",{className:"mx-1 h-3 w-[1px] bg-divider-regular"}),(0,x.jsx)(oY,{disabled:!S,varType:s.varType,value:s.comparison_operator,onSelect:E,file:R})]}),!(0,oJ.comparisonOperatorNotRequireValue)(s.comparison_operator)&&!B&&s.varType!==eb.VarType.number&&s.varType!==eb.VarType.boolean&&(0,x.jsx)("div",{className:"max-h-[100px] overflow-y-auto border-t border-t-divider-subtle px-2 py-1",children:(0,x.jsx)(oX,{disabled:a,value:s.value,onChange:P,availableNodes:g})}),!(0,oJ.comparisonOperatorNotRequireValue)(s.comparison_operator)&&s.varType===eb.VarType.boolean&&(0,x.jsx)("div",{className:"p-1",children:(0,x.jsx)(sr.default,{value:s.value,onChange:P})}),!(0,oJ.comparisonOperatorNotRequireValue)(s.comparison_operator)&&!B&&s.varType===eb.VarType.number&&(0,x.jsx)("div",{className:"border-t border-t-divider-subtle px-2 py-1 pt-[3px]",children:(0,x.jsx)(oG,{numberVarType:s.numberVarType,onNumberVarTypeChange:V,value:s.value,onValueChange:P,variables:b,isShort:o,unit:R?.key==="size"?"Byte":void 0})}),!(0,oJ.comparisonOperatorNotRequireValue)(s.comparison_operator)&&L&&(0,x.jsx)("div",{className:"border-t border-t-divider-subtle",children:(0,x.jsx)(la.SimpleSelect,{wrapperClassName:"h-8",className:"rounded-t-none px-2 text-xs",defaultValue:A?s.value?.[0]:s.value,items:F,onSelect:e=>P(e.value),hideChecked:!0,notClearable:!0})}),!(0,oJ.comparisonOperatorNotRequireValue)(s.comparison_operator)&&I&&(0,x.jsx)("div",{className:"p-1",children:(0,x.jsx)(o5,{isSubVariable:!0,conditions:s.sub_variable_condition?.conditions||[],logicalOperator:s.sub_variable_condition?.logical_operator,conditionId:r,readOnly:!!a,handleAddSubVariableCondition:c,handleRemoveSubVariableCondition:u,handleUpdateSubVariableCondition:p,handleToggleSubVariableConditionLogicalOperator:m,nodeId:h,availableNodes:g,availableVars:v})})]}),(0,x.jsx)("div",{className:"ml-1 mt-1 flex h-6 w-6 shrink-0 cursor-pointer items-center justify-center rounded-lg text-text-tertiary hover:bg-state-destructive-hover hover:text-text-destructive",onMouseEnter:()=>k(!0),onMouseLeave:()=>k(!1),onClick:z,children:(0,x.jsx)(M.RiDeleteBinLine,{className:"h-4 w-4"})})]})},o2=e=>{let{isSubVariable:t,disabled:a,conditionId:r,conditions:s,logicalOperator:l,onUpdateCondition:n,onRemoveCondition:o,onToggleConditionLogicalOperator:i,onAddSubVariableCondition:d,onRemoveSubVariableCondition:c,onUpdateSubVariableCondition:u,onToggleSubVariableConditionLogicalOperator:p,nodeId:m,availableNodes:h,numberVariables:g,availableVars:f}=e,b=(0,y.useCallback)(e=>{t&&e?p?.(e):i?.()},[t,i,p]),v=(0,y.useMemo)(()=>!!t&&!!(s.length>1),[s.length,t]),w=(0,y.useMemo)(()=>!t||s.length<2?"":l===oU.LogicalOperator.and?"pl-[51px]":"pl-[42px]",[s.length,t,l]);return(0,x.jsxs)("div",{className:(0,T.cn)("relative",s.length>1&&!t&&"pl-[60px]"),children:[s.length>1&&(0,x.jsxs)("div",{className:(0,T.cn)("absolute bottom-0 left-0 top-0 w-[60px]",t&&l===oU.LogicalOperator.and&&"left-[-10px]",t&&l===oU.LogicalOperator.or&&"left-[-18px]"),children:[(0,x.jsx)("div",{className:"absolute bottom-4 left-[46px] top-4 w-2.5 rounded-l-[8px] border border-r-0 border-divider-deep"}),(0,x.jsx)("div",{className:"absolute right-0 top-1/2 h-[29px] w-4 -translate-y-1/2 bg-components-panel-bg"}),(0,x.jsxs)("div",{className:"absolute right-1 top-1/2 flex h-[21px] -translate-y-1/2 cursor-pointer select-none items-center rounded-md border-[0.5px] border-components-button-secondary-border bg-components-button-secondary-bg px-1 text-[10px] font-semibold text-text-accent-secondary shadow-xs",onClick:()=>b(r),children:[!!l&&l.toUpperCase(),(0,x.jsx)(M.RiLoopLeftLine,{className:"ml-0.5 h-3 w-3"})]})]}),s.map(e=>(0,x.jsx)(o1,{className:w,disabled:a,conditionId:t?r:e.id,condition:e,isValueFieldShort:v,onUpdateCondition:n,onRemoveCondition:o,onAddSubVariableCondition:d,onRemoveSubVariableCondition:c,onUpdateSubVariableCondition:u,onToggleSubVariableConditionLogicalOperator:p,nodeId:m,availableNodes:h,numberVariables:g,isSubVariableKey:t,availableVars:f},e.id))]})},o5=y.memo(e=>{let{isSubVariable:t,conditionId:a,conditions:r,logicalOperator:s,nodeId:l="",readOnly:n,handleUpdateCondition:o,handleAddCondition:i,handleRemoveCondition:d,handleToggleConditionLogicalOperator:c,handleAddSubVariableCondition:u,handleRemoveSubVariableCondition:p,handleUpdateSubVariableCondition:m,handleToggleSubVariableConditionLogicalOperator:h,availableNodes:g=[],availableVars:f=[]}=e,{t:b}=(0,O.useTranslation)(),v=aV(),w=(0,y.useCallback)(e=>e.type===eb.VarType.number,[]),j=tS.SUB_VARIABLES.map(e=>({name:e,value:e}));return r?(0,x.jsx)(x.Fragment,{children:(0,x.jsx)("div",{children:(0,x.jsxs)("div",{className:(0,T.cn)("group relative rounded-[10px] bg-components-panel-bg",!t&&"min-h-[40px] px-3 py-1 ",t&&"px-1 py-2"),children:[r&&!!r.length&&(0,x.jsx)("div",{className:"mb-2",children:(0,x.jsx)(o2,{disabled:n,conditionId:a,conditions:r,logicalOperator:s,onUpdateCondition:o,onRemoveCondition:d,onToggleConditionLogicalOperator:c,nodeId:l,availableNodes:g,numberVariables:v(l,"",w),onAddSubVariableCondition:u,onRemoveSubVariableCondition:p,onUpdateSubVariableCondition:m,onToggleSubVariableConditionLogicalOperator:h,isSubVariable:t,availableVars:f})}),(0,x.jsx)("div",{className:(0,T.cn)("flex items-center justify-between pr-[30px]",!r.length&&!t&&"mt-1",!r.length&&t&&"mt-2",r.length>1&&!t&&"ml-[60px]"),children:t?(0,x.jsx)(la.PortalSelect,{popupInnerClassName:"w-[165px] max-h-none",onSelect:e=>u?.(a,e.value),items:j,value:"",renderTrigger:()=>(0,x.jsxs)(es.default,{size:"small",disabled:n,children:[(0,x.jsx)(M.RiAddLine,{className:"mr-1 h-3.5 w-3.5"}),b("nodes.ifElse.addSubVariable",{ns:"workflow"})]}),hideChecked:!0}):(0,x.jsx)(oq,{disabled:n,variables:f,onSelectVariable:i})})]})})}):(0,x.jsx)("div",{})}),o3=()=>{let{t:e}=(0,O.useTranslation)();return(0,x.jsx)("div",{className:"system-xs-regular flex h-10 items-center justify-center rounded-[10px] bg-background-section text-text-tertiary",children:e("nodes.loop.setLoopVariables",{ns:"workflow"})})};var o4=e.i(992046),o6=e.i(269345);let o8=e=>{let{nodeId:t,item:a,onChange:r}=e,{t:s}=(0,O.useTranslation)(),{value_type:l,var_type:n,value:o}=a,i=(0,y.useCallback)(e=>{r(e.target.value)},[r]),d=(0,y.useCallback)(e=>{r(e)},[r]),c=(0,y.useCallback)(e=>e.type===n,[n]),u=(0,y.useMemo)(()=>n===eb.VarType.arrayObject?"240px":"120px",[n]),p=(0,y.useMemo)(()=>n===eb.VarType.arrayString?o6.arrayStringPlaceholder:n===eb.VarType.arrayNumber?o6.arrayNumberPlaceholder:n===eb.VarType.arrayObject?o6.arrayObjectPlaceholder:n===eb.VarType.arrayBoolean?o6.arrayBoolPlaceholder:o6.objectPlaceholder,[n]);return(0,x.jsxs)("div",{children:[l===eb.ValueType.variable&&(0,x.jsx)(sa.default,{readonly:!1,nodeId:t,isShowNodeName:!0,value:o,onChange:d,filterVar:c,placeholder:s("nodes.assigner.setParameter",{ns:"workflow"})}),l===eb.ValueType.constant&&n===eb.VarType.string&&(0,x.jsx)(se.default,{value:o,onChange:i,className:"min-h-12 w-full"}),l===eb.ValueType.constant&&n===eb.VarType.number&&(0,x.jsx)(eF.default,{type:"number",value:o,onChange:i,className:"w-full"}),l===eb.ValueType.constant&&n===eb.VarType.boolean&&(0,x.jsx)(sr.default,{value:o,onChange:d}),l===eb.ValueType.constant&&(n===eb.VarType.object||n===eb.VarType.arrayString||n===eb.VarType.arrayNumber||n===eb.VarType.arrayObject)&&(0,x.jsx)("div",{className:"w-full rounded-[10px] bg-components-input-bg-normal py-2 pl-3 pr-1",style:{height:u},children:(0,x.jsx)(eB.default,{value:o,isExpand:!0,noWrapper:!0,language:eD.CodeLanguage.json,onChange:d,className:"w-full",placeholder:(0,x.jsx)("div",{className:"whitespace-pre",children:p})})}),l===eb.ValueType.constant&&n===eb.VarType.arrayBoolean&&(0,x.jsx)(o4.default,{className:"mt-2",list:o||[!1],onChange:d})]})};var o9=e.i(306101);let o7=e=>{let{value:t,onChange:a}=e,{t:r}=(0,O.useTranslation)();return(0,x.jsx)(o9.default,{options:[{label:"Variable",value:"variable"},{label:"Constant",value:"constant"}],value:t,onChange:a,popupProps:{title:r("nodes.loop.inputMode",{ns:"workflow"}),className:"w-[132px]"}})},ie=e=>{let{value:t,onChange:a}=e,r=[{label:"String",value:eb.VarType.string},{label:"Number",value:eb.VarType.number},{label:"Object",value:eb.VarType.object},{label:"Boolean",value:eb.VarType.boolean},{label:"Array[string]",value:eb.VarType.arrayString},{label:"Array[number]",value:eb.VarType.arrayNumber},{label:"Array[object]",value:eb.VarType.arrayObject},{label:"Array[boolean]",value:eb.VarType.arrayBoolean}];return(0,x.jsx)(o9.default,{options:r,value:t,onChange:a,popupProps:{className:"w-[132px]"}})},it=e=>{let{nodeId:t,item:a,handleRemoveLoopVariable:r,handleUpdateLoopVariable:s}=e,{t:l}=(0,O.useTranslation)(),n=e=>{let{isValid:t,errorMessageKey:a}=(0,sm.checkKeys)([e],!1);return!!t||(eR.default.notify({type:"error",message:l(`varKeyError.${a}`,{ns:"appDebug",key:l("env.modal.name",{ns:"workflow"})})}),!1)},o=(0,y.useCallback)(e=>{(0,sm.replaceSpaceWithUnderscoreInVarNameInput)(e.target),(!e.target.value||n(e.target.value))&&s(a.id,{label:e.target.value})},[a.id,s]),i=(0,y.useCallback)((e,t)=>{if(t!==eb.ValueType.variable)switch(e){case eb.VarType.boolean:return!1;case eb.VarType.arrayBoolean:return[!1];default:return}},[]),d=(0,y.useCallback)(e=>{s(a.id,{var_type:e,value:i(e,a.value_type)})},[a.id,s]),c=(0,y.useCallback)(e=>{s(a.id,{value_type:e,value:i(a.var_type,e)})},[a.id,s]),u=(0,y.useCallback)(e=>{s(a.id,{value:e})},[a.id,s]);return(0,x.jsxs)("div",{className:"mb-4 flex last-of-type:mb-0",children:[(0,x.jsxs)("div",{className:"w-0 grow",children:[(0,x.jsxs)("div",{className:"mb-1 grid grid-cols-3 gap-1",children:[(0,x.jsx)(eF.default,{value:a.label,onChange:o,onBlur:e=>n(e.target.value),autoFocus:!a.label,placeholder:l("nodes.loop.variableName",{ns:"workflow"})}),(0,x.jsx)(ie,{value:a.var_type,onChange:d}),(0,x.jsx)(o7,{value:a.value_type,onChange:c})]}),(0,x.jsx)("div",{children:(0,x.jsx)(o8,{nodeId:t,item:a,onChange:u})})]}),(0,x.jsx)(rk.default,{className:"shrink-0",size:"l",onClick:()=>r(a.id),children:(0,x.jsx)(M.RiDeleteBinLine,{className:"h-4 w-4 text-text-tertiary"})})]})},ia=e=>{let{variables:t=[],...a}=e;return t.length?t.map(e=>(0,x.jsx)(it,{item:e,...a},e.id)):(0,x.jsx)(o3,{})},ir="nodes.loop",is=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,childrenNodeVars:n,loopChildrenNodes:o,handleAddCondition:i,handleUpdateCondition:d,handleRemoveCondition:c,handleToggleConditionLogicalOperator:u,handleAddSubVariableCondition:p,handleRemoveSubVariableCondition:m,handleUpdateSubVariableCondition:h,handleToggleSubVariableConditionLogicalOperator:g,handleUpdateLoopCount:b,handleAddLoopVariable:v,handleRemoveLoopVariable:w,handleUpdateLoopVariable:j}=((e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),r=(0,Z.useIsChatMode)(),s=(0,eN.useStore)(e=>e.conversationVariables),{inputs:l,setInputs:n}=(0,tZ.default)(e,t),o=(0,y.useRef)(l),i=(0,y.useCallback)(e=>{o.current=e,n(e)},[n]),d=(0,y.useCallback)(e=>[eb.VarType.array,eb.VarType.arrayString,eb.VarType.arrayNumber,eb.VarType.arrayObject,eb.VarType.arrayFile].includes(e.type),[]),{getLoopNodeChildren:c}=(0,Z.useWorkflow)(),u=[{id:e,data:t},...c(e)],{data:p}=(0,C.useAllBuiltInTools)(),{data:m}=(0,C.useAllCustomTools)(),{data:x}=(0,C.useAllWorkflowTools)(),{data:h}=(0,C.useAllMCPTools)(),g=(0,eN.useStore)(e=>e.dataSourceList),b=(0,ty.toNodeOutputVars)(u,r,void 0,[],s,[],{buildInTools:p||[],customTools:m||[],workflowTools:x||[],mcpTools:h||[],dataSourceList:g||[]}),{getIsVarFileAttribute:v}=(e=>{let{nodeId:t}=e,a=(0,Z.useIsChatMode)(),{getBeforeNodesInSameBranch:r}=(0,Z.useWorkflow)(),s=(0,y.useMemo)(()=>r(t),[r,t]),{getCurrentVariableType:l}=(0,aT.useWorkflowVariables)();return{getIsVarFileAttribute:e=>3===e.length&&l({valueSelector:e.slice(0,2),availableNodes:s,isChatMode:a,isConstant:!1})===eb.VarType.file}})({nodeId:e}),w=(0,y.useCallback)(e=>{i((0,f.produce)(o.current,t=>{t.error_handle_mode=e.value}))},[l,i]),j=(0,y.useCallback)((e,t)=>{i((0,f.produce)(o.current,a=>{a.break_conditions||(a.break_conditions=[]),a.break_conditions?.push({id:(0,sv.v4)(),varType:t.type,variable_selector:e,comparison_operator:(0,oJ.getOperators)(t.type,v(e)?{key:e.slice(-1)[0]}:void 0)[0],value:t.type===eb.VarType.boolean?"false":""})}))},[v,i]),k=(0,y.useCallback)(e=>{i((0,f.produce)(o.current,t=>{t.break_conditions=t.break_conditions?.filter(t=>t.id!==e)}))},[i]),N=(0,y.useCallback)((e,t)=>{i((0,f.produce)(o.current,a=>{let r=a.break_conditions?.find(t=>t.id===e);r&&Object.assign(r,t)}))},[i]),_=(0,y.useCallback)(()=>{i((0,f.produce)(o.current,e=>{e.logical_operator=e.logical_operator===oU.LogicalOperator.and?oU.LogicalOperator.or:oU.LogicalOperator.and}))},[i]),T=(0,y.useCallback)((e,t)=>{i((0,f.produce)(o.current,a=>{let r=a.break_conditions?.find(t=>t.id===e);if(!r)return;r?.sub_variable_condition||(r.sub_variable_condition={logical_operator:oU.LogicalOperator.and,conditions:[]});let s=r.sub_variable_condition;if(s){s.conditions||(s.conditions=[]);let e=(0,oJ.getOperators)(eb.VarType.string,{key:t||""});s.conditions.push({id:(0,sv.v4)(),key:t||"",varType:eb.VarType.string,comparison_operator:e&&e.length?e[0]:void 0,value:""})}}))},[i]),S=(0,y.useCallback)((e,t)=>{i((0,f.produce)(o.current,a=>{let r=a.break_conditions?.find(t=>t.id===e);if(!r||!r?.sub_variable_condition)return;let s=r.sub_variable_condition;s&&(s.conditions=s.conditions.filter(e=>e.id!==t))}))},[i]),E=(0,y.useCallback)((e,t,a)=>{i((0,f.produce)(o.current,r=>{let s=r.break_conditions?.find(t=>t.id===e);if(s&&s.sub_variable_condition){let e=s.sub_variable_condition.conditions.find(e=>e.id===t);e&&Object.assign(e,a)}}))},[i]),V=(0,y.useCallback)(e=>{i((0,f.produce)(o.current,t=>{let a=t.break_conditions?.find(t=>t.id===e);a&&a.sub_variable_condition&&(a.sub_variable_condition.logical_operator=a.sub_variable_condition.logical_operator===oU.LogicalOperator.and?oU.LogicalOperator.or:oU.LogicalOperator.and)}))},[i]),I=(0,y.useCallback)(e=>{i((0,f.produce)(o.current,t=>{t.loop_count=e}))},[i]),R=(0,y.useCallback)(()=>{i((0,f.produce)(o.current,e=>{e.loop_variables||(e.loop_variables=[]),e.loop_variables.push({id:(0,sv.v4)(),label:"",var_type:eb.VarType.string,value_type:eb.ValueType.constant,value:""})}))},[i]);return{readOnly:a,inputs:l,filterInputVar:d,childrenNodeVars:b,loopChildrenNodes:u,handleAddCondition:j,handleRemoveCondition:k,handleUpdateCondition:N,handleToggleConditionLogicalOperator:_,handleAddSubVariableCondition:T,handleUpdateSubVariableCondition:E,handleRemoveSubVariableCondition:S,handleToggleSubVariableConditionLogicalOperator:V,handleUpdateLoopCount:I,changeErrorResponseMode:w,handleAddLoopVariable:R,handleRemoveLoopVariable:(0,y.useCallback)(e=>{i((0,f.produce)(o.current,t=>{t.loop_variables=t.loop_variables?.filter(t=>t.id!==e)}))},[i]),handleUpdateLoopVariable:(0,y.useCallback)((e,t)=>{let a=(o.current.loop_variables||[]).findIndex(t=>t.id===e);i((0,f.produce)(o.current,e=>{a>-1&&(e.loop_variables[a]={...e.loop_variables[a],...t})}))},[i])}})(t,a);return(0,x.jsx)("div",{className:"mt-2",children:(0,x.jsxs)("div",{children:[(0,x.jsx)(rj,{title:(0,x.jsx)("div",{className:"pl-3",children:r("nodes.loop.loopVariables",{ns:"workflow"})}),operations:(0,x.jsx)("div",{className:"mr-4 flex h-5 w-5 cursor-pointer items-center justify-center",onClick:v,children:(0,x.jsx)(M.RiAddLine,{className:"h-4 w-4 text-text-tertiary"})}),children:(0,x.jsx)("div",{className:"px-4",children:(0,x.jsx)(ia,{variables:l.loop_variables,nodeId:t,handleRemoveLoopVariable:w,handleUpdateLoopVariable:j})})}),(0,x.jsx)(er,{className:"my-2"}),(0,x.jsx)(rj,{title:(0,x.jsx)("div",{className:"pl-3",children:r(`${ir}.breakCondition`,{ns:"workflow"})}),tooltip:r(`${ir}.breakConditionTip`,{ns:"workflow"}),children:(0,x.jsx)(o5,{nodeId:t,readOnly:s,handleAddCondition:i,handleRemoveCondition:c,handleUpdateCondition:d,handleToggleConditionLogicalOperator:u,handleAddSubVariableCondition:p,handleRemoveSubVariableCondition:m,handleUpdateSubVariableCondition:h,handleToggleSubVariableConditionLogicalOperator:g,availableNodes:o,availableVars:n,conditions:l.break_conditions||[],logicalOperator:l.logical_operator})}),(0,x.jsx)(er,{className:"mt-2"}),(0,x.jsx)("div",{className:"mt-2",children:(0,x.jsx)(rj,{title:(0,x.jsx)("div",{className:"pl-3",children:r(`${ir}.loopMaxCount`,{ns:"workflow"})}),children:(0,x.jsx)("div",{className:"px-3 py-2",children:(0,x.jsx)(nY.default,{min:1,max:k.LOOP_NODE_MAX_COUNT,value:l.loop_count,onChange:e=>{let t=Math.round(e);b(Number.isNaN(t)?1:t)}})})})})]})})}),il=y.memo(e=>{let{data:t}=e,{provider:a,name:r}=t.model||{},{textGenerationModelList:s}=(0,$.useTextGenerationCurrentProviderAndModelAndModelList)(),l=a&&r;return(0,x.jsx)("div",{className:"mb-1 px-3 py-1",children:l&&(0,x.jsx)(a2.default,{defaultModel:{provider:a,model:r},modelList:s,triggerClassName:"!h-6 !rounded-md",readonly:!0})})});var rq=rq;let io=(0,y.memo)(e=>{let{onImport:t}=e,{t:a}=(0,O.useTranslation)(),r=(0,$.useLanguage)(),{data:s}=(0,C.useAllBuiltInTools)(),{data:l}=(0,C.useAllCustomTools)(),{data:n}=(0,C.useAllWorkflowTools)(),o=(0,y.useCallback)((e,a)=>{var o;if(!a||"datasource_name"in a||!("tool_name"in a))return;let{provider_id:i,provider_type:d,tool_name:c}=a,u=(()=>{switch(d){case e9.CollectionType.builtIn:return s||[];case e9.CollectionType.custom:return l||[];case e9.CollectionType.workflow:return n||[];default:return[]}})().find(e=>(0,eE.canFindTool)(e.id,i)),p=u?.tools.find(e=>e.name===c);t((o=(p?.parameters||[]).filter(e=>"llm"===e.form),o.map(e=>({name:e.name,type:e.type,required:e.required,description:e.llm_description,options:e.options?.map(e=>e.label[r]||e.label.en_US)||[]}))))},[s,l,r,t,n]),i=(0,y.useCallback)(e=>(0,x.jsx)("div",{children:(0,x.jsx)("div",{className:(0,T.cn)("flex h-6 cursor-pointer items-center rounded-md px-2 text-xs font-medium text-text-tertiary hover:bg-state-base-hover",e&&"bg-state-base-hover"),children:a("nodes.parameterExtractor.importFromTool",{ns:"workflow"})})}),[a]);return(0,x.jsx)(eZ.default,{placement:"bottom-end",offset:{mainAxis:4,crossAxis:52},trigger:i,onSelect:o,noBlocks:!0})}),ii=y.memo(e=>{let{payload:t,onEdit:a,onDelete:r}=e,{t:s}=(0,O.useTranslation)();return(0,x.jsxs)("div",{className:"group relative rounded-lg bg-components-input-bg-normal px-2.5 py-2 hover:shadow-xs",children:[(0,x.jsxs)("div",{className:"flex justify-between",children:[(0,x.jsxs)("div",{className:"flex items-center",children:[(0,x.jsx)(r_.Variable02,{className:"h-3.5 w-3.5 text-text-accent-secondary"}),(0,x.jsx)("div",{className:"ml-1 text-[13px] font-medium text-text-primary",children:t.name}),(0,x.jsx)("div",{className:"ml-2 text-xs font-normal capitalize text-text-tertiary",children:t.type})]}),t.required&&(0,x.jsx)("div",{className:"text-xs font-normal uppercase leading-4 text-text-tertiary",children:s("nodes.parameterExtractor.addExtractParameterContent.required",{ns:"workflow"})})]}),(0,x.jsx)("div",{className:"mt-0.5 text-xs font-normal leading-[18px] text-text-tertiary",children:t.description}),(0,x.jsxs)("div",{className:"absolute right-0 top-0 hidden h-full w-[119px] items-center justify-end space-x-1 rounded-lg bg-gradient-to-l from-components-panel-on-panel-item-bg to-background-gradient-mask-transparent pr-1 group-hover:flex",children:[(0,x.jsx)("div",{className:"cursor-pointer rounded-md p-1 hover:bg-state-base-hover",onClick:a,children:(0,x.jsx)(M.RiEditLine,{className:"h-4 w-4 text-text-tertiary"})}),(0,x.jsx)("div",{className:"group shrink-0 cursor-pointer rounded-md p-1 hover:!bg-state-destructive-hover",onClick:r,children:(0,x.jsx)(M.RiDeleteBinLine,{className:"h-4 w-4 text-text-tertiary group-hover:text-text-destructive"})})]})]})});var id=e.i(501371),ic=e.i(203956),iu=e.i(721954);let ip="nodes.parameterExtractor",im="errorMsg",ix={name:"",type:iu.ParamType.string,description:"",required:!1},ih=[iu.ParamType.string,iu.ParamType.number,iu.ParamType.bool,iu.ParamType.arrayString,iu.ParamType.arrayNumber,iu.ParamType.arrayObject,iu.ParamType.arrayBool],ig=y.memo(e=>{let{type:t,payload:a,onSave:r,onCancel:s}=e,{t:l}=(0,O.useTranslation)(),n="add"===t,[o,i]=(0,y.useState)(n?ix:a),[d,c]=(0,y.useState)(void 0),u=(0,y.useCallback)(e=>t=>{if("name"===e){let{isValid:e,errorKey:a,errorMessageKey:r}=(0,sm.checkKeys)([t],!0);if(!e)return void eR.default.notify({type:"error",message:l(`varKeyError.${r}`,{ns:"appDebug",key:a})})}c("name"===e?{type:eb.ChangeType.changeVarName,payload:{beforeKey:o.name,afterKey:t}}:void 0),i(a=>({...a,[e]:t}))},[o.name,l]),[p,{setTrue:m,setFalse:h}]=(0,an.useBoolean)(!n),g=(0,y.useCallback)(()=>{h(),s?.()},[s,h]),f=(0,y.useCallback)(()=>{n&&i(ix),m()},[n,m]),b=(0,y.useCallback)(()=>{let e="";return o.name||(e=l(`${im}.fieldRequired`,{ns:"workflow",field:l(`${ip}.addExtractParameterContent.name`,{ns:"workflow"})})),e||o.type!==iu.ParamType.select||o.options&&0!==o.options.length||(e=l(`${im}.fieldRequired`,{ns:"workflow",field:l("variableConfig.options",{ns:"appDebug"})})),e||o.description||(e=l(`${im}.fieldRequired`,{ns:"workflow",field:l(`${ip}.addExtractParameterContent.description`,{ns:"workflow"})})),!e||(eR.default.notify({type:"error",message:e}),!1)},[o,l]),v=(0,y.useCallback)(()=>{b()&&(r(o,d),g())},[b,r,o,g,d]);return(0,x.jsxs)("div",{children:[n&&(0,x.jsx)(eM.default,{className:"mx-1",onClick:f}),p&&(0,x.jsx)(s5.default,{title:l(`${ip}.addExtractParameter`,{ns:"workflow"}),isShow:!0,onClose:g,className:"!w-[400px] !max-w-[400px] !p-4",children:(0,x.jsxs)("div",{children:[(0,x.jsxs)("div",{className:"space-y-2",children:[(0,x.jsx)(id.default,{title:l(`${ip}.addExtractParameterContent.name`,{ns:"workflow"}),children:(0,x.jsx)(eF.default,{value:o.name,onChange:e=>u("name")(e.target.value),placeholder:l(`${ip}.addExtractParameterContent.namePlaceholder`,{ns:"workflow"})})}),(0,x.jsx)(id.default,{title:l(`${ip}.addExtractParameterContent.type`,{ns:"workflow"}),children:(0,x.jsx)(la.default,{defaultValue:o.type,allowSearch:!1,onSelect:e=>u("type")(e.value),optionClassName:"capitalize",items:ih.map(e=>({value:e,name:e}))})}),o.type===iu.ParamType.select&&(0,x.jsx)(id.default,{title:l("variableConfig.options",{ns:"appDebug"}),children:(0,x.jsx)(ic.default,{options:o.options||[],onChange:u("options")})}),(0,x.jsx)(id.default,{title:l(`${ip}.addExtractParameterContent.description`,{ns:"workflow"}),children:(0,x.jsx)(se.default,{value:o.description,onChange:e=>u("description")(e.target.value),placeholder:l(`${ip}.addExtractParameterContent.descriptionPlaceholder`,{ns:"workflow"})})}),(0,x.jsx)(id.default,{title:l(`${ip}.addExtractParameterContent.required`,{ns:"workflow"}),children:(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"mb-1.5 text-xs font-normal leading-[18px] text-text-tertiary",children:l(`${ip}.addExtractParameterContent.requiredContent`,{ns:"workflow"})}),(0,x.jsx)(ts.default,{size:"l",defaultValue:o.required,onChange:u("required")})]})})]}),(0,x.jsxs)("div",{className:"mt-4 flex justify-end space-x-2",children:[(0,x.jsx)(es.default,{className:"!w-[95px]",onClick:g,children:l("operation.cancel",{ns:"common"})}),(0,x.jsx)(es.default,{className:"!w-[95px]",variant:"primary",onClick:v,children:n?l("operation.add",{ns:"common"}):l("operation.save",{ns:"common"})})]})]})})]})}),ib=y.memo(e=>{let{list:t,onChange:a}=e,{t:r}=(0,O.useTranslation)(),[s,{setTrue:l,setFalse:n}]=(0,an.useBoolean)(!1),o=(0,y.useCallback)(e=>(r,s)=>{a(t.map((t,a)=>a===e?r:t),s),n()},[n,t,a]),[i,d]=(0,y.useState)(-1),c=(0,y.useCallback)(e=>()=>{d(e),l()},[l]),u=(0,y.useCallback)(e=>()=>{a(t.filter((t,a)=>a!==e))},[t,a]);return 0===t.length?(0,x.jsx)(st,{children:r("nodes.parameterExtractor.extractParametersNotSet",{ns:"workflow"})}):(0,x.jsxs)("div",{className:"space-y-1",children:[t.map((e,t)=>(0,x.jsx)(ii,{payload:e,onDelete:u(t),onEdit:c(t)},t)),s&&(0,x.jsx)(ig,{type:"edit",payload:t[i],onSave:o(i),onCancel:n})]})}),iy="nodes.parameterExtractor",iv=y.memo(e=>{let{type:t,onChange:a}=e,{t:r}=(0,O.useTranslation)(),s=(0,y.useCallback)(e=>()=>{a(e)},[a]);return(0,x.jsx)(rj,{title:r(`${iy}.reasoningMode`,{ns:"workflow"}),tooltip:r(`${iy}.reasoningModeTip`,{ns:"workflow"}),children:(0,x.jsxs)("div",{className:"grid grid-cols-2 gap-x-1",children:[(0,x.jsx)(nK.default,{title:"Function/Tool Calling",onSelect:s(iu.ReasoningModeType.functionCall),selected:t===iu.ReasoningModeType.functionCall}),(0,x.jsx)(nK.default,{title:"Prompt",selected:t===iu.ReasoningModeType.prompt,onSelect:s(iu.ReasoningModeType.prompt)})]})})});var iw=e.i(896071);let ij="nodes.parameterExtractor",ik=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,handleInputVarChange:n,filterVar:o,isChatModel:i,isChatMode:d,isCompletionModel:c,handleModelChanged:u,handleImportFromTool:p,handleCompletionParamsChange:m,addExtractParameter:h,handleExactParamsChange:g,handleInstructionChange:b,hasSetBlockStatus:v,handleMemoryChange:w,isSupportFunctionCall:j,handleReasoningModeChange:k,availableVars:N,availableNodesWithParent:C,isVisionModel:_,handleVisionResolutionChange:T,handleVisionResolutionEnabledChange:S}=((e,t)=>{let{deleteNodeInspectorVars:a,renameInspectVarName:r}=(0,ea.default)(),{nodesReadOnly:s}=(0,Z.useNodesReadOnly)(),{handleOutVarRenameChange:l}=(0,Z.useWorkflow)(),n=(0,Z.useIsChatMode)(),o=(0,eN.useStore)(e=>e.nodesDefaultConfigs)?.[t.type],[i,d]=(0,y.useState)({user:"",assistant:""}),{inputs:c,setInputs:u}=(0,tZ.default)(e,t),p=(0,y.useRef)(c),m=(0,y.useCallback)(e=>{if(e.memory&&!e.memory.role_prefix){let t=(0,f.produce)(e,e=>{e.memory.role_prefix=i});u(t),p.current=t;return}u(e),p.current=e},[u,i]),x=(0,y.useCallback)(e=>[eb.VarType.string].includes(e.type),[]),h=(0,y.useCallback)(e=>{m((0,f.produce)(c,t=>{t.query=e||[]}))},[c,m]),g=(0,y.useCallback)((t,s)=>{m((0,f.produce)(c,e=>{e.parameters=t})),s&&s?.type===eb.ChangeType.changeVarName&&s.payload?(l(e,[e,s.payload.beforeKey],[e,s.payload.afterKey]),r(e,s.payload.beforeKey,s.payload.afterKey)):a(e)},[a,l,e,c,r,m]),b=(0,y.useCallback)(t=>{m((0,f.produce)(c,e=>{e.parameters||(e.parameters=[]),e.parameters.push(t)})),a(e)},[a,e,c,m]),v=c.model||{provider:"",name:"",mode:eg.AppModeEnum.CHAT,completion_params:{temperature:.7}},w=c.model?.mode===eg.AppModeEnum.CHAT,j=!w,{isVisionModel:k,handleVisionResolutionEnabledChange:N,handleVisionResolutionChange:C,handleModelChanged:_}=as(v,{payload:c.vision,onChange:e=>{m((0,f.produce)(c,t=>{t.vision=e}))}}),T=(0,y.useCallback)((e,t,a)=>{let r=t.prompt_templates;w||d({user:r.completion_model.conversation_histories_role.user_prefix,assistant:r.completion_model.conversation_histories_role.assistant_prefix})},[w]),[S,E]=(0,y.useState)(!1),{currentProvider:V,currentModel:I}=(0,$.useModelListAndDefaultModelAndCurrentProviderAndModel)(t0.ModelTypeEnum.textGeneration),R=(0,y.useCallback)(e=>{m((0,f.produce)(p.current,t=>{t.model.provider=e.provider,t.model.name=e.modelId,t.model.mode=e.mode,e.mode!==p.current.model?.mode&&o&&Object.keys(o).length>0&&T(t,o,e.mode===eg.AppModeEnum.CHAT)})),E(!0)},[m,o,T]);(0,y.useEffect)(()=>{V?.provider&&I?.model&&!v.provider&&R({provider:V?.provider,modelId:I?.model,mode:I?.model_properties?.mode})},[v?.provider,V,I,R]),(0,y.useEffect)(()=>{S&&(E(!1),_())},[k,S]);let{currentModel:M}=(0,$.useTextGenerationCurrentProviderAndModelAndModelList)({provider:v.provider,model:v.name}),A=(0,iw.supportFunctionCall)(M?.features),O=(0,y.useCallback)(e=>[eb.VarType.number,eb.VarType.string].includes(e.type),[]),{availableVars:P,availableNodesWithParent:L}=(0,t3.default)(e,{onlyLeafNodeVar:!1,filterVar:O}),F=(0,y.useCallback)(e=>{m((0,f.produce)(c,t=>{t.model.completion_params=e}))},[c,m]),B=(0,y.useCallback)(e=>{m((0,f.produce)(c,t=>{t.instruction=e}))},[c,m]),D={history:!1,query:!!n&&(0,tb.checkHasQueryBlock)(c.instruction),context:!1},z=(0,y.useCallback)(e=>{m((0,f.produce)(c,t=>{t.memory=e}))},[c,m]),H=(0,y.useCallback)(e=>{m((0,f.produce)(c,t=>{t.reasoning_mode=e}))},[c,m]),W=(0,y.useCallback)(e=>{m((0,f.produce)(c,t=>{t.parameters=e}))},[c,m]);return{readOnly:s,handleInputVarChange:h,filterVar:x,isChatMode:n,inputs:c,isChatModel:w,isCompletionModel:j,handleModelChanged:R,handleCompletionParamsChange:F,handleImportFromTool:W,handleExactParamsChange:g,addExtractParameter:b,handleInstructionChange:B,hasSetBlockStatus:D,availableVars:P,availableNodesWithParent:L,isSupportFunctionCall:A,handleReasoningModeChange:H,handleMemoryChange:z,isVisionModel:k,handleVisionResolutionEnabledChange:N,handleVisionResolutionChange:C}})(t,a),E=l.model;return(0,x.jsxs)("div",{className:"pt-2",children:[(0,x.jsxs)("div",{className:"space-y-4 px-4",children:[(0,x.jsx)(rj,{title:r("common.model",{ns:"workflow"}),required:!0,children:(0,x.jsx)(n4.default,{popupClassName:"!w-[387px]",isInWorkflow:!0,isAdvancedMode:!0,provider:E?.provider,completionParams:E?.completion_params,modelId:E?.name,setModel:u,onCompletionParamsChange:m,hideDebugWithMultipleModel:!0,debugWithMultipleModel:!1,readonly:s})}),(0,x.jsx)(rj,{title:r(`${ij}.inputVar`,{ns:"workflow"}),required:!0,children:(0,x.jsx)(x.Fragment,{children:(0,x.jsx)(sa.default,{readonly:s,nodeId:t,isShowNodeName:!0,value:l.query||[],onChange:n,filterVar:o})})}),(0,x.jsx)(er,{}),(0,x.jsx)(n7,{nodeId:t,readOnly:s,isVisionModel:_,enabled:l.vision?.enabled,onEnabledChange:S,config:l.vision?.configs,onConfigChange:T}),(0,x.jsx)(rj,{title:r(`${ij}.extractParameters`,{ns:"workflow"}),required:!0,operations:s?void 0:(0,x.jsxs)("div",{className:"flex items-center space-x-1",children:[!s&&(0,x.jsx)(io,{onImport:p}),!s&&(0,x.jsx)("div",{className:"h-3 w-px bg-divider-regular"}),(0,x.jsx)(ig,{type:"add",onSave:h})]}),children:(0,x.jsx)(ib,{readonly:s,list:l.parameters||[],onChange:g})}),(0,x.jsx)(rF,{title:(0,x.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,x.jsx)("span",{className:"uppercase",children:r(`${ij}.instruction`,{ns:"workflow"})}),(0,x.jsx)(B.default,{popupContent:(0,x.jsx)("div",{className:"w-[120px]",children:r(`${ij}.instructionTip`,{ns:"workflow"})}),triggerClassName:"w-3.5 h-3.5 ml-0.5"})]}),value:l.instruction,onChange:b,readOnly:s,isChatModel:i,isChatApp:d,isShowContext:!1,hasSetBlockStatus:v,nodesOutputVars:N,availableNodes:C})]}),(0,x.jsx)(rq.default,{title:r(`${ij}.advancedSetting`,{ns:"workflow"}),children:(0,x.jsxs)(x.Fragment,{children:[d&&(0,x.jsx)("div",{className:"mt-4",children:(0,x.jsx)(rW,{readonly:s,config:{data:l.memory},onChange:w,canSetRoleName:c})}),j&&(0,x.jsx)("div",{className:"mt-2",children:(0,x.jsx)(iv,{type:l.reasoning_mode,onChange:k})})]})}),l.parameters?.length>0&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(er,{}),(0,x.jsx)("div",{children:(0,x.jsx)(rG,{children:(0,x.jsxs)(x.Fragment,{children:[l.parameters.map((e,t)=>(0,x.jsx)(rK,{name:e.name,type:e.type,description:e.description},t)),(0,x.jsx)(rK,{name:"__is_success",type:eb.VarType.number,description:r(`${ij}.outputVars.isSuccess`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"__reason",type:eb.VarType.string,description:r(`${ij}.outputVars.errorReason`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"__usage",type:"object",description:r(`${ij}.outputVars.usage`,{ns:"workflow"})})]})})})]})]})}),iN=e=>{let{topic:t,index:a,nodeId:r,t:s}=e,l=t.name.length>50?`${t.name.slice(0,50)}...`:t.name,n=t.name.length>50,o=(0,x.jsx)("div",{className:"system-xs-regular truncate text-text-tertiary",children:(0,x.jsx)(r5,{value:l,nodeId:r,className:"truncate"})});return(0,x.jsxs)("div",{className:"flex flex-col gap-y-0.5 rounded-md bg-workflow-block-parma-bg px-[5px] py-[3px]",children:[(0,x.jsx)("div",{className:"system-2xs-semibold-uppercase uppercase text-text-secondary",children:`${s("nodes.questionClassifiers.class",{ns:"workflow"})} ${a+1}`}),n?(0,x.jsx)(B.default,{popupContent:(0,x.jsx)("div",{className:"max-w-[300px] break-words",children:(0,x.jsx)(r5,{value:t.name,nodeId:r})}),children:o}):o]})},iC=y.memo(e=>{let{t}=(0,O.useTranslation)(),{data:a,id:r}=e,{provider:s,name:l}=a.model,n=a.classes,{textGenerationModelList:o}=(0,$.useTextGenerationCurrentProviderAndModelAndModelList)(),i=s&&l;return i||n.length?(0,x.jsxs)("div",{className:"mb-1 px-3 py-1",children:[i&&(0,x.jsx)(a2.default,{defaultModel:{provider:s,model:l},triggerClassName:"!h-6 !rounded-md",modelList:o,readonly:!0}),!!n.length&&(0,x.jsx)("div",{className:"mt-2 space-y-0.5",children:(0,x.jsx)("div",{className:"space-y-0.5",children:n.map((a,s)=>(0,x.jsxs)("div",{className:"relative",children:[(0,x.jsx)(iN,{topic:a,index:s,nodeId:r,t:t}),(0,x.jsx)(aF,{...e,handleId:a.id,handleClassName:"!top-1/2 !-translate-y-1/2 !-right-[21px]"})]},a.id))})})]}):null});var rq=rq;let i_="nodes.questionClassifiers",iT=y.memo(e=>{let{instruction:t,onInstructionChange:a,hideMemorySetting:r,memory:s,onMemoryChange:l,readonly:n,isChatModel:o,isChatApp:i,hasSetBlockStatus:d,nodesOutputVars:c,availableNodes:u}=e,{t:p}=(0,O.useTranslation)();return(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(rF,{title:(0,x.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,x.jsx)("span",{className:"uppercase",children:p(`${i_}.instruction`,{ns:"workflow"})}),(0,x.jsx)(B.default,{popupContent:(0,x.jsx)("div",{className:"w-[120px]",children:p(`${i_}.instructionTip`,{ns:"workflow"})}),triggerClassName:"w-3.5 h-3.5 ml-0.5"})]}),value:t,onChange:a,readOnly:n,isChatModel:o,isChatApp:i,isShowContext:!1,hasSetBlockStatus:d,nodesOutputVars:c,availableNodes:u}),!r&&(0,x.jsx)(rW,{className:"mt-4",readonly:!1,config:{data:s},onChange:l,canSetRoleName:!1})]})}),iS="nodes.questionClassifiers",iE=y.memo(e=>{let{className:t,headerClassName:a,nodeId:r,payload:s,onChange:l,onRemove:n,index:o,readonly:i,filterVar:d}=e,{t:c}=(0,O.useTranslation)(),[u,p]=(0,y.useState)(()=>lt());(0,y.useEffect)(()=>{p(`${r}-${lt()}`)},[r]);let m=(0,y.useCallback)(e=>{l({...s,name:e})},[l,s]),{availableVars:h,availableNodesWithParent:g}=(0,t3.default)(r,{onlyLeafNodeVar:!1,hideChatVar:!1,hideEnv:!1,filterVar:d});return(0,x.jsx)(rF,{className:t,headerClassName:a,title:`${c(`${iS}.class`,{ns:"workflow"})} ${o}`,placeholder:c(`${iS}.topicPlaceholder`,{ns:"workflow"}),value:s.name,onChange:m,showRemove:!0,onRemove:n,nodesOutputVars:h,availableNodes:g,readOnly:i,instanceId:u,justVar:!0,isSupportFileVar:!0})}),iV="nodes.questionClassifiers",iI=y.memo(e=>{let{nodeId:t,list:a,onChange:r,readonly:s,filterVar:l,handleSortTopic:n=tg.noop}=e,{t:o}=(0,O.useTranslation)(),{handleEdgeDeleteByDeleteBranch:i}=(0,eK.useEdgesInteractions)(),d=(0,y.useRef)(null),[c,u]=(0,y.useState)(!1),p=(0,y.useRef)(a.length),[m,h]=(0,y.useState)(!1),g=(0,y.useCallback)(e=>t=>{r((0,f.produce)(a,a=>{a[e]=t}))},[a,r]),b=(0,y.useCallback)(()=>{r((0,f.produce)(a,e=>{e.push({id:`${Date.now()}`,name:""})})),u(!0),m&&h(!1)},[a,r,m]),v=(0,y.useCallback)(e=>()=>{i(t,a[e].id),r((0,f.produce)(a,t=>{t.splice(e,1)}))},[a,r,i,t]),w=a.length;(0,y.useEffect)(()=>{c&&a.length>p.current&&u(!1),p.current=a.length},[a.length,c]);let j=(0,y.useCallback)(()=>{h(!m)},[m]);return(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"mb-2 flex items-center justify-between",onClick:j,children:(0,x.jsxs)("div",{className:"flex cursor-pointer items-center text-xs font-semibold uppercase text-text-secondary",children:[o(`${iV}.class`,{ns:"workflow"})," ",(0,x.jsx)("span",{className:"text-text-destructive",children:"*"}),a.length>0&&(0,x.jsx)(sM.ArrowDownRoundFill,{className:(0,T.cn)("h-4 w-4 text-text-quaternary transition-transform duration-200",m&&"-rotate-90")})]})}),!m&&(0,x.jsx)("div",{ref:d,className:(0,T.cn)("overflow-y-visible","pl-3"),children:(0,x.jsx)(sy.ReactSortable,{list:a.map(e=>({...e})),setList:n,handle:".handle",ghostClass:"bg-components-panel-bg",animation:150,disabled:s,className:"space-y-2",children:a.map((e,r)=>{let n=!s&&w>=2;return(0,x.jsx)("div",{className:(0,T.cn)("group relative rounded-[10px] bg-components-panel-bg","-ml-3 min-h-[40px] px-0 py-0"),style:{contain:"layout style paint"},children:(0,x.jsxs)("div",{children:[n&&(0,x.jsx)(M.RiDraggable,{className:(0,T.cn)("handle absolute left-2 top-3 hidden h-3 w-3 cursor-pointer text-text-tertiary","group-hover:block")}),(0,x.jsx)(iE,{className:(0,T.cn)(n&&"handle"),headerClassName:(0,T.cn)(n&&"cursor-grab group-hover:pl-5"),nodeId:t,payload:e,onChange:g(r),onRemove:v(r),index:r+1,readonly:s,filterVar:l},a[r].id)]})},e.id)})})}),!s&&!m&&(0,x.jsx)("div",{className:"mt-2",children:(0,x.jsx)(ot,{onClick:b,text:o(`${iV}.addClass`,{ns:"workflow"})})})]})}),iR="nodes.questionClassifiers",iM=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,handleModelChanged:n,isChatMode:o,isChatModel:i,handleCompletionParamsChange:d,handleQueryVarChange:c,handleTopicsChange:u,hasSetBlockStatus:p,availableVars:m,availableNodesWithParent:h,handleInstructionChange:g,handleMemoryChange:b,isVisionModel:v,handleVisionResolutionChange:w,handleVisionResolutionEnabledChange:k,filterVar:N,handleSortTopic:C}=((e,t)=>{let a=(0,j.useUpdateNodeInternals)(),{nodesReadOnly:r}=(0,Z.useNodesReadOnly)(),s=(0,Z.useIsChatMode)(),l=(0,eN.useStore)(e=>e.nodesDefaultConfigs)?.[t.type],{getBeforeNodesInSameBranch:n}=(0,Z.useWorkflow)(),o=n(e).find(e=>e.data.type===eb.BlockEnum.Start),i=o?.id,{inputs:d,setInputs:c}=(0,tZ.default)(e,t),u=(0,y.useRef)(d);(0,y.useEffect)(()=>{u.current=d},[d]);let[p,m]=(0,y.useState)(!1),{currentProvider:x,currentModel:h}=(0,$.useModelListAndDefaultModelAndCurrentProviderAndModel)(t0.ModelTypeEnum.textGeneration),g=d.model,b=d.model?.mode===eg.AppModeEnum.CHAT,{isVisionModel:v,handleVisionResolutionEnabledChange:w,handleVisionResolutionChange:k,handleModelChanged:N}=as(g,{payload:d.vision,onChange:e=>{c((0,f.produce)(d,t=>{t.vision=e}))}}),C=(0,y.useCallback)(e=>{c((0,f.produce)(u.current,t=>{t.model.provider=e.provider,t.model.name=e.modelId,t.model.mode=e.mode})),m(!0)},[c]);(0,y.useEffect)(()=>{x?.provider&&h?.model&&!g.provider&&C({provider:x?.provider,modelId:h?.model,mode:h?.model_properties?.mode})},[g.provider,x,h,C]);let _=(0,y.useCallback)(e=>{c((0,f.produce)(d,t=>{t.model.completion_params=e}))},[d,c]);(0,y.useEffect)(()=>{p&&(m(!1),N())},[v,p]);let T=(0,y.useCallback)(e=>{c((0,f.produce)(d,t=>{t.query_variable_selector=e}))},[d,c]);(0,y.useEffect)(()=>{if(l&&Object.keys(l).length>0){let e=[];s&&0===d.query_variable_selector.length&&i&&(e=[i,"sys.query"]),c({...d,...l,query_variable_selector:d.query_variable_selector.length>0?d.query_variable_selector:e})}},[l]);let S=(0,y.useCallback)(e=>{c((0,f.produce)(d,t=>{t.classes=e,t._targetBranches=e}))},[d,c]),E=(0,y.useCallback)(e=>[eb.VarType.number,eb.VarType.string].includes(e.type),[]),V=(0,y.useCallback)(e=>[eb.VarType.file,eb.VarType.arrayFile].includes(e.type),[]),{availableVars:I,availableNodesWithParent:R}=(0,t3.default)(e,{onlyLeafNodeVar:!1,filterVar:E}),{availableVars:M}=(0,t3.default)(e,{onlyLeafNodeVar:!1,filterVar:V}),A={history:!1,query:!!s&&(0,tb.checkHasQueryBlock)(d.instruction),context:!1},O=(0,y.useCallback)(e=>{c((0,f.produce)(d,t=>{t.instruction=e}))},[d,c]),P=(0,y.useCallback)(e=>{c((0,f.produce)(d,t=>{t.memory=e}))},[d,c]),L=(0,y.useCallback)(e=>e.type===eb.VarType.string,[]),F=(0,y.useCallback)(t=>{c((0,f.produce)(d,e=>{e.classes=t.filter(Boolean).map(e=>({id:e.id,name:e.name}))})),a(e)},[e,d,c,a]);return{readOnly:r,inputs:d,handleModelChanged:C,isChatMode:s,isChatModel:b,handleCompletionParamsChange:_,handleQueryVarChange:T,filterVar:L,handleTopicsChange:S,hasSetBlockStatus:A,availableVars:I,availableNodesWithParent:R,availableVisionVars:M,handleInstructionChange:O,handleMemoryChange:P,isVisionModel:v,handleVisionResolutionEnabledChange:w,handleVisionResolutionChange:k,handleSortTopic:F}})(t,a),_=l.model;return(0,x.jsxs)("div",{className:"pt-2",children:[(0,x.jsxs)("div",{className:"space-y-4 px-4",children:[(0,x.jsx)(rj,{title:r(`${iR}.model`,{ns:"workflow"}),required:!0,children:(0,x.jsx)(n4.default,{popupClassName:"!w-[387px]",isInWorkflow:!0,isAdvancedMode:!0,provider:_?.provider,completionParams:_.completion_params,modelId:_.name,setModel:n,onCompletionParamsChange:d,hideDebugWithMultipleModel:!0,debugWithMultipleModel:!1,readonly:s})}),(0,x.jsx)(rj,{title:r(`${iR}.inputVars`,{ns:"workflow"}),required:!0,children:(0,x.jsx)(sa.default,{readonly:s,isShowNodeName:!0,nodeId:t,value:l.query_variable_selector,onChange:c,filterVar:N})}),(0,x.jsx)(er,{}),(0,x.jsx)(n7,{nodeId:t,readOnly:s,isVisionModel:v,enabled:l.vision?.enabled,onEnabledChange:k,config:l.vision?.configs,onConfigChange:w}),(0,x.jsx)(iI,{nodeId:t,list:l.classes,onChange:u,readonly:s,filterVar:N,handleSortTopic:C}),(0,x.jsx)(er,{})]}),(0,x.jsx)(rq.default,{title:r(`${iR}.advancedSetting`,{ns:"workflow"}),children:(0,x.jsx)(iT,{hideMemorySetting:!o,instruction:l.instruction,onInstructionChange:g,memory:l.memory,onMemoryChange:b,readonly:s,isChatApp:o,isChatModel:i,hasSetBlockStatus:p,nodesOutputVars:m,availableNodes:h})}),(0,x.jsx)(er,{}),(0,x.jsx)("div",{children:(0,x.jsx)(rG,{children:(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(rK,{name:"class_name",type:"string",description:r(`${iR}.outputVars.className`,{ns:"workflow"})}),(0,x.jsx)(rK,{name:"usage",type:"object",description:r(`${iR}.outputVars.usage`,{ns:"workflow"})})]})})})]})});var iA=e.i(111378);let iO=y.memo(e=>{let{data:t}=e,{t:a}=(0,O.useTranslation)(),{variables:r}=t;return r.length?(0,x.jsx)("div",{className:"mb-1 px-3 py-1",children:(0,x.jsx)("div",{className:"space-y-0.5",children:r.map(e=>(0,x.jsxs)("div",{className:"flex h-6 items-center justify-between space-x-1 rounded-md  bg-workflow-block-parma-bg px-1",children:[(0,x.jsxs)("div",{className:"flex w-0 grow items-center space-x-1",children:[(0,x.jsx)(r_.Variable02,{className:"h-3.5 w-3.5 shrink-0 text-text-accent"}),(0,x.jsx)("span",{className:"system-xs-regular w-0 grow truncate text-text-secondary",children:e.variable})]}),(0,x.jsxs)("div",{className:"ml-1 flex items-center space-x-1",children:[e.required&&(0,x.jsx)("span",{className:"system-2xs-regular-uppercase text-text-tertiary",children:a("nodes.start.required",{ns:"workflow"})}),(0,x.jsx)(iA.default,{type:e.type,className:"h-3 w-3 text-text-tertiary"})]})]},e.variable))})}):null});var iP=e.i(112142),iL=e.i(726371),iF=e.i(99443),iF=iF;let iB=y.memo(e=>{let{className:t,readonly:a,payload:r,onChange:s=()=>!0,onRemove:l=tg.noop,rightContent:n,varKeys:o=[],showLegacyBadge:i=!1,canDrag:d}=e,{t:c}=(0,O.useTranslation)(),u=(0,y.useRef)(null),p=(0,iL.useHover)(u),[m,{setTrue:h,setFalse:g}]=(0,an.useBoolean)(!1),f=(0,y.useCallback)((e,t)=>{s(e,t)&&g()},[s,g]);return(0,x.jsxs)("div",{ref:u,className:(0,T.cn)("flex h-8 cursor-pointer items-center justify-between rounded-lg border border-components-panel-border-subtle bg-components-panel-on-panel-item-bg px-2.5 shadow-xs hover:shadow-md",t),children:[(0,x.jsxs)("div",{className:"flex w-0 grow items-center space-x-1",children:[(0,x.jsx)(r_.Variable02,{className:(0,T.cn)("h-3.5 w-3.5 text-text-accent",d&&"group-hover:opacity-0")}),(0,x.jsx)("div",{title:r.variable,className:"max-w-[130px] shrink-0 truncate text-[13px] font-medium text-text-secondary",children:r.variable}),r.label&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"shrink-0 text-xs font-medium text-text-quaternary",children:"·"}),(0,x.jsx)("div",{title:r.label,className:"max-w-[130px] truncate text-[13px] font-medium text-text-tertiary",children:r.label})]}),i&&(0,x.jsx)(r6.default,{text:"LEGACY",className:"shrink-0 border-text-accent-secondary text-text-accent-secondary"})]}),(0,x.jsx)("div",{className:"ml-2 flex shrink-0 items-center",children:n||(0,x.jsx)(x.Fragment,{children:!p||a?(0,x.jsxs)(x.Fragment,{children:[r.required&&(0,x.jsx)("div",{className:"mr-2 text-xs font-normal text-text-tertiary",children:c("nodes.start.required",{ns:"workflow"})}),(0,x.jsx)(iA.default,{type:r.type,className:"h-3.5 w-3.5 text-text-tertiary"})]}):!a&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{onClick:h,className:"mr-1 cursor-pointer rounded-md p-1 hover:bg-state-base-hover",children:(0,x.jsx)(iF.default,{className:"h-4 w-4 text-text-tertiary"})}),(0,x.jsx)("div",{onClick:l,className:"group cursor-pointer rounded-md p-1 hover:bg-state-destructive-hover",children:(0,x.jsx)(M.RiDeleteBinLine,{className:"h-4 w-4 text-text-tertiary group-hover:text-text-destructive"})})]})})}),m&&(0,x.jsx)(iP.default,{isShow:!0,supportFile:!0,payload:r,onClose:g,onConfirm:f,varKeys:o})]})}),iD=y.memo(e=>{let{readonly:t,list:a,onChange:r}=e,{t:s}=(0,O.useTranslation)(),l=(0,y.useCallback)(e=>(t,l)=>{let n=(0,f.produce)(a,a=>{a[e]=t}),o="",i="";return((0,sm.hasDuplicateStr)(n.map(e=>e.variable))?(o="varKeyError.keyAlreadyExists",i="variableConfig.varName"):(0,sm.hasDuplicateStr)(n.map(e=>e.label))&&(o="varKeyError.keyAlreadyExists",i="variableConfig.labelName"),o&&i)?(eR.default.notify({type:"error",message:s(o,{ns:"appDebug",key:s(i,{ns:"appDebug"})})}),!1):(r(n,l?{index:e,payload:l}:void 0),!0)},[a,r]),n=(0,y.useCallback)(e=>()=>{r((0,f.produce)(a,t=>{t.splice(e,1)}),{index:e,payload:{type:eb.ChangeType.remove,payload:{beforeKey:a[e].variable}}})},[a,r]),o=(0,y.useMemo)(()=>a.map(e=>({id:e.variable,variable:{...e}})),[a]),i=a.length;if(0===a.length)return(0,x.jsx)("div",{className:"flex h-[42px] items-center justify-center rounded-md bg-components-panel-bg text-xs font-normal leading-[18px] text-text-tertiary",children:s("nodes.start.noVarTip",{ns:"workflow"})});let d=!t&&i>1;return(0,x.jsx)(sy.ReactSortable,{className:"space-y-1",list:o,setList:e=>{r(e.map(e=>e.variable))},handle:".handle",ghostClass:"opacity-50",animation:150,children:o.map((e,r)=>(0,x.jsxs)("div",{className:"group relative",children:[(0,x.jsx)(iB,{className:(0,T.cn)(d&&"handle"),readonly:t,payload:e.variable,onChange:l(r),onRemove:n(r),varKeys:a.map(e=>e.variable),canDrag:d}),d&&(0,x.jsx)(M.RiDraggable,{className:(0,T.cn)("handle absolute left-3 top-2.5 hidden h-3 w-3 cursor-pointer text-text-tertiary","group-hover:block")})]},e.id))})});var i$=e.i(310828);let iz=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,isChatMode:l,inputs:n,isShowAddVarModal:o,showAddVarModal:i,handleAddVariable:d,hideAddVarModal:c,handleVarListChange:u,isShowRemoveVarConfirm:p,hideRemoveVarConfirm:m,onRemoveVarConfirm:h}=(0,i$.default)(t,a);return(0,x.jsxs)("div",{className:"mt-2",children:[(0,x.jsx)("div",{className:"space-y-4 px-4 pb-2",children:(0,x.jsx)(rj,{title:r("nodes.start.inputField",{ns:"workflow"}),operations:s?void 0:(0,x.jsx)(eM.default,{onClick:i}),children:(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(iD,{readonly:s,list:n.variables||[],onChange:u}),(0,x.jsxs)("div",{className:"mt-1 space-y-1",children:[(0,x.jsx)(er,{className:"my-2"}),l&&(0,x.jsx)(iB,{readonly:!0,payload:{variable:"userinput.query"},rightContent:(0,x.jsx)("div",{className:"text-xs font-normal text-text-tertiary",children:"String"})}),(0,x.jsx)(iB,{readonly:!0,showLegacyBadge:!l,payload:{variable:"userinput.files"},rightContent:(0,x.jsx)("div",{className:"text-xs font-normal text-text-tertiary",children:"Array[File]"})})]})]})})}),o&&(0,x.jsx)(iP.default,{isCreate:!0,supportFile:!0,isShow:o,onClose:c,onConfirm:e=>{d(e)&&c()},varKeys:n.variables.map(e=>e.variable)}),(0,x.jsx)(sj.default,{isShow:p,onCancel:m,onConfirm:h})]})}),iH=y.memo(()=>(0,x.jsx)("div",{})),iW="nodes.templateTransform",iq=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,availableVars:n,handleVarListChange:o,handleVarNameChange:i,handleAddVariable:d,handleAddEmptyVariable:c,handleCodeChange:u,filterVar:p}=((e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),r=(0,eN.useStore)(e=>e.nodesDefaultConfigs)?.[t.type],{inputs:s,setInputs:l}=(0,tZ.default)(e,t),n=(0,y.useRef)(s),o=(0,y.useCallback)(e=>{l(e),n.current=e},[l]),{availableVars:i}=(0,t3.default)(e,{onlyLeafNodeVar:!1,filterVar:()=>!0}),{handleAddVariable:d}=t4({inputs:s,setInputs:o}),c=(0,y.useCallback)(e=>{o((0,f.produce)(n.current,t=>{t.variables=e}))},[o]),u=(0,y.useCallback)(e=>{o((0,f.produce)(n.current,t=>{t.variables.push(e)}))},[o]),p=(0,y.useCallback)((e,t)=>{o((0,f.produce)(n.current,a=>{a.template=a.template.replaceAll(`{{ ${e} }}`,`{{ ${t} }}`)}))},[o]);return(0,y.useEffect)(()=>{s.template||r&&Object.keys(r).length>0&&o({...s,...r})},[r]),{readOnly:a,inputs:s,availableVars:i,handleVarListChange:c,handleVarNameChange:p,handleAddVariable:u,handleAddEmptyVariable:d,handleCodeChange:(0,y.useCallback)(e=>{o((0,f.produce)(n.current,t=>{t.template=e}))},[o]),filterVar:(0,y.useCallback)(e=>[eb.VarType.string,eb.VarType.number,eb.VarType.boolean,eb.VarType.object,eb.VarType.array,eb.VarType.arrayNumber,eb.VarType.arrayString,eb.VarType.arrayBoolean,eb.VarType.arrayObject].includes(e.type),[])}})(t,a);return(0,x.jsxs)("div",{className:"mt-2",children:[(0,x.jsxs)("div",{className:"space-y-4 px-4 pb-4",children:[(0,x.jsx)(rj,{title:r(`${iW}.inputVars`,{ns:"workflow"}),operations:s?void 0:(0,x.jsx)(eM.default,{onClick:c}),children:(0,x.jsx)(sw,{nodeId:t,readonly:s,list:l.variables,onChange:o,onVarNameChange:i,filterVar:p,isSupportFileVar:!1})}),(0,x.jsx)(er,{}),(0,x.jsx)(rI,{availableVars:n,varList:l.variables,onAddVar:d,isInNode:!0,readOnly:s,language:eD.CodeLanguage.python3,title:(0,x.jsx)("div",{className:"uppercase",children:r(`${iW}.code`,{ns:"workflow"})}),headerRight:(0,x.jsxs)("div",{className:"flex items-center",children:[(0,x.jsxs)("a",{className:"flex h-[18px] items-center space-x-0.5 text-xs font-normal text-text-tertiary",href:"https://jinja.palletsprojects.com/en/3.1.x/templates/",target:"_blank",children:[(0,x.jsx)("span",{children:r(`${iW}.codeSupportTip`,{ns:"workflow"})}),(0,x.jsx)(M.RiQuestionLine,{className:"h-3 w-3"})]}),(0,x.jsx)("div",{className:"mx-1.5 h-3 w-px bg-divider-regular"})]}),value:l.template,onChange:u})]}),(0,x.jsx)(er,{}),(0,x.jsx)("div",{children:(0,x.jsx)(rG,{children:(0,x.jsx)(x.Fragment,{children:(0,x.jsx)(rK,{name:"output",type:"string",description:r(`${iW}.outputVars.output`,{ns:"workflow"})})})})})]})}),iU=y.memo(e=>{let{id:t,data:a}=e,{tool_configurations:r,paramSchemas:s}=a,l=Object.keys(r||{}),{isChecking:n,isMissing:o,uniqueIdentifier:i,canInstall:d,onInstallSuccess:c,shouldDim:u}=sT(a),p=!n&&o&&d&&i,{handleNodeDataUpdate:m}=(0,Q.useNodeDataUpdate)(),h=!n&&o&&d&&!!i;(0,y.useEffect)(()=>{(a._pluginInstallLocked!==h||a._dimmed!==u)&&m({id:t,data:{_pluginInstallLocked:h,_dimmed:u}})},[a._pluginInstallLocked,a._dimmed,m,t,u,h]);let g=l.length>0;return p||g?(0,x.jsxs)("div",{className:"relative mb-1 px-3 py-1",children:[p&&(0,x.jsx)("div",{className:"pointer-events-auto absolute right-3 top-[-32px] z-40",children:(0,x.jsx)(rf.InstallPluginButton,{size:"small",className:"!font-medium !text-text-accent",extraIdentifiers:[a.plugin_id,a.provider_id,a.provider_name].filter(Boolean),uniqueIdentifier:i,onSuccess:c})}),g&&(0,x.jsx)("div",{className:"space-y-0.5","aria-disabled":u,children:l.map((e,t)=>(0,x.jsxs)("div",{className:"flex h-6 items-center justify-between space-x-1 rounded-md  bg-workflow-block-parma-bg px-1 text-xs font-normal text-text-secondary",children:[(0,x.jsx)("div",{title:e,className:"max-w-[100px] shrink-0 truncate text-xs font-medium uppercase text-text-tertiary",children:e}),"string"==typeof r[e].value&&(0,x.jsx)("div",{title:r[e].value,className:"w-0 shrink-0 grow truncate text-right text-xs font-normal text-text-secondary",children:s?.find(t=>t.name===e)?.type===t0.FormTypeEnum.secretInput?"********":r[e].value}),"number"==typeof r[e].value&&(0,x.jsx)("div",{title:Number.isNaN(r[e].value)?"":r[e].value,className:"w-0 shrink-0 grow truncate text-right text-xs font-normal text-text-secondary",children:Number.isNaN(r[e].value)?"":r[e].value}),"string"!=typeof r[e]&&r[e]?.type===t0.FormTypeEnum.modelSelector&&(0,x.jsx)("div",{title:r[e].model,className:"w-0 shrink-0 grow truncate text-right text-xs font-normal text-text-secondary",children:r[e].model})]},t))})]}):null}),iK="nodes.tool",iG=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,toolInputVarSchema:n,setInputVar:o,toolSettingSchema:i,toolSettingValue:d,setToolSettingValue:c,currCollection:u,isShowAuthBtn:p,isLoading:m,outputSchema:h,hasObjectOutput:g,currTool:f}=ai(t,a),[b,v]=y.useState(!1),w=(0,eN.useStore)(e=>e.pipelineId),j=(0,eN.useStore)(e=>e.setShowInputFieldPanel),{schemaTypeDefinitions:k}=(0,tP.default)();return m?(0,x.jsx)("div",{className:"flex h-[200px] items-center justify-center",children:(0,x.jsx)(oN.default,{})}):(0,x.jsxs)("div",{className:"pt-2",children:[!p&&(0,x.jsxs)("div",{className:"relative",children:[n.length>0&&(0,x.jsx)(rj,{className:"px-4",title:r(`${iK}.inputVars`,{ns:"workflow"}),children:(0,x.jsx)(sD.default,{readOnly:s,nodeId:t,schema:n,value:l.tool_parameters,onChange:o,currentProvider:u,currentTool:f,showManageInputField:!!w,onManageInputField:()=>j?.(!0)})}),n.length>0&&i.length>0&&(0,x.jsx)(er,{className:"mt-1"}),i.length>0&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(rG,{title:r(`${iK}.settings`,{ns:"workflow"}),collapsed:b,onCollapse:v,children:(0,x.jsx)(sD.default,{readOnly:s,nodeId:t,schema:i,value:d,onChange:c})}),(0,x.jsx)(er,{})]})]}),(0,x.jsx)("div",{children:(0,x.jsx)(rG,{children:(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(rK,{name:"text",type:"string",description:r(`${iK}.outputVars.text`,{ns:"workflow"}),isIndent:g}),(0,x.jsx)(rK,{name:"files",type:"array[file]",description:r(`${iK}.outputVars.files.title`,{ns:"workflow"}),isIndent:g}),(0,x.jsx)(rK,{name:"json",type:"array[object]",description:r(`${iK}.outputVars.json`,{ns:"workflow"}),isIndent:g}),h.map(e=>{let t=(0,tP.getMatchedSchemaType)(e.value,k);return(0,x.jsx)("div",{children:e.value?.type==="object"?(0,x.jsx)(sF,{rootClassName:"code-sm-semibold text-text-secondary",payload:(0,sB.wrapStructuredVarItem)(e,t)}):(0,x.jsx)(rK,{name:e.name,type:`${e.type.toLocaleLowerCase()}${t?` (${t})`:""}`,description:e.description,isIndent:g})},e.name)})]})})})]})});var iJ=e.i(417494),iX=((c={}).warning="warning",c.error="error",c);let iQ=(0,oc.cva)("flex items-center gap-1 rounded-md px-2 py-1 system-xs-medium",{variants:{status:{warning:"bg-state-warning-hover text-text-warning",error:"bg-state-destructive-hover text-text-destructive"}},defaultVariants:{status:"warning"}}),iY={warning:{IconComponent:iJ.default,message:"Warning"},error:{IconComponent:M.RiErrorWarningFill,message:"Error"}},iZ=e=>{let{className:t,status:a,message:r,styleCss:s,iconClassName:l,children:n,...o}=e,i=iY[a??"warning"].IconComponent,d=iY[a??"warning"].message;return(0,x.jsxs)("div",{className:(0,T.cn)(iQ({status:a,className:t})),style:s,...o,children:[(0,x.jsx)(i,{className:(0,T.cn)("h-3.5 w-3.5 shrink-0",l)}),(0,x.jsx)("span",{children:r??d}),n]})};iZ.displayName="NodeStatus";let i0=y.memo(iZ);var i1=e.i(705848);let i2=function(e){let{allowScalars:t=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return!e||"object"!=typeof e||Array.isArray(e)?{}:Object.entries(e).reduce((e,a)=>{let[r,s]=a;if(!s&&0!==s&&!1!==s)return e;if("object"==typeof s&&!Array.isArray(s)&&"type"in s&&"value"in s){let t={...s};return t.type===i1.VarKindType.mixed&&(t.type=i1.VarKindType.constant),e[r]=t,e}return t&&("string"==typeof s||"number"==typeof s||"boolean"==typeof s?e[r]={type:i1.VarKindType.constant,value:s}:Array.isArray(s)&&s.every(e=>"string"==typeof e)&&(e[r]={type:i1.VarKindType.variable,value:s})),e},{})},i5=(e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),{data:r=[]}=(0,eS.useAllTriggerPlugins)(),{inputs:s,setInputs:l}=(0,tZ.default)(e,t),{provider_id:n,provider_name:o,event_name:i,config:d={},event_parameters:c={},subscription_id:u}=s,p=(0,y.useMemo)(()=>i2(c),[c]),m=(0,y.useMemo)(()=>i2(d,{allowScalars:!0}),[d]),x=(0,y.useMemo)(()=>r.find(e=>e.name===o||e.id===n||n&&e.plugin_id===n),[r,o,n]),{data:h=[]}=(0,eS.useTriggerSubscriptions)(n||""),g=(0,y.useMemo)(()=>h?.find(e=>e.id===u),[h,u]),b=(0,y.useMemo)(()=>x?.events.find(e=>e.name===i),[x,i]),v=(0,y.useMemo)(()=>b?(0,t1.toolParametersToFormSchemas)(b.parameters):[],[b]),w=(0,y.useMemo)(()=>{let e=new Map;return v.forEach(t=>{e.set(t.variable||t.name,t)}),Array.from(e.values())},[v]),j=(0,y.useMemo)(()=>{if(!w.length)return{};let e=p&&Object.keys(p).length>0?p:m;return i2((0,t1.getConfiguredValue)(e,w))},[w,p,m]);(0,y.useEffect)(()=>{!w.length||p&&Object.keys(p).length>0||!j||0===Object.keys(j).length||l((0,f.produce)(s,e=>{e.event_parameters=j,e.config=j}))},[l,p,s,w,j]);let k=(0,y.useCallback)(e=>{let t=i2(e);l((0,f.produce)(s,e=>{e.event_parameters=t,e.config=t}))},[s,l]),N=(0,y.useCallback)((e,t)=>{l((0,f.produce)(s,a=>{let r=i2({...a.event_parameters,[e.variable]:{type:i1.VarKindType.variable,value:t.variable}});a.event_parameters=r,a.config=r}))},[s,l]),C=(0,y.useMemo)(()=>b?.output_schema||{},[b]),_=(0,y.useMemo)(()=>Object.values(C.properties||{}).some(e=>"object"===e.type),[C]);return{readOnly:a,inputs:s,currentProvider:x,currentEvent:b,triggerParameterSchema:w,triggerParameterValue:j,setTriggerParameterValue:k,setInputVar:N,outputSchema:C,hasObjectOutput:_,subscriptions:h,subscriptionSelected:g}},i3=e=>{if(null==e)return"";if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return String(e);if(Array.isArray(e))return e.join(".");if("object"==typeof e){let{value:t}=e;if(null==t)return"";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return String(t);if(Array.isArray(t))return t.join(".");try{return JSON.stringify(t)}catch{}}return""},i4=y.memo(e=>{let{id:t,data:a}=e,{subscriptions:r}=i5(t,a),{config:s={},subscription_id:l}=a,n=Object.keys(s),{isChecking:o,isMissing:i,uniqueIdentifier:d,canInstall:c,onInstallSuccess:u,shouldDim:p}=sT(a),{handleNodeDataUpdate:m}=(0,Q.useNodeDataUpdate)(),h=!o&&i&&c&&d,g=!o&&i&&c&&!!d;(0,y.useEffect)(()=>{(a._pluginInstallLocked!==g||a._dimmed!==p)&&m({id:t,data:{_pluginInstallLocked:g,_dimmed:p}})},[a._pluginInstallLocked,a._dimmed,m,t,p,g]);let{t:f}=(0,O.useTranslation)(),b=(0,y.useMemo)(()=>l&&r?.some(e=>e.id===l),[l,r]);return(0,x.jsxs)("div",{className:"relative mb-1 px-3 py-1",children:[h&&(0,x.jsx)("div",{className:"pointer-events-auto absolute right-3 top-[-32px] z-40",children:(0,x.jsx)(rf.InstallPluginButton,{size:"small",extraIdentifiers:[a.plugin_id,a.provider_id,a.provider_name].filter(Boolean),className:"!font-medium !text-text-accent",uniqueIdentifier:d,onSuccess:u})}),(0,x.jsxs)("div",{className:"space-y-0.5","aria-disabled":p,children:[!b&&(0,x.jsx)(i0,{status:iX.warning,message:f("node.status.warning",{ns:"pluginTrigger"})}),b&&n.map((e,t)=>{let a;return(0,x.jsxs)("div",{className:"flex h-6 items-center justify-between space-x-1 rounded-md bg-workflow-block-parma-bg px-1 text-xs font-normal text-text-secondary",children:[(0,x.jsx)("div",{title:e,className:"max-w-[100px] shrink-0 truncate text-xs font-medium uppercase text-text-tertiary",children:e}),(0,x.jsx)("div",{title:i3(s[e]),className:"w-0 shrink-0 grow truncate text-right text-xs font-normal text-text-secondary",children:(a=i3(s[e])).includes("secret")?"********":a})]},t)})]})]})});e.i(844083);var i6=e.i(620191),i8=e.i(925304);let i9=e=>{let{readOnly:t,nodeId:a,schema:r,value:s,onChange:l,inPanel:n,currentEvent:o,currentProvider:i,extraParams:d,disableVariableInsertion:c=!1}=e,u=(0,$.useLanguage)(),{name:p,label:m,type:h,required:g,tooltip:f,input_schema:b}=r,y=h===t0.FormTypeEnum.object||h===t0.FormTypeEnum.array,v=h===t0.FormTypeEnum.textInput||h===t0.FormTypeEnum.secretInput,[w,{setTrue:j,setFalse:k}]=(0,an.useBoolean)(!1);return(0,x.jsxs)("div",{className:"space-y-0.5 py-1",children:[(0,x.jsxs)("div",{children:[(0,x.jsxs)("div",{className:"flex h-6 items-center",children:[(0,x.jsx)("div",{className:"system-sm-medium text-text-secondary",children:m[u]||m.en_US}),g&&(0,x.jsx)("div",{className:"system-xs-regular ml-1 text-text-destructive-secondary",children:"*"}),!v&&f&&(0,x.jsx)(B.default,{popupContent:(0,x.jsx)("div",{className:"w-[200px]",children:f[u]||f.en_US}),triggerClassName:"ml-1 w-4 h-4",asChild:!1}),y&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"system-xs-regular ml-1 mr-0.5 text-text-quaternary",children:"·"}),(0,x.jsxs)(es.default,{variant:"ghost",size:"small",onClick:j,className:"system-xs-regular px-1 text-text-tertiary",children:[(0,x.jsx)(M.RiBracesLine,{className:"mr-1 size-3.5"}),(0,x.jsx)("span",{children:"JSON Schema"})]})]})]}),v&&f&&(0,x.jsx)("div",{className:"body-xs-regular pb-0.5 text-text-tertiary",children:f[u]||f.en_US})]}),(0,x.jsx)(i8.default,{readOnly:t,nodeId:a,schema:r,value:s,onChange:l,inPanel:n,currentTool:o,currentProvider:i,providerType:"trigger",extraParams:d,disableVariableInsertion:c}),w&&(0,x.jsx)(i6.SchemaModal,{isShow:!0,onClose:k,rootName:p,schema:b})]})},i7=e=>{let{readOnly:t,nodeId:a,schema:r,value:s,onChange:l,inPanel:n,currentEvent:o,currentProvider:i,extraParams:d,disableVariableInsertion:c=!1}=e;return(0,x.jsx)("div",{className:"space-y-1",children:r.map((e,r)=>(0,x.jsx)(i9,{readOnly:t,nodeId:a,schema:e,value:s,onChange:l,inPanel:n,currentEvent:o,currentProvider:i,extraParams:d,disableVariableInsertion:c},r))})},de=y.memo(e=>{let{id:t,data:a}=e,{readOnly:r,triggerParameterSchema:s,triggerParameterValue:l,setTriggerParameterValue:n,outputSchema:o,hasObjectOutput:i,currentProvider:d,currentEvent:c,subscriptionSelected:u}=i5(t,a),p=a.type===eb.BlockEnum.TriggerPlugin,m=Object.entries(o.properties||{}).map(e=>{let[t,a]=e;return{name:t,type:a.type||"string",description:a.description||""}});return(0,x.jsxs)("div",{className:"mt-2",children:[s.length>0&&u&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"px-4 pb-4",children:(0,x.jsx)(i7,{readOnly:r,nodeId:t,schema:s,value:l,onChange:n,currentProvider:d,currentEvent:c,disableVariableInsertion:p})}),(0,x.jsx)(er,{})]}),(0,x.jsx)(rG,{children:(0,x.jsxs)(x.Fragment,{children:[m.map(e=>(0,x.jsx)(rK,{name:e.name,type:e.type,description:e.description,isIndent:i},e.name)),Object.entries(o.properties||{}).map(e=>{let[t,a]=e;return(0,x.jsx)("div",{children:"object"===a.type?(0,x.jsx)(sF,{rootClassName:"code-sm-semibold text-text-secondary",payload:{schema:{type:od.Type.object,properties:{[t]:a},additionalProperties:!1}}}):null},t)})]})})]})});var dt=e.i(38696);let da=y.memo(e=>{let{data:t}=e,{t:a}=(0,O.useTranslation)();return(0,x.jsxs)("div",{className:"mb-1 px-3 py-1",children:[(0,x.jsx)("div",{className:"mb-1 text-[10px] font-medium uppercase tracking-wide text-text-tertiary",children:a("nodes.triggerSchedule.nextExecutionTime",{ns:"workflow"})}),(0,x.jsx)("div",{className:"flex h-[26px] items-center rounded-md bg-workflow-block-parma-bg px-2 text-xs text-text-secondary",children:(0,x.jsx)("div",{className:"w-0 grow",children:(0,x.jsx)("div",{className:"truncate",title:(0,dt.getNextExecutionTime)(t),children:(0,dt.getNextExecutionTime)(t)})})})]})});var dr=e.i(519089);let ds=e=>{let{frequency:t,onChange:a}=e,{t:r}=(0,O.useTranslation)(),s=(0,y.useMemo)(()=>[{value:"frequency-header",name:r("nodes.triggerSchedule.frequency.label",{ns:"workflow"}),isGroup:!0},{value:"hourly",name:r("nodes.triggerSchedule.frequency.hourly",{ns:"workflow"})},{value:"daily",name:r("nodes.triggerSchedule.frequency.daily",{ns:"workflow"})},{value:"weekly",name:r("nodes.triggerSchedule.frequency.weekly",{ns:"workflow"})},{value:"monthly",name:r("nodes.triggerSchedule.frequency.monthly",{ns:"workflow"})}],[r]);return(0,x.jsx)(la.SimpleSelect,{items:s,defaultValue:t,onSelect:e=>a(e.value),placeholder:r("nodes.triggerSchedule.selectFrequency",{ns:"workflow"}),className:"w-full py-2",wrapperClassName:"h-auto",optionWrapClassName:"min-w-40",notClearable:!0,allowSearch:!1},`${t}-${s[0]?.name}`)};var dl=e.i(158420),dl=dl,dn=e.i(647226),dn=dn;let di=e=>{let{mode:t,onChange:a}=e,{t:r}=(0,O.useTranslation)(),s=r("visual"===t?"nodes.triggerSchedule.useCronExpression":"nodes.triggerSchedule.useVisualPicker",{ns:"workflow"}),l="visual"===t?dl.default:dn.default;return(0,x.jsxs)("button",{type:"button",onClick:()=>{a("visual"===t?"cron":"visual")},className:"flex cursor-pointer items-center gap-1 rounded-lg px-2 py-1 text-sm text-text-secondary hover:bg-state-base-hover",children:[y.createElement(l,{className:"w-4 h-4"}),(0,x.jsx)("span",{children:s})]})},dd=e=>{let{selectedDays:t,onChange:a}=e,{t:r}=(0,O.useTranslation)(),s=Array.from({length:31},(e,t)=>t+1),l=[s.slice(0,7),s.slice(7,14),s.slice(14,21),s.slice(21,28),[29,30,31,"last"]];return(0,x.jsxs)("div",{className:"space-y-2",children:[(0,x.jsx)("label",{className:"mb-2 block text-xs font-medium text-text-tertiary",children:r("nodes.triggerSchedule.days",{ns:"workflow"})}),(0,x.jsx)("div",{className:"space-y-1.5",children:l.map((e,s)=>(0,x.jsxs)("div",{className:"grid grid-cols-7 gap-1.5",children:[e.map(e=>(0,x.jsx)("button",{type:"button",onClick:()=>{let r,s;a((s=(r=t||[]).includes(e)?r.filter(t=>t!==e):[...r,e]).length>0?s:[e])},className:`rounded-lg border bg-components-option-card-option-bg py-1 text-xs transition-colors ${"last"===e?"col-span-2 min-w-0":""} ${t?.includes(e)||0?"border-util-colors-blue-brand-blue-brand-600 text-text-secondary":"border-divider-subtle text-text-tertiary hover:border-divider-regular hover:text-text-secondary"}`,children:"last"===e?(0,x.jsxs)("div",{className:"flex items-center justify-center gap-1",children:[(0,x.jsx)("span",{children:r("nodes.triggerSchedule.lastDay",{ns:"workflow"})}),(0,x.jsx)(B.default,{popupContent:r("nodes.triggerSchedule.lastDayTooltip",{ns:"workflow"}),children:(0,x.jsx)(M.RiQuestionLine,{className:"h-3 w-3 text-text-quaternary"})})]}):e},e)),s===l.length-1&&Array.from({length:7-e.length-1},(e,t)=>(0,x.jsx)("div",{className:"invisible"},`empty-${t}`))]},s))}),t?.includes(31)&&(0,x.jsx)("div",{className:"mt-1.5 grid grid-cols-7 gap-1.5",children:(0,x.jsx)("div",{className:"col-span-7 text-xs text-gray-500",children:r("nodes.triggerSchedule.lastDayTooltip",{ns:"workflow"})})})]})},dc=e=>{let{data:t}=e,{t:a}=(0,O.useTranslation)();if(!t.frequency)return null;let r=(0,dt.getFormattedExecutionTimes)(t,5);return 0===r.length?null:(0,x.jsxs)("div",{className:"space-y-2",children:[(0,x.jsx)("label",{className:"block text-xs font-medium text-gray-500",children:a("nodes.triggerSchedule.nextExecutionTimes",{ns:"workflow"})}),(0,x.jsx)("div",{className:"flex min-h-[80px] flex-col rounded-xl bg-components-input-bg-normal py-2",children:r.map((e,t)=>(0,x.jsxs)("div",{className:"flex items-baseline text-xs",children:[(0,x.jsx)("span",{className:"w-6 select-none text-right font-mono font-normal leading-[150%] tracking-wider text-text-quaternary",children:String(t+1).padStart(2,"0")}),(0,x.jsx)("span",{className:"pl-2 pr-3 font-mono font-normal leading-[150%] tracking-wider text-text-secondary",children:e})]},t))})]})},du=e=>{let{value:t=0,onChange:a}=e,{t:r}=(0,O.useTranslation)();return(0,x.jsxs)("div",{children:[(0,x.jsx)("label",{className:"mb-2 block text-xs font-medium text-gray-500",children:r("nodes.triggerSchedule.onMinute",{ns:"workflow"})}),(0,x.jsxs)("div",{className:"relative flex h-8 items-center rounded-lg bg-components-input-bg-normal",children:[(0,x.jsx)("div",{className:"flex h-full w-12 shrink-0 items-center justify-center text-[13px] text-components-input-text-filled",children:t}),(0,x.jsx)("div",{className:"absolute left-12 top-0 h-full w-px bg-components-panel-bg"}),(0,x.jsx)("div",{className:"flex h-full grow items-center pl-4 pr-3",children:(0,x.jsx)(tr.default,{className:"w-full",value:t,min:0,max:59,step:1,onChange:a})})]})]})},dp=e=>{let{selectedDays:t,onChange:a}=e,{t:r}=(0,O.useTranslation)();return(0,x.jsxs)("div",{className:"space-y-2",children:[(0,x.jsx)("label",{className:"mb-2 block text-xs font-medium text-text-tertiary",children:r("nodes.triggerSchedule.weekdays",{ns:"workflow"})}),(0,x.jsx)("div",{className:"flex gap-1.5",children:[{key:"sun",label:"Sun"},{key:"mon",label:"Mon"},{key:"tue",label:"Tue"},{key:"wed",label:"Wed"},{key:"thu",label:"Thu"},{key:"fri",label:"Fri"},{key:"sat",label:"Sat"}].map(e=>{let r;return(0,x.jsx)("button",{type:"button",className:`flex-1 rounded-lg border bg-components-option-card-option-bg py-1 text-xs transition-colors ${(r=e.key,t.includes(r))?"border-util-colors-blue-brand-blue-brand-600 text-text-secondary":"border-divider-subtle text-text-tertiary hover:border-divider-regular hover:text-text-secondary"}`,onClick:()=>{var r;let s,l;return r=e.key,void a((l=(s=t||[]).includes(r)?s.filter(e=>e!==r):[...s,r]).length>0?l:[r])},children:e.label},e.key)})})]})};var dm=e.i(890987);let dx=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{inputs:s,setInputs:l,handleModeChange:n,handleFrequencyChange:o,handleCronExpressionChange:i,handleWeekdaysChange:d,handleTimeChange:c,handleOnMinuteChange:u}=((e,t)=>{let{nodesReadOnly:a}=(0,Z.useNodesReadOnly)(),{userProfile:r}=(0,nS.useAppContext)(),s=(0,y.useMemo)(()=>({...t,mode:t.mode||"visual",frequency:t.frequency||"daily",timezone:t.timezone||r.timezone||"UTC",visual_config:{...(0,dm.getDefaultVisualConfig)(),...t.visual_config}}),[t,r.timezone]),{inputs:l,setInputs:n}=(0,tZ.default)(e,s),o=(0,y.useCallback)(e=>{n({...l,mode:e})},[l,n]),i=(0,y.useCallback)(e=>{n({...l,frequency:e,visual_config:{...l.visual_config,..."hourly"===e&&{on_minute:l.visual_config?.on_minute??0}},cron_expression:void 0})},[l,n]),d=(0,y.useCallback)(e=>{n({...l,cron_expression:e,frequency:void 0,visual_config:void 0})},[l,n]),c=(0,y.useCallback)(e=>{n({...l,visual_config:{...l.visual_config,weekdays:e},cron_expression:void 0})},[l,n]),u=(0,y.useCallback)(e=>{n({...l,visual_config:{...l.visual_config,time:e},cron_expression:void 0})},[l,n]),p=(0,y.useCallback)(e=>{n({...l,visual_config:{...l.visual_config,on_minute:e},cron_expression:void 0})},[l,n]);return{readOnly:a,inputs:l,setInputs:n,handleModeChange:o,handleFrequencyChange:i,handleCronExpressionChange:d,handleWeekdaysChange:c,handleTimeChange:u,handleOnMinuteChange:p}})(t,a);return(0,x.jsx)("div",{className:"mt-2",children:(0,x.jsxs)("div",{className:"space-y-4 px-4 pb-3 pt-2",children:[(0,x.jsx)(rj,{title:r("nodes.triggerSchedule.title",{ns:"workflow"}),operations:(0,x.jsx)(di,{mode:s.mode,onChange:n}),children:(0,x.jsxs)("div",{className:"space-y-3",children:["visual"===s.mode&&(0,x.jsxs)("div",{className:"space-y-3",children:[(0,x.jsxs)("div",{className:"grid grid-cols-3 gap-3",children:[(0,x.jsxs)("div",{children:[(0,x.jsx)("label",{className:"mb-2 block text-xs font-medium text-gray-500",children:r("nodes.triggerSchedule.frequencyLabel",{ns:"workflow"})}),(0,x.jsx)(ds,{frequency:s.frequency||"daily",onChange:o})]}),(0,x.jsx)("div",{className:"col-span-2",children:"hourly"===s.frequency?(0,x.jsx)(du,{value:s.visual_config?.on_minute,onChange:u}):(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("label",{className:"mb-2 block text-xs font-medium text-gray-500",children:r("nodes.triggerSchedule.time",{ns:"workflow"})}),(0,x.jsx)(dr.default,{notClearable:!0,timezone:s.timezone,value:s.visual_config?.time||"12:00 AM",triggerFullWidth:!0,onChange:e=>{e&&c(e.format("h:mm A"))},onClear:()=>{c("12:00 AM")},placeholder:r("nodes.triggerSchedule.selectTime",{ns:"workflow"}),showTimezone:!0})]})})]}),"weekly"===s.frequency&&(0,x.jsx)(dp,{selectedDays:s.visual_config?.weekdays||[],onChange:d}),"monthly"===s.frequency&&(0,x.jsx)(dd,{selectedDays:s.visual_config?.monthly_days||[1],onChange:e=>{l({...s,visual_config:{...s.visual_config,monthly_days:e}})}})]}),"cron"===s.mode&&(0,x.jsx)("div",{className:"space-y-2",children:(0,x.jsxs)("div",{children:[(0,x.jsx)("label",{className:"mb-2 block text-xs font-medium text-gray-500",children:r("nodes.triggerSchedule.cronExpression",{ns:"workflow"})}),(0,x.jsx)(eF.default,{value:s.cron_expression||"",onChange:e=>i(e.target.value),placeholder:"0 0 * * *",className:"font-mono"})]})})]})}),(0,x.jsx)("div",{className:"border-t border-divider-subtle"}),(0,x.jsx)(dc,{data:s})]})})}),dh=y.memo(e=>{let{data:t}=e;return(0,x.jsxs)("div",{className:"mb-1 px-3 py-1",children:[(0,x.jsx)("div",{className:"mb-1 text-[10px] font-medium uppercase tracking-wide text-text-tertiary",children:"URL"}),(0,x.jsx)("div",{className:"flex h-[26px] items-center rounded-md bg-workflow-block-parma-bg px-2 text-xs text-text-secondary",children:(0,x.jsx)("div",{className:"w-0 grow",children:(0,x.jsx)("div",{className:"truncate",title:t.webhook_url||"--",children:t.webhook_url||"--"})})})]})});var dg=e.i(617571);let df="overview.appInfo.embedded",db=y.forwardRef((e,t)=>{let{showCopyButton:a=!0,copyValue:r,onCopy:s,value:l,wrapperClassName:n,...o}=e,{t:i}=(0,O.useTranslation)(),d="string"==typeof l?l:String(l||""),c=r||d,{copied:u,copy:p,reset:m}=(0,dg.useClipboard)();return(0,x.jsxs)("div",{className:(0,T.cn)("relative w-full",n),children:[(0,x.jsx)("input",{ref:t,className:(0,T.cn)("w-full appearance-none border border-transparent bg-components-input-bg-normal py-[7px] text-components-input-text-filled caret-primary-600 outline-none placeholder:text-components-input-text-placeholder hover:border-components-input-border-hover hover:bg-components-input-bg-hover focus:border-components-input-border-active focus:bg-components-input-bg-active focus:shadow-xs","radius-md system-sm-regular px-3",a&&"pr-8",o.disabled&&"cursor-not-allowed border-transparent bg-components-input-bg-disabled text-components-input-text-filled-disabled hover:border-transparent hover:bg-components-input-bg-disabled",o.className),value:l,...(e=>{let{size:t,...a}=e;return a})(o)}),a&&(0,x.jsx)("div",{className:"absolute right-2 top-1/2 -translate-y-1/2",onMouseLeave:m,children:(0,x.jsx)(B.default,{popupContent:i(u?`${df}.copied`:`${df}.copy`,{ns:"appOverview"})||"",children:(0,x.jsx)(rk.default,{size:"xs",onClick:()=>{p(c),s?.(c)},className:"hover:bg-components-button-ghost-bg-hover",children:u?(0,x.jsx)(M.RiClipboardFill,{className:"h-3.5 w-3.5 text-text-tertiary"}):(0,x.jsx)(M.RiClipboardLine,{className:"h-3.5 w-3.5 text-text-tertiary"})})})})]})});db.displayName="InputWithCopy";var dy=e.i(844367),dv=e.i(324935);let dw=y.memo(e=>{let{title:t,columns:a,data:r,onChange:s,readonly:l=!1,placeholder:n,emptyRowData:o,className:i,showHeader:d=!1}=e,c=(0,y.useMemo)(()=>{let e=e=>Object.values(e).every(e=>""===e||null==e||!1===e);if(l)return r.map((e,t)=>({row:e,dataIndex:t,isVirtual:!1}));let t=r.length>0,a=[];return t?(r.forEach((t,s)=>{e(t)&&s<r.length-1||a.push({row:t,dataIndex:s,isVirtual:!1})}),e(r[r.length-1])||a.push({row:{...o},dataIndex:null,isVirtual:!0})):a.push({row:{...o},dataIndex:null,isVirtual:!0}),a},[r,o,l]),u=(0,y.useCallback)(e=>{l||e<0||e>=r.length||s(r.filter((t,a)=>a!==e))},[r,l,s]),p=(0,y.useCallback)((e,t,a)=>{if(!l){if(null!==e&&e<r.length){let l=[...r];l[e]={...l[e],[t]:a},s(l);return}s([...r,{...o,[t]:a}])}},[r,o,s,l]),m=(0,y.useMemo)(()=>a.find(e=>"key"===e.key||"name"===e.key)?.key??"key",[a]),h=l&&0===r.length;return(0,x.jsxs)("div",{className:i,children:[(0,x.jsx)("div",{className:"mb-3 flex items-center justify-between",children:(0,x.jsx)("h4",{className:"system-sm-semibold-uppercase text-text-secondary",children:t})}),h?(0,x.jsx)("div",{className:"flex h-7 items-center justify-center rounded-lg border border-divider-regular bg-components-panel-bg text-xs font-normal leading-[18px] text-text-quaternary",children:n}):(0,x.jsxs)("div",{className:"rounded-lg border border-divider-regular",children:[d&&(0,x.jsx)("div",{className:"system-xs-medium-uppercase flex h-7 items-center leading-7 text-text-tertiary",children:a.map((e,t)=>(0,x.jsx)("div",{className:(0,T.cn)("h-full pl-3",e.width&&e.width.startsWith("w-")?"shrink-0":"flex-1",e.width,t<a.length-1&&"border-r border-divider-regular"),children:e.title},e.key))}),(0,x.jsx)("div",{className:"divide-y divide-divider-subtle",children:c.map((e,t)=>{var r;let{row:s,dataIndex:n,isVirtual:o}=e,i=`row-${t}`,d="string"==typeof(r=s[m])?""!==r.trim():""!==r&&null!=r&&!1!==r;return(0,x.jsxs)("div",{className:(0,T.cn)("group relative flex border-t border-divider-regular",d?"hover:bg-state-destructive-hover":"hover:bg-state-base-hover"),style:{minHeight:"28px"},children:[a.map((e,t)=>(0,x.jsx)("div",{className:(0,T.cn)("shrink-0 pl-3",e.width,t<a.length-1&&"border-r border-divider-regular"),children:((e,t,a)=>{let r=t[e.key],s=t=>p(a,e.key,t);switch(e.type){case"input":return(0,x.jsx)(eF.default,{value:r||"",onChange:t=>{("key"===e.key||"name"===e.key)&&(0,sm.replaceSpaceWithUnderscoreInVarNameInput)(t.target),s(t.target.value)},onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),e.currentTarget.blur())},placeholder:e.placeholder,disabled:l,wrapperClassName:"w-full min-w-0",className:(0,T.cn)("h-6 rounded-none border-0 bg-transparent px-0 py-0 shadow-none","hover:border-transparent hover:bg-transparent focus:border-transparent focus:bg-transparent","system-sm-regular text-text-secondary placeholder:text-text-quaternary")});case"select":return(0,x.jsx)(la.SimpleSelect,{items:e.options||[],defaultValue:r,onSelect:e=>s(e.value),disabled:l,placeholder:e.placeholder,hideChecked:!1,notClearable:!0,wrapperClassName:"h-6 w-full min-w-0",className:(0,T.cn)("h-6 rounded-none bg-transparent pl-0 pr-6 text-text-secondary","hover:bg-transparent focus-visible:bg-transparent group-hover/simple-select:bg-transparent"),optionWrapClassName:"w-26 min-w-26 z-[60] -ml-3"});case"switch":return(0,x.jsx)("div",{className:"flex h-7 items-center",children:(0,x.jsx)(dv.default,{id:`${e.key}-${String(a??"v")}`,checked:!!r,onCheck:()=>s(!r),disabled:l})});case"custom":return e.render?e.render(r,t,a??-1,s):null;default:return null}})(e,s,n)},e.key)),!l&&null!==n&&d&&(0,x.jsx)("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100",children:(0,x.jsx)("button",{type:"button",onClick:()=>u(n),className:"p-1","aria-label":"Delete row",children:(0,x.jsx)(M.RiDeleteBinLine,{className:"h-3.5 w-3.5 text-text-destructive"})})})]},i)})})]})]})}),dj=y.memo(e=>{let{readonly:t=!1,headers:a=[],onChange:r}=e,{t:s}=(0,O.useTranslation)(),l=[{key:"name",title:s("nodes.triggerWebhook.varName",{ns:"workflow"}),type:"input",width:"flex-1",placeholder:s("nodes.triggerWebhook.varNamePlaceholder",{ns:"workflow"})},{key:"required",title:s("nodes.triggerWebhook.required",{ns:"workflow"}),type:"switch",width:"w-[88px]"}],n=a.map(e=>({name:e.name,required:e.required}));return(0,x.jsx)(dw,{title:"Header Parameters",columns:l,data:n,onChange:e=>{r(e.filter(e=>e.name&&"string"==typeof e.name&&""!==e.name.trim()).map(e=>({name:e.name||"",required:!!e.required})))},readonly:t,placeholder:s("nodes.triggerWebhook.noHeaders",{ns:"workflow"}),emptyRowData:{name:"",required:!1},showHeader:!0})}),dk=y.memo(e=>{let{value:t,onChange:a,placeholder:r,disabled:s=!1,className:l}=e,n=(0,y.useRef)(null),o=Math.max(3,(t?t.split("\n"):[""]).length);return(0,x.jsx)("div",{className:(0,T.cn)("rounded-xl bg-components-input-bg-normal px-3 pb-2 pt-3",l),children:(0,x.jsxs)("div",{className:"relative",children:[(0,x.jsx)("div",{className:"pointer-events-none absolute left-0 top-0 flex flex-col",children:Array.from({length:o},(e,t)=>(0,x.jsx)("span",{className:"flex h-[20px] select-none items-center font-mono text-xs leading-[20px] text-text-quaternary",children:String(t+1).padStart(2,"0")},t))}),(0,x.jsx)("textarea",{ref:n,value:t,onChange:e=>a(e.target.value),placeholder:r,disabled:s,className:"w-full resize-none border-0 bg-transparent pl-6 font-mono text-xs leading-[20px] text-text-secondary outline-none placeholder:text-text-quaternary",style:{minHeight:`${20*Math.max(3,o)}px`,lineHeight:"20px"},rows:Math.max(3,o)})]})})});var dN=e.i(100501);let dC=e=>{let{title:t,parameters:a,onChange:r,readonly:s,placeholder:l,contentType:n}=e,{t:o}=(0,O.useTranslation)(),i=(0,y.useMemo)(()=>(0,dN.createParameterTypeOptions)(n),[n]),d=[{key:"key",title:o("nodes.triggerWebhook.varName",{ns:"workflow"}),type:"input",width:"flex-1",placeholder:o("nodes.triggerWebhook.varNamePlaceholder",{ns:"workflow"})},{key:"type",title:o("nodes.triggerWebhook.varType",{ns:"workflow"}),type:"select",width:"w-[120px]",placeholder:o("nodes.triggerWebhook.varType",{ns:"workflow"}),options:i},{key:"required",title:o("nodes.triggerWebhook.required",{ns:"workflow"}),type:"switch",width:"w-[88px]"}],c=i[0]?.value||"string",u=a.map(e=>({key:e.name,type:e.type,required:e.required}));return(0,x.jsx)(dw,{title:t,columns:d,data:u,onChange:e=>{let t="text/plain"===(n||"").toLowerCase(),a="application/octet-stream"===(n||"").toLowerCase(),s=e.filter(e=>"string"==typeof e.key&&""!==e.key.trim()).map(e=>({name:String(e.key),type:t?eb.VarType.string:a?eb.VarType.file:(0,dN.normalizeParameterType)(e.type),required:!!e.required}));r(t||a?s.slice(0,1):s)},readonly:s,placeholder:l||o("nodes.triggerWebhook.noParameters",{ns:"workflow"}),emptyRowData:{key:"",type:c,required:!1},showHeader:!0})};var d_=e.i(972282),dT=e.i(646704);let dS={raw:0,param:1,header:2,body:3},dE=e=>{let{prefix:t,name:a,type:r}=e;return(0,x.jsx)("div",{className:"py-1",children:(0,x.jsxs)("div",{className:"flex items-center leading-[18px]",children:[(0,x.jsxs)("span",{className:"code-sm-regular text-text-tertiary",children:[t,"."]}),(0,x.jsx)("span",{className:"code-sm-semibold text-text-secondary",children:a}),(0,x.jsx)("span",{className:"system-xs-regular ml-2 text-text-tertiary",children:r})]})})},dV=e=>{let{variables:t=[]}=e;if(!t||0===t.length)return(0,x.jsx)("div",{className:"system-sm-regular py-2 text-text-tertiary",children:"No output variables"});let a=[...t].sort((e,t)=>{let a="string"==typeof e.label?e.label:"",r="string"==typeof t.label?t.label:"";return(dS[a]||999)-(dS[r]||999)});return(0,x.jsx)("div",{children:a.map((e,t)=>{let a="string"==typeof e.label?e.label:"",r="string"==typeof e.variable?e.variable:"";return(0,x.jsx)(dE,{prefix:{raw:"payload",param:"query_params",header:"header_params",body:"req_body_params"}[a]||a,name:r,type:e.value_type||"string"},`${a}-${r}-${t}`)})})},dI="nodes.triggerWebhook",dR=[{name:"GET",value:"GET"},{name:"POST",value:"POST"},{name:"PUT",value:"PUT"},{name:"DELETE",value:"DELETE"},{name:"PATCH",value:"PATCH"},{name:"HEAD",value:"HEAD"}],dM=[{name:"application/json",value:"application/json"},{name:"application/x-www-form-urlencoded",value:"application/x-www-form-urlencoded"},{name:"text/plain",value:"text/plain"},{name:"application/octet-stream",value:"application/octet-stream"},{name:"multipart/form-data",value:"multipart/form-data"}];var dA=e.i(702496);let dO=(0,y.memo)(e=>{let{availableVars:t,variableAssignerNodeId:a,variableAssignerNodeData:r,handleId:s}=e,[l,n]=(0,y.useState)(!1),{handleAssignVariableValueChange:o}=aE(),i=(0,y.useCallback)((e,t)=>{o(a,e,t,s),n(!1)},[o,a,s,n]);return(0,x.jsx)("div",{className:(0,T.cn)(l&&"!flex",r.selected&&"!flex"),children:(0,x.jsxs)(ez.PortalToFollowElem,{placement:"right",offset:4,open:l,onOpenChange:n,children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>n(!l),children:(0,x.jsx)("div",{className:(0,T.cn)("group/addvariable flex items-center justify-center","h-4 w-4 cursor-pointer","hover:rounded-full hover:bg-primary-600",l&&"!rounded-full !bg-primary-600"),children:(0,x.jsx)(dA.Plus02,{className:(0,T.cn)("h-2.5 w-2.5 text-text-tertiary","group-hover/addvariable:text-text-primary",l&&"!text-text-primary")})})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[1000]",children:(0,x.jsx)(aM,{onSelect:i,availableVars:t})})]})})}),dP=(0,y.memo)(e=>{let{item:t}=e,{t:a}=(0,O.useTranslation)(),r=(0,eN.useStore)(e=>e.enteringNodePayload),s=(0,eN.useStore)(e=>e.hoveringAssignVariableGroupId),l=(0,j.useNodes)(),{handleGroupItemMouseEnter:n,handleGroupItemMouseLeave:o}=aE(),i=aV(),d=t.groupEnabled,c=(0,y.useMemo)(()=>{if(!d)return t.variableAssignerNodeData.output_type;let e=t.variableAssignerNodeData.advanced_settings?.groups.find(e=>e.groupId===t.targetHandleId);return e?.output_type||""},[t.variableAssignerNodeData,t.targetHandleId,d]),u=i(t.variableAssignerNodeId,t.targetHandleId,aI(c),!0),p=(0,y.useMemo)(()=>{if(d&&r?.nodeId===t.variableAssignerNodeId)if(s)return s!==t.targetHandleId;else return r?.nodeData.advanced_settings?.groups[0].groupId!==t.targetHandleId;return!1},[r,d,s,t.targetHandleId,t.variableAssignerNodeId]),m=(0,y.useMemo)(()=>{if(d&&r?.nodeId===t.variableAssignerNodeId)if(s)return s===t.targetHandleId;else return r?.nodeData.advanced_settings?.groups[0].groupId===t.targetHandleId;return!1},[r,d,s,t.targetHandleId,t.variableAssignerNodeId]);return(0,x.jsxs)("div",{className:(0,T.cn)("relative rounded-lg border-[1.5px] border-transparent px-1.5 pb-1.5 pt-1",p&&"!border-dashed !border-divider-subtle bg-state-base-hover",m&&"!border-text-accent !bg-util-colors-blue-blue-50"),onMouseEnter:()=>d&&n(t.targetHandleId),onMouseLeave:o,children:[(0,x.jsxs)("div",{className:"flex h-4 items-center justify-between text-[10px] font-medium text-text-tertiary",children:[(0,x.jsx)("span",{className:(0,T.cn)("grow truncate uppercase",m&&"text-text-accent"),title:t.title,children:t.title}),(0,x.jsxs)("div",{className:"flex items-center",children:[(0,x.jsx)("span",{className:"ml-2 shrink-0",children:t.type}),(0,x.jsx)("div",{className:"ml-2 mr-1 h-2.5 w-[1px] bg-divider-regular"}),(0,x.jsx)(dO,{availableVars:u,variableAssignerNodeId:t.variableAssignerNodeId,variableAssignerNodeData:t.variableAssignerNodeData,handleId:t.targetHandleId})]})]}),!t.variables.length&&(0,x.jsx)("div",{className:(0,T.cn)("relative flex h-[22px] items-center justify-between space-x-1 rounded-md bg-workflow-block-parma-bg px-1 text-[10px] font-normal uppercase text-text-tertiary",(m||p)&&"!bg-black/[0.02]"),children:a("nodes.variableAssigner.varNotSet",{ns:"workflow"})}),!!t.variables.length&&(0,x.jsx)("div",{className:"space-y-0.5",children:t.variables.map(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0,a=(0,ty.isSystemVar)(e),r=a?l.find(e=>e.data.type===eb.BlockEnum.Start):l.find(t=>t.id===e[0]),s=a?`sys.${e[e.length-1]}`:e.slice(1).join("."),n=(0,lS.isExceptionVariable)(s,r?.data.type);return(0,x.jsx)(r8.VariableLabelInNode,{variables:e,nodeType:r?.data.type,nodeTitle:r?.data.title,isExceptionVariable:n},t)})})]})}),dL=(0,y.memo)(e=>{let{t}=(0,O.useTranslation)(),a=(0,y.useRef)(null),{id:r,data:s}=e,{advanced_settings:l}=s,n=(0,y.useMemo)(()=>l?.group_enabled?l.groups.map(e=>({groupEnabled:!0,targetHandleId:e.groupId,title:e.group_name,type:e.output_type,variables:e.variables,variableAssignerNodeId:r,variableAssignerNodeData:s})):[{groupEnabled:!1,targetHandleId:"target",title:t("nodes.variableAssigner.title",{ns:"workflow"}),type:s.output_type,variables:s.variables,variableAssignerNodeId:r,variableAssignerNodeData:s}],[t,l,s,r]);return(0,x.jsx)("div",{className:"relative mb-1 space-y-0.5 px-1",ref:a,children:n.map(e=>(0,x.jsx)(dP,{item:e},e.title))})});var dF=e.i(155365),dF=dF;let dB=y.memo(e=>{let{readonly:t,nodeId:a,list:r,onChange:s,onOpen:l=tg.noop,filterVar:n}=e,{t:o}=(0,O.useTranslation)(),i=(0,y.useCallback)(e=>t=>{s((0,f.produce)(r,a=>{a[e]=t}),t)},[r,s]),d=(0,y.useCallback)(e=>()=>{s((0,f.produce)(r,t=>{t.splice(e,1)}))},[r,s]),c=(0,y.useCallback)(e=>()=>l(e),[l]);return 0===r.length?(0,x.jsx)(st,{children:o("nodes.variableAssigner.noVarTip",{ns:"workflow"})}):(0,x.jsx)("div",{className:"space-y-2",children:r.map((e,r)=>(0,x.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,x.jsx)(sa.default,{readonly:t,nodeId:a,isShowNodeName:!0,className:"grow",value:e,onChange:i(r),onOpen:c(r),filterVar:n,defaultVarKindType:t6.VarType.variable}),!t&&(0,x.jsx)(sx.default,{onClick:d(r)})]},r))})}),dD=y.memo(e=>{let{readOnly:t,nodeId:a,payload:r,onChange:s,groupEnabled:l,onGroupNameChange:n,canRemove:o,onRemove:i,availableVars:d}=e,{t:c}=(0,O.useTranslation)(),u=(0,y.useCallback)((e,t,a)=>{r.variables.some(t=>t.join(".")===e.join("."))||s((0,f.produce)(r,t=>{t.variables.push(e),a&&a.type!==eb.VarType.any&&(t.output_type=a.type)}))},[s,r]),p=(0,y.useCallback)((e,t)=>{t&&r.variables.some(e=>e.join(".")===t.join("."))||s((0,f.produce)(r,t=>{t.variables=e,0===e.length&&(t.output_type=eb.VarType.any)}))},[s,r]),m=(0,y.useCallback)(e=>r.output_type===eb.VarType.any||e.type===r.output_type,[r.output_type]),[h,{setTrue:g,setFalse:b}]=(0,an.useBoolean)(!1),v=(0,y.useCallback)(e=>{(0,sm.replaceSpaceWithUnderscoreInVarNameInput)(e.target);let t=e.target.value,{isValid:a,errorKey:r,errorMessageKey:s}=(0,sm.checkKeys)([t],!1);a?n?.(t):eR.default.notify({type:"error",message:c(`varKeyError.${s}`,{ns:"appDebug",key:r})})},[n,c]);return(0,x.jsx)(rj,{className:"group",title:l?(0,x.jsxs)("div",{className:"flex items-center",children:[(0,x.jsxs)("div",{className:"flex items-center !normal-case",children:[(0,x.jsx)(dF.default,{className:"mr-0.5 h-3.5 w-3.5"}),h?(0,x.jsx)("input",{type:"text",className:"h-6 rounded-lg border border-gray-300 bg-white px-1 focus:outline-none",size:r.group_name?.length,autoFocus:!0,value:r.group_name,onChange:v,onBlur:b,maxLength:30}):(0,x.jsx)("div",{className:"system-sm-semibold flex h-6 cursor-text items-center rounded-lg px-1 text-text-secondary hover:bg-gray-100",onClick:g,children:r.group_name})]}),o&&(0,x.jsx)("div",{className:"ml-0.5 hidden cursor-pointer rounded-md p-1 text-text-tertiary hover:bg-state-destructive-hover hover:text-text-destructive group-hover:block",onClick:i,children:(0,x.jsx)(M.RiDeleteBinLine,{className:"h-4 w-4"})})]}):c("nodes.variableAssigner.title",{ns:"workflow"}),operations:(0,x.jsxs)("div",{className:"flex h-6 items-center  space-x-2",children:[r.variables.length>0&&(0,x.jsx)("div",{className:"system-2xs-medium-uppercase flex h-[18px] items-center rounded-[5px] border border-divider-deep px-1 text-text-tertiary",children:r.output_type}),t?void 0:(0,x.jsx)(sa.default,{isAddBtnTrigger:!0,readonly:!1,nodeId:a,isShowNodeName:!0,value:[],onChange:u,defaultVarKindType:t6.VarType.variable,filterVar:m,availableVars:d})]}),children:(0,x.jsx)(dB,{readonly:t,nodeId:a,list:r.variables,onChange:p,filterVar:m})})}),d$="nodes.variableAssigner",dz=y.memo(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{readOnly:s,inputs:l,handleListOrTypeChange:n,isEnableGroup:o,handleGroupEnabledChange:i,handleAddGroup:d,handleListOrTypeChangeInGroup:c,handleGroupRemoved:u,handleVarGroupNameChange:p,isShowRemoveVarConfirm:m,hideRemoveVarConfirm:h,onRemoveVarConfirm:g,getAvailableVars:b,filterVar:v}=((e,t)=>{let{deleteNodeInspectorVars:a,renameInspectVarName:r}=(0,ea.default)(),{nodesReadOnly:s}=(0,Z.useNodesReadOnly)(),{handleOutVarRenameChange:l,isVarUsedInNodes:n,removeUsedVarInNodes:o}=(0,Z.useWorkflow)(),{inputs:i,setInputs:d}=(0,tZ.default)(e,t),c=!!i.advanced_settings?.group_enabled,u=(0,y.useCallback)(e=>{d({...i,...e})},[i,d]),p=(0,y.useCallback)(e=>t=>{let a=i.advanced_settings.groups.findIndex(t=>t.groupId===e);d((0,f.produce)(i,e=>{e.advanced_settings.groups[a]={...e.advanced_settings.groups[a],...t}}))},[i,d]),m=aV(),[x,{setTrue:h,setFalse:g}]=(0,an.useBoolean)(!1),[b,v]=(0,y.useState)([]),[w,j]=(0,y.useState)("group"),[k,N]=(0,y.useState)(-1),C=(0,y.useCallback)(t=>()=>{let a=i.advanced_settings.groups.findIndex(e=>e.groupId===t);if(n([e,i.advanced_settings.groups[a].group_name,"output"])){h(),v([[e,i.advanced_settings.groups[a].group_name,"output"]]),j("group"),N(a);return}d((0,f.produce)(i,e=>{e.advanced_settings.groups.splice(a,1)}))},[e,i,n,d,h]),_=(0,y.useCallback)(t=>{d((0,f.produce)(i,a=>{if(a.advanced_settings||(a.advanced_settings={group_enabled:!1,groups:[]}),t){if(0===a.advanced_settings.groups.length){let t="Group1";a.advanced_settings.groups=[{output_type:a.output_type,variables:a.variables,group_name:t,groupId:(0,sv.v4)()}],l(e,[e,"output"],[e,t,"output"])}}else if(a.advanced_settings.groups.length>0){if(a.advanced_settings.groups.length>1){let t=a.advanced_settings.groups.filter((t,a)=>a>0&&n([e,t.group_name,"output"]));if(t.length>0){h(),v(t.map(t=>[e,t.group_name,"output"])),j("enableChanged");return}}a.output_type=a.advanced_settings.groups[0].output_type,a.variables=a.advanced_settings.groups[0].variables,l(e,[e,a.advanced_settings.groups[0].group_name,"output"],[e,"output"])}a.advanced_settings.group_enabled=t})),a(e)},[a,l,e,i,n,d,h]),T=(0,y.useCallback)(()=>{let t=1;i.advanced_settings.groups.forEach(e=>{let a=/(\d+)$/.exec(e.group_name);if(a){let e=Number.parseInt(a[1],10);e>t&&(t=e)}}),d((0,f.produce)(i,e=>{e.advanced_settings.groups.push({output_type:eb.VarType.any,variables:[],group_name:`Group${t+1}`,groupId:(0,sv.v4)()})})),a(e)},[a,e,i,d]),S=(0,y.useRef)({}),{run:E}=(0,sp.useDebounceFn)((e,t)=>{let a=S.current[e];r(e,a,t),delete S.current[e]},{wait:500}),V=(0,y.useCallback)(t=>a=>{let r=i.advanced_settings.groups.findIndex(e=>e.groupId===t),s=(0,f.produce)(i,e=>{e.advanced_settings.groups[r].group_name=a});l(e,[e,i.advanced_settings.groups[r].group_name,"output"],[e,a,"output"]),d(s),e in S.current||(S.current[e]=i.advanced_settings.groups[r].group_name),E(e,a)},[l,e,i,E,d]),I=(0,y.useCallback)(()=>{b.forEach(e=>{o(e)}),g(),"group"===w?d((0,f.produce)(i,e=>{e.advanced_settings.groups.splice(k,1)})):d((0,f.produce)(i,e=>{e.advanced_settings.group_enabled=!1,e.output_type=e.advanced_settings.groups[0].output_type,e.variables=e.advanced_settings.groups[0].variables}))},[b,g,w,o,i,d,k]);return{readOnly:s,inputs:i,handleListOrTypeChange:u,isEnableGroup:c,handleGroupEnabledChange:_,handleAddGroup:T,handleListOrTypeChangeInGroup:p,handleGroupRemoved:C,handleVarGroupNameChange:V,isShowRemoveVarConfirm:x,hideRemoveVarConfirm:g,onRemoveVarConfirm:I,getAvailableVars:m,filterVar:e=>t=>e===eb.VarType.any||t.type===eb.VarType.any||t.type===e}})(t,a);return(0,x.jsxs)("div",{className:"mt-2",children:[(0,x.jsx)("div",{className:"space-y-4 px-4 pb-4",children:o?(0,x.jsxs)("div",{children:[(0,x.jsx)("div",{className:"space-y-2",children:l.advanced_settings?.groups.map((e,a)=>(0,x.jsxs)("div",{children:[(0,x.jsx)(dD,{readOnly:s,nodeId:t,payload:e,onChange:c(e.groupId),groupEnabled:!0,canRemove:!s&&l.advanced_settings?.groups.length>1,onRemove:u(e.groupId),onGroupNameChange:p(e.groupId),availableVars:b(t,e.groupId,v(e.output_type),!0)}),a!==l.advanced_settings?.groups.length-1&&(0,x.jsx)(er,{className:"my-4"})]},e.groupId))}),(0,x.jsx)(ot,{className:"mt-2",text:r(`${d$}.addGroup`,{ns:"workflow"}),onClick:d})]}):(0,x.jsx)(dD,{readOnly:s,nodeId:t,payload:{output_type:l.output_type,variables:l.variables},onChange:n,groupEnabled:!1,availableVars:b(t,"target",v(l.output_type),!0)})}),(0,x.jsx)(er,{}),(0,x.jsx)("div",{className:(0,T.cn)("px-4 pt-4",o?"pb-4":"pb-2"),children:(0,x.jsx)(rj,{title:r(`${d$}.aggregationGroup`,{ns:"workflow"}),tooltip:r(`${d$}.aggregationGroupTip`,{ns:"workflow"}),operations:(0,x.jsx)(ts.default,{defaultValue:o,onChange:i,size:"md",disabled:s})})}),o&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(er,{}),(0,x.jsx)(rG,{children:(0,x.jsx)(x.Fragment,{children:l.advanced_settings?.groups.map((e,t)=>(0,x.jsx)(rK,{name:`${e.group_name}.output`,type:e.output_type,description:r(`${d$}.outputVars.varDescribe`,{ns:"workflow",groupName:e.group_name})},t))})})]}),(0,x.jsx)(sj.default,{isShow:m,onCancel:h,onConfirm:g})]})}),dH={[eb.BlockEnum.Start]:iO,[eb.BlockEnum.End]:sG,[eb.BlockEnum.Answer]:r3,[eb.BlockEnum.LLM]:n3,[eb.BlockEnum.KnowledgeRetrieval]:nN,[eb.BlockEnum.QuestionClassifier]:iC,[eb.BlockEnum.IfElse]:lk,[eb.BlockEnum.Code]:sd,[eb.BlockEnum.TemplateTransform]:iH,[eb.BlockEnum.HttpRequest]:sX,[eb.BlockEnum.Tool]:iU,[eb.BlockEnum.VariableAssigner]:dL,[eb.BlockEnum.Assigner]:r7,[eb.BlockEnum.VariableAggregator]:dL,[eb.BlockEnum.ParameterExtractor]:il,[eb.BlockEnum.Iteration]:lq,[eb.BlockEnum.Loop]:oW,[eb.BlockEnum.DocExtractor]:sH,[eb.BlockEnum.ListFilter]:nq,[eb.BlockEnum.Agent]:a7,[eb.BlockEnum.DataSource]:sS,[eb.BlockEnum.KnowledgeBase]:lY,[eb.BlockEnum.TriggerSchedule]:da,[eb.BlockEnum.TriggerWebhook]:dh,[eb.BlockEnum.TriggerPlugin]:i4},dW={[eb.BlockEnum.Start]:iz,[eb.BlockEnum.End]:sJ,[eb.BlockEnum.Answer]:r4,[eb.BlockEnum.LLM]:oD,[eb.BlockEnum.KnowledgeRetrieval]:nW,[eb.BlockEnum.QuestionClassifier]:iM,[eb.BlockEnum.IfElse]:l$,[eb.BlockEnum.Code]:s_,[eb.BlockEnum.TemplateTransform]:iq,[eb.BlockEnum.HttpRequest]:lb,[eb.BlockEnum.Tool]:iG,[eb.BlockEnum.VariableAssigner]:dz,[eb.BlockEnum.VariableAggregator]:dz,[eb.BlockEnum.Assigner]:si,[eb.BlockEnum.ParameterExtractor]:ik,[eb.BlockEnum.Iteration]:lK,[eb.BlockEnum.Loop]:is,[eb.BlockEnum.DocExtractor]:sK,[eb.BlockEnum.ListFilter]:n5,[eb.BlockEnum.Agent]:rZ,[eb.BlockEnum.DataSource]:sz,[eb.BlockEnum.KnowledgeBase]:nk,[eb.BlockEnum.TriggerSchedule]:dx,[eb.BlockEnum.TriggerWebhook]:e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),[s,l]=y.useState(!1),[n,o]=(0,y.useState)(!1),{readOnly:i,inputs:d,handleMethodChange:c,handleContentTypeChange:u,handleHeadersChange:p,handleParamsChange:m,handleBodyChange:h,handleStatusCodeChange:g,handleStatusCodeBlur:b,handleResponseBodyChange:v,generateWebhookUrl:w}=((e,t)=>{let{t:a}=(0,O.useTranslation)(),{nodesReadOnly:r}=(0,Z.useNodesReadOnly)(),{inputs:s,setInputs:l}=(0,tZ.default)(e,t),n=L.useStore.getState().appDetail?.id,{isVarUsedInNodes:o,removeUsedVarInNodes:i}=(0,Z.useWorkflow)(),d=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.method=e}))},[s,l]),c=(0,y.useCallback)(t=>{l((0,f.produce)(s,a=>{let r=a.content_type;a.content_type=t,r!==t&&(a.body=[],a.variables&&(a.variables.filter(e=>"body"===e.label).forEach(t=>{o([e,t.variable])&&i([e,t.variable])}),a.variables=a.variables.filter(e=>"body"!==e.label)))}))},[s,l,e,o,i]),u=(0,y.useCallback)((t,r,s)=>{t.variables||(t.variables=[]);let l=r.map(e=>({item:e,sanitizedName:"header"===s?e.name.replace(/-/g,"_"):e.name}));if(l.some(e=>e.sanitizedName===dT.WEBHOOK_RAW_VARIABLE_NAME))return eR.default.notify({type:"error",message:a("varKeyError.keyAlreadyExists",{ns:"appDebug",key:a("variableConfig.varName",{ns:"appDebug"})})}),!1;let n=new Set(t.variables.filter(e=>e.label!==s&&e.variable!==dT.WEBHOOK_RAW_VARIABLE_NAME).map(e=>e.variable)),d=l.find(e=>n.has(e.sanitizedName));if(d)return eR.default.notify({type:"error",message:a("varKeyError.keyAlreadyExists",{ns:"appDebug",key:d.sanitizedName})}),!1;if((0,sm.hasDuplicateStr)(l.map(e=>e.sanitizedName)))return eR.default.notify({type:"error",message:a("varKeyError.keyAlreadyExists",{ns:"appDebug",key:a("variableConfig.varName",{ns:"appDebug"})})}),!1;for(let{sanitizedName:e}of l){let{isValid:t,errorMessageKey:r}=(0,sm.checkKeys)([e],!1);if(!t)return eR.default.notify({type:"error",message:a(`varKeyError.${r}`,{ns:"appDebug",key:a("variableConfig.varName",{ns:"appDebug"})})}),!1}let c=new Set(l.map(e=>e.sanitizedName));return t.variables.filter(e=>e.label===s&&!c.has(e.variable)).forEach(t=>{o([e,t.variable])&&i([e,t.variable])}),t.variables=t.variables.filter(e=>e.label!==s||c.has(e.variable)),l.forEach(e=>{let{item:a,sanitizedName:r}=e,l=t.variables.findIndex(e=>e.variable===r),n={value_type:"type"in a?a.type:eb.VarType.string,label:s,variable:r,value_selector:[],required:a.required};l>=0?t.variables[l]=n:t.variables.push(n)}),!0},[a,e,o,i]),p=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.params=e,u(t,e,"param")}))},[s,l,u]),m=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.headers=e,u(t,e,"header")}))},[s,l,u]),x=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.body=e,u(t,e,"body")}))},[s,l,u]),h=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.async_mode=e}))},[s,l]),g=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.status_code=e}))},[s,l]),b=(0,y.useCallback)(e=>{let t=Math.min(Math.max(e,200),399);l((0,f.produce)(s,e=>{e.status_code=t}))},[s,l]),v=(0,y.useCallback)(e=>{l((0,f.produce)(s,t=>{t.response_body=e}))},[s,l]),w=(0,y.useCallback)(async()=>{if((!s.webhook_url||!(s.webhook_url.length>0))&&n)try{let t=await (0,d_.fetchWebhookUrl)({appId:n,nodeId:e}),a=(0,f.produce)(s,e=>{e.webhook_url=t.webhook_url,e.webhook_debug_url=t.webhook_debug_url});l(a)}catch(e){console.error("Failed to generate webhook URL:",e),l((0,f.produce)(s,e=>{e.webhook_url=""}))}},[n,e,s,l]);return{readOnly:r,inputs:s,setInputs:l,handleMethodChange:d,handleContentTypeChange:c,handleHeadersChange:m,handleParamsChange:p,handleBodyChange:x,handleAsyncModeChange:h,handleStatusCodeChange:g,handleStatusCodeBlur:b,handleResponseBodyChange:v,generateWebhookUrl:w}})(t,a),j=(0,y.useRef)(!1);return(0,y.useEffect)(()=>{i||d.webhook_url||j.current||(j.current=!0,w())},[i,d.webhook_url,w]),(0,x.jsxs)("div",{className:"mt-2",children:[(0,x.jsxs)("div",{className:"space-y-4 px-4 pb-3 pt-2",children:[(0,x.jsx)(rj,{title:r(`${dI}.webhookUrl`,{ns:"workflow"}),children:(0,x.jsxs)("div",{className:"space-y-1",children:[(0,x.jsxs)("div",{className:"flex gap-1",style:{height:"32px"},children:[(0,x.jsx)("div",{className:"w-26 shrink-0",children:(0,x.jsx)(la.SimpleSelect,{items:dR,defaultValue:d.method,onSelect:e=>c(e.value),disabled:i,className:"h-8 pr-8 text-sm",wrapperClassName:"h-8",optionWrapClassName:"w-26 min-w-26 z-[5]",allowSearch:!1,notClearable:!0})}),(0,x.jsx)("div",{className:"flex-1",style:{width:"284px"},children:(0,x.jsx)(db,{value:d.webhook_url||"",placeholder:r(`${dI}.webhookUrlPlaceholder`,{ns:"workflow"}),readOnly:!0,onCopy:()=>{eR.default.notify({type:"success",message:r(`${dI}.urlCopied`,{ns:"workflow"})})}})})]}),d.webhook_debug_url&&(0,x.jsxs)("div",{className:"space-y-2",children:[(0,x.jsx)(B.default,{popupContent:s?r(`${dI}.debugUrlCopied`,{ns:"workflow"}):r(`${dI}.debugUrlCopy`,{ns:"workflow"}),popupClassName:"system-xs-regular text-text-primary bg-components-tooltip-bg border border-components-panel-border shadow-lg backdrop-blur-sm rounded-md px-1.5 py-1",position:"top",offset:{mainAxis:-20},needsDelay:!0,children:(0,x.jsxs)("div",{className:"flex cursor-pointer gap-1.5 rounded-lg px-1 py-1.5 transition-colors",style:{width:"368px",height:"38px"},onClick:()=>{(0,ak.default)(d.webhook_debug_url||""),l(!0),setTimeout(()=>l(!1),2e3)},children:[(0,x.jsx)("div",{className:"mt-0.5 w-0.5 bg-divider-regular",style:{height:"28px"}}),(0,x.jsxs)("div",{className:"flex-1",style:{width:"352px",height:"32px"},children:[(0,x.jsx)("div",{className:"text-xs leading-4 text-text-tertiary",children:r(`${dI}.debugUrlTitle`,{ns:"workflow"})}),(0,x.jsx)("div",{className:"truncate text-xs leading-4 text-text-primary",children:d.webhook_debug_url})]})]})}),(0,dy.isPrivateOrLocalAddress)(d.webhook_debug_url)&&(0,x.jsx)("div",{className:"system-xs-regular mt-1 px-0 py-[2px] text-text-warning",children:r(`${dI}.debugUrlPrivateAddressWarning`,{ns:"workflow"})})]})]})}),(0,x.jsx)(rj,{title:r(`${dI}.contentType`,{ns:"workflow"}),children:(0,x.jsx)("div",{className:"w-full",children:(0,x.jsx)(la.SimpleSelect,{items:dM,defaultValue:d.content_type,onSelect:e=>u(e.value),disabled:i,className:"h-8 text-sm",wrapperClassName:"h-8",optionWrapClassName:"min-w-48 z-[5]",allowSearch:!1,notClearable:!0})})}),(0,x.jsx)(dC,{readonly:i,title:"Query Parameters",parameters:d.params,onChange:m,placeholder:r(`${dI}.noQueryParameters`,{ns:"workflow"})}),(0,x.jsx)(dj,{readonly:i,headers:d.headers,onChange:p}),(0,x.jsx)(dC,{readonly:i,title:"Request Body Parameters",parameters:d.body,onChange:h,placeholder:r(`${dI}.noBodyParameters`,{ns:"workflow"}),contentType:d.content_type}),(0,x.jsx)(er,{}),(0,x.jsx)(rj,{title:r(`${dI}.responseConfiguration`,{ns:"workflow"}),children:(0,x.jsxs)("div",{className:"space-y-3",children:[(0,x.jsxs)("div",{className:"flex items-center justify-between",children:[(0,x.jsx)("label",{className:"system-sm-medium text-text-tertiary",children:r(`${dI}.statusCode`,{ns:"workflow"})}),(0,x.jsx)(rr.InputNumber,{value:d.status_code,onChange:e=>{g(e||200)},disabled:i,wrapClassName:"w-[120px]",className:"h-8",defaultValue:200,onBlur:()=>{b(d.status_code)}})]}),(0,x.jsxs)("div",{children:[(0,x.jsx)("label",{className:"system-sm-medium mb-2 block text-text-tertiary",children:r(`${dI}.responseBody`,{ns:"workflow"})}),(0,x.jsx)(dk,{value:d.response_body,onChange:v,placeholder:r(`${dI}.responseBodyPlaceholder`,{ns:"workflow"}),disabled:i})]})]})})]}),(0,x.jsx)(er,{}),(0,x.jsx)("div",{className:"",children:(0,x.jsx)(rG,{collapsed:n,onCollapse:o,children:(0,x.jsx)(dV,{variables:d.variables})})})]})},[eb.BlockEnum.TriggerPlugin]:de},dq=e=>{let t=e.data,a=(0,y.useMemo)(()=>dH[t.type],[t.type]);return(0,x.jsx)(x.Fragment,{children:(0,x.jsx)(aX,{id:e.id,data:e.data,children:(0,x.jsx)(a,{})})})};dq.displayName="CustomNode";let dU=(0,y.memo)(e=>{let t=e.type,a=e.data,r=(0,y.useMemo)(()=>t===S.CUSTOM_NODE?dW[a.type]:()=>null,[t,a.type]);return t===S.CUSTOM_NODE?(0,x.jsx)(ay,{id:e.id,data:e.data,children:(0,x.jsx)(r,{})},e.id):null});dU.displayName="Panel";let dK=(0,y.memo)(dq);e.s(["Panel",0,dU,"default",0,dK],465574);var dG=e.i(276145),dJ=e.i(534042);e.i(444462);var dX=e.i(212838),dQ=e.i(378675),dY=e.i(805429),dY=dY;let dZ=()=>(0,x.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 18 18",fill:"none",children:(0,x.jsx)("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M12 9.75V6H13.5V9.75C13.5 11.8211 11.8211 13.5 9.75 13.5H6V12H9.75C10.9926 12 12 10.9926 12 9.75Z",fill:"black",fillOpacity:"0.16"})}),d0=(0,y.memo)(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),s=(0,eN.useStore)(e=>e.controlPromptEditorRerenderKey),l=(0,y.useRef)(null),n=a.theme,{handleThemeChange:o,handleEditorChange:i,handleShowAuthorChange:d}=(e=>{let{handleNodeDataUpdateWithSyncDraft:t}=(0,Q.useNodeDataUpdate)(),{saveStateToHistory:a}=(0,R.useWorkflowHistory)(),r=(0,y.useCallback)(r=>{t({id:e,data:{theme:r}}),a(R.WorkflowHistoryEvent.NoteChange,{nodeId:e})},[t,e,a]);return{handleThemeChange:r,handleEditorChange:(0,y.useCallback)(a=>{a?.isEmpty()?t({id:e,data:{text:""}}):t({id:e,data:{text:JSON.stringify(a)}})},[t,e]),handleShowAuthorChange:(0,y.useCallback)(r=>{t({id:e,data:{showAuthor:r}}),a(R.WorkflowHistoryEvent.NoteChange,{nodeId:e})},[t,e,a])}})(t),{handleNodesCopy:c,handleNodesDuplicate:u,handleNodeDelete:p}=(0,V.useNodesInteractions)(),{handleNodeDataUpdateWithSyncDraft:m}=(0,Q.useNodeDataUpdate)();(0,a_.useClickAway)(()=>{m({id:t,data:{selected:!1}})},l);let{setShortcutsEnabled:h}=(0,dG.useWorkflowHistoryStore)();return(0,x.jsx)("div",{className:(0,T.cn)("relative flex flex-col rounded-md border shadow-xs hover:shadow-md",dJ.THEME_MAP[n].bg,a.selected?dJ.THEME_MAP[n].border:"border-black/5"),style:{width:a.width,height:a.height},ref:l,children:(0,x.jsx)(dQ.NoteEditorContextProvider,{value:a.text,editable:!a._isTempNode,children:(0,x.jsxs)(x.Fragment,{children:[!a._isTempNode&&(0,x.jsx)(aG,{nodeId:t,nodeData:a,icon:(0,x.jsx)(dZ,{}),minWidth:240,minHeight:88}),(0,x.jsx)("div",{className:(0,T.cn)("h-2 shrink-0 rounded-t-md opacity-50",dJ.THEME_MAP[n].title)}),a.selected&&!a._isTempNode&&(0,x.jsx)("div",{className:"absolute left-1/2 top-[-41px] -translate-x-1/2",children:(0,x.jsx)(dY.default,{theme:n,onThemeChange:o,onCopy:()=>c(t),onDuplicate:()=>u(t),onDelete:()=>p(t),showAuthor:a.showAuthor,onShowAuthorChange:d})}),(0,x.jsx)("div",{className:"grow overflow-y-auto px-3 py-2.5",children:(0,x.jsx)("div",{className:(0,T.cn)(a.selected&&"nodrag nopan nowheel cursor-text"),children:(0,x.jsx)(dX.NoteEditor,{containerElement:l.current,placeholder:r("nodes.note.editor.placeholder",{ns:"workflow"})||"",onChange:i,setShortcutsEnabled:h})})}),a.showAuthor&&(0,x.jsx)("div",{className:"p-3 pt-0 text-xs text-text-tertiary",children:a.author})]})},s)})}),d1=(0,y.memo)(e=>{let{candidateNode:t}=e,a=(0,j.useStoreApi)(),r=(0,j.useReactFlow)(),s=(0,eN.useWorkflowStore)(),l=(0,eN.useStore)(e=>e.mousePosition),{zoom:n}=(0,j.useViewport)(),{handleNodeSelect:o}=(0,V.useNodesInteractions)(),{saveStateToHistory:i}=(0,R.useWorkflowHistory)(),{handleSyncWorkflowDraft:d}=(0,I.useNodesSyncDraft)(),c=(0,E.useAutoGenerateWebhookUrl)();return(0,h.default)("click",e=>{e.preventDefault();let{getNodes:n,setNodes:u}=a.getState(),{screenToFlowPosition:p}=r,m=n(),{x,y:h}=p({x:l.pageX,y:l.pageY});u((0,f.produce)(m,e=>{e.push({...t,data:{...t.data,_isCandidate:!1},position:{x,y:h}}),t.data.type===eb.BlockEnum.Iteration&&e.push((0,e_.getIterationStartNode)(t.id)),t.data.type===eb.BlockEnum.Loop&&e.push((0,e_.getLoopStartNode)(t.id))})),t.type===dJ.CUSTOM_NOTE_NODE?i(R.WorkflowHistoryEvent.NoteAdd,{nodeId:t.id}):i(R.WorkflowHistoryEvent.NodeAdd,{nodeId:t.id}),s.setState({candidateNode:void 0}),t.type===dJ.CUSTOM_NOTE_NODE&&o(t.id),t.data.type===eb.BlockEnum.TriggerWebhook&&d(!0,!0,{onSuccess:()=>c(t.id)})}),(0,h.default)("contextmenu",e=>{e.preventDefault(),s.setState({candidateNode:void 0})}),(0,x.jsxs)("div",{className:"absolute z-10",style:{left:l.elementX,top:l.elementY,transform:`scale(${n})`,transformOrigin:"0 0"},children:[t.type===S.CUSTOM_NODE&&(0,x.jsx)(dK,{...t}),t.type===dJ.CUSTOM_NOTE_NODE&&(0,x.jsx)(d0,{...t})]})}),d2=(0,y.memo)(()=>{let e=(0,eN.useStore)(e=>e.candidateNode);return e?(0,x.jsx)(d1,{candidateNode:e}):null});var d5=e.i(490525),d3=e.i(174383),d4=e.i(735900);let d6=(0,y.memo)(e=>{let{id:t,data:a,source:r,sourceHandleId:s,target:l,targetHandleId:n,sourceX:o,sourceY:i,targetX:d,targetY:c,selected:u}=e,[p,m,h]=(0,j.getBezierPath)({sourceX:o-8,sourceY:i,sourcePosition:j.Position.Right,targetX:d+8,targetY:c,targetPosition:j.Position.Left,curvature:.16}),[g,f]=(0,y.useState)(!1),{handleNodeAdd:b}=(0,V.useNodesInteractions)(),{availablePrevBlocks:v}=(0,X.useAvailableBlocks)(a.targetType,a?.isInIteration||a?.isInLoop),{availableNextBlocks:w}=(0,X.useAvailableBlocks)(a.sourceType,a?.isInIteration||a?.isInLoop),{_sourceRunningStatus:k,_targetRunningStatus:N}=a,C=(0,y.useMemo)(()=>{if((k===eb.NodeRunningStatus.Succeeded||k===eb.NodeRunningStatus.Failed||k===eb.NodeRunningStatus.Exception)&&(N===eb.NodeRunningStatus.Succeeded||N===eb.NodeRunningStatus.Failed||N===eb.NodeRunningStatus.Exception||N===eb.NodeRunningStatus.Running))return t},[k,N,t]),_=(0,y.useCallback)(e=>{f(e)},[]),E=(0,y.useCallback)((e,t)=>{b({nodeType:e,pluginDefaultValue:t},{prevNodeId:r,prevNodeSourceHandle:s||"source",nextNodeId:l,nextNodeTargetHandle:n||"target"})},[b,r,s,l,n]),I=(0,y.useMemo)(()=>u?(0,d4.getEdgeColor)(eb.NodeRunningStatus.Running):C?`url(#${C})`:a?._connectedNodeIsHovering?(0,d4.getEdgeColor)(eb.NodeRunningStatus.Running,s===eH.ErrorHandleTypeEnum.failBranch):(0,d4.getEdgeColor)(),[a._connectedNodeIsHovering,C,u,s]);return(0,x.jsxs)(x.Fragment,{children:[C&&(0,x.jsx)(d3.default,{id:C,startColor:(0,d4.getEdgeColor)(k),stopColor:(0,d4.getEdgeColor)(N),position:{x1:o,y1:i,x2:d,y2:c}}),(0,x.jsx)(j.BaseEdge,{id:t,path:p,style:{stroke:I,strokeWidth:2,opacity:a._dimmed?.3:a._waitingRun?.7:1,strokeDasharray:a._isTemp?"8 8":void 0}}),(0,x.jsx)(j.EdgeLabelRenderer,{children:(0,x.jsx)("div",{className:(0,T.cn)("nopan nodrag hover:scale-125",a?._hovering?"block":"hidden",g&&"!block",a.isInIteration&&`z-[${S.ITERATION_CHILDREN_Z_INDEX}]`,a.isInLoop&&`z-[${S.LOOP_CHILDREN_Z_INDEX}]`),style:{position:"absolute",transform:`translate(-50%, -50%) translate(${m}px, ${h}px)`,pointerEvents:"all",opacity:a._waitingRun?.7:1},children:(0,x.jsx)(eZ.default,{open:g,onOpenChange:_,asChild:!0,onSelect:E,availableBlocksTypes:e1(v,w),triggerClassName:()=>"hover:scale-150 transition-all"})})})]})});var d8=e.i(517317);let d9=(0,y.memo)(e=>{let{top:t,left:a,width:r}=e,{x:s,y:l,zoom:n}=(0,j.useViewport)();return(0,x.jsx)("div",{className:"absolute z-[9] h-px bg-primary-300",style:{top:t*n+l,left:a*n+s,width:r*n}})});d9.displayName="HelpLineBase";let d7=(0,y.memo)(e=>{let{top:t,left:a,height:r}=e,{x:s,y:l,zoom:n}=(0,j.useViewport)();return(0,x.jsx)("div",{className:"absolute z-[9] w-[1px] bg-primary-300",style:{top:t*n+l,left:a*n+s,height:r*n}})});d7.displayName="HelpLineVertical";let ce=(0,y.memo)(()=>{let e=(0,eN.useStore)(e=>e.helpLineHorizontal),t=(0,eN.useStore)(e=>e.helpLineVertical);return e||t?(0,x.jsxs)(x.Fragment,{children:[e&&(0,x.jsx)(d9,{...e}),t&&(0,x.jsx)(d7,{...t})]}):null});var ct=e.i(568603),ca=e.i(77352),cr=e.i(872135),cs=e.i(413741),cl=e.i(892323),cn=e.i(407396),co=e.i(340821),ci=e.i(616332);let cd=(0,y.memo)(()=>{let e=(0,y.useRef)(null),t=(0,ci.default)(),{handleNodeContextmenuCancel:a,handlePaneContextmenuCancel:r}=(0,ct.usePanelInteractions)(),s=(0,eN.useStore)(e=>e.nodeMenu),l=t.find(e=>e.id===s?.nodeId);return((0,y.useEffect)(()=>{s&&r()},[s,r]),(0,a_.useClickAway)(()=>{a()},e),s&&l)?(0,x.jsx)("div",{className:"absolute z-[9]",style:{left:s.left,top:s.top},ref:e,children:(0,x.jsx)(tt,{id:l.id,data:l.data,onClosePopup:()=>a(),showHelpLink:!0})}):null}),cc=(0,y.memo)(e=>{let{id:t,data:a}=e,{t:r}=(0,O.useTranslation)(),{handleReplaceNode:s}=(e=>{let t=(0,j.useStoreApi)(),{nodesMap:a}=(0,Y.useNodesMetaData)();return{handleReplaceNode:(0,y.useCallback)((r,s)=>{let{getNodes:l,setNodes:n}=t.getState(),o=l(),i=o.findIndex(t=>t.id===e);if(i<0)return;let{defaultValue:d}=a[r],c=o[i],{newNode:u}=(0,e_.generateNewNode)({data:{...d,...s},position:{x:c.position.x,y:c.position.y}}),p=(0,f.produce)(o,e=>{e[i]=u});n((0,f.produce)(p,e=>e.filter(e=>!e.data._isTempNode)))},[])}})(t),l=(0,y.useCallback)(()=>(0,x.jsxs)(es.default,{variant:"primary",className:"w-full",children:[(0,x.jsx)(M.RiAddLine,{className:"mr-1 h-4 w-4"}),r("nodes.dataSource.add",{ns:"workflow"})]}),[]);return(0,x.jsxs)("div",{className:(0,T.cn)("relative flex rounded-2xl border","border-transparent"),style:{width:a.width,height:a.height},children:[(0,x.jsx)("div",{className:"absolute inset-[-2px] top-[-22px] z-[-1] rounded-[18px] bg-node-data-source-bg p-0.5 backdrop-blur-[6px]",children:(0,x.jsx)("div",{className:"system-2xs-semibold-uppercase flex h-5 items-center px-2.5 text-text-tertiary",children:r("blocks.datasource",{ns:"workflow"})})}),(0,x.jsx)("div",{className:(0,T.cn)("group relative shadow-xs","rounded-[15px] border border-transparent","w-[240px] bg-workflow-block-bg"),children:(0,x.jsx)("div",{className:(0,T.cn)("flex items-center rounded-t-2xl p-3"),children:(0,x.jsx)(eZ.default,{asChild:!0,onSelect:s,trigger:l,noBlocks:!0,noTools:!0,popupClassName:"w-[320px]",placement:"bottom-start",offset:{mainAxis:4,crossAxis:0}})})})]})});var cu=e.i(974650),cp=e.i(786191),cm=e.i(4520),cx=e.i(234766),ch=e.i(175179);let cg=(0,y.memo)(()=>{let{t:e}=(0,O.useTranslation)(),[t,a]=(0,y.useState)(!1),{nodesReadOnly:r}=(0,Z.useNodesReadOnly)(),{setCurrentLogItem:s,setShowMessageLogModal:l}=(0,L.useStore)((0,P.useShallow)(e=>({appDetail:e.appDetail,setCurrentLogItem:e.setCurrentLogItem,setShowMessageLogModal:e.setShowMessageLogModal}))),n=(0,j.useStoreApi)(),{store:o,getHistoryLabel:i}=(0,R.useWorkflowHistory)(),{pastStates:d,futureStates:c,undo:u,redo:p,clear:m}=o.temporal.getState(),[h,g]=(0,y.useState)(0),f=(0,y.useCallback)(()=>{m(),g(0)},[m]),b=(0,y.useCallback)(e=>{let{index:t}=e,{setEdges:a,setNodes:r}=n.getState(),s=h+t;if(0===s)return;s<0?u(-1*s):p(s);let{edges:l,nodes:i}=o.getState();(0!==l.length||0!==i.length)&&(a(l),r(i))},[h,n,p,o,u]),v=(0,y.useCallback)(t=>{if(!t)return;let a=t<0?-1*t:t;return`${t>0?e("changeHistory.stepForward",{ns:"workflow",count:a}):e("changeHistory.stepBackward",{ns:"workflow",count:a})}`},[e]),w=(0,y.useMemo)(()=>{let e=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e.map((r,s)=>{let l=r.nodes||o.getState().nodes||[],n=r?.workflowHistoryEventMeta?.nodeId,d=l.find(e=>e.id===n)?.data?.title??"";return{label:r.workflowHistoryEvent&&i(r.workflowHistoryEvent),index:a?e.length-1-s-t:s-t,state:{...r,workflowHistoryEventMeta:r.workflowHistoryEventMeta?{...r.workflowHistoryEventMeta,nodeTitle:r.workflowHistoryEventMeta.nodeTitle||d}:void 0}}}).filter(Boolean)},t={pastStates:e(d,d.length).reverse(),futureStates:e([...c,!d.length&&!c.length?void 0:o.getState()].filter(Boolean),0,!0),statesCount:0};return t.statesCount=d.length+c.length,{...t,statesCount:d.length+c.length}},[c,i,d,o]),k=(0,y.useCallback)((e,t)=>e?`${e} ${t}`:t,[]);return(0,x.jsxs)(ez.PortalToFollowElem,{placement:"bottom-end",offset:{mainAxis:4,crossAxis:131},open:t,onOpenChange:a,children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{onClick:()=>!r&&a(e=>!e),children:(0,x.jsx)(ch.default,{title:e("changeHistory.title",{ns:"workflow"}),children:(0,x.jsx)("div",{className:(0,T.cn)("flex h-8 w-8 cursor-pointer items-center justify-center rounded-md text-text-tertiary hover:bg-state-base-hover hover:text-text-secondary",t&&"bg-state-accent-active text-text-accent",r&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"),onClick:()=>{r||(s(),l(!1))},children:(0,x.jsx)(M.RiHistoryLine,{className:"h-4 w-4"})})})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-[12]",children:(0,x.jsxs)("div",{className:"ml-2 flex min-w-[240px] max-w-[360px] flex-col overflow-y-auto rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow-xl backdrop-blur-[5px]",children:[(0,x.jsxs)("div",{className:"sticky top-0 flex items-center justify-between px-4 pt-3",children:[(0,x.jsx)("div",{className:"system-mg-regular grow text-text-secondary",children:e("changeHistory.title",{ns:"workflow"})}),(0,x.jsx)("div",{className:"flex h-6 w-6 shrink-0 cursor-pointer items-center justify-center",onClick:()=>{s(),l(!1),a(!1)},children:(0,x.jsx)(M.RiCloseLine,{className:"h-4 w-4 text-text-secondary"})})]}),(0,x.jsxs)("div",{className:"overflow-y-auto p-2",style:{maxHeight:"calc(1 / 2 * 100vh)"},children:[!w.statesCount&&(0,x.jsxs)("div",{className:"py-12",children:[(0,x.jsx)(M.RiHistoryLine,{className:"mx-auto mb-2 h-8 w-8 text-text-tertiary"}),(0,x.jsx)("div",{className:"text-center text-[13px] text-text-tertiary",children:e("changeHistory.placeholder",{ns:"workflow"})})]}),(0,x.jsxs)("div",{className:"flex flex-col",children:[w.futureStates.map(t=>(0,x.jsx)("div",{className:(0,T.cn)("mb-0.5 flex cursor-pointer rounded-lg px-2 py-[7px] text-text-secondary hover:bg-state-base-hover",t?.index===h&&"bg-state-base-hover"),onClick:()=>{b(t),a(!1)},children:(0,x.jsx)("div",{children:(0,x.jsxs)("div",{className:(0,T.cn)("flex items-center text-[13px] font-medium leading-[18px] text-text-secondary"),children:[k(t?.state?.workflowHistoryEventMeta?.nodeTitle,t?.label||e("changeHistory.sessionStart",{ns:"workflow"}))," ","(",v(t?.index),t?.index===h&&e("changeHistory.currentState",{ns:"workflow"}),")"]})})},t?.index)),w.pastStates.map(t=>(0,x.jsx)("div",{className:(0,T.cn)("mb-0.5 flex cursor-pointer rounded-lg px-2 py-[7px] hover:bg-state-base-hover",t?.index===w.statesCount-1&&"bg-state-base-hover"),onClick:()=>{b(t),a(!1)},children:(0,x.jsx)("div",{children:(0,x.jsxs)("div",{className:(0,T.cn)("flex items-center text-[13px] font-medium leading-[18px] text-text-secondary"),children:[k(t?.state?.workflowHistoryEventMeta?.nodeTitle,t?.label||e("changeHistory.sessionStart",{ns:"workflow"}))," ","(",v(t?.index),")"]})})},t?.index))]})]}),!!w.statesCount&&(0,x.jsxs)("div",{className:"px-0.5",children:[(0,x.jsx)(ss.default,{className:"m-0"}),(0,x.jsx)("div",{className:(0,T.cn)("my-0.5 flex cursor-pointer rounded-lg px-2 py-[7px] text-text-secondary","hover:bg-state-base-hover"),onClick:()=>{f(),a(!1)},children:(0,x.jsx)("div",{children:(0,x.jsx)("div",{className:(0,T.cn)("flex items-center text-[13px] font-medium leading-[18px]"),children:e("changeHistory.clearHistory",{ns:"workflow"})})})})]}),(0,x.jsxs)("div",{className:"w-[240px] px-3 py-2 text-xs text-text-tertiary",children:[(0,x.jsx)("div",{className:"mb-1 flex h-[22px] items-center font-medium uppercase",children:e("changeHistory.hint",{ns:"workflow"})}),(0,x.jsx)("div",{className:"mb-1 leading-[18px] text-text-tertiary",children:e("changeHistory.hintText",{ns:"workflow"})})]})]})})]})}),cf=(0,y.memo)(e=>{let{handleUndo:t,handleRedo:a}=e,{t:r}=(0,O.useTranslation)(),{store:s}=(0,dG.useWorkflowHistoryStore)(),[l,n]=(0,y.useState)({undo:!0,redo:!0});(0,y.useEffect)(()=>{let e=s.temporal.subscribe(e=>{n({undo:0===e.pastStates.length,redo:0===e.futureStates.length})});return()=>e()},[s]);let{nodesReadOnly:o}=(0,Z.useNodesReadOnly)();return(0,x.jsxs)("div",{className:"flex items-center space-x-0.5 rounded-lg border-[0.5px] border-components-actionbar-border bg-components-actionbar-bg p-0.5 shadow-lg backdrop-blur-[5px]",children:[(0,x.jsx)(ch.default,{title:r("common.undo",{ns:"workflow"}),shortcuts:["ctrl","z"],children:(0,x.jsx)("div",{"data-tooltip-id":"workflow.undo",className:(0,T.cn)("system-sm-medium flex h-8 w-8 cursor-pointer select-none items-center rounded-md px-1.5 text-text-tertiary hover:bg-state-base-hover hover:text-text-secondary",(o||l.undo)&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"),onClick:()=>!o&&!l.undo&&t(),children:(0,x.jsx)(M.RiArrowGoBackLine,{className:"h-4 w-4"})})}),(0,x.jsx)(ch.default,{title:r("common.redo",{ns:"workflow"}),shortcuts:["ctrl","y"],children:(0,x.jsx)("div",{"data-tooltip-id":"workflow.redo",className:(0,T.cn)("system-sm-medium flex h-8 w-8 cursor-pointer select-none items-center rounded-md px-1.5 text-text-tertiary hover:bg-state-base-hover hover:text-text-secondary",(o||l.redo)&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"),onClick:()=>!o&&!l.redo&&a(),children:(0,x.jsx)(M.RiArrowGoForwardFill,{className:"h-4 w-4"})})}),(0,x.jsx)(ss.default,{type:"vertical",className:"mx-0.5 h-3.5"}),(0,x.jsx)(cg,{})]})});var cb=e.i(981875);let cy=()=>{let{t:e}=(0,O.useTranslation)(),t=(0,eq.useDocLink)();return(0,x.jsxs)("div",{className:"flex h-full flex-col gap-3 rounded-xl bg-background-section p-8",children:[(0,x.jsx)("div",{className:"flex h-10 w-10 items-center justify-center rounded-[10px] border-[0.5px] border-components-card-border bg-components-card-bg shadow-lg backdrop-blur-sm",children:(0,x.jsx)(r_.Variable02,{className:"h-5 w-5 text-text-accent"})}),(0,x.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,x.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:e("debug.variableInspect.title",{ns:"workflow"})}),(0,x.jsx)("div",{className:"system-xs-regular text-text-tertiary",children:e("debug.variableInspect.emptyTip",{ns:"workflow"})}),(0,x.jsx)("a",{className:"system-xs-regular cursor-pointer text-text-accent",href:t("/use-dify/debug/variable-inspect"),target:"_blank",rel:"noopener noreferrer",children:e("debug.variableInspect.emptyLink",{ns:"workflow"})})]})]})};var cv=e.i(697743);let cw=e=>{let{nodeData:t,currentVar:a,varType:r,varList:s,handleSelect:l,handleView:n,handleClear:o}=e,{t:i}=(0,O.useTranslation)(),[d,c]=(0,y.useState)(!1),u=(0,ee.useToolIcon)(t?.nodePayload),p=r===cb.VarInInspectType.environment,m=r===cb.VarInInspectType.conversation,h=r===cb.VarInInspectType.system,g=p?s:s.filter(e=>e.visible);return(0,x.jsxs)("div",{className:"p-0.5",children:[(0,x.jsxs)("div",{className:"group flex h-6 items-center gap-0.5",children:[(0,x.jsxs)("div",{className:"h-3 w-3 shrink-0",children:[t?.isSingRunRunning&&(0,x.jsx)(M.RiLoader2Line,{className:"h-3 w-3 animate-spin text-text-accent"}),(!t||!t.isSingRunRunning)&&g.length>0&&(0,x.jsx)(M.RiArrowRightSLine,{className:(0,T.cn)("h-3 w-3 text-text-tertiary",!d&&"rotate-90"),onClick:()=>c(!d)})]}),(0,x.jsxs)("div",{className:"flex grow cursor-pointer items-center gap-1",onClick:()=>c(!d),children:[t&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(J.default,{className:"shrink-0",type:t.nodeType,toolIcon:u||"",size:"xs"}),(0,x.jsx)("div",{className:"system-xs-medium-uppercase truncate text-text-tertiary",children:t.title})]}),!t&&(0,x.jsxs)("div",{className:"system-xs-medium-uppercase truncate text-text-tertiary",children:[p&&i("debug.variableInspect.envNode",{ns:"workflow"}),m&&i("debug.variableInspect.chatNode",{ns:"workflow"}),h&&i("debug.variableInspect.systemNode",{ns:"workflow"})]})]}),t&&!t.isSingRunRunning&&(0,x.jsxs)("div",{className:"hidden shrink-0 items-center group-hover:flex",children:[(0,x.jsx)(B.default,{popupContent:i("debug.variableInspect.view",{ns:"workflow"}),children:(0,x.jsx)(rk.default,{onClick:n,children:(0,x.jsx)(M.RiFileList3Line,{className:"h-4 w-4"})})}),(0,x.jsx)(B.default,{popupContent:i("debug.variableInspect.clearNode",{ns:"workflow"}),children:(0,x.jsx)(rk.default,{onClick:o,children:(0,x.jsx)(M.RiDeleteBinLine,{className:"h-4 w-4"})})})]})]}),!d&&!t?.isSingRunRunning&&(0,x.jsx)("div",{className:"px-0.5",children:g.length>0&&g.map(e=>(0,x.jsxs)("div",{className:(0,T.cn)("relative flex cursor-pointer items-center gap-1 rounded-md px-3 py-1 hover:bg-state-base-hover",e.id===a?.var?.id&&"bg-state-base-hover-alt hover:bg-state-base-hover-alt"),onClick:()=>{r===cb.VarInInspectType.environment?l({nodeId:cb.VarInInspectType.environment,title:cb.VarInInspectType.environment,nodeType:cb.VarInInspectType.environment,var:{...e,type:cb.VarInInspectType.environment,..."secret"===e.value_type?{value:"******************"}:{}}}):r===cb.VarInInspectType.conversation?l({nodeId:cb.VarInInspectType.conversation,nodeType:cb.VarInInspectType.conversation,title:cb.VarInInspectType.conversation,var:{...e,type:cb.VarInInspectType.conversation}}):r===cb.VarInInspectType.system?l({nodeId:cb.VarInInspectType.system,nodeType:cb.VarInInspectType.system,title:cb.VarInInspectType.system,var:{...e,type:cb.VarInInspectType.system}}):t&&l({nodeId:t.nodeId,nodeType:t.nodeType,title:t.title,var:e})},children:[(0,x.jsx)(cv.VariableIconWithColor,{variableCategory:r,isExceptionVariable:["error_type","error_message"].includes(e.name),className:"size-4"}),(0,x.jsx)("div",{className:"system-sm-medium grow truncate text-text-secondary",children:e.name}),(0,x.jsx)("div",{className:"system-xs-regular shrink-0 text-text-tertiary",children:e.value_type})]},e.id))})]})},cj=e=>{let{currentNodeVar:t,handleVarSelect:a}=e,{t:r}=(0,O.useTranslation)(),s=(0,eN.useStore)(e=>e.environmentVariables),l=(0,eN.useStore)(e=>e.setCurrentFocusNodeId),{conversationVars:n,systemVars:o,nodesWithInspectVars:i,deleteAllInspectorVars:d,deleteNodeInspectorVars:c}=(0,ea.default)(),{handleNodeSelect:u}=(0,V.useNodesInteractions)(),p=s.length>0||n.length>0||o.length>0;return(0,x.jsxs)("div",{className:(0,T.cn)("flex h-full flex-col"),children:[(0,x.jsxs)("div",{className:"flex shrink-0 items-center justify-between gap-1 pl-4 pr-1 pt-2",children:[(0,x.jsx)("div",{className:"system-sm-semibold-uppercase truncate text-text-primary",children:r("debug.variableInspect.title",{ns:"workflow"})}),(0,x.jsx)(es.default,{variant:"ghost",size:"small",className:"shrink-0",onClick:()=>{d(),l("")},children:r("debug.variableInspect.clearAll",{ns:"workflow"})})]}),(0,x.jsxs)("div",{className:"grow overflow-y-auto py-1",children:[s.length>0&&(0,x.jsx)(cw,{varType:cb.VarInInspectType.environment,varList:s,currentVar:t,handleSelect:a}),n.length>0&&(0,x.jsx)(cw,{varType:cb.VarInInspectType.conversation,varList:n,currentVar:t,handleSelect:a}),o.length>0&&(0,x.jsx)(cw,{varType:cb.VarInInspectType.system,varList:o,currentVar:t,handleSelect:a}),p&&(0,x.jsx)("div",{className:"px-4 py-1",children:(0,x.jsx)("div",{className:"h-px bg-divider-subtle"})}),i.length>0&&i.map(e=>(0,x.jsx)(cw,{varType:cb.VarInInspectType.node,varList:e.vars,nodeData:e,currentVar:t,handleSelect:a,handleView:()=>u(e.nodeId,!1,!0),handleClear:()=>{c(e.nodeId),l("")}},e.nodeId))]})]})};var ck=e.i(854938);e.s(["StopCircle",()=>ck.default],348042);var ck=ck;let cN=e=>{let{onStop:t,message:a}=e,{t:r}=(0,O.useTranslation)(),s=(0,j.useStoreApi)(),l=(0,eN.useStore)(e=>e.listeningTriggerType),n=(0,eN.useStore)(e=>e.listeningTriggerNodeId),o=(0,eN.useStore)(e=>e.listeningTriggerNodeIds),i=(0,eN.useStore)(e=>e.listeningTriggerIsAll),d=(0,ee.useGetToolIcon)(),{getNodes:c}=s.getState(),u=c(),p=n?u.find(e=>e.id===n):void 0,m=p?.data?.type,h=l||m||eb.BlockEnum.TriggerWebhook,g=h===eb.BlockEnum.TriggerWebhook?p?.data?.webhook_debug_url:void 0,[f,b]=(0,y.useState)(!1);(0,y.useEffect)(()=>{if(!f)return;let e=window.setTimeout(()=>{b(!1)},2e3);return()=>{window.clearTimeout(e)}},[f]);let v=[];i?v=o.length>0?u.filter(e=>o.includes(e.id)):u.filter(e=>{let t=e.data?.type;return t===eb.BlockEnum.TriggerSchedule||t===eb.BlockEnum.TriggerWebhook||t===eb.BlockEnum.TriggerPlugin}):p&&(v=[p]);let w=v.map(e=>{let t=e.data?.type||eb.BlockEnum.TriggerWebhook,a=d(e.data);return{key:e.id,type:t,toolIcon:a}});0===w.length&&w.push({key:"default",type:i?eb.BlockEnum.TriggerWebhook:h,toolIcon:!i&&p?d(p.data):void 0});let k=i?((e,t)=>{if(!e.length)return t("debug.variableInspect.listening.tipFallback",{ns:"workflow"});let a=e.map(e=>e.data?.title).filter(e=>!!e);return a.length?t("debug.variableInspect.listening.tip",{ns:"workflow",nodeName:a.join(", ")}):t("debug.variableInspect.listening.tipFallback",{ns:"workflow"})})(v,r):((e,t,a,r)=>{if(e)return e;if(a===eb.BlockEnum.TriggerSchedule){let e=t?.data;return r("debug.variableInspect.listening.tipSchedule",{ns:"workflow",nextTriggerTime:(e?(0,dt.getNextExecutionTime)(e):"")||r("debug.variableInspect.listening.defaultScheduleTime",{ns:"workflow"})})}if(a===eb.BlockEnum.TriggerPlugin){let e=t?.data?.provider_name||t?.data?.title||r("debug.variableInspect.listening.defaultPluginName",{ns:"workflow"});return r("debug.variableInspect.listening.tipPlugin",{ns:"workflow",pluginName:e})}if(a===eb.BlockEnum.TriggerWebhook){let e=t?.data?.title||r("debug.variableInspect.listening.defaultNodeName",{ns:"workflow"});return r("debug.variableInspect.listening.tip",{ns:"workflow",nodeName:e})}let s=t?.data?.desc;return s||r("debug.variableInspect.listening.tipFallback",{ns:"workflow"})})(a,p,h,r);return(0,x.jsxs)("div",{className:"flex h-full flex-col gap-4 rounded-xl bg-background-section p-8",children:[(0,x.jsx)("div",{className:"flex flex-row flex-wrap items-center gap-3",children:w.map(e=>(0,x.jsx)(J.default,{type:e.type,toolIcon:e.toolIcon,size:"md",className:"!h-10 !w-10 !rounded-xl [&_svg]:!h-7 [&_svg]:!w-7"},e.key))}),(0,x.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,x.jsx)("div",{className:"system-sm-semibold text-text-secondary",children:r("debug.variableInspect.listening.title",{ns:"workflow"})}),(0,x.jsx)("div",{className:"system-xs-regular whitespace-pre-line text-text-tertiary",children:k})]}),g&&(0,x.jsxs)("div",{className:"flex items-center gap-2",children:[(0,x.jsx)("div",{className:"system-xs-regular shrink-0 whitespace-pre-line text-text-tertiary",children:r("nodes.triggerWebhook.debugUrlTitle",{ns:"workflow"})}),(0,x.jsx)(B.default,{popupContent:r(f?"nodes.triggerWebhook.debugUrlCopied":"nodes.triggerWebhook.debugUrlCopy",{ns:"workflow"}),popupClassName:"system-xs-regular text-text-primary bg-components-tooltip-bg border border-components-panel-border shadow-lg backdrop-blur-sm rounded-md px-1.5 py-1",position:"top",offset:{mainAxis:-4},needsDelay:!0,children:(0,x.jsx)("button",{type:"button","aria-label":r("nodes.triggerWebhook.debugUrlCopy",{ns:"workflow"})||"",className:`inline-flex items-center rounded-[6px] border border-divider-regular bg-components-badge-white-to-dark px-1.5 py-[2px] font-mono text-[13px] leading-[18px] text-text-secondary transition-colors hover:bg-components-panel-on-panel-item-bg-hover focus:outline-none focus-visible:outline focus-visible:outline-2 focus-visible:outline-components-panel-border ${f?"bg-components-panel-on-panel-item-bg-hover text-text-primary":""}`,onClick:()=>{(0,ak.default)(g),b(!0)},children:(0,x.jsx)("span",{className:"whitespace-nowrap text-text-primary",children:g})})})]}),(0,x.jsx)("div",{children:(0,x.jsxs)(es.default,{size:"medium",className:"px-3",variant:"primary",onClick:t,children:[(0,x.jsx)(ck.default,{className:"mr-1 size-4"}),r("debug.variableInspect.listening.stopButton",{ns:"workflow"})]})})]})};var cC=e.i(772499),c_=e.i(830462),cT=e.i(299075);e.i(237855);var cS=e.i(910605),cE=e.i(832356);let cV=cE.z.array(cE.z.string()),cI=cE.z.array(cE.z.number()),cR=cE.z.union([cE.z.string(),cE.z.number(),cE.z.boolean(),cE.z.null()]),cM=cE.z.lazy(()=>cE.z.union([cR,cE.z.array(cM),cE.z.record(cM)])),cA=cE.z.lazy(()=>cE.z.array(cM));var cO=e.i(711284),cP=e.i(379415),cL=e.i(74548);let cF=y.memo(e=>{let{previewType:t,varType:a,schemaType:r,mdString:s,jsonString:l,readonly:n,handleTextChange:o,handleEditorChange:i,className:d}=e,[c,u]=(0,y.useState)(tA.ViewMode.Code),[p,m]=(0,y.useState)(!1),{t:h}=(0,O.useTranslation)(),g=(0,y.useMemo)(()=>{if(t===tA.PreviewType.Chunks&&r){if("general_structure"===r)return lG.ChunkingMode.text;if("parent_child_structure"===r)return lG.ChunkingMode.parentChild;if("qa_structure"===r)return lG.ChunkingMode.qa}},[t,r]),f=(0,y.useMemo)(()=>{if(t===tA.PreviewType.Chunks&&r&&l&&"parent_child_structure"===r)return JSON.parse(l)?.parent_mode},[t,r,l]);return(0,x.jsxs)("div",{className:(0,T.cn)("flex h-full flex-col rounded-[10px] bg-components-input-bg-normal",p&&"bg-components-input-bg-active outline outline-1 outline-components-input-border-active",d),children:[(0,x.jsxs)("div",{className:"flex shrink-0 items-center justify-end p-1",children:[t===tA.PreviewType.Markdown&&(0,x.jsx)("div",{className:"system-xs-semibold-uppercase flex grow items-center px-2 py-0.5 text-text-secondary",children:t.toUpperCase()}),t===tA.PreviewType.Chunks&&(0,x.jsxs)("div",{className:"system-xs-semibold-uppercase flex grow items-center px-2 py-0.5 text-text-secondary",children:[a.toUpperCase(),r?`(${r})`:""]}),(0,x.jsx)(ox,{options:[{value:tA.ViewMode.Code,text:h("nodes.templateTransform.code",{ns:"workflow"}),Icon:M.RiBracesLine},{value:tA.ViewMode.Preview,text:h("common.preview",{ns:"workflow"}),Icon:M.RiEyeLine}],value:c,onChange:u,size:"small",padding:"with",activeClassName:"!text-text-accent-light-mode-only",btnClassName:"!pl-1.5 !pr-0.5 gap-[3px]",className:"shrink-0"})]}),(0,x.jsxs)("div",{className:"flex flex-1 overflow-auto rounded-b-[10px] pl-3 pr-1",children:[c===tA.ViewMode.Code&&(t===tA.PreviewType.Markdown?(0,x.jsx)(se.default,{readOnly:n,disabled:n,className:"h-full border-none bg-transparent p-0 text-text-secondary hover:bg-transparent focus:bg-transparent focus:shadow-none",value:s,onChange:e=>o?.(e.target.value),onFocus:()=>m(!0),onBlur:()=>m(!1)}):(0,x.jsx)(oV,{readonly:n,className:"overflow-y-auto bg-transparent",hideTopMenu:!0,schema:l,onUpdate:i,onFocus:()=>m(!0),onBlur:()=>m(!1)})),c===tA.ViewMode.Preview&&(t===tA.PreviewType.Markdown?(0,x.jsx)(cP.Markdown,{className:"grow overflow-auto rounded-lg px-4 py-3",content:s??""}):(0,x.jsx)(cL.ChunkCardList,{chunkType:g,parentMode:f,chunkInfo:JSON.parse(l)}))]})]})}),cB=y.memo(e=>{let{currentVar:t,handleValueChange:a,isTruncated:r}=e,s=(0,y.useRef)(null),l=(0,y.useRef)(null),[n,o]=(0,y.useState)(0),i="secret"===t.value_type||"string"===t.value_type||"number"===t.value_type,d="boolean"==typeof t.value,c=Array.isArray(t.value)&&t.value.every(e=>"boolean"==typeof e),u=t.type===cb.VarInInspectType.system&&"files"===t.name,p=!u&&("object"===t.value_type||"array[string]"===t.value_type||"array[number]"===t.value_type||"array[object]"===t.value_type||"array[any]"===t.value_type),m=u||"file"===t.value_type||"array[file]"===t.value_type,h=t.type===cb.VarInInspectType.environment||t.type===cb.VarInInspectType.system&&"query"!==t.name&&"files"!==t.name,g="array[any]"===t.value_type,f=(0,eN.useStore)(e=>e.fileUploadConfig),b=(0,y.useMemo)(()=>!!t.schemaType&&tA.CHUNK_SCHEMA_TYPES.includes(t.schemaType),[t.schemaType]),v=e=>"file"===e.value_type?e.value?(0,eI.getProcessedFilesFromResponse)([e.value]):[]:("array[file]"===e.value_type||e.type===cb.VarInInspectType.system&&"files"===t.name)&&e.value&&e.value.length>0?(0,eI.getProcessedFilesFromResponse)(e.value):[],[w,j]=(0,y.useState)(),[N,C]=(0,y.useState)(""),[_,S]=(0,y.useState)(null),[E,V]=(0,y.useState)(""),[I,R]=(0,y.useState)(()=>v(t)),{run:M}=(0,sp.useDebounceFn)(a,{wait:500});(0,y.useEffect)(()=>{if(i){if("number"===t.value_type)return j(JSON.stringify(t.value));if(!t.value)return j("");j(t.value)}p&&C(null!=t.value?JSON.stringify(t.value,null,2):""),m&&R(v(t))},[t.id,t.value]);let A=e=>{if(r)return;"string"===t.value_type&&j(e),"number"===t.value_type&&/^-?\d+(\.)?(\d+)?$/.test(e)&&j(Number.parseFloat(e));let a="number"===t.value_type?Number.parseFloat(e):e;M(t.id,a)},O=e=>{if(!r&&(C(e),((e,t)=>{try{var a,r;let s=JSON.parse(e);S(null);let l=(a=s,r=t,"array[string]"===r?cV.safeParse(a):"array[number]"===r?cI.safeParse(a):"object"===r?cM.safeParse(a):"array[object]"===r?cA.safeParse(a):{success:!0});if(!l.success)return V(l.error.message),!1;if("object"===t||"array[object]"===t){if((0,oh.checkJsonSchemaDepth)(s)>k.JSON_SCHEMA_MAX_DEPTH)return V(`Schema exceeds maximum depth of ${k.JSON_SCHEMA_MAX_DEPTH}.`),!1;let e=(0,oh.validateSchemaAgainstDraft7)(s);if(e.length>0)return V((0,oh.getValidationErrorMessage)(e)),!1}return V(""),!0}catch(e){if(V(""),e instanceof Error)return S(e),!1;return S(Error("Invalid JSON")),!1}})(e,t.value_type))){let a=JSON.parse(e);M(t.id,a)}};return(0,y.useEffect)(()=>{if(s.current&&l.current){let e=new ResizeObserver(e=>{for(let t of e){let{inlineSize:e}=t.borderBoxSize[0];o(s.current.clientHeight-e)}});return e.observe(l.current),()=>{e.disconnect()}}},[o]),(0,x.jsxs)("div",{ref:s,className:"flex h-full flex-col",children:[(0,x.jsxs)("div",{className:(0,T.cn)("relative grow"),style:{height:`${n}px`},children:[i&&(0,x.jsxs)(x.Fragment,{children:[r&&(0,x.jsx)(oE.default,{className:"absolute left-3 right-3 top-1"}),"string"===t.value_type?(0,x.jsx)(cF,{previewType:tA.PreviewType.Markdown,varType:t.value_type,mdString:w,readonly:h,handleTextChange:A,className:(0,T.cn)(r&&"pt-[36px]")}):(0,x.jsx)(se.default,{readOnly:h,disabled:h||r,className:(0,T.cn)("h-full",r&&"pt-[48px]"),value:w,onChange:e=>A(e.target.value)})]}),d&&(0,x.jsx)("div",{className:"w-[295px]",children:(0,x.jsx)(sr.default,{value:t.value,onChange:e=>{j(e),M(t.id,e)}})}),c&&(0,x.jsx)("div",{className:"w-[295px] space-y-1",children:t.value.map((e,a)=>(0,x.jsx)(sr.default,{value:e,onChange:e=>{let r=[...t.value];r[a]=e,j(r),M(t.id,r)}},a))}),p&&(b?(0,x.jsx)(cF,{previewType:tA.PreviewType.Chunks,varType:t.value_type,schemaType:t.schemaType??"",jsonString:N??"{}",readonly:g,handleEditorChange:O}):(0,x.jsx)(oV,{readonly:g||r,className:"overflow-y-auto",hideTopMenu:!0,schema:N,onUpdate:O,isTruncated:r})),m&&(0,x.jsx)("div",{className:"max-w-[460px]",children:(0,x.jsx)(cS.FileUploaderInAttachmentWrapper,{value:I,onChange:e=>{var a;R(a=(0,eI.getProcessedFiles)(e)),a.every(e=>e.upload_file_id)&&("file"===t.value_type&&M(t.id,a[0]),("array[file]"===t.value_type||u)&&M(t.id,a))},fileConfig:{allowed_file_types:[eb.SupportUploadFileTypes.image,eb.SupportUploadFileTypes.document,eb.SupportUploadFileTypes.audio,eb.SupportUploadFileTypes.video],allowed_file_extensions:[...tb.FILE_EXTS[eb.SupportUploadFileTypes.image],...tb.FILE_EXTS[eb.SupportUploadFileTypes.document],...tb.FILE_EXTS[eb.SupportUploadFileTypes.audio],...tb.FILE_EXTS[eb.SupportUploadFileTypes.video]],allowed_file_upload_methods:[eg.TransferMethod.local_file,eg.TransferMethod.remote_url],number_limits:"file"===t.value_type?1:f?.workflow_file_upload_limit||5,fileUploadConfig:f,preview_config:{mode:cO.PreviewMode.NewPage,file_type_list:["application/pdf"]}},isDisabled:h})})]}),(0,x.jsxs)("div",{ref:l,className:"shrink-0",children:[_&&(0,x.jsx)(og,{className:"mt-1",message:_.message}),E&&(0,x.jsx)(og,{className:"mt-1",message:E})]})]})}),cD=e=>{let t,{nodeId:a,currentNodeVar:r,handleOpenMenu:s,isValueFetching:l}=e,{t:n}=(0,O.useTranslation)(),o=(0,eN.useStore)(e=>e.bottomPanelWidth),i=(0,eN.useStore)(e=>e.setShowVariableInspectPanel),d=(0,eN.useStore)(e=>e.setCurrentFocusNodeId),c=(0,ee.useToolIcon)(r?.nodeData),u=r?.var.is_truncated,p=r?.var.full_content,{resetConversationVar:m,resetToLastRunVar:h,editInspectVarValue:g}=(0,ea.default)(),b=(0,et.useHooksStore)(e=>e.configsMap),{eventEmitter:v}=(0,N.useEventEmitterContextContext)(),{handleNodeSelect:w}=(0,V.useNodesInteractions)(),{node:j}=(0,cT.default)(a),{setInputs:k}=(0,tZ.default)(a,j?.data),C=j?.data?.type,_=C===eb.BlockEnum.Code,S=[eb.BlockEnum.LLM,eb.BlockEnum.Code].includes(C),E=(0,y.useMemo)(()=>S?C===eb.BlockEnum.LLM?j?.data?.prompt_template?.text||j?.data?.prompt_template?.[0].text:C===eb.BlockEnum.Code?j?.data?.code:void 0:"",[S]),[I,{setTrue:R,setFalse:A}]=(0,an.useBoolean)(!1),P=(0,y.useCallback)(()=>{w(a),R()},[R,w,a]),L=(0,y.useCallback)(e=>{k((0,f.produce)(j?.data,t=>{switch(C){case eb.BlockEnum.LLM:t?.prompt_template&&(Array.isArray(t.prompt_template)?t.prompt_template[0].text=e.modified:t.prompt_template.text=e.modified);break;case eb.BlockEnum.Code:t.code=e.modified}})),v?.emit({type:rE.PROMPT_EDITOR_UPDATE_VALUE_BY_EVENT_EMITTER,instanceId:`${a}-chat-workflow-llm-prompt-editor`,payload:e.modified}),A()},[k,C,a,j?.data,A]),F=r?.var.schemaType?`(${r.var.schemaType})`:"";return(0,x.jsxs)("div",{className:(0,T.cn)("flex h-full flex-col"),children:[(0,x.jsxs)("div",{className:"flex shrink-0 items-center justify-between gap-1 px-2 pt-2",children:[o<488&&(0,x.jsx)(rk.default,{className:"shrink-0",onClick:s,children:(0,x.jsx)(M.RiMenuLine,{className:"h-4 w-4"})}),(0,x.jsx)("div",{className:"flex w-0 grow items-center gap-1",children:r?.var&&(0,x.jsxs)(x.Fragment,{children:[[cb.VarInInspectType.environment,cb.VarInInspectType.conversation,cb.VarInInspectType.system].includes(r.nodeType)&&(0,x.jsx)(cv.VariableIconWithColor,{variableCategory:r.nodeType,className:"size-4"}),r.nodeType!==cb.VarInInspectType.environment&&r.nodeType!==cb.VarInInspectType.conversation&&r.nodeType!==cb.VarInInspectType.system&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(J.default,{className:"shrink-0",type:r.nodeType,size:"xs",toolIcon:c}),(0,x.jsx)("div",{className:"system-sm-regular shrink-0 text-text-secondary",children:r.title}),(0,x.jsx)("div",{className:"system-sm-regular shrink-0 text-text-quaternary",children:"/"})]}),(0,x.jsx)("div",{title:r.var.name,className:"system-sm-semibold truncate text-text-secondary",children:r.var.name}),(0,x.jsxs)("div",{className:"system-xs-medium ml-1 shrink-0 space-x-2 text-text-tertiary",children:[(0,x.jsx)("span",{children:`${r.var.value_type}${F}`}),u&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("span",{children:"·"}),(0,x.jsxs)("span",{children:[((p?.size_bytes||0)/1024/1024).toFixed(1),"MB"]})]})]})]})}),(0,x.jsxs)("div",{className:"flex shrink-0 items-center gap-1",children:[r&&(0,x.jsxs)(x.Fragment,{children:[S&&(0,x.jsx)(B.default,{popupContent:n("generate.optimizePromptTooltip",{ns:"appDebug"}),children:(0,x.jsx)("div",{className:"cursor-pointer rounded-md p-1 hover:bg-state-accent-active",onClick:P,children:(0,x.jsx)(M.RiSparklingFill,{className:"size-4 text-components-input-border-active-prompt-1"})})}),u&&(0,x.jsx)(B.default,{popupContent:n("debug.variableInspect.exportToolTip",{ns:"workflow"}),children:(0,x.jsx)(rk.default,{children:(0,x.jsx)("a",{href:p?.download_url,target:"_blank",children:(0,x.jsx)(M.RiFileDownloadFill,{className:"size-4"})})})}),!u&&r.var.edited&&(0,x.jsxs)(r6.default,{children:[(0,x.jsx)("span",{className:"ml-[2.5px] mr-[4.5px] h-[3px] w-[3px] rounded bg-text-accent-secondary"}),(0,x.jsx)("span",{className:"system-2xs-semibold-uupercase",children:n("debug.variableInspect.edited",{ns:"workflow"})})]}),!u&&r.var.edited&&r.var.type!==cb.VarInInspectType.conversation&&(0,x.jsx)(B.default,{popupContent:n("debug.variableInspect.reset",{ns:"workflow"}),children:(0,x.jsx)(rk.default,{onClick:()=>{r&&h(r.nodeId,r.var.id)},children:(0,x.jsx)(M.RiArrowGoBackLine,{className:"h-4 w-4"})})}),!u&&r.var.edited&&r.var.type===cb.VarInInspectType.conversation&&(0,x.jsx)(B.default,{popupContent:n("debug.variableInspect.resetConversationVar",{ns:"workflow"}),children:(0,x.jsx)(rk.default,{onClick:()=>{r&&m(r.var.id)},children:(0,x.jsx)(M.RiArrowGoBackLine,{className:"h-4 w-4"})})}),"secret"!==r.var.value_type&&(0,x.jsx)(cC.default,{content:null==(t=r?.var.value)?"":"object"==typeof t?JSON.stringify(t):String(t)})]}),(0,x.jsx)(rk.default,{onClick:()=>{i(!1),d("")},children:(0,x.jsx)(M.RiCloseLine,{className:"h-4 w-4"})})]})]}),(0,x.jsxs)("div",{className:"grow p-2",children:[!r?.var&&(0,x.jsx)(cy,{}),l&&(0,x.jsx)("div",{className:"flex h-full items-center justify-center",children:(0,x.jsx)(oN.default,{})}),r?.var&&!l&&(0,x.jsx)(cB,{currentVar:r.var,handleValueChange:(e,t)=>{r&&g(r.nodeId,e,t)},isTruncated:!!u},`${r.nodeId}-${r.var.id}`)]}),I&&(_?(0,x.jsx)(c_.default,{isShow:!0,mode:eg.AppModeEnum.CHAT,onClose:A,flowId:b?.flowId||"",nodeId:a,currentCode:E,codeLanguages:j?.data?.code_languages||eD.CodeLanguage.python3,onFinished:L}):(0,x.jsx)(rA.default,{mode:eg.AppModeEnum.CHAT,isShow:!0,onClose:A,onFinished:L,flowId:b?.flowId||"",nodeId:a,currentPrompt:E}))]})},c$=()=>{let{t:e}=(0,O.useTranslation)(),t=(0,eN.useStore)(e=>e.bottomPanelWidth),a=(0,eN.useStore)(e=>e.setShowVariableInspectPanel),[r,s]=(0,y.useState)(!0),l=(0,eN.useStore)(e=>e.isListening),n=(0,eN.useStore)(e=>e.environmentVariables),o=(0,eN.useStore)(e=>e.currentFocusNodeId),i=(0,eN.useStore)(e=>e.setCurrentFocusNodeId),[d,c]=(0,y.useState)(""),{conversationVars:u,systemVars:p,nodesWithInspectVars:m,fetchInspectVarValue:h}=(0,ea.default)(),g=(0,y.useMemo)(()=>0==[...n,...u,...p,...m].length,[n,u,p,m]),f=(0,y.useMemo)(()=>{if(!o)return;if(o===cb.VarInInspectType.environment){let e=n.find(e=>e.id===d),t={nodeId:cb.VarInInspectType.environment,title:cb.VarInInspectType.environment,nodeType:cb.VarInInspectType.environment};return e?{...t,var:{...e,type:cb.VarInInspectType.environment,visible:!0,..."secret"===e.value_type?{value:"******************"}:{}}}:t}if(o===cb.VarInInspectType.conversation){let e=u.find(e=>e.id===d),t={nodeId:cb.VarInInspectType.conversation,title:cb.VarInInspectType.conversation,nodeType:cb.VarInInspectType.conversation};return e?{...t,var:{...e,type:cb.VarInInspectType.conversation}}:t}if(o===cb.VarInInspectType.system){let e=p.find(e=>e.id===d),t={nodeId:cb.VarInInspectType.system,title:cb.VarInInspectType.system,nodeType:cb.VarInInspectType.system};return e?{...t,var:{...e,type:cb.VarInInspectType.system}}:t}let e=m.find(e=>e.nodeId===o);if(!e)return;let t=e.vars.find(e=>e.id===d);return{nodeId:e.nodeId,nodeType:e.nodeType,title:e.title,isSingRunRunning:e.isSingRunRunning,isValueFetched:e.isValueFetched,nodeData:e.nodePayload,...t?{var:t}:{}}},[o,d,n,u,p,m]),b=(0,y.useMemo)(()=>{if(!f)return!1;let e=m.find(e=>e.nodeId===f.nodeId);return!!e&&!e.isValueFetched},[f,m]),v=(0,y.useCallback)(e=>{i(e.nodeId),c(e.var.id)},[i,c]),{isLoading:w,schemaTypeDefinitions:j}=(0,tP.default)(),{eventEmitter:k}=(0,N.useEventEmitterContextContext)(),C=(0,y.useCallback)(()=>{k?.emit({type:tA.EVENT_WORKFLOW_STOP})},[k]);return((0,y.useEffect)(()=>{if(o&&d&&!w){let e=m.find(e=>e.nodeId===o);e&&!e.isValueFetched&&h([o],j)}},[o,d,m,h,j,w]),l)?(0,x.jsxs)("div",{className:(0,T.cn)("flex h-full flex-col"),children:[(0,x.jsxs)("div",{className:"flex shrink-0 items-center justify-between pl-4 pr-2 pt-2",children:[(0,x.jsx)("div",{className:"system-sm-semibold-uppercase text-text-primary",children:e("debug.variableInspect.title",{ns:"workflow"})}),(0,x.jsx)(rk.default,{onClick:()=>a(!1),children:(0,x.jsx)(M.RiCloseLine,{className:"h-4 w-4"})})]}),(0,x.jsx)("div",{className:"grow p-2",children:(0,x.jsx)(cN,{onStop:C})})]}):g?(0,x.jsxs)("div",{className:(0,T.cn)("flex h-full flex-col"),children:[(0,x.jsxs)("div",{className:"flex shrink-0 items-center justify-between pl-4 pr-2 pt-2",children:[(0,x.jsx)("div",{className:"system-sm-semibold-uppercase text-text-primary",children:e("debug.variableInspect.title",{ns:"workflow"})}),(0,x.jsx)(rk.default,{onClick:()=>a(!1),children:(0,x.jsx)(M.RiCloseLine,{className:"h-4 w-4"})})]}),(0,x.jsx)("div",{className:"grow p-2",children:(0,x.jsx)(cy,{})})]}):(0,x.jsxs)("div",{className:(0,T.cn)("relative flex h-full"),children:[t<488&&r&&(0,x.jsx)("div",{className:"absolute left-0 top-0 h-full w-full",onClick:()=>s(!1)}),(0,x.jsx)("div",{className:(0,T.cn)("w-60 shrink-0 border-r border-divider-burn",t<488?r?"absolute left-0 top-0 z-10 h-full w-[217px] rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-lg backdrop-blur-sm":"hidden":"block"),children:(0,x.jsx)(cj,{currentNodeVar:f,handleVarSelect:v})}),(0,x.jsx)("div",{className:"w-0 grow",children:(0,x.jsx)(cD,{nodeId:o,isValueFetching:b,currentNodeVar:f,handleOpenMenu:()=>s(!0)})})]})},cz=()=>{let e=(0,eN.useStore)(e=>e.showVariableInspectPanel),t=(0,eN.useStore)(e=>e.workflowCanvasHeight),a=(0,eN.useStore)(e=>e.variableInspectPanelHeight),r=(0,eN.useStore)(e=>e.setVariableInspectPanelHeight),s=(0,y.useMemo)(()=>t?t-60:480,[t]),l=(0,y.useCallback)((e,t)=>{localStorage.setItem("workflow-variable-inpsect-panel-height",`${t}`),r(t)},[r]),{triggerRef:n,containerRef:o}=(0,eV.useResizePanel)({direction:"vertical",triggerDirection:"top",minHeight:120,maxHeight:s,onResize:(0,A.debounce)(l)});return e?(0,x.jsxs)("div",{className:(0,T.cn)("relative pb-1"),children:[(0,x.jsx)("div",{ref:n,className:"absolute -top-1 left-0 flex h-1 w-full cursor-row-resize resize-y items-center justify-center",children:(0,x.jsx)("div",{className:"h-0.5 w-10 rounded-sm bg-state-base-handle hover:w-full hover:bg-state-accent-solid active:w-full active:bg-state-accent-solid"})}),(0,x.jsx)("div",{ref:o,className:(0,T.cn)("overflow-hidden rounded-2xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-xl"),style:{height:`${a}px`},children:(0,x.jsx)(c$,{})})]}):null},cH=()=>{let{t:e}=(0,O.useTranslation)(),{eventEmitter:t}=(0,N.useEventEmitterContextContext)(),a=(0,eN.useStore)(e=>e.showVariableInspectPanel),r=(0,eN.useStore)(e=>e.setShowVariableInspectPanel),s=(0,eN.useStore)(e=>e.environmentVariables),l=(0,eN.useStore)(e=>e.setCurrentFocusNodeId),{conversationVars:n,systemVars:o,nodesWithInspectVars:i,deleteAllInspectorVars:d}=(0,ea.default)(),c=(0,y.useMemo)(()=>[...s,...n,...o,...i],[s,n,o,i]),{nodesReadOnly:u,getNodesReadOnly:p}=(0,Z.useNodesReadOnly)(),m=(0,eN.useStore)(e=>e.workflowRunningData),h=(0,j.useNodes)(),g=(0,y.useMemo)(()=>h.some(e=>e.data._singleRunningStatus===eb.NodeRunningStatus.Running),[h]),f=(0,y.useMemo)(()=>!!m&&m.result.status===eb.WorkflowRunningStatus.Running,[m]),b=(0,y.useMemo)(()=>f||g,[f,g]);return a?null:(0,x.jsxs)("div",{className:(0,T.cn)("flex items-center gap-1"),children:[!b&&!c.length&&(0,x.jsx)("div",{className:(0,T.cn)("system-2xs-semibold-uppercase flex h-5 cursor-pointer items-center gap-1 rounded-md border-[0.5px] border-effects-highlight bg-components-actionbar-bg px-2 text-text-tertiary shadow-lg backdrop-blur-sm hover:bg-background-default-hover",u&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"),onClick:()=>{p()||r(!0)},children:e("debug.variableInspect.trigger.normal",{ns:"workflow"})}),!b&&c.length>0&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:(0,T.cn)("system-xs-medium flex h-6 cursor-pointer items-center gap-1 rounded-md border-[0.5px] border-effects-highlight bg-components-actionbar-bg px-2 text-text-accent shadow-lg backdrop-blur-sm hover:bg-components-actionbar-bg-accent",u&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"),onClick:()=>{p()||r(!0)},children:e("debug.variableInspect.trigger.cached",{ns:"workflow"})}),(0,x.jsx)("div",{className:(0,T.cn)("system-xs-medium flex h-6 cursor-pointer items-center rounded-md border-[0.5px] border-effects-highlight bg-components-actionbar-bg px-1 text-text-tertiary shadow-lg backdrop-blur-sm hover:bg-components-actionbar-bg-accent hover:text-text-accent",u&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"),onClick:()=>{p()||(d(),l(""))},children:e("debug.variableInspect.trigger.clear",{ns:"workflow"})})]}),b&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)("div",{className:"system-xs-medium flex h-6 cursor-pointer items-center gap-1 rounded-md border-[0.5px] border-effects-highlight bg-components-actionbar-bg px-2 text-text-accent shadow-lg backdrop-blur-sm hover:bg-components-actionbar-bg-accent",onClick:()=>r(!0),children:[(0,x.jsx)(M.RiLoader2Line,{className:"h-4 w-4 animate-spin"}),(0,x.jsx)("span",{className:"text-text-accent",children:e("debug.variableInspect.trigger.running",{ns:"workflow"})})]}),f&&(0,x.jsx)(B.default,{popupContent:e("debug.variableInspect.trigger.stop",{ns:"workflow"}),children:(0,x.jsx)("div",{className:"flex h-6 cursor-pointer items-center rounded-md border-[0.5px] border-effects-highlight bg-components-actionbar-bg px-1 shadow-lg backdrop-blur-sm hover:bg-components-actionbar-bg-accent",onClick:()=>{t?.emit({type:tA.EVENT_WORKFLOW_STOP})},children:(0,x.jsx)(M.RiStopCircleFill,{className:"h-4 w-4 text-text-accent"})})})]})]})};var cW=((u=cW||{}).zoomIn="zoomIn",u.zoomOut="zoomOut",u.zoomToFit="zoomToFit",u.zoomTo25="zoomTo25",u.zoomTo50="zoomTo50",u.zoomTo75="zoomTo75",u.zoomTo100="zoomTo100",u.zoomTo200="zoomTo200",u);let cq=(0,y.memo)(()=>{let{t:e}=(0,O.useTranslation)(),{zoomIn:t,zoomOut:a,zoomTo:r,fitView:s}=(0,j.useReactFlow)(),{zoom:l}=(0,j.useViewport)(),{handleSyncWorkflowDraft:n}=(0,I.useNodesSyncDraft)(),[o,i]=(0,y.useState)(!1),{workflowReadOnly:d,getWorkflowReadOnly:c}=(0,Z.useWorkflowReadOnly)(),u=[[{key:"zoomTo200",text:"200%"},{key:"zoomTo100",text:"100%"},{key:"zoomTo75",text:"75%"},{key:"zoomTo50",text:"50%"},{key:"zoomTo25",text:"25%"}],[{key:"zoomToFit",text:e("operator.zoomToFit",{ns:"workflow"})}]],p=(0,y.useCallback)(()=>{c()||i(e=>!e)},[c]);return(0,x.jsxs)(ez.PortalToFollowElem,{placement:"top-start",open:o,onOpenChange:i,offset:{mainAxis:4,crossAxis:-2},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{asChild:!0,children:(0,x.jsx)("div",{className:`
          h-9 cursor-pointer rounded-lg border-[0.5px] border-components-actionbar-border bg-components-actionbar-bg
          p-0.5 text-[13px] shadow-lg backdrop-blur-[5px]
          hover:bg-state-base-hover
          ${d&&"!cursor-not-allowed opacity-50"}
        `,children:(0,x.jsxs)("div",{className:(0,T.cn)("flex h-8 w-[98px] items-center justify-between rounded-lg"),children:[(0,x.jsx)(ch.default,{title:e("operator.zoomOut",{ns:"workflow"}),shortcuts:["ctrl","-"],children:(0,x.jsx)("div",{className:`flex h-8 w-8 items-center justify-center rounded-lg ${l<=.25?"cursor-not-allowed":"cursor-pointer hover:bg-black/5"}`,onClick:e=>{l<=.25||(e.stopPropagation(),a())},children:(0,x.jsx)(M.RiZoomOutLine,{className:"h-4 w-4 text-text-tertiary hover:text-text-secondary"})})}),(0,x.jsxs)("div",{onClick:p,className:(0,T.cn)("system-sm-medium w-[34px] text-text-tertiary hover:text-text-secondary"),children:[Number.parseFloat(`${100*l}`).toFixed(0),"%"]}),(0,x.jsx)(ch.default,{title:e("operator.zoomIn",{ns:"workflow"}),shortcuts:["ctrl","+"],children:(0,x.jsx)("div",{className:`flex h-8 w-8 items-center justify-center rounded-lg ${l>=2?"cursor-not-allowed":"cursor-pointer hover:bg-black/5"}`,onClick:e=>{l>=2||(e.stopPropagation(),t())},children:(0,x.jsx)(M.RiZoomInLine,{className:"h-4 w-4 text-text-tertiary hover:text-text-secondary"})})})]})})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-10",children:(0,x.jsx)("div",{className:"w-[145px] rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow-lg backdrop-blur-[5px]",children:u.map((e,t)=>(0,x.jsxs)(y.Fragment,{children:[0!==t&&(0,x.jsx)(ss.default,{className:"m-0"}),(0,x.jsx)("div",{className:"p-1",children:e.map(e=>(0,x.jsxs)("div",{className:"system-md-regular flex h-8 cursor-pointer items-center justify-between space-x-1 rounded-lg py-1.5 pl-3 pr-2 text-text-secondary hover:bg-state-base-hover",onClick:()=>{var t;return t=e.key,void(!d&&("zoomToFit"===t&&s(),"zoomTo25"===t&&r(.25),"zoomTo50"===t&&r(.5),"zoomTo75"===t&&r(.75),"zoomTo100"===t&&r(1),"zoomTo200"===t&&r(2),n()))},children:[(0,x.jsx)("span",{children:e.text}),(0,x.jsxs)("div",{className:"flex items-center space-x-0.5",children:["zoomToFit"===e.key&&(0,x.jsx)(e7.default,{keys:["ctrl","1"]}),"zoomTo50"===e.key&&(0,x.jsx)(e7.default,{keys:["shift","5"]}),"zoomTo100"===e.key&&(0,x.jsx)(e7.default,{keys:["shift","1"]})]})]},e.key))})]},t))})})]})}),cU=(0,y.memo)(e=>{let{handleUndo:t,handleRedo:a}=e,r=(0,y.useRef)(null),s=(0,eN.useStore)(e=>e.workflowCanvasWidth),l=(0,eN.useStore)(e=>e.rightPanelWidth),n=(0,eN.useStore)(e=>e.setBottomPanelWidth),o=(0,eN.useStore)(e=>e.setBottomPanelHeight),i=(0,y.useMemo)(()=>s&&l?Math.max(s-l,400):"auto",[s,l]),d=(0,y.useCallback)(e=>e.data?.selected?"bg-workflow-minimap-block border-components-option-card-option-selected-border":"bg-workflow-minimap-block",[]);return(0,y.useEffect)(()=>{if(r.current){let e=new ResizeObserver(e=>{for(let t of e){let{inlineSize:e,blockSize:a}=t.borderBoxSize[0];n(e),o(a)}});return e.observe(r.current),()=>{e.disconnect()}}},[o,n]),(0,x.jsxs)("div",{ref:r,className:"absolute bottom-0 left-0 right-0 z-10 px-1",style:{width:i},children:[(0,x.jsxs)("div",{className:"flex justify-between px-1 pb-2",children:[(0,x.jsx)("div",{className:"flex items-center gap-2",children:(0,x.jsx)(cf,{handleUndo:t,handleRedo:a})}),(0,x.jsx)(cH,{}),(0,x.jsxs)("div",{className:"relative",children:[(0,x.jsx)(cx.MiniMap,{pannable:!0,zoomable:!0,style:{width:102,height:72},maskColor:"var(--color-workflow-minimap-bg)",nodeClassName:d,nodeStrokeWidth:3,className:"!absolute !bottom-10 z-[9] !m-0 !h-[73px] !w-[103px] !rounded-lg !border-[0.5px] !border-divider-subtle !bg-background-default-subtle !shadow-md !shadow-shadow-shadow-5"}),(0,x.jsx)(cq,{})]})]}),(0,x.jsx)(cz,{})]})});var cK=e.i(856105);let cG=(0,y.memo)(e=>{let{renderTrigger:t,offset:a}=e,{t:r}=(0,O.useTranslation)(),s=(0,j.useStoreApi)(),l=(0,eN.useWorkflowStore)(),n=(0,Z.useIsChatMode)(),{nodesReadOnly:o}=(0,Z.useNodesReadOnly)(),{handlePaneContextmenuCancel:i}=(0,ct.usePanelInteractions)(),[d,c]=(0,y.useState)(!1),{availableNextBlocks:u}=(0,X.useAvailableBlocks)(eb.BlockEnum.Start,!1),{nodesMap:p}=(0,Y.useNodesMetaData)(),m=(0,et.useHooksStore)(e=>e.configsMap?.flowType)!==ef.FlowType.ragPipeline&&!n,h=(0,y.useCallback)(e=>{c(e),e||i()},[i]),g=(0,y.useCallback)((e,t)=>{let{getNodes:a}=s.getState(),r=a().filter(t=>t.data.type===e),{defaultValue:n}=p[e],{newNode:o}=(0,e_.generateNewNode)({type:(0,e_.getNodeCustomTypeByNodeDataType)(e),data:{...n,title:r.length>0?`${n.title} ${r.length+1}`:n.title,...t,_isCandidate:!0},position:{x:0,y:0}});l.setState({candidateNode:o})},[s,l,p]),f=(0,y.useCallback)(e=>(0,x.jsx)(ch.default,{title:r("common.addBlock",{ns:"workflow"}),children:(0,x.jsx)("div",{className:(0,T.cn)("flex h-8 w-8 cursor-pointer items-center justify-center rounded-lg text-text-tertiary hover:bg-state-base-hover hover:text-text-secondary",`${o&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"}`,e&&"bg-state-accent-active text-text-accent"),children:(0,x.jsx)(M.RiAddCircleFill,{className:"h-4 w-4"})})}),[o,r]);return(0,x.jsx)(eZ.default,{open:d,onOpenChange:h,disabled:o,onSelect:g,placement:"right-start",offset:a??{mainAxis:4,crossAxis:-8},trigger:t||f,popupClassName:"!min-w-[256px]",availableBlocksTypes:u,showStartTab:m})});var cJ=e.i(141167);let cX=()=>{let e=(0,eN.useWorkflowStore)(),{userProfile:t}=(0,nS.useAppContext)();return{handleAddNote:(0,y.useCallback)(()=>{let{newNode:a}=(0,e_.generateNewNode)({type:dJ.CUSTOM_NOTE_NODE,data:{title:"",desc:"",type:"",text:"",theme:cJ.NoteTheme.blue,author:t?.name||"",showAuthor:!0,width:240,height:88,_isCandidate:!0},position:{x:0,y:0}});e.setState({candidateNode:a})},[e,t])}};var cQ=e.i(604193);let cY=(a=0,()=>(a+=1,`u${`0000${(1679616*Math.random()|0).toString(36)}`.slice(-4)}${a}`));function cZ(e){let t=[];for(let a=0,r=e.length;a<r;a++)t.push(e[a]);return t}let c0=null;function c1(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return c0||(c0=e.includeStyleProperties?e.includeStyleProperties:cZ(window.getComputedStyle(document.documentElement)))}function c2(e,t){let a=(e.ownerDocument.defaultView||window).getComputedStyle(e).getPropertyValue(t);return a?parseFloat(a.replace("px","")):0}function c5(e){let t,a,r,s,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return{width:l.width||(t=c2(e,"border-left-width"),a=c2(e,"border-right-width"),e.clientWidth+t+a),height:l.height||(r=c2(e,"border-top-width"),s=c2(e,"border-bottom-width"),e.clientHeight+r+s)}}function c3(e){return new Promise((t,a)=>{let r=new Image;r.onload=()=>{r.decode().then(()=>{requestAnimationFrame(()=>t(r))})},r.onerror=a,r.crossOrigin="anonymous",r.decoding="async",r.src=e})}async function c4(e){return Promise.resolve().then(()=>new XMLSerializer().serializeToString(e)).then(encodeURIComponent).then(e=>`data:image/svg+xml;charset=utf-8,${e}`)}async function c6(e,t,a){let r="http://www.w3.org/2000/svg",s=document.createElementNS(r,"svg"),l=document.createElementNS(r,"foreignObject");return s.setAttribute("width",`${t}`),s.setAttribute("height",`${a}`),s.setAttribute("viewBox",`0 0 ${t} ${a}`),l.setAttribute("width","100%"),l.setAttribute("height","100%"),l.setAttribute("x","0"),l.setAttribute("y","0"),l.setAttribute("externalResourcesRequired","true"),s.appendChild(l),l.appendChild(e),c4(s)}let c8=(e,t)=>{if(e instanceof t)return!0;let a=Object.getPrototypeOf(e);return null!==a&&(a.constructor.name===t.name||c8(a,t))};function c9(e,t,a,r){let s,l,n,o=window.getComputedStyle(e,a),i=o.getPropertyValue("content");if(""===i||"none"===i)return;let d=cY();try{t.className=`${t.className} ${d}`}catch(e){return}let c=document.createElement("style");c.appendChild((s=`.${d}:${a}`,n=o.cssText?(l=o.getPropertyValue("content"),`${o.cssText} content: '${l.replace(/'|"/g,"")}';`):c1(r).map(e=>{let t=o.getPropertyValue(e),a=o.getPropertyPriority(e);return`${e}: ${t}${a?" !important":""};`}).join(" "),document.createTextNode(`${s}{${n}}`))),t.appendChild(c)}let c7="application/font-woff",ue="image/jpeg",ut={woff:c7,woff2:c7,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:ue,jpeg:ue,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml",webp:"image/webp"};function ua(e){let t;return ut[((t=/\.([^./]*?)$/g.exec(e))?t[1]:"").toLowerCase()]||""}function ur(e){return -1!==e.search(/^(data:)/)}function us(e,t){return`data:${t};base64,${e}`}async function ul(e,t,a){let r=await fetch(e,t);if(404===r.status)throw Error(`Resource "${r.url}" not found`);let s=await r.blob();return new Promise((e,t)=>{let l=new FileReader;l.onerror=t,l.onloadend=()=>{try{e(a({res:r,result:l.result}))}catch(e){t(e)}},l.readAsDataURL(s)})}let un={};async function uo(e,t,a){var r,s,l;let n,o,i=(r=e,s=t,l=a.includeQueryParams,o=r.replace(/\?.*/,""),l&&(o=r),/ttf|otf|eot|woff2?/i.test(o)&&(o=o.replace(/.*\//,"")),s?`[${s}]${o}`:o);if(null!=un[i])return un[i];a.cacheBust&&(e+=(/\?/.test(e)?"&":"?")+new Date().getTime());try{let r=await ul(e,a.fetchRequestInit,e=>{let{res:a,result:r}=e;return t||(t=a.headers.get("Content-Type")||""),r.split(/,/)[1]});n=us(r,t)}catch(r){n=a.imagePlaceholder||"";let t=`Failed to fetch resource: ${e}`;r&&(t="string"==typeof r?r:r.message),t&&console.warn(t)}return un[i]=n,n}async function ui(e){let t=e.toDataURL();return"data:,"===t?e.cloneNode(!1):c3(t)}async function ud(e,t){if(e.currentSrc){let t=document.createElement("canvas"),a=t.getContext("2d");return t.width=e.clientWidth,t.height=e.clientHeight,null==a||a.drawImage(e,0,0,t.width,t.height),c3(t.toDataURL())}let a=e.poster,r=ua(a);return c3(await uo(a,r,t))}async function uc(e,t){var a;try{if(null==(a=null==e?void 0:e.contentDocument)?void 0:a.body)return await uh(e.contentDocument.body,t,!0)}catch(e){}return e.cloneNode(!1)}async function uu(e,t){return c8(e,HTMLCanvasElement)?ui(e):c8(e,HTMLVideoElement)?ud(e,t):c8(e,HTMLIFrameElement)?uc(e,t):e.cloneNode(up(e))}let up=e=>null!=e.tagName&&"SVG"===e.tagName.toUpperCase();async function um(e,t,a){var r,s;if(up(t))return t;let l=[];return 0===(l=null!=e.tagName&&"SLOT"===e.tagName.toUpperCase()&&e.assignedNodes?cZ(e.assignedNodes()):c8(e,HTMLIFrameElement)&&(null==(r=e.contentDocument)?void 0:r.body)?cZ(e.contentDocument.body.childNodes):cZ((null!=(s=e.shadowRoot)?s:e).childNodes)).length||c8(e,HTMLVideoElement)||await l.reduce((e,r)=>e.then(()=>uh(r,a)).then(e=>{e&&t.appendChild(e)}),Promise.resolve()),t}async function ux(e,t){let a=e.querySelectorAll?e.querySelectorAll("use"):[];if(0===a.length)return e;let r={};for(let s=0;s<a.length;s++){let l=a[s].getAttribute("xlink:href");if(l){let a=e.querySelector(l),s=document.querySelector(l);a||!s||r[l]||(r[l]=await uh(s,t,!0))}}let s=Object.values(r);if(s.length){let t="http://www.w3.org/1999/xhtml",a=document.createElementNS(t,"svg");a.setAttribute("xmlns",t),a.style.position="absolute",a.style.width="0",a.style.height="0",a.style.overflow="hidden",a.style.display="none";let r=document.createElementNS(t,"defs");a.appendChild(r);for(let e=0;e<s.length;e++)r.appendChild(s[e]);e.appendChild(a)}return e}async function uh(e,t,a){return a||!t.filter||t.filter(e)?Promise.resolve(e).then(e=>uu(e,t)).then(a=>um(e,a,t)).then(a=>(function(e,t,a){if(c8(t,Element)&&(!function(e,t,a){let r=t.style;if(!r)return;let s=window.getComputedStyle(e);s.cssText?(r.cssText=s.cssText,r.transformOrigin=s.transformOrigin):c1(a).forEach(a=>{let l=s.getPropertyValue(a);if("font-size"===a&&l.endsWith("px")){let e=Math.floor(parseFloat(l.substring(0,l.length-2)))-.1;l=`${e}px`}c8(e,HTMLIFrameElement)&&"display"===a&&"inline"===l&&(l="block"),"d"===a&&t.getAttribute("d")&&(l=`path(${t.getAttribute("d")})`),r.setProperty(a,l,s.getPropertyPriority(a))})}(e,t,a),c9(e,t,":before",a),c9(e,t,":after",a),c8(e,HTMLTextAreaElement)&&(t.innerHTML=e.value),c8(e,HTMLInputElement)&&t.setAttribute("value",e.value),c8(e,HTMLSelectElement))){let a=Array.from(t.children).find(t=>e.value===t.getAttribute("value"));a&&a.setAttribute("selected","")}return t})(e,a,t)).then(e=>ux(e,t)):null}let ug=/url\((['"]?)([^'"]+?)\1\)/g,uf=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,ub=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;async function uy(e,t,a,r,s){try{let l,n,o=a?function(e,t){if(e.match(/^[a-z]+:\/\//i))return e;if(e.match(/^\/\//))return window.location.protocol+e;if(e.match(/^[a-z]+:/i))return e;let a=document.implementation.createHTMLDocument(),r=a.createElement("base"),s=a.createElement("a");return a.head.appendChild(r),a.body.appendChild(s),t&&(r.href=t),s.href=e,s.href}(t,a):t,i=ua(t);if(s){let e=await s(o);l=us(e,i)}else l=await uo(o,i,r);return e.replace((n=t.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1"),RegExp(`(url\\(['"]?)(${n})(['"]?\\))`,"g")),`$1${l}$3`)}catch(e){}return e}function uv(e){return -1!==e.search(ug)}async function uw(e,t,a){let r;if(!uv(e))return e;let s=function(e,t){let{preferredFontFormat:a}=t;return a?e.replace(ub,e=>{for(;;){let[t,,r]=uf.exec(e)||[];if(!r)return"";if(r===a)return`src: ${t};`}}):e}(e,a);return(r=[],s.replace(ug,(e,t,a)=>(r.push(a),e)),r.filter(e=>!ur(e))).reduce((e,r)=>e.then(e=>uy(e,r,t,a)),Promise.resolve(s))}async function uj(e,t,a){var r;let s=null==(r=t.style)?void 0:r.getPropertyValue(e);if(s){let r=await uw(s,null,a);return t.style.setProperty(e,r,t.style.getPropertyPriority(e)),!0}return!1}async function uk(e,t){await uj("background",e,t)||await uj("background-image",e,t),await uj("mask",e,t)||await uj("-webkit-mask",e,t)||await uj("mask-image",e,t)||await uj("-webkit-mask-image",e,t)}async function uN(e,t){let a=c8(e,HTMLImageElement);if(!(a&&!ur(e.src))&&!(c8(e,SVGImageElement)&&!ur(e.href.baseVal)))return;let r=a?e.src:e.href.baseVal,s=await uo(r,ua(r),t);await new Promise((r,l)=>{e.onload=r,e.onerror=t.onImageErrorHandler?function(){for(var e=arguments.length,a=Array(e),s=0;s<e;s++)a[s]=arguments[s];try{r(t.onImageErrorHandler(...a))}catch(e){l(e)}}:l,e.decode&&(e.decode=r),"lazy"===e.loading&&(e.loading="eager"),a?(e.srcset="",e.src=s):e.href.baseVal=s})}async function uC(e,t){let a=cZ(e.childNodes).map(e=>u_(e,t));await Promise.all(a).then(()=>e)}async function u_(e,t){c8(e,Element)&&(await uk(e,t),await uN(e,t),await uC(e,t))}let uT={};async function uS(e){let t=uT[e];if(null!=t)return t;let a=await fetch(e);return t={url:e,cssText:await a.text()},uT[e]=t,t}async function uE(e,t){let a=e.cssText,r=/url\(["']?([^"')]+)["']?\)/g;return Promise.all((a.match(/url\([^)]+\)/g)||[]).map(async s=>{let l=s.replace(r,"$1");return l.startsWith("https://")||(l=new URL(l,e.url).href),ul(l,t.fetchRequestInit,e=>{let{result:t}=e;return a=a.replace(s,`url(${t})`),[s,t]})})).then(()=>a)}function uV(e){if(null==e)return[];let t=[],a=e.replace(/(\/\*[\s\S]*?\*\/)/gi,""),r=RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi");for(;;){let e=r.exec(a);if(null===e)break;t.push(e[0])}a=a.replace(r,"");let s=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi,l=RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");for(;;){let e=s.exec(a);if(null===e){if(null===(e=l.exec(a)))break;s.lastIndex=l.lastIndex}else l.lastIndex=s.lastIndex;t.push(e[0])}return t}async function uI(e,t){let a=[],r=[];return e.forEach(a=>{if("cssRules"in a)try{cZ(a.cssRules||[]).forEach((e,s)=>{if(e.type===CSSRule.IMPORT_RULE){let l=s+1,n=e.href,o=uS(n).then(e=>uE(e,t)).then(e=>uV(e).forEach(e=>{try{a.insertRule(e,e.startsWith("@import")?l+=1:a.cssRules.length)}catch(t){console.error("Error inserting rule from remote css",{rule:e,error:t})}})).catch(e=>{console.error("Error loading remote css",e.toString())});r.push(o)}})}catch(l){let s=e.find(e=>null==e.href)||document.styleSheets[0];null!=a.href&&r.push(uS(a.href).then(e=>uE(e,t)).then(e=>uV(e).forEach(e=>{s.insertRule(e,s.cssRules.length)})).catch(e=>{console.error("Error loading remote stylesheet",e)})),console.error("Error inlining remote css file",l)}}),Promise.all(r).then(()=>(e.forEach(e=>{if("cssRules"in e)try{cZ(e.cssRules||[]).forEach(e=>{a.push(e)})}catch(t){console.error(`Error while reading CSS rules from ${e.href}`,t)}}),a))}async function uR(e,t){if(null==e.ownerDocument)throw Error("Provided element is not within a Document");let a=cZ(e.ownerDocument.styleSheets);return(await uI(a,t)).filter(e=>e.type===CSSRule.FONT_FACE_RULE).filter(e=>uv(e.style.getPropertyValue("src")))}function uM(e){return e.trim().replace(/["']/g,"")}async function uA(e,t){let a,r=await uR(e,t),s=(a=new Set,!function e(t){(t.style.fontFamily||getComputedStyle(t).fontFamily).split(",").forEach(e=>{a.add(uM(e))}),Array.from(t.children).forEach(t=>{t instanceof HTMLElement&&e(t)})}(e),a);return(await Promise.all(r.filter(e=>s.has(uM(e.style.fontFamily))).map(e=>{let a=e.parentStyleSheet?e.parentStyleSheet.href:null;return uw(e.cssText,a,t)}))).join("\n")}async function uO(e,t){let a=null!=t.fontEmbedCSS?t.fontEmbedCSS:t.skipFonts?null:await uA(e,t);if(a){let t=document.createElement("style"),r=document.createTextNode(a);t.appendChild(r),e.firstChild?e.insertBefore(t,e.firstChild):e.appendChild(t)}}async function uP(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{width:a,height:r}=c5(e,t),s=await uh(e,t,!0);return await uO(s,t),await u_(s,t),!function(e,t){let{style:a}=e;t.backgroundColor&&(a.backgroundColor=t.backgroundColor),t.width&&(a.width=`${t.width}px`),t.height&&(a.height=`${t.height}px`);let r=t.style;null!=r&&Object.keys(r).forEach(e=>{a[e]=r[e]})}(s,t),await c6(s,a,r)}async function uL(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{width:a,height:r}=c5(e,t),s=await uP(e,t),l=await c3(s),n=document.createElement("canvas"),o=n.getContext("2d"),i=t.pixelRatio||function(){let e,t;try{t=cQ.default}catch(e){}let a=t&&t.env?t.env.devicePixelRatio:null;return a&&Number.isNaN(e=parseInt(a,10))&&(e=1),e||window.devicePixelRatio||1}(),d=t.canvasWidth||a,c=t.canvasHeight||r;return n.width=d*i,n.height=c*i,!t.skipAutoScale&&(n.width>16384||n.height>16384)&&(n.width>16384&&n.height>16384?n.width>n.height?(n.height*=16384/n.width,n.width=16384):(n.width*=16384/n.height,n.height=16384):n.width>16384?(n.height*=16384/n.width,n.width=16384):(n.width*=16384/n.height,n.height=16384)),n.style.width=`${d}`,n.style.height=`${c}`,t.backgroundColor&&(o.fillStyle=t.backgroundColor,o.fillRect(0,0,n.width,n.height)),o.drawImage(l,0,0,n.width,n.height),n}async function uF(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(await uL(e,t)).toDataURL()}async function uB(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(await uL(e,t)).toDataURL("image/jpeg",t.quality||1)}var uD=e.i(998020),u$=e.i(618403);let uz=(0,y.memo)(()=>{let{t:e}=(0,O.useTranslation)(),{getNodesReadOnly:t}=(0,Z.useNodesReadOnly)(),a=(0,j.useReactFlow)(),[r,s]=(0,y.useState)(!1),[l,n]=(0,y.useState)(""),[o,i]=(0,y.useState)(""),d=(0,eN.useStore)(e=>e.knowledgeName),c=(0,eN.useStore)(e=>e.appName),u=(0,eN.useStore)(e=>e.maximizeCanvas),{appSidebarExpand:p}=(0,L.useStore)((0,P.useShallow)(e=>({appSidebarExpand:e.appSidebarExpand}))),m=(0,y.useMemo)(()=>u?40:"expand"===p?188:40,[p,u]),h=(0,y.useCallback)(async function(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!c&&!d||t())return;s(!1);let l=document.querySelector(".react-flow__viewport");if(l)try{let t,s=c||d,o=e=>!(e instanceof HTMLImageElement)||e.complete&&0!==e.naturalHeight;if(r){let r=a.getNodes(),n=(0,j.getNodesBounds)(r),i=a.getViewport(),d=window.innerWidth,c=window.innerHeight,u=Math.min(d/(n.width+100),c/(n.height+100),1),p=n.x+n.width/2,m=n.y+n.height/2;a.setViewport({x:d/2-p*u,y:c/2-m*u,zoom:u}),await new Promise(e=>setTimeout(e,300));let x=n.width+100,h=n.height+100,g={filter:o,backgroundColor:"#1a1a1a",pixelRatio:2,width:x,height:h,style:{width:`${x}px`,height:`${h}px`,transform:`translate(${50-n.x}px, ${50-n.y}px)`,transformOrigin:"top left"}};switch(e){case"png":default:t=await uF(l,g);break;case"jpeg":t=await uB(l,g);break;case"svg":t=await uP(l,{filter:o})}s+="-whole-workflow",setTimeout(()=>{a.setViewport(i)},500)}else switch(e){case"png":default:t=await uF(l,{filter:o});break;case"jpeg":t=await uB(l,{filter:o});break;case"svg":t=await uP(l,{filter:o})}let u=`${s}.${e}`;r&&(n(t),i(u)),(0,u$.downloadUrl)({url:t,fileName:u})}catch(e){console.error("Export image failed:",e)}},[t,c,a,d]),g=(0,y.useCallback)(()=>{t()||s(e=>!e)},[t]);return(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)(ez.PortalToFollowElem,{open:r,onOpenChange:s,placement:"bottom-end",offset:{mainAxis:-200,crossAxis:m},children:[(0,x.jsx)(ez.PortalToFollowElemTrigger,{children:(0,x.jsx)(ch.default,{title:e("common.moreActions",{ns:"workflow"}),children:(0,x.jsx)("div",{className:(0,T.cn)("flex h-8 w-8 cursor-pointer items-center justify-center rounded-lg hover:bg-state-base-hover hover:text-text-secondary",`${t()&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"}`),onClick:g,children:(0,x.jsx)(M.RiMoreFill,{className:"h-4 w-4"})})})}),(0,x.jsx)(ez.PortalToFollowElemContent,{className:"z-10",children:(0,x.jsx)("div",{className:"min-w-[180px] rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg-blur text-text-secondary shadow-lg",children:(0,x.jsxs)("div",{className:"p-1",children:[(0,x.jsxs)("div",{className:"flex items-center gap-2 px-2 py-1 text-xs font-medium text-text-tertiary",children:[(0,x.jsx)(M.RiExportLine,{className:"h-3 w-3"}),e("common.exportImage",{ns:"workflow"})]}),(0,x.jsx)("div",{className:"px-2 py-1 text-xs font-medium text-text-tertiary",children:e("common.currentView",{ns:"workflow"})}),(0,x.jsx)("div",{className:"system-md-regular flex h-8 cursor-pointer items-center rounded-lg px-2 hover:bg-state-base-hover",onClick:()=>h("png"),children:e("common.exportPNG",{ns:"workflow"})}),(0,x.jsx)("div",{className:"system-md-regular flex h-8 cursor-pointer items-center rounded-lg px-2 hover:bg-state-base-hover",onClick:()=>h("jpeg"),children:e("common.exportJPEG",{ns:"workflow"})}),(0,x.jsx)("div",{className:"system-md-regular flex h-8 cursor-pointer items-center rounded-lg px-2 hover:bg-state-base-hover",onClick:()=>h("svg"),children:e("common.exportSVG",{ns:"workflow"})}),(0,x.jsx)("div",{className:"border-border-divider mx-2 my-1 border-t"}),(0,x.jsx)("div",{className:"px-2 py-1 text-xs font-medium text-text-tertiary",children:e("common.currentWorkflow",{ns:"workflow"})}),(0,x.jsx)("div",{className:"system-md-regular flex h-8 cursor-pointer items-center rounded-lg px-2 hover:bg-state-base-hover",onClick:()=>h("png",!0),children:e("common.exportPNG",{ns:"workflow"})}),(0,x.jsx)("div",{className:"system-md-regular flex h-8 cursor-pointer items-center rounded-lg px-2 hover:bg-state-base-hover",onClick:()=>h("jpeg",!0),children:e("common.exportJPEG",{ns:"workflow"})}),(0,x.jsx)("div",{className:"system-md-regular flex h-8 cursor-pointer items-center rounded-lg px-2 hover:bg-state-base-hover",onClick:()=>h("svg",!0),children:e("common.exportSVG",{ns:"workflow"})})]})})})]}),l&&(0,x.jsx)(uD.default,{url:l,title:o,onCancel:()=>n("")})]})}),uH=(0,y.memo)(()=>{let{t:e}=(0,O.useTranslation)(),t=(0,eN.useStore)(e=>e.controlMode),a=(0,eN.useStore)(e=>e.maximizeCanvas),{handleModePointer:r,handleModeHand:s}=(0,cK.useWorkflowMoveMode)(),{handleLayout:l}=(0,cK.useWorkflowOrganize)(),{handleAddNote:n}=cX(),{nodesReadOnly:o,getNodesReadOnly:i}=(0,Z.useNodesReadOnly)(),{handleToggleMaximizeCanvas:d}=(0,cK.useWorkflowCanvasMaximize)();return(0,x.jsxs)("div",{className:"pointer-events-auto flex flex-col items-center rounded-lg border-[0.5px] border-components-actionbar-border bg-components-actionbar-bg p-0.5 text-text-tertiary shadow-lg",children:[(0,x.jsx)(cG,{}),(0,x.jsx)(ch.default,{title:e("nodes.note.addNote",{ns:"workflow"}),children:(0,x.jsx)("div",{className:(0,T.cn)("ml-[1px] flex h-8 w-8 cursor-pointer items-center justify-center rounded-lg hover:bg-state-base-hover hover:text-text-secondary",`${o&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"}`),onClick:e=>{i()||(e.stopPropagation(),n())},children:(0,x.jsx)(M.RiStickyNoteAddLine,{className:"h-4 w-4"})})}),(0,x.jsx)(ss.default,{className:"my-1 w-3.5"}),(0,x.jsx)(ch.default,{title:e("common.pointerMode",{ns:"workflow"}),shortcuts:["v"],children:(0,x.jsx)("div",{className:(0,T.cn)("mr-[1px] flex h-8 w-8 cursor-pointer items-center justify-center rounded-lg",t===eb.ControlMode.Pointer?"bg-state-accent-active text-text-accent":"hover:bg-state-base-hover hover:text-text-secondary",`${o&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"}`),onClick:r,children:(0,x.jsx)(M.RiCursorLine,{className:"h-4 w-4"})})}),(0,x.jsx)(ch.default,{title:e("common.handMode",{ns:"workflow"}),shortcuts:["h"],children:(0,x.jsx)("div",{className:(0,T.cn)("flex h-8 w-8 cursor-pointer items-center justify-center rounded-lg",t===eb.ControlMode.Hand?"bg-state-accent-active text-text-accent":"hover:bg-state-base-hover hover:text-text-secondary",`${o&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"}`),onClick:s,children:(0,x.jsx)(M.RiHand,{className:"h-4 w-4"})})}),(0,x.jsx)(ss.default,{className:"my-1 w-3.5"}),(0,x.jsx)(ch.default,{title:e("panel.organizeBlocks",{ns:"workflow"}),shortcuts:["ctrl","o"],children:(0,x.jsx)("div",{className:(0,T.cn)("flex h-8 w-8 cursor-pointer items-center justify-center rounded-lg hover:bg-state-base-hover hover:text-text-secondary",`${o&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"}`),onClick:l,children:(0,x.jsx)(M.RiFunctionAddLine,{className:"h-4 w-4"})})}),(0,x.jsx)(ch.default,{title:e(a?"panel.minimize":"panel.maximize",{ns:"workflow"}),shortcuts:["f"],children:(0,x.jsxs)("div",{className:(0,T.cn)("flex h-8 w-8 cursor-pointer items-center justify-center rounded-lg hover:bg-state-base-hover hover:text-text-secondary",a?"bg-state-accent-active text-text-accent hover:text-text-accent":"hover:bg-state-base-hover hover:text-text-secondary",`${o&&"cursor-not-allowed text-text-disabled hover:bg-transparent hover:text-text-disabled"}`),onClick:d,children:[a&&(0,x.jsx)(M.RiAspectRatioFill,{className:"h-4 w-4"}),!a&&(0,x.jsx)(M.RiAspectRatioLine,{className:"h-4 w-4"})]})}),(0,x.jsx)(uz,{})]})});var uW=e.i(804612),uq=e.i(886485);let uU=(0,y.memo)(()=>{let{t:e}=(0,O.useTranslation)(),t=(0,y.useRef)(null),a=(0,eN.useStore)(e=>e.panelMenu),r=(0,eN.useStore)(e=>e.clipboardElements),s=(0,eN.useStore)(e=>e.setShowImportDSLModal),{handleNodesPaste:l}=(0,V.useNodesInteractions)(),{handlePaneContextmenuCancel:n,handleNodeContextmenuCancel:o}=(0,ct.usePanelInteractions)(),{handleStartWorkflowRun:i}=(0,uq.useWorkflowStartRun)(),{handleAddNote:d}=cX(),{exportCheck:c}=(0,uW.useDSL)();return((0,y.useEffect)(()=>{a&&o()},[a,o]),(0,a_.useClickAway)(()=>{n()},t),a)?(0,x.jsxs)("div",{className:"absolute z-[9] w-[200px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg-blur shadow-lg",style:{left:a.left,top:a.top},ref:t,children:[(0,x.jsxs)("div",{className:"p-1",children:[(0,x.jsx)(cG,{renderTrigger:()=>(0,x.jsx)("div",{className:"flex h-8 cursor-pointer items-center justify-between rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",children:e("common.addBlock",{ns:"workflow"})}),offset:{mainAxis:-36,crossAxis:-4}}),(0,x.jsx)("div",{className:"flex h-8 cursor-pointer items-center justify-between rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:e=>{e.stopPropagation(),d(),n()},children:e("nodes.note.addNote",{ns:"workflow"})}),(0,x.jsxs)("div",{className:"flex h-8 cursor-pointer items-center justify-between rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>{i(),n()},children:[e("common.run",{ns:"workflow"}),(0,x.jsx)(e7.default,{keys:["alt","r"]})]})]}),(0,x.jsx)(ss.default,{className:"m-0"}),(0,x.jsx)("div",{className:"p-1",children:(0,x.jsxs)("div",{className:(0,T.cn)("flex h-8 cursor-pointer items-center justify-between rounded-lg px-3 text-sm text-text-secondary",r.length?"hover:bg-state-base-hover":"cursor-not-allowed opacity-50"),onClick:()=>{r.length&&(l(),n())},children:[e("common.pasteHere",{ns:"workflow"}),(0,x.jsx)(e7.default,{keys:["ctrl","v"]})]})}),(0,x.jsx)(ss.default,{className:"m-0"}),(0,x.jsxs)("div",{className:"p-1",children:[(0,x.jsx)("div",{className:"flex h-8 cursor-pointer items-center justify-between rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>c?.(),children:e("export",{ns:"app"})}),(0,x.jsx)("div",{className:"flex h-8 cursor-pointer items-center justify-between rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>s(!0),children:e("common.importDSL",{ns:"workflow"})})]})]}):null});var uK=((p=uK||{}).Left="left",p.Center="center",p.Right="right",p.Top="top",p.Middle="middle",p.Bottom="bottom",p.DistributeHorizontal="distributeHorizontal",p.DistributeVertical="distributeVertical",p);let uG=(0,y.memo)(()=>{let{t:e}=(0,O.useTranslation)(),t=(0,y.useRef)(null),{getNodesReadOnly:a}=(0,Z.useNodesReadOnly)(),{handleSelectionContextmenuCancel:r}=(0,ca.useSelectionInteractions)(),s=(0,eN.useStore)(e=>e.selectionMenu),l=(0,j.useStoreApi)(),n=(0,eN.useWorkflowStore)(),o=(0,j.useStore)(e=>e.getNodes().filter(e=>e.selected)),{handleSyncWorkflowDraft:i}=(0,I.useNodesSyncDraft)(),{saveStateToHistory:d}=(0,R.useWorkflowHistory)(),c=(0,y.useRef)(null),u=(0,y.useMemo)(()=>{if(!s)return{left:0,top:0};let e=s.left,t=s.top,a=document.querySelector("#workflow-container");if(a){let{width:r,height:s}=a.getBoundingClientRect();e+240>r&&(e-=240),t+380>s&&(t-=380),e=Math.max(0,e),t=Math.max(0,t)}return{left:e,top:t}},[s]);(0,a_.useClickAway)(()=>{r()},t),(0,y.useEffect)(()=>{s&&o.length<=1&&r()},[s,o.length,r]);let p=(0,y.useCallback)((e,t,a,r,s,l,n)=>{let o=t.width,i=t.height;switch(a){case"left":e.position.x=r,e.positionAbsolute&&(e.positionAbsolute.x=r);break;case"center":{let t=r+(s-r)/2-o/2;e.position.x=t,e.positionAbsolute&&(e.positionAbsolute.x=t);break}case"right":{let t=s-o;e.position.x=t,e.positionAbsolute&&(e.positionAbsolute.x=t);break}case"top":e.position.y=l,e.positionAbsolute&&(e.positionAbsolute.y=l);break;case"middle":{let t=l+(n-l)/2-i/2;e.position.y=t,e.positionAbsolute&&(e.positionAbsolute.y=t);break}case"bottom":{let t=Math.round(n-i);e.position.y=t,e.positionAbsolute&&(e.positionAbsolute.y=t)}}},[]),m=(0,y.useCallback)((e,t,a)=>{let r=[...e].sort((e,t)=>"distributeHorizontal"===a?e.position.x-t.position.x:e.position.y-t.position.y);if(r.length<3)return null;let s=0,l=0;if("distributeHorizontal"===a){let e=r[0].position.x;s=r[r.length-1].position.x+(r[r.length-1].width||0)-e,l=r.reduce((e,t)=>e+(t.width||0),0)}else{let e=r[0].position.y;s=r[r.length-1].position.y+(r[r.length-1].height||0)-e,l=r.reduce((e,t)=>e+(t.height||0),0)}let n=(s-l)/(r.length-1);return n<=0?null:(0,f.produce)(t,e=>{let t;t="distributeHorizontal"===a?r[0].position.x+(r[0].width||0):r[0].position.y+(r[0].height||0);for(let s=1;s<r.length-1;s++){let l=r[s],o=e.find(e=>e.id===l.id);if(o)if("distributeHorizontal"===a){let e=t+n;o.position.x=e,o.positionAbsolute&&(o.positionAbsolute.x=e),t=e+(l.width||0)}else{let e=t+n;o.position.y=e,o.positionAbsolute&&(o.positionAbsolute.y=e),t=e+(l.height||0)}}})},[]),h=(0,y.useCallback)(e=>{if(a()||o.length<=1)return void r();n.setState({nodeAnimation:!1});let t=l.getState().getNodes(),s=o.map(e=>e.id),c=new Set;t.forEach(e=>{e.data._children&&e.data._children.length>0&&s.includes(e.id)&&e.data._children.forEach(e=>{c.add(e.nodeId)})});let u=t.filter(e=>s.includes(e.id)&&!c.has(e.id));if(u.length<=1)return void r();let x=Number.MAX_SAFE_INTEGER,h=Number.MIN_SAFE_INTEGER,g=Number.MAX_SAFE_INTEGER,b=Number.MIN_SAFE_INTEGER;if(u.filter(e=>e.width&&e.height).forEach(e=>{let t=e.width,a=e.height;x=Math.min(x,e.position.x),h=Math.max(h,e.position.x+t),g=Math.min(g,e.position.y),b=Math.max(b,e.position.y+a)}),"distributeHorizontal"===e||"distributeVertical"===e){let a=m(u,t,e);if(a){l.getState().setNodes(a),r();let{setHelpLineHorizontal:e,setHelpLineVertical:t}=n.getState();e(),t(),i(),d(R.WorkflowHistoryEvent.NodeDragStop);return}}let y=(0,f.produce)(t,t=>{u.filter(e=>e.width&&e.height).forEach(a=>{let r=t.find(e=>e.id===a.id);r&&p(r,a,e,x,h,g,b)})});try{l.getState().setNodes(y),r();let{setHelpLineHorizontal:e,setHelpLineVertical:t}=n.getState();e(),t(),i(),d(R.WorkflowHistoryEvent.NodeDragStop)}catch(e){console.error("Failed to update nodes:",e)}},[l,n,o,a,i,d,r,p,m]);return s?(0,x.jsx)("div",{className:"absolute z-[9]",style:{left:u.left,top:u.top},ref:t,children:(0,x.jsxs)("div",{ref:c,className:"w-[240px] rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-xl",children:[(0,x.jsxs)("div",{className:"p-1",children:[(0,x.jsx)("div",{className:"system-xs-medium px-2 py-2 text-text-tertiary",children:e("operator.vertical",{ns:"workflow"})}),(0,x.jsxs)("div",{className:"flex h-8 cursor-pointer items-center gap-2 rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>h("top"),children:[(0,x.jsx)(M.RiAlignTop,{className:"h-4 w-4"}),e("operator.alignTop",{ns:"workflow"})]}),(0,x.jsxs)("div",{className:"flex h-8 cursor-pointer items-center gap-2 rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>h("middle"),children:[(0,x.jsx)(M.RiAlignCenter,{className:"h-4 w-4 rotate-90"}),e("operator.alignMiddle",{ns:"workflow"})]}),(0,x.jsxs)("div",{className:"flex h-8 cursor-pointer items-center gap-2 rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>h("bottom"),children:[(0,x.jsx)(M.RiAlignBottom,{className:"h-4 w-4"}),e("operator.alignBottom",{ns:"workflow"})]}),(0,x.jsxs)("div",{className:"flex h-8 cursor-pointer items-center gap-2 rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>h("distributeVertical"),children:[(0,x.jsx)(M.RiAlignJustify,{className:"h-4 w-4 rotate-90"}),e("operator.distributeVertical",{ns:"workflow"})]})]}),(0,x.jsx)("div",{className:"h-px bg-divider-regular"}),(0,x.jsxs)("div",{className:"p-1",children:[(0,x.jsx)("div",{className:"system-xs-medium px-2 py-2 text-text-tertiary",children:e("operator.horizontal",{ns:"workflow"})}),(0,x.jsxs)("div",{className:"flex h-8 cursor-pointer items-center gap-2 rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>h("left"),children:[(0,x.jsx)(M.RiAlignLeft,{className:"h-4 w-4"}),e("operator.alignLeft",{ns:"workflow"})]}),(0,x.jsxs)("div",{className:"flex h-8 cursor-pointer items-center gap-2 rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>h("center"),children:[(0,x.jsx)(M.RiAlignCenter,{className:"h-4 w-4"}),e("operator.alignCenter",{ns:"workflow"})]}),(0,x.jsxs)("div",{className:"flex h-8 cursor-pointer items-center gap-2 rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>h("right"),children:[(0,x.jsx)(M.RiAlignRight,{className:"h-4 w-4"}),e("operator.alignRight",{ns:"workflow"})]}),(0,x.jsxs)("div",{className:"flex h-8 cursor-pointer items-center gap-2 rounded-lg px-3 text-sm text-text-secondary hover:bg-state-base-hover",onClick:()=>h("distributeHorizontal"),children:[(0,x.jsx)(M.RiAlignJustify,{className:"h-4 w-4"}),e("operator.distributeHorizontal",{ns:"workflow"})]})]})]})}):null}),uJ=(0,y.memo)(e=>{let{id:t,data:a}=e,{nodesReadOnly:r}=(0,Z.useNodesReadOnly)(),s=a.selected||a._isBundled||a._isEntering,{showRunningBorder:l,showSuccessBorder:n,showFailedBorder:o,showExceptionBorder:i}=(0,y.useMemo)(()=>({showRunningBorder:a._runningStatus===eb.NodeRunningStatus.Running&&!s,showSuccessBorder:a._runningStatus===eb.NodeRunningStatus.Succeeded&&!s,showFailedBorder:a._runningStatus===eb.NodeRunningStatus.Failed&&!s,showExceptionBorder:a._runningStatus===eb.NodeRunningStatus.Exception&&!s}),[a._runningStatus,s]);return(0,x.jsx)("div",{className:(0,T.cn)("flex rounded-2xl border-[2px]",s?"border-components-option-card-option-selected-border":"border-transparent",a._waitingRun&&"opacity-70"),style:{width:"auto",height:"auto"},children:(0,x.jsxs)("div",{className:(0,T.cn)("group relative pb-1 shadow-xs","rounded-[15px] border border-transparent","w-[240px] bg-workflow-block-bg",!a._runningStatus&&"hover:shadow-lg",l&&"!border-state-accent-solid",n&&"!border-state-success-solid",o&&"!border-state-destructive-solid",i&&"!border-state-warning-solid",a._isBundled&&"!shadow-lg"),children:[!a._isCandidate&&(0,x.jsx)(aL,{id:t,data:a,handleClassName:"!top-4 !-left-[9px] !translate-y-0",handleId:"target"}),!a._runningStatus&&!r&&!a._isCandidate&&(0,x.jsx)(aD,{id:t,data:a}),(0,x.jsxs)("div",{className:(0,T.cn)("flex items-center rounded-t-2xl px-3 pb-2 pt-3"),children:[(0,x.jsx)(J.default,{className:"mr-2 shrink-0",type:a.type,size:"md"}),(0,x.jsx)("div",{title:a.title,className:"system-sm-semibold-uppercase mr-1 flex grow items-center truncate text-text-primary",children:(0,x.jsx)("div",{children:a.title})}),(a._runningStatus===eb.NodeRunningStatus.Running||a._singleRunningStatus===eb.NodeRunningStatus.Running)&&(0,x.jsx)(M.RiLoader2Line,{className:"h-3.5 w-3.5 animate-spin text-text-accent"}),a._runningStatus===eb.NodeRunningStatus.Succeeded&&(0,x.jsx)(M.RiCheckboxCircleFill,{className:"h-3.5 w-3.5 text-text-success"}),a._runningStatus===eb.NodeRunningStatus.Failed&&(0,x.jsx)(M.RiErrorWarningFill,{className:"h-3.5 w-3.5 text-text-destructive"}),a._runningStatus===eb.NodeRunningStatus.Exception&&(0,x.jsx)(M.RiAlertFill,{className:"h-3.5 w-3.5 text-text-warning-secondary"})]})]})})});var uX=e.i(794611);let uQ=()=>(0,eN.useStore)(e=>e.isSyncingWorkflowDraft)?(0,x.jsx)("div",{className:"absolute inset-0 z-[9999]"}):null;var uY=e.i(997908);let uZ=(0,b.default)(()=>e.A(623391),{loadableGenerated:{modules:[920226]},ssr:!1}),u0={[S.CUSTOM_NODE]:dK,[dJ.CUSTOM_NOTE_NODE]:d0,[uX.CUSTOM_SIMPLE_NODE]:uJ,[cp.CUSTOM_ITERATION_START_NODE]:lH,[cm.CUSTOM_LOOP_START_NODE]:oz,[cu.CUSTOM_DATA_SOURCE_EMPTY_NODE]:cc},u1={[S.CUSTOM_EDGE]:d6},u2=(0,y.memo)(e=>{let{nodes:t,edges:a,viewport:r,children:s,onWorkflowDataUpdate:l}=e,n=(0,y.useRef)(null),o=(0,eN.useWorkflowStore)(),i=(0,j.useReactFlow)(),[d,c]=(0,j.useNodesState)(t),[u,p]=(0,j.useEdgesState)(a),m=(0,eN.useStore)(e=>e.controlMode),b=(0,eN.useStore)(e=>e.nodeAnimation),E=(0,eN.useStore)(e=>e.showConfirm),R=(0,eN.useStore)(e=>e.workflowCanvasHeight),M=(0,eN.useStore)(e=>e.bottomPanelHeight),A=(0,eN.useStore)(e=>e.setWorkflowCanvasWidth),O=(0,eN.useStore)(e=>e.setWorkflowCanvasHeight),P=(0,y.useMemo)(()=>R?R-M:"100%",[R,M]);(0,y.useEffect)(()=>{if(n.current){let e=new ResizeObserver(e=>{for(let t of e){let{inlineSize:e,blockSize:a}=t.borderBoxSize[0];A(e),O(a)}});return e.observe(n.current),()=>{e.disconnect()}}},[O,A]);let{setShowConfirm:L,setControlPromptEditorRerenderKey:F,setSyncWorkflowDraftHash:B,setNodes:D}=o.getState(),$=(0,j.useNodes)(),z=(0,y.useCallback)(e=>{let t=e.map(e=>({id:e.id,data:e.data})),a=o.getState().nodes.map(e=>({id:e.id,data:e.data}));(0,g.isEqual)(a,t)||D(e)},[D,o]);(0,y.useEffect)(()=>{z($)},[$,z]);let{handleSyncWorkflowDraft:H,syncWorkflowDraftWhenPageClose:W}=(0,I.useNodesSyncDraft)(),{workflowReadOnly:q}=(0,Z.useWorkflowReadOnly)(),{nodesReadOnly:U}=(0,Z.useNodesReadOnly)(),{eventEmitter:K}=(0,N.useEventEmitterContextContext)(),G=(0,j.useStoreApi)();K?.useSubscription(e=>{e.type===S.WORKFLOW_DATA_UPDATE&&(c(e.payload.nodes),G.getState().setNodes(e.payload.nodes),p(e.payload.edges),e.payload.viewport&&i.setViewport(e.payload.viewport),e.payload.hash&&B(e.payload.hash),l?.(e.payload),setTimeout(()=>F(Date.now())))}),(0,y.useEffect)(()=>((0,f.setAutoFreeze)(!1),()=>{(0,f.setAutoFreeze)(!0)}),[]),(0,y.useEffect)(()=>()=>{H(!0,!0)},[H]);let{handleRefreshWorkflowDraft:J}=(0,cl.useWorkflowRefreshDraft)(),X=(0,y.useCallback)(()=>{if("hidden"===document.visibilityState)return void W();if("visible"===document.visibilityState){let{isListening:e,workflowRunningData:t}=o.getState(),a=t?.result?.status;if(e||a===eb.WorkflowRunningStatus.Running)return;setTimeout(()=>J(),500)}},[W,J,o]),Q=(0,y.useCallback)(()=>{W()},[W]);(0,y.useEffect)(()=>(document.addEventListener("visibilitychange",X),window.addEventListener("beforeunload",Q),()=>{document.removeEventListener("visibilitychange",X),window.removeEventListener("beforeunload",Q)}),[X,Q]),(0,h.default)("keydown",e=>{("d"===e.key||"D"===e.key)&&(e.ctrlKey||e.metaKey)&&e.preventDefault(),("z"===e.key||"Z"===e.key)&&(e.ctrlKey||e.metaKey)&&e.preventDefault(),("y"===e.key||"Y"===e.key)&&(e.ctrlKey||e.metaKey)&&e.preventDefault(),("s"===e.key||"S"===e.key)&&(e.ctrlKey||e.metaKey)&&e.preventDefault()}),(0,h.default)("mousemove",e=>{let t=n.current?.getBoundingClientRect();t&&o.setState({mousePosition:{pageX:e.clientX,pageY:e.clientY,elementX:e.clientX-t.left,elementY:e.clientY-t.top}})});let{handleNodeDragStart:Y,handleNodeDrag:ee,handleNodeDragStop:ea,handleNodeEnter:er,handleNodeLeave:es,handleNodeClick:el,handleNodeConnect:en,handleNodeConnectStart:eo,handleNodeConnectEnd:ei,handleNodeContextMenu:ed,handleHistoryBack:ec,handleHistoryForward:eu}=(0,V.useNodesInteractions)(),{handleEdgeEnter:ep,handleEdgeLeave:em,handleEdgesChange:ex}=(0,eK.useEdgesInteractions)(),{handleSelectionStart:eh,handleSelectionChange:eg,handleSelectionDrag:ef,handleSelectionContextMenu:ey}=(0,ca.useSelectionInteractions)(),{handlePaneContextMenu:ev}=(0,ct.usePanelInteractions)(),{isValidConnection:ew}=(0,Z.useWorkflow)();(0,j.useOnViewportChange)({onEnd:()=>{H()}}),(0,cs.useShortcuts)(),(0,co.useWorkflowSearch)(),(0,y.useEffect)(()=>(0,uY.setupScrollToNodeListener)(d,i),[d,i]);let{schemaTypeDefinitions:ej}=(0,tP.default)(),{fetchInspectVars:ek}=(0,cr.useSetWorkflowVarsWithValue)(),{data:eC}=(0,C.useAllBuiltInTools)(),{data:e_}=(0,C.useAllCustomTools)(),{data:eT}=(0,C.useAllWorkflowTools)(),{data:eS}=(0,C.useAllMCPTools)(),eE=(0,eN.useStore)(e=>e.dataSourceList),eV=(0,et.useHooksStore)(e=>e.configsMap),[eI,eR]=(0,y.useState)(!1),[eM,eA]=(0,y.useState)([]);return(0,y.useEffect)(()=>{(async()=>{eV?.flowType&&eV?.flowId&&(eA(await (0,_.fetchAllInspectVars)(eV.flowType,eV.flowId)),eR(!0))})()},[eV?.flowType,eV?.flowId]),(0,y.useEffect)(()=>{ej&&eI&&ek({passInVars:!0,vars:eM,passedInAllPluginInfoList:{buildInTools:eC||[],customTools:e_||[],workflowTools:eT||[],mcpTools:eS||[],dataSourceList:eE??[]},passedInSchemaTypeDefinitions:ej})},[ej,ek,eI,eM,e_,eC,eT,eS,eE]),k.IS_DEV&&(G.getState().onError=(e,t)=>{"002"!==e&&console.warn(t)}),(0,x.jsxs)("div",{id:"workflow-container",className:(0,T.cn)("relative h-full w-full min-w-[960px]",q&&"workflow-panel-animation",b&&"workflow-node-animation"),ref:n,children:[(0,x.jsx)(uQ,{}),(0,x.jsx)(d2,{}),(0,x.jsx)("div",{className:"pointer-events-none absolute left-0 top-0 z-10 flex w-12 items-center justify-center p-1 pl-2",style:{height:P},children:(0,x.jsx)(uH,{})}),(0,x.jsx)(cU,{handleRedo:eu,handleUndo:ec}),(0,x.jsx)(uU,{}),(0,x.jsx)(cd,{}),(0,x.jsx)(uG,{}),(0,x.jsx)(ce,{}),!!E&&(0,x.jsx)(uZ,{isShow:!0,onCancel:()=>L(void 0),onConfirm:E.onConfirm,title:E.title,content:E.desc}),s,(0,x.jsx)(v.default,{nodeTypes:u0,edgeTypes:u1,nodes:d,edges:u,onNodeDragStart:Y,onNodeDrag:ee,onNodeDragStop:ea,onNodeMouseEnter:er,onNodeMouseLeave:es,onNodeClick:el,onNodeContextMenu:ed,onConnect:en,onConnectStart:eo,onConnectEnd:ei,onEdgeMouseEnter:ep,onEdgeMouseLeave:em,onEdgesChange:ex,onSelectionStart:eh,onSelectionChange:eg,onSelectionDrag:ef,onPaneContextMenu:ev,onSelectionContextMenu:ey,connectionLineComponent:d5.default,connectionLineContainerStyle:{zIndex:S.ITERATION_CHILDREN_Z_INDEX},defaultViewport:r,multiSelectionKeyCode:null,deleteKeyCode:null,nodesDraggable:!U,nodesConnectable:!U,nodesFocusable:!U,edgesFocusable:!U,panOnScroll:m===eb.ControlMode.Pointer&&!q,panOnDrag:m===eb.ControlMode.Hand||[1],zoomOnPinch:!0,zoomOnScroll:!0,zoomOnDoubleClick:!0,isValidConnection:ew,selectionKeyCode:null,selectionMode:j.SelectionMode.Partial,selectionOnDrag:m===eb.ControlMode.Pointer&&!q,minZoom:.25,children:(0,x.jsx)(w.Background,{gap:[14,14],size:2,className:"bg-workflow-canvas-workflow-bg",color:"var(--color-workflow-canvas-workflow-dot-color)"})})]})}),u5=(0,y.memo)(e=>{let{hooksStore:t,...a}=e;return(0,x.jsx)(cn.HooksStoreContextProvider,{...t,children:(0,x.jsx)(u2,{...a})})}),u3=(0,y.memo)(e=>{let{nodes:t,edges:a,children:r}=e;return(0,x.jsx)(j.ReactFlowProvider,{children:(0,x.jsx)(dG.WorkflowHistoryProvider,{nodes:t,edges:a,children:(0,x.jsx)(d8.default,{nodes:t,children:r})})})});e.s(["WorkflowWithInnerContext",0,u5,"default",0,u3],724605)},576597,e=>{"use strict";var t=e.i(563199),a=e.i(233697),r=e.i(326531);e.i(845780);var s=e.i(383923);e.i(275225);var l=e.i(705405),n=e.i(268255),o=e.i(192447);e.i(160186);var i=e.i(621830),d=e.i(757198),c=e.i(265522),u=e.i(720315),p=e.i(556354);e.i(152567);var m=e.i(408767),x=e.i(363372),h=e.i(157884);let g=(0,n.memo)(()=>{let{t:e}=(0,m.useTranslation)(),{formatTime:a}=(0,h.default)(),{formatTimeFromNow:r}=(0,x.useFormatTimeFromNow)(),s=(0,l.useStore)(e=>e.draftUpdatedAt),n=(0,l.useStore)(e=>e.publishedAt),o=(0,l.useStore)(e=>e.isSyncingWorkflowDraft),i=(0,l.useStore)(e=>e.maximizeCanvas);return(0,t.jsxs)("div",{className:`system-xs-regular flex h-[18px] min-w-[300px] items-center whitespace-nowrap text-text-tertiary ${i?"ml-2":""}`,children:[!!s&&(0,t.jsxs)(t.Fragment,{children:[e("common.autoSaved",{ns:"workflow"})," ",a(s/1e3,"HH:mm:ss")]}),(0,t.jsx)("span",{className:"mx-1 flex items-center",children:"·"}),n?`${e("common.published",{ns:"workflow"})} ${r(n)}`:e("common.unpublished",{ns:"workflow"}),o&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("span",{className:"mx-1 flex items-center",children:"·"}),e("common.syncingData",{ns:"workflow"})]})]})});var f=e.i(151094);e.i(42241);var b=e.i(825220),y=e.i(922521),v=e.i(935139);let w=(0,n.memo)(e=>{let{disabled:a}=e,{theme:r}=(0,y.default)(),s=(0,l.useStore)(e=>e.setShowChatVariablePanel),n=(0,l.useStore)(e=>e.showEnvPanel),o=(0,l.useStore)(e=>e.setShowEnvPanel),d=(0,l.useStore)(e=>e.setShowGlobalVariablePanel),c=(0,l.useStore)(e=>e.setShowDebugAndPreviewPanel),{closeAllInputFieldPanels:u}=(0,i.useInputFieldPanel)();return(0,t.jsx)(f.default,{className:(0,v.cn)("rounded-lg border border-transparent p-2","dark"===r&&n&&"border-black/5 bg-white/10 backdrop-blur-sm"),variant:"ghost",disabled:a,onClick:()=>{o(!0),s(!1),d(!1),c(!1),u()},children:(0,t.jsx)(b.Env,{className:"h-4 w-4 text-components-button-secondary-text"})})});var j=e.i(379636);let k=(0,n.memo)(e=>{let{disabled:a}=e,{theme:r}=(0,y.default)(),s=(0,l.useStore)(e=>e.showGlobalVariablePanel),n=(0,l.useStore)(e=>e.setShowGlobalVariablePanel),o=(0,l.useStore)(e=>e.setShowEnvPanel),d=(0,l.useStore)(e=>e.setShowChatVariablePanel),c=(0,l.useStore)(e=>e.setShowDebugAndPreviewPanel),{closeAllInputFieldPanels:u}=(0,i.useInputFieldPanel)();return(0,t.jsx)(f.default,{className:(0,v.cn)("rounded-lg border border-transparent p-2","dark"===r&&s&&"border-black/5 bg-white/10 backdrop-blur-sm"),disabled:a,onClick:()=>{n(!0),o(!1),d(!1),c(!1),u()},variant:"ghost",children:(0,t.jsx)(j.GlobalVariable,{className:"h-4 w-4 text-components-button-secondary-text"})})});var N=e.i(837699),C=e.i(886485);e.i(538868);var _=e.i(403033),_=_;e.i(668763);var T=e.i(780170),T=T;e.i(47690);var S=e.i(76501),S=S,E=e.i(391185),V=e.i(616332),I=e.i(120219),R=e.i(944419);let M=(0,n.memo)(e=>{let{disabled:a,showGoTo:r=!0,onItemClick:s}=e,{t:l}=(0,m.useTranslation)(),[i,d]=(0,n.useState)(!1),u=(0,o.useEdges)(),p=(0,V.default)(),x=(0,R.useChecklist)(p,u),{handleNodeSelect:h}=(0,c.useNodesInteractions)();return(0,t.jsxs)(E.PortalToFollowElem,{placement:"bottom-end",offset:{mainAxis:12,crossAxis:4},open:i,onOpenChange:d,children:[(0,t.jsx)(E.PortalToFollowElemTrigger,{onClick:()=>!a&&d(e=>!e),children:(0,t.jsxs)("div",{className:(0,v.cn)("relative ml-0.5 flex h-7 w-7 items-center justify-center rounded-md",a&&"cursor-not-allowed opacity-50"),children:[(0,t.jsx)("div",{className:(0,v.cn)("group flex h-full w-full cursor-pointer items-center justify-center rounded-md hover:bg-state-accent-hover",i&&"bg-state-accent-hover"),children:(0,t.jsx)(N.RiListCheck3,{className:(0,v.cn)("h-4 w-4 group-hover:text-components-button-secondary-accent-text",i?"text-components-button-secondary-accent-text":"text-components-button-ghost-text")})}),!!x.length&&(0,t.jsx)("div",{className:"absolute -right-1.5 -top-1.5 flex h-[18px] min-w-[18px] items-center justify-center rounded-full border border-gray-100 bg-[#F79009] text-[11px] font-semibold text-white",children:x.length})]})}),(0,t.jsx)(E.PortalToFollowElemContent,{className:"z-[12]",children:(0,t.jsxs)("div",{className:"w-[420px] overflow-y-auto rounded-2xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-lg",style:{maxHeight:"calc(2 / 3 * 100vh)"},children:[(0,t.jsxs)("div",{className:"text-md sticky top-0 z-[1] flex h-[44px] items-center bg-components-panel-bg pl-4 pr-3 pt-3 font-semibold text-text-primary",children:[(0,t.jsxs)("div",{className:"grow",children:[l("panel.checklist",{ns:"workflow"}),x.length?`(${x.length})`:""]}),(0,t.jsx)("div",{className:"flex h-6 w-6 shrink-0 cursor-pointer items-center justify-center",onClick:()=>d(!1),children:(0,t.jsx)(N.RiCloseLine,{className:"h-4 w-4 text-text-tertiary"})})]}),(0,t.jsxs)("div",{className:"pb-2",children:[!!x.length&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"px-4 pt-1 text-xs text-text-tertiary",children:l("panel.checklistTip",{ns:"workflow"})}),(0,t.jsx)("div",{className:"px-4 py-2",children:x.map(e=>(0,t.jsxs)("div",{className:(0,v.cn)("group mb-2 rounded-lg border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-xs last-of-type:mb-0",r&&e.canNavigate&&!e.disableGoTo?"cursor-pointer":"cursor-default opacity-80"),onClick:()=>{r&&e.canNavigate&&!e.disableGoTo&&(s?s(e):h(e.id),d(!1))},children:[(0,t.jsxs)("div",{className:"flex h-9 items-center p-2 text-xs font-medium text-text-secondary",children:[(0,t.jsx)(I.default,{type:e.type,className:"mr-1.5",toolIcon:e.toolIcon}),(0,t.jsx)("span",{className:"grow truncate",children:e.title}),r&&e.canNavigate&&!e.disableGoTo&&(0,t.jsxs)("div",{className:"flex h-4 w-[60px] shrink-0 items-center justify-center gap-1 opacity-0 transition-opacity duration-200 group-hover:opacity-100",children:[(0,t.jsx)("span",{className:"whitespace-nowrap text-xs font-medium leading-4 text-primary-600",children:l("panel.goTo",{ns:"workflow"})}),(0,t.jsx)(T.default,{className:"h-3.5 w-3.5 text-primary-600"})]})]}),(0,t.jsxs)("div",{className:(0,v.cn)("rounded-b-lg border-t-[0.5px] border-divider-regular",(e.unConnected||e.errorMessage)&&"bg-gradient-to-r from-components-badge-bg-orange-soft to-transparent"),children:[e.unConnected&&(0,t.jsx)("div",{className:"px-3 py-1 first:pt-1.5 last:pb-1.5",children:(0,t.jsxs)("div",{className:"flex text-xs leading-4 text-text-tertiary",children:[(0,t.jsx)(_.default,{className:"mr-2 mt-[2px] h-3 w-3 text-[#F79009]"}),l("common.needConnectTip",{ns:"workflow"})]})}),e.errorMessage&&(0,t.jsx)("div",{className:"px-3 py-1 first:pt-1.5 last:pb-1.5",children:(0,t.jsxs)("div",{className:"flex text-xs leading-4 text-text-tertiary",children:[(0,t.jsx)(_.default,{className:"mr-2 mt-[2px] h-3 w-3 text-[#F79009]"}),e.errorMessage]})})]})]},e.id))})]}),!x.length&&(0,t.jsxs)("div",{className:"mx-4 mb-3 rounded-lg bg-components-panel-bg py-4 text-center text-xs text-text-tertiary",children:[(0,t.jsx)(S.default,{className:"mx-auto mb-[5px] h-8 w-8 text-text-quaternary"}),l("panel.checklistResolved",{ns:"workflow"})]})]})]})})]})});e.i(201987);var A=e.i(207331);e.i(27905);var O=e.i(348042),P=e.i(137667),L=e.i(194902),F=e.i(390622),B=e.i(443523),D=e.i(249420);e.i(916131);var $=e.i(584458),z=e.i(819114),H=e.i(36359),W=e.i(205707);let q=n.memo(e=>{let{text:a}=e,{t:r}=(0,m.useTranslation)(),{handleWorkflowStartRunInWorkflow:s,handleWorkflowTriggerScheduleRunInWorkflow:o,handleWorkflowTriggerWebhookRunInWorkflow:i,handleWorkflowTriggerPluginRunInWorkflow:d,handleWorkflowRunAllTriggersInWorkflow:c}=(0,C.useWorkflowStartRun)(),{handleStopRun:u}=(0,p.useWorkflowRun)(),{validateBeforeRun:x,warningNodes:h}=(0,R.useWorkflowRunValidation)(),g=(0,l.useStore)(e=>e.workflowRunningData),f=(0,l.useStore)(e=>e.isListening),b=g?.result.status===F.WorkflowRunningStatus.Running||f,y=(()=>{let{t:e}=(0,m.useTranslation)(),a=(0,V.default)(),r=(0,l.useStore)(e=>e.buildInTools),s=(0,l.useStore)(e=>e.customTools),o=(0,l.useStore)(e=>e.workflowTools),i=(0,l.useStore)(e=>e.mcpTools),{data:d}=(0,z.useAllTriggerPlugins)();return(0,n.useMemo)(()=>{let r,s=[];for(let l of a){let a=l.data;if(a?.type){if(a.type===F.BlockEnum.Start)r={id:l.id,type:H.TriggerType.UserInput,name:a.title||e("blocks.start",{ns:"workflow"}),icon:(0,t.jsx)(I.default,{type:F.BlockEnum.Start,size:"md"}),nodeId:l.id,enabled:!0};else if(a.type===F.BlockEnum.TriggerSchedule)s.push({id:l.id,type:H.TriggerType.Schedule,name:a.title||e("blocks.trigger-schedule",{ns:"workflow"}),icon:(0,t.jsx)(I.default,{type:F.BlockEnum.TriggerSchedule,size:"md"}),nodeId:l.id,enabled:!0});else if(a.type===F.BlockEnum.TriggerWebhook)s.push({id:l.id,type:H.TriggerType.Webhook,name:a.title||e("blocks.trigger-webhook",{ns:"workflow"}),icon:(0,t.jsx)(I.default,{type:F.BlockEnum.TriggerWebhook,size:"md"}),nodeId:l.id,enabled:!0});else if(a.type===F.BlockEnum.TriggerPlugin){let r;if(a.provider_id){let e=d||[];r=e.find(e=>e.name===a.provider_id)?.icon}let n=(0,t.jsx)(I.default,{type:F.BlockEnum.TriggerPlugin,size:"md",toolIcon:r});s.push({id:l.id,type:H.TriggerType.Plugin,name:a.title||a.plugin_name||e("blocks.trigger-plugin",{ns:"workflow"}),icon:n,nodeId:l.id,enabled:!0})}}}if(!r){let s=(0,W.getWorkflowEntryNode)(a);s&&s.data?.type===F.BlockEnum.Start&&(r={id:s.id,type:H.TriggerType.UserInput,name:s.data?.title||e("blocks.start",{ns:"workflow"}),icon:(0,t.jsx)(I.default,{type:F.BlockEnum.Start,size:"md"}),nodeId:s.id,enabled:!0})}let l=s.map(e=>e.nodeId).filter(e=>!!e);return{userInput:r,triggers:s,runAll:l.length>1?{id:"run-all",type:H.TriggerType.All,name:e("common.runAllTriggers",{ns:"workflow"}),icon:(0,t.jsx)("div",{className:"flex h-6 w-6 items-center justify-center rounded-lg border-[0.5px] border-white/2 bg-util-colors-purple-purple-500 text-white shadow-md",children:(0,t.jsx)($.TriggerAll,{className:"h-4.5 w-4.5"})}),relatedNodeIds:l,enabled:!0}:void 0}},[a,r,s,o,i,d,e])})(),w=(0,n.useRef)(null),{notify:j}=(0,P.useToastContext)();(0,n.useEffect)(()=>(window._toggleTestRunDropdown=()=>{w.current?.toggle()},()=>{delete window._toggleTestRunDropdown}),[]);let k=(0,n.useCallback)(()=>{u(g?.task_id||"")},[u,g?.task_id]),_=(0,n.useCallback)(e=>{let t=!0;if(h.forEach(a=>{a.id===e.nodeId&&(t=!1)}),!t)return void j({type:"error",message:r("panel.checklistTip",{ns:"workflow"})});if(e.type===H.TriggerType.UserInput)s(),(0,A.trackEvent)("app_start_action_time",{action_type:"user_input"});else if(e.type===H.TriggerType.Schedule)o(e.nodeId),(0,A.trackEvent)("app_start_action_time",{action_type:"schedule"});else if(e.type===H.TriggerType.Webhook)e.nodeId&&i({nodeId:e.nodeId}),(0,A.trackEvent)("app_start_action_time",{action_type:"webhook"});else if(e.type===H.TriggerType.Plugin)e.nodeId&&d(e.nodeId),(0,A.trackEvent)("app_start_action_time",{action_type:"plugin"});else if(e.type===H.TriggerType.All){let t=e.relatedNodeIds?.filter(Boolean);t&&t.length>0&&c(t),(0,A.trackEvent)("app_start_action_time",{action_type:"all"})}},[x,s,o,i,d,c]),{eventEmitter:T}=(0,D.useEventEmitterContextContext)();return T?.useSubscription(e=>{e.type===B.EVENT_WORKFLOW_STOP&&k()}),(0,t.jsxs)("div",{className:"flex items-center gap-x-px",children:[b?(0,t.jsxs)("button",{type:"button",className:(0,v.cn)("system-xs-medium flex h-7 cursor-not-allowed items-center gap-x-1 rounded-l-md bg-state-accent-hover px-1.5 text-text-accent"),disabled:!0,children:[(0,t.jsx)(N.RiLoader2Line,{className:"mr-1 size-4 animate-spin"}),f?r("common.listening",{ns:"workflow"}):r("common.running",{ns:"workflow"})]}):(0,t.jsx)(H.default,{ref:w,options:y,onSelect:_,children:(0,t.jsxs)("div",{className:(0,v.cn)("system-xs-medium flex h-7 cursor-pointer items-center gap-x-1 rounded-md px-1.5 text-text-accent hover:bg-state-accent-hover"),style:{userSelect:"none"},children:[(0,t.jsx)(N.RiPlayLargeLine,{className:"mr-1 size-4"}),a??r("common.run",{ns:"workflow"}),(0,t.jsx)(L.default,{keys:["alt","R"],textColor:"secondary"})]})}),b&&(0,t.jsx)("button",{type:"button",className:(0,v.cn)("flex size-7 items-center justify-center rounded-r-md bg-state-accent-active"),onClick:k,children:(0,t.jsx)(O.StopCircle,{className:"size-4 text-text-accent"})})]})});var U=e.i(347229);let K=(0,n.memo)(()=>{let{t:e}=(0,m.useTranslation)(),{handleWorkflowStartRunInChatflow:a}=(0,C.useWorkflowStartRun)();return(0,t.jsxs)("div",{className:(0,v.cn)("flex h-7 items-center rounded-md px-2.5 text-[13px] font-medium text-components-button-secondary-accent-text","cursor-pointer hover:bg-state-accent-hover"),onClick:()=>a(),children:[(0,t.jsx)(N.RiPlayLargeLine,{className:"mr-1 h-4 w-4"}),e("common.debugAndPreview",{ns:"workflow"})]})}),G=(0,n.memo)(e=>{let{showRunButton:a,runButtonText:r,showPreviewButton:s,viewHistoryProps:l,components:n}=e,{nodesReadOnly:o}=(0,u.useNodesReadOnly)(),{RunMode:i}=n||{};return(0,t.jsxs)("div",{className:"flex h-8 items-center rounded-lg border-[0.5px] border-components-button-secondary-border bg-components-button-secondary-bg px-0.5 shadow-xs",children:[a&&(i?(0,t.jsx)(i,{text:r}):(0,t.jsx)(q,{text:r})),s&&(0,t.jsx)(K,{}),(0,t.jsx)("div",{className:"mx-0.5 h-3.5 w-[1px] bg-divider-regular"}),(0,t.jsx)(U.default,{...l}),(0,t.jsx)(M,{disabled:o})]})});var J=e.i(997908);let X=()=>{let{t:e}=(0,m.useTranslation)(),a=(0,o.useNodes)().find(e=>e.data.selected),r=(0,n.useCallback)(()=>{a&&(0,J.scrollToWorkflowNode)(a.id)},[a]);return a?(0,t.jsx)("div",{className:(0,v.cn)("system-xs-medium flex h-6 cursor-pointer items-center justify-center whitespace-nowrap rounded-md border-[0.5px] border-effects-highlight bg-components-actionbar-bg px-3 text-text-tertiary shadow-lg backdrop-blur-sm transition-colors duration-200 hover:text-text-accent"),onClick:r,children:e("panel.scrollToSelectedNode",{ns:"workflow"})}):null};var Q=e.i(250755),Y=e.i(421001);e.i(905691);var Z=e.i(706416);let ee=["ctrl","⇧","H"],et=n.memo(()=>{let{t:e}=(0,m.useTranslation)();return(0,t.jsxs)("div",{className:"flex items-center gap-x-1",children:[(0,t.jsx)("div",{className:"system-xs-medium px-0.5 text-text-secondary",children:e("common.versionHistory",{ns:"workflow"})}),(0,t.jsx)(L.default,{keys:ee,bgColor:"gray",textColor:"secondary"})]})});et.displayName="PopupContent";let ea=e=>{let{onClick:a}=e,{theme:r}=(0,y.default)(),s=(0,n.useCallback)(async()=>{await a?.()},[a]);return(0,Q.useKeyPress)(`${(0,Z.getKeyboardKeyCodeBySystem)("ctrl")}.shift.h`,e=>{e.preventDefault(),s()},{exactMatch:!0,useCapture:!0}),(0,t.jsx)(Y.default,{popupContent:(0,t.jsx)(et,{}),noDecoration:!0,popupClassName:"rounded-lg border-[0.5px] border-components-panel-border bg-components-tooltip-bg shadow-lg shadow-shadow-shadow-5 backdrop-blur-[5px] p-1.5",children:(0,t.jsx)(f.default,{className:(0,v.cn)("rounded-lg border border-transparent p-2","dark"===r&&"border-black/5 bg-white/10 backdrop-blur-sm"),onClick:s,children:(0,t.jsx)(N.RiHistoryLine,{className:"h-4 w-4 text-components-button-secondary-text"})})})},er=e=>{let{components:a,runAndHistoryProps:r}=e,s=(0,l.useWorkflowStore)(),{nodesReadOnly:m}=(0,u.useNodesReadOnly)(),{handleNodeSelect:x}=(0,c.useNodesInteractions)(),h=(0,l.useStore)(e=>e.setShowWorkflowVersionHistoryPanel),f=(0,l.useStore)(e=>e.setShowEnvPanel),b=(0,l.useStore)(e=>e.setShowDebugAndPreviewPanel),y=(0,l.useStore)(e=>e.setShowVariableInspectPanel),v=(0,l.useStore)(e=>e.setShowChatVariablePanel),j=(0,l.useStore)(e=>e.setShowGlobalVariablePanel),N=(0,o.useNodes)().find(e=>e.data.selected),{handleBackupDraft:C}=(0,p.useWorkflowRun)(),{closeAllInputFieldPanels:_}=(0,i.useInputFieldPanel)(),T=(0,n.useCallback)(()=>{s.setState({isRestoring:!0}),C(),N&&x(N.id,!0),h(!0),f(!1),b(!1),y(!1),v(!1),j(!1),_()},[s,C,N,x,h,f,b,y,v,j]);return(0,t.jsxs)("div",{className:"flex w-full items-center justify-between",children:[(0,t.jsx)("div",{children:(0,t.jsx)(g,{})}),(0,t.jsx)("div",{children:(0,t.jsx)(X,{})}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[a?.left,(0,t.jsx)(d.default,{type:"vertical",className:"mx-auto h-3.5"}),(0,t.jsx)(G,{...r}),(0,t.jsxs)("div",{className:"shrink-0 cursor-pointer rounded-lg border-[0.5px] border-components-button-secondary-border bg-components-button-secondary-bg shadow-xs backdrop-blur-[10px]",children:[a?.chatVariableTrigger,(0,t.jsx)(w,{disabled:m}),(0,t.jsx)(k,{disabled:m})]}),a?.middle,(0,t.jsx)(ea,{onClick:T})]})]})},es=(0,a.default)(()=>e.A(888741),{loadableGenerated:{modules:[173827]},ssr:!1}),el=(0,a.default)(()=>e.A(507500),{loadableGenerated:{modules:[963740]},ssr:!1});e.s(["default",0,e=>{let{normal:a,viewHistory:n,restoring:o}=e,i=(0,r.usePathname)(),d=i.endsWith("/workflow"),c=i.endsWith("/pipeline"),{normal:u,restoring:p,viewHistory:m}=(0,s.useWorkflowMode)(),x=(0,l.useStore)(e=>e.maximizeCanvas);return(0,t.jsxs)("div",{className:"absolute left-0 top-7 z-10 flex h-0 w-full items-center justify-between bg-mask-top2bottom-gray-50-to-transparent px-3",children:[(d||c)&&x&&(0,t.jsx)("div",{className:"h-14 w-[52px]"}),u&&(0,t.jsx)(er,{...a}),m&&(0,t.jsx)(es,{...n}),p&&(0,t.jsx)(el,{...o})]})}],576597)},525160,e=>{"use strict";var t=e.i(563199),a=e.i(233697),r=e.i(268255),s=e.i(192447),l=e.i(908432),n=e.i(935139),o=e.i(465574);e.i(275225);var i=e.i(705405),d=e.i(837699);e.i(152567);var c=e.i(408767),u=e.i(604208),p=e.i(370869),m=e.i(963855),x=e.i(403861);e.i(42241);var h=e.i(825220);let g=(0,r.memo)(e=>{let{env:a,onEdit:s,onDelete:l}=e,o=(0,i.useStore)(e=>e.envSecrets),[c,u]=(0,r.useState)(!1);return(0,t.jsxs)("div",{className:(0,n.cn)("radius-md group mb-1 border border-components-panel-border-subtle bg-components-panel-on-panel-item-bg shadow-xs hover:bg-components-panel-on-panel-item-bg-hover",c&&"border-state-destructive-border hover:bg-state-destructive-hover"),children:[(0,t.jsxs)("div",{className:"px-2.5 py-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex grow items-center gap-1",children:[(0,t.jsx)(h.Env,{className:"h-4 w-4 text-util-colors-violet-violet-600"}),(0,t.jsx)("div",{className:"system-sm-medium text-text-primary",children:a.name}),(0,t.jsx)("div",{className:"system-xs-medium text-text-tertiary",children:(0,x.capitalize)(a.value_type)}),"secret"===a.value_type&&(0,t.jsx)(d.RiLock2Line,{className:"h-3 w-3 text-text-tertiary"})]}),(0,t.jsxs)("div",{className:"flex shrink-0 items-center gap-1 text-text-tertiary",children:[(0,t.jsx)("div",{className:"radius-md cursor-pointer p-1 hover:bg-state-base-hover hover:text-text-secondary",children:(0,t.jsx)(d.RiEditLine,{className:"h-4 w-4",onClick:()=>s(a)})}),(0,t.jsx)("div",{className:"radius-md cursor-pointer p-1 hover:bg-state-destructive-hover hover:text-text-destructive",onMouseOver:()=>u(!0),onMouseOut:()=>u(!1),children:(0,t.jsx)(d.RiDeleteBinLine,{className:"h-4 w-4",onClick:()=>l(a)})})]})]}),(0,t.jsx)("div",{className:"system-xs-regular truncate text-text-tertiary",children:"secret"===a.value_type?o[a.id]:a.value})]}),a.description&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"h-[0.5px] bg-divider-subtle"}),(0,t.jsx)("div",{className:(0,n.cn)("rounded-bl-[8px] rounded-br-[8px] bg-background-default-subtle px-2.5 py-2 group-hover:bg-transparent",c&&"bg-state-destructive-hover hover:bg-state-destructive-hover"),children:(0,t.jsx)("div",{className:"system-xs-regular truncate text-text-tertiary",children:a.description})})]})]})});var f=e.i(151094),b=e.i(391185),y=e.i(339548),v=e.i(503144),w=e.i(291631),j=e.i(137667),k=e.i(421001),N=e.i(168014);let C=e=>{let{env:a,onClose:s,onSave:l}=e,{t:o}=(0,c.useTranslation)(),{notify:u}=(0,y.useContext)(j.ToastContext),p=(0,i.useWorkflowStore)(),[m,x]=r.useState("string"),[h,g]=r.useState(""),[b,C]=r.useState(),[_,T]=r.useState(""),S=e=>{let{isValid:t,errorMessageKey:a}=(0,N.checkKeys)([e],!1);return!!t||(u({type:"error",message:o(`varKeyError.${a}`,{ns:"appDebug",key:o("env.modal.name",{ns:"workflow"})})}),!1)};return(0,r.useEffect)(()=>{if(a){x(a.value_type),g(a.name);let e=p.getState().envSecrets;C("secret"===a.value_type?e[a.id]:a.value),T(a.description)}},[a,p]),(0,t.jsxs)("div",{className:(0,n.cn)("flex h-full w-[360px] flex-col rounded-2xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-2xl"),children:[(0,t.jsxs)("div",{className:"system-xl-semibold mb-3 flex shrink-0 items-center justify-between p-4 pb-0 text-text-primary",children:[a?o("env.modal.editTitle",{ns:"workflow"}):o("env.modal.title",{ns:"workflow"}),(0,t.jsx)("div",{className:"flex items-center",children:(0,t.jsx)("div",{className:"flex h-6 w-6 cursor-pointer items-center justify-center",onClick:s,children:(0,t.jsx)(d.RiCloseLine,{className:"h-4 w-4 text-text-tertiary"})})})]}),(0,t.jsxs)("div",{className:"px-4 py-2",children:[(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("div",{className:"system-sm-semibold mb-1 flex h-6 items-center text-text-secondary",children:o("env.modal.type",{ns:"workflow"})}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)("div",{className:(0,n.cn)("radius-md system-sm-regular flex w-[106px] cursor-pointer items-center justify-center border border-components-option-card-option-border bg-components-option-card-option-bg p-2 text-text-secondary hover:border-components-option-card-option-border-hover hover:bg-components-option-card-option-bg-hover hover:shadow-xs","string"===m&&"system-sm-medium border-[1.5px] border-components-option-card-option-selected-border bg-components-option-card-option-selected-bg text-text-primary shadow-xs hover:border-components-option-card-option-selected-border"),onClick:()=>x("string"),children:"String"}),(0,t.jsx)("div",{className:(0,n.cn)("radius-md system-sm-regular flex w-[106px] cursor-pointer items-center justify-center border border-components-option-card-option-border bg-components-option-card-option-bg p-2 text-text-secondary hover:border-components-option-card-option-border-hover hover:bg-components-option-card-option-bg-hover hover:shadow-xs","number"===m&&"border-[1.5px] border-components-option-card-option-selected-border bg-components-option-card-option-selected-bg font-medium text-text-primary shadow-xs hover:border-components-option-card-option-selected-border"),onClick:()=>{x("number"),/^\d$/.test(b)||C("")},children:"Number"}),(0,t.jsxs)("div",{className:(0,n.cn)("radius-md system-sm-regular flex w-[106px] cursor-pointer items-center justify-center border border-components-option-card-option-border bg-components-option-card-option-bg p-2 text-text-secondary hover:border-components-option-card-option-border-hover hover:bg-components-option-card-option-bg-hover hover:shadow-xs","secret"===m&&"border-[1.5px] border-components-option-card-option-selected-border bg-components-option-card-option-selected-bg font-medium text-text-primary shadow-xs hover:border-components-option-card-option-selected-border"),onClick:()=>x("secret"),children:[(0,t.jsx)("span",{children:"Secret"}),(0,t.jsx)(k.default,{popupContent:(0,t.jsx)("div",{className:"w-[240px]",children:o("env.modal.secretTip",{ns:"workflow"})}),triggerClassName:"ml-0.5 w-3.5 h-3.5"})]})]})]}),(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("div",{className:"system-sm-semibold mb-1 flex h-6 items-center text-text-secondary",children:o("env.modal.name",{ns:"workflow"})}),(0,t.jsx)("div",{className:"flex",children:(0,t.jsx)(w.default,{placeholder:o("env.modal.namePlaceholder",{ns:"workflow"})||"",value:h,onChange:e=>{(0,N.replaceSpaceWithUnderscoreInVarNameInput)(e.target),(!e.target.value||S(e.target.value))&&g(e.target.value||"")},onBlur:e=>S(e.target.value),type:"text"})})]}),(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("div",{className:"system-sm-semibold mb-1 flex h-6 items-center text-text-secondary",children:o("env.modal.value",{ns:"workflow"})}),(0,t.jsx)("div",{className:"flex",children:"number"!==m?(0,t.jsx)("textarea",{className:"system-sm-regular placeholder:system-sm-regular block h-20 w-full resize-none appearance-none rounded-lg border border-transparent bg-components-input-bg-normal p-2 text-components-input-text-filled caret-primary-600 outline-none placeholder:text-components-input-text-placeholder hover:border-components-input-border-hover hover:bg-components-input-bg-hover focus:border-components-input-border-active focus:bg-components-input-bg-active focus:shadow-xs",value:b,placeholder:o("env.modal.valuePlaceholder",{ns:"workflow"})||"",onChange:e=>C(e.target.value)}):(0,t.jsx)(w.default,{placeholder:o("env.modal.valuePlaceholder",{ns:"workflow"})||"",value:b,onChange:e=>C(e.target.value),type:"number"})})]}),(0,t.jsxs)("div",{className:"",children:[(0,t.jsx)("div",{className:"system-sm-semibold mb-1 flex h-6 items-center text-text-secondary",children:o("env.modal.description",{ns:"workflow"})}),(0,t.jsx)("div",{className:"flex",children:(0,t.jsx)("textarea",{className:"system-sm-regular placeholder:system-sm-regular block h-20 w-full resize-none appearance-none rounded-lg border border-transparent bg-components-input-bg-normal p-2 text-components-input-text-filled caret-primary-600 outline-none placeholder:text-components-input-text-placeholder hover:border-components-input-border-hover hover:bg-components-input-bg-hover focus:border-components-input-border-active focus:bg-components-input-bg-active focus:shadow-xs",value:_,placeholder:o("env.modal.descriptionPlaceholder",{ns:"workflow"})||"",onChange:e=>T(e.target.value)})})]})]}),(0,t.jsx)("div",{className:"flex flex-row-reverse rounded-b-2xl p-4 pt-2",children:(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)(f.default,{onClick:s,children:o("operation.cancel",{ns:"common"})}),(0,t.jsx)(f.default,{variant:"primary",onClick:()=>{if(!S(h))return;if(!b)return u({type:"error",message:"value can not be empty"});let e=p.getState().environmentVariables;if(a&&a.name!==h&&e.some(e=>e.name===h)||!a&&e.some(e=>e.name===h))return u({type:"error",message:"name is existed"});l({id:a?a.id:(0,v.v4)(),value_type:m,name:h,value:"number"===m?Number(b):b,description:_}),s()},children:o("operation.save",{ns:"common"})})]})})]})},_=e=>{let{open:a,setOpen:r,env:s,onClose:l,onSave:n}=e,{t:o}=(0,c.useTranslation)();return(0,t.jsxs)(b.PortalToFollowElem,{open:a,onOpenChange:()=>{r(e=>!e),a&&l()},placement:"left-start",offset:{mainAxis:8,alignmentAxis:-104},children:[(0,t.jsx)(b.PortalToFollowElemTrigger,{onClick:()=>{r(e=>!e),a&&l()},children:(0,t.jsxs)(f.default,{variant:"primary",children:[(0,t.jsx)(d.RiAddLine,{className:"mr-1 h-4 w-4"}),(0,t.jsx)("span",{className:"system-sm-medium",children:o("env.envPanelButton",{ns:"workflow"})})]})}),(0,t.jsx)(b.PortalToFollowElemContent,{className:"z-[11]",children:(0,t.jsx)(C,{env:s,onSave:n,onClose:()=>{l(),r(!1)}})})]})},T=(0,r.memo)(()=>{let{t:e}=(0,c.useTranslation)(),a=(0,s.useStoreApi)(),l=(0,i.useStore)(e=>e.setShowEnvPanel),o=(0,i.useStore)(e=>e.environmentVariables),x=(0,i.useStore)(e=>e.envSecrets),h=(0,i.useStore)(e=>e.setEnvironmentVariables),f=(0,i.useStore)(e=>e.setEnvSecrets),{doSyncWorkflowDraft:b}=(0,u.useNodesSyncDraft)(),[y,v]=(0,r.useState)(!1),[w,j]=(0,r.useState)(),[k,N]=(0,r.useState)(!1),[C,T]=(0,r.useState)(),S=e=>e.length>8?`${e.slice(0,6)}************${e.slice(-2)}`:"********************",E=(0,r.useCallback)(e=>{let{getNodes:t}=a.getState(),r=t();return(0,m.findUsedVarNodes)(["env",e.name],r)},[a]),V=(0,r.useCallback)(e=>{let{getNodes:t,setNodes:r}=a.getState(),s=E(e);r(t().map(t=>s.find(e=>e.id===t.id)?(0,m.updateNodeVars)(t,["env",e.name],[]):t))},[E,a]),I=e=>{j(e),v(!0)},R=(0,r.useCallback)(e=>{if(V(e),h(o.filter(t=>t.id!==e.id)),T(void 0),N(!1),b(),"secret"===e.value_type){let t={...x};delete t[e.id],f(t)}},[b,o,x,V,f,h]),M=(0,r.useCallback)(e=>{E(e).length>0?(T(e),N(!0)):R(e)},[E,R]),A=(0,r.useCallback)(async e=>{let t=e;if(w)"secret"===w.value_type?"secret"===e.value_type&&(x[w.id]!==e.value?(t=e,f({...x,[e.id]:S(e.value)})):t={...e,value:"[__HIDDEN__]"}):"secret"===e.value_type&&(t=e,f({...x,[e.id]:S(e.value)}));else{"secret"===e.value_type&&f({...x,[e.id]:S(e.value)});let t=[e,...o];h(t),await b(),h(t.map(t=>t.id===e.id&&"secret"===e.value_type?{...t,value:"[__HIDDEN__]"}:t));return}let r=o.map(e=>e.id===w.id?t:e);if(h(r),w.name!==e.name){let{getNodes:t,setNodes:r}=a.getState(),s=E(w);r(t().map(t=>s.find(e=>e.id===t.id)?(0,m.updateNodeVars)(t,["env",w.name],["env",e.name]):t))}await b(),h(r.map(t=>t.id===e.id&&"secret"===e.value_type?{...t,value:"[__HIDDEN__]"}:t))},[w,b,o,x,E,f,a,h]);return(0,t.jsxs)("div",{className:(0,n.cn)("relative flex h-full w-[420px] flex-col rounded-l-2xl border border-components-panel-border bg-components-panel-bg-alt"),children:[(0,t.jsxs)("div",{className:"system-xl-semibold flex shrink-0 items-center justify-between p-4 pb-0 text-text-primary",children:[e("env.envPanelTitle",{ns:"workflow"}),(0,t.jsx)("div",{className:"flex items-center",children:(0,t.jsx)("div",{className:"flex h-6 w-6 cursor-pointer items-center justify-center",onClick:()=>l(!1),children:(0,t.jsx)(d.RiCloseLine,{className:"h-4 w-4 text-text-tertiary"})})})]}),(0,t.jsx)("div",{className:"system-sm-regular shrink-0 px-4 py-1 text-text-tertiary",children:e("env.envDescription",{ns:"workflow"})}),(0,t.jsx)("div",{className:"shrink-0 px-4 pb-3 pt-2",children:(0,t.jsx)(_,{open:y,setOpen:v,env:w,onSave:A,onClose:()=>j(void 0)})}),(0,t.jsx)("div",{className:"grow overflow-y-auto rounded-b-2xl px-4",children:o.map(e=>(0,t.jsx)(g,{env:e,onEdit:I,onDelete:M},e.id))}),(0,t.jsx)(p.default,{isShow:k,onCancel:()=>N(!1),onConfirm:()=>C&&R(C)})]})}),S=(0,a.default)(()=>e.A(253777),{loadableGenerated:{modules:[580158]},ssr:!1}),E=(e,t)=>e.borderBoxSize?.length>0?e.borderBoxSize[0].inlineSize:e.contentRect.width>0?e.contentRect.width:t.getBoundingClientRect().width,V=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=(0,r.useRef)(null),s=(0,r.useCallback)(e,[e]);return(0,r.useEffect)(()=>{let e=a.current;if(!e)return;let t=new ResizeObserver(t=>{for(let a of t)s(E(a,e))});return t.observe(e),s(e.getBoundingClientRect().width),()=>{t.disconnect()}},[s,...t]),a},I=(0,r.memo)(e=>{let{components:a,versionHistoryPanelProps:d}=e,c=(0,s.useStore)((0,l.useShallow)(e=>{let t=e.getNodes().find(e=>e.data.selected);if(t)return{id:t.id,type:t.type,data:t.data}})),u=(0,i.useStore)(e=>e.showEnvPanel),p=(0,i.useStore)(e=>e.isRestoring),m=(0,i.useStore)(e=>e.showWorkflowVersionHistoryPanel),x=(0,i.useStore)(e=>e.workflowCanvasWidth),h=(0,i.useStore)(e=>e.previewPanelWidth),g=(0,i.useStore)(e=>e.setPreviewPanelWidth);(0,r.useEffect)(()=>{if(!c||!x)return;let e=Math.max(x-400-400,400);h>e&&g(e)},[c,x,h,g]);let f=(0,i.useStore)(e=>e.setRightPanelWidth),b=(0,i.useStore)(e=>e.setOtherPanelWidth),y=V(f,[f,c,u,m]),v=V(b,[b,u,m]);return(0,t.jsxs)("div",{ref:y,tabIndex:-1,className:(0,n.cn)("absolute bottom-1 right-0 top-14 z-10 flex outline-none"),children:[a?.left,!!c&&(0,t.jsx)(o.Panel,{...c}),(0,t.jsxs)("div",{className:"relative",ref:v,children:[a?.right,m&&(0,t.jsx)(S,{...d}),u&&(0,t.jsx)(T,{})]})]},`${p}`)});e.s(["default",0,I],525160)}]);