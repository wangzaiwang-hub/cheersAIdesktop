(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,368148,e=>{"use strict";var t=e.i(105845),a=e.i(268255),o=e.i(192447),i=e.i(189299),n=e.i(390622),r=e.i(972282);e.s(["useAutoGenerateWebhookUrl",0,()=>{let e=(0,o.useStoreApi)();return(0,a.useCallback)(async a=>{let o=i.useStore.getState().appDetail?.id;if(!o)return;let{getNodes:d}=e.getState(),l=d().find(e=>e.id===a);if(l&&l.data.type===n.BlockEnum.TriggerWebhook&&(!l.data.webhook_url||!(l.data.webhook_url.length>0)))try{let i=await (0,r.fetchWebhookUrl)({appId:o,nodeId:a}),{getNodes:d,setNodes:l}=e.getState(),s=!1,u=(0,t.produce)(d(),e=>{let t=e.find(e=>e.id===a);t&&t.data.type===n.BlockEnum.TriggerWebhook&&(t.data={...t.data,webhook_url:i.webhook_url,webhook_debug_url:i.webhook_debug_url},s=!0)});s&&l(u)}catch(e){console.error("Failed to auto-generate webhook URL:",e)}},[e])}])},585736,e=>{"use strict";e.s(["createHooksStore",()=>r,"useHooksStore",()=>d]);var t=e.i(124836),a=e.i(268255),o=e.i(639751),i=e.i(763989),n=e.i(407396);let r=e=>{let{doSyncWorkflowDraft:a=async()=>(0,t.noop)(),syncWorkflowDraftWhenPageClose:o=t.noop,handleRefreshWorkflowDraft:n=t.noop,handleBackupDraft:r=t.noop,handleLoadBackupDraft:d=t.noop,handleRestoreFromPublishedWorkflow:l=t.noop,handleRun:s=t.noop,handleStopRun:u=t.noop,handleStartWorkflowRun:c=t.noop,handleWorkflowStartRunInWorkflow:p=t.noop,handleWorkflowStartRunInChatflow:g=t.noop,handleWorkflowTriggerScheduleRunInWorkflow:f=t.noop,handleWorkflowTriggerWebhookRunInWorkflow:h=t.noop,handleWorkflowTriggerPluginRunInWorkflow:y=t.noop,handleWorkflowRunAllTriggersInWorkflow:S=t.noop,availableNodesMetaData:I={nodes:[]},getWorkflowRunAndTraceUrl:k=()=>({runUrl:"",traceUrl:""}),exportCheck:E=async()=>(0,t.noop)(),handleExportDSL:m=async()=>(0,t.noop)(),fetchInspectVars:w=async()=>(0,t.noop)(),hasNodeInspectVars:_=()=>!1,hasSetInspectVar:T=()=>!1,fetchInspectVarValue:N=async()=>(0,t.noop)(),editInspectVarValue:C=async()=>(0,t.noop)(),renameInspectVarName:v=async()=>(0,t.noop)(),appendNodeInspectVars:D=()=>(0,t.noop)(),deleteInspectVar:b=async()=>(0,t.noop)(),deleteNodeInspectorVars:O=async()=>(0,t.noop)(),deleteAllInspectorVars:A=async()=>(0,t.noop)(),isInspectVarEdited:P=()=>!1,resetToLastRunVar:B=async()=>(0,t.noop)(),invalidateSysVarValues:x=t.noop,resetConversationVar:R=async()=>(0,t.noop)(),invalidateConversationVarValues:M=t.noop}=e;return(0,i.createStore)(e=>({refreshAll:t=>e(e=>({...e,...t})),doSyncWorkflowDraft:a,syncWorkflowDraftWhenPageClose:o,handleRefreshWorkflowDraft:n,handleBackupDraft:r,handleLoadBackupDraft:d,handleRestoreFromPublishedWorkflow:l,handleRun:s,handleStopRun:u,handleStartWorkflowRun:c,handleWorkflowStartRunInWorkflow:p,handleWorkflowStartRunInChatflow:g,handleWorkflowTriggerScheduleRunInWorkflow:f,handleWorkflowTriggerWebhookRunInWorkflow:h,handleWorkflowTriggerPluginRunInWorkflow:y,handleWorkflowRunAllTriggersInWorkflow:S,availableNodesMetaData:I,getWorkflowRunAndTraceUrl:k,exportCheck:E,handleExportDSL:m,fetchInspectVars:w,hasNodeInspectVars:_,hasSetInspectVar:T,fetchInspectVarValue:N,editInspectVarValue:C,renameInspectVarName:v,appendNodeInspectVars:D,deleteInspectVar:b,deleteNodeInspectorVars:O,deleteAllInspectorVars:A,isInspectVarEdited:P,resetToLastRunVar:B,invalidateSysVarValues:x,resetConversationVar:R,invalidateConversationVarValues:M}))};function d(e){let t=(0,a.useContext)(n.HooksStoreContext);if(!t)throw Error("Missing HooksStoreContext.Provider in the tree");return(0,o.useStore)(t,e)}},407396,e=>{"use strict";e.s(["HooksStoreContext",()=>n,"HooksStoreContextProvider",()=>r]);var t=e.i(563199),a=e.i(268255),o=e.i(192447),i=e.i(585736);let n=(0,a.createContext)(null),r=e=>{let{children:r,...d}=e,l=(0,a.useRef)(void 0),s=(0,o.useStore)(e=>e.d3Selection),u=(0,o.useStore)(e=>e.d3Zoom);return(0,a.useEffect)(()=>{l.current&&s&&u&&l.current.getState().refreshAll(d)},[s,u]),l.current||(l.current=(0,i.createHooksStore)(d)),(0,t.jsx)(n.Provider,{value:l.current,children:r})}},491401,e=>{"use strict";e.i(407396),e.i(585736),e.s([])},275225,305230,705405,e=>{"use strict";e.s([],275225),e.i(845296),e.s(["createWorkflowStore",()=>s,"useStore",()=>u,"useWorkflowStore",()=>c],705405);var t=e.i(268255),a=e.i(639751),o=e.i(763989);e.s(["WorkflowContext",()=>n,"WorkflowContextProvider",()=>r],305230);var i=e.i(563199);let n=(0,t.createContext)(null),r=e=>{let{children:a,injectWorkflowStoreSliceFn:o}=e,r=(0,t.useRef)(void 0);return r.current||(r.current=s({injectWorkflowStoreSliceFn:o})),(0,i.jsx)(n.Provider,{value:r.current,children:a})};var d=e.i(105845),l=e.i(813672);let s=e=>{let{injectWorkflowStoreSliceFn:t}=e||{};return(0,o.createStore)(function(){for(var e=arguments.length,a=Array(e),o=0;o<e;o++)a[o]=arguments[o];return{...(e=>{let t={showDebugAndPreviewPanel:!1,showEnvPanel:!1,showChatVariablePanel:!1,showGlobalVariablePanel:!1};return{showChatVariablePanel:!1,setShowChatVariablePanel:a=>e(()=>a?{...t,showChatVariablePanel:!0}:{showChatVariablePanel:!1}),showGlobalVariablePanel:!1,setShowGlobalVariablePanel:a=>e(()=>a?{...t,showGlobalVariablePanel:!0}:{showGlobalVariablePanel:!1}),conversationVariables:[],setConversationVariables:t=>e(()=>({conversationVariables:t}))}})(...a),...(e=>{let t={showDebugAndPreviewPanel:!1,showEnvPanel:!1,showChatVariablePanel:!1,showGlobalVariablePanel:!1};return{showEnvPanel:!1,setShowEnvPanel:a=>e(()=>a?{...t,showEnvPanel:!0}:{showEnvPanel:!1}),environmentVariables:[],setEnvironmentVariables:t=>e(()=>({environmentVariables:t})),envSecrets:{},setEnvSecrets:t=>e(()=>({envSecrets:t}))}})(...a),...(e=>({inputs:{},setInputs:t=>e(()=>({inputs:t})),files:[],setFiles:t=>e(()=>({files:t}))}))(...a),...(e=>({helpLineHorizontal:void 0,setHelpLineHorizontal:t=>e(()=>({helpLineHorizontal:t})),helpLineVertical:void 0,setHelpLineVertical:t=>e(()=>({helpLineVertical:t}))}))(...a),...(e=>({historyWorkflowData:void 0,setHistoryWorkflowData:t=>e(()=>({historyWorkflowData:t})),showRunHistory:!1,setShowRunHistory:t=>e(()=>({showRunHistory:t})),versionHistory:[],setVersionHistory:t=>e(()=>({versionHistory:t}))}))(...a),...(e=>({showSingleRunPanel:!1,setShowSingleRunPanel:t=>e(()=>({showSingleRunPanel:t})),nodeAnimation:!1,setNodeAnimation:t=>e(()=>({nodeAnimation:t})),candidateNode:void 0,setCandidateNode:t=>e(()=>({candidateNode:t})),nodeMenu:void 0,setNodeMenu:t=>e(()=>({nodeMenu:t})),showAssignVariablePopup:void 0,setShowAssignVariablePopup:t=>e(()=>({showAssignVariablePopup:t})),hoveringAssignVariableGroupId:void 0,setHoveringAssignVariableGroupId:t=>e(()=>({hoveringAssignVariableGroupId:t})),connectingNodePayload:void 0,setConnectingNodePayload:t=>e(()=>({connectingNodePayload:t})),enteringNodePayload:void 0,setEnteringNodePayload:t=>e(()=>({enteringNodePayload:t})),iterTimes:1,setIterTimes:t=>e(()=>({iterTimes:t})),loopTimes:1,setLoopTimes:t=>e(()=>({loopTimes:t})),iterParallelLogMap:new Map,setIterParallelLogMap:t=>e(()=>({iterParallelLogMap:t})),pendingSingleRun:void 0,setPendingSingleRun:t=>e(()=>({pendingSingleRun:t}))}))(...a),...(e=>({panelWidth:localStorage.getItem("workflow-node-panel-width")?Number.parseFloat(localStorage.getItem("workflow-node-panel-width")):420,showFeaturesPanel:!1,setShowFeaturesPanel:t=>e(()=>({showFeaturesPanel:t})),showWorkflowVersionHistoryPanel:!1,setShowWorkflowVersionHistoryPanel:t=>e(()=>({showWorkflowVersionHistoryPanel:t})),showInputsPanel:!1,setShowInputsPanel:t=>e(()=>({showInputsPanel:t})),showDebugAndPreviewPanel:!1,setShowDebugAndPreviewPanel:t=>e(()=>({showDebugAndPreviewPanel:t})),panelMenu:void 0,setPanelMenu:t=>e(()=>({panelMenu:t})),selectionMenu:void 0,setSelectionMenu:t=>e(()=>({selectionMenu:t})),showVariableInspectPanel:!1,setShowVariableInspectPanel:t=>e(()=>({showVariableInspectPanel:t})),initShowLastRunTab:!1,setInitShowLastRunTab:t=>e(()=>({initShowLastRunTab:t}))}))(...a),...(e=>({toolPublished:!1,setToolPublished:t=>e(()=>({toolPublished:t})),lastPublishedHasUserInput:!1,setLastPublishedHasUserInput:t=>e(()=>({lastPublishedHasUserInput:t})),buildInTools:void 0,customTools:void 0,workflowTools:void 0,mcpTools:void 0}))(...a),...(e=>({draftUpdatedAt:0,setDraftUpdatedAt:t=>e(()=>({draftUpdatedAt:t?1e3*t:0})),publishedAt:0,setPublishedAt:t=>e(()=>({publishedAt:t?1e3*t:0})),currentVersion:null,setCurrentVersion:t=>e(()=>({currentVersion:t})),isRestoring:!1,setIsRestoring:t=>e(()=>({isRestoring:t}))}))(...a),...(e=>{let t=(0,l.debounce)(e=>{e()},5e3);return{backupDraft:void 0,setBackupDraft:t=>e(()=>({backupDraft:t})),debouncedSyncWorkflowDraft:t,syncWorkflowDraftHash:"",setSyncWorkflowDraftHash:t=>e(()=>({syncWorkflowDraftHash:t})),isSyncingWorkflowDraft:!1,setIsSyncingWorkflowDraft:t=>e(()=>({isSyncingWorkflowDraft:t})),isWorkflowDataLoaded:!1,setIsWorkflowDataLoaded:t=>e(()=>({isWorkflowDataLoaded:t})),nodes:[],setNodes:t=>e(()=>({nodes:t})),flushPendingSync:()=>{t.flush&&t.flush()}}})(...a),...(e=>({workflowRunningData:void 0,setWorkflowRunningData:t=>e(()=>({workflowRunningData:t})),isListening:!1,setIsListening:t=>e(()=>({isListening:t})),listeningTriggerType:null,setListeningTriggerType:t=>e(()=>({listeningTriggerType:t})),listeningTriggerNodeId:null,setListeningTriggerNodeId:t=>e(()=>({listeningTriggerNodeId:t})),listeningTriggerNodeIds:[],setListeningTriggerNodeIds:t=>e(()=>({listeningTriggerNodeIds:t})),listeningTriggerIsAll:!1,setListeningTriggerIsAll:t=>e(()=>({listeningTriggerIsAll:t})),clipboardElements:[],setClipboardElements:t=>e(()=>({clipboardElements:t})),selection:null,setSelection:t=>e(()=>({selection:t})),bundleNodeSize:null,setBundleNodeSize:t=>e(()=>({bundleNodeSize:t})),controlMode:"pointer"===localStorage.getItem("workflow-operation-mode")?"pointer":"hand",setControlMode:t=>{e(()=>({controlMode:t})),localStorage.setItem("workflow-operation-mode",t)},mousePosition:{pageX:0,pageY:0,elementX:0,elementY:0},setMousePosition:t=>e(()=>({mousePosition:t})),showConfirm:void 0,setShowConfirm:t=>e(()=>({showConfirm:t})),controlPromptEditorRerenderKey:0,setControlPromptEditorRerenderKey:t=>e(()=>({controlPromptEditorRerenderKey:t})),showImportDSLModal:!1,setShowImportDSLModal:t=>e(()=>({showImportDSLModal:t})),fileUploadConfig:void 0,setFileUploadConfig:t=>e(()=>({fileUploadConfig:t}))}))(...a),...(e=>({currentFocusNodeId:null,nodesWithInspectVars:[],conversationVars:[],setCurrentFocusNodeId:t=>{e(()=>({currentFocusNodeId:t}))},setNodesWithInspectVars:t=>{e(()=>({nodesWithInspectVars:t}))},deleteAllInspectVars:()=>{e(()=>({nodesWithInspectVars:[]}))},setNodeInspectVars:(t,a)=>{e(e=>{let o=e.nodesWithInspectVars;return{nodesWithInspectVars:(0,d.produce)(o,e=>{let i=o.findIndex(e=>e.nodeId===t);-1!==i&&(e[i].vars=a,e[i].isValueFetched=!0)})}})},deleteNodeInspectVars:t=>{e(e=>({nodesWithInspectVars:e.nodesWithInspectVars.filter(e=>e.nodeId!==t)}))},setInspectVarValue:(t,a,o)=>{e(e=>({nodesWithInspectVars:(0,d.produce)(e.nodesWithInspectVars,e=>{let i=e.find(e=>e.nodeId===t);if(!i)return;let n=i.vars.find(e=>e.id===a);n&&(n.value=o,n.edited=!0)})}))},resetToLastRunVar:(t,a,o)=>{e(e=>({nodesWithInspectVars:(0,d.produce)(e.nodesWithInspectVars,e=>{let i=e.find(e=>e.nodeId===t);if(!i)return;let n=i.vars.find(e=>e.id===a);n&&(n.value=o,n.edited=!1)})}))},renameInspectVarName:(t,a,o)=>{e(e=>({nodesWithInspectVars:(0,d.produce)(e.nodesWithInspectVars,e=>{let i=e.find(e=>e.nodeId===t);if(!i)return;let n=i.vars.find(e=>e.id===a);n&&(n.name=o[1],n.selector=o)})}))},deleteInspectVar:(t,a)=>{e(e=>({nodesWithInspectVars:(0,d.produce)(e.nodesWithInspectVars,e=>{let o=e.find(e=>e.nodeId===t);if(!o)return;let i=o.vars.findIndex(e=>e.id===a);-1!==i&&o.vars.splice(i,1)})}))}}))(...a),...(e=>({workflowCanvasWidth:void 0,workflowCanvasHeight:void 0,setWorkflowCanvasWidth:t=>e(()=>({workflowCanvasWidth:t})),setWorkflowCanvasHeight:t=>e(()=>({workflowCanvasHeight:t})),rightPanelWidth:void 0,setRightPanelWidth:t=>e(()=>({rightPanelWidth:t})),nodePanelWidth:localStorage.getItem("workflow-node-panel-width")?Number.parseFloat(localStorage.getItem("workflow-node-panel-width")):400,setNodePanelWidth:t=>e(()=>({nodePanelWidth:t})),previewPanelWidth:localStorage.getItem("debug-and-preview-panel-width")?Number.parseFloat(localStorage.getItem("debug-and-preview-panel-width")):400,setPreviewPanelWidth:t=>e(()=>({previewPanelWidth:t})),otherPanelWidth:400,setOtherPanelWidth:t=>e(()=>({otherPanelWidth:t})),bottomPanelWidth:480,setBottomPanelWidth:t=>e(()=>({bottomPanelWidth:t})),bottomPanelHeight:324,setBottomPanelHeight:t=>e(()=>({bottomPanelHeight:t})),variableInspectPanelHeight:localStorage.getItem("workflow-variable-inpsect-panel-height")?Number.parseFloat(localStorage.getItem("workflow-variable-inpsect-panel-height")):320,setVariableInspectPanelHeight:t=>e(()=>({variableInspectPanelHeight:t})),maximizeCanvas:"true"===localStorage.getItem("workflow-canvas-maximize"),setMaximizeCanvas:t=>e(()=>({maximizeCanvas:t}))}))(...a),...t?.(...a)||{}}})};function u(e){let o=(0,t.useContext)(n);if(!o)throw Error("Missing WorkflowContext.Provider in the tree");return(0,a.useStore)(o,e)}let c=()=>(0,t.useContext)(n)},3340,148280,e=>{"use strict";var t=e.i(268255),a=e.i(390622),o=e.i(946700);e.i(491401);var i=e.i(585736);e.i(275225);var n=e.i(705405),r=e.i(683257),d=e.i(154033),l=e.i(842090);let s=()=>{let e=(0,i.useHooksStore)(e=>e.availableNodesMetaData);return(0,t.useMemo)(()=>({nodes:e?.nodes||[],nodesMap:e?.nodesMap||{}}),[e])};e.s(["useNodeMetaData",0,e=>{let i=(0,r.useGetLanguage)(),{data:u}=(0,d.useAllBuiltInTools)(),{data:c}=(0,d.useAllCustomTools)(),{data:p}=(0,d.useAllWorkflowTools)(),g=(0,n.useStore)(e=>e.dataSourceList),f=s(),{data:h}=e,y=f.nodesMap?.[h.type],S=(0,t.useMemo)(()=>h.type===a.BlockEnum.DataSource?g?.find(e=>e.plugin_id===h.plugin_id)?.author:h.type===a.BlockEnum.Tool?h.provider_type===o.CollectionType.builtIn?u?.find(e=>(0,l.canFindTool)(e.id,h.provider_id))?.author:h.provider_type===o.CollectionType.workflow?p?.find(e=>e.id===h.provider_id)?.author:c?.find(e=>e.id===h.provider_id)?.author:y?.metaData.author,[h,u,c,p,y,g]),I=(0,t.useMemo)(()=>h.type===a.BlockEnum.DataSource?g?.find(e=>e.plugin_id===h.plugin_id)?.description[i]:h.type===a.BlockEnum.Tool?h.provider_type===o.CollectionType.builtIn?u?.find(e=>(0,l.canFindTool)(e.id,h.provider_id))?.description[i]:h.provider_type===o.CollectionType.workflow?p?.find(e=>e.id===h.provider_id)?.description[i]:c?.find(e=>e.id===h.provider_id)?.description[i]:y?.metaData.description,[h,u,c,p,y,g,i]);return(0,t.useMemo)(()=>({...y?.metaData,author:S,description:I}),[S,y,I])},"useNodesMetaData",0,s],148280);let u=(e,t)=>(!t||e!==a.BlockEnum.Iteration&&e!==a.BlockEnum.Loop&&e!==a.BlockEnum.End&&e!==a.BlockEnum.DataSource&&e!==a.BlockEnum.KnowledgeBase)&&(!!t||e!==a.BlockEnum.LoopEnd)&&!0;e.s(["useAvailableBlocks",0,(e,o)=>{let{nodes:i}=s(),n=(0,t.useMemo)(()=>i.map(e=>e.metaData.type),[i]),r=(0,t.useMemo)(()=>e&&e!==a.BlockEnum.Start&&e!==a.BlockEnum.DataSource&&e!==a.BlockEnum.TriggerPlugin&&e!==a.BlockEnum.TriggerWebhook&&e!==a.BlockEnum.TriggerSchedule?n:[],[n,e]),d=(0,t.useMemo)(()=>e&&e!==a.BlockEnum.End&&e!==a.BlockEnum.LoopEnd&&e!==a.BlockEnum.KnowledgeBase?n:[],[n,e]),l=(0,t.useCallback)((e,t)=>{let o=n;e&&e!==a.BlockEnum.Start&&e!==a.BlockEnum.DataSource||(o=[]);let i=n;return e&&e!==a.BlockEnum.End&&e!==a.BlockEnum.LoopEnd&&e!==a.BlockEnum.KnowledgeBase||(i=[]),{availablePrevBlocks:o.filter(e=>u(e,t)),availableNextBlocks:i.filter(e=>u(e,t))}},[n]);return(0,t.useMemo)(()=>({getAvailableBlocks:l,availablePrevBlocks:r.filter(e=>u(e,o)),availableNextBlocks:d.filter(e=>u(e,o))}),[l,r,d,o])}],3340)},616332,e=>{"use strict";e.i(275225);var t=e.i(705405);e.s(["default",0,()=>(0,t.useStore)(e=>e.nodes)])},18084,517317,95131,227785,e=>{"use strict";e.s(["createDatasetsDetailStore",()=>u,"useDatasetsDetailStore",()=>c],18084);var t=e.i(105845),a=e.i(268255),o=e.i(763989),i=e.i(639751);e.s(["DatasetsDetailContext",()=>l,"default",()=>s],517317);var n=e.i(563199),r=e.i(211857),d=e.i(390622);let l=(0,a.createContext)(void 0),s=e=>{let{nodes:t,children:o}=e,i=(0,a.useRef)(void 0);i.current||(i.current=u());let s=(0,a.useCallback)(async e=>{let{data:t}=await (0,r.fetchDatasets)({url:"/datasets",params:{page:1,ids:e}});t&&t.length>0&&i.current.getState().updateDatasetsDetail(t)},[]);return(0,a.useEffect)(()=>{if(!i.current)return;let e=t.filter(e=>e.data.type===d.BlockEnum.KnowledgeRetrieval).reduce((e,t)=>Array.from(new Set([...e,...t.data.dataset_ids])),[]);0!==e.length&&s(e)},[]),(0,n.jsx)(l.Provider,{value:i.current,children:o})},u=()=>(0,o.createStore)((e,a)=>({datasetsDetail:{},updateDatasetsDetail:o=>{let i=a().datasetsDetail,n=o.reduce((e,t)=>(e[t.id]=t,e),{});e({datasetsDetail:(0,t.produce)(i,e=>{Object.entries(n).forEach(t=>{let[a,o]=t;e[a]=o})})})}})),c=e=>{let t=(0,a.useContext)(l);if(!t)throw Error("Missing DatasetsDetailContext.Provider in the tree");return(0,i.useStore)(t,e)};var p=e.i(946700),g=e.i(922521),f=e.i(154033),h=e.i(819114),y=e.i(842090);e.i(275225);var S=e.i(705405);let I=e=>e.type===d.BlockEnum.TriggerPlugin,k=e=>e.type===d.BlockEnum.Tool,E=e=>e.type===d.BlockEnum.DataSource,m=(e,t,a)=>"dark"===e&&a?a:t,w=(e,t,a)=>{let o=t||[];for(let t of e){if(!t)continue;let e=o.find(e=>e.id===t||(0,y.canFindTool)(e.id,t));if(e)return m(a,e.icon,e.icon_dark)}};e.s(["useGetToolIcon",0,()=>{let{data:e}=(0,f.useAllBuiltInTools)(),{data:t}=(0,f.useAllCustomTools)(),{data:o}=(0,f.useAllWorkflowTools)(),{data:i}=(0,f.useAllMCPTools)(),{data:n}=(0,h.useAllTriggerPlugins)(),r=(0,S.useWorkflowStore)(),{theme:d}=(0,g.default)();return(0,a.useCallback)(a=>{let{buildInTools:l,customTools:s,workflowTools:u,mcpTools:c,dataSourceList:g}=r.getState();if(I(a))return w([a.plugin_id,a.provider_id,a.provider_name],n,d);if(k(a)){let n=[(()=>{switch(a.provider_type){case p.CollectionType.custom:return s??t;case p.CollectionType.mcp:return c??i;case p.CollectionType.workflow:return u??o;case p.CollectionType.builtIn:default:return l??e}})(),l??e,s??t,u??o,c??i],r=new Set;for(let e of n){if(!e||r.has(e))continue;r.add(e);let t=e.find(e=>!!(0,y.canFindTool)(e.id,a.provider_id)||!!a.plugin_id&&e.plugin_id===a.plugin_id||a.provider_name===e.name);if(t){let e=m(d,t.icon,t.icon_dark);if(e)return e}}let g=m(d,a.provider_icon,a.provider_icon_dark);return g||void 0}if(E(a))return g?.find(e=>e.plugin_id===a.plugin_id)?.icon},[r,n,e,t,o,i,d])},"useToolIcon",0,e=>{let{data:t}=(0,f.useAllBuiltInTools)(),{data:o}=(0,f.useAllCustomTools)(),{data:i}=(0,f.useAllWorkflowTools)(),{data:n}=(0,f.useAllMCPTools)(),r=(0,S.useStore)(e=>e.dataSourceList),{data:d}=(0,h.useAllTriggerPlugins)(),{theme:l}=(0,g.default)();return(0,a.useMemo)(()=>{if(!e)return"";if(I(e)){let t=w([e.plugin_id,e.provider_id,e.provider_name],d,l);if(t)return t}if(k(e)){let a;switch(e.provider_type){case p.CollectionType.custom:a=o;break;case p.CollectionType.mcp:a=n;break;case p.CollectionType.workflow:a=i;break;case p.CollectionType.builtIn:default:a=t}let r=[a,t,o,i,n],d=new Set;for(let t of r){if(!t||d.has(t))continue;d.add(t);let a=t.find(t=>!!(0,y.canFindTool)(t.id,e.provider_id)||!!e.plugin_id&&t.plugin_id===e.plugin_id||e.provider_name===t.name);if(a){let e=m(l,a.icon,a.icon_dark);if(e)return e}}let s=m(l,e.provider_icon,e.provider_icon_dark);return s||""}return E(e)&&r?.find(t=>t.plugin_id===e.plugin_id)?.icon||""},[e,r,t,o,i,n,d,l])}],95131),e.s(["getTriggerCheckParams",0,(e,t,a)=>{if(!t)return{triggerInputsSchema:[],isReadyForCheckValid:!1};let{provider_id:o,provider_name:i,event_name:n}=e,r=t.find(e=>e.name===i||e.id===o||o&&e.plugin_id===o),d=r?.events.find(e=>e.name===n);return{triggerInputsSchema:(d?.parameters||[]).map(e=>{let t=e.label?.[a]||e.label?.en_US||e.name;return{variable:e.name,label:t,required:e.required}}),isReadyForCheckValid:!0}}],227785)},720315,205707,e=>{"use strict";e.s(["useIsChatMode",()=>S,"useIsNodeInIteration",()=>m,"useIsNodeInLoop",()=>w,"useNodesReadOnly",()=>E,"useWorkflow",()=>I,"useWorkflowReadOnly",()=>k],720315);var t=e.i(276925),a=e.i(268255),o=e.i(192447),i=e.i(189299),n=e.i(786191),r=e.i(4520),d=e.i(648404);e.i(845780);var l=e.i(148280),s=e.i(959752),u=e.i(963855),c=e.i(534042);e.i(275225);var p=e.i(705405),g=e.i(390622);function f(e){let t=e.find(e=>(0,g.isTriggerNode)(e.data.type));return t||e.find(e=>e.data.type===g.BlockEnum.Start)}function h(e){return e===g.BlockEnum.Start||(0,g.isTriggerNode)(e)}e.s(["getWorkflowEntryNode",()=>f,"isWorkflowEntryNode",()=>h],205707);var y=e.i(3340);let S=()=>{let e=(0,i.useStore)(e=>e.appDetail);return e?.mode===d.AppModeEnum.ADVANCED_CHAT},I=()=>{let e=(0,o.useStoreApi)(),{getAvailableBlocks:i}=(0,y.useAvailableBlocks)(),{nodesMap:d}=(0,l.useNodesMetaData)(),p=(0,a.useCallback)(t=>{let{getNodes:a}=e.getState();return a().find(e=>e.id===t)},[e]),g=(0,a.useCallback)(a=>{let{getNodes:i,edges:l}=e.getState(),u=i(),c=u.find(e=>e.id===a),p=u.filter(e=>d?.[e.data.type]?.metaData.isStart)||[];if(c?.parentId){let e=u.find(e=>e.parentId===c.parentId&&(e.type===n.CUSTOM_ITERATION_START_NODE||e.type===r.CUSTOM_LOOP_START_NODE));e&&(p=[e])}if(!p.length)return[];let g=[],f=(e,t)=>{if(e.id===a)return;let i=(0,o.getOutgoers)(e,u,l);i.length?i.forEach(e=>{f(e,t)}):e.id!==a&&t(e)};p.forEach(e=>{f(e,e=>{g.push(e)})});let h=(0,o.getIncomers)({id:a},u,l);return g.push(...h),(0,t.uniqBy)(g,"id").filter(e=>s.SUPPORT_OUTPUT_VARS_NODE.includes(e.data.type))},[e,d]),S=(0,a.useCallback)((a,i,n)=>{let{getNodes:r,edges:d}=e.getState(),l=i||r(),u=l.find(e=>e.id===a),c=[];if(!u)return c;if(u.parentId){let e=l.find(e=>e.id===u.parentId);if(e){let t=S(e.id);c.push(...t)}}let p=(e,t)=>{if(e){let a=(0,o.getIncomers)(e,l,n||d);a.length&&a.forEach(e=>{c.find(t=>e.id===t.id)||(t(e),p(e,t))})}};return(p(u,e=>{c.push(e)}),c.length)?(0,t.uniqBy)(c,"id").reverse().filter(e=>s.SUPPORT_OUTPUT_VARS_NODE.includes(e.data.type)):[]},[e]),I=(0,a.useCallback)((t,a,o)=>{let i=S(t,a,o),{getNodes:n}=e.getState(),r=n(),d=r.find(e=>e.id===t),l=d?.parentId,s=r.find(e=>e.id===l);return s&&i.push(s),i},[S,e]),k=(0,a.useCallback)(a=>{let{getNodes:i,edges:n}=e.getState(),r=i(),d=r.find(e=>e.id===a);if(!d)return[];let l=[d],s=(e,t)=>{if(e){let a=(0,o.getOutgoers)(e,r,n);a.length&&a.forEach(e=>{t(e),s(e,t)})}};return s(d,e=>{l.push(e)}),(0,t.uniqBy)(l,"id")},[e]),E=(0,a.useCallback)(t=>{let{getNodes:a,edges:i}=e.getState(),n=a(),r=n.find(e=>e.id===t);return(0,o.getIncomers)(r,n,i)},[e]),m=(0,a.useCallback)(t=>{let{getNodes:a}=e.getState();return a().filter(e=>e.parentId===t)},[e]),w=(0,a.useCallback)(t=>{let{getNodes:a}=e.getState();return a().filter(e=>e.parentId===t)},[e]),_=(0,a.useCallback)(t=>{let{getNodes:a}=e.getState(),o=a().find(e=>e.id===t);if(!o)return!1;if(h(o.data.type))return!0;let i=e=>{for(let t of E(e.id))if(h(t.data.type)||i(t))return!0;return!1};return i(o)},[e,E]),T=(0,a.useCallback)((t,a,o)=>{let{getNodes:i,setNodes:n}=e.getState(),r=i(),d=(0,u.findUsedVarNodes)(a,r);d.length>0&&n(r.map(e=>d.find(t=>t.id===e.id)?(0,u.updateNodeVars)(e,a,o):e))},[e]),N=(0,a.useCallback)(e=>{let t=k(e[0]);return(0,u.findUsedVarNodes)(e,t).length>0},[k]),C=(0,a.useCallback)(t=>{let a=t[0],{getNodes:o,setNodes:i}=e.getState(),n=k(a),r=(0,u.findUsedVarNodes)(t,n);r.length>0&&i(o().map(e=>r.find(t=>t.id===e.id)?(0,u.updateNodeVars)(e,t,[]):e))},[k,e]),v=(0,a.useCallback)((e,t)=>(0,u.getNodeOutputVars)(e,t).some(e=>N(e)),[N]),D=(0,a.useCallback)(a=>{let{getNodes:i,edges:n}=e.getState(),r=i(),d=r.find(e=>e.id===a),l=[];if(!d)return l;if(d.parentId){let e=r.find(e=>e.id===d.parentId);if(e){let t=D(e.id);l.push(...t)}}let s=(e,t)=>{if(e){let a=(0,o.getIncomers)(e,r,n);a.length?a.forEach(e=>{s(e,t)}):t(e)}};return(s(d,e=>{l.push(e)}),l.length)?(0,t.uniqBy)(l,"id"):[]},[e]),b=(0,a.useCallback)((e,t)=>{let{id:a,parentId:o}=t||{},i=[];if(o){let t=e.find(e=>e.id===o);if(!t)throw Error("Parent node not found");let a=e.find(e=>e.id===t.data.start_node_id);a&&(i=[a])}else i=e.filter(e=>d?.[e.data.type]?.metaData.isStart)||[];return i.length||(i=D(a||"")),i},[d,D]);return{getNodeById:p,getTreeLeafNodes:g,getBeforeNodesInSameBranch:S,getBeforeNodesInSameBranchIncludeParent:I,getAfterNodesInSameBranch:k,handleOutVarRenameChange:T,isVarUsedInNodes:N,removeUsedVarInNodes:C,isNodeVarsUsedInNodes:v,isValidConnection:(0,a.useCallback)(t=>{let{source:a,sourceHandle:n,target:r}=t,{edges:d,getNodes:l}=e.getState(),s=l(),u=s.find(e=>e.id===a),p=s.find(e=>e.id===r);if(u.type===c.CUSTOM_NOTE_NODE||p.type===c.CUSTOM_NOTE_NODE||u.parentId!==p.parentId)return!1;if(u&&p){let e=i(u.data.type,!!u.parentId).availableNextBlocks,t=i(p.data.type,!!p.parentId).availablePrevBlocks;if(!e.includes(p.data.type)||!t.includes(u.data.type))return!1}let g=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Set;if(t.has(e.id))return!1;for(let i of(t.add(e.id),(0,o.getOutgoers)(e,s,d)))if(i.id===a||g(i,t))return!0};return!g(p)},[e,i]),getBeforeNodeById:E,getIterationNodeChildren:m,getLoopNodeChildren:w,getRootNodesById:D,getStartNodes:b,isFromStartNode:_,getNode:(0,a.useCallback)(t=>{let{getNodes:a}=e.getState(),o=a();return o.find(e=>e.id===t)||f(o)},[e])}},k=()=>{let e=(0,p.useWorkflowStore)(),t=(0,p.useStore)(e=>e.workflowRunningData),o=(0,a.useCallback)(()=>e.getState().workflowRunningData?.result.status===g.WorkflowRunningStatus.Running,[e]);return{workflowReadOnly:t?.result.status===g.WorkflowRunningStatus.Running,getWorkflowReadOnly:o}},E=()=>{let e=(0,p.useWorkflowStore)(),t=(0,p.useStore)(e=>e.workflowRunningData),o=(0,p.useStore)(e=>e.historyWorkflowData),i=(0,p.useStore)(e=>e.isRestoring),n=(0,a.useCallback)(()=>{let{workflowRunningData:t,historyWorkflowData:a,isRestoring:o}=e.getState();return!!(t?.result.status===g.WorkflowRunningStatus.Running||a||o)},[e]);return{nodesReadOnly:!!(t?.result.status===g.WorkflowRunningStatus.Running||o||i),getNodesReadOnly:n}},m=e=>{let t=(0,o.useStoreApi)();return{isNodeInIteration:(0,a.useCallback)(a=>{let{getNodes:o}=t.getState(),i=o().find(e=>e.id===a);return!!i&&i.parentId===e},[e,t])}},w=e=>{let t=(0,o.useStoreApi)();return{isNodeInLoop:(0,a.useCallback)(a=>{let{getNodes:o}=t.getState(),i=o().find(e=>e.id===a);return!!i&&i.parentId===e},[e,t])}}},944419,949250,804612,e=>{"use strict";e.s(["useChecklist",()=>R,"useChecklistBeforePublish",()=>M,"useWorkflowRunValidation",()=>L],944419);var t=e.i(268255);e.i(152567);var a=e.i(408767),o=e.i(192447),i=e.i(189299),n=e.i(137667),r=e.i(739255),d=e.i(225162),l=e.i(616332),s=e.i(925521),u=e.i(683257),c=e.i(211857),p=e.i(243922),g=e.i(154033),f=e.i(819114),h=e.i(648404),y=e.i(959752),S=e.i(18084);e.i(845780);var I=e.i(95131),k=e.i(148280),E=e.i(963855);e.i(275225);var m=e.i(705405),w=e.i(390622);e.i(905691);var _=e.i(451660),T=e.i(476285),N=e.i(911684),C=e.i(227785),v=e.i(720315);e.s(["useWorkflowVariableType",()=>O,"useWorkflowVariables",()=>b],949250);var D=e.i(840247);let b=()=>{let{t:e}=(0,a.useTranslation)(),o=(0,m.useWorkflowStore)(),{schemaTypeDefinitions:i}=(0,D.default)(),{data:n}=(0,g.useAllBuiltInTools)(),{data:r}=(0,g.useAllCustomTools)(),{data:d}=(0,g.useAllWorkflowTools)(),{data:l}=(0,g.useAllMCPTools)();return{getNodeAvailableVars:(0,t.useCallback)(t=>{let{parentNode:a,beforeNodes:s,isChatMode:u,filterVar:c,hideEnv:p,hideChatVar:g}=t,{conversationVariables:f,environmentVariables:h,ragPipelineVariables:y,dataSourceList:S}=o.getState();return(0,E.toNodeAvailableVars)({parentNode:a,t:e,beforeNodes:s,isChatMode:u,environmentVariables:p?[]:h,conversationVariables:u&&!g?f:[],ragVariables:y,filterVar:c,allPluginInfoList:{buildInTools:n||[],customTools:r||[],workflowTools:d||[],mcpTools:l||[],dataSourceList:S||[]},schemaTypeDefinitions:i})},[e,o,i,n,r,d,l]),getCurrentVariableType:(0,t.useCallback)(e=>{let{parentNode:t,valueSelector:a,isIterationItem:s,isLoopItem:u,availableNodes:c,isChatMode:p,isConstant:g,preferSchemaType:f}=e,{conversationVariables:h,environmentVariables:y,ragPipelineVariables:S,dataSourceList:I}=o.getState();return(0,E.getVarType)({parentNode:t,valueSelector:a,isIterationItem:s,isLoopItem:u,availableNodes:c,isChatMode:p,isConstant:g,environmentVariables:y,conversationVariables:h,ragVariables:S,allPluginInfoList:{buildInTools:n||[],customTools:r||[],workflowTools:d||[],mcpTools:l||[],dataSourceList:I??[]},schemaTypeDefinitions:i,preferSchemaType:f})},[o,E.getVarType,i,n,r,d,l])}},O=()=>{let{getNodes:e}=(0,o.useStoreApi)().getState(),{getCurrentVariableType:t}=b(),a=(0,v.useIsChatMode)();return o=>{let{nodeId:i,valueSelector:n}=o,r=e().find(e=>e.id===i);return t({parentNode:r?.data.isInIteration?e().find(e=>e.id===r.parentId):null,valueSelector:n,availableNodes:[r],isChatMode:a,isConstant:!1})}},A=(e,t)=>{let a=t.find(t=>t.id===e),o=!!a?.data.isInIteration,i=!!a?.data.isInLoop,n=a?.parentId;return{node:a,isInIteration:o,isInLoop:i,parentNode:t.find(e=>e.id===n)}},P=function(e){let{onlyLeafNodeVar:t,filterVar:a,hideEnv:o=!1,hideChatVar:i=!1,passedInAvailableNodes:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{onlyLeafNodeVar:!1,filterVar:()=>!0},{getTreeLeafNodes:r,getBeforeNodesInSameBranchIncludeParent:d}=(0,v.useWorkflow)(),{getNodeAvailableVars:l}=b(),s=(0,v.useIsChatMode)(),u={};return e.forEach(c=>{let p=c.id,g=n||(t?r(p):d(p));c.data.type===w.BlockEnum.Loop&&g.push(c);let{parentNode:f}=A(p,e),h=l({parentNode:f,beforeNodes:g,isChatMode:s,filterVar:a,hideEnv:o,hideChatVar:i});u[p]={node:c,availableVars:h,availableNodes:g}}),u},B=[w.BlockEnum.Start,w.BlockEnum.TriggerSchedule,w.BlockEnum.TriggerWebhook,w.BlockEnum.TriggerPlugin],x=[w.BlockEnum.Tool,w.BlockEnum.DataSource,w.BlockEnum.TriggerPlugin],R=(e,o)=>{let{t:n}=(0,a.useTranslation)(),l=(0,u.useGetLanguage)(),{nodesMap:s}=(0,k.useNodesMetaData)(),{data:c}=(0,g.useAllBuiltInTools)(),{data:v}=(0,g.useAllCustomTools)(),{data:D}=(0,g.useAllWorkflowTools)(),b=(0,m.useStore)(e=>e.dataSourceList),{data:O}=(0,p.useStrategyProviders)(),{data:A}=(0,f.useAllTriggerPlugins)(),R=(0,S.useDatasetsDetailStore)(e=>e.datasetsDetail),M=(0,I.useGetToolIcon)(),L=i.useStore.getState().appDetail?.mode,H=L===h.AppModeEnum.WORKFLOW||L===h.AppModeEnum.ADVANCED_CHAT,V=P(e),{data:W}=(0,d.useModelList)(r.ModelTypeEnum.textEmbedding),{data:U}=(0,d.useModelList)(r.ModelTypeEnum.rerank),$=(0,t.useCallback)(e=>{let t=e;if(e.type===w.BlockEnum.KnowledgeRetrieval){let a=e.dataset_ids.reduce((e,t)=>(R[t]&&e.push(R[t]),e),[]);t={...e,_datasets:a}}else e.type===w.BlockEnum.KnowledgeBase&&(t={...e,_embeddingModelList:W,_rerankModelList:U});return t},[R,W,U]);return(0,t.useMemo)(()=>{let t=[],a=e.filter(e=>e.type===y.CUSTOM_NODE),{validNodes:i}=(0,N.getValidTreeNodes)(a,o);for(let e=0;e<a.length;e++){let o,r=a[e],d=[];r.data.type===w.BlockEnum.Tool&&(o=(0,T.getToolCheckParams)(r.data,c||[],v||[],D||[],l)),r.data.type===w.BlockEnum.DataSource&&(o=(0,_.getDataSourceCheckParams)(r.data,b||[],l)),r.data.type===w.BlockEnum.TriggerPlugin&&(o=(0,C.getTriggerCheckParams)(r.data,A,l));let u=M(r.data);if(r.data.type===w.BlockEnum.Agent){let e=r.data,t=!!O,a=O?.find(t=>t.declaration.identity.name===e.agent_strategy_provider_name),i=a?.declaration.strategies?.find(t=>t.identity.name===e.agent_strategy_name);o={provider:a,strategy:i,language:l,isReadyForCheckValid:t}}else d=(0,E.getNodeUsedVars)(r).filter(e=>e.length>0);if(r.type===y.CUSTOM_NODE){let e,a=$(r.data),l=s?.[r.data.type]?.checkValid,c=x.includes(r.data.type)&&r.data._pluginInstallLocked;if(c?e=n("nodes.common.pluginNotInstalled",{ns:"workflow"}):l&&(e=l(a,n,o).errorMessage),!e){let t=V[r.id].availableVars;for(let a of d)if(!(0,E.isSpecialVar)(a[0])){let o=t.find(e=>e.nodeId===a?.[0]);o&&o.vars.find(e=>e.variable===a?.[1])||(e=n("errorMsg.invalidVariable",{ns:"workflow"}))}}let p=s?.[r.data.type]?.metaData.isStart??!1,g=!H||p,f=!i.find(e=>e.id===r.id);(e||f&&!g)&&t.push({id:r.id,type:r.data.type,title:r.data.title,toolIcon:u,unConnected:f&&!g,errorMessage:e,canNavigate:!c,disableGoTo:c})}}return H&&0===e.filter(e=>B.includes(e.data.type)).length&&t.push({id:"start-node-required",type:w.BlockEnum.Start,title:n("panel.startNode",{ns:"workflow"}),errorMessage:n("common.needStartNode",{ns:"workflow"}),canNavigate:!1}),Object.keys(s).filter(e=>s[e].metaData.isRequired).forEach(e=>{a.find(t=>t.data.type===e)||t.push({id:`${e}-need-added`,type:e,title:n(`blocks.${e}`,{ns:"workflow"}),errorMessage:n("common.needAdd",{ns:"workflow",node:n(`blocks.${e}`,{ns:"workflow"})}),canNavigate:!1})}),t},[e,s,o,c,v,D,l,b,M,O,$,n,V,H])},M=()=>{let{t:e}=(0,a.useTranslation)(),l=(0,u.useGetLanguage)(),{notify:f}=(0,n.useToastContext)(),I=(0,o.useStoreApi)(),{nodesMap:C}=(0,k.useNodesMetaData)(),{data:D}=(0,p.useStrategyProviders)(),O=(0,S.useDatasetsDetailStore)(e=>e.updateDatasetsDetail),P=(0,t.useRef)(0),x=(0,m.useWorkflowStore)(),{getNodesAvailableVarList:R}=(()=>{let{getTreeLeafNodes:e,getBeforeNodesInSameBranchIncludeParent:a}=(0,v.useWorkflow)(),{getNodeAvailableVars:o}=b(),i=(0,v.useIsChatMode)();return{getNodesAvailableVarList:(0,t.useCallback)(function(t){let{onlyLeafNodeVar:n,filterVar:r,hideEnv:d,hideChatVar:l,passedInAvailableNodes:s}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{onlyLeafNodeVar:!1,filterVar:()=>!0},u={};return t.forEach(c=>{let p=c.id,g=s||(n?e(p):a(p));c.data.type===w.BlockEnum.Loop&&g.push(c);let{parentNode:f}=A(p,t),h=o({parentNode:f,beforeNodes:g,isChatMode:i,filterVar:r,hideEnv:d,hideChatVar:l});u[p]={node:c,availableVars:h,availableNodes:g}}),u},[e,a,o,i])}})(),{data:M}=(0,d.useModelList)(r.ModelTypeEnum.textEmbedding),{data:L}=(0,d.useModelList)(r.ModelTypeEnum.rerank),{data:H}=(0,g.useAllBuiltInTools)(),{data:V}=(0,g.useAllCustomTools)(),{data:W}=(0,g.useAllWorkflowTools)(),U=i.useStore.getState().appDetail?.mode,$=U===h.AppModeEnum.WORKFLOW||U===h.AppModeEnum.ADVANCED_CHAT,z=(0,t.useCallback)((e,t)=>{let a=e;if(e.type===w.BlockEnum.KnowledgeRetrieval){let o=e.dataset_ids,i=t.reduce((e,t)=>(e[t.id]=t,e),{}),n=o.reduce((e,t)=>(i[t]&&e.push(i[t]),e),[]);a={...e,_datasets:n}}else e.type===w.BlockEnum.KnowledgeBase&&(a={...e,_embeddingModelList:M,_rerankModelList:L});return a},[M,L]);return{handleCheckBeforePublish:(0,t.useCallback)(async()=>{let{getNodes:t,edges:a}=I.getState(),{dataSourceList:o}=x.getState(),i=t(),n=i.filter(e=>e.type===y.CUSTOM_NODE),{validNodes:r,maxDepth:d}=(0,N.getValidTreeNodes)(n,a);if(d>s.MAX_TREE_DEPTH)return f({type:"error",message:e("common.maxTreeDepth",{ns:"workflow",depth:s.MAX_TREE_DEPTH})}),!1;let u=n.filter(e=>e.data.type===w.BlockEnum.KnowledgeRetrieval).reduce((e,t)=>Array.from(new Set([...e,...t.data.dataset_ids])),[]),p=[];if(u.length>0){P.current=P.current+1;let e=P.current,{data:t}=await (0,c.fetchDatasets)({url:"/datasets",params:{page:1,ids:u}});if(t&&t.length>0){if(e<P.current)return!1;p=t,O(t)}}let g=R(i);for(let t=0;t<n.length;t++){let a,i=n[t],d=[];if(i.data.type===w.BlockEnum.Tool&&(a=(0,T.getToolCheckParams)(i.data,H||[],V||[],W||[],l)),i.data.type===w.BlockEnum.DataSource&&(a=(0,_.getDataSourceCheckParams)(i.data,o||[],l)),i.data.type===w.BlockEnum.Agent){let e=i.data,t=!!D,o=D?.find(t=>t.declaration.identity.name===e.agent_strategy_provider_name),n=o?.declaration.strategies?.find(t=>t.identity.name===e.agent_strategy_name);a={provider:o,strategy:n,language:l,isReadyForCheckValid:t}}else d=(0,E.getNodeUsedVars)(i).filter(e=>e.length>0);let s=z(i.data,p),{errorMessage:u}=C[i.data.type].checkValid(s,e,a);if(u)return f({type:"error",message:`[${i.data.title}] ${u}`}),!1;let c=g[i.id].availableVars;for(let t of d)if(!(0,E.isSpecialVar)(t[0])){let a=c.find(e=>e.nodeId===t?.[0]);if(!a||!a.vars.find(e=>e.variable===t?.[1]))return f({type:"error",message:`[${i.data.title}] ${e("errorMsg.invalidVariable",{ns:"workflow"})}`}),!1}let h=C?.[i.data.type]?.metaData.isStart??!1,y=!$||h;if(!r.find(e=>e.id===i.id)&&!y)return f({type:"error",message:`[${i.data.title}] ${e("common.needConnectTip",{ns:"workflow"})}`}),!1}if($&&0===i.filter(e=>B.includes(e.data.type)).length)return f({type:"error",message:e("common.needStartNode",{ns:"workflow"})}),!1;let h=Object.keys(C).filter(e=>C[e].metaData.isRequired);for(let t=0;t<h.length;t++){let a=h[t];if(!n.find(e=>e.data.type===a))return f({type:"error",message:e("common.needAdd",{ns:"workflow",node:e(`blocks.${a}`,{ns:"workflow"})})}),!1}return!0},[I,f,e,l,C,D,O,z,x,H,V,W,$])}},L=()=>{let{t:e}=(0,a.useTranslation)(),i=R((0,l.default)(),(0,o.useEdges)()),{notify:r}=(0,n.useToastContext)();return{validateBeforeRun:(0,t.useCallback)(()=>!(i.length>0)||(r({type:"error",message:e("panel.checklistTip",{ns:"workflow"})}),!1),[i,r,e]),hasValidationErrors:i.length>0,warningNodes:i}};e.i(491401);var H=e.i(585736);e.s(["useDSL",0,()=>({exportCheck:(0,H.useHooksStore)(e=>e.exportCheck),handleExportDSL:(0,H.useHooksStore)(e=>e.handleExportDSL)})],804612)},604208,e=>{"use strict";e.s(["useNodesSyncDraft",()=>n]);var t=e.i(268255);e.i(491401);var a=e.i(585736);e.i(275225);var o=e.i(705405),i=e.i(720315);let n=()=>{let{getNodesReadOnly:e}=(0,i.useNodesReadOnly)(),n=(0,o.useStore)(e=>e.debouncedSyncWorkflowDraft),r=(0,a.useHooksStore)(e=>e.doSyncWorkflowDraft),d=(0,a.useHooksStore)(e=>e.syncWorkflowDraftWhenPageClose),l=(0,t.useCallback)((t,a,o)=>{e()||(t?r(a,o):n(r))},[n,r,e]);return{doSyncWorkflowDraft:r,handleSyncWorkflowDraft:l,syncWorkflowDraftWhenPageClose:d}}},735738,276145,339512,959095,554499,91025,781988,265522,257988,568603,77352,e=>{"use strict";e.s(["useEdgesInteractions",()=>m],735738);var t=e.i(105845),a=e.i(268255),o=e.i(192447);e.i(905691);var i=e.i(911684),n=e.i(604208),r=e.i(720315),d=e.i(813672);e.i(152567);var l=e.i(408767),s=e.i(563199),u=e.i(124836),c=e.i(65932),p=e.i(763989),g=(e,t,a)=>(o,i)=>({pastStates:a?.pastStates||[],futureStates:a?.futureStates||[],undo:function(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(i().pastStates.length){let r=a?.partialize?.(t())||t(),d=i().pastStates.splice(-n,n),l=d.shift();e(l),o({pastStates:i().pastStates,futureStates:i().futureStates.concat(a?.diff?.(r,l)||r,d.reverse())})}},redo:function(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(i().futureStates.length){let r=a?.partialize?.(t())||t(),d=i().futureStates.splice(-n,n),l=d.shift();e(l),o({pastStates:i().pastStates.concat(a?.diff?.(r,l)||r,d.reverse()),futureStates:i().futureStates})}},clear:()=>o({pastStates:[],futureStates:[]}),isTracking:!0,pause:()=>o({isTracking:!1}),resume:()=>o({isTracking:!0}),setOnSave:e=>o({_onSave:e}),_onSave:a?.onSave,_handleSet:(e,t,n,r)=>{a?.limit&&i().pastStates.length>=a?.limit&&i().pastStates.shift(),i()._onSave?.(e,n),o({pastStates:i().pastStates.concat(r||e),futureStates:[]})}}),f=e.i(639751);let h=(0,a.createContext)({store:null,shortcutsEnabled:!0,setShortcutsEnabled:u.noop}),y=h.Provider;function S(e){let{nodes:t,edges:o,children:i}=e,[n,r]=(0,a.useState)(!0),[d]=(0,a.useState)(()=>(function(e){var t,a;let{nodes:o,edges:i}=e;return(0,f.create)((t=(e,t)=>({workflowHistoryEvent:void 0,workflowHistoryEventMeta:void 0,nodes:o,edges:i,getNodes:()=>t().nodes,setNodes:t=>e({nodes:t}),setEdges:t=>e({edges:t})}),a={equality:(e,t)=>(0,c.default)(e,t)},(e,o,i)=>{i.temporal=(0,p.createStore)(a?.wrapTemporal?.(g(e,o,a))||g(e,o,a));let n=a?.handleSet?.(i.temporal.getState()._handleSet)||i.temporal.getState()._handleSet,r=e=>{if(!i.temporal.getState().isTracking)return;let t=a?.partialize?.(o())||o(),r=a?.diff?.(e,t);null===r||a?.equality?.(e,t)||n(e,void 0,t,r)},d=i.setState;return i.setState=function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];let n=a?.partialize?.(o())||o();d(...t),r(n)},t(function(){for(var t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];let d=a?.partialize?.(o())||o();e(...i),r(d)},o,i)}))})({nodes:t,edges:o}));return(0,s.jsx)(y,{value:{store:d,shortcutsEnabled:n,setShortcutsEnabled:r},children:i})}function I(){let{store:e,shortcutsEnabled:t,setShortcutsEnabled:o}=(0,a.useContext)(h);if(null===e)throw Error("useWorkflowHistoryStoreApi must be used within a WorkflowHistoryProvider");return{store:(0,a.useMemo)(()=>({getState:e.getState,setState:t=>{e.setState({workflowHistoryEvent:t.workflowHistoryEvent,workflowHistoryEventMeta:t.workflowHistoryEventMeta,nodes:t.nodes.map(e=>({...e,data:{...e.data,selected:!1}})),edges:t.edges.map(e=>({...e,selected:!1}))})},subscribe:e.subscribe,temporal:e.temporal}),[e]),shortcutsEnabled:t,setShortcutsEnabled:o}}e.s(["WorkflowHistoryProvider",()=>S,"useWorkflowHistoryStore",()=>I],276145);let k={NodeTitleChange:"NodeTitleChange",NodeDescriptionChange:"NodeDescriptionChange",NodeDragStop:"NodeDragStop",NodeChange:"NodeChange",NodeConnect:"NodeConnect",NodePaste:"NodePaste",NodeDelete:"NodeDelete",EdgeDelete:"EdgeDelete",EdgeDeleteByDeleteBranch:"EdgeDeleteByDeleteBranch",NodeAdd:"NodeAdd",NodeResize:"NodeResize",NoteAdd:"NoteAdd",NoteChange:"NoteChange",NoteDelete:"NoteDelete",LayoutOrganize:"LayoutOrganize"},E=()=>{let e=(0,o.useStoreApi)(),{store:t}=I(),{t:i}=(0,l.useTranslation)(),[n,r]=(0,a.useState)([]),[s,u]=(0,a.useState)([]),c=(0,a.useCallback)(e=>(r(t=>[...t,e]),()=>r(t=>t.filter(t=>t!==e))),[]),p=(0,a.useCallback)(e=>(u(t=>[...t,e]),()=>u(t=>t.filter(t=>t!==e))),[]),g=(0,a.useCallback)(()=>{t.temporal.getState().undo(),n.forEach(e=>e())},[n,t.temporal]),f=(0,a.useCallback)(()=>{t.temporal.getState().redo(),s.forEach(e=>e())},[s,t.temporal]),h=(0,a.useRef)((0,d.debounce)((a,o)=>{t.setState({workflowHistoryEvent:a,workflowHistoryEventMeta:o,nodes:e.getState().getNodes(),edges:e.getState().edges})},500));return{store:t,saveStateToHistory:(0,a.useCallback)((e,t)=>{switch(e){case k.NoteChange:case k.NodeTitleChange:case k.NodeDescriptionChange:case k.NodeDragStop:case k.NodeChange:case k.NodeConnect:case k.NodePaste:case k.NodeDelete:case k.EdgeDelete:case k.EdgeDeleteByDeleteBranch:case k.NodeAdd:case k.NodeResize:case k.NoteAdd:case k.LayoutOrganize:case k.NoteDelete:h.current(e,t)}},[]),getHistoryLabel:(0,a.useCallback)(e=>{switch(e){case k.NodeTitleChange:return i("changeHistory.nodeTitleChange",{ns:"workflow"});case k.NodeDescriptionChange:return i("changeHistory.nodeDescriptionChange",{ns:"workflow"});case k.LayoutOrganize:case k.NodeDragStop:return i("changeHistory.nodeDragStop",{ns:"workflow"});case k.NodeChange:return i("changeHistory.nodeChange",{ns:"workflow"});case k.NodeConnect:return i("changeHistory.nodeConnect",{ns:"workflow"});case k.NodePaste:return i("changeHistory.nodePaste",{ns:"workflow"});case k.NodeDelete:return i("changeHistory.nodeDelete",{ns:"workflow"});case k.NodeAdd:return i("changeHistory.nodeAdd",{ns:"workflow"});case k.EdgeDelete:case k.EdgeDeleteByDeleteBranch:return i("changeHistory.edgeDelete",{ns:"workflow"});case k.NodeResize:return i("changeHistory.nodeResize",{ns:"workflow"});case k.NoteAdd:return i("changeHistory.noteAdd",{ns:"workflow"});case k.NoteChange:return i("changeHistory.noteChange",{ns:"workflow"});case k.NoteDelete:return i("changeHistory.noteDelete",{ns:"workflow"});default:return"Unknown Event"}},[i]),undo:g,redo:f,onUndo:c,onRedo:p}};e.s(["WorkflowHistoryEvent",0,k,"useWorkflowHistory",0,E],339512);let m=()=>{let e=(0,o.useStoreApi)(),{handleSyncWorkflowDraft:d}=(0,n.useNodesSyncDraft)(),{getNodesReadOnly:l}=(0,r.useNodesReadOnly)(),{saveStateToHistory:s}=E(),u=(0,a.useCallback)((a,o)=>{if(l())return;let{edges:i,setEdges:n}=e.getState();n((0,t.produce)(i,e=>{e.find(e=>e.id===o.id).data._hovering=!0}))},[e,l]),c=(0,a.useCallback)((a,o)=>{if(l())return;let{edges:i,setEdges:n}=e.getState();n((0,t.produce)(i,e=>{e.find(e=>e.id===o.id).data._hovering=!1}))},[e,l]),p=(0,a.useCallback)((a,o)=>{if(l())return;let{getNodes:n,setNodes:r,edges:u,setEdges:c}=e.getState(),p=u.filter(e=>e.source===a&&e.sourceHandle===o);if(!p.length)return;let g=n(),f=(0,i.getNodesConnectedSourceOrTargetHandleIdsMap)(p.map(e=>({type:"remove",edge:e})),g);r((0,t.produce)(g,e=>{e.forEach(e=>{f[e.id]&&(e.data={...e.data,...f[e.id]})})})),c((0,t.produce)(u,e=>e.filter(e=>!p.find(t=>t.id===e.id)))),d(),s(k.EdgeDeleteByDeleteBranch)},[l,e,d,s]);return{handleEdgeEnter:u,handleEdgeLeave:c,handleEdgeDeleteByDeleteBranch:p,handleEdgeDelete:(0,a.useCallback)(()=>{if(l())return;let{getNodes:a,setNodes:o,edges:n,setEdges:r}=e.getState(),u=n.findIndex(e=>e.selected);if(u<0)return;let c=n[u],p=a(),g=(0,i.getNodesConnectedSourceOrTargetHandleIdsMap)([{type:"remove",edge:c}],p);o((0,t.produce)(p,e=>{e.forEach(e=>{g[e.id]&&(e.data={...e.data,...g[e.id]})})})),r((0,t.produce)(n,e=>{e.splice(u,1)})),d(),s(k.EdgeDelete)},[l,e,d,s]),handleEdgesChange:(0,a.useCallback)(a=>{if(l())return;let{edges:o,setEdges:i}=e.getState();i((0,t.produce)(o,e=>{a.forEach(t=>{"select"===t.type&&(e.find(e=>e.id===t.id).selected=t.selected)})}))},[e,l])}};e.i(491401);var w=e.i(585736),_=e.i(387852),T=e.i(480600);e.i(275225);var N=e.i(705405),C=e.i(390622);let v=["query","files"],D=()=>{let e=(0,N.useStore)(e=>e.nodesWithInspectVars),a=(0,w.useHooksStore)(e=>e.configsMap),o=a?.flowType===T.FlowType.ragPipeline,{data:i}=(0,_.useConversationVarValues)(a?.flowType,o?"":a?.flowId),{data:n}=(0,_.useSysVarValues)(a?.flowType,o?"":a?.flowId),{varsAppendStartNode:r,systemVars:d}=n?.length===0?{varsAppendStartNode:[],systemVars:[]}:{varsAppendStartNode:n?.filter(e=>{let{name:t}=e;return v.includes(t)})||[],systemVars:n?.filter(e=>{let{name:t}=e;return!v.includes(t)})||[]},l=e&&0!==e.length?(0,t.produce)(e,e=>{e.forEach(e=>{e.nodeType===C.BlockEnum.Start&&(e.vars=[...e.vars,...r])})}):[],s=(0,w.useHooksStore)(e=>e.hasNodeInspectVars),u=(0,w.useHooksStore)(e=>e.hasSetInspectVar),c=(0,w.useHooksStore)(e=>e.fetchInspectVarValue),p=(0,w.useHooksStore)(e=>e.editInspectVarValue),g=(0,w.useHooksStore)(e=>e.renameInspectVarName),f=(0,w.useHooksStore)(e=>e.appendNodeInspectVars),h=(0,w.useHooksStore)(e=>e.deleteInspectVar),y=(0,w.useHooksStore)(e=>e.deleteNodeInspectorVars),S=(0,w.useHooksStore)(e=>e.deleteAllInspectorVars),I=(0,w.useHooksStore)(e=>e.isInspectVarEdited),k=(0,w.useHooksStore)(e=>e.resetToLastRunVar),E=(0,w.useHooksStore)(e=>e.invalidateSysVarValues);return{conversationVars:i||[],systemVars:d||[],nodesWithInspectVars:l,hasNodeInspectVars:s,hasSetInspectVar:u,fetchInspectVarValue:c,editInspectVarValue:p,renameInspectVarName:g,appendNodeInspectVars:f,deleteInspectVar:h,deleteNodeInspectorVars:y,deleteAllInspectorVars:S,isInspectVarEdited:I,resetToLastRunVar:k,invalidateSysVarValues:E,resetConversationVar:(0,w.useHooksStore)(e=>e.resetConversationVar),invalidateConversationVarValues:(0,w.useHooksStore)(e=>e.invalidateConversationVarValues)}};e.s(["default",0,D],959095),e.s(["useNodeDataUpdate",()=>b],554499);let b=()=>{let e=(0,o.useStoreApi)(),{handleSyncWorkflowDraft:i}=(0,n.useNodesSyncDraft)(),{getNodesReadOnly:d}=(0,r.useNodesReadOnly)(),l=(0,a.useCallback)(a=>{let{id:o,data:i}=a,{getNodes:n,setNodes:r}=e.getState();r((0,t.produce)(n(),e=>{let t=e.find(e=>e.id===o);t&&(t.data={...t.data,...i})}))},[e]),s=(0,a.useCallback)((e,t)=>{d()||(l(e),i(t?.sync,t?.notRefreshWhenSyncError,t?.callback))},[i,l,d]);return{handleNodeDataUpdate:l,handleNodeDataUpdateWithSyncDraft:s}};e.s(["useNodesInteractions",()=>W],265522);var O=e.i(959752),A=e.i(963855),P=e.i(786191);e.s(["useNodeIterationInteractions",()=>R],91025),e.i(845780);var B=e.i(148280),x=e.i(52592);let R=()=>{let{t:e}=(0,l.useTranslation)(),i=(0,o.useStoreApi)(),{nodesMap:n}=(0,B.useNodesMetaData)(),r=(0,a.useCallback)(e=>{let a,o,{getNodes:n,setNodes:r}=i.getState(),d=n(),l=d.find(t=>t.id===e);d.filter(t=>t.parentId===e).forEach(e=>{a?e.position.x+e.width>a.position.x+a.width&&(a=e):a=e,o?e.position.y+e.height>o.position.y+o.height&&(o=e):o=e});let s=a&&l.width<a.position.x+a.width,u=o&&l.height<o.position.y+o.height;(s||u)&&r((0,t.produce)(d,t=>{t.forEach(t=>{t.id===e&&(s&&(t.data.width=a.position.x+a.width+O.ITERATION_PADDING.right,t.width=a.position.x+a.width+O.ITERATION_PADDING.right),u&&(t.data.height=o.position.y+o.height+O.ITERATION_PADDING.bottom,t.height=o.position.y+o.height+O.ITERATION_PADDING.bottom))})}))},[i]),d=(0,a.useCallback)(e=>{let{getNodes:t}=i.getState(),a=t(),o={x:void 0,y:void 0};if(e.data.isInIteration){let t=a.find(t=>t.id===e.parentId);t&&(e.position.y<O.ITERATION_PADDING.top&&(o.y=O.ITERATION_PADDING.top),e.position.x<O.ITERATION_PADDING.left&&(o.x=O.ITERATION_PADDING.left),e.position.x+e.width>t.width-O.ITERATION_PADDING.right&&(o.x=t.width-O.ITERATION_PADDING.right-e.width),e.position.y+e.height>t.height-O.ITERATION_PADDING.bottom&&(o.y=t.height-O.ITERATION_PADDING.bottom-e.height))}return{restrictPosition:o}},[i]),s=(0,a.useCallback)(e=>{let{getNodes:t}=i.getState(),a=t().find(t=>t.id===e).parentId;a&&r(a)},[i,r]);return{handleNodeIterationRerender:r,handleNodeIterationChildDrag:d,handleNodeIterationChildSizeChange:s,handleNodeIterationChildrenCopy:(0,a.useCallback)((t,a,o)=>{let{getNodes:r}=i.getState(),d=r(),l=d.filter(e=>e.parentId===t&&e.type!==P.CUSTOM_ITERATION_START_NODE),s={...o},u={};return{copyChildren:l.map((t,o)=>{let i=t.data.type,r=d.filter(e=>e.data.type===i);u[i]?u[i]=u[i]+1:u[i]=r.length+1;let{newNode:l}=(0,x.generateNewNode)({type:(0,x.getNodeCustomTypeByNodeDataType)(i),data:{...n[i].defaultValue,...t.data,selected:!1,_isBundled:!1,_connectedSourceHandleIds:[],_connectedTargetHandleIds:[],title:r.length>0?`${e(`blocks.${i}`,{ns:"workflow"})} ${u[i]}`:e(`blocks.${i}`,{ns:"workflow"}),iteration_id:a,type:i},position:t.position,positionAbsolute:t.positionAbsolute,parentId:a,extent:t.extent,zIndex:t.zIndex});return l.id=`${a}${l.id+o}`,s[t.id]=l.id,l}),newIdMapping:s}},[i,e])}};var M=e.i(4520);e.s(["useNodeLoopInteractions",()=>L],781988);let L=()=>{let e=(0,o.useStoreApi)(),{nodesMap:i}=(0,B.useNodesMetaData)(),n=(0,a.useCallback)(a=>{let o,i,{getNodes:n,setNodes:r}=e.getState(),d=n(),l=d.find(e=>e.id===a);d.filter(e=>e.parentId===a).forEach(e=>{o?e.position.x+e.width>o.position.x+o.width&&(o=e):o=e,i?e.position.y+e.height>i.position.y+i.height&&(i=e):i=e});let s=o&&l.width<o.position.x+o.width,u=i&&l.height<i.position.y+i.height;(s||u)&&r((0,t.produce)(d,e=>{e.forEach(e=>{e.id===a&&(s&&(e.data.width=o.position.x+o.width+O.LOOP_PADDING.right,e.width=o.position.x+o.width+O.LOOP_PADDING.right),u&&(e.data.height=i.position.y+i.height+O.LOOP_PADDING.bottom,e.height=i.position.y+i.height+O.LOOP_PADDING.bottom))})}))},[e]),r=(0,a.useCallback)(t=>{let{getNodes:a}=e.getState(),o=a(),i={x:void 0,y:void 0};if(t.data.isInLoop){let e=o.find(e=>e.id===t.parentId);e&&(t.position.y<O.LOOP_PADDING.top&&(i.y=O.LOOP_PADDING.top),t.position.x<O.LOOP_PADDING.left&&(i.x=O.LOOP_PADDING.left),t.position.x+t.width>e.width-O.LOOP_PADDING.right&&(i.x=e.width-O.LOOP_PADDING.right-t.width),t.position.y+t.height>e.height-O.LOOP_PADDING.bottom&&(i.y=e.height-O.LOOP_PADDING.bottom-t.height))}return{restrictPosition:i}},[e]),d=(0,a.useCallback)(t=>{let{getNodes:a}=e.getState(),o=a().find(e=>e.id===t).parentId;o&&n(o)},[e,n]);return{handleNodeLoopRerender:n,handleNodeLoopChildDrag:r,handleNodeLoopChildSizeChange:d,handleNodeLoopChildrenCopy:(0,a.useCallback)((t,a)=>{let{getNodes:o}=e.getState(),n=o();return n.filter(e=>e.parentId===t&&e.type!==M.CUSTOM_LOOP_START_NODE).map((e,t)=>{let o=e.data.type,{defaultValue:r}=i[o],d=n.filter(e=>e.data.type===o),{newNode:l}=(0,x.generateNewNode)({type:(0,x.getNodeCustomTypeByNodeDataType)(o),data:{...r,...e.data,selected:!1,_isBundled:!1,_connectedSourceHandleIds:[],_connectedTargetHandleIds:[],_dimmed:!1,title:d.length>0?`${r.title} ${d.length+1}`:r.title,isInLoop:!0,loop_id:a,type:o},position:e.position,positionAbsolute:e.positionAbsolute,parentId:a,extent:e.extent,zIndex:O.LOOP_CHILDREN_Z_INDEX});return l.id=`${a}${l.id+t}`,l})},[e,i])}};var H=e.i(534042),V=e.i(368148);let W=()=>{let e,d,s,u,{t:c}=(0,l.useTranslation)(),p=(0,o.useStoreApi)(),g=(0,N.useWorkflowStore)(),f=(0,o.useReactFlow)(),{store:h}=I(),{handleSyncWorkflowDraft:y}=(0,n.useNodesSyncDraft)(),{getAfterNodesInSameBranch:S}=(0,r.useWorkflow)(),{getNodesReadOnly:m}=(0,r.useNodesReadOnly)(),{getWorkflowReadOnly:w}=(0,r.useWorkflowReadOnly)(),{handleSetHelpline:_}=(e=(0,o.useStoreApi)(),d=(0,N.useWorkflowStore)(),s=(0,a.useCallback)(e=>(0,C.isTriggerNode)(e.data.type)||e.data.type===C.BlockEnum.Start,[]),u=(0,a.useCallback)(e=>s(e)?{x:e.position.x+0,y:e.position.y+21}:{x:e.position.x,y:e.position.y},[s]),{handleSetHelpline:(0,a.useCallback)(t=>{let{getNodes:a}=e.getState(),o=a(),{setHelpLineHorizontal:i,setHelpLineVertical:n}=d.getState();if(t.data.isInIteration||t.data.isInLoop)return{showHorizontalHelpLineNodes:[],showVerticalHelpLineNodes:[]};let r=u(t),l=o.filter(e=>{if(e.id===t.id||e.data.isInIteration||e.data.isInLoop)return!1;let a=Math.ceil(u(e).y),o=Math.ceil(r.y);return!!(a-o<5)&&!!(a-o>-5)}).sort((e,t)=>{let a=u(e),o=u(t);return a.x-o.x}),c=l.length;if(c>0){let e=l[0],a=l[c-1],o=u(e),n=u(a),d=s(a)?a.width-0:a.width,p={top:o.y,left:o.x,width:n.x+d-o.x};if(r.x<o.x){let t=s(e)?e.width-0:e.width;p.left=r.x,p.width=o.x+t-r.x}if(r.x>n.x){let e=s(t)?t.width-0:t.width;p.width=r.x+e-o.x}i(p)}else i();let p=o.filter(e=>{if(e.id===t.id||e.data.isInIteration||e.data.isInLoop)return!1;let a=Math.ceil(u(e).x),o=Math.ceil(r.x);return!!(a-o<5)&&!!(a-o>-5)}).sort((e,t)=>{let a=u(e),o=u(t);return a.x-o.x}),g=p.length;if(g>0){let e=p[0],a=p[g-1],o=u(e),i=u(a),d=s(a)?a.height-21:a.height,l={top:o.y,left:o.x,height:i.y+d-o.y};if(r.y<o.y){let t=s(e)?e.height-21:e.height;l.top=r.y,l.height=o.y+t-r.y}if(r.y>i.y){let e=s(t)?t.height-21:t.height;l.height=r.y+e-o.y}n(l)}else n();return{showHorizontalHelpLineNodes:l,showVerticalHelpLineNodes:p}},[e,d,u])}),{handleNodeIterationChildDrag:T,handleNodeIterationChildrenCopy:v}=R(),{handleNodeLoopChildDrag:b,handleNodeLoopChildrenCopy:W}=L(),U=(0,a.useRef)({x:0,y:0}),{nodesMap:$}=(0,B.useNodesMetaData)(),{saveStateToHistory:z,undo:G,redo:K}=E(),F=(0,V.useAutoGenerateWebhookUrl)(),X=(0,a.useCallback)((e,t)=>{g.setState({nodeAnimation:!1}),m()||t.type===P.CUSTOM_ITERATION_START_NODE||t.type===H.CUSTOM_NOTE_NODE||t.type!==M.CUSTOM_LOOP_START_NODE&&t.type!==H.CUSTOM_NOTE_NODE&&(U.current={x:t.position.x,y:t.position.y})},[g,m]),Z=(0,a.useCallback)((e,a)=>{if(m()||a.type===P.CUSTOM_ITERATION_START_NODE||a.type===M.CUSTOM_LOOP_START_NODE)return;let{getNodes:o,setNodes:i}=p.getState();e.stopPropagation();let n=o(),{restrictPosition:r}=T(a),{restrictPosition:d}=b(a),{showHorizontalHelpLineNodes:l,showVerticalHelpLineNodes:s}=_(a),u=l.length,c=s.length;i((0,t.produce)(n,e=>{let t=e.find(e=>e.id===a.id),o=(0,C.isTriggerNode)(a.data.type)||a.data.type===C.BlockEnum.Start;if(c>0){let e=s[0],a=(0,C.isTriggerNode)(e.data.type)||e.data.type===C.BlockEnum.Start;t.position.x=e.position.x+0-0}else void 0!==r.x?t.position.x=r.x:void 0!==d.x?t.position.x=d.x:t.position.x=a.position.x;if(u>0){let e=l[0],a=(0,C.isTriggerNode)(e.data.type)||e.data.type===C.BlockEnum.Start;t.position.y=e.position.y+21*!!a-21*!!o}else void 0!==r.y?t.position.y=r.y:void 0!==d.y?t.position.y=d.y:t.position.y=a.position.y}))},[m,p,T,b,_]),Y=(0,a.useCallback)((e,t)=>{let{setHelpLineHorizontal:a,setHelpLineVertical:o}=g.getState();if(m())return;let{x:i,y:n}=U.current;(i!==t.position.x||n!==t.position.y)&&(a(),o(),y(),0!==i&&0!==n&&z(k.NodeDragStop,{nodeId:t.id}))},[g,m,z,y]),q=(0,a.useCallback)((e,a)=>{if(m()||a.type===H.CUSTOM_NOTE_NODE||a.type===P.CUSTOM_ITERATION_START_NODE||a.type===M.CUSTOM_LOOP_START_NODE||a.type===H.CUSTOM_NOTE_NODE)return;let{getNodes:i,setNodes:n,edges:r,setEdges:d}=p.getState(),l=i(),{connectingNodePayload:s,setEnteringNodePayload:u}=g.getState();if(s){if(s.nodeId===a.id)return;let e=l.find(e=>e.id===s.nodeId);if(e.parentId===a.parentId){u({nodeId:a.id,nodeData:a.data});let o=s.handleType;n((0,t.produce)(l,t=>{t.forEach(t=>{t.id!==a.id||"source"!==o||a.data.type!==C.BlockEnum.VariableAssigner&&a.data.type!==C.BlockEnum.VariableAggregator||a.data.advanced_settings?.group_enabled||(t.data._isEntering=!0),t.id===a.id&&"target"===o&&(e.data.type===C.BlockEnum.VariableAssigner||e.data.type===C.BlockEnum.VariableAggregator)&&a.data.type!==C.BlockEnum.IfElse&&a.data.type!==C.BlockEnum.QuestionClassifier&&(t.data._isEntering=!0)})}))}}d((0,t.produce)(r,e=>{(0,o.getConnectedEdges)([a],r).forEach(t=>{let a=e.find(e=>e.id===t.id);a&&(a.data._connectedNodeIsHovering=!0)})}))},[p,g,m]),j=(0,a.useCallback)((e,a)=>{if(m()||a.type===H.CUSTOM_NOTE_NODE||a.type===P.CUSTOM_ITERATION_START_NODE||a.type===H.CUSTOM_NOTE_NODE||a.type===M.CUSTOM_LOOP_START_NODE)return;let{setEnteringNodePayload:o}=g.getState();o(void 0);let{getNodes:i,setNodes:n,edges:r,setEdges:d}=p.getState();n((0,t.produce)(i(),e=>{e.forEach(e=>{e.data._isEntering=!1})})),d((0,t.produce)(r,e=>{e.forEach(e=>{e.data._connectedNodeIsHovering=!1})}))},[p,g,m]),Q=(0,a.useCallback)((e,a,i)=>{i&&g.setState({initShowLastRunTab:!0});let{getNodes:n,setNodes:r,edges:d,setEdges:l}=p.getState(),s=n(),u=s.find(e=>e.data.selected);if(!a&&u?.id===e)return;r((0,t.produce)(s,t=>{t.forEach(t=>{t.id===e?t.data.selected=!a:t.data.selected=!1})}));let c=(0,o.getConnectedEdges)([{id:e}],d).map(e=>e.id);l((0,t.produce)(d,e=>{e.forEach(e=>{c.includes(e.id)?e.data={...e.data,_connectedNodeIsSelected:!a}:e.data={...e.data,_connectedNodeIsSelected:!1}})})),y()},[p,y]),J=(0,a.useCallback)((e,t)=>{t.type===P.CUSTOM_ITERATION_START_NODE||t.type===M.CUSTOM_LOOP_START_NODE||t.data.type===C.BlockEnum.DataSourceEmpty||t.data._pluginInstallLocked||Q(t.id)},[Q]),ee=(0,a.useCallback)(e=>{let{source:a,sourceHandle:o,target:n,targetHandle:r}=e;if(a===n||m())return;let{getNodes:d,setNodes:l,edges:s,setEdges:u}=p.getState(),c=d(),g=c.find(e=>e.id===n),f=c.find(e=>e.id===a);if(g?.parentId!==f?.parentId||f?.type===H.CUSTOM_NOTE_NODE||g?.type===H.CUSTOM_NOTE_NODE||s.find(e=>e.source===a&&e.sourceHandle===o&&e.target===n&&e.targetHandle===r))return;let h=c.find(e=>e.id===g?.parentId),S=h&&h.data.type===C.BlockEnum.Iteration,I=!!h&&h.data.type===C.BlockEnum.Loop,E={id:`${a}-${o}-${n}-${r}`,type:O.CUSTOM_EDGE,source:a,target:n,sourceHandle:o,targetHandle:r,data:{sourceType:c.find(e=>e.id===a).data.type,targetType:c.find(e=>e.id===n).data.type,isInIteration:S,iteration_id:S?g?.parentId:void 0,isInLoop:I,loop_id:I?g?.parentId:void 0},zIndex:g?.parentId?S?O.ITERATION_CHILDREN_Z_INDEX:O.LOOP_CHILDREN_Z_INDEX:0},w=(0,i.getNodesConnectedSourceOrTargetHandleIdsMap)([{type:"add",edge:E}],c),_=(0,t.produce)(c,e=>{e.forEach(e=>{w[e.id]&&(e.data={...e.data,...w[e.id]})})}),T=(0,t.produce)(s,e=>{e.push(E)});l(_),u(T),y(),z(k.NodeConnect,{nodeId:g?.id})},[m,p,g,y,z]),et=(0,a.useCallback)((e,t)=>{let{nodeId:a,handleType:o,handleId:i}=t;if(!m()&&a&&o){let{setConnectingNodePayload:e}=g.getState(),{getNodes:t}=p.getState(),n=t().find(e=>e.id===a);if(n.type===H.CUSTOM_NOTE_NODE||(n.data.type===C.BlockEnum.VariableAggregator||n.data.type===C.BlockEnum.VariableAssigner)&&"target"===o)return;e({nodeId:a,nodeType:n.data.type,handleType:o,handleId:i})}},[p,g,m]),ea=(0,a.useCallback)(e=>{if(m())return;let{connectingNodePayload:a,setConnectingNodePayload:o,enteringNodePayload:i,setEnteringNodePayload:n}=g.getState();if(a&&i){let{setShowAssignVariablePopup:o,hoveringAssignVariableGroupId:n}=g.getState(),{screenToFlowPosition:r}=f,{getNodes:d,setNodes:l}=p.getState(),s=d(),u=a.handleType,c=a.handleId,h=s.find(e=>e.id===a.nodeId),y=s.find(e=>e.id===i.nodeId),S=s.find(e=>e.id===y.parentId);if(h.parentId!==y.parentId)return;let{x:I,y:k}=r({x:e.x,y:e.y});if("source"===u&&(y.data.type===C.BlockEnum.VariableAssigner||y.data.type===C.BlockEnum.VariableAggregator)){let e=y.data.advanced_settings?.group_enabled,a=y.data.advanced_settings?.groups[0].groupId,i="target";e&&(i=n||a),l((0,t.produce)(s,e=>{e.forEach(e=>{e.id===y.id&&(e.data._showAddVariablePopup=!0,e.data._holdAddVariablePopup=!0)})})),o({nodeId:h.id,nodeData:h.data,variableAssignerNodeId:y.id,variableAssignerNodeData:y.data,variableAssignerNodeHandleId:i,parentNode:S,x:I-y.positionAbsolute.x,y:k-y.positionAbsolute.y}),ee({source:h.id,sourceHandle:c,target:y.id,targetHandle:"target"})}}o(void 0),n(void 0)},[p,ee,m,g,f]),{deleteNodeInspectorVars:eo}=D(),ei=(0,a.useCallback)(e=>{if(m())return;let{getNodes:a,setNodes:n,edges:r,setEdges:d}=p.getState(),l=a(),s=l.findIndex(t=>t.id===e),u=l[s];if(!u||$?.[u.data.type]?.metaData.isUndeletable)return;if(eo(e),u.data.type===C.BlockEnum.Iteration){let t=l.filter(e=>e.parentId===u.id);if(t.length)if(u.data._isBundled)return t.forEach(e=>{ei(e.id)}),ei(e);else{if(1===t.length){ei(t[0].id),ei(e);return}let{setShowConfirm:a,showConfirm:o}=g.getState();if(!o)return void a({title:c("nodes.iteration.deleteTitle",{ns:"workflow"}),desc:c("nodes.iteration.deleteDesc",{ns:"workflow"})||"",onConfirm:()=>{t.forEach(e=>{ei(e.id)}),ei(e),y(),a(void 0)}})}}if(u.data.type===C.BlockEnum.Loop){let t=l.filter(e=>e.parentId===u.id);if(t.length)if(u.data._isBundled)return t.forEach(e=>{ei(e.id)}),ei(e);else{if(1===t.length){ei(t[0].id),ei(e);return}let{setShowConfirm:a,showConfirm:o}=g.getState();if(!o)return void a({title:c("nodes.loop.deleteTitle",{ns:"workflow"}),desc:c("nodes.loop.deleteDesc",{ns:"workflow"})||"",onConfirm:()=>{t.forEach(e=>{ei(e.id)}),ei(e),y(),a(void 0)}})}}if(u.data.type===C.BlockEnum.DataSource){let{id:e}=u,{ragPipelineVariables:t,setRagPipelineVariables:a}=g.getState();if(t&&a){let o=[];t.forEach(t=>{t.belong_to_node_id!==e&&o.push(t)}),a(o)}}let f=(0,o.getConnectedEdges)([{id:e}],r),h=(0,i.getNodesConnectedSourceOrTargetHandleIdsMap)(f.map(e=>({type:"remove",edge:e})),l);n((0,t.produce)(l,t=>{t.forEach(t=>{h[t.id]&&(t.data={...t.data,...h[t.id]}),t.id===u.parentId&&(t.data._children=t.data._children?.filter(t=>t.nodeId!==e))}),t.splice(s,1)})),d((0,t.produce)(r,e=>e.filter(e=>!f.find(t=>t.id===e.id)))),y(),u.type===H.CUSTOM_NOTE_NODE?z(k.NoteDelete,{nodeId:u.id}):z(k.NodeDelete,{nodeId:u.id})},[m,p,y,z,g,c,$,eo]),en=(0,a.useCallback)((e,a)=>{let{nodeType:n,sourceHandle:r="source",targetHandle:d="target",pluginDefaultValue:l}=e,{prevNodeId:s,prevNodeSourceHandle:u,nextNodeId:c,nextNodeTargetHandle:f}=a;if(m())return;let{getNodes:h,setNodes:I,edges:E,setEdges:w}=p.getState(),_=h(),T=_.filter(e=>e.data.type===n),{defaultValue:N}=$[n],{newNode:v,newIterationStartNode:D,newLoopStartNode:b}=(0,x.generateNewNode)({type:(0,x.getNodeCustomTypeByNodeDataType)(n),data:{...N,title:T.length>0?`${N.title} ${T.length+1}`:N.title,...l,selected:!0,_showAddVariablePopup:(n===C.BlockEnum.VariableAssigner||n===C.BlockEnum.VariableAggregator)&&!!s,_holdAddVariablePopup:!1},position:{x:0,y:0}});if(s&&!c){let e=_.findIndex(e=>e.id===s),a=_[e],r=(0,o.getOutgoers)(a,_,E).sort((e,t)=>e.position.y-t.position.y),l=r[r.length-1];v.data._connectedTargetHandleIds=n===C.BlockEnum.DataSource?[]:[d],v.data._connectedSourceHandleIds=[],v.position={x:l?l.position.x:a.position.x+a.width+O.X_OFFSET,y:l?l.position.y+l.height+O.Y_OFFSET:a.position.y},v.parentId=a.parentId,v.extent=a.extent;let c=_.find(e=>e.id===a.parentId)||null,p=!!c&&c.data.type===C.BlockEnum.Iteration,f=!!c&&c.data.type===C.BlockEnum.Loop;a.parentId&&(v.data.isInIteration=p,v.data.isInLoop=f,p&&(v.data.iteration_id=c.id,v.zIndex=O.ITERATION_CHILDREN_Z_INDEX),f&&(v.data.loop_id=c.id,v.zIndex=O.LOOP_CHILDREN_Z_INDEX),p&&(v.data.type===C.BlockEnum.Answer||v.data.type===C.BlockEnum.Tool||v.data.type===C.BlockEnum.Assigner)&&(c.data._isShowTips=!0),f&&(v.data.type===C.BlockEnum.Answer||v.data.type===C.BlockEnum.Tool||v.data.type===C.BlockEnum.Assigner)&&(c.data._isShowTips=!0));let h=null;n!==C.BlockEnum.DataSource&&(h={id:`${s}-${u}-${v.id}-${d}`,type:O.CUSTOM_EDGE,source:s,sourceHandle:u,target:v.id,targetHandle:d,data:{sourceType:a.data.type,targetType:v.data.type,isInIteration:p,isInLoop:f,iteration_id:p?a.parentId:void 0,loop_id:f?a.parentId:void 0,_connectedNodeIsSelected:!0},zIndex:a.parentId?p?O.ITERATION_CHILDREN_Z_INDEX:O.LOOP_CHILDREN_Z_INDEX:0});let y=(0,i.getNodesConnectedSourceOrTargetHandleIdsMap)(h?[{type:"add",edge:h}]:[],_),S=(0,t.produce)(_,e=>{e.forEach(e=>{e.data.selected=!1,y[e.id]&&(e.data={...e.data,...y[e.id]}),e.data.type===C.BlockEnum.Iteration&&a.parentId===e.id&&e.data._children?.push({nodeId:v.id,nodeType:v.data.type}),e.data.type===C.BlockEnum.Loop&&a.parentId===e.id&&e.data._children?.push({nodeId:v.id,nodeType:v.data.type})}),e.push(v),D&&e.push(D),b&&e.push(b)});if(v.data.type===C.BlockEnum.VariableAssigner||v.data.type===C.BlockEnum.VariableAggregator){let{setShowAssignVariablePopup:e}=g.getState();e({nodeId:a.id,nodeData:a.data,variableAssignerNodeId:v.id,variableAssignerNodeData:v.data,variableAssignerNodeHandleId:d,parentNode:_.find(e=>e.id===v.parentId),x:-25,y:44})}let k=(0,t.produce)(E,e=>{e.forEach(e=>{e.data={...e.data,_connectedNodeIsSelected:!1}}),h&&e.push(h)});I(S),w(k)}if(!s&&c){let e,a,o=_.findIndex(e=>e.id===c),d=_[o];n!==C.BlockEnum.IfElse&&n!==C.BlockEnum.QuestionClassifier&&(v.data._connectedSourceHandleIds=[r]),v.data._connectedTargetHandleIds=[],v.position={x:d.position.x,y:d.position.y},v.parentId=d.parentId,v.extent=d.extent;let l=_.find(e=>e.id===d.parentId)||null,s=!!l&&l.data.type===C.BlockEnum.Iteration,u=!!l&&l.data.type===C.BlockEnum.Loop;l&&d.parentId&&(v.data.isInIteration=s,v.data.isInLoop=u,s&&(v.data.iteration_id=l.id,v.zIndex=O.ITERATION_CHILDREN_Z_INDEX),u&&(v.data.loop_id=l.id,v.zIndex=O.LOOP_CHILDREN_Z_INDEX)),n!==C.BlockEnum.IfElse&&n!==C.BlockEnum.QuestionClassifier&&n!==C.BlockEnum.LoopEnd&&(e={id:`${v.id}-${r}-${c}-${f}`,type:O.CUSTOM_EDGE,source:v.id,sourceHandle:r,target:c,targetHandle:f,data:{sourceType:v.data.type,targetType:d.data.type,isInIteration:s,isInLoop:u,iteration_id:s?d.parentId:void 0,loop_id:u?d.parentId:void 0,_connectedNodeIsSelected:!0},zIndex:d.parentId?s?O.ITERATION_CHILDREN_Z_INDEX:O.LOOP_CHILDREN_Z_INDEX:0}),e&&(a=(0,i.getNodesConnectedSourceOrTargetHandleIdsMap)([{type:"add",edge:e}],_));let p=S(c).map(e=>e.id),g=(0,t.produce)(_,e=>{e.forEach(e=>{e.data.selected=!1,p.includes(e.id)&&(e.position.x+=O.NODE_WIDTH_X_OFFSET),a?.[e.id]&&(e.data={...e.data,...a[e.id]}),e.data.type===C.BlockEnum.Iteration&&d.parentId===e.id&&e.data._children?.push({nodeId:v.id,nodeType:v.data.type}),e.data.type===C.BlockEnum.Iteration&&e.data.start_node_id===c&&(e.data.start_node_id=v.id,e.data.startNodeType=v.data.type),e.data.type===C.BlockEnum.Loop&&d.parentId===e.id&&e.data._children?.push({nodeId:v.id,nodeType:v.data.type}),e.data.type===C.BlockEnum.Loop&&e.data.start_node_id===c&&(e.data.start_node_id=v.id,e.data.startNodeType=v.data.type)}),e.push(v),D&&e.push(D),b&&e.push(b)});if(e){let a=(0,t.produce)(E,t=>{t.forEach(e=>{e.data={...e.data,_connectedNodeIsSelected:!1}}),t.push(e)});I(g),w(a)}else I(g)}if(s&&c){let e=_.find(e=>e.id===s),a=_.find(e=>e.id===c);v.data._connectedTargetHandleIds=n===C.BlockEnum.DataSource?[]:[d],v.data._connectedSourceHandleIds=[r],v.position={x:a.position.x,y:a.position.y},v.parentId=e.parentId,v.extent=e.extent;let o=_.find(t=>t.id===e.parentId)||null,l=!!o&&o.data.type===C.BlockEnum.Iteration,p=!!o&&o.data.type===C.BlockEnum.Loop;o&&e.parentId&&(v.data.isInIteration=l,v.data.isInLoop=p,l&&(v.data.iteration_id=o.id,v.zIndex=O.ITERATION_CHILDREN_Z_INDEX),p&&(v.data.loop_id=o.id,v.zIndex=O.LOOP_CHILDREN_Z_INDEX));let h=E.findIndex(e=>e.source===s&&e.target===c),y=null;n!==C.BlockEnum.DataSource&&(y={id:`${s}-${u}-${v.id}-${d}`,type:O.CUSTOM_EDGE,source:s,sourceHandle:u,target:v.id,targetHandle:d,data:{sourceType:e.data.type,targetType:v.data.type,isInIteration:l,isInLoop:p,iteration_id:l?e.parentId:void 0,loop_id:p?e.parentId:void 0,_connectedNodeIsSelected:!0},zIndex:e.parentId?l?O.ITERATION_CHILDREN_Z_INDEX:O.LOOP_CHILDREN_Z_INDEX:0});let k=null,m=_.find(e=>e.id===a.parentId)||null,T=!!m&&m.data.type===C.BlockEnum.Iteration,N=!!m&&m.data.type===C.BlockEnum.Loop;n!==C.BlockEnum.IfElse&&n!==C.BlockEnum.QuestionClassifier&&n!==C.BlockEnum.LoopEnd&&(k={id:`${v.id}-${r}-${c}-${f}`,type:O.CUSTOM_EDGE,source:v.id,sourceHandle:r,target:c,targetHandle:f,data:{sourceType:v.data.type,targetType:a.data.type,isInIteration:T,isInLoop:N,iteration_id:T?a.parentId:void 0,loop_id:N?a.parentId:void 0,_connectedNodeIsSelected:!0},zIndex:a.parentId?T?O.ITERATION_CHILDREN_Z_INDEX:O.LOOP_CHILDREN_Z_INDEX:0});let A=(0,i.getNodesConnectedSourceOrTargetHandleIdsMap)([{type:"remove",edge:E[h]},...y?[{type:"add",edge:y}]:[],...k?[{type:"add",edge:k}]:[]],[..._,v]),P=S(c).map(e=>e.id);if(I((0,t.produce)(_,t=>{t.forEach(t=>{t.data.selected=!1,A[t.id]&&(t.data={...t.data,...A[t.id]}),P.includes(t.id)&&(t.position.x+=O.NODE_WIDTH_X_OFFSET),t.data.type===C.BlockEnum.Iteration&&e.parentId===t.id&&t.data._children?.push({nodeId:v.id,nodeType:v.data.type}),t.data.type===C.BlockEnum.Loop&&e.parentId===t.id&&t.data._children?.push({nodeId:v.id,nodeType:v.data.type})}),t.push(v),D&&t.push(D),b&&t.push(b)})),v.data.type===C.BlockEnum.VariableAssigner||v.data.type===C.BlockEnum.VariableAggregator){let{setShowAssignVariablePopup:t}=g.getState();t({nodeId:e.id,nodeData:e.data,variableAssignerNodeId:v.id,variableAssignerNodeData:v.data,variableAssignerNodeHandleId:d,parentNode:_.find(e=>e.id===v.parentId),x:-25,y:44})}w((0,t.produce)(E,e=>{e.splice(h,1),e.forEach(e=>{e.data={...e.data,_connectedNodeIsSelected:!1}}),y&&e.push(y),k&&e.push(k)}))}y(),z(k.NodeAdd,{nodeId:v.id})},[m,p,y,z,g,S,$]),er=(0,a.useCallback)((e,a,n,r)=>{if(m())return;let{getNodes:d,setNodes:l,edges:s,setEdges:u}=p.getState(),c=d(),g=c.find(t=>t.id===e),f=(0,o.getConnectedEdges)([g],s),h=c.filter(e=>e.data.type===a),{defaultValue:S}=$[a],{newNode:I,newIterationStartNode:E,newLoopStartNode:w}=(0,x.generateNewNode)({type:(0,x.getNodeCustomTypeByNodeDataType)(a),data:{...S,title:h.length>0?`${S.title} ${h.length+1}`:S.title,...r,_connectedSourceHandleIds:[],_connectedTargetHandleIds:[],selected:g.data.selected,isInIteration:g.data.isInIteration,isInLoop:g.data.isInLoop,iteration_id:g.data.iteration_id,loop_id:g.data.loop_id},position:{x:g.position.x,y:g.position.y},parentId:g.parentId,extent:g.extent,zIndex:g.zIndex}),_=(0,i.getNodesConnectedSourceOrTargetHandleIdsMap)(f.map(e=>({type:"remove",edge:e})),c);l((0,t.produce)(c,t=>{t.forEach(e=>{e.data.selected=!1,_[e.id]&&(e.data={...e.data,..._[e.id]})});let a=t.findIndex(t=>t.id===e);t.splice(a,1,I),E&&t.push(E),w&&t.push(w)})),u((0,t.produce)(s,e=>e.filter(e=>!f.find(t=>t.id===e.id)))),a===C.BlockEnum.TriggerWebhook?y(!0,!0,{onSuccess:()=>F(I.id)}):y(),z(k.NodeChange,{nodeId:e})},[m,p,y,z,$,F]),ed=(0,a.useCallback)(()=>{let{getNodes:e,setNodes:a}=p.getState(),o=e();a((0,t.produce)(o,e=>{e.forEach(e=>{e.data.selected=!1})}))},[p]),el=(0,a.useCallback)((e,t)=>{if(t.type===H.CUSTOM_NOTE_NODE||t.type===P.CUSTOM_ITERATION_START_NODE||t.type===H.CUSTOM_NOTE_NODE||t.type===M.CUSTOM_LOOP_START_NODE)return;e.preventDefault();let{x:a,y:o}=document.querySelector("#workflow-container").getBoundingClientRect();g.setState({nodeMenu:{top:e.clientY-o,left:e.clientX-a,nodeId:t.id}}),Q(t.id)},[g,Q]),es=(0,a.useCallback)(e=>{if(m())return;let{setClipboardElements:t}=g.getState(),{getNodes:a}=p.getState(),o=a();if(e){let a=o.find(t=>t.id===e&&t.data.type!==C.BlockEnum.Start&&t.type!==P.CUSTOM_ITERATION_START_NODE&&t.type!==M.CUSTOM_LOOP_START_NODE&&t.data.type!==C.BlockEnum.LoopEnd&&t.data.type!==C.BlockEnum.KnowledgeBase&&t.data.type!==C.BlockEnum.DataSourceEmpty);a&&t([a])}else{let e=o.filter(e=>{if(!e.data._isBundled)return!1;if(e.type===H.CUSTOM_NOTE_NODE)return!0;let{metaData:t}=$[e.data.type];return!t.isSingleton&&!e.data.isInIteration&&!e.data.isInLoop});if(e.length)return void t(e);let a=o.find(e=>{if(!e.data.selected)return!1;if(e.type===H.CUSTOM_NOTE_NODE)return!0;let{metaData:t}=$[e.data.type];return!t.isSingleton});a&&t([a])}},[m,p,g]),eu=(0,a.useCallback)(()=>{if(m())return;let{clipboardElements:e,mousePosition:a}=g.getState(),{getNodes:o,setNodes:i,edges:n,setEdges:r}=p.getState(),d=[],l=[],s=o();if(e.length){let{x:o,y:u}=(0,x.getTopLeftNodePosition)(e),{screenToFlowPosition:c}=f,p=c({x:a.pageX,y:a.pageY}),g=p.x-o,h=p.y-u,S={},I=[];e.forEach((e,t)=>{let a=e.data.type,{newNode:o,newIterationStartNode:i,newLoopStartNode:n}=(0,x.generateNewNode)({type:e.type,data:{...e.type!==H.CUSTOM_NOTE_NODE&&$[a].defaultValue,...e.data,selected:!1,_isBundled:!1,_connectedSourceHandleIds:[],_connectedTargetHandleIds:[],_dimmed:!1,title:(0,x.genNewNodeTitleFromOld)(e.data.title)},position:{x:e.position.x+g,y:e.position.y+h},extent:e.extent,zIndex:e.zIndex});o.id=o.id+t;let r=[];if(e.data.type===C.BlockEnum.Iteration){i.parentId=o.id,o.data.start_node_id=i.id,S[s.find(t=>t.parentId===e.id&&t.type===P.CUSTOM_ITERATION_START_NODE).id]=i.id;let{copyChildren:t,newIdMapping:a}=v(e.id,o.id,S);r=t,S=a,r.forEach(e=>{o.data._children?.push({nodeId:e.id,nodeType:e.data.type})}),r.push(i)}else if(e.data.type===C.BlockEnum.Loop)n.parentId=o.id,o.data.start_node_id=n.id,(r=W(e.id,o.id)).forEach(e=>{o.data._children?.push({nodeId:e.id,nodeType:e.data.type})}),r.push(n);else{let t=s.find(e=>e.selected);if(t){if([C.BlockEnum.End].includes(e.data.type))return;if(t.data.type===C.BlockEnum.Iteration||t.data.type===C.BlockEnum.Loop){let e=t.data.type===C.BlockEnum.Iteration;o.data.isInIteration=e,o.data.iteration_id=e?t.id:void 0,o.data.isInLoop=!e,o.data.loop_id=e?void 0:t.id,o.parentId=t.id,o.zIndex=e?O.ITERATION_CHILDREN_Z_INDEX:O.LOOP_CHILDREN_Z_INDEX,o.positionAbsolute={x:o.position.x,y:o.position.y},o.position=(0,x.getNestedNodePosition)(o,t),I.push({parentId:t.id,childId:o.id,childType:o.data.type})}}}d.push(o),r.length&&d.push(...r)}),n.forEach(e=>{let t=S[e.source],a=S[e.target];if(t&&a){let o={...e,id:`${t}-${e.sourceHandle}-${a}-${e.targetHandle}`,source:t,target:a,data:{...e.data,_connectedNodeIsSelected:!1}};l.push(o)}}),i((0,t.produce)(s,e=>{I.forEach(t=>{let{parentId:a,childId:o,childType:i}=t,n=e.find(e=>e.id===a);n&&n.data._children?.push({nodeId:o,nodeType:i})}),e.push(...d)})),r([...n,...l]),z(k.NodePaste,{nodeId:d?.[0]?.id}),y()}},[m,g,p,f,z,y,v,W,$]),ec=(0,a.useCallback)(e=>{m()||(es(e),eu())},[m,es,eu]),ep=(0,a.useCallback)(()=>{if(m())return;let{getNodes:e,edges:t}=p.getState(),a=e(),o=a.filter(e=>e.data._isBundled);if(o.length)return void o.forEach(e=>ei(e.id));if(t.some(e=>e.selected))return;let i=a.find(e=>e.data.selected);i&&ei(i.id)},[p,m,ei]),eg=(0,a.useCallback)((e,a)=>{let o,i;if(m())return;let{getNodes:n,setNodes:r}=p.getState(),{x:d,y:l,width:s,height:u}=a,c=n(),g=c.find(t=>t.id===e);if(c.filter(e=>g.data._children?.find(t=>t.nodeId===e.id)).forEach(e=>{o?e.position.x+e.width>o.position.x+o.width&&(o=e):o=e,i?e.position.y+e.height>i.position.y+i.height&&(i=e):i=e}),o&&i){let e=c.find(e=>e.id===o.parentId),t=e?.data.type===C.BlockEnum.Iteration?O.ITERATION_PADDING:O.LOOP_PADDING;if(s<o.position.x+o.width+t.right||u<i.position.y+i.height+t.bottom)return}r((0,t.produce)(c,t=>{t.forEach(t=>{t.id===e&&(t.data.width=s,t.data.height=u,t.width=s,t.height=u,t.position.x=d,t.position.y=l)})})),y(),z(k.NodeResize,{nodeId:e})},[m,p,y,z]),ef=(0,a.useCallback)(e=>{if(m())return;let{getNodes:a,setNodes:n,edges:r,setEdges:d}=p.getState(),l=a(),s=l.find(t=>t.id===e),u=(0,o.getConnectedEdges)([s],r),c=(0,i.getNodesConnectedSourceOrTargetHandleIdsMap)(u.map(e=>({type:"remove",edge:e})),l);n((0,t.produce)(l,e=>{e.forEach(e=>{c[e.id]&&(e.data={...e.data,...c[e.id]})})})),d((0,t.produce)(r,e=>e.filter(e=>!u.find(t=>t.id===e.id)))),y(),z(k.EdgeDelete)},[p,m,y,z]),eh=(0,a.useCallback)(()=>{if(m()||w())return;let{setEdges:e,setNodes:t}=p.getState();G();let{edges:a,nodes:o}=h.getState();(0!==a.length||0!==o.length)&&(e(a),t(o))},[p,G,h,m,w]),ey=(0,a.useCallback)(()=>{if(m()||w())return;let{setEdges:e,setNodes:t}=p.getState();K();let{edges:a,nodes:o}=h.getState();(0!==a.length||0!==o.length)&&(e(a),t(o))},[K,p,h,m,w]),[eS,eI]=(0,a.useState)(!1);return{handleNodeDragStart:X,handleNodeDrag:Z,handleNodeDragStop:Y,handleNodeEnter:q,handleNodeLeave:j,handleNodeSelect:Q,handleNodeClick:J,handleNodeConnect:ee,handleNodeConnectStart:et,handleNodeConnectEnd:ea,handleNodeDelete:ei,handleNodeChange:er,handleNodeAdd:en,handleNodesCancelSelected:ed,handleNodeContextMenu:el,handleNodesCopy:es,handleNodesPaste:eu,handleNodesDuplicate:ec,handleNodesDelete:ep,handleNodeResize:eg,handleNodeDisconnect:ef,handleHistoryBack:eh,handleHistoryForward:ey,dimOtherNodes:(0,a.useCallback)(()=>{if(eS)return;let{getNodes:e,setNodes:a,edges:i,setEdges:n}=p.getState(),r=e(),d=r.find(e=>e.data.selected);if(!d)return;eI(!0);let l=(0,A.getNodeUsedVars)(d),s=[];l.forEach(e=>{let t=r.find(t=>t.id===e?.[0]);t&&!s.includes(t)&&s.push(t)});let u=(0,o.getOutgoers)(d,r,i);for(let e=0;e<u.length;e++){let t=u[e];(0,o.getOutgoers)(t,r,i).forEach(e=>{u.some(t=>t.id===e.id)||u.push(e)})}let c=[];u.forEach(e=>{(0,A.getNodeUsedVars)(e).some(e=>e?.[0]===d.id)&&(c.some(t=>t.id===e.id)||c.push(e))});let g=[...s,...c,d];a((0,t.produce)(r,e=>{e.forEach(e=>{g.find(t=>t.id===e.id)||(e.data._dimmed=!0)})}));let f=[];s.forEach(e=>{f.push({id:`tmp_${e.id}-source-${d.id}-target`,type:O.CUSTOM_EDGE,source:e.id,sourceHandle:"source_tmp",target:d.id,targetHandle:"target_tmp",animated:!0,data:{sourceType:e.data.type,targetType:d.data.type,_isTemp:!0,_connectedNodeIsHovering:!0}})}),c.forEach(e=>{f.push({id:`tmp_${d.id}-source-${e.id}-target`,type:O.CUSTOM_EDGE,source:d.id,sourceHandle:"source_tmp",target:e.id,targetHandle:"target_tmp",animated:!0,data:{sourceType:d.data.type,targetType:e.data.type,_isTemp:!0,_connectedNodeIsHovering:!0}})}),n((0,t.produce)(i,e=>{e.forEach(e=>{e.data._dimmed=!0}),e.push(...f)}))},[eS,p]),undimAllNodes:(0,a.useCallback)(()=>{let{getNodes:e,setNodes:a,edges:o,setEdges:i}=p.getState(),n=e();eI(!1),a((0,t.produce)(n,e=>{e.forEach(e=>{e.data._dimmed=!1})})),i((0,t.produce)(o.filter(e=>!e.data._isTemp),e=>{e.forEach(e=>{e.data._dimmed=!1})}))},[p])}};e.s([],257988);var U=e.i(641153);e.i(361126),new U.default,e.s(["usePanelInteractions",0,()=>{let e=(0,N.useWorkflowStore)(),t=(0,a.useCallback)(t=>{t.preventDefault();let{x:a,y:o}=document.querySelector("#workflow-container").getBoundingClientRect();e.setState({panelMenu:{top:t.clientY-o,left:t.clientX-a}})},[e]);return{handlePaneContextMenu:t,handlePaneContextmenuCancel:(0,a.useCallback)(()=>{e.setState({panelMenu:void 0})},[e]),handleNodeContextmenuCancel:(0,a.useCallback)(()=>{e.setState({nodeMenu:void 0})},[e])}}],568603),e.s(["useSelectionInteractions",0,()=>{let e=(0,o.useStoreApi)(),i=(0,N.useWorkflowStore)(),n=(0,a.useCallback)(()=>{let{getNodes:a,setNodes:o,edges:i,setEdges:n,userSelectionRect:r}=e.getState();if(!r?.width||!r?.height){let e=a();o((0,t.produce)(e,e=>{e.forEach(e=>{e.data._isBundled&&(e.data._isBundled=!1)})})),n((0,t.produce)(i,e=>{e.forEach(e=>{e.data._isBundled&&(e.data._isBundled=!1)})}))}},[e]),r=(0,a.useCallback)(a=>{let{nodes:o,edges:i}=a,{getNodes:n,setNodes:r,edges:d,setEdges:l,userSelectionRect:s}=e.getState(),u=n();s?.width&&s?.height&&(r((0,t.produce)(u,e=>{e.forEach(e=>{o.find(t=>t.id===e.id)?e.data._isBundled=!0:e.data._isBundled=!1})})),l((0,t.produce)(d,e=>{e.forEach(e=>{i.find(t=>t.id===e.id)?e.data._isBundled=!0:e.data._isBundled=!1})})))},[e]),d=(0,a.useCallback)((a,o)=>{let{getNodes:n,setNodes:r}=e.getState();i.setState({nodeAnimation:!1});let d=n();r((0,t.produce)(d,e=>{e.forEach(e=>{let t=o.find(t=>t.id===e.id);t&&(e.position=t.position)})}))},[e,i]),l=(0,a.useCallback)(()=>{let{getNodes:a,setNodes:o,edges:i,setEdges:n}=e.getState();e.setState({userSelectionRect:null,userSelectionActive:!0});let r=a();o((0,t.produce)(r,e=>{e.forEach(e=>{e.data._isBundled&&(e.data._isBundled=!1)})})),n((0,t.produce)(i,e=>{e.forEach(e=>{e.data._isBundled&&(e.data._isBundled=!1)})}))},[e]);return{handleSelectionStart:n,handleSelectionChange:r,handleSelectionDrag:d,handleSelectionCancel:l,handleSelectionContextMenu:(0,a.useCallback)(e=>{if(!e.target.classList.contains("react-flow__nodesselection-rect"))return;e.preventDefault();let{x:t,y:a}=document.querySelector("#workflow-container").getBoundingClientRect();i.setState({selectionMenu:{top:e.clientY-a,left:e.clientX-t}})},[i]),handleSelectionContextmenuCancel:(0,a.useCallback)(()=>{i.setState({selectionMenu:void 0})},[i])}}],77352)},337160,e=>{"use strict";var t=e.i(268255);e.s(["useSerialAsyncCallback",0,(e,a)=>{let o=(0,t.useRef)(Promise.resolve());return(0,t.useCallback)(function(){for(var t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];if(a?.())return Promise.resolve(void 0);let r=o.current.catch(()=>void 0).then(()=>e(...i));return o.current=r,r},[e,a])}])},872135,e=>{"use strict";e.i(491401);var t=e.i(585736);e.s(["useSetWorkflowVarsWithValue",0,()=>({fetchInspectVars:(0,t.useHooksStore)(e=>e.fetchInspectVars)})])},586136,e=>{"use strict";var t=e.i(105845),a=e.i(268255),o=e.i(192447);e.s(["useEdgesInteractionsWithoutSync",0,()=>{let e=(0,o.useStoreApi)();return{handleEdgeCancelRunningStatus:(0,a.useCallback)(()=>{let{edges:a,setEdges:o}=e.getState();o((0,t.produce)(a,e=>{e.forEach(e=>{e.data._sourceRunningStatus=void 0,e.data._targetRunningStatus=void 0,e.data._waitingRun=!1})}))},[e])}}])},213889,e=>{"use strict";var t=e.i(105845),a=e.i(268255),o=e.i(192447),i=e.i(390622);e.s(["useNodesInteractionsWithoutSync",0,()=>{let e=(0,o.useStoreApi)(),n=(0,a.useCallback)(()=>{let{getNodes:a,setNodes:o}=e.getState(),i=a();o((0,t.produce)(i,e=>{e.forEach(e=>{e.data._runningStatus=void 0,e.data._waitingRun=!1})}))},[e]);return{handleNodeCancelRunningStatus:n,handleCancelAllNodeSuccessStatus:(0,a.useCallback)(()=>{let{getNodes:a,setNodes:o}=e.getState(),n=a();o((0,t.produce)(n,e=>{e.forEach(e=>{e.data._runningStatus===i.NodeRunningStatus.Succeeded&&(e.data._runningStatus=void 0)})}))},[e]),handleCancelNodeSuccessStatus:(0,a.useCallback)(a=>{let{getNodes:o,setNodes:n}=e.getState();n((0,t.produce)(o(),e=>{let t=e.find(e=>e.id===a);t&&t.data._runningStatus===i.NodeRunningStatus.Succeeded&&(t.data._runningStatus=void 0,t.data._waitingRun=!1)}))},[e])}}])},845780,856105,413741,383923,892323,556354,340821,886485,e=>{"use strict";e.s([],845780),e.i(368148),e.i(3340),e.i(944419),e.i(804612);var t=e.i(735738);e.i(959095),e.i(554499);var a=e.i(265522);e.i(257988),e.i(148280);var o=e.i(604208);e.i(568603);var i=e.i(77352);e.i(337160),e.i(872135),e.s(["useShortcuts",()=>v],413741);var n=e.i(250755),r=e.i(268255),d=e.i(192447),l=e.i(571566);e.s(["useWorkflowCanvasMaximize",()=>T,"useWorkflowInteractions",()=>E,"useWorkflowMoveMode",()=>m,"useWorkflowOrganize",()=>w,"useWorkflowUpdate",()=>_],856105);var s=e.i(105845),u=e.i(249420),c=e.i(959752),p=e.i(720315);e.i(275225);var g=e.i(705405),f=e.i(390622);e.i(905691);var h=e.i(722681),y=e.i(322034),S=e.i(586136),I=e.i(213889),k=e.i(339512);let E=()=>{let e=(0,g.useWorkflowStore)(),{handleNodeCancelRunningStatus:t}=(0,I.useNodesInteractionsWithoutSync)(),{handleEdgeCancelRunningStatus:a}=(0,S.useEdgesInteractionsWithoutSync)();return{handleCancelDebugAndPreviewPanel:(0,r.useCallback)(()=>{e.setState({showDebugAndPreviewPanel:!1,workflowRunningData:void 0}),t(),a()},[e,t,a])}},m=()=>{let e=(0,g.useStore)(e=>e.setControlMode),{getNodesReadOnly:t}=(0,p.useNodesReadOnly)(),{handleSelectionCancel:a}=(0,i.useSelectionInteractions)();return{handleModePointer:(0,r.useCallback)(()=>{t()||e(f.ControlMode.Pointer)},[t,e]),handleModeHand:(0,r.useCallback)(()=>{t()||(e(f.ControlMode.Hand),a())},[t,e,a])}},w=()=>{let e=(0,g.useWorkflowStore)(),t=(0,d.useStoreApi)(),a=(0,d.useReactFlow)(),{getNodesReadOnly:i}=(0,p.useNodesReadOnly)(),{saveStateToHistory:n}=(0,k.useWorkflowHistory)(),{handleSyncWorkflowDraft:l}=(0,o.useNodesSyncDraft)();return{handleLayout:(0,r.useCallback)(async()=>{if(i())return;e.setState({nodeAnimation:!0});let{getNodes:o,edges:r,setNodes:d}=t.getState(),{setViewport:u}=a,p=o(),g=p.filter(e=>(e.data.type===f.BlockEnum.Loop||e.data.type===f.BlockEnum.Iteration)&&!e.parentId&&e.type===c.CUSTOM_NODE),y=(await Promise.all(g.map(async e=>[e.id,await (0,h.getLayoutForChildNodes)(e.id,p,r)]))).reduce((e,t)=>{let[a,o]=t;return o&&(e[a]=o),e},{}),S={};g.forEach(e=>{let t=y[e.id];if(!t)return;let{bounds:a,nodes:o}=t;if(!o.size)return;let i=a.maxX-a.minX+2*c.NODE_LAYOUT_HORIZONTAL_PADDING,n=a.maxY-a.minY+2*c.NODE_LAYOUT_VERTICAL_PADDING;S[e.id]={width:Math.max(e.width||0,i),height:Math.max(e.height||0,n)}});let I=(0,s.produce)(p,e=>{e.forEach(e=>{(e.data.type===f.BlockEnum.Loop||e.data.type===f.BlockEnum.Iteration)&&S[e.id]&&(e.width=S[e.id].width,e.height=S[e.id].height,e.data.type===f.BlockEnum.Loop?(e.data.width=S[e.id].width,e.data.height=S[e.id].height):e.data.type===f.BlockEnum.Iteration&&(e.data.width=S[e.id].width,e.data.height=S[e.id].height))})}),E=await (0,h.getLayoutByDagre)(I,r),m=new Map;E.nodes.forEach(e=>{if(void 0!==e.layer){let t=m.get(e.layer),a={minY:t?Math.min(t.minY,e.y):e.y,maxHeight:t?Math.max(t.maxHeight,e.height):e.height};m.set(e.layer,a)}}),d((0,s.produce)(I,e=>{e.forEach(e=>{if(!e.parentId&&e.type===c.CUSTOM_NODE){let t=E.nodes.get(e.id);if(!t)return;let a=t.y;if(void 0!==t.layer){let e=m.get(t.layer);e&&(a=e.minY+e.maxHeight/2-t.height/2)}e.position={x:t.x,y:a}}}),g.forEach(t=>{let a=y[t.id];if(!a)return;let o=e.filter(e=>e.parentId===t.id),{bounds:i,nodes:n}=a;o.forEach(e=>{let t=n.get(e.id);t&&(e.position={x:c.NODE_LAYOUT_HORIZONTAL_PADDING+(t.x-i.minX),y:c.NODE_LAYOUT_VERTICAL_PADDING+(t.y-i.minY)})})})})),u({x:0,y:0,zoom:.7}),n(k.WorkflowHistoryEvent.LayoutOrganize),setTimeout(()=>{l()})},[i,t,a,e,l,n])}},_=()=>{let e=(0,d.useReactFlow)(),{eventEmitter:t}=(0,u.useEventEmitterContextContext)();return{handleUpdateWorkflowCanvas:(0,r.useCallback)(a=>{let{nodes:o,edges:i,viewport:n}=a,{setViewport:r}=e;t?.emit({type:c.WORKFLOW_DATA_UPDATE,payload:{nodes:(0,y.initialNodes)(o,i),edges:(0,y.initialEdges)(i,o)}}),n&&"number"==typeof n.x&&"number"==typeof n.y&&"number"==typeof n.zoom&&r(n)},[t,e])}},T=()=>{let{eventEmitter:e}=(0,u.useEventEmitterContextContext)(),t=(0,g.useStore)(e=>e.maximizeCanvas),a=(0,g.useStore)(e=>e.setMaximizeCanvas),{getNodesReadOnly:o}=(0,p.useNodesReadOnly)();return{handleToggleMaximizeCanvas:(0,r.useCallback)(()=>{o()||(a(!t),localStorage.setItem("workflow-canvas-maximize",String(!t)),e?.emit({type:"workflow-canvas-maximize",payload:!t}))},[e,o,t,a])}};var N=e.i(706416),C=e.i(276145);let v=()=>{let{handleNodesCopy:e,handleNodesPaste:i,handleNodesDuplicate:s,handleNodesDelete:u,handleHistoryBack:c,handleHistoryForward:p,dimOtherNodes:f,undimAllNodes:h}=(0,a.useNodesInteractions)(),{shortcutsEnabled:y}=(0,C.useWorkflowHistoryStore)(),{handleSyncWorkflowDraft:S}=(0,o.useNodesSyncDraft)(),{handleEdgeDelete:I}=(0,t.useEdgesInteractions)(),k=(0,g.useWorkflowStore)(),{handleModeHand:E,handleModePointer:_}=m(),{handleLayout:v}=w(),{handleToggleMaximizeCanvas:D}=T(),{zoomTo:b,getZoom:O,fitView:A}=(0,d.useReactFlow)(),P=(0,r.useCallback)(e=>!(0,N.isEventTargetInputArea)(e.target),[]),B=(0,r.useCallback)(()=>{let e=document.getSelection();return!e||e.isCollapsed},[]);(0,n.useKeyPress)(["delete","backspace"],e=>{P(e)&&(e.preventDefault(),u(),I())}),(0,n.useKeyPress)(`${(0,N.getKeyboardKeyCodeBySystem)("ctrl")}.c`,t=>{let{showDebugAndPreviewPanel:a}=k.getState();P(t)&&B()&&!a&&(t.preventDefault(),e())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)(`${(0,N.getKeyboardKeyCodeBySystem)("ctrl")}.v`,e=>{let{showDebugAndPreviewPanel:t}=k.getState();P(e)&&!t&&(e.preventDefault(),i())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)(`${(0,N.getKeyboardKeyCodeBySystem)("ctrl")}.d`,e=>{P(e)&&(e.preventDefault(),s())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)(`${(0,N.getKeyboardKeyCodeBySystem)("alt")}.r`,e=>{P(e)&&(e.preventDefault(),window._toggleTestRunDropdown&&window._toggleTestRunDropdown())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)(`${(0,N.getKeyboardKeyCodeBySystem)("ctrl")}.z`,e=>{let{showDebugAndPreviewPanel:t}=k.getState();P(e)&&!t&&(e.preventDefault(),y&&c())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)([`${(0,N.getKeyboardKeyCodeBySystem)("ctrl")}.y`,`${(0,N.getKeyboardKeyCodeBySystem)("ctrl")}.shift.z`],e=>{P(e)&&(e.preventDefault(),y&&p())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)("h",e=>{P(e)&&(e.preventDefault(),E())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)("v",e=>{P(e)&&(e.preventDefault(),_())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)(`${(0,N.getKeyboardKeyCodeBySystem)("ctrl")}.o`,e=>{P(e)&&(e.preventDefault(),v())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)("f",e=>{P(e)&&(e.preventDefault(),D())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)(`${(0,N.getKeyboardKeyCodeBySystem)("ctrl")}.1`,e=>{P(e)&&(e.preventDefault(),A(),S())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)("shift.1",e=>{P(e)&&(e.preventDefault(),b(1),S())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)("shift.5",e=>{P(e)&&(e.preventDefault(),b(.5),S())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)(`${(0,N.getKeyboardKeyCodeBySystem)("ctrl")}.dash`,e=>{P(e)&&(e.preventDefault(),b(Math.max(O()-.1,.25)),S())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)(`${(0,N.getKeyboardKeyCodeBySystem)("ctrl")}.equalsign`,e=>{P(e)&&(e.preventDefault(),b(Math.min(O()+.1,2)),S())},{exactMatch:!0,useCapture:!0}),(0,n.useKeyPress)("shift",e=>{P(e)&&f()},{exactMatch:!0,useCapture:!0,events:["keydown"]}),(0,n.useKeyPress)(e=>"Shift"===e.key,e=>{P(e)&&h()},{exactMatch:!0,useCapture:!0,events:["keyup"]}),(0,r.useEffect)(()=>{let e=()=>{D()};return window.addEventListener(l.ZEN_TOGGLE_EVENT,e),()=>{window.removeEventListener(l.ZEN_TOGGLE_EVENT,e)}},[D])};e.i(95131),e.s(["useWorkflowMode",0,()=>{let e=(0,g.useStore)(e=>e.historyWorkflowData),t=(0,g.useStore)(e=>e.isRestoring);return(0,r.useMemo)(()=>({normal:!e&&!t,restoring:t,viewHistory:!!e}),[e,t])}],383923),e.i(491401);var D=e.i(585736);e.s(["useWorkflowRefreshDraft",0,()=>({handleRefreshWorkflowDraft:(0,D.useHooksStore)(e=>e.handleRefreshWorkflowDraft)})],892323),e.s(["useWorkflowRun",0,()=>{let e=(0,D.useHooksStore)(e=>e.handleBackupDraft),t=(0,D.useHooksStore)(e=>e.handleLoadBackupDraft),a=(0,D.useHooksStore)(e=>e.handleRestoreFromPublishedWorkflow);return{handleBackupDraft:e,handleLoadBackupDraft:t,handleRun:(0,D.useHooksStore)(e=>e.handleRun),handleStopRun:(0,D.useHooksStore)(e=>e.handleStopRun),handleRestoreFromPublishedWorkflow:a}}],556354),e.s(["useWorkflowSearch",()=>M],340821);var b=e.i(563199),O=e.i(87403),A=e.i(946700),P=e.i(120219),B=e.i(154033),x=e.i(842090),R=e.i(997908);let M=()=>{let e=(0,d.useNodes)(),{handleNodeSelect:t}=(0,a.useNodesInteractions)(),{data:o}=(0,B.useAllBuiltInTools)(),{data:i}=(0,B.useAllCustomTools)(),{data:n}=(0,B.useAllWorkflowTools)(),{data:l}=(0,B.useAllMCPTools)(),s=(0,r.useCallback)(e=>{if(e?.type!==f.BlockEnum.Tool)return;let t={[A.CollectionType.builtIn]:o||[],[A.CollectionType.custom]:i||[],[A.CollectionType.mcp]:l||[]},a=e.provider_type&&t[e.provider_type]||n;return a?.find(t=>(0,x.canFindTool)(t.id,e.provider_id))?.icon},[o,i,n,l]),u=(0,r.useCallback)(e=>e?.type!==f.BlockEnum.LLM?{}:e.model?{provider:e.model.provider,name:e.model.name,mode:e.model.mode}:{},[]),c=(0,r.useMemo)(()=>e.filter(e=>{if(!e.id||!e.data||"sticky"===e.type)return!1;let t=e.data;return!["iteration-start","loop-start"].includes(t?.type)}).map(e=>{let t=e.data;return{id:e.id,title:t?.title||t?.type||"Untitled",type:t?.type||"",desc:t?.desc||"",blockType:t?.type,nodeData:t,toolIcon:s(t),modelInfo:u(t)}}),[e,s,u]),p=(0,r.useCallback)((e,t)=>{if(!t)return 1;let a=e.title.toLowerCase(),o=e.type.toLowerCase(),i=e.desc?.toLowerCase()||"",n=e.modelInfo?.provider?.toLowerCase()||"",r=e.modelInfo?.name?.toLowerCase()||"",d=e.modelInfo?.mode?.toLowerCase()||"",l=0;return a.startsWith(t)?l+=100:a.includes(t)&&(l+=50),o===t?l+=80:o.includes(t)&&(l+=30),i.includes(t)&&(l+=20),r&&r.includes(t)&&(l+=60),n&&n.includes(t)&&(l+=40),d&&d.includes(t)&&(l+=30),l},[]),g=(0,r.useCallback)(e=>{if(!c.length)return[];let t=e.toLowerCase().trim();return c.map(e=>{let a=p(e,t);return a>0?{id:e.id,title:e.title,description:e.desc||e.type,type:"workflow-node",path:`#${e.id}`,icon:(0,b.jsx)(P.default,{type:e.blockType,className:"shrink-0",size:"sm",toolIcon:e.toolIcon}),metadata:{nodeId:e.id,nodeData:e.nodeData},data:e.nodeData,score:a}:null}).filter(e=>null!==e).sort((e,a)=>t?(a.score||0)-(e.score||0):e.title.localeCompare(a.title))},[c,p]);return(0,r.useEffect)(()=>(c.length>0&&(O.workflowNodesAction.searchFn=g),()=>{O.workflowNodesAction.searchFn=void 0}),[c,g]),(0,r.useEffect)(()=>(0,R.setupNodeSelectionListener)(t),[t]),null};e.s(["useWorkflowStartRun",0,()=>{let e=(0,D.useHooksStore)(e=>e.handleStartWorkflowRun),t=(0,D.useHooksStore)(e=>e.handleWorkflowStartRunInWorkflow),a=(0,D.useHooksStore)(e=>e.handleWorkflowStartRunInChatflow),o=(0,D.useHooksStore)(e=>e.handleWorkflowTriggerScheduleRunInWorkflow),i=(0,D.useHooksStore)(e=>e.handleWorkflowTriggerWebhookRunInWorkflow);return{handleStartWorkflowRun:e,handleWorkflowStartRunInWorkflow:t,handleWorkflowStartRunInChatflow:a,handleWorkflowTriggerScheduleRunInWorkflow:o,handleWorkflowTriggerWebhookRunInWorkflow:i,handleWorkflowTriggerPluginRunInWorkflow:(0,D.useHooksStore)(e=>e.handleWorkflowTriggerPluginRunInWorkflow),handleWorkflowRunAllTriggersInWorkflow:(0,D.useHooksStore)(e=>e.handleWorkflowRunAllTriggersInWorkflow)}}],886485),e.i(949250)}]);