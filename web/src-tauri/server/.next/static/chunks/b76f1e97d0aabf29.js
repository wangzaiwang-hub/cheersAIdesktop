(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,434937,e=>{"use strict";var t=e.i(563199),o=e.i(268255);let a=o.forwardRef(function(e,t){let{title:a,titleId:i,...r}=e;return o.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":i},r),a?o.createElement("title",{id:i},a):null,o.createElement("path",{fillRule:"evenodd",d:"M6.28 5.22a.75.75 0 0 1 0 1.06L2.56 10l3.72 3.72a.75.75 0 0 1-1.06 1.06L.97 10.53a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Zm7.44 0a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L17.44 10l-3.72-3.72a.75.75 0 0 1 0-1.06ZM11.377 2.011a.75.75 0 0 1 .612.867l-2.5 14.5a.75.75 0 0 1-1.478-.255l2.5-14.5a.75.75 0 0 1 .866-.612Z",clipRule:"evenodd"}))});var i=e.i(417944),r=e.i(668295),n=e.i(719730),s=e.i(346563),l=e.i(105845),d=e.i(326531);e.i(152567);var p=e.i(408767),m=e.i(339548),_=e.i(908432),u=e.i(990835),c=e.i(547105),g=e.i(987878),f=e.i(471981),x=e.i(390622),h=e.i(648404);let b=e=>{let{t:a}=(0,p.useTranslation)(),i=(0,g.useFeatures)(e=>e.features),r=(0,g.useFeaturesStore)(),[n,s]=(0,o.useState)(!1),{more_like_this:d,opening_statement:m,suggested_questions:_,sensitive_word_avoidance:b,speech_to_text:v,text_to_speech:T,suggested_questions_after_answer:y,retriever_resource:M,annotation_reply:C,file_upload:E,resetAppConfig:P}=e.publishedConfig.modelConfig,N=(0,o.useCallback)(()=>{P?.();let{features:e,setFeatures:t}=r.getState();t((0,l.produce)(e,e=>{e.moreLikeThis=d||{enabled:!1},e.opening={enabled:!!m,opening_statement:m||"",suggested_questions:_||[]},e.moderation=b||{enabled:!1},e.speech2text=v||{enabled:!1},e.text2speech=T||{enabled:!1},e.suggested=y||{enabled:!1},e.citation=M||{enabled:!1},e.annotationReply=C||{enabled:!1},e.file={image:{detail:E?.image?.detail||h.Resolution.high,enabled:!!E?.image?.enabled,number_limits:E?.image?.number_limits||3,transfer_methods:E?.image?.transfer_methods||["local_file","remote_url"]},enabled:!!(E?.enabled||E?.image?.enabled),allowed_file_types:E?.allowed_file_types||[x.SupportUploadFileTypes.image],allowed_file_extensions:E?.allowed_file_extensions||f.FILE_EXTS[x.SupportUploadFileTypes.image].map(e=>`.${e}`),allowed_file_upload_methods:E?.allowed_file_upload_methods||E?.image?.transfer_methods||["local_file","remote_url"],number_limits:E?.number_limits||E?.image?.number_limits||3}})),s(!1)},[r,e]),A=(0,o.useCallback)(t=>e.onPublish?.(t,i),[i,e]);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(u.default,{...e,onPublish:A,onRestore:()=>s(!0)}),n&&(0,t.jsx)(c.default,{title:a("resetConfig.title",{ns:"appDebug"}),content:a("resetConfig.message",{ns:"appDebug"}),isShow:n,onConfirm:N,onCancel:()=>s(!1)})]})};var v=e.i(875489),T=e.i(151094),y=e.i(21151);let M=o.memo(e=>{let{isShow:a,saveLoading:i,data:r,onClose:n,onSave:s}=e,{t:l}=(0,p.useTranslation)(),[d,m]=(0,o.useState)(r);return(0,t.jsxs)(y.default,{title:l("feature.conversationHistory.editModal.title",{ns:"appDebug"}),isShow:a,onClose:n,children:[(0,t.jsx)("div",{className:"mt-6 text-sm font-medium leading-[21px] text-text-primary",children:l("feature.conversationHistory.editModal.userPrefix",{ns:"appDebug"})}),(0,t.jsx)("input",{className:"mt-2 box-border h-10 w-full rounded-lg bg-components-input-bg-normal px-3 text-sm leading-10",value:d.user_prefix,onChange:e=>m({...d,user_prefix:e.target.value})}),(0,t.jsx)("div",{className:"mt-6 text-sm font-medium leading-[21px] text-text-primary",children:l("feature.conversationHistory.editModal.assistantPrefix",{ns:"appDebug"})}),(0,t.jsx)("input",{className:"mt-2 box-border h-10 w-full rounded-lg bg-components-input-bg-normal px-3 text-sm leading-10",value:d.assistant_prefix,onChange:e=>m({...d,assistant_prefix:e.target.value}),placeholder:l("chat.conversationNamePlaceholder",{ns:"common"})||""}),(0,t.jsxs)("div",{className:"mt-10 flex justify-end",children:[(0,t.jsx)(T.default,{className:"mr-2 shrink-0",onClick:n,children:l("operation.cancel",{ns:"common"})}),(0,t.jsx)(T.default,{variant:"primary",className:"shrink-0",onClick:()=>s(d),loading:i,children:l("operation.save",{ns:"common"})})]})]})});var C=e.i(837699),E=e.i(892081);e.i(417885);var P=e.i(325832),P=P;e.i(25339);var N=e.i(580759),N=N,A=e.i(170866),w=e.i(925521),j=e.i(421001),S=e.i(935139);let k=o.memo(e=>{let{className:o,icon:a,name:i,description:r,children:n}=e;return(0,t.jsxs)("div",{className:(0,S.cn)(o,"flex h-12 items-center justify-between rounded-lg bg-background-section-burn px-3"),children:[(0,t.jsxs)("div",{className:"flex items-center",children:[a,(0,t.jsx)("div",{className:"ml-3 mr-1 text-sm font-semibold leading-6 text-text-secondary",children:i}),(0,t.jsx)(j.default,{popupContent:(0,t.jsx)("div",{className:"w-[180px]",children:r})})]}),(0,t.jsx)("div",{children:n})]})}),O=o.memo(e=>{let{isChatModel:a,payload:i,isFunctionCall:r,onCancel:n,onSave:s}=e,{t:l}=(0,p.useTranslation)(),[d,m]=(0,o.useState)(i),_=(0,o.useRef)(null),[u,c]=(0,o.useState)(!1);return(0,E.useClickAway)(()=>{u&&n()},_),(0,o.useEffect)(()=>{c(!0)},[]),(0,t.jsx)("div",{className:"fixed inset-0 z-[100] flex justify-end overflow-hidden p-2",style:{backgroundColor:"rgba(16, 24, 40, 0.20)"},children:(0,t.jsxs)("div",{ref:_,className:"flex h-full w-[640px] flex-col overflow-hidden rounded-xl border-[0.5px] border-components-panel-border bg-components-panel-bg shadow-xl",children:[(0,t.jsxs)("div",{className:"flex h-14 shrink-0 items-center justify-between border-b border-divider-regular pl-6 pr-5",children:[(0,t.jsx)("div",{className:"flex flex-col text-base font-semibold text-text-primary",children:(0,t.jsx)("div",{className:"leading-6",children:l("agent.setting.name",{ns:"appDebug"})})}),(0,t.jsx)("div",{className:"flex items-center",children:(0,t.jsx)("div",{onClick:n,className:"flex h-6 w-6 cursor-pointer items-center justify-center",children:(0,t.jsx)(C.RiCloseLine,{className:"h-4 w-4 text-text-tertiary"})})})]}),(0,t.jsxs)("div",{className:"grow overflow-y-auto border-b p-6 pb-[68px] pt-5",style:{borderBottom:"rgba(0, 0, 0, 0.05)"},children:[(0,t.jsx)(k,{className:"mb-4",icon:(0,t.jsx)(P.default,{className:"h-4 w-4 text-indigo-600"}),name:l("agent.agentMode",{ns:"appDebug"}),description:l("agent.agentModeDes",{ns:"appDebug"}),children:(0,t.jsx)("div",{className:"text-[13px] font-medium leading-[18px] text-text-primary",children:l(r?"agent.agentModeType.functionCall":"agent.agentModeType.ReACT",{ns:"appDebug"})})}),(0,t.jsx)(k,{className:"mb-4",icon:(0,t.jsx)(N.default,{className:"h-4 w-4 text-[#FB6514]"}),name:l("agent.setting.maximumIterations.name",{ns:"appDebug"}),description:l("agent.setting.maximumIterations.description",{ns:"appDebug"}),children:(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)(A.default,{className:"mr-3 w-[156px]",min:1,max:w.MAX_ITERATIONS_NUM,value:d.max_iteration,onChange:e=>{m({...d,max_iteration:e})}}),(0,t.jsx)("input",{type:"number",min:1,max:w.MAX_ITERATIONS_NUM,step:1,className:"block h-7 w-11 rounded-lg border-0 bg-components-input-bg-normal px-1.5 pl-1 leading-7 text-text-primary placeholder:text-text-tertiary focus:ring-1 focus:ring-inset focus:ring-primary-600",value:d.max_iteration,onChange:e=>{let t=Number.parseInt(e.target.value,10);t<1&&(t=1),t>w.MAX_ITERATIONS_NUM&&(t=w.MAX_ITERATIONS_NUM),m({...d,max_iteration:t})}})]})}),!r&&(0,t.jsxs)("div",{className:"rounded-xl bg-background-section-burn py-2 shadow-xs",children:[(0,t.jsx)("div",{className:"flex h-8 items-center px-4 text-sm font-semibold leading-6 text-text-secondary",children:l("builtInPromptTitle",{ns:"tools"})}),(0,t.jsx)("div",{className:"h-[396px] overflow-y-auto whitespace-pre-line px-4 text-sm font-normal leading-5 text-text-secondary",children:a?w.DEFAULT_AGENT_PROMPT.chat:w.DEFAULT_AGENT_PROMPT.completion}),(0,t.jsx)("div",{className:"px-4",children:(0,t.jsx)("div",{className:"inline-flex h-5 items-center rounded-md bg-components-input-bg-normal px-1 text-xs font-medium leading-[18px] text-text-tertiary",children:(a?w.DEFAULT_AGENT_PROMPT.chat:w.DEFAULT_AGENT_PROMPT.completion).length})})]})]}),(0,t.jsxs)("div",{className:"sticky bottom-0 z-[5] flex w-full justify-end border-t border-divider-regular bg-background-section-burn px-6 py-4",children:[(0,t.jsx)(T.default,{onClick:n,className:"mr-2",children:l("operation.cancel",{ns:"common"})}),(0,t.jsx)(T.default,{variant:"primary",onClick:()=>{s(d)},children:l("operation.save",{ns:"common"})})]})]})})}),D=o.memo(e=>{let{onAgentSettingChange:a,isFunctionCall:i,isChatModel:r,agentConfig:n}=e,{t:s}=(0,p.useTranslation)(),[l,d]=(0,o.useState)(!1);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(T.default,{onClick:()=>d(!0),className:"mr-2 shrink-0",children:[(0,t.jsx)(C.RiSettings2Line,{className:"mr-1 h-4 w-4 text-text-tertiary"}),s("agent.setting.name",{ns:"appDebug"})]}),l&&(0,t.jsx)(O,{isFunctionCall:i,payload:n,isChatModel:r,onSave:e=>{a(e),d(!1)},onCancel:()=>d(!1)})]})});var R=e.i(766293),F=e.i(315765),I=e.i(890189),L=e.i(923978),U=e.i(459760),q=e.i(189299),G=e.i(757198),H=e.i(521632);e.i(458266);var B=e.i(733437),V=e.i(744699),X=e.i(449980),$=e.i(137667),W=e.i(59375),z=e.i(739255),K=e.i(225162),Z=e.i(337464),Q=e.i(88961),Y=e.i(337132),J=e.i(711536),ee=e.i(265630),et=e.i(381480),eo=e.i(296124),ea=e.i(56971),ei=e.i(271743),er=e.i(972282),en=e.i(211857),es=e.i(344600),el=e.i(652669),ed=e.i(842090),ep=e.i(495620),em=e.i(680884),e_=e.i(896071),eu=e.i(168014);let ec=o.memo(()=>{let{t:e}=(0,p.useTranslation)(),{notify:u}=(0,m.useContext)($.ToastContext),{isLoadingCurrentWorkspace:g,currentWorkspace:y}=(0,J.useAppContext)(),{appDetail:C,showAppConfigureFeaturesModal:E,setAppSidebarExpand:P,setShowAppConfigureFeaturesModal:N}=(0,q.useStore)((0,_.useShallow)(e=>({appDetail:e.appDetail,setAppSidebarExpand:e.setAppSidebarExpand,showAppConfigureFeaturesModal:e.showAppConfigureFeaturesModal,setShowAppConfigureFeaturesModal:e.setShowAppConfigureFeaturesModal}))),{data:A}=(0,el.useFileUploadConfig)(),j=(0,o.useMemo)(()=>C?.model_config?.updated_at,[C]),[S,k]=(0,o.useState)(!1),{setShowAccountSettingModal:O}=(0,eo.useModalContext)(),[ec,eg]=(0,o.useState)(!1),ef=!ec,ex=(0,d.usePathname)().match(/\/app\/([^/]+)/),eh=ex?.length&&ex[1]?ex[1]:"",[eb,ev]=(0,o.useState)(h.AppModeEnum.CHAT),[eT,ey]=(0,o.useState)(null),[eM,eC]=(0,o.useState)(""),eE=(0,ei.default)()===ei.MediaType.mobile,[eP,{setTrue:eN,setFalse:eA}]=(0,i.useBoolean)(!1),[ew,ej]=(0,o.useState)(""),[eS,ek]=(0,o.useState)([]),[eO,eD]=(0,o.useState)(0),[eR,eF]=(0,o.useState)({prompt_template:"",prompt_variables:[]}),[eI,eL]=(0,o.useState)({enabled:!1}),[eU,eq]=(0,o.useState)({enabled:!1}),[eG,eH]=(0,o.useState)({enabled:!1}),[eB,eV]=(0,o.useState)({enabled:!1,voice:"",language:""}),[eX,e$]=(0,o.useState)({enabled:!1}),[eW,ez]=(0,o.useState)({id:"",enabled:!1,score_threshold:w.ANNOTATION_DEFAULT.score_threshold,embedding_model:{embedding_provider_name:"",embedding_model_name:""}}),eK=(0,I.useFormattingChangedDispatcher)(),eZ=(e,t)=>{ez(e),t||eK()},[eQ,eY]=(0,o.useState)({enabled:!1}),[eJ,e0]=(0,o.useState)([]),[e1,e5]=(0,o.useState)({}),[e2,e4]=(0,o.useState)(""),[e6,e7]=(0,o.useState)({}),[e3,e8,e9]=(0,r.useGetState)([]),te=e=>{let t={...e};t.stop&&0!==t.stop.length||tu.current!==h.ModelModeType.completion||(t.stop=e9(),e8([])),e7(t)},[tt,to]=(0,o.useState)({provider:"langgenius/openai/openai",model_id:"gpt-3.5-turbo",mode:h.ModelModeType.unset,configs:{prompt_template:"",prompt_variables:[]},chat_prompt_config:(0,n.clone)(w.DEFAULT_CHAT_PROMPT_CONFIG),completion_prompt_config:(0,n.clone)(w.DEFAULT_COMPLETION_PROMPT_CONFIG),more_like_this:null,opening_statement:"",suggested_questions:[],sensitive_word_avoidance:null,speech_to_text:null,text_to_speech:null,file_upload:null,suggested_questions_after_answer:null,retriever_resource:null,annotation_reply:null,external_data_tools:[],system_parameters:{audio_file_size_limit:0,file_size_limit:0,image_file_size_limit:0,video_file_size_limit:0,workflow_file_upload_limit:0},dataSets:[],agentConfig:w.DEFAULT_AGENT_SETTING}),ta=eb===h.AppModeEnum.AGENT_CHAT,ti="langgenius/openai/openai"===tt.provider,[tr,tn]=(0,o.useState)([]),[ts,tl]=(0,o.useState)({retrieval_model:h.RETRIEVE_TYPE.multiWay,reranking_model:{reranking_provider_name:"",reranking_model_name:""},top_k:w.DATASET_DEFAULT.top_k,score_threshold_enabled:!1,score_threshold:w.DATASET_DEFAULT.score_threshold,datasets:{datasets:[]}}),td=(0,o.useRef)(ts),tp=(0,o.useCallback)(e=>{tl(e),td.current=e},[]),tm=e=>{to(e)},t_=tt.mode,tu=(0,o.useRef)(t_);(0,o.useEffect)(()=>{tu.current=t_},[t_]);let[tc,tg]=(0,o.useState)([]),tf=tt.configs.prompt_variables.find(e=>e.is_context_var)?.key,tx=!!tf,[th,{setTrue:tb,setFalse:tv}]=(0,i.useBoolean)(!1),tT=tc.map(e=>e.id),[ty,tM]=(0,o.useState)(!1),{currentModel:tC,currentProvider:tE}=(0,K.useModelListAndDefaultModelAndCurrentProviderAndModel)(z.ModelTypeEnum.rerank),[tP,{setTrue:tN,setFalse:tA}]=(0,i.useBoolean)(!1),tw=e=>{let t=e.modelConfig;tm(e.modelConfig),te(e.completionParams),tg(t.dataSets||[]),ej(t.opening_statement),eL(t.more_like_this||{enabled:!1}),eq(t.suggested_questions_after_answer||{enabled:!1}),eH(t.speech_to_text||{enabled:!1}),eV(t.text_to_speech||{enabled:!1,voice:"",language:""}),e$(t.retriever_resource||{enabled:!1})},{isAPIKeySet:tj}=(0,ea.useProviderContext)(),{currentModel:tS,textGenerationModelList:tk}=(0,K.useTextGenerationCurrentProviderAndModelAndModelList)({provider:tt.provider,model:tt.model_id}),tO=(0,e_.supportFunctionCall)(tS?.features);(0,o.useEffect)(()=>{if(ec&&!t_){let e=tS?.model_properties.mode;e&&tm((0,l.produce)(tt,t=>{t.mode=e}))}},[tk,ec,t_,tS,tt]);let[tD,tR]=(0,o.useState)(L.PromptMode.simple),tF=tD===L.PromptMode.advanced,[tI,tL]=(0,o.useState)(!0),tU=async e=>{e===L.PromptMode.advanced&&(await tQ(),tL(!0)),tR(e)},[tq,tG]=(0,o.useState)({enabled:!1,number_limits:2,detail:h.Resolution.low,transfer_methods:[h.TransferMethod.local_file]}),tH=(e,t)=>{tG({enabled:e.enabled||!1,number_limits:e.number_limits||2,detail:e.detail||h.Resolution.low,transfer_methods:e.transfer_methods||[h.TransferMethod.local_file]}),t||eK()},{chatPromptConfig:tB,setChatPromptConfig:tV,completionPromptConfig:tX,setCompletionPromptConfig:t$,currentAdvancedPrompt:tW,setCurrentAdvancedPrompt:tz,hasSetBlockStatus:tK,setConversationHistoriesRole:tZ,migrateToDefaultPrompt:tQ}=(e=>{let{appMode:t,modelModeType:a,modelName:i,promptMode:r,prePrompt:s,onUserChangedPrompt:d,hasSetDataSet:p,completionParams:m,setCompletionParams:_,setStop:u}=e,c=r===L.PromptMode.advanced,[g,x]=(0,o.useState)(()=>(0,n.clone)(w.DEFAULT_CHAT_PROMPT_CONFIG)),[b,v]=(0,o.useState)(()=>(0,n.clone)(w.DEFAULT_COMPLETION_PROMPT_CONFIG)),T=c?a===h.ModelModeType.chat?g.prompt:b.prompt:[],y=(()=>{if(!c)return{context:(0,f.checkHasContextBlock)(s),history:!1,query:!1};if(a===h.ModelModeType.chat)return{context:!!g.prompt.find(e=>(0,f.checkHasContextBlock)(e.text)),history:!1,query:!!g.prompt.find(e=>(0,f.checkHasQueryBlock)(e.text))};{let e=b.prompt?.text;return{context:(0,f.checkHasContextBlock)(e),history:(0,f.checkHasHistoryBlock)(e),query:(0,f.checkHasQueryBlock)(e)}}})(),M=async(e,o)=>{let r=s||"";if(t){if(!c){let{chat_prompt_config:e,completion_prompt_config:o,stop:n}=await (0,U.fetchPromptTemplate)({appMode:t,mode:a,modelName:i,hasSetDataSet:p});a===h.ModelModeType.chat?x((0,l.produce)(e,e=>{e.prompt=e.prompt.map(e=>({...e,text:e.text.replace(f.PRE_PROMPT_PLACEHOLDER_TEXT,r)}))})):(v((0,l.produce)(o,e=>{e.prompt.text=e.prompt.text.replace(f.PRE_PROMPT_PLACEHOLDER_TEXT,r)})),_({...m,stop:n}));return}if(e){let{completion_prompt_config:e,chat_prompt_config:a,stop:n}=await (0,U.fetchPromptTemplate)({appMode:t,mode:o,modelName:i,hasSetDataSet:p});o===h.ModelModeType.completion?(v((0,l.produce)(e,e=>{b.prompt?.text?e.prompt.text=b.prompt?.text.replace(f.PRE_PROMPT_PLACEHOLDER_TEXT,r):e.prompt.text=e.prompt.text.replace(f.PRE_PROMPT_PLACEHOLDER_TEXT,r),[h.AppModeEnum.ADVANCED_CHAT,h.AppModeEnum.AGENT_CHAT,h.AppModeEnum.CHAT].includes(t)&&b.conversation_histories_role.assistant_prefix&&b.conversation_histories_role.user_prefix&&(e.conversation_histories_role=b.conversation_histories_role)})),m.stop&&0!==m.stop.length||_({...m,stop:n}),u(n)):x((0,l.produce)(a,e=>{e.prompt=e.prompt.map(e=>({...e,text:e.text.replace(f.PRE_PROMPT_PLACEHOLDER_TEXT,r)}))}))}}};return{chatPromptConfig:g,setChatPromptConfig:x,completionPromptConfig:b,setCompletionPromptConfig:v,currentAdvancedPrompt:T,setCurrentAdvancedPrompt:(e,t)=>{c&&(a===h.ModelModeType.chat?x({...g,prompt:e}):v({...b,prompt:e}),t&&d())},hasSetBlockStatus:y,setConversationHistoriesRole:e=>{v({...b,conversation_histories_role:e})},migrateToDefaultPrompt:M}})({appMode:eb,modelName:tt.model_id,promptMode:tD,modelModeType:t_,prePrompt:tt.configs.prompt_template,hasSetDataSet:tc.length>0,onUserChangedPrompt:()=>{tL(!1)},completionParams:e6,setCompletionParams:te,setStop:e8}),tY=async t=>{let{modelId:o,provider:a,mode:i,features:r}=t;tF&&(i===h.ModelModeType.completion&&(eb!==h.AppModeEnum.COMPLETION?tX.prompt?.text&&tX.conversation_histories_role.assistant_prefix&&tX.conversation_histories_role.user_prefix||await tQ(!0,h.ModelModeType.completion):tX.prompt?.text||await tQ(!0,h.ModelModeType.completion)),i===h.ModelModeType.chat&&0===tB.prompt.length&&await tQ(!0,h.ModelModeType.chat)),tm((0,l.produce)(tt,e=>{e.provider=a,e.model_id=o,e.mode=i}));let n=r&&r.includes(z.ModelFeatureEnum.vision);tH({...tq,enabled:n},!0);try{let{params:t,removedDetails:i}=await (0,ep.fetchAndMergeValidCompletionParams)(a,o,e6,tF);Object.keys(i).length&&$.default.notify({type:"warning",message:`${e("modelProvider.parametersInvalidRemoved",{ns:"common"})}: ${Object.entries(i).map(e=>{let[t,o]=e;return`${t} (${o})`}).join(", ")}`}),te(t)}catch{$.default.notify({type:"error",message:e("error",{ns:"common"})}),te({})}},tJ=!!tS?.features?.includes(z.ModelFeatureEnum.vision),t0=!!tS?.features?.includes(z.ModelFeatureEnum.document),t1=!!tS?.features?.includes(z.ModelFeatureEnum.audio),t5=!!tS?.features?.includes(z.ModelFeatureEnum.video),t2=(0,o.useMemo)(()=>({moreLikeThis:tt.more_like_this||{enabled:!1},opening:{enabled:!!tt.opening_statement,opening_statement:tt.opening_statement||"",suggested_questions:tt.suggested_questions||[]},moderation:tt.sensitive_word_avoidance||{enabled:!1},speech2text:tt.speech_to_text||{enabled:!1},text2speech:tt.text_to_speech||{enabled:!1},file:{image:{detail:tt.file_upload?.image?.detail||h.Resolution.high,enabled:!!tt.file_upload?.image?.enabled,number_limits:tt.file_upload?.image?.number_limits||3,transfer_methods:tt.file_upload?.image?.transfer_methods||["local_file","remote_url"]},enabled:!!(tt.file_upload?.enabled||tt.file_upload?.image?.enabled),allowed_file_types:tt.file_upload?.allowed_file_types||[],allowed_file_extensions:tt.file_upload?.allowed_file_extensions||[...f.FILE_EXTS[x.SupportUploadFileTypes.image],...f.FILE_EXTS[x.SupportUploadFileTypes.video]].map(e=>`.${e}`),allowed_file_upload_methods:tt.file_upload?.allowed_file_upload_methods||tt.file_upload?.image?.transfer_methods||["local_file","remote_url"],number_limits:tt.file_upload?.number_limits||tt.file_upload?.image?.number_limits||3,fileUploadConfig:A},suggested:tt.suggested_questions_after_answer||{enabled:!1},citation:tt.retriever_resource||{enabled:!1},annotationReply:tt.annotation_reply||{enabled:!1}}),[A,tt]),t4=(0,o.useCallback)(e=>{N(!0),e&&eK()},[eK,N]),t6=(0,o.useCallback)(e=>{tm((0,l.produce)(tt,t=>{t.configs.prompt_variables=[...t.configs.prompt_variables,...e]}))},[tt]);(0,o.useEffect)(()=>{(async()=>{let e=await (0,es.fetchCollectionList)();eu.basePath&&e.forEach(e=>{"string"!=typeof e.icon||e.icon.includes(eu.basePath)||(e.icon=`${eu.basePath}${e.icon}`)}),tn(e);let t=await (0,er.fetchAppDetailDirect)({url:"/apps",id:eh});ev(t.mode);let o=t.model_config,a=o.prompt_type===L.PromptMode.advanced?L.PromptMode.advanced:L.PromptMode.simple;tR(a),a===L.PromptMode.advanced&&(o.chat_prompt_config&&o.chat_prompt_config.prompt.length>0?tV(o.chat_prompt_config):tV((0,n.clone)(w.DEFAULT_CHAT_PROMPT_CONFIG)),t$(o.completion_prompt_config||(0,n.clone)(w.DEFAULT_COMPLETION_PROMPT_CONFIG)),tL(!1));let i=o.model,r=null;if(o.agent_mode?.tools?.find(e=>{let{dataset:t}=e;return t?.enabled})?r=o.agent_mode?.tools.filter(e=>{let{dataset:t}=e;return t?.enabled}):o.dataset_configs.datasets?.datasets?.length>0&&(r=o.dataset_configs?.datasets?.datasets),tc&&r?.length&&r?.length>0){let{data:e}=await (0,en.fetchDatasets)({url:"/datasets",params:{page:1,ids:r.map(e=>{let{dataset:t}=e;return t.id})}});tg(r=e)}if(ej(o.opening_statement),ek(o.suggested_questions||[]),o.more_like_this&&eL(o.more_like_this),o.suggested_questions_after_answer&&eq(o.suggested_questions_after_answer),o.speech_to_text&&eH(o.speech_to_text),o.text_to_speech&&eV(o.text_to_speech),o.retriever_resource&&e$(o.retriever_resource),o.annotation_reply){let e=o.annotation_reply;o.annotation_reply.enabled&&(e={...o.annotation_reply,embedding_model:{...o.annotation_reply.embedding_model,embedding_provider_name:(0,ed.correctModelProvider)(o.annotation_reply.embedding_model.embedding_provider_name)}}),eZ(e,!0)}o.sensitive_word_avoidance&&eY(o.sensitive_word_avoidance),o.external_data_tools&&e0(o.external_data_tools);let s={modelConfig:{provider:(0,ed.correctModelProvider)(i.provider),model_id:i.name,mode:i.mode,configs:{prompt_template:o.pre_prompt||"",prompt_variables:(0,em.userInputsFormToPromptVariables)([...o.user_input_form,...o.external_data_tools?.length?o.external_data_tools.map(e=>({external_data_tool:{variable:e.variable,label:e.label,enabled:e.enabled,type:e.type,config:e.config,required:!0,icon:e.icon,icon_background:e.icon_background}})):[]],o.dataset_query_variable)},more_like_this:o.more_like_this??{enabled:!1},opening_statement:o.opening_statement,suggested_questions:o.suggested_questions??[],sensitive_word_avoidance:o.sensitive_word_avoidance,speech_to_text:o.speech_to_text,text_to_speech:o.text_to_speech,file_upload:o.file_upload??null,suggested_questions_after_answer:o.suggested_questions_after_answer??{enabled:!1},retriever_resource:o.retriever_resource,annotation_reply:o.annotation_reply??null,external_data_tools:o.external_data_tools??[],system_parameters:o.system_parameters,dataSets:r||[],agentConfig:t.mode===h.AppModeEnum.AGENT_CHAT?{max_iteration:w.DEFAULT_AGENT_SETTING.max_iteration,...o.agent_mode,enabled:!0,tools:(o.agent_mode?.tools??[]).filter(e=>!e.dataset).map(o=>{let a=e.find(e=>o.provider_id===e.id);return{...o,isDeleted:t.deleted_tools?.some(e=>e.provider_id===o.provider_id&&e.tool_name===o.tool_name)??!1,notAuthor:a?.is_team_authorization===!1,..."builtin"===o.provider_type?{provider_id:(0,ed.correctToolProvider)(o.provider_name,!!a),provider_name:(0,ed.correctToolProvider)(o.provider_name,!!a)}:{}}}),strategy:o.agent_mode?.strategy??h.AgentStrategy.react}:w.DEFAULT_AGENT_SETTING},completionParams:i.completion_params};o.file_upload&&tH(o.file_upload.image,!0),tw(s),ey(s);let l=(0,Q.getMultipleRetrievalConfig)({...o.dataset_configs,reranking_model:o.dataset_configs.reranking_model&&{provider:o.dataset_configs.reranking_model.reranking_provider_name,model:o.dataset_configs.reranking_model.reranking_model_name}},r,r,{provider:tE?.provider,model:tC?.model}),d={...o.dataset_configs,...l,...l.reranking_model?{reranking_model:{reranking_model_name:l.reranking_model.model,reranking_provider_name:(0,ed.correctModelProvider)(l.reranking_model.provider)}}:{}};d.retrieval_model=d.retrieval_model??h.RETRIEVE_TYPE.multiWay,tp(d),eg(!0)})()},[eh]);let t7=eb===h.AppModeEnum.COMPLETION&&(tF?t_===h.ModelModeType.chat?tB.prompt.every(e=>{let{text:t}=e;return!t}):!tX.prompt?.text:!tt.configs.prompt_template),t3=eb===h.AppModeEnum.COMPLETION?t7:!!tF&&(t_===h.ModelModeType.completion&&(!tK.history||!tK.query)||!1),t8=eb===h.AppModeEnum.COMPLETION&&tc.length>0&&!tx,t9=async(t,o)=>{let a=t?.model||tt.model_id,i=tt.configs.prompt_template,r=tt.configs.prompt_variables;if(t7)return void u({type:"error",message:e("otherError.promptNoBeEmpty",{ns:"appDebug"})});if(tF&&eb!==h.AppModeEnum.COMPLETION&&t_===h.ModelModeType.completion){if(!tK.history)return void u({type:"error",message:e("otherError.historyNoBeEmpty",{ns:"appDebug"})});if(!tK.query)return void u({type:"error",message:e("otherError.queryNoBeEmpty",{ns:"appDebug"})})}if(t8)return void u({type:"error",message:e("feature.dataSet.queryVariable.contextVarNotEmpty",{ns:"appDebug"})});let s=tc.map(e=>{let{id:t}=e;return{dataset:{enabled:!0,id:t}}}),d={...o?.file};delete d?.fileUploadConfig;let p={pre_prompt:tF?"":i,prompt_type:tD,chat_prompt_config:tF?tB:(0,n.clone)(w.DEFAULT_CHAT_PROMPT_CONFIG),completion_prompt_config:tF?tX:(0,n.clone)(w.DEFAULT_COMPLETION_PROMPT_CONFIG),user_input_form:(0,em.promptVariablesToUserInputsForm)(r),dataset_query_variable:tf||"",more_like_this:o?.moreLikeThis,opening_statement:o?.opening?.enabled&&o.opening?.opening_statement||"",suggested_questions:o?.opening?.enabled&&o.opening?.suggested_questions||[],sensitive_word_avoidance:o?.moderation,speech_to_text:o?.speech2text,text_to_speech:o?.text2speech,file_upload:d,suggested_questions_after_answer:o?.suggested,retriever_resource:o?.citation,agent_mode:{...tt.agentConfig,strategy:tO?h.AgentStrategy.functionCall:h.AgentStrategy.react},external_data_tools:eJ,model:{provider:t?.provider||tt.provider,name:a,mode:tt.mode,completion_params:t?.parameters||e6},dataset_configs:{...ts,datasets:{datasets:[...s]}},system_parameters:tt.system_parameters};return await (0,er.updateAppModelConfig)({url:`/apps/${eh}/model-config`,body:p}),ey({modelConfig:(0,l.produce)(tt,e=>{e.opening_statement=ew,e.more_like_this=eI,e.suggested_questions_after_answer=eU,e.speech_to_text=eG,e.text_to_speech=eB,e.retriever_resource=eX,e.dataSets=tc}),completionParams:e6}),u({type:"success",message:e("api.success",{ns:"common"})}),tL(!1),!0},[oe,ot]=(0,o.useState)(!1),{debugWithMultipleModel:oo,multipleModelConfigs:oa,handleMultipleModelConfigsChange:oi}=(0,I.useDebugWithSingleOrMultipleModel)(eh);if(ef||g||!y.id)return(0,t.jsx)("div",{className:"flex h-full items-center justify-center",children:(0,t.jsx)(X.default,{type:"area"})});let or={appId:eh,isAPIKeySet:tj,isTrailFinished:!1,mode:eb,modelModeType:t_,promptMode:tD,isAdvancedMode:tF,isAgent:ta,isOpenAI:ti,isFunctionCall:tO,collectionList:tr,setPromptMode:tU,canReturnToSimpleMode:tI,setCanReturnToSimpleMode:tL,chatPromptConfig:tB,completionPromptConfig:tX,currentAdvancedPrompt:tW,setCurrentAdvancedPrompt:tz,conversationHistoriesRole:tX.conversation_histories_role,showHistoryModal:tN,setConversationHistoriesRole:tZ,hasSetBlockStatus:tK,conversationId:eM,introduction:ew,setIntroduction:ej,suggestedQuestions:eS,setSuggestedQuestions:ek,setConversationId:eC,controlClearChatMessage:eO,setControlClearChatMessage:eD,prevPromptConfig:eR,setPrevPromptConfig:eF,moreLikeThisConfig:eI,setMoreLikeThisConfig:eL,suggestedQuestionsAfterAnswerConfig:eU,setSuggestedQuestionsAfterAnswerConfig:eq,speechToTextConfig:eG,setSpeechToTextConfig:eH,textToSpeechConfig:eB,setTextToSpeechConfig:eV,citationConfig:eX,setCitationConfig:e$,annotationConfig:eW,setAnnotationConfig:eZ,moderationConfig:eQ,setModerationConfig:eY,externalDataToolsConfig:eJ,setExternalDataToolsConfig:e0,formattingChanged:S,setFormattingChanged:k,inputs:e1,setInputs:e5,query:e2,setQuery:e4,completionParams:e6,setCompletionParams:te,modelConfig:tt,setModelConfig:tm,showSelectDataSet:tb,dataSets:tc,setDataSets:tg,datasetConfigs:ts,datasetConfigsRef:td,setDatasetConfigs:tp,hasSetContextVar:tx,isShowVisionConfig:tJ,visionConfig:tq,setVisionConfig:tH,isAllowVideoUpload:t5,isShowDocumentConfig:t0,isShowAudioConfig:t1,rerankSettingModalOpen:ty,setRerankSettingModalOpen:tM};return(0,t.jsx)(ee.default.Provider,{value:or,children:(0,t.jsx)(B.FeaturesProvider,{features:t2,children:(0,t.jsxs)(et.MittProvider,{children:[(0,t.jsx)("div",{className:"flex h-full flex-col",children:(0,t.jsxs)("div",{className:"relative flex h-[200px] grow pt-14",children:[(0,t.jsx)("div",{className:"bg-default-subtle absolute left-0 top-0 h-14 w-full",children:(0,t.jsxs)("div",{className:"flex h-14 items-center justify-between px-6",children:[(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("div",{className:"system-xl-semibold text-text-primary",children:e("orchestrate",{ns:"appDebug"})}),(0,t.jsx)("div",{className:"flex h-[14px] items-center space-x-1 text-xs",children:tF&&(0,t.jsx)("div",{className:"system-xs-medium-uppercase ml-1 flex h-5 items-center rounded-md border border-components-button-secondary-border px-1.5 uppercase text-text-tertiary",children:e("promptMode.advanced",{ns:"appDebug"})})})]}),(0,t.jsxs)("div",{className:"flex items-center",children:[ta&&(0,t.jsx)(D,{isChatModel:tt.mode===h.ModelModeType.chat,agentConfig:tt.agentConfig,isFunctionCall:tO,onAgentSettingChange:e=>{tm((0,l.produce)(tt,t=>{t.agentConfig=e}))}}),!oo&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Z.default,{isAdvancedMode:tF,provider:tt.provider,completionParams:e6,modelId:tt.model_id,setModel:tY,onCompletionParamsChange:e=>{te(e)},debugWithMultipleModel:oo,onDebugWithMultipleModelChange:()=>{oi(!0,[{id:`${Date.now()}`,model:tt.model_id,provider:tt.provider,parameters:e6},{id:`${Date.now()}-no-repeat`,model:"",provider:"",parameters:{}}]),P("collapse")}}),(0,t.jsx)(G.default,{type:"vertical",className:"mx-2 h-[14px]"})]}),eE&&(0,t.jsxs)(T.default,{className:"mr-2 !h-8 !text-[13px] font-medium",onClick:eN,children:[(0,t.jsx)("span",{className:"mr-1",children:e("operation.debugConfig",{ns:"appDebug"})}),(0,t.jsx)(a,{className:"h-4 w-4 text-text-tertiary"})]}),(0,t.jsx)(b,{publishDisabled:t3,publishedAt:1e3*(j||0),debugWithMultipleModel:oo,multipleModelConfigs:oa,onPublish:t9,publishedConfig:eT,resetAppConfig:()=>tw(eT)})]})]})}),(0,t.jsx)("div",{className:`flex h-full w-full shrink-0 flex-col sm:w-1/2 ${oo&&"max-w-[560px]"}`,children:(0,t.jsx)(v.default,{})}),!eE&&(0,t.jsx)("div",{className:"relative flex h-full w-1/2 grow flex-col overflow-y-auto ",style:{borderColor:"rgba(0, 0, 0, 0.02)"},children:(0,t.jsx)("div",{className:"flex grow flex-col rounded-tl-2xl border-l-[0.5px] border-t-[0.5px] border-components-panel-border bg-chatbot-bg ",children:(0,t.jsx)(F.default,{isAPIKeySet:tj,onSetting:()=>O({payload:W.ACCOUNT_SETTING_TAB.PROVIDER}),inputs:e1,modelParameterParams:{setModel:tY,onCompletionParamsChange:te},debugWithMultipleModel:oo,multipleModelConfigs:oa,onMultipleModelConfigsChange:oi})})})]})}),oe&&(0,t.jsx)(c.default,{title:e("trailUseGPT4Info.title",{ns:"appDebug"}),content:e("trailUseGPT4Info.description",{ns:"appDebug"}),isShow:oe,onConfirm:()=>{O({payload:W.ACCOUNT_SETTING_TAB.PROVIDER}),ot(!1)},onCancel:()=>ot(!1)}),th&&(0,t.jsx)(R.default,{isShow:th,onClose:tv,selectedIds:tT,onSelect:e=>{if((0,s.isEqual)(e.map(e=>e.id),tc.map(e=>e.id)))return void tv();eK();let t=e;if(e.find(e=>!e.name)){let o=(0,l.produce)(e,t=>{e.forEach((e,o)=>{if(!e.name){let a=tc.find(t=>t.id===e.id);a&&(t[o]=a)}})});tg(o),t=o}else tg(e);tv();let{allExternal:o,allInternal:a,mixtureInternalAndExternal:i,mixtureHighQualityAndEconomic:r,inconsistentEmbeddingModel:n}=(0,Q.getSelectedDatasetsMode)(t);(a&&(r||n)||i||o)&&tM(!0);let{datasets:d,retrieval_model:p,score_threshold_enabled:m,..._}=ts,{top_k:u,score_threshold:c,reranking_model:g,reranking_mode:f,weights:x,reranking_enable:h}=_,b={top_k:u,score_threshold:c,reranking_model:g?.reranking_provider_name&&g?.reranking_model_name?{provider:g.reranking_provider_name,model:g.reranking_model_name}:void 0,reranking_mode:f,weights:x,reranking_enable:h},v=(0,Q.getMultipleRetrievalConfig)(b,t,tc,{provider:tE?.provider,model:tC?.model});tp({...td.current,...v,reranking_model:{reranking_provider_name:v?.reranking_model?.provider||"",reranking_model_name:v?.reranking_model?.model||""},retrieval_model:p,score_threshold_enabled:m,datasets:d})}}),tP&&(0,t.jsx)(M,{isShow:tP,saveLoading:!1,onClose:tA,data:tX.conversation_histories_role,onSave:e=>{tZ(e),tA()}}),eE&&(0,t.jsx)(H.default,{showClose:!0,isOpen:eP,onClose:eA,mask:!0,footer:null,children:(0,t.jsx)(F.default,{isAPIKeySet:tj,onSetting:()=>O({payload:W.ACCOUNT_SETTING_TAB.PROVIDER}),inputs:e1,modelParameterParams:{setModel:tY,onCompletionParamsChange:te},debugWithMultipleModel:oo,multipleModelConfigs:oa,onMultipleModelConfigsChange:oi})}),E&&(0,t.jsx)(V.default,{show:!0,inWorkflow:!1,showFileUpload:!1,isChatMode:eb!==h.AppModeEnum.COMPLETION,disabled:!1,onChange:t4,onClose:()=>N(!1),promptVariables:tt.configs.prompt_variables,onAutoAddPromptVariable:t6}),(0,t.jsx)(Y.default,{})]})})})});e.s(["default",0,ec],434937)}]);