# 实现计划：数据脱敏功能

## 概述

本实现计划将数据脱敏功能分解为离散的编码步骤。该功能在桌面客户端（Next.js + TypeScript + React）中实现，包括脱敏引擎、沙箱管理、映射存储和反向替换等核心组件。实现将遵循 TDD 方法，使用 Jest 进行单元测试，使用 fast-check 进行基于属性的测试。

## 任务

- [x] 1. 设置项目结构和核心类型定义
  - 在 `web/app/components/data-masking/` 创建目录结构
  - 定义 TypeScript 接口和类型（MaskingRule, MaskingStrategy, MappingData 等）
  - 设置 SQLite 数据库连接和初始化脚本
  - 配置测试环境（Jest + fast-check）
  - _需求：1.1, 2.1, 5.1_

- [ ] 2. 实现脱敏引擎核心功能
  - [x] 2.1 实现 MaskingEngine 类
    - 实现 `maskContent()` 方法：应用规则识别和替换敏感数据
    - 实现 `validateRule()` 方法：验证规则配置
    - 支持三种脱敏策略：替换、令牌化、格式保留
    - _需求：1.1, 1.2_
  
  - [ ]* 2.2 为脱敏引擎编写属性测试
    - **属性 1：脱敏规则完整应用**
    - **验证：需求 1.1, 1.3**
  
  - [ ]* 2.3 为脱敏引擎编写单元测试
    - 测试电子邮件、电话、信用卡等常见模式
    - 测试空内容和无规则的边缘情况
    - 测试无效规则的错误处理
    - _需求：1.1, 1.2_

- [ ] 3. 实现映射存储功能
  - [x] 3.1 实现 MappingStore 类
    - 实现 `storeMapping()` 方法：存储映射关系
    - 实现 `getMapping()` 方法：检索映射数据
    - 实现 `findOriginalValue()` 方法：通过脱敏值查找原始值
    - 实现 AES-256 加密/解密功能
    - 集成操作系统凭据管理（Windows Credential Manager / macOS Keychain）
    - _需求：5.1, 5.2, 5.4, 5.5, 9.1, 9.3_
  
  - [x]* 3.2 为映射存储编写属性测试
    - **属性 10：映射唯一标识**
    - **验证：需求 5.1**
  
  - [ ]* 3.3 为映射存储编写属性测试
    - **属性 11：原始值加密存储**
    - **验证：需求 5.2, 9.1**
  
  - [ ]* 3.4 为映射存储编写属性测试
    - **属性 13：映射查询隔离**
    - **验证：需求 5.4**
  
  - [ ]* 3.5 为映射存储编写属性测试
    - **属性 14：脱敏值反向查找**
    - **验证：需求 5.5**
  
  - [ ]* 3.6 为映射存储编写单元测试
    - 测试加密密钥存储在操作系统凭据管理中
    - 测试数据库直接读取看到的是加密数据
    - 测试映射删除功能
    - _需求：5.1, 5.2, 5.6, 9.1, 9.3_

- [ ] 4. 实现沙箱管理功能
  - [x] 4.1 实现 SandboxManager 类
    - 实现 `configureSandbox()` 方法：配置和验证沙箱路径
    - 实现 `validatePath()` 方法：验证路径在沙箱内
    - 实现 `saveFile()` 和 `readFile()` 方法：沙箱内文件操作
    - 实现 `listFiles()` 和 `deleteFile()` 方法：文件管理
    - _需求：3.1, 3.2, 3.3, 3.4, 3.6_
  
  - [ ]* 4.2 为沙箱管理编写属性测试
    - **属性 6：沙箱路径验证**
    - **验证：需求 3.1**
  
  - [ ]* 4.3 为沙箱管理编写属性测试
    - **属性 7：沙箱配置持久化**
    - **验证：需求 3.2**
  
  - [ ]* 4.4 为沙箱管理编写属性测试
    - **属性 8：沙箱边界强制**
    - **验证：需求 3.3, 3.4, 3.5, 3.6, 4.1**
  
  - [ ]* 4.5 为沙箱管理编写单元测试
    - 测试无效路径（不存在、不可写、系统保护目录）
    - 测试路径遍历攻击防护
    - 测试文件操作错误处理
    - _需求：3.1, 3.6_

- [x] 5. 检查点 - 确保核心功能测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 6. 实现反向替换功能
  - [x] 6.1 实现 ReverseSubstitution 类
    - 实现 `substitute()` 方法：对响应执行反向替换
    - 实现 `identifyMaskedValues()` 方法：识别脱敏值
    - 支持多种响应格式（文本、JSON、结构化数据）
    - 实现部分替换失败处理
    - _需求：6.1, 6.2, 6.3, 6.4, 6.5, 6.6_
  
  - [x]* 6.2 为反向替换编写属性测试
    - **属性 15：脱敏和反向替换往返**
    - **验证：需求 6.1, 6.2, 6.3, 6.4**
  
  - [x]* 6.3 为反向替换编写属性测试
    - **属性 16：多格式反向替换**
    - **验证：需求 6.6**
  
  - [x]* 6.4 为反向替换编写单元测试
    - 测试缺失映射的处理（记录警告，保持脱敏值）
    - 测试各种响应格式（纯文本、JSON、嵌套对象）
    - 测试部分替换失败的情况
    - _需求：6.5, 6.6_

- [ ] 7. 实现文件上传功能
  - [x] 7.1 实现 FileUploader 类
    - 实现 `uploadFile()` 方法：上传文件到 Dify 后端
    - 集成沙箱路径验证
    - 实现上传进度跟踪
    - 实现重试机制（指数退避）
    - _需求：4.1, 4.2, 4.4, 4.5, 5.3_
  
  - [ ]* 7.2 为文件上传编写属性测试
    - **属性 9：只传输脱敏数据**
    - **验证：需求 4.2, 9.2**
  
  - [ ]* 7.3 为文件上传编写属性测试
    - **属性 12：映射关联上传**
    - **验证：需求 5.3**
  
  - [ ]* 7.4 为文件上传编写单元测试
    - 测试上传失败和重试逻辑
    - 测试进度回调功能
    - 测试沙箱外文件被拒绝
    - _需求：4.1, 4.4, 4.5_

- [ ] 8. 实现脱敏规则管理 UI
  - [x] 8.1 创建规则列表组件
    - 显示所有脱敏规则
    - 支持启用/禁用规则
    - 支持删除规则
    - _需求：2.5, 10.1_
  
  - [x] 8.2 创建规则表单组件
    - 创建/编辑规则表单
    - 模式匹配条件输入（正则表达式、关键词）
    - 脱敏策略选择（替换、令牌化、格式保留）
    - 规则验证和预览
    - _需求：2.1, 2.2, 2.3, 10.2_
  
  - [x] 8.3 实现预定义规则模板
    - 提供常见敏感数据类型模板（电子邮件、电话、信用卡、身份证号）
    - 模板一键应用功能
    - _需求：2.6_
  
  - [ ]* 8.4 为规则管理编写属性测试
    - **属性 3：规则持久化往返**
    - **验证：需求 2.3**
  
  - [ ]* 8.5 为规则管理编写属性测试
    - **属性 4：规则更新生效**
    - **验证：需求 2.4**
  
  - [ ]* 8.6 为规则管理编写属性测试
    - **属性 5：规则删除生效**
    - **验证：需求 2.5**
  
  - [ ]* 8.7 为规则管理 UI 编写单元测试
    - 测试规则表单验证
    - 测试预定义模板加载
    - 测试规则列表渲染
    - _需求：2.1, 2.2, 2.6, 10.1, 10.2_

- [ ] 9. 实现沙箱配置 UI
  - [ ] 9.1 创建沙箱配置组件
    - 沙箱路径选择器（目录选择对话框）
    - 显示当前沙箱配置
    - 路径验证和错误提示
    - _需求：3.1, 3.2, 10.3_
  
  - [ ]* 9.2 为沙箱配置 UI 编写单元测试
    - 测试路径选择器功能
    - 测试无效路径的错误显示
    - 测试配置保存和加载
    - _需求：3.1, 3.2, 10.3_

- [ ] 10. 实现文件脱敏 UI
  - [ ] 10.1 创建文件脱敏组件
    - 文件选择器（限制在沙箱内）
    - 规则选择（多选）
    - 脱敏预览功能
    - 执行脱敏按钮和进度显示
    - _需求：1.1, 1.4, 10.4_
  
  - [ ]* 10.2 为文件脱敏 UI 编写属性测试
    - **属性 2：沙箱文件保存**
    - **验证：需求 1.4**
  
  - [ ]* 10.3 为文件脱敏 UI 编写单元测试
    - 测试文件选择限制在沙箱内
    - 测试脱敏进度显示
    - 测试脱敏完成后的状态更新
    - _需求：1.4, 10.4_

- [ ] 11. 检查点 - 确保 UI 组件测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 12. 实现文件管理 UI
  - [ ] 12.1 创建文件列表组件
    - 显示沙箱内的脱敏文件
    - 文件信息（名称、大小、创建时间）
    - 上传按钮和进度显示
    - 删除按钮（可选删除关联映射）
    - _需求：4.4, 4.5, 5.6, 10.1_
  
  - [ ]* 12.2 为文件管理 UI 编写单元测试
    - 测试文件列表渲染
    - 测试上传进度显示
    - 测试删除确认对话框
    - _需求：4.5, 5.6, 10.1_

- [ ] 13. 实现错误处理和日志
  - [ ] 13.1 实现错误处理类
    - 定义自定义错误类型（MaskingError, UploadError 等）
    - 实现事务管理器（支持回滚）
    - 实现错误恢复机制
    - _需求：12.1, 12.2, 12.3, 12.4_
  
  - [ ] 13.2 实现操作日志功能
    - 创建日志记录函数
    - 实现日志查询和显示
    - 确保日志不包含敏感数据
    - _需求：9.4, 12.5_
  
  - [ ]* 13.3 为日志功能编写属性测试
    - **属性 17：日志不含敏感数据**
    - **验证：需求 9.4**
  
  - [ ]* 13.4 为错误处理编写单元测试
    - 测试脱敏失败时原始文件保留
    - 测试映射存储失败时回滚
    - 测试上传失败时数据保留
    - 测试部分替换失败的处理
    - _需求：12.1, 12.2, 12.3, 12.4_

- [ ] 14. 实现国际化
  - [ ] 14.1 添加中文翻译
    - 在 `web/i18n/zh-CN/` 添加 `data-masking.ts`
    - 翻译所有用户界面文本
    - _需求：10.5_
  
  - [ ] 14.2 添加英文翻译
    - 在 `web/i18n/en-US/` 添加 `data-masking.ts`
    - 翻译所有用户界面文本
    - _需求：10.5_
  
  - [ ] 14.3 更新所有 UI 组件使用翻译键
    - 替换所有硬编码文本为翻译键
    - 测试语言切换功能
    - _需求：10.5_

- [ ] 15. 实现 Dify 后端文件路径验证（可选）
  - [ ] 15.1 在 Dify 后端添加沙箱路径验证中间件
    - 验证文件路径在授权沙箱内
    - 拒绝沙箱外的文件访问
    - 记录文件访问尝试
    - _需求：7.1, 7.2, 7.4, 7.5_
  
  - [ ]* 15.2 为后端验证编写单元测试
    - 测试沙箱内路径被允许
    - 测试沙箱外路径被拒绝
    - 测试路径遍历攻击防护
    - _需求：7.1, 7.2, 7.4_

- [ ] 16. 集成和端到端测试
  - [ ] 16.1 实现完整的脱敏工作流集成
    - 连接所有组件（脱敏引擎、映射存储、沙箱管理、文件上传）
    - 实现主页面路由和导航
    - 测试完整用户流程
    - _需求：1.1, 1.2, 1.3, 1.4, 4.1, 4.2, 6.1, 6.2, 6.3, 6.4_
  
  - [ ]* 16.2 编写端到端测试
    - 测试完整的脱敏和上传流程
    - 测试完整的反向替换流程
    - 测试错误恢复场景
    - _需求：所有需求_

- [ ] 17. 最终检查点 - 确保所有测试通过
  - 运行所有单元测试和属性测试
  - 验证测试覆盖率 > 80%
  - 运行 ESLint 和类型检查
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务引用特定需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 所有用户界面文本必须使用 `web/i18n/` 中的翻译键
- 遵循 TypeScript 严格模式和 ESLint 规则
